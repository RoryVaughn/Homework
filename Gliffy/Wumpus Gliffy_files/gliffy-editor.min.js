(function(){var _gliffy={};_gliffy.renderers={};_gliffy.stages={};_gliffy.Debug={SKIP_CATCH_ERRORS:false,SKIP_RENDER_LOOP:false,DISPLAY_GUIDES:false,NO_CONTEXT_MENU:false,NO_ERROR_DIALOG:false,FINITE_NUMBER_CHECKS:false,NO_TIPS:false,NO_NAVIGATE_WARNING:false,STARTUP_FILE:null,LOG_TO_CONSOLE:false,LOG_ANALYTICS:false,USE_ANALYTICS_DEBUG_JS:false,SHOW_MOUSE_COORDS:false,I18N_UNDERSCORES:false,SHOW_RTREE:false};_gliffy.FEATURES={charts:false,tables:false,tables_v2:true,searchOn:true,showPremiumShapesLocked:false,umlV1:false,umlV2:true,uiV2:true,uiV3:true,allowDisableAutosave:false,mindmaps:true,mindmapsAutoLayout:true,browserTabs:false,tabs:true,showPremiumShapes:true,alwaysUseStaticShapeStyleDefaults:true};_gliffy.versionString="unavailable";_gliffy.confluenceVersion="unavailable";_gliffy.analyticsProduct="none";_gliffy.workQueue=$({});_gliffy.textDimensionMap={width:{},height:{}};_gliffy.textDimensionMapSize={width:0,height:0};_gliffy.MIN_OPACITY=0.008;_gliffy.MIN_VISIBLE_VALUE=2;_gliffy.clipboard=null;_gliffy.camelMap={};_gliffy.camelSize=0;$.camelCase=function(string){var getCamel=function(string){return string.replace(/^-ms-/,"ms-").replace(/-([a-z]|[0-9])/ig,function(all,letter){return(letter+"").toUpperCase()})};if(_gliffy.camelMap[string]===undefined){_gliffy.camelMap[string]=getCamel(string);if(++_gliffy.camelSize>1000){_gliffy.camelSize=0;_gliffy.camelMap={}}}return _gliffy.camelMap[string]};(function(factory){if(typeof define==="function"&&define.amd){define(["jquery"],factory)}else{factory(jQuery)}})(function($,undefined){var tag2attr={a:"href",img:"src",form:"action",base:"href",script:"src",iframe:"src",link:"href"},key=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","fragment"],aliases={anchor:"fragment"},parser={strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/},querystring_parser=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g,fragment_parser=/(?:^|&|;)([^&=;]*)=?([^&;]*)/g;function parseUri(url,strictMode){var str=decodeURI(unescape(url)),res=parser[strictMode||false?"strict":"loose"].exec(str),uri={attr:{},param:{},seg:{}},i=14;while(i--){uri.attr[key[i]]=res[i]||""}uri.param.query={};uri.param.fragment={};uri.attr.query.replace(querystring_parser,function($0,$1,$2){if($1){uri.param.query[$1]=$2}});uri.attr.fragment.replace(fragment_parser,function($0,$1,$2){if($1){uri.param.fragment[$1]=$2}});uri.seg.path=uri.attr.path.replace(/^\/+|\/+$/g,"").split("/");uri.seg.fragment=uri.attr.fragment.replace(/^\/+|\/+$/g,"").split("/");uri.attr.base=uri.attr.host?(uri.attr.protocol?uri.attr.protocol+"://"+uri.attr.host:uri.attr.host)+(uri.attr.port?":"+uri.attr.port:""):"";return uri}function getAttrName(elm){var tn=elm.tagName;if(tn!==undefined){return tag2attr[tn.toLowerCase()]}return tn}$.fn.url=function(strictMode){var url="";if(this.length){url=$(this).attr(getAttrName(this[0]))||""}return $.url(url,strictMode)};$.url=function(url,strictMode){if(arguments.length===1&&url===true){strictMode=true;url=undefined}strictMode=strictMode||false;url=url||window.location.toString();return{data:parseUri(url,strictMode),attr:function(attr){attr=aliases[attr]||attr;return attr!==undefined?this.data.attr[attr]:this.data.attr},param:function(param){return param!==undefined?this.data.param.query[param]:this.data.param.query},fparam:function(param){return param!==undefined?this.data.param.fragment[param]:this.data.param.fragment},segment:function(seg){if(seg===undefined){return this.data.seg.path}else{seg=seg<0?this.data.seg.path.length+seg:seg-1;return this.data.seg.path[seg]}},fsegment:function(seg){if(seg===undefined){return this.data.seg.fragment}else{seg=seg<0?this.data.seg.fragment.length+seg:seg-1;return this.data.seg.fragment[seg]}}}}});
/*!! Simple JavaScript Inheritance
 * By John Resig http://ejohn.org/
 * MIT Licensed.
 * http://ejohn.org/blog/simple-javascript-inheritance
 *
 */
(function(){var initializing=false,fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;var Class=function(){};Class.extend=function(prop){var _super=this.prototype;initializing=true;var prototype=new this();initializing=false;for(var name in prop){prototype[name]=typeof prop[name]=="function"&&typeof _super[name]=="function"&&fnTest.test(prop[name])?(function(name,fn){return function(){var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);this._super=tmp;return ret}})(name,prop[name]):prop[name]}function Class(){if(!(this instanceof Class)){return new Class(arguments)}if(!initializing&&this.init){this.init.apply(this,arguments)}}Class.prototype=prototype;Class.prototype.constructor=Class;Class.extend=arguments.callee;return Class};_gliffy.Class=Class})();var RTree=function(width){var _Min_Width=3;var _Max_Width=6;if(!isNaN(width)){_Min_Width=Math.floor(width/2);_Max_Width=width}var _T={x:0,y:0,w:0,h:0,id:"root",nodes:[]};var isArray=function(o){return Object.prototype.toString.call(o)==="[object Array]"};var _name_to_id=(function(){var idCache={};return function(idPrefix){var idVal=0;if(idPrefix in idCache){idVal=idCache[idPrefix]++}else{idCache[idPrefix]=0}return idPrefix+"_"+idVal}})();RTree.Rectangle.squarified_ratio=function(l,w,fill){var lperi=(l+w)/2;var larea=l*w;var lgeo=larea/(lperi*lperi);return(larea*fill/lgeo)};var _remove_subtree=function(rect,obj,root){var hit_stack=[];var count_stack=[];var ret_array=[];var current_depth=1;if(!rect||!RTree.Rectangle.overlap_rectangle(rect,root)){return ret_array}var ret_obj={x:rect.x,y:rect.y,w:rect.w,h:rect.h,target:obj};count_stack.push(root.nodes.length);hit_stack.push(root);do{var tree=hit_stack.pop();var i=count_stack.pop()-1;if("target" in ret_obj){while(i>=0){var ltree=tree.nodes[i];if(RTree.Rectangle.overlap_rectangle(ret_obj,ltree)){if((ret_obj.target&&"leaf" in ltree&&ltree.leaf===ret_obj.target)||(!ret_obj.target&&("leaf" in ltree||RTree.Rectangle.contains_rectangle(ltree,ret_obj)))){if("nodes" in ltree){ret_array=_search_subtree(ltree,true,[],ltree);tree.nodes.splice(i,1)}else{ret_array=tree.nodes.splice(i,1)}RTree.Rectangle.make_MBR(tree.nodes,tree);delete ret_obj.target;if(tree.nodes.length<_Min_Width){ret_obj.nodes=_search_subtree(tree,true,[],tree)}break}else{if("nodes" in ltree){current_depth+=1;count_stack.push(i);hit_stack.push(tree);tree=ltree;i=ltree.nodes.length}}}i-=1}}else{if("nodes" in ret_obj){tree.nodes.splice(i+1,1);if(tree.nodes.length>0){RTree.Rectangle.make_MBR(tree.nodes,tree)}for(var t=0;t<ret_obj.nodes.length;t++){_insert_subtree(ret_obj.nodes[t],tree)}ret_obj.nodes.length=0;if(hit_stack.length==0&&tree.nodes.length<=1){ret_obj.nodes=_search_subtree(tree,true,ret_obj.nodes,tree);tree.nodes.length=0;hit_stack.push(tree);count_stack.push(1)}else{if(hit_stack.length>0&&tree.nodes.length<_Min_Width){ret_obj.nodes=_search_subtree(tree,true,ret_obj.nodes,tree);tree.nodes.length=0}else{delete ret_obj.nodes}}}else{RTree.Rectangle.make_MBR(tree.nodes,tree)}}current_depth-=1}while(hit_stack.length>0);return(ret_array)};var _choose_leaf_subtree=function(rect,root){var best_choice_index=-1;var best_choice_stack=[];var best_choice_area;var load_callback=function(local_tree,local_node){return(function(data){local_tree._attach_data(local_node,data)})};best_choice_stack.push(root);var nodes=root.nodes;do{if(best_choice_index!=-1){best_choice_stack.push(nodes[best_choice_index]);nodes=nodes[best_choice_index].nodes;best_choice_index=-1}for(var i=nodes.length-1;i>=0;i--){var ltree=nodes[i];if("leaf" in ltree){best_choice_index=-1;break}var old_lratio=RTree.Rectangle.squarified_ratio(ltree.w,ltree.h,ltree.nodes.length+1);var nw=Math.max(ltree.x+ltree.w,rect.x+rect.w)-Math.min(ltree.x,rect.x);var nh=Math.max(ltree.y+ltree.h,rect.y+rect.h)-Math.min(ltree.y,rect.y);var lratio=RTree.Rectangle.squarified_ratio(nw,nh,ltree.nodes.length+2);if(best_choice_index<0||Math.abs(lratio-old_lratio)<best_choice_area){best_choice_area=Math.abs(lratio-old_lratio);best_choice_index=i}}}while(best_choice_index!=-1);return(best_choice_stack)};var _linear_split=function(nodes){var n=_pick_linear(nodes);while(nodes.length>0){_pick_next(nodes,n[0],n[1])}return(n)};var _pick_next=function(nodes,a,b){var area_a=RTree.Rectangle.squarified_ratio(a.w,a.h,a.nodes.length+1);var area_b=RTree.Rectangle.squarified_ratio(b.w,b.h,b.nodes.length+1);var high_area_delta;var high_area_node;var lowest_growth_group;for(var i=nodes.length-1;i>=0;i--){var l=nodes[i];var new_area_a={};new_area_a.x=Math.min(a.x,l.x);new_area_a.y=Math.min(a.y,l.y);new_area_a.w=Math.max(a.x+a.w,l.x+l.w)-new_area_a.x;new_area_a.h=Math.max(a.y+a.h,l.y+l.h)-new_area_a.y;var change_new_area_a=Math.abs(RTree.Rectangle.squarified_ratio(new_area_a.w,new_area_a.h,a.nodes.length+2)-area_a);var new_area_b={};new_area_b.x=Math.min(b.x,l.x);new_area_b.y=Math.min(b.y,l.y);new_area_b.w=Math.max(b.x+b.w,l.x+l.w)-new_area_b.x;new_area_b.h=Math.max(b.y+b.h,l.y+l.h)-new_area_b.y;var change_new_area_b=Math.abs(RTree.Rectangle.squarified_ratio(new_area_b.w,new_area_b.h,b.nodes.length+2)-area_b);if(!high_area_node||!high_area_delta||Math.abs(change_new_area_b-change_new_area_a)<high_area_delta){high_area_node=i;high_area_delta=Math.abs(change_new_area_b-change_new_area_a);lowest_growth_group=change_new_area_b<change_new_area_a?b:a}}var temp_node=nodes.splice(high_area_node,1)[0];if(a.nodes.length+nodes.length+1<=_Min_Width){a.nodes.push(temp_node);RTree.Rectangle.expand_rectangle(a,temp_node)}else{if(b.nodes.length+nodes.length+1<=_Min_Width){b.nodes.push(temp_node);RTree.Rectangle.expand_rectangle(b,temp_node)}else{lowest_growth_group.nodes.push(temp_node);RTree.Rectangle.expand_rectangle(lowest_growth_group,temp_node)}}};var _pick_linear=function(nodes){var lowest_high_x=nodes.length-1;var highest_low_x=0;var lowest_high_y=nodes.length-1;var highest_low_y=0;var t1,t2;for(var i=nodes.length-2;i>=0;i--){var l=nodes[i];if(l.x>nodes[highest_low_x].x){highest_low_x=i}else{if(l.x+l.w<nodes[lowest_high_x].x+nodes[lowest_high_x].w){lowest_high_x=i}}if(l.y>nodes[highest_low_y].y){highest_low_y=i}else{if(l.y+l.h<nodes[lowest_high_y].y+nodes[lowest_high_y].h){lowest_high_y=i}}}var dx=Math.abs((nodes[lowest_high_x].x+nodes[lowest_high_x].w)-nodes[highest_low_x].x);var dy=Math.abs((nodes[lowest_high_y].y+nodes[lowest_high_y].h)-nodes[highest_low_y].y);if(dx>dy){if(lowest_high_x>highest_low_x){t1=nodes.splice(lowest_high_x,1)[0];t2=nodes.splice(highest_low_x,1)[0]}else{t2=nodes.splice(highest_low_x,1)[0];t1=nodes.splice(lowest_high_x,1)[0]}}else{if(lowest_high_y>highest_low_y){t1=nodes.splice(lowest_high_y,1)[0];t2=nodes.splice(highest_low_y,1)[0]}else{t2=nodes.splice(highest_low_y,1)[0];t1=nodes.splice(lowest_high_y,1)[0]}}return([{x:t1.x,y:t1.y,w:t1.w,h:t1.h,nodes:[t1]},{x:t2.x,y:t2.y,w:t2.w,h:t2.h,nodes:[t2]}])};var _attach_data=function(node,more_tree){node.nodes=more_tree.nodes;node.x=more_tree.x;node.y=more_tree.y;node.w=more_tree.w;node.h=more_tree.h;return(node)};var _search_subtree=function(rect,return_node,return_array,root){var hit_stack=[];if(!RTree.Rectangle.overlap_rectangle(rect,root)){return(return_array)}var load_callback=function(local_tree,local_node){return(function(data){local_tree._attach_data(local_node,data)})};hit_stack.push(root.nodes);do{var nodes=hit_stack.pop();for(var i=nodes.length-1;i>=0;i--){var ltree=nodes[i];if(RTree.Rectangle.overlap_rectangle(rect,ltree)){if("nodes" in ltree){hit_stack.push(ltree.nodes)}else{if("leaf" in ltree){if(!return_node){return_array.push(ltree.leaf)}else{return_array.push(ltree)}}}}}}while(hit_stack.length>0);return(return_array)};var _insert_subtree=function(node,root){var bc;if(root.nodes.length==0){root.x=node.x;root.y=node.y;root.w=node.w;root.h=node.h;root.nodes.push(node);return}var tree_stack=_choose_leaf_subtree(node,root);var ret_obj=node;do{if(bc&&"nodes" in bc&&bc.nodes.length==0){var pbc=bc;bc=tree_stack.pop();for(var t=0;t<bc.nodes.length;t++){if(bc.nodes[t]===pbc||bc.nodes[t].nodes.length==0){bc.nodes.splice(t,1);break}}}else{bc=tree_stack.pop()}if("leaf" in ret_obj||"nodes" in ret_obj||isArray(ret_obj)){if(isArray(ret_obj)){for(var ai=0;ai<ret_obj.length;ai++){RTree.Rectangle.expand_rectangle(bc,ret_obj[ai])}bc.nodes=bc.nodes.concat(ret_obj)}else{RTree.Rectangle.expand_rectangle(bc,ret_obj);bc.nodes.push(ret_obj)}if(bc.nodes.length<=_Max_Width){ret_obj={x:bc.x,y:bc.y,w:bc.w,h:bc.h}}else{var a=_linear_split(bc.nodes);ret_obj=a;if(tree_stack.length<1){bc.nodes.push(a[0]);tree_stack.push(bc);ret_obj=a[1]}}}else{RTree.Rectangle.expand_rectangle(bc,ret_obj);ret_obj={x:bc.x,y:bc.y,w:bc.w,h:bc.h}}}while(tree_stack.length>0)};this.get_tree=function(){return _T};this.set_tree=function(new_tree,where){if(!where){where=_T}return(_attach_data(where,new_tree))};this.search=function(rect,return_node,return_array){if(arguments.length<1){throw"Wrong number of arguments. RT.Search requires at least a bounding rectangle."}switch(arguments.length){case 1:arguments[1]=false;case 2:arguments[2]=[];case 3:arguments[3]=_T;default:arguments.length=4}return(_search_subtree.apply(this,arguments))};this.toJSON=function(rect,tree){var hit_stack=[];var count_stack=[];var return_stack={};var max_depth=3;var current_depth=1;var return_string="";if(rect&&!RTree.Rectangle.overlap_rectangle(rect,_T)){return""}if(!tree){count_stack.push(_T.nodes.length);hit_stack.push(_T.nodes);return_string+="var main_tree = {x:"+_T.x.toFixed()+",y:"+_T.y.toFixed()+",w:"+_T.w.toFixed()+",h:"+_T.h.toFixed()+",nodes:["}else{max_depth+=4;count_stack.push(tree.nodes.length);hit_stack.push(tree.nodes);return_string+="var main_tree = {x:"+tree.x.toFixed()+",y:"+tree.y.toFixed()+",w:"+tree.w.toFixed()+",h:"+tree.h.toFixed()+",nodes:["}do{var nodes=hit_stack.pop();var i=count_stack.pop()-1;if(i>=0&&i<nodes.length-1){return_string+=","}while(i>=0){var ltree=nodes[i];if(!rect||RTree.Rectangle.overlap_rectangle(rect,ltree)){if(ltree.nodes){if(current_depth>=max_depth){var len=return_stack.length;var nam=_name_to_id("saved_subtree");return_string+="{x:"+ltree.x.toFixed()+",y:"+ltree.y.toFixed()+",w:"+ltree.w.toFixed()+",h:"+ltree.h.toFixed()+",load:'"+nam+".js'}";return_stack[nam]=this.toJSON(rect,ltree);if(i>0){return_string+=","}}else{return_string+="{x:"+ltree.x.toFixed()+",y:"+ltree.y.toFixed()+",w:"+ltree.w.toFixed()+",h:"+ltree.h.toFixed()+",nodes:[";current_depth+=1;count_stack.push(i);hit_stack.push(nodes);nodes=ltree.nodes;i=ltree.nodes.length}}else{if(ltree.leaf){var data=ltree.leaf.toJSON?ltree.leaf.toJSON():JSON.stringify(ltree.leaf);return_string+="{x:"+ltree.x.toFixed()+",y:"+ltree.y.toFixed()+",w:"+ltree.w.toFixed()+",h:"+ltree.h.toFixed()+",leaf:"+data+"}";if(i>0){return_string+=","}}else{if(ltree.load){return_string+="{x:"+ltree.x.toFixed()+",y:"+ltree.y.toFixed()+",w:"+ltree.w.toFixed()+",h:"+ltree.h.toFixed()+",load:'"+ltree.load+"'}";if(i>0){return_string+=","}}}}}i-=1}if(i<0){return_string+="]}";current_depth-=1}}while(hit_stack.length>0);return_string+=";";for(var my_key in return_stack){return_string+="\nvar "+my_key+" = function(){"+return_stack[my_key]+" return(main_tree);};"}return(return_string)};this.remove=function(rect,obj){if(arguments.length<1){throw"Wrong number of arguments. RT.remove requires at least a bounding rectangle."}switch(arguments.length){case 1:arguments[1]=false;case 2:arguments[2]=_T;default:arguments.length=3}if(arguments[1]===false){var numberdeleted=0;var ret_array=[];do{numberdeleted=ret_array.length;ret_array=ret_array.concat(_remove_subtree.apply(this,arguments))}while(numberdeleted!=ret_array.length);return ret_array}else{return(_remove_subtree.apply(this,arguments))}};this.insert=function(rect,obj){if(arguments.length<2){throw"Wrong number of arguments. RT.Insert requires at least a bounding rectangle and an object."}return(_insert_subtree({x:rect.x,y:rect.y,w:rect.w,h:rect.h,leaf:obj},_T))}};RTree.Rectangle=function(ix,iy,iw,ih){var x,x2,y,y2,w,h;if(ix.x){x=ix.x;y=ix.y;if(ix.w!==0&&!ix.w&&ix.x2){w=ix.x2-ix.x;h=ix.y2-ix.y}else{w=ix.w;h=ix.h}x2=x+w;y2=y+h}else{x=ix;y=iy;w=iw;h=ih;x2=x+w;y2=y+h}this.x1=this.x=function(){return x};this.y1=this.y=function(){return y};this.x2=function(){return x2};this.y2=function(){return y2};this.w=function(){return w};this.h=function(){return h};this.toJSON=function(){return('{"x":'+x.toString()+', "y":'+y.toString()+', "w":'+w.toString()+', "h":'+h.toString()+"}")};this.overlap=function(a){return(this.x()<a.x2()&&this.x2()>a.x()&&this.y()<a.y2()&&this.y2()>a.y())};this.expand=function(a){var nx=Math.min(this.x(),a.x());var ny=Math.min(this.y(),a.y());w=Math.max(this.x2(),a.x2())-nx;h=Math.max(this.y2(),a.y2())-ny;x=nx;y=ny;return(this)};this.setRect=function(ix,iy,iw,ih){var x,x2,y,y2,w,h;if(ix.x){x=ix.x;y=ix.y;if(ix.w!==0&&!ix.w&&ix.x2){w=ix.x2-ix.x;h=ix.y2-ix.y}else{w=ix.w;h=ix.h}x2=x+w;y2=y+h}else{x=ix;y=iy;w=iw;h=ih;x2=x+w;y2=y+h}}};RTree.Rectangle.overlap_rectangle=function(a,b){return(a.x<(b.x+b.w)&&(a.x+a.w)>b.x&&a.y<(b.y+b.h)&&(a.y+a.h)>b.y)};RTree.Rectangle.contains_rectangle=function(a,b){return((a.x+a.w)<=(b.x+b.w)&&a.x>=b.x&&(a.y+a.h)<=(b.y+b.h)&&a.y>=b.y)};RTree.Rectangle.expand_rectangle=function(a,b){var nx=Math.min(a.x,b.x);var ny=Math.min(a.y,b.y);a.w=Math.max(a.x+a.w,b.x+b.w)-nx;a.h=Math.max(a.y+a.h,b.y+b.h)-ny;a.x=nx;a.y=ny;return(a)};RTree.Rectangle.make_MBR=function(nodes,rect){if(nodes.length<1){return({x:0,y:0,w:0,h:0})}if(!rect){rect={x:nodes[0].x,y:nodes[0].y,w:nodes[0].w,h:nodes[0].h}}else{rect.x=nodes[0].x}rect.y=nodes[0].y;rect.w=nodes[0].w;rect.h=nodes[0].h;for(var i=nodes.length-1;i>0;i--){RTree.Rectangle.expand_rectangle(rect,nodes[i])}return(rect)};_gliffy.RTree=RTree;!function(a){a(function(){"use strict",a.support.transition=function(){var b=document.body||document.documentElement,c=b.style,d=c.transition!==undefined||c.WebkitTransition!==undefined||c.MozTransition!==undefined||c.MsTransition!==undefined||c.OTransition!==undefined;return d&&{end:function(){var b="TransitionEnd";return a.browser.webkit?b="webkitTransitionEnd":a.browser.mozilla?b="transitionend":a.browser.opera&&(b="oTransitionEnd"),b}()}}()})}(window.jQuery),!function(a){var b='[data-dismiss="alert"]',c=function(c){a(c).on("click",b,this.close)};c.prototype={constructor:c,close:function(b){function f(){e.trigger("closed").remove()}var c=a(this),d=c.attr("data-target"),e;d||(d=c.attr("href"),d=d&&d.replace(/.*(?=#[^\s]*$)/,"")),e=a(d),e.trigger("close"),b&&b.preventDefault(),e.length||(e=c.hasClass("alert")?c:c.parent()),e.trigger("close").removeClass("in"),a.support.transition&&e.hasClass("fade")?e.on(a.support.transition.end,f):f()}},a.fn.alert=function(b){return this.each(function(){var d=a(this),e=d.data("alert");e||d.data("alert",e=new c(this)),typeof b=="string"&&e[b].call(d)})},a.fn.alert.Constructor=c,a(function(){a("body").on("click.alert.data-api",b,c.prototype.close)})}(window.jQuery),!function(a){var b=function(b,c){this.$element=a(b),this.options=a.extend({},a.fn.button.defaults,c)};b.prototype={constructor:b,setState:function(a){var b="disabled",c=this.$element,d=c.data(),e=c.is("input")?"val":"html";a+="Text",d.resetText||c.data("resetText",c[e]()),c[e](d[a]||this.options[a]),setTimeout(function(){a=="loadingText"?c.addClass(b).attr(b,b):c.removeClass(b).removeAttr(b)},0)},toggle:function(){var a=this.$element.parent('[data-toggle="buttons-radio"]');a&&a.find(".active").removeClass("active"),this.$element.toggleClass("active")}},a.fn.button=function(c){return this.each(function(){var d=a(this),e=d.data("button"),f=typeof c=="object"&&c;e||d.data("button",e=new b(this,f)),c=="toggle"?e.toggle():c&&e.setState(c)})},a.fn.button.defaults={loadingText:"loading..."},a.fn.button.Constructor=b,a(function(){a("body").on("click.button.data-api","[data-toggle^=button]",function(b){var c=a(b.target);c.hasClass("btn")||(c=c.closest(".btn")),c.button("toggle")})})}(window.jQuery),!function(a){var b=function(b,c){this.$element=a(b),this.options=a.extend({},a.fn.carousel.defaults,c),this.options.slide&&this.slide(this.options.slide),this.options.pause=="hover"&&this.$element.on("mouseenter",a.proxy(this.pause,this)).on("mouseleave",a.proxy(this.cycle,this))};b.prototype={cycle:function(){return this.interval=setInterval(a.proxy(this.next,this),this.options.interval),this},to:function(b){var c=this.$element.find(".active"),d=c.parent().children(),e=d.index(c),f=this;if(b>d.length-1||b<0){return}return this.sliding?this.$element.one("slid",function(){f.to(b)}):e==b?this.pause().cycle():this.slide(b>e?"next":"prev",a(d[b]))},pause:function(){return clearInterval(this.interval),this.interval=null,this},next:function(){if(this.sliding){return}return this.slide("next")},prev:function(){if(this.sliding){return}return this.slide("prev")},slide:function(b,c){var d=this.$element.find(".active"),e=c||d[b](),f=this.interval,g=b=="next"?"left":"right",h=b=="next"?"first":"last",i=this;this.sliding=!0,f&&this.pause(),e=e.length?e:this.$element.find(".item")[h]();if(e.hasClass("active")){return}return !a.support.transition&&this.$element.hasClass("slide")?(this.$element.trigger("slide"),d.removeClass("active"),e.addClass("active"),this.sliding=!1,this.$element.trigger("slid")):(e.addClass(b),e[0].offsetWidth,d.addClass(g),e.addClass(g),this.$element.trigger("slide"),this.$element.one(a.support.transition.end,function(){e.removeClass([b,g].join(" ")).addClass("active"),d.removeClass(["active",g].join(" ")),i.sliding=!1,setTimeout(function(){i.$element.trigger("slid")},0)})),f&&this.cycle(),this}},a.fn.carousel=function(c){return this.each(function(){var d=a(this),e=d.data("carousel"),f=typeof c=="object"&&c;e||d.data("carousel",e=new b(this,f)),typeof c=="number"?e.to(c):typeof c=="string"||(c=f.slide)?e[c]():e.cycle()})},a.fn.carousel.defaults={interval:5000,pause:"hover"},a.fn.carousel.Constructor=b,a(function(){a("body").on("click.carousel.data-api","[data-slide]",function(b){var c=a(this),d,e=a(c.attr("data-target")||(d=c.attr("href"))&&d.replace(/.*(?=#[^\s]+$)/,"")),f=!e.data("modal")&&a.extend({},e.data(),c.data());e.carousel(f),b.preventDefault()})})}(window.jQuery),!function(a){var b=function(b,c){this.$element=a(b),this.options=a.extend({},a.fn.collapse.defaults,c),this.options.parent&&(this.$parent=a(this.options.parent)),this.options.toggle&&this.toggle()};b.prototype={constructor:b,dimension:function(){var a=this.$element.hasClass("width");return a?"width":"height"},show:function(){var b=this.dimension(),c=a.camelCase(["scroll",b].join("-")),d=this.$parent&&this.$parent.find(".in"),e;d&&d.length&&(e=d.data("collapse"),d.collapse("hide"),e||d.data("collapse",null)),this.$element[b](0),this.transition("addClass","show","shown"),this.$element[b](this.$element[0][c])},hide:function(){var a=this.dimension();this.reset(this.$element[a]()),this.transition("removeClass","hide","hidden"),this.$element[a](0)},reset:function(a){var b=this.dimension();return this.$element.removeClass("collapse")[b](a||"auto")[0].offsetWidth,this.$element[a?"addClass":"removeClass"]("collapse"),this},transition:function(b,c,d){var e=this,f=function(){c=="show"&&e.reset(),e.$element.trigger(d)};this.$element.trigger(c)[b]("in"),a.support.transition&&this.$element.hasClass("collapse")?this.$element.one(a.support.transition.end,f):f()},toggle:function(){this[this.$element.hasClass("in")?"hide":"show"]()}},a.fn.collapse=function(c){return this.each(function(){var d=a(this),e=d.data("collapse"),f=typeof c=="object"&&c;e||d.data("collapse",e=new b(this,f)),typeof c=="string"&&e[c]()})},a.fn.collapse.defaults={toggle:!0},a.fn.collapse.Constructor=b,a(function(){a("body").on("click.collapse.data-api","[data-toggle=collapse]",function(b){var c=a(this),d,e=c.attr("data-target")||b.preventDefault()||(d=c.attr("href"))&&d.replace(/.*(?=#[^\s]+$)/,""),f=a(e).data("collapse")?"toggle":c.data();a(e).collapse(f)})})}(window.jQuery),!function(a){function d(){a(b).parent().removeClass("open")}"use strict";var b='[data-toggle="dropdown"]',c=function(b){var c=a(b).on("click.dropdown.data-api",this.toggle);a("html").on("click.dropdown.data-api",function(){c.parent().removeClass("open")})};c.prototype={constructor:c,toggle:function(b){var c=a(this),e=c.attr("data-target"),f,g;return e||(e=c.attr("href"),e=e&&e.replace(/.*(?=#[^\s]*$)/,"")),f=a(e),f.length||(f=c.parent()),g=f.hasClass("open"),d(),!g&&f.toggleClass("open"),!1}},a.fn.dropdown=function(b){return this.each(function(){var d=a(this),e=d.data("dropdown");e||d.data("dropdown",e=new c(this)),typeof b=="string"&&e[b].call(d)})},a.fn.dropdown.Constructor=c,a(function(){a("html").on("click.dropdown.data-api",d),a("body").on("click.dropdown.data-api",b,c.prototype.toggle)})}(window.jQuery),!function(a){function c(){var b=this,c=setTimeout(function(){b.$element.off(a.support.transition.end),d.call(b)},500);this.$element.one(a.support.transition.end,function(){clearTimeout(c),d.call(b)})}function d(a){this.$element.hide().trigger("hidden"),e.call(this)}function e(b){var c=this,d=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var e=a.support.transition&&d;this.$backdrop=a('<div class="modal-backdrop '+d+'" />').appendTo(document.body),this.options.backdrop!="static"&&this.$backdrop.click(a.proxy(this.hide,this)),e&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),e?this.$backdrop.one(a.support.transition.end,b):b()}else{!this.isShown&&this.$backdrop?(this.$backdrop.removeClass("in"),a.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one(a.support.transition.end,a.proxy(f,this)):f.call(this)):b&&b()}}function f(){this.$backdrop.remove(),this.$backdrop=null}function g(){var b=this;this.isShown&&this.options.keyboard?a(document).on("keyup.dismiss.modal",function(a){a.which==27&&b.hide()}):this.isShown||a(document).off("keyup.dismiss.modal")}"use strict";var b=function(b,c){this.options=c,this.$element=a(b).delegate('[data-dismiss="modal"]',"click.dismiss.modal",a.proxy(this.hide,this))};b.prototype={constructor:b,toggle:function(){return this[this.isShown?"hide":"show"]()},show:function(){var b=this;if(this.isShown){return}a("body").addClass("modal-open"),this.isShown=!0,this.$element.trigger("show"),g.call(this),e.call(this,function(){var c=a.support.transition&&b.$element.hasClass("fade");!b.$element.parent().length&&b.$element.appendTo(document.body),b.$element.show(),c&&b.$element[0].offsetWidth,b.$element.addClass("in"),c?b.$element.one(a.support.transition.end,function(){b.$element.trigger("shown")}):b.$element.trigger("shown")})},hide:function(b){b&&b.preventDefault();if(!this.isShown){return}var e=this;this.isShown=!1,a("body").removeClass("modal-open"),g.call(this),this.$element.trigger("hide").removeClass("in"),a.support.transition&&this.$element.hasClass("fade")?c.call(this):d.call(this)}},a.fn.modal=function(c){return this.each(function(){var d=a(this),e=d.data("modal"),f=a.extend({},a.fn.modal.defaults,d.data(),typeof c=="object"&&c);e||d.data("modal",e=new b(this,f)),typeof c=="string"?e[c]():f.show&&e.show()})},a.fn.modal.defaults={backdrop:!0,keyboard:!0,show:!0},a.fn.modal.Constructor=b,a(function(){a("body").on("click.modal.data-api",'[data-toggle="modal"]',function(b){var c=a(this),d,e=a(c.attr("data-target")||(d=c.attr("href"))&&d.replace(/.*(?=#[^\s]+$)/,"")),f=e.data("modal")?"toggle":a.extend({},e.data(),c.data());b.preventDefault(),e.modal(f)})})}(window.jQuery),!function(a){var b=function(a,b){this.init("tooltip",a,b)};b.prototype={constructor:b,init:function(b,c,d){var e,f;this.type=b,this.$element=a(c),this.options=this.getOptions(d),this.enabled=!0,this.options.trigger!="manual"&&(e=this.options.trigger=="hover"?"mouseenter":"focus",f=this.options.trigger=="hover"?"mouseleave":"blur",this.$element.on(e,this.options.selector,a.proxy(this.enter,this)),this.$element.on(f,this.options.selector,a.proxy(this.leave,this))),this.options.selector?this._options=a.extend({},this.options,{trigger:"manual",selector:""}):this.fixTitle()},getOptions:function(b){return b=a.extend({},a.fn[this.type].defaults,b,this.$element.data()),b.delay&&typeof b.delay=="number"&&(b.delay={show:b.delay,hide:b.delay}),b},enter:function(b){var c=a(b.currentTarget)[this.type](this._options).data(this.type);!c.options.delay||!c.options.delay.show?c.show():(c.hoverState="in",setTimeout(function(){c.hoverState=="in"&&c.show()},c.options.delay.show))},leave:function(b){var c=a(b.currentTarget)[this.type](this._options).data(this.type);!c.options.delay||!c.options.delay.hide?c.hide():(c.hoverState="out",setTimeout(function(){c.hoverState=="out"&&c.hide()},c.options.delay.hide))},show:function(){var a,b,c,d,e,f,g;if(this.hasContent()&&this.enabled){a=this.tip(),this.setContent(),this.options.animation&&a.addClass("fade"),f=typeof this.options.placement=="function"?this.options.placement.call(this,a[0],this.$element[0]):this.options.placement,b=/in/.test(f),a.remove().css({top:0,left:0,display:"block"}).appendTo(b?this.$element:document.body),c=this.getPosition(b),d=a[0].offsetWidth,e=a[0].offsetHeight;switch(b?f.split(" ")[1]:f){case"bottom":g={top:c.top+c.height,left:c.left+c.width/2-d/2};break;case"top":g={top:c.top-e,left:c.left+c.width/2-d/2};break;case"left":g={top:c.top+c.height/2-e/2,left:c.left-d};break;case"right":g={top:c.top+c.height/2-e/2,left:c.left+c.width}}a.css(g).addClass(f).addClass("in")}},setContent:function(){var a=this.tip();a.find(".tooltip-inner").html(this.getTitle()),a.removeClass("fade in top bottom left right")},hide:function(){function d(){var b=setTimeout(function(){c.off(a.support.transition.end).remove()},500);c.one(a.support.transition.end,function(){clearTimeout(b),c.remove()})}var b=this,c=this.tip();c.removeClass("in"),a.support.transition&&this.$tip.hasClass("fade")?d():c.remove()},fixTitle:function(){var a=this.$element;(a.attr("title")||typeof a.attr("data-original-title")!="string")&&a.attr("data-original-title",a.attr("title")||"").removeAttr("title")},hasContent:function(){return this.getTitle()},getPosition:function(b){return a.extend({},b?{top:0,left:0}:this.$element.offset(),{width:this.$element[0].offsetWidth,height:this.$element[0].offsetHeight})},getTitle:function(){var a,b=this.$element,c=this.options;return a=b.attr("data-original-title")||(typeof c.title=="function"?c.title.call(b[0]):c.title),a=(a||"").toString().replace(/(^\s*|\s*$)/,""),a},tip:function(){return this.$tip=this.$tip||a(this.options.template)},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled},toggle:function(){this[this.tip().hasClass("in")?"hide":"show"]()}},a.fn.tooltip=function(c){return this.each(function(){var d=a(this),e=d.data("tooltip"),f=typeof c=="object"&&c;e||d.data("tooltip",e=new b(this,f)),typeof c=="string"&&e[c]()})},a.fn.tooltip.Constructor=b,a.fn.tooltip.defaults={animation:!0,delay:0,selector:!1,placement:"top",trigger:"hover",title:"",template:'<div class="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'}}(window.jQuery),!function(a){var b=function(a,b){this.init("popover",a,b)};b.prototype=a.extend({},a.fn.tooltip.Constructor.prototype,{constructor:b,setContent:function(){var b=this.tip(),c=this.getTitle(),d=this.getContent();b.find(".popover-title")[a.type(c)=="object"?"append":"html"](c),b.find(".popover-content > *")[a.type(d)=="object"?"append":"html"](d),b.removeClass("fade top bottom left right in")},hasContent:function(){return this.getTitle()||this.getContent()},getContent:function(){var a,b=this.$element,c=this.options;return a=b.attr("data-content")||(typeof c.content=="function"?c.content.call(b[0]):c.content),a=a.toString().replace(/(^\s*|\s*$)/,""),a},tip:function(){return this.$tip||(this.$tip=a(this.options.template)),this.$tip}}),a.fn.popover=function(c){return this.each(function(){var d=a(this),e=d.data("popover"),f=typeof c=="object"&&c;e||d.data("popover",e=new b(this,f)),typeof c=="string"&&e[c]()})},a.fn.popover.Constructor=b,a.fn.popover.defaults=a.extend({},a.fn.tooltip.defaults,{placement:"right",content:"",template:'<div class="popover"><div class="arrow"></div><div class="popover-inner"><h3 class="popover-title"></h3><div class="popover-content"><p></p></div></div></div>'})}(window.jQuery),!function(a){function b(b,c){var d=a.proxy(this.process,this),e=a(b).is("body")?a(window):a(b),f;this.options=a.extend({},a.fn.scrollspy.defaults,c),this.$scrollElement=e.on("scroll.scroll.data-api",d),this.selector=(this.options.target||(f=a(b).attr("href"))&&f.replace(/.*(?=#[^\s]+$)/,"")||"")+" .nav li > a",this.$body=a("body").on("click.scroll.data-api",this.selector,d),this.refresh(),this.process()}"use strict",b.prototype={constructor:b,refresh:function(){this.targets=this.$body.find(this.selector).map(function(){var b=a(this).attr("href");return/^#\w/.test(b)&&a(b).length?b:null}),this.offsets=a.map(this.targets,function(b){return a(b).position().top})},process:function(){var a=this.$scrollElement.scrollTop()+this.options.offset,b=this.offsets,c=this.targets,d=this.activeTarget,e;for(e=b.length;e--;){d!=c[e]&&a>=b[e]&&(!b[e+1]||a<=b[e+1])&&this.activate(c[e])}},activate:function(a){var b;this.activeTarget=a,this.$body.find(this.selector).parent(".active").removeClass("active"),b=this.$body.find(this.selector+'[href="'+a+'"]').parent("li").addClass("active"),b.parent(".dropdown-menu")&&b.closest("li.dropdown").addClass("active")}},a.fn.scrollspy=function(c){return this.each(function(){var d=a(this),e=d.data("scrollspy"),f=typeof c=="object"&&c;e||d.data("scrollspy",e=new b(this,f)),typeof c=="string"&&e[c]()})},a.fn.scrollspy.Constructor=b,a.fn.scrollspy.defaults={offset:10},a(function(){a('[data-spy="scroll"]').each(function(){var b=a(this);b.scrollspy(b.data())})})}(window.jQuery),!function(a){var b=function(b){this.element=a(b)};b.prototype={constructor:b,show:function(){var b=this.element,c=b.closest("ul:not(.dropdown-menu)"),d=b.attr("data-target"),e,f;d||(d=b.attr("href"),d=d&&d.replace(/.*(?=#[^\s]*$)/,""));if(b.parent("li").hasClass("active")){return}e=c.find(".active a").last()[0],b.trigger({type:"show",relatedTarget:e}),f=a(d),this.activate(b.parent("li"),c),this.activate(f,f.parent(),function(){b.trigger({type:"shown",relatedTarget:e})})},activate:function(b,c,d){function g(){e.removeClass("active").find("> .dropdown-menu > .active").removeClass("active"),b.addClass("active"),f?(b[0].offsetWidth,b.addClass("in")):b.removeClass("fade"),b.parent(".dropdown-menu")&&b.closest("li.dropdown").addClass("active"),d&&d()}var e=c.find("> .active"),f=d&&a.support.transition&&e.hasClass("fade");f?e.one(a.support.transition.end,g):g(),e.removeClass("in")}},a.fn.tab=function(c){return this.each(function(){var d=a(this),e=d.data("tab");e||d.data("tab",e=new b(this)),typeof c=="string"&&e[c]()})},a.fn.tab.Constructor=b,a(function(){a("body").on("click.tab.data-api",'[data-toggle="tab"], [data-toggle="pill"]',function(b){b.preventDefault(),a(this).tab("show")})})}(window.jQuery),!function(a){var b=function(b,c){this.$element=a(b),this.options=a.extend({},a.fn.typeahead.defaults,c),this.matcher=this.options.matcher||this.matcher,this.sorter=this.options.sorter||this.sorter,this.highlighter=this.options.highlighter||this.highlighter,this.$menu=a(this.options.menu).appendTo("body"),this.source=this.options.source,this.shown=!1,this.listen()};b.prototype={constructor:b,select:function(){var a=this.$menu.find(".active").attr("data-value");return this.$element.val(a),this.$element.change(),this.hide()},show:function(){var b=a.extend({},this.$element.offset(),{height:this.$element[0].offsetHeight});return this.$menu.css({top:b.top+b.height,left:b.left}),this.$menu.show(),this.shown=!0,this},hide:function(){return this.$menu.hide(),this.shown=!1,this},lookup:function(b){var c=this,d,e;return this.query=this.$element.val(),this.query?(d=a.grep(this.source,function(a){if(c.matcher(a)){return a}}),d=this.sorter(d),d.length?this.render(d.slice(0,this.options.items)).show():this.shown?this.hide():this):this.shown?this.hide():this},matcher:function(a){return ~a.toLowerCase().indexOf(this.query.toLowerCase())},sorter:function(a){var b=[],c=[],d=[],e;while(e=a.shift()){e.toLowerCase().indexOf(this.query.toLowerCase())?~e.indexOf(this.query)?c.push(e):d.push(e):b.push(e)}return b.concat(c,d)},highlighter:function(a){return a.replace(new RegExp("("+this.query+")","ig"),function(a,b){return"<strong>"+b+"</strong>"})},render:function(b){var c=this;return b=a(b).map(function(b,d){return b=a(c.options.item).attr("data-value",d),b.find("a").html(c.highlighter(d)),b[0]}),b.first().addClass("active"),this.$menu.html(b),this},next:function(b){var c=this.$menu.find(".active").removeClass("active"),d=c.next();d.length||(d=a(this.$menu.find("li")[0])),d.addClass("active")},prev:function(a){var b=this.$menu.find(".active").removeClass("active"),c=b.prev();c.length||(c=this.$menu.find("li").last()),c.addClass("active")},listen:function(){this.$element.on("blur",a.proxy(this.blur,this)).on("keypress",a.proxy(this.keypress,this)).on("keyup",a.proxy(this.keyup,this)),(a.browser.webkit||a.browser.msie)&&this.$element.on("keydown",a.proxy(this.keypress,this)),this.$menu.on("click",a.proxy(this.click,this)).on("mouseenter","li",a.proxy(this.mouseenter,this))},keyup:function(a){switch(a.keyCode){case 40:case 38:break;case 9:case 13:if(!this.shown){return}this.select();break;case 27:if(!this.shown){return}this.hide();break;default:this.lookup()}a.stopPropagation(),a.preventDefault()},keypress:function(a){if(!this.shown){return}switch(a.keyCode){case 9:case 13:case 27:a.preventDefault();break;case 38:a.preventDefault(),this.prev();break;case 40:a.preventDefault(),this.next()}a.stopPropagation()},blur:function(a){var b=this;setTimeout(function(){b.hide()},150)},click:function(a){a.stopPropagation(),a.preventDefault(),this.select()},mouseenter:function(b){this.$menu.find(".active").removeClass("active"),a(b.currentTarget).addClass("active")}},a.fn.typeahead=function(c){return this.each(function(){var d=a(this),e=d.data("typeahead"),f=typeof c=="object"&&c;e||d.data("typeahead",e=new b(this,f)),typeof c=="string"&&e[c]()})},a.fn.typeahead.defaults={source:[],items:8,menu:'<ul class="typeahead dropdown-menu"></ul>',item:'<li><a href="#"></a></li>'},a.fn.typeahead.Constructor=b,a(function(){a("body").on("focus.typeahead.data-api",'[data-provide="typeahead"]',function(b){var c=a(this);if(c.data("typeahead")){return}b.preventDefault(),c.typeahead(c.data())})})}(window.jQuery);!function($){var Slider=function(element,options){this.element=$(element);this.picker=$('<div class="slider"><div class="slider-track"><div class="slider-selection"></div><div class="slider-handle"></div><div class="slider-handle"></div></div><div class="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div></div>').insertBefore(this.element).append(this.element);this.id=this.element.data("slider-id")||options.id;if(this.id){this.picker[0].id=this.id}if(typeof Modernizr!=="undefined"&&Modernizr.touch){this.touchCapable=true}var tooltip=this.element.data("slider-tooltip")||options.tooltip;this.tooltip=this.picker.find(".tooltip");this.tooltipInner=this.tooltip.find("div.tooltip-inner");this.orientation=this.element.data("slider-orientation")||options.orientation;switch(this.orientation){case"vertical":this.picker.addClass("slider-vertical");this.stylePos="top";this.mousePos="pageY";this.sizePos="offsetHeight";this.tooltip.addClass("right")[0].style.left="100%";break;default:this.picker.addClass("slider-horizontal").css("width",this.element.outerWidth());this.orientation="horizontal";this.stylePos="left";this.mousePos="pageX";this.sizePos="offsetWidth";this.tooltip.addClass("top")[0].style.top=-this.tooltip.outerHeight()-14+"px";break}this.min=this.element.data("slider-min")||options.min;this.max=this.element.data("slider-max")||options.max;this.step=this.element.data("slider-step")||options.step;this.value=this.element.data("slider-value")||options.value;if(this.value[1]){this.range=true}this.selection=this.element.data("slider-selection")||options.selection;this.selectionEl=this.picker.find(".slider-selection");if(this.selection==="none"){this.selectionEl.addClass("hide")}this.selectionElStyle=this.selectionEl[0].style;this.handle1=this.picker.find(".slider-handle:first");this.handle1Stype=this.handle1[0].style;this.handle2=this.picker.find(".slider-handle:last");this.handle2Stype=this.handle2[0].style;var handle=this.element.data("slider-handle")||options.handle;switch(handle){case"round":this.handle1.addClass("round");this.handle2.addClass("round");break;case"triangle":this.handle1.addClass("triangle");this.handle2.addClass("triangle");break}if(this.range){this.value[0]=Math.max(this.min,Math.min(this.max,this.value[0]));this.value[1]=Math.max(this.min,Math.min(this.max,this.value[1]))}else{this.value=[Math.max(this.min,Math.min(this.max,this.value))];this.handle2.addClass("hide");if(this.selection=="after"){this.value[1]=this.max}else{this.value[1]=this.min}}this.diff=this.max-this.min;this.percentage=[(this.value[0]-this.min)*100/this.diff,(this.value[1]-this.min)*100/this.diff,this.step*100/this.diff];this.offset=this.picker.offset();this.size=this.picker[0][this.sizePos];this.formater=options.formater;this.layout();if(this.touchCapable){this.picker.on({touchstart:$.proxy(this.mousedown,this)})}else{this.picker.on({mousedown:$.proxy(this.mousedown,this)})}if(tooltip==="show"){this.picker.on({mouseenter:$.proxy(this.showTooltip,this),mouseleave:$.proxy(this.hideTooltip,this)})}else{this.tooltip.addClass("hide")}};Slider.prototype={constructor:Slider,over:false,inDrag:false,showTooltip:function(){this.tooltip.addClass("in");this.over=true},hideTooltip:function(){if(this.inDrag===false){this.tooltip.removeClass("in")}this.over=false},layout:function(){this.handle1Stype[this.stylePos]=this.percentage[0]+"%";this.handle2Stype[this.stylePos]=this.percentage[1]+"%";if(this.orientation=="vertical"){this.selectionElStyle.top=Math.min(this.percentage[0],this.percentage[1])+"%";this.selectionElStyle.height=Math.abs(this.percentage[0]-this.percentage[1])+"%"}else{this.selectionElStyle.left=Math.min(this.percentage[0],this.percentage[1])+"%";this.selectionElStyle.width=Math.abs(this.percentage[0]-this.percentage[1])+"%"}if(this.range){this.tooltipInner.text(this.formater(this.value[0])+" : "+this.formater(this.value[1]));this.tooltip[0].style[this.stylePos]=this.size*(this.percentage[0]+(this.percentage[1]-this.percentage[0])/2)/100-(this.orientation==="vertical"?this.tooltip.outerHeight()/2:this.tooltip.outerWidth()/2)+"px"}else{this.tooltipInner.text(this.formater(this.value[0]));this.tooltip[0].style[this.stylePos]=this.size*this.percentage[0]/100-(this.orientation==="vertical"?this.tooltip.outerHeight()/2:this.tooltip.outerWidth()/2)+"px"}},mousedown:function(ev){if(this.touchCapable&&ev.type==="touchstart"){ev=ev.originalEvent}this.offset=this.picker.offset();this.size=this.picker[0][this.sizePos];var percentage=this.getPercentage(ev);if(this.range){var diff1=Math.abs(this.percentage[0]-percentage);var diff2=Math.abs(this.percentage[1]-percentage);this.dragged=(diff1<diff2)?0:1}else{this.dragged=0}this.percentage[this.dragged]=percentage;this.layout();if(this.touchCapable){$(document).on({touchmove:$.proxy(this.mousemove,this),touchend:$.proxy(this.mouseup,this)})}else{$(document).on({mousemove:$.proxy(this.mousemove,this),mouseup:$.proxy(this.mouseup,this)})}this.inDrag=true;var val=this.calculateValue();this.element.trigger({type:"slideStart",value:val}).trigger({type:"slide",value:val});return false},mousemove:function(ev){if(this.touchCapable&&ev.type==="touchmove"){ev=ev.originalEvent}var percentage=this.getPercentage(ev);if(this.range){if(this.dragged===0&&this.percentage[1]<percentage){this.percentage[0]=this.percentage[1];this.dragged=1}else{if(this.dragged===1&&this.percentage[0]>percentage){this.percentage[1]=this.percentage[0];this.dragged=0}}}this.percentage[this.dragged]=percentage;this.layout();var val=this.calculateValue();this.element.trigger({type:"slide",value:val}).data("value",val).prop("value",val);return false},mouseup:function(ev){if(this.touchCapable){$(document).off({touchmove:this.mousemove,touchend:this.mouseup})}else{$(document).off({mousemove:this.mousemove,mouseup:this.mouseup})}this.inDrag=false;if(this.over==false){this.hideTooltip()}this.element;var val=this.calculateValue();this.element.trigger({type:"slideStop",value:val}).data("value",val).prop("value",val);return false},calculateValue:function(){var val;if(this.range){val=[(this.min+Math.round((this.diff*this.percentage[0]/100)/this.step)*this.step),(this.min+Math.round((this.diff*this.percentage[1]/100)/this.step)*this.step)];this.value=val}else{val=(this.min+Math.round((this.diff*this.percentage[0]/100)/this.step)*this.step);this.value=[val,this.value[1]]}return val},getPercentage:function(ev){if(this.touchCapable){ev=ev.touches[0]}var percentage=(ev[this.mousePos]-this.offset[this.stylePos])*100/this.size;percentage=Math.round(percentage/this.percentage[2])*this.percentage[2];return Math.max(0,Math.min(100,percentage))},getValue:function(){if(this.range){return this.value}return this.value[0]},setValue:function(val){this.value=val;if(this.range){this.value[0]=Math.max(this.min,Math.min(this.max,this.value[0]));this.value[1]=Math.max(this.min,Math.min(this.max,this.value[1]))}else{this.value=[Math.max(this.min,Math.min(this.max,this.value))];this.handle2.addClass("hide");if(this.selection=="after"){this.value[1]=this.max}else{this.value[1]=this.min}}this.diff=this.max-this.min;this.percentage=[(this.value[0]-this.min)*100/this.diff,(this.value[1]-this.min)*100/this.diff,this.step*100/this.diff];this.layout()}};$.fn.slider=function(option,val){return this.each(function(){var $this=$(this),data=$this.data("slider"),options=typeof option==="object"&&option;if(!data){$this.data("slider",(data=new Slider(this,$.extend({},$.fn.slider.defaults,options))))}if(typeof option=="string"){data[option](val)}})};$.fn.slider.defaults={min:0,max:10,step:1,orientation:"horizontal",value:5,selection:"before",tooltip:"show",handle:"round",formater:function(value){return value}};$.fn.slider.Constructor=Slider}(window.jQuery);window.GliffyApp=Ember.Application.createWithMixins({name:"GliffyApp",ready:function(){var dictionary,latinize,debug=_gliffy.Debug.I18N_UNDERSCORES,os,browser,english,otherLanguage=null,missingKeys=[],checkMissingKeys=true;english=GLIFFY.DICTIONARY?(GLIFFY.DICTIONARY.en||{}):{};if(GLIFFY.DICTIONARY){$.each(GLIFFY.DICTIONARY,function(key,value){if(key!=="en"){otherLanguage=value;return false}})}if(otherLanguage){if(checkMissingKeys){$.each(english,function(key,value){if(!otherLanguage[key]){missingKeys.push(key)}});if(missingKeys.length!==0){_gliffy.Logger.log("Warning, missing keys: "+JSON.stringify(missingKeys))}}dictionary=$.extend({},english,otherLanguage)}else{dictionary=english}os=_gliffy.BrowserDetect.OS.toUpperCase();if(os!=="WINDOWS"&&os!=="MAC"){os="WINDOWS"}browser=_gliffy.BrowserDetect.browser.toUpperCase();if(browser!=="CHROME"&&browser!=="FIREFOX"&&browser!=="EXPLORER"){browser="CHROME"}function getValue(key,options){var params=[];if(Array.isArray(options.params)){params=options.params.slice(0,-1)}var result=$.i18n._(Ember.Handlebars.Utils.escapeExpression(key)+(options.includeOS?("_"+os):"")+(options.includeBrowser?("_"+browser):""),params);return new Ember.Handlebars.SafeString(result)}Ember.Handlebars.registerHelper("i18n",function(key,params){var params=Array.prototype.slice.call(arguments,1),options={params:params,includeOS:false,includeBrowser:false};return getValue(key,options)});Ember.Handlebars.registerHelper("i18n_args",function(key,params){var params=Array.prototype.slice.call(arguments,1),options={includeOS:false,includeBrowser:false},translatedParams=[],i;for(i=0;i<params.length;i++){translatedParams.push(getValue(params[i],options))}options.params=translatedParams;return getValue(key,options)});Ember.Handlebars.registerHelper("i18n_os",function(key,params){var params=Array.prototype.slice.call(arguments,1),options={params:params,includeOS:true,includeBrowser:false};return getValue(key,options)});Ember.Handlebars.registerHelper("i18n_os_browser",function(key,params){var params=Array.prototype.slice.call(arguments,1),options={params:params,includeOS:true,includeBrowser:true};return getValue(key,options)});Ember.Handlebars.registerHelper("i18n_os_safari_num_key",function(key,params){var params=Array.prototype.slice.call(arguments,1),options={params:params,includeOS:true,includeBrowser:false},translation;var val=getValue(key,options);if(_gliffy.BrowserDetect.browser==="Safari"){translation=$.i18n._(val);return translation.toString().replace("&#8984;","Ctrl")}return val});Em.View.reopen({willDestroy:function(){this._super();this.set("bindingContext",null);this.set("controller",null);try{this.set("templateData",null)}catch(e){}}});var origExtend=Ember.CoreObject.ClassMixin.mixins[0].properties.extend;Ember.CoreObject.ClassMixin.mixins[0].properties.extend=function(){this.subclasses=null;return origExtend.apply(this,arguments)};latinize=function(text){text=text.replace(/\b([aeiou][a-z]*)\b/gi,"$1way");text=text.replace(/\b([bcdfghjklmnpqrstvwxy]+)([a-z]*)\b/gi,"$2$1ay");return text};if(debug){$.each(dictionary,function(key,value){if(key!=="TINYMCE_LANGUAGE_CODE"){dictionary[key]="_"+value}})}$.i18n.setDictionary(_gliffy.Utils.getI18nDictionary())}});GliffyApp.Router=Ember.Router.extend({location:"none"});(function(){_gliffy.BrowserDetect={init:function(){var isIE11=!!navigator.userAgent.match(/Trident\/7.0/);if(isIE11){this.browser="Explorer";this.version=11}else{this.browser=this.searchString(this.dataBrowser)||"An unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version"}this.OS=this.searchString(this.dataOS)||"an unknown OS"},dump:function(){return"OS: "+this.OS+", Browser: "+this.browser+", Version: "+this.version},searchString:function(data){for(var i=0;i<data.length;i++){var dataString=data[i].string;var dataProp=data[i].prop;this.versionSearchString=data[i].versionSearch||data[i].identity;if(dataString){if(dataString.indexOf(data[i].subString)!=-1){return data[i].identity}}else{if(dataProp){return data[i].identity}}}},searchVersion:function(dataString){var index=dataString.indexOf(this.versionSearchString);if(index==-1){return}return parseFloat(dataString.substring(index+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};_gliffy.BrowserDetect.init()}());(function(){if(typeof Function.empty!="function"){Function.empty=function(){}}if(typeof console=="undefined"){console={}}if(typeof console.log=="undefined"){console.log=Function.empty}if(typeof console.debug=="undefined"){console.debug=log}if(typeof console.info=="undefined"){console.info=log}if(typeof console.warn=="undefined"){console.warn=log}if(typeof console.error=="undefined"){console.error=log}if(typeof console.assert=="undefined"){console.assert=function(){var args=Array.prototype.slice.call(arguments);var parm=args.shift();if(!parm){console.error(arguments);throw new Error("Assert failed.")}}}if(typeof console.dir=="undefined"){console.dir=function(input){if(typeof JSON!="undefined"&&typeof JSON.stringify=="function"){console.log(JSON.stringify(input))}else{console.log(input.toString())}}}if(typeof console.dirxml=="undefined"){console.dirxml=console.dir}if(typeof console.trace=="undefined"){console.trace=Function.empty}if(typeof console.group=="undefined"){console.group=Function.empty}if(typeof console.groupCollapsed=="undefined"){console.groupCollapsed=Function.empty}if(typeof console.groupEnd=="undefined"){console.groupEnd=Function.empty}if(typeof console.time=="undefined"){console.time=Function.empty}if(typeof console.timeEnd=="undefined"){console.timeEnd=Function.empty}if(typeof console.profile=="undefined"){console.profile=Function.empty}if(typeof console.profileEnd=="undefined"){console.profileEnd=Function.empty}if(typeof console.count=="undefined"){console.count=Function.empty}function log(){if(typeof JSON!="undefined"&&typeof JSON.stringify=="function"){return console.log(JSON.stringify(arguments))}return console.log(arguments.toString())}})();
/*!!
 * jqModal - Minimalist Modaling with jQuery
 *   (http://dev.iceburg.net/jquery/jqModal/)
 *
 * Copyright (c) 2007,2008 Brice Burgess <bhb@iceburg.net>
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 * 
 * $Version: 03/01/2009 +r14
 */
(function($){$.fn.jqm=function(o){var p={overlay:50,overlayClass:"jqmOverlay",closeClass:"jqmClose",trigger:".jqModal",ajax:F,ajaxText:"",target:F,modal:F,toTop:F,onShow:F,onHide:F,onLoad:F};return this.each(function(){if(this._jqm){return H[this._jqm].c=$.extend({},H[this._jqm].c,o)}s++;this._jqm=s;H[s]={c:$.extend(p,$.jqm.params,o),a:F,w:$(this).addClass("jqmID"+s),s:s};if(p.trigger){$(this).jqmAddTrigger(p.trigger)}})};$.fn.jqmAddClose=function(e){return hs(this,e,"jqmHide")};$.fn.jqmAddTrigger=function(e){return hs(this,e,"jqmShow")};$.fn.jqmShow=function(t){return this.each(function(){t=t||window.event;$.jqm.open(this._jqm,t)})};$.fn.jqmHide=function(t){return this.each(function(){t=t||window.event;$.jqm.close(this._jqm,t)})};$.jqm={hash:{},open:function(s,t){var h=H[s],c=h.c,cc="."+c.closeClass,z=(parseInt(h.w.css("z-index"))),z=(z>0)?z:3000,o=$("<div></div>").css({height:"100%",width:"100%",position:"fixed",left:0,top:0,"z-index":z-1,opacity:c.overlay/100});if(h.a){return F}h.t=t;h.a=true;h.w.css("z-index",z);if(c.modal){if(!A[0]){L("bind")}A.push(s)}else{if(c.overlay>0){h.w.jqmAddClose(o)}else{o=F}}h.o=(o)?o.addClass(c.overlayClass).prependTo("body"):F;if(ie6){$("html,body").css({height:"100%",width:"100%"});if(o){o=o.css({position:"absolute"})[0];for(var y in {Top:1,Left:1}){o.style.setExpression(y.toLowerCase(),"(_=(document.documentElement.scroll"+y+" || document.body.scroll"+y+"))+'px'")}}}if(c.ajax){var r=c.target||h.w,u=c.ajax,r=(typeof r=="string")?$(r,h.w):$(r),u=(u.substr(0,1)=="@")?$(t).attr(u.substring(1)):u;r.html(c.ajaxText).load(u,function(){if(c.onLoad){c.onLoad.call(this,h)}if(cc){h.w.jqmAddClose($(cc,h.w))}e(h)})}else{if(cc){h.w.jqmAddClose($(cc,h.w))}}if(c.toTop&&h.o){h.w.before('<span id="jqmP'+h.w[0]._jqm+'"></span>').insertAfter(h.o)}(c.onShow)?c.onShow(h):h.w.show();return F},close:function(s){var h=H[s];if(!h.a){return F}h.a=F;if(A[0]){A.pop();if(!A[0]){L("unbind")}}if(h.c.toTop&&h.o){$("#jqmP"+h.w[0]._jqm).after(h.w).remove()}if(h.c.onHide){h.c.onHide(h)}else{h.w.hide();if(h.o){h.o.remove()}}return F},params:{}};var s=0,H=$.jqm.hash,A=[],ie6=$.browser.msie&&($.browser.version=="6.0"),F=false,i=$('<iframe src="javascript:false;document.write(\'\');" class="jqm"></iframe>').css({opacity:0}),e=function(h){if(ie6){if(h.o){h.o.html('<p style="width:100%;height:100%"/>').prepend(i)}else{if(!$("iframe.jqm",h.w)[0]){h.w.prepend(i)}}}f(h)},f=function(h){try{if($(":input:visible",h.w).length>0){$(":input:visible",h.w)[0].focus()}}catch(_){}},L=function(t){$()[t]("keypress",m)[t]("keydown",m)[t]("mousedown",m)},m=function(e){var h=H[A[A.length-1]],r=(!$(e.target).parents(".jqmID"+h.s)[0]);if(r){f(h)}return !r},hs=function(w,t,c){return w.each(function(){var s=this._jqm;$(t).each(function(){if(!this[c]){this[c]=[];$(this).click(function(){for(var i in {jqmShow:1,jqmHide:1}){for(var s in this[i]){if(H[this[i][s]]){H[this[i][s]].w[i](this)}}}return F})}this[c].push(s)})})}})(jQuery);
/*!!
 * jquery.event.drag - v 2.0.0 
 * Copyright (c) 2010 Three Dub Media - http://threedubmedia.com
 * Open Source MIT License - http://threedubmedia.com/code/license
 */
(function($){$.fn.drag=function(str,arg,opts){var type=typeof str=="string"?str:"",fn=$.isFunction(str)?str:$.isFunction(arg)?arg:null;if(type.indexOf("drag")!==0){type="drag"+type}opts=(str==fn?arg:opts)||{};return fn?this.bind(type,opts,fn):this.trigger(type)};var $event=$.event,$special=$event.special,drag=$special.drag={defaults:{which:1,distance:0,not:":input",handle:null,relative:false,drop:true,click:false},datakey:"dragdata",livekey:"livedrag",add:function(obj){var data=$.data(this,drag.datakey),opts=obj.data||{};data.related+=1;if(!data.live&&obj.selector){data.live=true;$event.add(this,"draginit."+drag.livekey,drag.delegate)}$.each(drag.defaults,function(key,def){if(opts[key]!==undefined){data[key]=opts[key]}})},remove:function(){$.data(this,drag.datakey).related-=1},setup:function(){if($.data(this,drag.datakey)){return}var data=$.extend({related:0},drag.defaults);$.data(this,drag.datakey,data);$event.add(this,"mousedown",drag.init,data);if(this.attachEvent){this.attachEvent("ondragstart",drag.dontstart)}},teardown:function(){if($.data(this,drag.datakey).related){return}$.removeData(this,drag.datakey);$event.remove(this,"mousedown",drag.init);$event.remove(this,"draginit",drag.delegate);drag.textselect(true,$(this).closest("html").parent().get(0));if(this.detachEvent){this.detachEvent("ondragstart",drag.dontstart)}},init:function(event){var dd=event.data,results;if(dd.which>0&&event.which!=dd.which){return}if($(event.target).is(dd.not)){return}if(dd.handle&&!$(event.target).closest(dd.handle,event.currentTarget).length){return}dd.propagates=1;dd.document=this.ownerDocument;dd.interactions=[drag.interaction(this,dd)];dd.target=event.target;dd.pageX=event.pageX;dd.pageY=event.pageY;dd.dragging=null;results=drag.hijack(event,"draginit",dd);if(!dd.propagates){return}results=drag.flatten(results);if(results&&results.length){dd.interactions=[];$.each(results,function(){dd.interactions.push(drag.interaction(this,dd))})}dd.propagates=dd.interactions.length;if(dd.drop!==false&&$special.drop){$special.drop.handler(event,dd)}drag.textselect(false,dd.document);$event.add($(this).closest("html").parent().get(0),"mousemove mouseup",drag.handler,dd);return false},interaction:function(elem,dd){return{drag:elem,callback:new drag.callback(),droppable:[],offset:$(elem)[dd.relative?"position":"offset"]()||{top:0,left:0}}},handler:function(event){var dd=event.data;switch(event.type){case !dd.dragging&&"mousemove":if(Math.pow(event.pageX-dd.pageX,2)+Math.pow(event.pageY-dd.pageY,2)<Math.pow(dd.distance,2)){break}event.target=dd.target;drag.hijack(event,"dragstart",dd);if(dd.propagates){dd.dragging=true}case"mousemove":if(dd.dragging){drag.hijack(event,"drag",dd);if(dd.propagates){if(dd.drop!==false&&$special.drop){$special.drop.handler(event,dd)}break}event.type="mouseup"}case"mouseup":$event.remove(dd.document,"mousemove mouseup",drag.handler);if(dd.dragging){if(dd.drop!==false&&$special.drop){$special.drop.handler(event,dd)}drag.hijack(event,"dragend",dd)}drag.textselect(true,dd.document);if(dd.click===false&&dd.dragging){jQuery.event.triggered=true;setTimeout(function(){jQuery.event.triggered=false},20);dd.dragging=false}break}},delegate:function(event){var elems=[],target,events=$.data(this,"events")||{};$.each(events.live||[],function(i,obj){if(obj.preType.indexOf("drag")!==0){return}target=$(event.target).closest(obj.selector,event.currentTarget)[0];if(!target){return}$event.add(target,obj.origType+"."+drag.livekey,obj.origHandler,obj.data);if($.inArray(target,elems)<0){elems.push(target)}});if(!elems.length){return false}return $(elems).bind("dragend."+drag.livekey,function(){$event.remove(this,"."+drag.livekey)})},hijack:function(event,type,dd,x,elem){if(!dd){return}var orig={event:event.originalEvent,type:event.type},mode=type.indexOf("drop")?"drag":"drop",result,i=x||0,ia,$elems,callback,len=!isNaN(x)?x:dd.interactions.length;event.type=type;event.originalEvent=null;dd.results=[];do{if(ia=dd.interactions[i]){if(type!=="dragend"&&ia.cancelled){continue}callback=drag.properties(event,dd,ia);ia.results=[];$(elem||ia[mode]||dd.droppable).each(function(p,subject){callback.target=subject;result=subject?$event.handle.call(subject,event,callback):null;if(result===false){if(mode=="drag"){ia.cancelled=true;dd.propagates-=1}if(type=="drop"){ia[mode][p]=null}}else{if(type=="dropinit"){ia.droppable.push(drag.element(result)||subject)}}if(type=="dragstart"){ia.proxy=$(drag.element(result)||ia.drag)[0]}ia.results.push(result);delete event.result;if(type!=="dropinit"){return result}});dd.results[i]=drag.flatten(ia.results);if(type=="dropinit"){ia.droppable=drag.flatten(ia.droppable)}if(type=="dragstart"&&!ia.cancelled){callback.update()}}}while(++i<len);event.type=orig.type;event.originalEvent=orig.event;return drag.flatten(dd.results)},properties:function(event,dd,ia){var obj=ia.callback;obj.drag=ia.drag;obj.proxy=ia.proxy||ia.drag;obj.startX=dd.pageX;obj.startY=dd.pageY;obj.deltaX=event.pageX-dd.pageX;obj.deltaY=event.pageY-dd.pageY;obj.originalX=ia.offset.left;obj.originalY=ia.offset.top;obj.offsetX=event.pageX-(dd.pageX-obj.originalX);obj.offsetY=event.pageY-(dd.pageY-obj.originalY);obj.drop=drag.flatten((ia.drop||[]).slice());obj.available=drag.flatten((ia.droppable||[]).slice());return obj},element:function(arg){if(arg&&(arg.jquery||arg.nodeType==1)){return arg}},flatten:function(arr){return $.map(arr,function(member){return member&&member.jquery?$.makeArray(member):member&&member.length?drag.flatten(member):member})},textselect:function(bool,doc){$(doc)[bool?"unbind":"bind"]("selectstart",drag.dontstart).attr("unselectable",bool?"off":"on").css("MozUserSelect",bool?"":"none")},dontstart:function(){return false},callback:function(){}};drag.callback.prototype={update:function(){if($special.drop&&this.available.length){$.each(this.available,function(i){$special.drop.locate(this,i)})}}};$special.draginit=$special.dragstart=$special.dragend=drag})(jQuery);
/*!
 * jQuery throttle / debounce - v1.1 - 3/7/2010
 * http://benalman.com/projects/jquery-throttle-debounce-plugin/
 *
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function(window,undefined){var $=window.jQuery||window.Cowboy||(window.Cowboy={}),jq_throttle;$.throttle=jq_throttle=function(delay,no_trailing,callback,debounce_mode){var timeout_id,last_exec=0;if(typeof no_trailing!=="boolean"){debounce_mode=callback;callback=no_trailing;no_trailing=undefined}function wrapper(){var that=this,elapsed=+new Date()-last_exec,args=arguments;function exec(){last_exec=+new Date();callback.apply(that,args)}function clear(){timeout_id=undefined}if(debounce_mode&&!timeout_id){exec()}timeout_id&&clearTimeout(timeout_id);if(debounce_mode===undefined&&elapsed>delay){exec()}else{if(no_trailing!==true){timeout_id=setTimeout(debounce_mode?clear:exec,debounce_mode===undefined?delay-elapsed:delay)}}}if($.guid){wrapper.guid=callback.guid=callback.guid||$.guid++}return wrapper};$.debounce=function(delay,at_begin,callback){return callback===undefined?jq_throttle(delay,at_begin,false):jq_throttle(delay,callback,at_begin!==false)}})(this);(function(jQuery){jQuery.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"numpadplus",109:"numpadminus",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",191:"/",224:"meta",187:"plus",189:"minus",61:"ffplus",173:"ffminus"},shiftNums:{"`":"~","1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"}};function keyHandler(handleObj){if(typeof handleObj.data!=="string"){return}var origHandler=handleObj.handler,keys=handleObj.data.toLowerCase().split(" ");handleObj.handler=function(event){if(this!==event.target&&(/textarea|select/i.test(event.target.nodeName)||event.target.type==="text")){return}var special=event.type!=="keypress"&&jQuery.hotkeys.specialKeys[event.which],character=String.fromCharCode(event.which).toLowerCase(),key,modif="",possible={};if(event.altKey&&special!=="alt"){modif+="alt+"}if(event.ctrlKey&&special!=="ctrl"){modif+="ctrl+"}if(event.metaKey&&!event.ctrlKey&&special!=="meta"){modif+="meta+"}if(event.shiftKey&&special!=="shift"){modif+="shift+"}if(special){possible[modif+special]=true}else{possible[modif+character]=true;possible[modif+jQuery.hotkeys.shiftNums[character]]=true;if(modif==="shift+"){possible[jQuery.hotkeys.shiftNums[character]]=true}}for(var i=0,l=keys.length;i<l;i++){if(possible[keys[i]]){return origHandler.apply(this,arguments)}}}}jQuery.each(["keydown","keyup","keypress"],function(){jQuery.event.special[this]={add:keyHandler}})})(jQuery);
/*! Copyright (c) 2011 Brandon Aaron (http://brandonaaron.net)
 * Licensed under the MIT License (LICENSE.txt).
 *
 * Thanks to: http://adomas.org/javascript-mouse-wheel/ for some pointers.
 * Thanks to: Mathias Bank(http://www.mathias-bank.de) for a scope bug fix.
 * Thanks to: Seamus Leahy for adding deltaX and deltaY
 *
 * Version: 3.0.6
 *
 * Requires: 1.2.2+
 */
(function($){var types=["DOMMouseScroll","mousewheel"];if($.event.fixHooks){for(var i=types.length;i;){$.event.fixHooks[types[--i]]=$.event.mouseHooks}}$.event.special.mousewheel={setup:function(){if(this.addEventListener){for(var i=types.length;i;){this.addEventListener(types[--i],handler,false)}}else{this.onmousewheel=handler}},teardown:function(){if(this.removeEventListener){for(var i=types.length;i;){this.removeEventListener(types[--i],handler,false)}}else{this.onmousewheel=null}}};$.fn.extend({mousewheel:function(fn){return fn?this.bind("mousewheel",fn):this.trigger("mousewheel")},unmousewheel:function(fn){return this.unbind("mousewheel",fn)}});function handler(event){var orgEvent=event||window.event,args=[].slice.call(arguments,1),delta=0,returnValue=true,deltaX=0,deltaY=0;event=$.event.fix(orgEvent);event.type="mousewheel";if(orgEvent.wheelDelta){delta=orgEvent.wheelDelta/120}if(orgEvent.detail){delta=-orgEvent.detail/3}deltaY=delta;if(orgEvent.axis!==undefined&&orgEvent.axis===orgEvent.HORIZONTAL_AXIS){deltaY=0;deltaX=-1*delta}if(orgEvent.wheelDeltaY!==undefined){deltaY=orgEvent.wheelDeltaY/120}if(orgEvent.wheelDeltaX!==undefined){deltaX=-1*orgEvent.wheelDeltaX/120}args.unshift(event,delta,deltaX,deltaY);return($.event.dispatch||$.event.handle).apply(this,args)}})(jQuery);(function($){$.i18n={dict:null,setDictionary:function(i18n_dict){this.dict=i18n_dict},_:function(str,params){var result=str;if(this.dict&&this.dict[str]){result=this.dict[str]}return this.printf(result,params)},printf:function(str,args){if(!args){return str}var result="";var search=/%(\d+)\$s/g;var matches=search.exec(str);while(matches){var index=parseInt(matches[1],10)-1;str=str.replace("%"+matches[1]+"$s",(args[index]));matches=search.exec(str)}var parts=str.split("%s");if(parts.length>1){for(var i=0;i<args.length;i++){if(parts[i].length>0&&parts[i].lastIndexOf("%")==(parts[i].length-1)){parts[i]+="s"+parts.splice(i+1,1)[0]}result+=parts[i]+args[i]}}return result+parts[parts.length-1]}};$.fn._t=function(str,params){return $(this).text($.i18n._(str,params))}})(jQuery);(function($,undefined){var hidden="hidden",copy='<textarea style="position:absolute; top:-9999px; left:-9999px; right:auto; bottom:auto; word-wrap:break-word; height:0 !important; min-height:0 !important; overflow:hidden">',copyStyle=["fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","textTransform","wordSpacing"],oninput="oninput",onpropertychange="onpropertychange",test=$(copy)[0];test.setAttribute(oninput,"return");if($.isFunction(test[oninput])||onpropertychange in test){$.fn.autosize=function(o){var options=$.extend({className:null,heightCallback:function(){}},o);var className=options.className;var heightCallback=options.heightCallback;return this.each(function(){var ta=this,$ta=$(ta).css({overflow:hidden,overflowY:hidden,wordWrap:"break-word"}),mirror=$(copy).addClass(className||"autosizejs")[0],minHeight=$ta.height(),maxHeight=parseInt($ta.css("maxHeight"),10),active,i=copyStyle.length;maxHeight=maxHeight&&maxHeight>0?maxHeight:90000;function adjust(){var height,overflow;if(!active){active=true;mirror.value=ta.value;mirror.style.overflowY=ta.style.overflowY;mirror.style.width=$ta.css("width");mirror.scrollTop=0;mirror.scrollTop=90000;height=mirror.scrollTop;if(heightCallback){heightCallback(height)}overflow=hidden;if(height>maxHeight){height=maxHeight;overflow="scroll"}else{if(height<minHeight){height=minHeight}}ta.style.overflowY=overflow;ta.style.height=ta.style.minHeight=ta.style.maxHeight=height+"px";setTimeout(function(){active=false},1)}}while(i--){mirror.style[copyStyle[i]]=$ta.css(copyStyle[i])}$("body").append(mirror);if(onpropertychange in ta){if(oninput in ta){ta[oninput]=ta.onkeyup=adjust}else{ta[onpropertychange]=adjust}}else{ta[oninput]=adjust}$(window).resize(adjust);$ta.bind("autosize",adjust);adjust()})}}else{$.fn.autosize=function(){return this}}}(jQuery));(function($){$.contextMenu={shadow:true,shadowOffset:0,shadowOffsetX:5,shadowOffsetY:5,shadowWidthAdjust:-3,shadowHeightAdjust:-3,shadowOpacity:0.2,shadowClass:"context-menu-shadow",shadowColor:"black",offsetX:0,offsetY:0,appendTo:"body",direction:"down",constrainToScreen:true,showTransition:"show",hideTransition:"hide",showSpeed:null,hideSpeed:null,showCallback:null,hideCallback:null,className:"context-menu",itemClassName:"context-menu-item",itemHoverClassName:"context-menu-item-hover",disabledItemClassName:"context-menu-item-disabled",disabledItemHoverClassName:"context-menu-item-disabled-hover",separatorClassName:"context-menu-separator",innerDivClassName:"context-menu-item-inner",themePrefix:"context-menu-theme-",theme:"default",separator:"context-menu-separator",target:null,menu:null,shadowObj:null,bgiframe:null,shown:false,useIframe:
/*@cc_on @*/
/*@if (@_win32) true, @else @*/
false,
/*@end @*/
create:function(menu,opts){var cmenu=$.extend({},this,opts);if(typeof menu=="string"){cmenu.menu=$(menu)}else{if(typeof menu=="function"){cmenu.menuFunction=menu}else{cmenu.menu=cmenu.createMenu(menu,cmenu)}}if(cmenu.menu){cmenu.menu.css({display:"none"});$(cmenu.appendTo).append(cmenu.menu)}if(cmenu.shadow){cmenu.createShadow(cmenu);if(cmenu.shadowOffset){cmenu.shadowOffsetX=cmenu.shadowOffsetY=cmenu.shadowOffset}}$("body").bind("contextmenu",function(){cmenu.hide()});return cmenu},createIframe:function(){return $('<iframe frameborder="0" tabindex="-1" src="javascript:false" style="display:block;position:absolute;z-index:-1;filter:Alpha(Opacity=0);"/>')},createMenu:function(menu,cmenu){var className=cmenu.className;$.each(cmenu.theme.split(","),function(i,n){className+=" "+cmenu.themePrefix+n});var $t=$("<table cellspacing=0 cellpadding=0></table>").click(function(){cmenu.hide();return false});var $tr=$("<tr></tr>");var $td=$("<td></td>");var $div=$('<div class="'+className+'"></div>');for(var i=0;i<menu.length;i++){var m=menu[i];if(m==$.contextMenu.separator){$div.append(cmenu.createSeparator())}else{for(var opt in menu[i]){$div.append(cmenu.createMenuItem(opt,menu[i][opt]))}}}if(cmenu.useIframe){$td.append(cmenu.createIframe())}$t.append($tr.append($td.append($div)));return $t},createMenuItem:function(label,obj){var cmenu=this;if(typeof obj=="function"){obj={onclick:obj}}var o=$.extend({onclick:function(){},className:"",hoverClassName:cmenu.itemHoverClassName,icon:"",disabled:false,title:"",hoverItem:cmenu.hoverItem,hoverItemOut:cmenu.hoverItemOut},obj);var iconStyle=(o.icon)?"background-image:url("+o.icon+");":"";var $div=$('<div class="'+cmenu.itemClassName+" "+o.className+((o.disabled)?" "+cmenu.disabledItemClassName:"")+'" title="'+o.title+'"></div>').click(function(e){if(cmenu.isItemDisabled(this)){return false}else{return o.onclick.call(cmenu.target,this,cmenu,e)}}).hover(function(){o.hoverItem.call(this,(cmenu.isItemDisabled(this))?cmenu.disabledItemHoverClassName:o.hoverClassName)},function(){o.hoverItemOut.call(this,(cmenu.isItemDisabled(this))?cmenu.disabledItemHoverClassName:o.hoverClassName)});var $idiv=$('<div class="'+cmenu.innerDivClassName+'" style="'+iconStyle+'">'+label+"</div>");$div.append($idiv);return $div},createSeparator:function(){return $('<div class="'+this.separatorClassName+'"></div>')},isItemDisabled:function(item){return $(item).is("."+this.disabledItemClassName)},hoverItem:function(c){$(this).addClass(c)},hoverItemOut:function(c){$(this).removeClass(c)},createShadow:function(cmenu){cmenu.shadowObj=$('<div class="'+cmenu.shadowClass+'"></div>').css({display:"none",position:"absolute",zIndex:99998,opacity:cmenu.shadowOpacity,backgroundColor:cmenu.shadowColor});$(cmenu.appendTo).append(cmenu.shadowObj)},showShadow:function(x,y,e){var cmenu=this;if(cmenu.shadow){cmenu.shadowObj.css({width:(cmenu.menu.width()+cmenu.shadowWidthAdjust)+"px",height:(cmenu.menu.height()+cmenu.shadowHeightAdjust)+"px",top:(y+cmenu.shadowOffsetY)+"px",left:(x+cmenu.shadowOffsetX)+"px"}).addClass(cmenu.shadowClass)[cmenu.showTransition](cmenu.showSpeed)}},beforeShow:function(){return true},show:function(t,e){var cmenu=this,x=e.pageX,y=e.pageY;cmenu.target=t;if(cmenu.beforeShow()!==false){if(cmenu.menuFunction){if(cmenu.menu){$(cmenu.menu).remove()}cmenu.menu=cmenu.createMenu(cmenu.menuFunction(cmenu,t),cmenu);cmenu.menu.css({display:"none"});$(cmenu.appendTo).append(cmenu.menu)}var $c=cmenu.menu;x+=cmenu.offsetX;y+=cmenu.offsetY;var pos=cmenu.getPosition(x,y,cmenu,e);cmenu.showShadow(pos.x,pos.y,e);if(cmenu.useIframe){$c.find("iframe").css({width:$c.width()+cmenu.shadowOffsetX+cmenu.shadowWidthAdjust,height:$c.height()+cmenu.shadowOffsetY+cmenu.shadowHeightAdjust})}$c.css({top:pos.y+"px",left:pos.x+"px",position:"absolute",zIndex:99999})[cmenu.showTransition](cmenu.showSpeed,((cmenu.showCallback)?function(){cmenu.showCallback.call(cmenu)}:null));cmenu.shown=true;$(document).one("click",null,function(e){if(!(_gliffy.BrowserDetect.OS==="Mac")){cmenu.hide()}})}},getPosition:function(clickX,clickY,cmenu,e){var x=clickX+cmenu.offsetX;var y=clickY+cmenu.offsetY;var h=$(cmenu.menu).height();var w=$(cmenu.menu).width();var dir=cmenu.direction;if(cmenu.constrainToScreen){var $w=$(window);var wh=$w.height();var ww=$w.width();if(dir=="down"&&(y+h-$w.scrollTop()>wh)){dir="up"}var maxRight=x+w-$w.scrollLeft();if(maxRight>ww){x-=(maxRight-ww)}}if(dir=="up"){y-=h}return{x:x,y:y}},hide:function(){var cmenu=this;if(cmenu.shown){if(cmenu.iframe){$(cmenu.iframe).hide()}if(cmenu.menu){cmenu.menu[cmenu.hideTransition](cmenu.hideSpeed,((cmenu.hideCallback)?function(){cmenu.hideCallback.call(cmenu)}:null))}if(cmenu.shadow){cmenu.shadowObj[cmenu.hideTransition](cmenu.hideSpeed)}}cmenu.shown=false}};$.fn.contextMenu=function(menu,options){var cmenu=$.contextMenu.create(menu,options);return this.each(function(){$(this).bind("contextmenu",function(e){cmenu.show(this,e);return false})})}})(jQuery);
/*!
 * hoverIntent r7 // 2013.03.11 // jQuery 1.9.1+
 * http://cherne.net/brian/resources/jquery.hoverIntent.html
 *
 * You may use hoverIntent under the terms of the MIT license. Basically that
 * means you are free to use hoverIntent as long as this header is left intact.
 * Copyright 2007, 2013 Brian Cherne
 */
(function($){$.fn.hoverIntent=function(handlerIn,handlerOut,selector){var cfg={interval:100,sensitivity:7,timeout:0};if(typeof handlerIn==="object"){cfg=$.extend(cfg,handlerIn)}else{if($.isFunction(handlerOut)){cfg=$.extend(cfg,{over:handlerIn,out:handlerOut,selector:selector})}else{cfg=$.extend(cfg,{over:handlerIn,out:handlerIn,selector:handlerOut})}}var cX,cY,pX,pY;var track=function(ev){cX=ev.pageX;cY=ev.pageY};var compare=function(ev,ob){ob.hoverIntent_t=clearTimeout(ob.hoverIntent_t);if((Math.abs(pX-cX)+Math.abs(pY-cY))<cfg.sensitivity){$(ob).off("mousemove.hoverIntent",track);ob.hoverIntent_s=1;return cfg.over.apply(ob,[ev])}else{pX=cX;pY=cY;ob.hoverIntent_t=setTimeout(function(){compare(ev,ob)},cfg.interval)}};var delay=function(ev,ob){ob.hoverIntent_t=clearTimeout(ob.hoverIntent_t);ob.hoverIntent_s=0;return cfg.out.apply(ob,[ev])};var handleHover=function(e){var ev=jQuery.extend({},e);var ob=this;if(ob.hoverIntent_t){ob.hoverIntent_t=clearTimeout(ob.hoverIntent_t)}if(e.type=="mouseenter"){pX=ev.pageX;pY=ev.pageY;$(ob).on("mousemove.hoverIntent",track);if(ob.hoverIntent_s!=1){ob.hoverIntent_t=setTimeout(function(){compare(ev,ob)},cfg.interval)}}else{$(ob).off("mousemove.hoverIntent",track);if(ob.hoverIntent_s==1){ob.hoverIntent_t=setTimeout(function(){delay(ev,ob)},cfg.timeout)}}};return this.on({"mouseenter.hoverIntent":handleHover,"mouseleave.hoverIntent":handleHover},cfg.selector)}})(jQuery);(function(global){var undefined=(void 0);var MAX_ARRAY_LENGTH=100000;function Type(v){switch(typeof v){case"undefined":return"undefined";case"boolean":return"boolean";case"number":return"number";case"string":return"string";default:return v===null?"null":"object"}}function Class(v){return Object.prototype.toString.call(v).replace(/^\[object *|\]$/g,"")}function IsCallable(o){return typeof o==="function"}function ToObject(v){if(v===null||v===undefined){throw TypeError()}return Object(v)}function ToInt32(v){return v>>0}function ToUint32(v){return v>>>0}var LN2=Math.LN2,abs=Math.abs,floor=Math.floor,log=Math.log,max=Math.max,min=Math.min,pow=Math.pow,round=Math.round;(function(){var orig=Object.defineProperty;var dom_only=!(function(){try{return Object.defineProperty({},"x",{})}catch(_){return false}}());if(!orig||dom_only){Object.defineProperty=function(o,prop,desc){if(orig){try{return orig(o,prop,desc)}catch(_){}}if(o!==Object(o)){throw TypeError("Object.defineProperty called on non-object")}if(Object.prototype.__defineGetter__&&("get" in desc)){Object.prototype.__defineGetter__.call(o,prop,desc.get)}if(Object.prototype.__defineSetter__&&("set" in desc)){Object.prototype.__defineSetter__.call(o,prop,desc.set)}if("value" in desc){o[prop]=desc.value}return o}}}());function makeArrayAccessors(obj){if(obj.length>MAX_ARRAY_LENGTH){throw RangeError("Array too large for polyfill")}function makeArrayAccessor(index){Object.defineProperty(obj,index,{get:function(){return obj._getter(index)},set:function(v){obj._setter(index,v)},enumerable:true,configurable:false})}var i;for(i=0;i<obj.length;i+=1){makeArrayAccessor(i)}}function as_signed(value,bits){var s=32-bits;return(value<<s)>>s}function as_unsigned(value,bits){var s=32-bits;return(value<<s)>>>s}function packI8(n){return[n&255]}function unpackI8(bytes){return as_signed(bytes[0],8)}function packU8(n){return[n&255]}function unpackU8(bytes){return as_unsigned(bytes[0],8)}function packU8Clamped(n){n=round(Number(n));return[n<0?0:n>255?255:n&255]}function packI16(n){return[(n>>8)&255,n&255]}function unpackI16(bytes){return as_signed(bytes[0]<<8|bytes[1],16)}function packU16(n){return[(n>>8)&255,n&255]}function unpackU16(bytes){return as_unsigned(bytes[0]<<8|bytes[1],16)}function packI32(n){return[(n>>24)&255,(n>>16)&255,(n>>8)&255,n&255]}function unpackI32(bytes){return as_signed(bytes[0]<<24|bytes[1]<<16|bytes[2]<<8|bytes[3],32)}function packU32(n){return[(n>>24)&255,(n>>16)&255,(n>>8)&255,n&255]}function unpackU32(bytes){return as_unsigned(bytes[0]<<24|bytes[1]<<16|bytes[2]<<8|bytes[3],32)}function packIEEE754(v,ebits,fbits){var bias=(1<<(ebits-1))-1,s,e,f,ln,i,bits,str,bytes;function roundToEven(n){var w=floor(n),f=n-w;if(f<0.5){return w}if(f>0.5){return w+1}return w%2?w+1:w}if(v!==v){e=(1<<ebits)-1;f=pow(2,fbits-1);s=0}else{if(v===Infinity||v===-Infinity){e=(1<<ebits)-1;f=0;s=(v<0)?1:0}else{if(v===0){e=0;f=0;s=(1/v===-Infinity)?1:0}else{s=v<0;v=abs(v);if(v>=pow(2,1-bias)){e=min(floor(log(v)/LN2),1023);f=roundToEven(v/pow(2,e)*pow(2,fbits));if(f/pow(2,fbits)>=2){e=e+1;f=1}if(e>bias){e=(1<<ebits)-1;f=0}else{e=e+bias;f=f-pow(2,fbits)}}else{e=0;f=roundToEven(v/pow(2,1-bias-fbits))}}}}bits=[];for(i=fbits;i;i-=1){bits.push(f%2?1:0);f=floor(f/2)}for(i=ebits;i;i-=1){bits.push(e%2?1:0);e=floor(e/2)}bits.push(s?1:0);bits.reverse();str=bits.join("");bytes=[];while(str.length){bytes.push(parseInt(str.substring(0,8),2));str=str.substring(8)}return bytes}function unpackIEEE754(bytes,ebits,fbits){var bits=[],i,j,b,str,bias,s,e,f;for(i=bytes.length;i;i-=1){b=bytes[i-1];for(j=8;j;j-=1){bits.push(b%2?1:0);b=b>>1}}bits.reverse();str=bits.join("");bias=(1<<(ebits-1))-1;s=parseInt(str.substring(0,1),2)?-1:1;e=parseInt(str.substring(1,1+ebits),2);f=parseInt(str.substring(1+ebits),2);if(e===(1<<ebits)-1){return f!==0?NaN:s*Infinity}else{if(e>0){return s*pow(2,e-bias)*(1+f/pow(2,fbits))}else{if(f!==0){return s*pow(2,-(bias-1))*(f/pow(2,fbits))}else{return s<0?-0:0}}}}function unpackF64(b){return unpackIEEE754(b,11,52)}function packF64(v){return packIEEE754(v,11,52)}function unpackF32(b){return unpackIEEE754(b,8,23)}function packF32(v){return packIEEE754(v,8,23)}(function(){function ArrayBuffer(length){length=ToInt32(length);if(length<0){throw RangeError("ArrayBuffer size is not a small enough positive integer.")}Object.defineProperty(this,"byteLength",{value:length});Object.defineProperty(this,"_bytes",{value:Array(length)});for(var i=0;i<length;i+=1){this._bytes[i]=0}}global.ArrayBuffer=global.ArrayBuffer||ArrayBuffer;function $TypedArray$(){if(!arguments.length||typeof arguments[0]!=="object"){return(function(length){length=ToInt32(length);if(length<0){throw RangeError("length is not a small enough positive integer.")}Object.defineProperty(this,"length",{value:length});Object.defineProperty(this,"byteLength",{value:length*this.BYTES_PER_ELEMENT});Object.defineProperty(this,"buffer",{value:new ArrayBuffer(this.byteLength)});Object.defineProperty(this,"byteOffset",{value:0})}).apply(this,arguments)}if(arguments.length>=1&&Type(arguments[0])==="object"&&arguments[0] instanceof $TypedArray$){return(function(typedArray){if(this.constructor!==typedArray.constructor){throw TypeError()}var byteLength=typedArray.length*this.BYTES_PER_ELEMENT;Object.defineProperty(this,"buffer",{value:new ArrayBuffer(byteLength)});Object.defineProperty(this,"byteLength",{value:byteLength});Object.defineProperty(this,"byteOffset",{value:0});Object.defineProperty(this,"length",{value:typedArray.length});for(var i=0;i<this.length;i+=1){this._setter(i,typedArray._getter(i))}}).apply(this,arguments)}if(arguments.length>=1&&Type(arguments[0])==="object"&&!(arguments[0] instanceof $TypedArray$)&&!(arguments[0] instanceof ArrayBuffer||Class(arguments[0])==="ArrayBuffer")){return(function(array){var byteLength=array.length*this.BYTES_PER_ELEMENT;Object.defineProperty(this,"buffer",{value:new ArrayBuffer(byteLength)});Object.defineProperty(this,"byteLength",{value:byteLength});Object.defineProperty(this,"byteOffset",{value:0});Object.defineProperty(this,"length",{value:array.length});for(var i=0;i<this.length;i+=1){var s=array[i];this._setter(i,Number(s))}}).apply(this,arguments)}if(arguments.length>=1&&Type(arguments[0])==="object"&&(arguments[0] instanceof ArrayBuffer||Class(arguments[0])==="ArrayBuffer")){return(function(buffer,byteOffset,length){byteOffset=ToUint32(byteOffset);if(byteOffset>buffer.byteLength){throw RangeError("byteOffset out of range")}if(byteOffset%this.BYTES_PER_ELEMENT){throw RangeError("buffer length minus the byteOffset is not a multiple of the element size.")}if(length===undefined){var byteLength=buffer.byteLength-byteOffset;if(byteLength%this.BYTES_PER_ELEMENT){throw RangeError("length of buffer minus byteOffset not a multiple of the element size")}length=byteLength/this.BYTES_PER_ELEMENT}else{length=ToUint32(length);byteLength=length*this.BYTES_PER_ELEMENT}if((byteOffset+byteLength)>buffer.byteLength){throw RangeError("byteOffset and length reference an area beyond the end of the buffer")}Object.defineProperty(this,"buffer",{value:buffer});Object.defineProperty(this,"byteLength",{value:byteLength});Object.defineProperty(this,"byteOffset",{value:byteOffset});Object.defineProperty(this,"length",{value:length})}).apply(this,arguments)}throw TypeError()}Object.defineProperty($TypedArray$,"from",{value:function(iterable){return new this(iterable)}});Object.defineProperty($TypedArray$,"of",{value:function(){return new this(arguments)}});var $TypedArrayPrototype$={};$TypedArray$.prototype=$TypedArrayPrototype$;Object.defineProperty($TypedArray$.prototype,"_getter",{value:function(index){if(arguments.length<1){throw SyntaxError("Not enough arguments")}index=ToUint32(index);if(index>=this.length){return undefined}var bytes=[],i,o;for(i=0,o=this.byteOffset+index*this.BYTES_PER_ELEMENT;i<this.BYTES_PER_ELEMENT;i+=1,o+=1){bytes.push(this.buffer._bytes[o])}return this._unpack(bytes)}});Object.defineProperty($TypedArray$.prototype,"get",{value:$TypedArray$.prototype._getter});Object.defineProperty($TypedArray$.prototype,"_setter",{value:function(index,value){if(arguments.length<2){throw SyntaxError("Not enough arguments")}index=ToUint32(index);if(index>=this.length){return}var bytes=this._pack(value),i,o;for(i=0,o=this.byteOffset+index*this.BYTES_PER_ELEMENT;i<this.BYTES_PER_ELEMENT;i+=1,o+=1){this.buffer._bytes[o]=bytes[i]}}});Object.defineProperty($TypedArray$.prototype,"constructor",{value:$TypedArray$});Object.defineProperty($TypedArray$.prototype,"copyWithin",{value:function(target,start){var end=arguments[2];var o=ToObject(this);var lenVal=o.length;var len=ToUint32(lenVal);len=max(len,0);var relativeTarget=ToInt32(target);var to;if(relativeTarget<0){to=max(len+relativeTarget,0)}else{to=min(relativeTarget,len)}var relativeStart=ToInt32(start);var from;if(relativeStart<0){from=max(len+relativeStart,0)}else{from=min(relativeStart,len)}var relativeEnd;if(end===undefined){relativeEnd=len}else{relativeEnd=ToInt32(end)}var final_;if(relativeEnd<0){final_=max(len+relativeEnd,0)}else{final_=min(relativeEnd,len)}var count=min(final_-from,len-to);var direction;if(from<to&&to<from+count){direction=-1;from=from+count-1;to=to+count-1}else{direction=1}while(count>0){o._setter(to,o._getter(from));from=from+direction;to=to+direction;count=count-1}return o}});Object.defineProperty($TypedArray$.prototype,"every",{value:function(callbackfn){if(this===undefined||this===null){throw TypeError()}var t=Object(this);var len=ToUint32(t.length);if(!IsCallable(callbackfn)){throw TypeError()}var thisArg=arguments[1];for(var i=0;i<len;i++){if(!callbackfn.call(thisArg,t._getter(i),i,t)){return false}}return true}});Object.defineProperty($TypedArray$.prototype,"fill",{value:function(value){var start=arguments[1],end=arguments[2];var o=ToObject(this);var lenVal=o.length;var len=ToUint32(lenVal);len=max(len,0);var relativeStart=ToInt32(start);var k;if(relativeStart<0){k=max((len+relativeStart),0)}else{k=min(relativeStart,len)}var relativeEnd;if(end===undefined){relativeEnd=len}else{relativeEnd=ToInt32(end)}var final_;if(relativeEnd<0){final_=max((len+relativeEnd),0)}else{final_=min(relativeEnd,len)}while(k<final_){o._setter(k,value);k+=1}return o}});Object.defineProperty($TypedArray$.prototype,"filter",{value:function(callbackfn){if(this===undefined||this===null){throw TypeError()}var t=Object(this);var len=ToUint32(t.length);if(!IsCallable(callbackfn)){throw TypeError()}var res=[];var thisp=arguments[1];for(var i=0;i<len;i++){var val=t._getter(i);if(callbackfn.call(thisp,val,i,t)){res.push(val)}}return new this.constructor(res)}});Object.defineProperty($TypedArray$.prototype,"find",{value:function(predicate){var o=ToObject(this);var lenValue=o.length;var len=ToUint32(lenValue);if(!IsCallable(predicate)){throw TypeError()}var t=arguments.length>1?arguments[1]:undefined;var k=0;while(k<len){var kValue=o._getter(k);var testResult=predicate.call(t,kValue,k,o);if(Boolean(testResult)){return kValue}++k}return undefined}});Object.defineProperty($TypedArray$.prototype,"findIndex",{value:function(predicate){var o=ToObject(this);var lenValue=o.length;var len=ToUint32(lenValue);if(!IsCallable(predicate)){throw TypeError()}var t=arguments.length>1?arguments[1]:undefined;var k=0;while(k<len){var kValue=o._getter(k);var testResult=predicate.call(t,kValue,k,o);if(Boolean(testResult)){return k}++k}return -1}});Object.defineProperty($TypedArray$.prototype,"forEach",{value:function(callbackfn){if(this===undefined||this===null){throw TypeError()}var t=Object(this);var len=ToUint32(t.length);if(!IsCallable(callbackfn)){throw TypeError()}var thisp=arguments[1];for(var i=0;i<len;i++){callbackfn.call(thisp,t._getter(i),i,t)}}});Object.defineProperty($TypedArray$.prototype,"indexOf",{value:function(searchElement){if(this===undefined||this===null){throw TypeError()}var t=Object(this);var len=ToUint32(t.length);if(len===0){return -1}var n=0;if(arguments.length>0){n=Number(arguments[1]);if(n!==n){n=0}else{if(n!==0&&n!==(1/0)&&n!==-(1/0)){n=(n>0||-1)*floor(abs(n))}}}if(n>=len){return -1}var k=n>=0?n:max(len-abs(n),0);for(;k<len;k++){if(t._getter(k)===searchElement){return k}}return -1}});Object.defineProperty($TypedArray$.prototype,"join",{value:function(separator){if(this===undefined||this===null){throw TypeError()}var t=Object(this);var len=ToUint32(t.length);var tmp=Array(len);for(var i=0;i<len;++i){tmp[i]=t._getter(i)}return tmp.join(separator===undefined?",":separator)}});Object.defineProperty($TypedArray$.prototype,"lastIndexOf",{value:function(searchElement){if(this===undefined||this===null){throw TypeError()}var t=Object(this);var len=ToUint32(t.length);if(len===0){return -1}var n=len;if(arguments.length>1){n=Number(arguments[1]);if(n!==n){n=0}else{if(n!==0&&n!==(1/0)&&n!==-(1/0)){n=(n>0||-1)*floor(abs(n))}}}var k=n>=0?min(n,len-1):len-abs(n);for(;k>=0;k--){if(t._getter(k)===searchElement){return k}}return -1}});Object.defineProperty($TypedArray$.prototype,"map",{value:function(callbackfn){if(this===undefined||this===null){throw TypeError()}var t=Object(this);var len=ToUint32(t.length);if(!IsCallable(callbackfn)){throw TypeError()}var res=[];res.length=len;var thisp=arguments[1];for(var i=0;i<len;i++){res[i]=callbackfn.call(thisp,t._getter(i),i,t)}return new this.constructor(res)}});Object.defineProperty($TypedArray$.prototype,"reduce",{value:function(callbackfn){if(this===undefined||this===null){throw TypeError()}var t=Object(this);var len=ToUint32(t.length);if(!IsCallable(callbackfn)){throw TypeError()}if(len===0&&arguments.length===1){throw TypeError()}var k=0;var accumulator;if(arguments.length>=2){accumulator=arguments[1]}else{accumulator=t._getter(k++)}while(k<len){accumulator=callbackfn.call(undefined,accumulator,t._getter(k),k,t);k++}return accumulator}});Object.defineProperty($TypedArray$.prototype,"reduceRight",{value:function(callbackfn){if(this===undefined||this===null){throw TypeError()}var t=Object(this);var len=ToUint32(t.length);if(!IsCallable(callbackfn)){throw TypeError()}if(len===0&&arguments.length===1){throw TypeError()}var k=len-1;var accumulator;if(arguments.length>=2){accumulator=arguments[1]}else{accumulator=t._getter(k--)}while(k>=0){accumulator=callbackfn.call(undefined,accumulator,t._getter(k),k,t);k--}return accumulator}});Object.defineProperty($TypedArray$.prototype,"reverse",{value:function(){if(this===undefined||this===null){throw TypeError()}var t=Object(this);var len=ToUint32(t.length);var half=floor(len/2);for(var i=0,j=len-1;i<half;++i,--j){var tmp=t._getter(i);t._setter(i,t._getter(j));t._setter(j,tmp)}return t}});Object.defineProperty($TypedArray$.prototype,"set",{value:function(index,value){if(arguments.length<1){throw SyntaxError("Not enough arguments")}var array,sequence,offset,len,i,s,d,byteOffset,byteLength,tmp;if(typeof arguments[0]==="object"&&arguments[0].constructor===this.constructor){array=arguments[0];offset=ToUint32(arguments[1]);if(offset+array.length>this.length){throw RangeError("Offset plus length of array is out of range")}byteOffset=this.byteOffset+offset*this.BYTES_PER_ELEMENT;byteLength=array.length*this.BYTES_PER_ELEMENT;if(array.buffer===this.buffer){tmp=[];for(i=0,s=array.byteOffset;i<byteLength;i+=1,s+=1){tmp[i]=array.buffer._bytes[s]}for(i=0,d=byteOffset;i<byteLength;i+=1,d+=1){this.buffer._bytes[d]=tmp[i]}}else{for(i=0,s=array.byteOffset,d=byteOffset;i<byteLength;i+=1,s+=1,d+=1){this.buffer._bytes[d]=array.buffer._bytes[s]}}}else{if(typeof arguments[0]==="object"&&typeof arguments[0].length!=="undefined"){sequence=arguments[0];len=ToUint32(sequence.length);offset=ToUint32(arguments[1]);if(offset+len>this.length){throw RangeError("Offset plus length of array is out of range")}for(i=0;i<len;i+=1){s=sequence[i];this._setter(offset+i,Number(s))}}else{throw TypeError("Unexpected argument type(s)")}}}});Object.defineProperty($TypedArray$.prototype,"slice",{value:function(start,end){var o=ToObject(this);var lenVal=o.length;var len=ToUint32(lenVal);var relativeStart=ToInt32(start);var k=(relativeStart<0)?max(len+relativeStart,0):min(relativeStart,len);var relativeEnd=(end===undefined)?len:ToInt32(end);var final_=(relativeEnd<0)?max(len+relativeEnd,0):min(relativeEnd,len);var count=final_-k;var c=o.constructor;var a=new c(count);var n=0;while(k<final_){var kValue=o._getter(k);a._setter(n,kValue);++k;++n}return a}});Object.defineProperty($TypedArray$.prototype,"some",{value:function(callbackfn){if(this===undefined||this===null){throw TypeError()}var t=Object(this);var len=ToUint32(t.length);if(!IsCallable(callbackfn)){throw TypeError()}var thisp=arguments[1];for(var i=0;i<len;i++){if(callbackfn.call(thisp,t._getter(i),i,t)){return true}}return false}});Object.defineProperty($TypedArray$.prototype,"sort",{value:function(comparefn){if(this===undefined||this===null){throw TypeError()}var t=Object(this);var len=ToUint32(t.length);var tmp=Array(len);for(var i=0;i<len;++i){tmp[i]=t._getter(i)}if(comparefn){tmp.sort(comparefn)}else{tmp.sort()}for(i=0;i<len;++i){t._setter(i,tmp[i])}return t}});Object.defineProperty($TypedArray$.prototype,"subarray",{value:function(start,end){function clamp(v,min,max){return v<min?min:v>max?max:v}start=ToInt32(start);end=ToInt32(end);if(arguments.length<1){start=0}if(arguments.length<2){end=this.length}if(start<0){start=this.length+start}if(end<0){end=this.length+end}start=clamp(start,0,this.length);end=clamp(end,0,this.length);var len=end-start;if(len<0){len=0}return new this.constructor(this.buffer,this.byteOffset+start*this.BYTES_PER_ELEMENT,len)}});function makeTypedArray(elementSize,pack,unpack){var TypedArray=function(){Object.defineProperty(this,"constructor",{value:TypedArray});$TypedArray$.apply(this,arguments);makeArrayAccessors(this)};if("__proto__" in TypedArray){TypedArray.__proto__=$TypedArray$}else{TypedArray.from=$TypedArray$.from;TypedArray.of=$TypedArray$.of}TypedArray.BYTES_PER_ELEMENT=elementSize;var TypedArrayPrototype=function(){};TypedArrayPrototype.prototype=$TypedArrayPrototype$;TypedArray.prototype=new TypedArrayPrototype();Object.defineProperty(TypedArray.prototype,"BYTES_PER_ELEMENT",{value:elementSize});Object.defineProperty(TypedArray.prototype,"_pack",{value:pack});Object.defineProperty(TypedArray.prototype,"_unpack",{value:unpack});return TypedArray}var Int8Array=makeTypedArray(1,packI8,unpackI8);var Uint8Array=makeTypedArray(1,packU8,unpackU8);var Uint8ClampedArray=makeTypedArray(1,packU8Clamped,unpackU8);var Int16Array=makeTypedArray(2,packI16,unpackI16);var Uint16Array=makeTypedArray(2,packU16,unpackU16);var Int32Array=makeTypedArray(4,packI32,unpackI32);var Uint32Array=makeTypedArray(4,packU32,unpackU32);var Float32Array=makeTypedArray(4,packF32,unpackF32);var Float64Array=makeTypedArray(8,packF64,unpackF64);global.Int8Array=global.Int8Array||Int8Array;global.Uint8Array=global.Uint8Array||Uint8Array;global.Uint8ClampedArray=global.Uint8ClampedArray||Uint8ClampedArray;global.Int16Array=global.Int16Array||Int16Array;global.Uint16Array=global.Uint16Array||Uint16Array;global.Int32Array=global.Int32Array||Int32Array;global.Uint32Array=global.Uint32Array||Uint32Array;global.Float32Array=global.Float32Array||Float32Array;global.Float64Array=global.Float64Array||Float64Array}());(function(){function r(array,index){return IsCallable(array.get)?array.get(index):array[index]}var IS_BIG_ENDIAN=(function(){var u16array=new Uint16Array([4660]),u8array=new Uint8Array(u16array.buffer);return r(u8array,0)===18}());function DataView(buffer,byteOffset,byteLength){if(!(buffer instanceof ArrayBuffer||Class(buffer)==="ArrayBuffer")){throw TypeError()}byteOffset=ToUint32(byteOffset);if(byteOffset>buffer.byteLength){throw RangeError("byteOffset out of range")}if(byteLength===undefined){byteLength=buffer.byteLength-byteOffset}else{byteLength=ToUint32(byteLength)}if((byteOffset+byteLength)>buffer.byteLength){throw RangeError("byteOffset and length reference an area beyond the end of the buffer")}Object.defineProperty(this,"buffer",{value:buffer});Object.defineProperty(this,"byteLength",{value:byteLength});Object.defineProperty(this,"byteOffset",{value:byteOffset})}function makeGetter(arrayType){return function GetViewValue(byteOffset,littleEndian){byteOffset=ToUint32(byteOffset);if(byteOffset+arrayType.BYTES_PER_ELEMENT>this.byteLength){throw RangeError("Array index out of range")}byteOffset+=this.byteOffset;var uint8Array=new Uint8Array(this.buffer,byteOffset,arrayType.BYTES_PER_ELEMENT),bytes=[];for(var i=0;i<arrayType.BYTES_PER_ELEMENT;i+=1){bytes.push(r(uint8Array,i))}if(Boolean(littleEndian)===Boolean(IS_BIG_ENDIAN)){bytes.reverse()}return r(new arrayType(new Uint8Array(bytes).buffer),0)}}Object.defineProperty(DataView.prototype,"getUint8",{value:makeGetter(Uint8Array)});Object.defineProperty(DataView.prototype,"getInt8",{value:makeGetter(Int8Array)});Object.defineProperty(DataView.prototype,"getUint16",{value:makeGetter(Uint16Array)});Object.defineProperty(DataView.prototype,"getInt16",{value:makeGetter(Int16Array)});Object.defineProperty(DataView.prototype,"getUint32",{value:makeGetter(Uint32Array)});Object.defineProperty(DataView.prototype,"getInt32",{value:makeGetter(Int32Array)});Object.defineProperty(DataView.prototype,"getFloat32",{value:makeGetter(Float32Array)});Object.defineProperty(DataView.prototype,"getFloat64",{value:makeGetter(Float64Array)});function makeSetter(arrayType){return function SetViewValue(byteOffset,value,littleEndian){byteOffset=ToUint32(byteOffset);if(byteOffset+arrayType.BYTES_PER_ELEMENT>this.byteLength){throw RangeError("Array index out of range")}var typeArray=new arrayType([value]),byteArray=new Uint8Array(typeArray.buffer),bytes=[],i,byteView;for(i=0;i<arrayType.BYTES_PER_ELEMENT;i+=1){bytes.push(r(byteArray,i))}if(Boolean(littleEndian)===Boolean(IS_BIG_ENDIAN)){bytes.reverse()}byteView=new Uint8Array(this.buffer,byteOffset,arrayType.BYTES_PER_ELEMENT);byteView.set(bytes)}}Object.defineProperty(DataView.prototype,"setUint8",{value:makeSetter(Uint8Array)});Object.defineProperty(DataView.prototype,"setInt8",{value:makeSetter(Int8Array)});Object.defineProperty(DataView.prototype,"setUint16",{value:makeSetter(Uint16Array)});Object.defineProperty(DataView.prototype,"setInt16",{value:makeSetter(Int16Array)});Object.defineProperty(DataView.prototype,"setUint32",{value:makeSetter(Uint32Array)});Object.defineProperty(DataView.prototype,"setInt32",{value:makeSetter(Int32Array)});Object.defineProperty(DataView.prototype,"setFloat32",{value:makeSetter(Float32Array)});Object.defineProperty(DataView.prototype,"setFloat64",{value:makeSetter(Float64Array)});global.DataView=global.DataView||DataView}())}(this));!function(){function n(n){return n&&(n.ownerDocument||n.document||n).documentElement}function t(n){return n&&(n.ownerDocument&&n.ownerDocument.defaultView||n.document&&n||n.defaultView)}function e(n,t){return t>n?-1:n>t?1:n>=t?0:0/0}function r(n){return null===n?0/0:+n}function u(n){return !isNaN(n)}function i(n){return{left:function(t,e,r,u){for(arguments.length<3&&(r=0),arguments.length<4&&(u=t.length);u>r;){var i=r+u>>>1;n(t[i],e)<0?r=i+1:u=i}return r},right:function(t,e,r,u){for(arguments.length<3&&(r=0),arguments.length<4&&(u=t.length);u>r;){var i=r+u>>>1;n(t[i],e)>0?u=i:r=i+1}return r}}}function o(n){return n.length}function a(n){for(var t=1;n*t%1;){t*=10}return t}function c(n,t){for(var e in t){Object.defineProperty(n.prototype,e,{value:t[e],enumerable:!1})}}function l(){this._=Object.create(null)}function s(n){return(n+="")===pa||n[0]===va?va+n:n}function f(n){return(n+="")[0]===va?n.slice(1):n}function h(n){return s(n) in this._}function g(n){return(n=s(n)) in this._&&delete this._[n]}function p(){var n=[];for(var t in this._){n.push(f(t))}return n}function v(){var n=0;for(var t in this._){++n}return n}function d(){for(var n in this._){return !1}return !0}function m(){this._=Object.create(null)}function y(n){return n}function M(n,t,e){return function(){var r=e.apply(t,arguments);return r===t?n:r}}function x(n,t){if(t in n){return t}t=t.charAt(0).toUpperCase()+t.slice(1);for(var e=0,r=da.length;r>e;++e){var u=da[e]+t;if(u in n){return u}}}function b(){}function _(){}function w(n){function t(){for(var t,r=e,u=-1,i=r.length;++u<i;){(t=r[u].on)&&t.apply(this,arguments)}return n}var e=[],r=new l;return t.on=function(t,u){var i,o=r.get(t);return arguments.length<2?o&&o.on:(o&&(o.on=null,e=e.slice(0,i=e.indexOf(o)).concat(e.slice(i+1)),r.remove(t)),u&&e.push(r.set(t,{on:u})),n)},t}function S(){ta.event.preventDefault()}function k(){for(var n,t=ta.event;n=t.sourceEvent;){t=n}return t}function E(n){for(var t=new _,e=0,r=arguments.length;++e<r;){t[arguments[e]]=w(t)}return t.of=function(e,r){return function(u){try{var i=u.sourceEvent=ta.event;u.target=n,ta.event=u,t[u.type].apply(e,r)}finally{ta.event=i}}},t}function A(n){return ya(n,_a),n}function N(n){return"function"==typeof n?n:function(){return Ma(n,this)}}function C(n){return"function"==typeof n?n:function(){return xa(n,this)}}function z(n,t){function e(){this.removeAttribute(n)}function r(){this.removeAttributeNS(n.space,n.local)}function u(){this.setAttribute(n,t)}function i(){this.setAttributeNS(n.space,n.local,t)}function o(){var e=t.apply(this,arguments);null==e?this.removeAttribute(n):this.setAttribute(n,e)}function a(){var e=t.apply(this,arguments);null==e?this.removeAttributeNS(n.space,n.local):this.setAttributeNS(n.space,n.local,e)}return n=ta.ns.qualify(n),null==t?n.local?r:e:"function"==typeof t?n.local?a:o:n.local?i:u}function q(n){return n.trim().replace(/\s+/g," ")}function L(n){return new RegExp("(?:^|\\s+)"+ta.requote(n)+"(?:\\s+|$)","g")}function T(n){return(n+"").trim().split(/^|\s+/)}function R(n,t){function e(){for(var e=-1;++e<u;){n[e](this,t)}}function r(){for(var e=-1,r=t.apply(this,arguments);++e<u;){n[e](this,r)}}n=T(n).map(D);var u=n.length;return"function"==typeof t?r:e}function D(n){var t=L(n);return function(e,r){if(u=e.classList){return r?u.add(n):u.remove(n)}var u=e.getAttribute("class")||"";r?(t.lastIndex=0,t.test(u)||e.setAttribute("class",q(u+" "+n))):e.setAttribute("class",q(u.replace(t," ")))}}function P(n,t,e){function r(){this.style.removeProperty(n)}function u(){this.style.setProperty(n,t,e)}function i(){var r=t.apply(this,arguments);null==r?this.style.removeProperty(n):this.style.setProperty(n,r,e)}return null==t?r:"function"==typeof t?i:u}function U(n,t){function e(){delete this[n]}function r(){this[n]=t}function u(){var e=t.apply(this,arguments);null==e?delete this[n]:this[n]=e}return null==t?e:"function"==typeof t?u:r}function j(n){function t(){var t=this.ownerDocument,e=this.namespaceURI;return e?t.createElementNS(e,n):t.createElement(n)}function e(){return this.ownerDocument.createElementNS(n.space,n.local)}return"function"==typeof n?n:(n=ta.ns.qualify(n)).local?e:t}function F(){var n=this.parentNode;n&&n.removeChild(this)}function H(n){return{__data__:n}}function O(n){return function(){return ba(this,n)}}function I(n){return arguments.length||(n=e),function(t,e){return t&&e?n(t.__data__,e.__data__):!t-!e}}function Y(n,t){for(var e=0,r=n.length;r>e;e++){for(var u,i=n[e],o=0,a=i.length;a>o;o++){(u=i[o])&&t(u,o,e)}}return n}function Z(n){return ya(n,Sa),n}function V(n){var t,e;return function(r,u,i){var o,a=n[i].update,c=a.length;for(i!=e&&(e=i,t=0),u>=t&&(t=u+1);!(o=a[t])&&++t<c;){}return o}}function X(n,t,e){function r(){var t=this[o];t&&(this.removeEventListener(n,t,t.$),delete this[o])}function u(){var u=c(t,ra(arguments));r.call(this),this.addEventListener(n,this[o]=u,u.$=e),u._=t}function i(){var t,e=new RegExp("^__on([^.]+)"+ta.requote(n)+"$");for(var r in this){if(t=r.match(e)){var u=this[r];this.removeEventListener(t[1],u,u.$),delete this[r]}}}var o="__on"+n,a=n.indexOf("."),c=$;a>0&&(n=n.slice(0,a));var l=ka.get(n);return l&&(n=l,c=B),a?t?u:r:t?b:i}function $(n,t){return function(e){var r=ta.event;ta.event=e,t[0]=this.__data__;try{n.apply(this,t)}finally{ta.event=r}}}function B(n,t){var e=$(n,t);return function(n){var t=this,r=n.relatedTarget;r&&(r===t||8&r.compareDocumentPosition(t))||e.call(t,n)}}function W(e){var r=".dragsuppress-"+ ++Aa,u="click"+r,i=ta.select(t(e)).on("touchmove"+r,S).on("dragstart"+r,S).on("selectstart"+r,S);if(null==Ea&&(Ea="onselectstart" in e?!1:x(e.style,"userSelect")),Ea){var o=n(e).style,a=o[Ea];o[Ea]="none"}return function(n){if(i.on(r,null),Ea&&(o[Ea]=a),n){var t=function(){i.on(u,null)};i.on(u,function(){S(),t()},!0),setTimeout(t,0)}}}function J(n,e){e.changedTouches&&(e=e.changedTouches[0]);var r=n.ownerSVGElement||n;if(r.createSVGPoint){var u=r.createSVGPoint();if(0>Na){var i=t(n);if(i.scrollX||i.scrollY){r=ta.select("body").append("svg").style({position:"absolute",top:0,left:0,margin:0,padding:0,border:"none"},"important");var o=r[0][0].getScreenCTM();Na=!(o.f||o.e),r.remove()}}return Na?(u.x=e.pageX,u.y=e.pageY):(u.x=e.clientX,u.y=e.clientY),u=u.matrixTransform(n.getScreenCTM().inverse()),[u.x,u.y]}var a=n.getBoundingClientRect();return[e.clientX-a.left-n.clientLeft,e.clientY-a.top-n.clientTop]}function G(){return ta.event.changedTouches[0].identifier}function K(n){return n>0?1:0>n?-1:0}function Q(n,t,e){return(t[0]-n[0])*(e[1]-n[1])-(t[1]-n[1])*(e[0]-n[0])}function nt(n){return n>1?0:-1>n?qa:Math.acos(n)}function tt(n){return n>1?Ra:-1>n?-Ra:Math.asin(n)}function et(n){return((n=Math.exp(n))-1/n)/2}function rt(n){return((n=Math.exp(n))+1/n)/2}function ut(n){return((n=Math.exp(2*n))-1)/(n+1)}function it(n){return(n=Math.sin(n/2))*n}function ot(){}function at(n,t,e){return this instanceof at?(this.h=+n,this.s=+t,void (this.l=+e)):arguments.length<2?n instanceof at?new at(n.h,n.s,n.l):bt(""+n,_t,at):new at(n,t,e)}function ct(n,t,e){function r(n){return n>360?n-=360:0>n&&(n+=360),60>n?i+(o-i)*n/60:180>n?o:240>n?i+(o-i)*(240-n)/60:i}function u(n){return Math.round(255*r(n))}var i,o;return n=isNaN(n)?0:(n%=360)<0?n+360:n,t=isNaN(t)?0:0>t?0:t>1?1:t,e=0>e?0:e>1?1:e,o=0.5>=e?e*(1+t):e+t-e*t,i=2*e-o,new mt(u(n+120),u(n),u(n-120))}function lt(n,t,e){return this instanceof lt?(this.h=+n,this.c=+t,void (this.l=+e)):arguments.length<2?n instanceof lt?new lt(n.h,n.c,n.l):n instanceof ft?gt(n.l,n.a,n.b):gt((n=wt((n=ta.rgb(n)).r,n.g,n.b)).l,n.a,n.b):new lt(n,t,e)}function st(n,t,e){return isNaN(n)&&(n=0),isNaN(t)&&(t=0),new ft(e,Math.cos(n*=Da)*t,Math.sin(n)*t)}function ft(n,t,e){return this instanceof ft?(this.l=+n,this.a=+t,void (this.b=+e)):arguments.length<2?n instanceof ft?new ft(n.l,n.a,n.b):n instanceof lt?st(n.h,n.c,n.l):wt((n=mt(n)).r,n.g,n.b):new ft(n,t,e)}function ht(n,t,e){var r=(n+16)/116,u=r+t/500,i=r-e/200;return u=pt(u)*Xa,r=pt(r)*$a,i=pt(i)*Ba,new mt(dt(3.2404542*u-1.5371385*r-0.4985314*i),dt(-0.969266*u+1.8760108*r+0.041556*i),dt(0.0556434*u-0.2040259*r+1.0572252*i))}function gt(n,t,e){return n>0?new lt(Math.atan2(e,t)*Pa,Math.sqrt(t*t+e*e),n):new lt(0/0,0/0,n)}function pt(n){return n>0.206893034?n*n*n:(n-4/29)/7.787037}function vt(n){return n>0.008856?Math.pow(n,1/3):7.787037*n+4/29}function dt(n){return Math.round(255*(0.00304>=n?12.92*n:1.055*Math.pow(n,1/2.4)-0.055))}function mt(n,t,e){return this instanceof mt?(this.r=~~n,this.g=~~t,void (this.b=~~e)):arguments.length<2?n instanceof mt?new mt(n.r,n.g,n.b):bt(""+n,mt,ct):new mt(n,t,e)}function yt(n){return new mt(n>>16,n>>8&255,255&n)}function Mt(n){return yt(n)+""}function xt(n){return 16>n?"0"+Math.max(0,n).toString(16):Math.min(255,n).toString(16)}function bt(n,t,e){var r,u,i,o=0,a=0,c=0;if(r=/([a-z]+)\((.*)\)/i.exec(n)){switch(u=r[2].split(","),r[1]){case"hsl":return e(parseFloat(u[0]),parseFloat(u[1])/100,parseFloat(u[2])/100);case"rgb":return t(kt(u[0]),kt(u[1]),kt(u[2]))}}return(i=Ga.get(n.toLowerCase()))?t(i.r,i.g,i.b):(null==n||"#"!==n.charAt(0)||isNaN(i=parseInt(n.slice(1),16))||(4===n.length?(o=(3840&i)>>4,o=o>>4|o,a=240&i,a=a>>4|a,c=15&i,c=c<<4|c):7===n.length&&(o=(16711680&i)>>16,a=(65280&i)>>8,c=255&i)),t(o,a,c))}function _t(n,t,e){var r,u,i=Math.min(n/=255,t/=255,e/=255),o=Math.max(n,t,e),a=o-i,c=(o+i)/2;return a?(u=0.5>c?a/(o+i):a/(2-o-i),r=n==o?(t-e)/a+(e>t?6:0):t==o?(e-n)/a+2:(n-t)/a+4,r*=60):(r=0/0,u=c>0&&1>c?0:r),new at(r,u,c)}function wt(n,t,e){n=St(n),t=St(t),e=St(e);var r=vt((0.4124564*n+0.3575761*t+0.1804375*e)/Xa),u=vt((0.2126729*n+0.7151522*t+0.072175*e)/$a),i=vt((0.0193339*n+0.119192*t+0.9503041*e)/Ba);return ft(116*u-16,500*(r-u),200*(u-i))}function St(n){return(n/=255)<=0.04045?n/12.92:Math.pow((n+0.055)/1.055,2.4)}function kt(n){var t=parseFloat(n);return"%"===n.charAt(n.length-1)?Math.round(2.55*t):t}function Et(n){return"function"==typeof n?n:function(){return n}}function At(n){return function(t,e,r){return 2===arguments.length&&"function"==typeof e&&(r=e,e=null),Nt(t,e,n,r)}}function Nt(n,t,e,r){function u(){var n,t=c.status;if(!t&&zt(c)||t>=200&&300>t||304===t){try{n=e.call(i,c)}catch(r){return void o.error.call(i,r)}o.load.call(i,n)}else{o.error.call(i,c)}}var i={},o=ta.dispatch("beforesend","progress","load","error"),a={},c=new XMLHttpRequest,l=null;return !this.XDomainRequest||"withCredentials" in c||!/^(http(s)?:)?\/\//.test(n)||(c=new XDomainRequest),"onload" in c?c.onload=c.onerror=u:c.onreadystatechange=function(){c.readyState>3&&u()},c.onprogress=function(n){var t=ta.event;ta.event=n;try{o.progress.call(i,c)}finally{ta.event=t}},i.header=function(n,t){return n=(n+"").toLowerCase(),arguments.length<2?a[n]:(null==t?delete a[n]:a[n]=t+"",i)},i.mimeType=function(n){return arguments.length?(t=null==n?null:n+"",i):t},i.responseType=function(n){return arguments.length?(l=n,i):l},i.response=function(n){return e=n,i},["get","post"].forEach(function(n){i[n]=function(){return i.send.apply(i,[n].concat(ra(arguments)))}}),i.send=function(e,r,u){if(2===arguments.length&&"function"==typeof r&&(u=r,r=null),c.open(e,n,!0),null==t||"accept" in a||(a.accept=t+",*/*"),c.setRequestHeader){for(var s in a){c.setRequestHeader(s,a[s])}}return null!=t&&c.overrideMimeType&&c.overrideMimeType(t),null!=l&&(c.responseType=l),null!=u&&i.on("error",u).on("load",function(n){u(null,n)}),o.beforesend.call(i,c),c.send(null==r?null:r),i},i.abort=function(){return c.abort(),i},ta.rebind(i,o,"on"),null==r?i:i.get(Ct(r))}function Ct(n){return 1===n.length?function(t,e){n(null==t?e:null)}:n}function zt(n){var t=n.responseType;return t&&"text"!==t?n.response:n.responseText}function qt(){var n=Lt(),t=Tt()-n;t>24?(isFinite(t)&&(clearTimeout(tc),tc=setTimeout(qt,t)),nc=0):(nc=1,rc(qt))}function Lt(){var n=Date.now();for(ec=Ka;ec;){n>=ec.t&&(ec.f=ec.c(n-ec.t)),ec=ec.n}return n}function Tt(){for(var n,t=Ka,e=1/0;t;){t.f?t=n?n.n=t.n:Ka=t.n:(t.t<e&&(e=t.t),t=(n=t).n)}return Qa=n,e}function Rt(n,t){return t-(n?Math.ceil(Math.log(n)/Math.LN10):1)}function Dt(n,t){var e=Math.pow(10,3*ga(8-t));return{scale:t>8?function(n){return n/e}:function(n){return n*e},symbol:n}}function Pt(n){var t=n.decimal,e=n.thousands,r=n.grouping,u=n.currency,i=r&&e?function(n,t){for(var u=n.length,i=[],o=0,a=r[0],c=0;u>0&&a>0&&(c+a+1>t&&(a=Math.max(1,t-c)),i.push(n.substring(u-=a,u+a)),!((c+=a+1)>t));){a=r[o=(o+1)%r.length]}return i.reverse().join(e)}:y;return function(n){var e=ic.exec(n),r=e[1]||" ",o=e[2]||">",a=e[3]||"-",c=e[4]||"",l=e[5],s=+e[6],f=e[7],h=e[8],g=e[9],p=1,v="",d="",m=!1,y=!0;switch(h&&(h=+h.substring(1)),(l||"0"===r&&"="===o)&&(l=r="0",o="="),g){case"n":f=!0,g="g";break;case"%":p=100,d="%",g="f";break;case"p":p=100,d="%",g="r";break;case"b":case"o":case"x":case"X":"#"===c&&(v="0"+g.toLowerCase());case"c":y=!1;case"d":m=!0,h=0;break;case"s":p=-1,g="r"}"$"===c&&(v=u[0],d=u[1]),"r"!=g||h||(g="g"),null!=h&&("g"==g?h=Math.max(1,Math.min(21,h)):("e"==g||"f"==g)&&(h=Math.max(0,Math.min(20,h)))),g=oc.get(g)||Ut;var M=l&&f;return function(n){var e=d;if(m&&n%1){return""}var u=0>n||0===n&&0>1/n?(n=-n,"-"):"-"===a?"":a;if(0>p){var c=ta.formatPrefix(n,h);n=c.scale(n),e=c.symbol+d}else{n*=p}n=g(n,h);var x,b,_=n.lastIndexOf(".");if(0>_){var w=y?n.lastIndexOf("e"):-1;0>w?(x=n,b=""):(x=n.substring(0,w),b=n.substring(w))}else{x=n.substring(0,_),b=t+n.substring(_+1)}!l&&f&&(x=i(x,1/0));var S=v.length+x.length+b.length+(M?0:u.length),k=s>S?new Array(S=s-S+1).join(r):"";return M&&(x=i(k+x,k.length?s-b.length:1/0)),u+=v,n=x+b,("<"===o?u+n+k:">"===o?k+u+n:"^"===o?k.substring(0,S>>=1)+u+n+k.substring(S):u+(M?n:k+n))+e}}}function Ut(n){return n+""}function jt(){this._=new Date(arguments.length>1?Date.UTC.apply(this,arguments):arguments[0])}function Ft(n,t,e){function r(t){var e=n(t),r=i(e,1);return r-t>t-e?e:r}function u(e){return t(e=n(new cc(e-1)),1),e}function i(n,e){return t(n=new cc(+n),e),n}function o(n,r,i){var o=u(n),a=[];if(i>1){for(;r>o;){e(o)%i||a.push(new Date(+o)),t(o,1)}}else{for(;r>o;){a.push(new Date(+o)),t(o,1)}}return a}function a(n,t,e){try{cc=jt;var r=new jt;return r._=n,o(r,t,e)}finally{cc=Date}}n.floor=n,n.round=r,n.ceil=u,n.offset=i,n.range=o;var c=n.utc=Ht(n);return c.floor=c,c.round=Ht(r),c.ceil=Ht(u),c.offset=Ht(i),c.range=a,n}function Ht(n){return function(t,e){try{cc=jt;var r=new jt;return r._=t,n(r,e)._}finally{cc=Date}}}function Ot(n){function t(n){function t(t){for(var e,u,i,o=[],a=-1,c=0;++a<r;){37===n.charCodeAt(a)&&(o.push(n.slice(c,a)),null!=(u=sc[e=n.charAt(++a)])&&(e=n.charAt(++a)),(i=N[e])&&(e=i(t,null==u?"e"===e?" ":"0":u)),o.push(e),c=a+1)}return o.push(n.slice(c,a)),o.join("")}var r=n.length;return t.parse=function(t){var r={y:1900,m:0,d:1,H:0,M:0,S:0,L:0,Z:null},u=e(r,n,t,0);if(u!=t.length){return null}"p" in r&&(r.H=r.H%12+12*r.p);var i=null!=r.Z&&cc!==jt,o=new (i?jt:cc);return"j" in r?o.setFullYear(r.y,0,r.j):"w" in r&&("W" in r||"U" in r)?(o.setFullYear(r.y,0,1),o.setFullYear(r.y,0,"W" in r?(r.w+6)%7+7*r.W-(o.getDay()+5)%7:r.w+7*r.U-(o.getDay()+6)%7)):o.setFullYear(r.y,r.m,r.d),o.setHours(r.H+(r.Z/100|0),r.M+r.Z%100,r.S,r.L),i?o._:o},t.toString=function(){return n},t}function e(n,t,e,r){for(var u,i,o,a=0,c=t.length,l=e.length;c>a;){if(r>=l){return -1}if(u=t.charCodeAt(a++),37===u){if(o=t.charAt(a++),i=C[o in sc?t.charAt(a++):o],!i||(r=i(n,e,r))<0){return -1}}else{if(u!=e.charCodeAt(r++)){return -1}}}return r}function r(n,t,e){_.lastIndex=0;var r=_.exec(t.slice(e));return r?(n.w=w.get(r[0].toLowerCase()),e+r[0].length):-1}function u(n,t,e){x.lastIndex=0;var r=x.exec(t.slice(e));return r?(n.w=b.get(r[0].toLowerCase()),e+r[0].length):-1}function i(n,t,e){E.lastIndex=0;var r=E.exec(t.slice(e));return r?(n.m=A.get(r[0].toLowerCase()),e+r[0].length):-1}function o(n,t,e){S.lastIndex=0;var r=S.exec(t.slice(e));return r?(n.m=k.get(r[0].toLowerCase()),e+r[0].length):-1}function a(n,t,r){return e(n,N.c.toString(),t,r)}function c(n,t,r){return e(n,N.x.toString(),t,r)}function l(n,t,r){return e(n,N.X.toString(),t,r)}function s(n,t,e){var r=M.get(t.slice(e,e+=2).toLowerCase());return null==r?-1:(n.p=r,e)}var f=n.dateTime,h=n.date,g=n.time,p=n.periods,v=n.days,d=n.shortDays,m=n.months,y=n.shortMonths;t.utc=function(n){function e(n){try{cc=jt;var t=new cc;return t._=n,r(t)}finally{cc=Date}}var r=t(n);return e.parse=function(n){try{cc=jt;var t=r.parse(n);return t&&t._}finally{cc=Date}},e.toString=r.toString,e},t.multi=t.utc.multi=ae;var M=ta.map(),x=Yt(v),b=Zt(v),_=Yt(d),w=Zt(d),S=Yt(m),k=Zt(m),E=Yt(y),A=Zt(y);p.forEach(function(n,t){M.set(n.toLowerCase(),t)});var N={a:function(n){return d[n.getDay()]},A:function(n){return v[n.getDay()]},b:function(n){return y[n.getMonth()]},B:function(n){return m[n.getMonth()]},c:t(f),d:function(n,t){return It(n.getDate(),t,2)},e:function(n,t){return It(n.getDate(),t,2)},H:function(n,t){return It(n.getHours(),t,2)},I:function(n,t){return It(n.getHours()%12||12,t,2)},j:function(n,t){return It(1+ac.dayOfYear(n),t,3)},L:function(n,t){return It(n.getMilliseconds(),t,3)},m:function(n,t){return It(n.getMonth()+1,t,2)},M:function(n,t){return It(n.getMinutes(),t,2)},p:function(n){return p[+(n.getHours()>=12)]},S:function(n,t){return It(n.getSeconds(),t,2)},U:function(n,t){return It(ac.sundayOfYear(n),t,2)},w:function(n){return n.getDay()},W:function(n,t){return It(ac.mondayOfYear(n),t,2)},x:t(h),X:t(g),y:function(n,t){return It(n.getFullYear()%100,t,2)},Y:function(n,t){return It(n.getFullYear()%10000,t,4)},Z:ie,"%":function(){return"%"}},C={a:r,A:u,b:i,B:o,c:a,d:Qt,e:Qt,H:te,I:te,j:ne,L:ue,m:Kt,M:ee,p:s,S:re,U:Xt,w:Vt,W:$t,x:c,X:l,y:Wt,Y:Bt,Z:Jt,"%":oe};return t}function It(n,t,e){var r=0>n?"-":"",u=(r?-n:n)+"",i=u.length;return r+(e>i?new Array(e-i+1).join(t)+u:u)}function Yt(n){return new RegExp("^(?:"+n.map(ta.requote).join("|")+")","i")}function Zt(n){for(var t=new l,e=-1,r=n.length;++e<r;){t.set(n[e].toLowerCase(),e)}return t}function Vt(n,t,e){fc.lastIndex=0;var r=fc.exec(t.slice(e,e+1));return r?(n.w=+r[0],e+r[0].length):-1}function Xt(n,t,e){fc.lastIndex=0;var r=fc.exec(t.slice(e));return r?(n.U=+r[0],e+r[0].length):-1}function $t(n,t,e){fc.lastIndex=0;var r=fc.exec(t.slice(e));return r?(n.W=+r[0],e+r[0].length):-1}function Bt(n,t,e){fc.lastIndex=0;var r=fc.exec(t.slice(e,e+4));return r?(n.y=+r[0],e+r[0].length):-1}function Wt(n,t,e){fc.lastIndex=0;var r=fc.exec(t.slice(e,e+2));return r?(n.y=Gt(+r[0]),e+r[0].length):-1}function Jt(n,t,e){return/^[+-]\d{4}$/.test(t=t.slice(e,e+5))?(n.Z=-t,e+5):-1}function Gt(n){return n+(n>68?1900:2000)}function Kt(n,t,e){fc.lastIndex=0;var r=fc.exec(t.slice(e,e+2));return r?(n.m=r[0]-1,e+r[0].length):-1}function Qt(n,t,e){fc.lastIndex=0;var r=fc.exec(t.slice(e,e+2));return r?(n.d=+r[0],e+r[0].length):-1}function ne(n,t,e){fc.lastIndex=0;var r=fc.exec(t.slice(e,e+3));return r?(n.j=+r[0],e+r[0].length):-1}function te(n,t,e){fc.lastIndex=0;var r=fc.exec(t.slice(e,e+2));return r?(n.H=+r[0],e+r[0].length):-1}function ee(n,t,e){fc.lastIndex=0;var r=fc.exec(t.slice(e,e+2));return r?(n.M=+r[0],e+r[0].length):-1}function re(n,t,e){fc.lastIndex=0;var r=fc.exec(t.slice(e,e+2));return r?(n.S=+r[0],e+r[0].length):-1}function ue(n,t,e){fc.lastIndex=0;var r=fc.exec(t.slice(e,e+3));return r?(n.L=+r[0],e+r[0].length):-1}function ie(n){var t=n.getTimezoneOffset(),e=t>0?"-":"+",r=ga(t)/60|0,u=ga(t)%60;return e+It(r,"0",2)+It(u,"0",2)}function oe(n,t,e){hc.lastIndex=0;var r=hc.exec(t.slice(e,e+1));return r?e+r[0].length:-1}function ae(n){for(var t=n.length,e=-1;++e<t;){n[e][0]=this(n[e][0])}return function(t){for(var e=0,r=n[e];!r[1](t);){r=n[++e]}return r[0](t)}}function ce(){}function le(n,t,e){var r=e.s=n+t,u=r-n,i=r-u;e.t=n-i+(t-u)}function se(n,t){n&&dc.hasOwnProperty(n.type)&&dc[n.type](n,t)}function fe(n,t,e){var r,u=-1,i=n.length-e;for(t.lineStart();++u<i;){r=n[u],t.point(r[0],r[1],r[2])}t.lineEnd()}function he(n,t){var e=-1,r=n.length;for(t.polygonStart();++e<r;){fe(n[e],t,1)}t.polygonEnd()}function ge(){function n(n,t){n*=Da,t=t*Da/2+qa/4;var e=n-r,o=e>=0?1:-1,a=o*e,c=Math.cos(t),l=Math.sin(t),s=i*l,f=u*c+s*Math.cos(a),h=s*o*Math.sin(a);yc.add(Math.atan2(h,f)),r=n,u=c,i=l}var t,e,r,u,i;Mc.point=function(o,a){Mc.point=n,r=(t=o)*Da,u=Math.cos(a=(e=a)*Da/2+qa/4),i=Math.sin(a)},Mc.lineEnd=function(){n(t,e)}}function pe(n){var t=n[0],e=n[1],r=Math.cos(e);return[r*Math.cos(t),r*Math.sin(t),Math.sin(e)]}function ve(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function de(n,t){return[n[1]*t[2]-n[2]*t[1],n[2]*t[0]-n[0]*t[2],n[0]*t[1]-n[1]*t[0]]}function me(n,t){n[0]+=t[0],n[1]+=t[1],n[2]+=t[2]}function ye(n,t){return[n[0]*t,n[1]*t,n[2]*t]}function Me(n){var t=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);n[0]/=t,n[1]/=t,n[2]/=t}function xe(n){return[Math.atan2(n[1],n[0]),tt(n[2])]}function be(n,t){return ga(n[0]-t[0])<Ca&&ga(n[1]-t[1])<Ca}function _e(n,t){n*=Da;var e=Math.cos(t*=Da);we(e*Math.cos(n),e*Math.sin(n),Math.sin(t))}function we(n,t,e){++xc,_c+=(n-_c)/xc,wc+=(t-wc)/xc,Sc+=(e-Sc)/xc}function Se(){function n(n,u){n*=Da;var i=Math.cos(u*=Da),o=i*Math.cos(n),a=i*Math.sin(n),c=Math.sin(u),l=Math.atan2(Math.sqrt((l=e*c-r*a)*l+(l=r*o-t*c)*l+(l=t*a-e*o)*l),t*o+e*a+r*c);bc+=l,kc+=l*(t+(t=o)),Ec+=l*(e+(e=a)),Ac+=l*(r+(r=c)),we(t,e,r)}var t,e,r;qc.point=function(u,i){u*=Da;var o=Math.cos(i*=Da);t=o*Math.cos(u),e=o*Math.sin(u),r=Math.sin(i),qc.point=n,we(t,e,r)}}function ke(){qc.point=_e}function Ee(){function n(n,t){n*=Da;var e=Math.cos(t*=Da),o=e*Math.cos(n),a=e*Math.sin(n),c=Math.sin(t),l=u*c-i*a,s=i*o-r*c,f=r*a-u*o,h=Math.sqrt(l*l+s*s+f*f),g=r*o+u*a+i*c,p=h&&-nt(g)/h,v=Math.atan2(h,g);Nc+=p*l,Cc+=p*s,zc+=p*f,bc+=v,kc+=v*(r+(r=o)),Ec+=v*(u+(u=a)),Ac+=v*(i+(i=c)),we(r,u,i)}var t,e,r,u,i;qc.point=function(o,a){t=o,e=a,qc.point=n,o*=Da;var c=Math.cos(a*=Da);r=c*Math.cos(o),u=c*Math.sin(o),i=Math.sin(a),we(r,u,i)},qc.lineEnd=function(){n(t,e),qc.lineEnd=ke,qc.point=_e}}function Ae(n,t){function e(e,r){return e=n(e,r),t(e[0],e[1])}return n.invert&&t.invert&&(e.invert=function(e,r){return e=t.invert(e,r),e&&n.invert(e[0],e[1])}),e}function Ne(){return !0}function Ce(n,t,e,r,u){var i=[],o=[];if(n.forEach(function(n){if(!((t=n.length-1)<=0)){var t,e=n[0],r=n[t];if(be(e,r)){u.lineStart();for(var a=0;t>a;++a){u.point((e=n[a])[0],e[1])}return void u.lineEnd()}var c=new qe(e,n,null,!0),l=new qe(e,null,c,!1);c.o=l,i.push(c),o.push(l),c=new qe(r,n,null,!1),l=new qe(r,null,c,!0),c.o=l,i.push(c),o.push(l)}}),o.sort(t),ze(i),ze(o),i.length){for(var a=0,c=e,l=o.length;l>a;++a){o[a].e=c=!c}for(var s,f,h=i[0];;){for(var g=h,p=!0;g.v;){if((g=g.n)===h){return}}s=g.z,u.lineStart();do{if(g.v=g.o.v=!0,g.e){if(p){for(var a=0,l=s.length;l>a;++a){u.point((f=s[a])[0],f[1])}}else{r(g.x,g.n.x,1,u)}g=g.n}else{if(p){s=g.p.z;for(var a=s.length-1;a>=0;--a){u.point((f=s[a])[0],f[1])}}else{r(g.x,g.p.x,-1,u)}g=g.p}g=g.o,s=g.z,p=!p}while(!g.v);u.lineEnd()}}}function ze(n){if(t=n.length){for(var t,e,r=0,u=n[0];++r<t;){u.n=e=n[r],e.p=u,u=e}u.n=e=n[0],e.p=u}}function qe(n,t,e,r){this.x=n,this.z=t,this.o=e,this.e=r,this.v=!1,this.n=this.p=null}function Le(n,t,e,r){return function(u,i){function o(t,e){var r=u(t,e);n(t=r[0],e=r[1])&&i.point(t,e)}function a(n,t){var e=u(n,t);d.point(e[0],e[1])}function c(){y.point=a,d.lineStart()}function l(){y.point=o,d.lineEnd()}function s(n,t){v.push([n,t]);var e=u(n,t);x.point(e[0],e[1])}function f(){x.lineStart(),v=[]}function h(){s(v[0][0],v[0][1]),x.lineEnd();var n,t=x.clean(),e=M.buffer(),r=e.length;if(v.pop(),p.push(v),v=null,r){if(1&t){n=e[0];var u,r=n.length-1,o=-1;if(r>0){for(b||(i.polygonStart(),b=!0),i.lineStart();++o<r;){i.point((u=n[o])[0],u[1])}i.lineEnd()}}else{r>1&&2&t&&e.push(e.pop().concat(e.shift())),g.push(e.filter(Te))}}}var g,p,v,d=t(i),m=u.invert(r[0],r[1]),y={point:o,lineStart:c,lineEnd:l,polygonStart:function(){y.point=s,y.lineStart=f,y.lineEnd=h,g=[],p=[]},polygonEnd:function(){y.point=o,y.lineStart=c,y.lineEnd=l,g=ta.merge(g);var n=Fe(m,p);g.length?(b||(i.polygonStart(),b=!0),Ce(g,De,n,e,i)):n&&(b||(i.polygonStart(),b=!0),i.lineStart(),e(null,null,1,i),i.lineEnd()),b&&(i.polygonEnd(),b=!1),g=p=null},sphere:function(){i.polygonStart(),i.lineStart(),e(null,null,1,i),i.lineEnd(),i.polygonEnd()}},M=Re(),x=t(M),b=!1;return y}}function Te(n){return n.length>1}function Re(){var n,t=[];return{lineStart:function(){t.push(n=[])},point:function(t,e){n.push([t,e])},lineEnd:b,buffer:function(){var e=t;return t=[],n=null,e},rejoin:function(){t.length>1&&t.push(t.pop().concat(t.shift()))}}}function De(n,t){return((n=n.x)[0]<0?n[1]-Ra-Ca:Ra-n[1])-((t=t.x)[0]<0?t[1]-Ra-Ca:Ra-t[1])}function Pe(n){var t,e=0/0,r=0/0,u=0/0;return{lineStart:function(){n.lineStart(),t=1},point:function(i,o){var a=i>0?qa:-qa,c=ga(i-e);ga(c-qa)<Ca?(n.point(e,r=(r+o)/2>0?Ra:-Ra),n.point(u,r),n.lineEnd(),n.lineStart(),n.point(a,r),n.point(i,r),t=0):u!==a&&c>=qa&&(ga(e-u)<Ca&&(e-=u*Ca),ga(i-a)<Ca&&(i-=a*Ca),r=Ue(e,r,i,o),n.point(u,r),n.lineEnd(),n.lineStart(),n.point(a,r),t=0),n.point(e=i,r=o),u=a},lineEnd:function(){n.lineEnd(),e=r=0/0},clean:function(){return 2-t}}}function Ue(n,t,e,r){var u,i,o=Math.sin(n-e);return ga(o)>Ca?Math.atan((Math.sin(t)*(i=Math.cos(r))*Math.sin(e)-Math.sin(r)*(u=Math.cos(t))*Math.sin(n))/(u*i*o)):(t+r)/2}function je(n,t,e,r){var u;if(null==n){u=e*Ra,r.point(-qa,u),r.point(0,u),r.point(qa,u),r.point(qa,0),r.point(qa,-u),r.point(0,-u),r.point(-qa,-u),r.point(-qa,0),r.point(-qa,u)}else{if(ga(n[0]-t[0])>Ca){var i=n[0]<t[0]?qa:-qa;u=e*i/2,r.point(-i,u),r.point(0,u),r.point(i,u)}else{r.point(t[0],t[1])}}}function Fe(n,t){var e=n[0],r=n[1],u=[Math.sin(e),-Math.cos(e),0],i=0,o=0;yc.reset();for(var a=0,c=t.length;c>a;++a){var l=t[a],s=l.length;if(s){for(var f=l[0],h=f[0],g=f[1]/2+qa/4,p=Math.sin(g),v=Math.cos(g),d=1;;){d===s&&(d=0),n=l[d];var m=n[0],y=n[1]/2+qa/4,M=Math.sin(y),x=Math.cos(y),b=m-h,_=b>=0?1:-1,w=_*b,S=w>qa,k=p*M;if(yc.add(Math.atan2(k*_*Math.sin(w),v*x+k*Math.cos(w))),i+=S?b+_*La:b,S^h>=e^m>=e){var E=de(pe(f),pe(n));Me(E);var A=de(u,E);Me(A);var N=(S^b>=0?-1:1)*tt(A[2]);(r>N||r===N&&(E[0]||E[1]))&&(o+=S^b>=0?1:-1)}if(!d++){break}h=m,p=M,v=x,f=n}}}return(-Ca>i||Ca>i&&0>yc)^1&o}function He(n){function t(n,t){return Math.cos(n)*Math.cos(t)>i}function e(n){var e,i,c,l,s;return{lineStart:function(){l=c=!1,s=1},point:function(f,h){var g,p=[f,h],v=t(f,h),d=o?v?0:u(f,h):v?u(f+(0>f?qa:-qa),h):0;if(!e&&(l=c=v)&&n.lineStart(),v!==c&&(g=r(e,p),(be(e,g)||be(p,g))&&(p[0]+=Ca,p[1]+=Ca,v=t(p[0],p[1]))),v!==c){s=0,v?(n.lineStart(),g=r(p,e),n.point(g[0],g[1])):(g=r(e,p),n.point(g[0],g[1]),n.lineEnd()),e=g}else{if(a&&e&&o^v){var m;d&i||!(m=r(p,e,!0))||(s=0,o?(n.lineStart(),n.point(m[0][0],m[0][1]),n.point(m[1][0],m[1][1]),n.lineEnd()):(n.point(m[1][0],m[1][1]),n.lineEnd(),n.lineStart(),n.point(m[0][0],m[0][1])))}}!v||e&&be(e,p)||n.point(p[0],p[1]),e=p,c=v,i=d},lineEnd:function(){c&&n.lineEnd(),e=null},clean:function(){return s|(l&&c)<<1}}}function r(n,t,e){var r=pe(n),u=pe(t),o=[1,0,0],a=de(r,u),c=ve(a,a),l=a[0],s=c-l*l;if(!s){return !e&&n}var f=i*c/s,h=-i*l/s,g=de(o,a),p=ye(o,f),v=ye(a,h);me(p,v);var d=g,m=ve(p,d),y=ve(d,d),M=m*m-y*(ve(p,p)-1);if(!(0>M)){var x=Math.sqrt(M),b=ye(d,(-m-x)/y);if(me(b,p),b=xe(b),!e){return b}var _,w=n[0],S=t[0],k=n[1],E=t[1];w>S&&(_=w,w=S,S=_);var A=S-w,N=ga(A-qa)<Ca,C=N||Ca>A;if(!N&&k>E&&(_=k,k=E,E=_),C?N?k+E>0^b[1]<(ga(b[0]-w)<Ca?k:E):k<=b[1]&&b[1]<=E:A>qa^(w<=b[0]&&b[0]<=S)){var z=ye(d,(-m+x)/y);return me(z,p),[b,xe(z)]}}}function u(t,e){var r=o?n:qa-n,u=0;return -r>t?u|=1:t>r&&(u|=2),-r>e?u|=4:e>r&&(u|=8),u}var i=Math.cos(n),o=i>0,a=ga(i)>Ca,c=gr(n,6*Da);return Le(t,e,c,o?[0,-n]:[-qa,n-qa])}function Oe(n,t,e,r){return function(u){var i,o=u.a,a=u.b,c=o.x,l=o.y,s=a.x,f=a.y,h=0,g=1,p=s-c,v=f-l;if(i=n-c,p||!(i>0)){if(i/=p,0>p){if(h>i){return}g>i&&(g=i)}else{if(p>0){if(i>g){return}i>h&&(h=i)}}if(i=e-c,p||!(0>i)){if(i/=p,0>p){if(i>g){return}i>h&&(h=i)}else{if(p>0){if(h>i){return}g>i&&(g=i)}}if(i=t-l,v||!(i>0)){if(i/=v,0>v){if(h>i){return}g>i&&(g=i)}else{if(v>0){if(i>g){return}i>h&&(h=i)}}if(i=r-l,v||!(0>i)){if(i/=v,0>v){if(i>g){return}i>h&&(h=i)}else{if(v>0){if(h>i){return}g>i&&(g=i)}}return h>0&&(u.a={x:c+h*p,y:l+h*v}),1>g&&(u.b={x:c+g*p,y:l+g*v}),u}}}}}}function Ie(n,t,e,r){function u(r,u){return ga(r[0]-n)<Ca?u>0?0:3:ga(r[0]-e)<Ca?u>0?2:1:ga(r[1]-t)<Ca?u>0?1:0:u>0?3:2}function i(n,t){return o(n.x,t.x)}function o(n,t){var e=u(n,1),r=u(t,1);return e!==r?e-r:0===e?t[1]-n[1]:1===e?n[0]-t[0]:2===e?n[1]-t[1]:t[0]-n[0]}return function(a){function c(n){for(var t=0,e=d.length,r=n[1],u=0;e>u;++u){for(var i,o=1,a=d[u],c=a.length,l=a[0];c>o;++o){i=a[o],l[1]<=r?i[1]>r&&Q(l,i,n)>0&&++t:i[1]<=r&&Q(l,i,n)<0&&--t,l=i}}return 0!==t}function l(i,a,c,l){var s=0,f=0;if(null==i||(s=u(i,c))!==(f=u(a,c))||o(i,a)<0^c>0){do{l.point(0===s||3===s?n:e,s>1?r:t)}while((s=(s+c+4)%4)!==f)}else{l.point(a[0],a[1])}}function s(u,i){return u>=n&&e>=u&&i>=t&&r>=i}function f(n,t){s(n,t)&&a.point(n,t)}function h(){C.point=p,d&&d.push(m=[]),S=!0,w=!1,b=_=0/0}function g(){v&&(p(y,M),x&&w&&A.rejoin(),v.push(A.buffer())),C.point=f,w&&a.lineEnd()}function p(n,t){n=Math.max(-Tc,Math.min(Tc,n)),t=Math.max(-Tc,Math.min(Tc,t));var e=s(n,t);if(d&&m.push([n,t]),S){y=n,M=t,x=e,S=!1,e&&(a.lineStart(),a.point(n,t))}else{if(e&&w){a.point(n,t)}else{var r={a:{x:b,y:_},b:{x:n,y:t}};N(r)?(w||(a.lineStart(),a.point(r.a.x,r.a.y)),a.point(r.b.x,r.b.y),e||a.lineEnd(),k=!1):e&&(a.lineStart(),a.point(n,t),k=!1)}}b=n,_=t,w=e}var v,d,m,y,M,x,b,_,w,S,k,E=a,A=Re(),N=Oe(n,t,e,r),C={point:f,lineStart:h,lineEnd:g,polygonStart:function(){a=A,v=[],d=[],k=!0},polygonEnd:function(){a=E,v=ta.merge(v);var t=c([n,r]),e=k&&t,u=v.length;(e||u)&&(a.polygonStart(),e&&(a.lineStart(),l(null,null,1,a),a.lineEnd()),u&&Ce(v,i,t,l,a),a.polygonEnd()),v=d=m=null}};return C}}function Ye(n){var t=0,e=qa/3,r=ir(n),u=r(t,e);return u.parallels=function(n){return arguments.length?r(t=n[0]*qa/180,e=n[1]*qa/180):[t/qa*180,e/qa*180]},u}function Ze(n,t){function e(n,t){var e=Math.sqrt(i-2*u*Math.sin(t))/u;return[e*Math.sin(n*=u),o-e*Math.cos(n)]}var r=Math.sin(n),u=(r+Math.sin(t))/2,i=1+r*(2*u-r),o=Math.sqrt(i)/u;return e.invert=function(n,t){var e=o-t;return[Math.atan2(n,e)/u,tt((i-(n*n+e*e)*u*u)/(2*u))]},e}function Ve(){function n(n,t){Dc+=u*n-r*t,r=n,u=t}var t,e,r,u;Hc.point=function(i,o){Hc.point=n,t=r=i,e=u=o},Hc.lineEnd=function(){n(t,e)}}function Xe(n,t){Pc>n&&(Pc=n),n>jc&&(jc=n),Uc>t&&(Uc=t),t>Fc&&(Fc=t)}function $e(){function n(n,t){o.push("M",n,",",t,i)}function t(n,t){o.push("M",n,",",t),a.point=e}function e(n,t){o.push("L",n,",",t)}function r(){a.point=n}function u(){o.push("Z")}var i=Be(4.5),o=[],a={point:n,lineStart:function(){a.point=t},lineEnd:r,polygonStart:function(){a.lineEnd=u},polygonEnd:function(){a.lineEnd=r,a.point=n},pointRadius:function(n){return i=Be(n),a},result:function(){if(o.length){var n=o.join("");return o=[],n}}};return a}function Be(n){return"m0,"+n+"a"+n+","+n+" 0 1,1 0,"+-2*n+"a"+n+","+n+" 0 1,1 0,"+2*n+"z"}function We(n,t){_c+=n,wc+=t,++Sc}function Je(){function n(n,r){var u=n-t,i=r-e,o=Math.sqrt(u*u+i*i);kc+=o*(t+n)/2,Ec+=o*(e+r)/2,Ac+=o,We(t=n,e=r)}var t,e;Ic.point=function(r,u){Ic.point=n,We(t=r,e=u)}}function Ge(){Ic.point=We}function Ke(){function n(n,t){var e=n-r,i=t-u,o=Math.sqrt(e*e+i*i);kc+=o*(r+n)/2,Ec+=o*(u+t)/2,Ac+=o,o=u*n-r*t,Nc+=o*(r+n),Cc+=o*(u+t),zc+=3*o,We(r=n,u=t)}var t,e,r,u;Ic.point=function(i,o){Ic.point=n,We(t=r=i,e=u=o)},Ic.lineEnd=function(){n(t,e)}}function Qe(n){function t(t,e){n.moveTo(t+o,e),n.arc(t,e,o,0,La)}function e(t,e){n.moveTo(t,e),a.point=r}function r(t,e){n.lineTo(t,e)}function u(){a.point=t}function i(){n.closePath()}var o=4.5,a={point:t,lineStart:function(){a.point=e},lineEnd:u,polygonStart:function(){a.lineEnd=i},polygonEnd:function(){a.lineEnd=u,a.point=t},pointRadius:function(n){return o=n,a},result:b};return a}function nr(n){function t(n){return(a?r:e)(n)}function e(t){return rr(t,function(e,r){e=n(e,r),t.point(e[0],e[1])})}function r(t){function e(e,r){e=n(e,r),t.point(e[0],e[1])}function r(){M=0/0,S.point=i,t.lineStart()}function i(e,r){var i=pe([e,r]),o=n(e,r);u(M,x,y,b,_,w,M=o[0],x=o[1],y=e,b=i[0],_=i[1],w=i[2],a,t),t.point(M,x)}function o(){S.point=e,t.lineEnd()}function c(){r(),S.point=l,S.lineEnd=s}function l(n,t){i(f=n,h=t),g=M,p=x,v=b,d=_,m=w,S.point=i}function s(){u(M,x,y,b,_,w,g,p,f,v,d,m,a,t),S.lineEnd=o,o()}var f,h,g,p,v,d,m,y,M,x,b,_,w,S={point:e,lineStart:r,lineEnd:o,polygonStart:function(){t.polygonStart(),S.lineStart=c},polygonEnd:function(){t.polygonEnd(),S.lineStart=r}};return S}function u(t,e,r,a,c,l,s,f,h,g,p,v,d,m){var y=s-t,M=f-e,x=y*y+M*M;if(x>4*i&&d--){var b=a+g,_=c+p,w=l+v,S=Math.sqrt(b*b+_*_+w*w),k=Math.asin(w/=S),E=ga(ga(w)-1)<Ca||ga(r-h)<Ca?(r+h)/2:Math.atan2(_,b),A=n(E,k),N=A[0],C=A[1],z=N-t,q=C-e,L=M*z-y*q;(L*L/x>i||ga((y*z+M*q)/x-0.5)>0.3||o>a*g+c*p+l*v)&&(u(t,e,r,a,c,l,N,C,E,b/=S,_/=S,w,d,m),m.point(N,C),u(N,C,E,b,_,w,s,f,h,g,p,v,d,m))}}var i=0.5,o=Math.cos(30*Da),a=16;return t.precision=function(n){return arguments.length?(a=(i=n*n)>0&&16,t):Math.sqrt(i)},t}function tr(n){var t=nr(function(t,e){return n([t*Pa,e*Pa])});return function(n){return or(t(n))}}function er(n){this.stream=n}function rr(n,t){return{point:t,sphere:function(){n.sphere()},lineStart:function(){n.lineStart()},lineEnd:function(){n.lineEnd()},polygonStart:function(){n.polygonStart()},polygonEnd:function(){n.polygonEnd()}}}function ur(n){return ir(function(){return n})()}function ir(n){function t(n){return n=a(n[0]*Da,n[1]*Da),[n[0]*h+c,l-n[1]*h]}function e(n){return n=a.invert((n[0]-c)/h,(l-n[1])/h),n&&[n[0]*Pa,n[1]*Pa]}function r(){a=Ae(o=lr(m,M,x),i);var n=i(v,d);return c=g-n[0]*h,l=p+n[1]*h,u()}function u(){return s&&(s.valid=!1,s=null),t}var i,o,a,c,l,s,f=nr(function(n,t){return n=i(n,t),[n[0]*h+c,l-n[1]*h]}),h=150,g=480,p=250,v=0,d=0,m=0,M=0,x=0,b=Lc,_=y,w=null,S=null;return t.stream=function(n){return s&&(s.valid=!1),s=or(b(o,f(_(n)))),s.valid=!0,s},t.clipAngle=function(n){return arguments.length?(b=null==n?(w=n,Lc):He((w=+n)*Da),u()):w},t.clipExtent=function(n){return arguments.length?(S=n,_=n?Ie(n[0][0],n[0][1],n[1][0],n[1][1]):y,u()):S},t.scale=function(n){return arguments.length?(h=+n,r()):h},t.translate=function(n){return arguments.length?(g=+n[0],p=+n[1],r()):[g,p]},t.center=function(n){return arguments.length?(v=n[0]%360*Da,d=n[1]%360*Da,r()):[v*Pa,d*Pa]},t.rotate=function(n){return arguments.length?(m=n[0]%360*Da,M=n[1]%360*Da,x=n.length>2?n[2]%360*Da:0,r()):[m*Pa,M*Pa,x*Pa]},ta.rebind(t,f,"precision"),function(){return i=n.apply(this,arguments),t.invert=i.invert&&e,r()}}function or(n){return rr(n,function(t,e){n.point(t*Da,e*Da)})}function ar(n,t){return[n,t]}function cr(n,t){return[n>qa?n-La:-qa>n?n+La:n,t]}function lr(n,t,e){return n?t||e?Ae(fr(n),hr(t,e)):fr(n):t||e?hr(t,e):cr}function sr(n){return function(t,e){return t+=n,[t>qa?t-La:-qa>t?t+La:t,e]}}function fr(n){var t=sr(n);return t.invert=sr(-n),t}function hr(n,t){function e(n,t){var e=Math.cos(t),a=Math.cos(n)*e,c=Math.sin(n)*e,l=Math.sin(t),s=l*r+a*u;return[Math.atan2(c*i-s*o,a*r-l*u),tt(s*i+c*o)]}var r=Math.cos(n),u=Math.sin(n),i=Math.cos(t),o=Math.sin(t);return e.invert=function(n,t){var e=Math.cos(t),a=Math.cos(n)*e,c=Math.sin(n)*e,l=Math.sin(t),s=l*i-c*o;return[Math.atan2(c*i+l*o,a*r+s*u),tt(s*r-a*u)]},e}function gr(n,t){var e=Math.cos(n),r=Math.sin(n);return function(u,i,o,a){var c=o*t;null!=u?(u=pr(e,u),i=pr(e,i),(o>0?i>u:u>i)&&(u+=o*La)):(u=n+o*La,i=n-0.5*c);for(var l,s=u;o>0?s>i:i>s;s-=c){a.point((l=xe([e,-r*Math.cos(s),-r*Math.sin(s)]))[0],l[1])}}}function pr(n,t){var e=pe(t);e[0]-=n,Me(e);var r=nt(-e[1]);return((-e[2]<0?-r:r)+2*Math.PI-Ca)%(2*Math.PI)}function vr(n,t,e){var r=ta.range(n,t-Ca,e).concat(t);return function(n){return r.map(function(t){return[n,t]})}}function dr(n,t,e){var r=ta.range(n,t-Ca,e).concat(t);return function(n){return r.map(function(t){return[t,n]})}}function mr(n){return n.source}function yr(n){return n.target}function Mr(n,t,e,r){var u=Math.cos(t),i=Math.sin(t),o=Math.cos(r),a=Math.sin(r),c=u*Math.cos(n),l=u*Math.sin(n),s=o*Math.cos(e),f=o*Math.sin(e),h=2*Math.asin(Math.sqrt(it(r-t)+u*o*it(e-n))),g=1/Math.sin(h),p=h?function(n){var t=Math.sin(n*=h)*g,e=Math.sin(h-n)*g,r=e*c+t*s,u=e*l+t*f,o=e*i+t*a;return[Math.atan2(u,r)*Pa,Math.atan2(o,Math.sqrt(r*r+u*u))*Pa]}:function(){return[n*Pa,t*Pa]};return p.distance=h,p}function xr(){function n(n,u){var i=Math.sin(u*=Da),o=Math.cos(u),a=ga((n*=Da)-t),c=Math.cos(a);Yc+=Math.atan2(Math.sqrt((a=o*Math.sin(a))*a+(a=r*i-e*o*c)*a),e*i+r*o*c),t=n,e=i,r=o}var t,e,r;Zc.point=function(u,i){t=u*Da,e=Math.sin(i*=Da),r=Math.cos(i),Zc.point=n},Zc.lineEnd=function(){Zc.point=Zc.lineEnd=b}}function br(n,t){function e(t,e){var r=Math.cos(t),u=Math.cos(e),i=n(r*u);return[i*u*Math.sin(t),i*Math.sin(e)]}return e.invert=function(n,e){var r=Math.sqrt(n*n+e*e),u=t(r),i=Math.sin(u),o=Math.cos(u);return[Math.atan2(n*i,r*o),Math.asin(r&&e*i/r)]},e}function _r(n,t){function e(n,t){o>0?-Ra+Ca>t&&(t=-Ra+Ca):t>Ra-Ca&&(t=Ra-Ca);var e=o/Math.pow(u(t),i);return[e*Math.sin(i*n),o-e*Math.cos(i*n)]}var r=Math.cos(n),u=function(n){return Math.tan(qa/4+n/2)},i=n===t?Math.sin(n):Math.log(r/Math.cos(t))/Math.log(u(t)/u(n)),o=r*Math.pow(u(n),i)/i;return i?(e.invert=function(n,t){var e=o-t,r=K(i)*Math.sqrt(n*n+e*e);return[Math.atan2(n,e)/i,2*Math.atan(Math.pow(o/r,1/i))-Ra]},e):Sr}function wr(n,t){function e(n,t){var e=i-t;return[e*Math.sin(u*n),i-e*Math.cos(u*n)]}var r=Math.cos(n),u=n===t?Math.sin(n):(r-Math.cos(t))/(t-n),i=r/u+n;return ga(u)<Ca?ar:(e.invert=function(n,t){var e=i-t;return[Math.atan2(n,e)/u,i-K(u)*Math.sqrt(n*n+e*e)]},e)}function Sr(n,t){return[n,Math.log(Math.tan(qa/4+t/2))]}function kr(n){var t,e=ur(n),r=e.scale,u=e.translate,i=e.clipExtent;return e.scale=function(){var n=r.apply(e,arguments);return n===e?t?e.clipExtent(null):e:n},e.translate=function(){var n=u.apply(e,arguments);return n===e?t?e.clipExtent(null):e:n},e.clipExtent=function(n){var o=i.apply(e,arguments);if(o===e){if(t=null==n){var a=qa*r(),c=u();i([[c[0]-a,c[1]-a],[c[0]+a,c[1]+a]])}}else{t&&(o=null)}return o},e.clipExtent(null)}function Er(n,t){return[Math.log(Math.tan(qa/4+t/2)),-n]}function Ar(n){return n[0]}function Nr(n){return n[1]}function Cr(n){for(var t=n.length,e=[0,1],r=2,u=2;t>u;u++){for(;r>1&&Q(n[e[r-2]],n[e[r-1]],n[u])<=0;){--r}e[r++]=u}return e.slice(0,r)}function zr(n,t){return n[0]-t[0]||n[1]-t[1]}function qr(n,t,e){return(e[0]-t[0])*(n[1]-t[1])<(e[1]-t[1])*(n[0]-t[0])}function Lr(n,t,e,r){var u=n[0],i=e[0],o=t[0]-u,a=r[0]-i,c=n[1],l=e[1],s=t[1]-c,f=r[1]-l,h=(a*(c-l)-f*(u-i))/(f*o-a*s);return[u+h*o,c+h*s]}function Tr(n){var t=n[0],e=n[n.length-1];return !(t[0]-e[0]||t[1]-e[1])}function Rr(){tu(this),this.edge=this.site=this.circle=null}function Dr(n){var t=el.pop()||new Rr;return t.site=n,t}function Pr(n){Xr(n),Qc.remove(n),el.push(n),tu(n)}function Ur(n){var t=n.circle,e=t.x,r=t.cy,u={x:e,y:r},i=n.P,o=n.N,a=[n];Pr(n);for(var c=i;c.circle&&ga(e-c.circle.x)<Ca&&ga(r-c.circle.cy)<Ca;){i=c.P,a.unshift(c),Pr(c),c=i}a.unshift(c),Xr(c);for(var l=o;l.circle&&ga(e-l.circle.x)<Ca&&ga(r-l.circle.cy)<Ca;){o=l.N,a.push(l),Pr(l),l=o}a.push(l),Xr(l);var s,f=a.length;for(s=1;f>s;++s){l=a[s],c=a[s-1],Kr(l.edge,c.site,l.site,u)}c=a[0],l=a[f-1],l.edge=Jr(c.site,l.site,null,u),Vr(c),Vr(l)}function jr(n){for(var t,e,r,u,i=n.x,o=n.y,a=Qc._;a;){if(r=Fr(a,o)-i,r>Ca){a=a.L}else{if(u=i-Hr(a,o),!(u>Ca)){r>-Ca?(t=a.P,e=a):u>-Ca?(t=a,e=a.N):t=e=a;break}if(!a.R){t=a;break}a=a.R}}var c=Dr(n);if(Qc.insert(t,c),t||e){if(t===e){return Xr(t),e=Dr(t.site),Qc.insert(c,e),c.edge=e.edge=Jr(t.site,c.site),Vr(t),void Vr(e)}if(!e){return void (c.edge=Jr(t.site,c.site))}Xr(t),Xr(e);var l=t.site,s=l.x,f=l.y,h=n.x-s,g=n.y-f,p=e.site,v=p.x-s,d=p.y-f,m=2*(h*d-g*v),y=h*h+g*g,M=v*v+d*d,x={x:(d*y-g*M)/m+s,y:(h*M-v*y)/m+f};Kr(e.edge,l,p,x),c.edge=Jr(l,n,null,x),e.edge=Jr(n,p,null,x),Vr(t),Vr(e)}}function Fr(n,t){var e=n.site,r=e.x,u=e.y,i=u-t;if(!i){return r}var o=n.P;if(!o){return -1/0}e=o.site;var a=e.x,c=e.y,l=c-t;if(!l){return a}var s=a-r,f=1/i-1/l,h=s/l;return f?(-h+Math.sqrt(h*h-2*f*(s*s/(-2*l)-c+l/2+u-i/2)))/f+r:(r+a)/2}function Hr(n,t){var e=n.N;if(e){return Fr(e,t)}var r=n.site;return r.y===t?r.x:1/0}function Or(n){this.site=n,this.edges=[]}function Ir(n){for(var t,e,r,u,i,o,a,c,l,s,f=n[0][0],h=n[1][0],g=n[0][1],p=n[1][1],v=Kc,d=v.length;d--;){if(i=v[d],i&&i.prepare()){for(a=i.edges,c=a.length,o=0;c>o;){s=a[o].end(),r=s.x,u=s.y,l=a[++o%c].start(),t=l.x,e=l.y,(ga(r-t)>Ca||ga(u-e)>Ca)&&(a.splice(o,0,new Qr(Gr(i.site,s,ga(r-f)<Ca&&p-u>Ca?{x:f,y:ga(t-f)<Ca?e:p}:ga(u-p)<Ca&&h-r>Ca?{x:ga(e-p)<Ca?t:h,y:p}:ga(r-h)<Ca&&u-g>Ca?{x:h,y:ga(t-h)<Ca?e:g}:ga(u-g)<Ca&&r-f>Ca?{x:ga(e-g)<Ca?t:f,y:g}:null),i.site,null)),++c)}}}}function Yr(n,t){return t.angle-n.angle}function Zr(){tu(this),this.x=this.y=this.arc=this.site=this.cy=null}function Vr(n){var t=n.P,e=n.N;if(t&&e){var r=t.site,u=n.site,i=e.site;if(r!==i){var o=u.x,a=u.y,c=r.x-o,l=r.y-a,s=i.x-o,f=i.y-a,h=2*(c*f-l*s);if(!(h>=-za)){var g=c*c+l*l,p=s*s+f*f,v=(f*g-l*p)/h,d=(c*p-s*g)/h,f=d+a,m=rl.pop()||new Zr;m.arc=n,m.site=u,m.x=v+o,m.y=f+Math.sqrt(v*v+d*d),m.cy=f,n.circle=m;for(var y=null,M=tl._;M;){if(m.y<M.y||m.y===M.y&&m.x<=M.x){if(!M.L){y=M.P;break}M=M.L}else{if(!M.R){y=M;break}M=M.R}}tl.insert(y,m),y||(nl=m)}}}}function Xr(n){var t=n.circle;t&&(t.P||(nl=t.N),tl.remove(t),rl.push(t),tu(t),n.circle=null)}function $r(n){for(var t,e=Gc,r=Oe(n[0][0],n[0][1],n[1][0],n[1][1]),u=e.length;u--;){t=e[u],(!Br(t,n)||!r(t)||ga(t.a.x-t.b.x)<Ca&&ga(t.a.y-t.b.y)<Ca)&&(t.a=t.b=null,e.splice(u,1))}}function Br(n,t){var e=n.b;if(e){return !0}var r,u,i=n.a,o=t[0][0],a=t[1][0],c=t[0][1],l=t[1][1],s=n.l,f=n.r,h=s.x,g=s.y,p=f.x,v=f.y,d=(h+p)/2,m=(g+v)/2;if(v===g){if(o>d||d>=a){return}if(h>p){if(i){if(i.y>=l){return}}else{i={x:d,y:c}}e={x:d,y:l}}else{if(i){if(i.y<c){return}}else{i={x:d,y:l}}e={x:d,y:c}}}else{if(r=(h-p)/(v-g),u=m-r*d,-1>r||r>1){if(h>p){if(i){if(i.y>=l){return}}else{i={x:(c-u)/r,y:c}}e={x:(l-u)/r,y:l}}else{if(i){if(i.y<c){return}}else{i={x:(l-u)/r,y:l}}e={x:(c-u)/r,y:c}}}else{if(v>g){if(i){if(i.x>=a){return}}else{i={x:o,y:r*o+u}}e={x:a,y:r*a+u}}else{if(i){if(i.x<o){return}}else{i={x:a,y:r*a+u}}e={x:o,y:r*o+u}}}}return n.a=i,n.b=e,!0}function Wr(n,t){this.l=n,this.r=t,this.a=this.b=null}function Jr(n,t,e,r){var u=new Wr(n,t);return Gc.push(u),e&&Kr(u,n,t,e),r&&Kr(u,t,n,r),Kc[n.i].edges.push(new Qr(u,n,t)),Kc[t.i].edges.push(new Qr(u,t,n)),u}function Gr(n,t,e){var r=new Wr(n,null);return r.a=t,r.b=e,Gc.push(r),r}function Kr(n,t,e,r){n.a||n.b?n.l===e?n.b=r:n.a=r:(n.a=r,n.l=t,n.r=e)}function Qr(n,t,e){var r=n.a,u=n.b;this.edge=n,this.site=t,this.angle=e?Math.atan2(e.y-t.y,e.x-t.x):n.l===t?Math.atan2(u.x-r.x,r.y-u.y):Math.atan2(r.x-u.x,u.y-r.y)}function nu(){this._=null}function tu(n){n.U=n.C=n.L=n.R=n.P=n.N=null}function eu(n,t){var e=t,r=t.R,u=e.U;u?u.L===e?u.L=r:u.R=r:n._=r,r.U=u,e.U=r,e.R=r.L,e.R&&(e.R.U=e),r.L=e}function ru(n,t){var e=t,r=t.L,u=e.U;u?u.L===e?u.L=r:u.R=r:n._=r,r.U=u,e.U=r,e.L=r.R,e.L&&(e.L.U=e),r.R=e}function uu(n){for(;n.L;){n=n.L}return n}function iu(n,t){var e,r,u,i=n.sort(ou).pop();for(Gc=[],Kc=new Array(n.length),Qc=new nu,tl=new nu;;){if(u=nl,i&&(!u||i.y<u.y||i.y===u.y&&i.x<u.x)){(i.x!==e||i.y!==r)&&(Kc[i.i]=new Or(i),jr(i),e=i.x,r=i.y),i=n.pop()}else{if(!u){break}Ur(u.arc)}}t&&($r(t),Ir(t));var o={cells:Kc,edges:Gc};return Qc=tl=Gc=Kc=null,o}function ou(n,t){return t.y-n.y||t.x-n.x}function au(n,t,e){return(n.x-e.x)*(t.y-n.y)-(n.x-t.x)*(e.y-n.y)}function cu(n){return n.x}function lu(n){return n.y}function su(){return{leaf:!0,nodes:[],point:null,x:null,y:null}}function fu(n,t,e,r,u,i){if(!n(t,e,r,u,i)){var o=0.5*(e+u),a=0.5*(r+i),c=t.nodes;c[0]&&fu(n,c[0],e,r,o,a),c[1]&&fu(n,c[1],o,r,u,a),c[2]&&fu(n,c[2],e,a,o,i),c[3]&&fu(n,c[3],o,a,u,i)}}function hu(n,t,e,r,u,i,o){var a,c=1/0;return function l(n,s,f,h,g){if(!(s>i||f>o||r>h||u>g)){if(p=n.point){var p,v=t-n.x,d=e-n.y,m=v*v+d*d;if(c>m){var y=Math.sqrt(c=m);r=t-y,u=e-y,i=t+y,o=e+y,a=p}}for(var M=n.nodes,x=0.5*(s+h),b=0.5*(f+g),_=t>=x,w=e>=b,S=w<<1|_,k=S+4;k>S;++S){if(n=M[3&S]){switch(3&S){case 0:l(n,s,f,x,b);break;case 1:l(n,x,f,h,b);break;case 2:l(n,s,b,x,g);break;case 3:l(n,x,b,h,g)}}}}}(n,r,u,i,o),a}function gu(n,t){n=ta.rgb(n),t=ta.rgb(t);var e=n.r,r=n.g,u=n.b,i=t.r-e,o=t.g-r,a=t.b-u;return function(n){return"#"+xt(Math.round(e+i*n))+xt(Math.round(r+o*n))+xt(Math.round(u+a*n))}}function pu(n,t){var e,r={},u={};for(e in n){e in t?r[e]=mu(n[e],t[e]):u[e]=n[e]}for(e in t){e in n||(u[e]=t[e])}return function(n){for(e in r){u[e]=r[e](n)}return u}}function vu(n,t){return n=+n,t=+t,function(e){return n*(1-e)+t*e}}function du(n,t){var e,r,u,i=il.lastIndex=ol.lastIndex=0,o=-1,a=[],c=[];for(n+="",t+="";(e=il.exec(n))&&(r=ol.exec(t));){(u=r.index)>i&&(u=t.slice(i,u),a[o]?a[o]+=u:a[++o]=u),(e=e[0])===(r=r[0])?a[o]?a[o]+=r:a[++o]=r:(a[++o]=null,c.push({i:o,x:vu(e,r)})),i=ol.lastIndex}return i<t.length&&(u=t.slice(i),a[o]?a[o]+=u:a[++o]=u),a.length<2?c[0]?(t=c[0].x,function(n){return t(n)+""}):function(){return t}:(t=c.length,function(n){for(var e,r=0;t>r;++r){a[(e=c[r]).i]=e.x(n)}return a.join("")})}function mu(n,t){for(var e,r=ta.interpolators.length;--r>=0&&!(e=ta.interpolators[r](n,t));){}return e}function yu(n,t){var e,r=[],u=[],i=n.length,o=t.length,a=Math.min(n.length,t.length);for(e=0;a>e;++e){r.push(mu(n[e],t[e]))}for(;i>e;++e){u[e]=n[e]}for(;o>e;++e){u[e]=t[e]}return function(n){for(e=0;a>e;++e){u[e]=r[e](n)}return u}}function Mu(n){return function(t){return 0>=t?0:t>=1?1:n(t)}}function xu(n){return function(t){return 1-n(1-t)}}function bu(n){return function(t){return 0.5*(0.5>t?n(2*t):2-n(2-2*t))}}function _u(n){return n*n}function wu(n){return n*n*n}function Su(n){if(0>=n){return 0}if(n>=1){return 1}var t=n*n,e=t*n;return 4*(0.5>n?e:3*(n-t)+e-0.75)}function ku(n){return function(t){return Math.pow(t,n)}}function Eu(n){return 1-Math.cos(n*Ra)}function Au(n){return Math.pow(2,10*(n-1))}function Nu(n){return 1-Math.sqrt(1-n*n)}function Cu(n,t){var e;return arguments.length<2&&(t=0.45),arguments.length?e=t/La*Math.asin(1/n):(n=1,e=t/4),function(r){return 1+n*Math.pow(2,-10*r)*Math.sin((r-e)*La/t)}}function zu(n){return n||(n=1.70158),function(t){return t*t*((n+1)*t-n)}}function qu(n){return 1/2.75>n?7.5625*n*n:2/2.75>n?7.5625*(n-=1.5/2.75)*n+0.75:2.5/2.75>n?7.5625*(n-=2.25/2.75)*n+0.9375:7.5625*(n-=2.625/2.75)*n+0.984375}function Lu(n,t){n=ta.hcl(n),t=ta.hcl(t);var e=n.h,r=n.c,u=n.l,i=t.h-e,o=t.c-r,a=t.l-u;return isNaN(o)&&(o=0,r=isNaN(r)?t.c:r),isNaN(i)?(i=0,e=isNaN(e)?t.h:e):i>180?i-=360:-180>i&&(i+=360),function(n){return st(e+i*n,r+o*n,u+a*n)+""}}function Tu(n,t){n=ta.hsl(n),t=ta.hsl(t);var e=n.h,r=n.s,u=n.l,i=t.h-e,o=t.s-r,a=t.l-u;return isNaN(o)&&(o=0,r=isNaN(r)?t.s:r),isNaN(i)?(i=0,e=isNaN(e)?t.h:e):i>180?i-=360:-180>i&&(i+=360),function(n){return ct(e+i*n,r+o*n,u+a*n)+""}}function Ru(n,t){n=ta.lab(n),t=ta.lab(t);var e=n.l,r=n.a,u=n.b,i=t.l-e,o=t.a-r,a=t.b-u;return function(n){return ht(e+i*n,r+o*n,u+a*n)+""}}function Du(n,t){return t-=n,function(e){return Math.round(n+t*e)}}function Pu(n){var t=[n.a,n.b],e=[n.c,n.d],r=ju(t),u=Uu(t,e),i=ju(Fu(e,t,-u))||0;t[0]*e[1]<e[0]*t[1]&&(t[0]*=-1,t[1]*=-1,r*=-1,u*=-1),this.rotate=(r?Math.atan2(t[1],t[0]):Math.atan2(-e[0],e[1]))*Pa,this.translate=[n.e,n.f],this.scale=[r,i],this.skew=i?Math.atan2(u,i)*Pa:0}function Uu(n,t){return n[0]*t[0]+n[1]*t[1]}function ju(n){var t=Math.sqrt(Uu(n,n));return t&&(n[0]/=t,n[1]/=t),t}function Fu(n,t,e){return n[0]+=e*t[0],n[1]+=e*t[1],n}function Hu(n,t){var e,r=[],u=[],i=ta.transform(n),o=ta.transform(t),a=i.translate,c=o.translate,l=i.rotate,s=o.rotate,f=i.skew,h=o.skew,g=i.scale,p=o.scale;return a[0]!=c[0]||a[1]!=c[1]?(r.push("translate(",null,",",null,")"),u.push({i:1,x:vu(a[0],c[0])},{i:3,x:vu(a[1],c[1])})):r.push(c[0]||c[1]?"translate("+c+")":""),l!=s?(l-s>180?s+=360:s-l>180&&(l+=360),u.push({i:r.push(r.pop()+"rotate(",null,")")-2,x:vu(l,s)})):s&&r.push(r.pop()+"rotate("+s+")"),f!=h?u.push({i:r.push(r.pop()+"skewX(",null,")")-2,x:vu(f,h)}):h&&r.push(r.pop()+"skewX("+h+")"),g[0]!=p[0]||g[1]!=p[1]?(e=r.push(r.pop()+"scale(",null,",",null,")"),u.push({i:e-4,x:vu(g[0],p[0])},{i:e-2,x:vu(g[1],p[1])})):(1!=p[0]||1!=p[1])&&r.push(r.pop()+"scale("+p+")"),e=u.length,function(n){for(var t,i=-1;++i<e;){r[(t=u[i]).i]=t.x(n)}return r.join("")}}function Ou(n,t){return t=(t-=n=+n)||1/t,function(e){return(e-n)/t}}function Iu(n,t){return t=(t-=n=+n)||1/t,function(e){return Math.max(0,Math.min(1,(e-n)/t))}}function Yu(n){for(var t=n.source,e=n.target,r=Vu(t,e),u=[t];t!==r;){t=t.parent,u.push(t)}for(var i=u.length;e!==r;){u.splice(i,0,e),e=e.parent}return u}function Zu(n){for(var t=[],e=n.parent;null!=e;){t.push(n),n=e,e=e.parent}return t.push(n),t}function Vu(n,t){if(n===t){return n}for(var e=Zu(n),r=Zu(t),u=e.pop(),i=r.pop(),o=null;u===i;){o=u,u=e.pop(),i=r.pop()}return o}function Xu(n){n.fixed|=2}function $u(n){n.fixed&=-7}function Bu(n){n.fixed|=4,n.px=n.x,n.py=n.y}function Wu(n){n.fixed&=-5}function Ju(n,t,e){var r=0,u=0;if(n.charge=0,!n.leaf){for(var i,o=n.nodes,a=o.length,c=-1;++c<a;){i=o[c],null!=i&&(Ju(i,t,e),n.charge+=i.charge,r+=i.charge*i.cx,u+=i.charge*i.cy)}}if(n.point){n.leaf||(n.point.x+=Math.random()-0.5,n.point.y+=Math.random()-0.5);var l=t*e[n.point.index];n.charge+=n.pointCharge=l,r+=l*n.point.x,u+=l*n.point.y}n.cx=r/n.charge,n.cy=u/n.charge}function Gu(n,t){return ta.rebind(n,t,"sort","children","value"),n.nodes=n,n.links=ri,n}function Ku(n,t){for(var e=[n];null!=(n=e.pop());){if(t(n),(u=n.children)&&(r=u.length)){for(var r,u;--r>=0;){e.push(u[r])}}}}function Qu(n,t){for(var e=[n],r=[];null!=(n=e.pop());){if(r.push(n),(i=n.children)&&(u=i.length)){for(var u,i,o=-1;++o<u;){e.push(i[o])}}}for(;null!=(n=r.pop());){t(n)}}function ni(n){return n.children}function ti(n){return n.value}function ei(n,t){return t.value-n.value}function ri(n){return ta.merge(n.map(function(n){return(n.children||[]).map(function(t){return{source:n,target:t}})}))}function ui(n){return n.x}function ii(n){return n.y}function oi(n,t,e){n.y0=t,n.y=e}function ai(n){return ta.range(n.length)}function ci(n){for(var t=-1,e=n[0].length,r=[];++t<e;){r[t]=0}return r}function li(n){for(var t,e=1,r=0,u=n[0][1],i=n.length;i>e;++e){(t=n[e][1])>u&&(r=e,u=t)}return r}function si(n){return n.reduce(fi,0)}function fi(n,t){return n+t[1]}function hi(n,t){return gi(n,Math.ceil(Math.log(t.length)/Math.LN2+1))}function gi(n,t){for(var e=-1,r=+n[0],u=(n[1]-r)/t,i=[];++e<=t;){i[e]=u*e+r}return i}function pi(n){return[ta.min(n),ta.max(n)]}function vi(n,t){return n.value-t.value}function di(n,t){var e=n._pack_next;n._pack_next=t,t._pack_prev=n,t._pack_next=e,e._pack_prev=t}function mi(n,t){n._pack_next=t,t._pack_prev=n}function yi(n,t){var e=t.x-n.x,r=t.y-n.y,u=n.r+t.r;return 0.999*u*u>e*e+r*r}function Mi(n){function t(n){s=Math.min(n.x-n.r,s),f=Math.max(n.x+n.r,f),h=Math.min(n.y-n.r,h),g=Math.max(n.y+n.r,g)}if((e=n.children)&&(l=e.length)){var e,r,u,i,o,a,c,l,s=1/0,f=-1/0,h=1/0,g=-1/0;if(e.forEach(xi),r=e[0],r.x=-r.r,r.y=0,t(r),l>1&&(u=e[1],u.x=u.r,u.y=0,t(u),l>2)){for(i=e[2],wi(r,u,i),t(i),di(r,i),r._pack_prev=i,di(i,u),u=r._pack_next,o=3;l>o;o++){wi(r,u,i=e[o]);var p=0,v=1,d=1;for(a=u._pack_next;a!==u;a=a._pack_next,v++){if(yi(a,i)){p=1;break}}if(1==p){for(c=r._pack_prev;c!==a._pack_prev&&!yi(c,i);c=c._pack_prev,d++){}}p?(d>v||v==d&&u.r<r.r?mi(r,u=a):mi(r=c,u),o--):(di(r,i),u=i,t(i))}}var m=(s+f)/2,y=(h+g)/2,M=0;for(o=0;l>o;o++){i=e[o],i.x-=m,i.y-=y,M=Math.max(M,i.r+Math.sqrt(i.x*i.x+i.y*i.y))}n.r=M,e.forEach(bi)}}function xi(n){n._pack_next=n._pack_prev=n}function bi(n){delete n._pack_next,delete n._pack_prev}function _i(n,t,e,r){var u=n.children;if(n.x=t+=r*n.x,n.y=e+=r*n.y,n.r*=r,u){for(var i=-1,o=u.length;++i<o;){_i(u[i],t,e,r)}}}function wi(n,t,e){var r=n.r+e.r,u=t.x-n.x,i=t.y-n.y;if(r&&(u||i)){var o=t.r+e.r,a=u*u+i*i;o*=o,r*=r;var c=0.5+(r-o)/(2*a),l=Math.sqrt(Math.max(0,2*o*(r+a)-(r-=a)*r-o*o))/(2*a);e.x=n.x+c*u+l*i,e.y=n.y+c*i-l*u}else{e.x=n.x+r,e.y=n.y}}function Si(n,t){return n.parent==t.parent?1:2}function ki(n){var t=n.children;return t.length?t[0]:n.t}function Ei(n){var t,e=n.children;return(t=e.length)?e[t-1]:n.t}function Ai(n,t,e){var r=e/(t.i-n.i);t.c-=r,t.s+=e,n.c+=r,t.z+=e,t.m+=e}function Ni(n){for(var t,e=0,r=0,u=n.children,i=u.length;--i>=0;){t=u[i],t.z+=e,t.m+=e,e+=t.s+(r+=t.c)}}function Ci(n,t,e){return n.a.parent===t.parent?n.a:e}function zi(n){return 1+ta.max(n,function(n){return n.y})}function qi(n){return n.reduce(function(n,t){return n+t.x},0)/n.length}function Li(n){var t=n.children;return t&&t.length?Li(t[0]):n}function Ti(n){var t,e=n.children;return e&&(t=e.length)?Ti(e[t-1]):n}function Ri(n){return{x:n.x,y:n.y,dx:n.dx,dy:n.dy}}function Di(n,t){var e=n.x+t[3],r=n.y+t[0],u=n.dx-t[1]-t[3],i=n.dy-t[0]-t[2];return 0>u&&(e+=u/2,u=0),0>i&&(r+=i/2,i=0),{x:e,y:r,dx:u,dy:i}}function Pi(n){var t=n[0],e=n[n.length-1];return e>t?[t,e]:[e,t]}function Ui(n){return n.rangeExtent?n.rangeExtent():Pi(n.range())}function ji(n,t,e,r){var u=e(n[0],n[1]),i=r(t[0],t[1]);return function(n){return i(u(n))}}function Fi(n,t){var e,r=0,u=n.length-1,i=n[r],o=n[u];return i>o&&(e=r,r=u,u=e,e=i,i=o,o=e),n[r]=t.floor(i),n[u]=t.ceil(o),n}function Hi(n){return n?{floor:function(t){return Math.floor(t/n)*n},ceil:function(t){return Math.ceil(t/n)*n}}:ml}function Oi(n,t,e,r){var u=[],i=[],o=0,a=Math.min(n.length,t.length)-1;for(n[a]<n[0]&&(n=n.slice().reverse(),t=t.slice().reverse());++o<=a;){u.push(e(n[o-1],n[o])),i.push(r(t[o-1],t[o]))}return function(t){var e=ta.bisect(n,t,1,a)-1;return i[e](u[e](t))}}function Ii(n,t,e,r){function u(){var u=Math.min(n.length,t.length)>2?Oi:ji,c=r?Iu:Ou;return o=u(n,t,c,e),a=u(t,n,c,mu),i}function i(n){return o(n)}var o,a;return i.invert=function(n){return a(n)},i.domain=function(t){return arguments.length?(n=t.map(Number),u()):n},i.range=function(n){return arguments.length?(t=n,u()):t},i.rangeRound=function(n){return i.range(n).interpolate(Du)},i.clamp=function(n){return arguments.length?(r=n,u()):r},i.interpolate=function(n){return arguments.length?(e=n,u()):e},i.ticks=function(t){return Xi(n,t)},i.tickFormat=function(t,e){return $i(n,t,e)},i.nice=function(t){return Zi(n,t),u()},i.copy=function(){return Ii(n,t,e,r)},u()}function Yi(n,t){return ta.rebind(n,t,"range","rangeRound","interpolate","clamp")}function Zi(n,t){return Fi(n,Hi(Vi(n,t)[2]))}function Vi(n,t){null==t&&(t=10);var e=Pi(n),r=e[1]-e[0],u=Math.pow(10,Math.floor(Math.log(r/t)/Math.LN10)),i=t/r*u;return 0.15>=i?u*=10:0.35>=i?u*=5:0.75>=i&&(u*=2),e[0]=Math.ceil(e[0]/u)*u,e[1]=Math.floor(e[1]/u)*u+0.5*u,e[2]=u,e}function Xi(n,t){return ta.range.apply(ta,Vi(n,t))}function $i(n,t,e){var r=Vi(n,t);if(e){var u=ic.exec(e);if(u.shift(),"s"===u[8]){var i=ta.formatPrefix(Math.max(ga(r[0]),ga(r[1])));return u[7]||(u[7]="."+Bi(i.scale(r[2]))),u[8]="f",e=ta.format(u.join("")),function(n){return e(i.scale(n))+i.symbol}}u[7]||(u[7]="."+Wi(u[8],r)),e=u.join("")}else{e=",."+Bi(r[2])+"f"}return ta.format(e)}function Bi(n){return -Math.floor(Math.log(n)/Math.LN10+0.01)}function Wi(n,t){var e=Bi(t[2]);return n in yl?Math.abs(e-Bi(Math.max(ga(t[0]),ga(t[1]))))+ +("e"!==n):e-2*("%"===n)}function Ji(n,t,e,r){function u(n){return(e?Math.log(0>n?0:n):-Math.log(n>0?0:-n))/Math.log(t)}function i(n){return e?Math.pow(t,n):-Math.pow(t,-n)}function o(t){return n(u(t))}return o.invert=function(t){return i(n.invert(t))},o.domain=function(t){return arguments.length?(e=t[0]>=0,n.domain((r=t.map(Number)).map(u)),o):r},o.base=function(e){return arguments.length?(t=+e,n.domain(r.map(u)),o):t},o.nice=function(){var t=Fi(r.map(u),e?Math:xl);return n.domain(t),r=t.map(i),o},o.ticks=function(){var n=Pi(r),o=[],a=n[0],c=n[1],l=Math.floor(u(a)),s=Math.ceil(u(c)),f=t%1?2:t;if(isFinite(s-l)){if(e){for(;s>l;l++){for(var h=1;f>h;h++){o.push(i(l)*h)}}o.push(i(l))}else{for(o.push(i(l));l++<s;){for(var h=f-1;h>0;h--){o.push(i(l)*h)}}}for(l=0;o[l]<a;l++){}for(s=o.length;o[s-1]>c;s--){}o=o.slice(l,s)}return o},o.tickFormat=function(n,t){if(!arguments.length){return Ml}arguments.length<2?t=Ml:"function"!=typeof t&&(t=ta.format(t));var r,a=Math.max(0.1,n/o.ticks().length),c=e?(r=1e-12,Math.ceil):(r=-1e-12,Math.floor);return function(n){return n/i(c(u(n)+r))<=a?t(n):""}},o.copy=function(){return Ji(n.copy(),t,e,r)},Yi(o,n)}function Gi(n,t,e){function r(t){return n(u(t))}var u=Ki(t),i=Ki(1/t);return r.invert=function(t){return i(n.invert(t))},r.domain=function(t){return arguments.length?(n.domain((e=t.map(Number)).map(u)),r):e},r.ticks=function(n){return Xi(e,n)},r.tickFormat=function(n,t){return $i(e,n,t)},r.nice=function(n){return r.domain(Zi(e,n))},r.exponent=function(o){return arguments.length?(u=Ki(t=o),i=Ki(1/t),n.domain(e.map(u)),r):t},r.copy=function(){return Gi(n.copy(),t,e)},Yi(r,n)}function Ki(n){return function(t){return 0>t?-Math.pow(-t,n):Math.pow(t,n)}}function Qi(n,t){function e(e){return i[((u.get(e)||("range"===t.t?u.set(e,n.push(e)):0/0))-1)%i.length]}function r(t,e){return ta.range(n.length).map(function(n){return t+e*n})}var u,i,o;return e.domain=function(r){if(!arguments.length){return n}n=[],u=new l;for(var i,o=-1,a=r.length;++o<a;){u.has(i=r[o])||u.set(i,n.push(i))}return e[t.t].apply(e,t.a)},e.range=function(n){return arguments.length?(i=n,o=0,t={t:"range",a:arguments},e):i},e.rangePoints=function(u,a){arguments.length<2&&(a=0);var c=u[0],l=u[1],s=n.length<2?(c=(c+l)/2,0):(l-c)/(n.length-1+a);return i=r(c+s*a/2,s),o=0,t={t:"rangePoints",a:arguments},e},e.rangeRoundPoints=function(u,a){arguments.length<2&&(a=0);var c=u[0],l=u[1],s=n.length<2?(c=l=Math.round((c+l)/2),0):(l-c)/(n.length-1+a)|0;return i=r(c+Math.round(s*a/2+(l-c-(n.length-1+a)*s)/2),s),o=0,t={t:"rangeRoundPoints",a:arguments},e},e.rangeBands=function(u,a,c){arguments.length<2&&(a=0),arguments.length<3&&(c=a);var l=u[1]<u[0],s=u[l-0],f=u[1-l],h=(f-s)/(n.length-a+2*c);return i=r(s+h*c,h),l&&i.reverse(),o=h*(1-a),t={t:"rangeBands",a:arguments},e},e.rangeRoundBands=function(u,a,c){arguments.length<2&&(a=0),arguments.length<3&&(c=a);var l=u[1]<u[0],s=u[l-0],f=u[1-l],h=Math.floor((f-s)/(n.length-a+2*c));return i=r(s+Math.round((f-s-(n.length-a)*h)/2),h),l&&i.reverse(),o=Math.round(h*(1-a)),t={t:"rangeRoundBands",a:arguments},e},e.rangeBand=function(){return o},e.rangeExtent=function(){return Pi(t.a[0])},e.copy=function(){return Qi(n,t)},e.domain(n)}function no(n,t){function i(){var e=0,r=t.length;for(a=[];++e<r;){a[e-1]=ta.quantile(n,e/r)}return o}function o(n){return isNaN(n=+n)?void 0:t[ta.bisect(a,n)]}var a;return o.domain=function(t){return arguments.length?(n=t.map(r).filter(u).sort(e),i()):n},o.range=function(n){return arguments.length?(t=n,i()):t},o.quantiles=function(){return a},o.invertExtent=function(e){return e=t.indexOf(e),0>e?[0/0,0/0]:[e>0?a[e-1]:n[0],e<a.length?a[e]:n[n.length-1]]},o.copy=function(){return no(n,t)},i()}function to(n,t,e){function r(t){return e[Math.max(0,Math.min(o,Math.floor(i*(t-n))))]}function u(){return i=e.length/(t-n),o=e.length-1,r}var i,o;return r.domain=function(e){return arguments.length?(n=+e[0],t=+e[e.length-1],u()):[n,t]},r.range=function(n){return arguments.length?(e=n,u()):e},r.invertExtent=function(t){return t=e.indexOf(t),t=0>t?0/0:t/i+n,[t,t+1/i]},r.copy=function(){return to(n,t,e)},u()}function eo(n,t){function e(e){return e>=e?t[ta.bisect(n,e)]:void 0}return e.domain=function(t){return arguments.length?(n=t,e):n},e.range=function(n){return arguments.length?(t=n,e):t},e.invertExtent=function(e){return e=t.indexOf(e),[n[e-1],n[e]]},e.copy=function(){return eo(n,t)},e}function ro(n){function t(n){return +n}return t.invert=t,t.domain=t.range=function(e){return arguments.length?(n=e.map(t),t):n},t.ticks=function(t){return Xi(n,t)},t.tickFormat=function(t,e){return $i(n,t,e)},t.copy=function(){return ro(n)},t}function uo(){return 0}function io(n){return n.innerRadius}function oo(n){return n.outerRadius}function ao(n){return n.startAngle}function co(n){return n.endAngle}function lo(n){return n&&n.padAngle}function so(n,t,e,r){return(n-e)*t-(t-r)*n>0?0:1}function fo(n,t,e,r,u){var i=n[0]-t[0],o=n[1]-t[1],a=(u?r:-r)/Math.sqrt(i*i+o*o),c=a*o,l=-a*i,s=n[0]+c,f=n[1]+l,h=t[0]+c,g=t[1]+l,p=(s+h)/2,v=(f+g)/2,d=h-s,m=g-f,y=d*d+m*m,M=e-r,x=s*g-h*f,b=(0>m?-1:1)*Math.sqrt(M*M*y-x*x),_=(x*m-d*b)/y,w=(-x*d-m*b)/y,S=(x*m+d*b)/y,k=(-x*d+m*b)/y,E=_-p,A=w-v,N=S-p,C=k-v;return E*E+A*A>N*N+C*C&&(_=S,w=k),[[_-c,w-l],[_*e/M,w*e/M]]}function ho(n){function t(t){function o(){l.push("M",i(n(s),a))}for(var c,l=[],s=[],f=-1,h=t.length,g=Et(e),p=Et(r);++f<h;){u.call(this,c=t[f],f)?s.push([+g.call(this,c,f),+p.call(this,c,f)]):s.length&&(o(),s=[])}return s.length&&o(),l.length?l.join(""):null}var e=Ar,r=Nr,u=Ne,i=go,o=i.key,a=0.7;return t.x=function(n){return arguments.length?(e=n,t):e},t.y=function(n){return arguments.length?(r=n,t):r},t.defined=function(n){return arguments.length?(u=n,t):u},t.interpolate=function(n){return arguments.length?(o="function"==typeof n?i=n:(i=El.get(n)||go).key,t):o},t.tension=function(n){return arguments.length?(a=n,t):a},t}function go(n){return n.join("L")}function po(n){return go(n)+"Z"}function vo(n){for(var t=0,e=n.length,r=n[0],u=[r[0],",",r[1]];++t<e;){u.push("H",(r[0]+(r=n[t])[0])/2,"V",r[1])}return e>1&&u.push("H",r[0]),u.join("")}function mo(n){for(var t=0,e=n.length,r=n[0],u=[r[0],",",r[1]];++t<e;){u.push("V",(r=n[t])[1],"H",r[0])}return u.join("")}function yo(n){for(var t=0,e=n.length,r=n[0],u=[r[0],",",r[1]];++t<e;){u.push("H",(r=n[t])[0],"V",r[1])}return u.join("")}function Mo(n,t){return n.length<4?go(n):n[1]+_o(n.slice(1,-1),wo(n,t))}function xo(n,t){return n.length<3?go(n):n[0]+_o((n.push(n[0]),n),wo([n[n.length-2]].concat(n,[n[1]]),t))}function bo(n,t){return n.length<3?go(n):n[0]+_o(n,wo(n,t))}function _o(n,t){if(t.length<1||n.length!=t.length&&n.length!=t.length+2){return go(n)}var e=n.length!=t.length,r="",u=n[0],i=n[1],o=t[0],a=o,c=1;if(e&&(r+="Q"+(i[0]-2*o[0]/3)+","+(i[1]-2*o[1]/3)+","+i[0]+","+i[1],u=n[1],c=2),t.length>1){a=t[1],i=n[c],c++,r+="C"+(u[0]+o[0])+","+(u[1]+o[1])+","+(i[0]-a[0])+","+(i[1]-a[1])+","+i[0]+","+i[1];for(var l=2;l<t.length;l++,c++){i=n[c],a=t[l],r+="S"+(i[0]-a[0])+","+(i[1]-a[1])+","+i[0]+","+i[1]}}if(e){var s=n[c];r+="Q"+(i[0]+2*a[0]/3)+","+(i[1]+2*a[1]/3)+","+s[0]+","+s[1]}return r}function wo(n,t){for(var e,r=[],u=(1-t)/2,i=n[0],o=n[1],a=1,c=n.length;++a<c;){e=i,i=o,o=n[a],r.push([u*(o[0]-e[0]),u*(o[1]-e[1])])}return r}function So(n){if(n.length<3){return go(n)}var t=1,e=n.length,r=n[0],u=r[0],i=r[1],o=[u,u,u,(r=n[1])[0]],a=[i,i,i,r[1]],c=[u,",",i,"L",No(Cl,o),",",No(Cl,a)];for(n.push(n[e-1]);++t<=e;){r=n[t],o.shift(),o.push(r[0]),a.shift(),a.push(r[1]),Co(c,o,a)}return n.pop(),c.push("L",r),c.join("")}function ko(n){if(n.length<4){return go(n)}for(var t,e=[],r=-1,u=n.length,i=[0],o=[0];++r<3;){t=n[r],i.push(t[0]),o.push(t[1])}for(e.push(No(Cl,i)+","+No(Cl,o)),--r;++r<u;){t=n[r],i.shift(),i.push(t[0]),o.shift(),o.push(t[1]),Co(e,i,o)}return e.join("")}function Eo(n){for(var t,e,r=-1,u=n.length,i=u+4,o=[],a=[];++r<4;){e=n[r%u],o.push(e[0]),a.push(e[1])}for(t=[No(Cl,o),",",No(Cl,a)],--r;++r<i;){e=n[r%u],o.shift(),o.push(e[0]),a.shift(),a.push(e[1]),Co(t,o,a)}return t.join("")}function Ao(n,t){var e=n.length-1;if(e){for(var r,u,i=n[0][0],o=n[0][1],a=n[e][0]-i,c=n[e][1]-o,l=-1;++l<=e;){r=n[l],u=l/e,r[0]=t*r[0]+(1-t)*(i+u*a),r[1]=t*r[1]+(1-t)*(o+u*c)}}return So(n)}function No(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]+n[3]*t[3]}function Co(n,t,e){n.push("C",No(Al,t),",",No(Al,e),",",No(Nl,t),",",No(Nl,e),",",No(Cl,t),",",No(Cl,e))}function zo(n,t){return(t[1]-n[1])/(t[0]-n[0])}function qo(n){for(var t=0,e=n.length-1,r=[],u=n[0],i=n[1],o=r[0]=zo(u,i);++t<e;){r[t]=(o+(o=zo(u=i,i=n[t+1])))/2}return r[t]=o,r}function Lo(n){for(var t,e,r,u,i=[],o=qo(n),a=-1,c=n.length-1;++a<c;){t=zo(n[a],n[a+1]),ga(t)<Ca?o[a]=o[a+1]=0:(e=o[a]/t,r=o[a+1]/t,u=e*e+r*r,u>9&&(u=3*t/Math.sqrt(u),o[a]=u*e,o[a+1]=u*r))}for(a=-1;++a<=c;){u=(n[Math.min(c,a+1)][0]-n[Math.max(0,a-1)][0])/(6*(1+o[a]*o[a])),i.push([u||0,o[a]*u||0])}return i}function To(n){return n.length<3?go(n):n[0]+_o(n,Lo(n))}function Ro(n){for(var t,e,r,u=-1,i=n.length;++u<i;){t=n[u],e=t[0],r=t[1]-Ra,t[0]=e*Math.cos(r),t[1]=e*Math.sin(r)}return n}function Do(n){function t(t){function c(){v.push("M",a(n(m),f),s,l(n(d.reverse()),f),"Z")}for(var h,g,p,v=[],d=[],m=[],y=-1,M=t.length,x=Et(e),b=Et(u),_=e===r?function(){return g}:Et(r),w=u===i?function(){return p}:Et(i);++y<M;){o.call(this,h=t[y],y)?(d.push([g=+x.call(this,h,y),p=+b.call(this,h,y)]),m.push([+_.call(this,h,y),+w.call(this,h,y)])):d.length&&(c(),d=[],m=[])}return d.length&&c(),v.length?v.join(""):null}var e=Ar,r=Ar,u=0,i=Nr,o=Ne,a=go,c=a.key,l=a,s="L",f=0.7;return t.x=function(n){return arguments.length?(e=r=n,t):r},t.x0=function(n){return arguments.length?(e=n,t):e},t.x1=function(n){return arguments.length?(r=n,t):r},t.y=function(n){return arguments.length?(u=i=n,t):i},t.y0=function(n){return arguments.length?(u=n,t):u},t.y1=function(n){return arguments.length?(i=n,t):i},t.defined=function(n){return arguments.length?(o=n,t):o},t.interpolate=function(n){return arguments.length?(c="function"==typeof n?a=n:(a=El.get(n)||go).key,l=a.reverse||a,s=a.closed?"M":"L",t):c},t.tension=function(n){return arguments.length?(f=n,t):f},t}function Po(n){return n.radius}function Uo(n){return[n.x,n.y]}function jo(n){return function(){var t=n.apply(this,arguments),e=t[0],r=t[1]-Ra;return[e*Math.cos(r),e*Math.sin(r)]}}function Fo(){return 64}function Ho(){return"circle"}function Oo(n){var t=Math.sqrt(n/qa);return"M0,"+t+"A"+t+","+t+" 0 1,1 0,"+-t+"A"+t+","+t+" 0 1,1 0,"+t+"Z"}function Io(n){return function(){var t,e;(t=this[n])&&(e=t[t.active])&&(--t.count?delete t[t.active]:delete this[n],t.active+=0.5,e.event&&e.event.interrupt.call(this,this.__data__,e.index))}}function Yo(n,t,e){return ya(n,Pl),n.namespace=t,n.id=e,n}function Zo(n,t,e,r){var u=n.id,i=n.namespace;return Y(n,"function"==typeof e?function(n,o,a){n[i][u].tween.set(t,r(e.call(n,n.__data__,o,a)))}:(e=r(e),function(n){n[i][u].tween.set(t,e)}))}function Vo(n){return null==n&&(n=""),function(){this.textContent=n}}function Xo(n){return null==n?"__transition__":"__transition_"+n+"__"}function $o(n,t,e,r,u){var i=n[e]||(n[e]={active:0,count:0}),o=i[r];if(!o){var a=u.time;o=i[r]={tween:new l,time:a,delay:u.delay,duration:u.duration,ease:u.ease,index:t},u=null,++i.count,ta.timer(function(u){function c(e){if(i.active>r){return s()}var u=i[i.active];u&&(--i.count,delete i[i.active],u.event&&u.event.interrupt.call(n,n.__data__,u.index)),i.active=r,o.event&&o.event.start.call(n,n.__data__,t),o.tween.forEach(function(e,r){(r=r.call(n,n.__data__,t))&&v.push(r)}),h=o.ease,f=o.duration,ta.timer(function(){return p.c=l(e||1)?Ne:l,1},0,a)}function l(e){if(i.active!==r){return 1}for(var u=e/f,a=h(u),c=v.length;c>0;){v[--c].call(n,a)}return u>=1?(o.event&&o.event.end.call(n,n.__data__,t),s()):void 0}function s(){return --i.count?delete i[r]:delete n[e],1}var f,h,g=o.delay,p=ec,v=[];return p.t=g+a,u>=g?c(u-g):void (p.c=c)},0,a)}}function Bo(n,t,e){n.attr("transform",function(n){var r=t(n);return"translate("+(isFinite(r)?r:e(n))+",0)"})}function Wo(n,t,e){n.attr("transform",function(n){var r=t(n);return"translate(0,"+(isFinite(r)?r:e(n))+")"})}function Jo(n){return n.toISOString()}function Go(n,t,e){function r(t){return n(t)}function u(n,e){var r=n[1]-n[0],u=r/e,i=ta.bisect(Vl,u);return i==Vl.length?[t.year,Vi(n.map(function(n){return n/31536000000}),e)[2]]:i?t[u/Vl[i-1]<Vl[i]/u?i-1:i]:[Bl,Vi(n,e)[2]]}return r.invert=function(t){return Ko(n.invert(t))},r.domain=function(t){return arguments.length?(n.domain(t),r):n.domain().map(Ko)},r.nice=function(n,t){function e(e){return !isNaN(e)&&!n.range(e,Ko(+e+1),t).length}var i=r.domain(),o=Pi(i),a=null==n?u(o,10):"number"==typeof n&&u(o,n);return a&&(n=a[0],t=a[1]),r.domain(Fi(i,t>1?{floor:function(t){for(;e(t=n.floor(t));){t=Ko(t-1)}return t},ceil:function(t){for(;e(t=n.ceil(t));){t=Ko(+t+1)}return t}}:n))},r.ticks=function(n,t){var e=Pi(r.domain()),i=null==n?u(e,10):"number"==typeof n?u(e,n):!n.range&&[{range:n},t];return i&&(n=i[0],t=i[1]),n.range(e[0],Ko(+e[1]+1),1>t?1:t)},r.tickFormat=function(){return e},r.copy=function(){return Go(n.copy(),t,e)},Yi(r,n)}function Ko(n){return new Date(n)}function Qo(n){return JSON.parse(n.responseText)}function na(n){var t=ua.createRange();return t.selectNode(ua.body),t.createContextualFragment(n.responseText)}var ta={version:"3.5.5"},ea=[].slice,ra=function(n){return ea.call(n)},ua=this.document;if(ua){try{ra(ua.documentElement.childNodes)[0].nodeType}catch(ia){ra=function(n){for(var t=n.length,e=new Array(t);t--;){e[t]=n[t]}return e}}}if(Date.now||(Date.now=function(){return +new Date}),ua){try{ua.createElement("DIV").style.setProperty("opacity",0,"")}catch(oa){var aa=this.Element.prototype,ca=aa.setAttribute,la=aa.setAttributeNS,sa=this.CSSStyleDeclaration.prototype,fa=sa.setProperty;aa.setAttribute=function(n,t){ca.call(this,n,t+"")},aa.setAttributeNS=function(n,t,e){la.call(this,n,t,e+"")},sa.setProperty=function(n,t,e){fa.call(this,n,t+"",e)}}}ta.ascending=e,ta.descending=function(n,t){return n>t?-1:t>n?1:t>=n?0:0/0},ta.min=function(n,t){var e,r,u=-1,i=n.length;if(1===arguments.length){for(;++u<i;){if(null!=(r=n[u])&&r>=r){e=r;break}}for(;++u<i;){null!=(r=n[u])&&e>r&&(e=r)}}else{for(;++u<i;){if(null!=(r=t.call(n,n[u],u))&&r>=r){e=r;break}}for(;++u<i;){null!=(r=t.call(n,n[u],u))&&e>r&&(e=r)}}return e},ta.max=function(n,t){var e,r,u=-1,i=n.length;if(1===arguments.length){for(;++u<i;){if(null!=(r=n[u])&&r>=r){e=r;break}}for(;++u<i;){null!=(r=n[u])&&r>e&&(e=r)}}else{for(;++u<i;){if(null!=(r=t.call(n,n[u],u))&&r>=r){e=r;break}}for(;++u<i;){null!=(r=t.call(n,n[u],u))&&r>e&&(e=r)}}return e},ta.extent=function(n,t){var e,r,u,i=-1,o=n.length;if(1===arguments.length){for(;++i<o;){if(null!=(r=n[i])&&r>=r){e=u=r;break}}for(;++i<o;){null!=(r=n[i])&&(e>r&&(e=r),r>u&&(u=r))}}else{for(;++i<o;){if(null!=(r=t.call(n,n[i],i))&&r>=r){e=u=r;break}}for(;++i<o;){null!=(r=t.call(n,n[i],i))&&(e>r&&(e=r),r>u&&(u=r))}}return[e,u]},ta.sum=function(n,t){var e,r=0,i=n.length,o=-1;if(1===arguments.length){for(;++o<i;){u(e=+n[o])&&(r+=e)}}else{for(;++o<i;){u(e=+t.call(n,n[o],o))&&(r+=e)}}return r},ta.mean=function(n,t){var e,i=0,o=n.length,a=-1,c=o;if(1===arguments.length){for(;++a<o;){u(e=r(n[a]))?i+=e:--c}}else{for(;++a<o;){u(e=r(t.call(n,n[a],a)))?i+=e:--c}}return c?i/c:void 0},ta.quantile=function(n,t){var e=(n.length-1)*t+1,r=Math.floor(e),u=+n[r-1],i=e-r;return i?u+i*(n[r]-u):u},ta.median=function(n,t){var i,o=[],a=n.length,c=-1;if(1===arguments.length){for(;++c<a;){u(i=r(n[c]))&&o.push(i)}}else{for(;++c<a;){u(i=r(t.call(n,n[c],c)))&&o.push(i)}}return o.length?ta.quantile(o.sort(e),0.5):void 0},ta.variance=function(n,t){var e,i,o=n.length,a=0,c=0,l=-1,s=0;if(1===arguments.length){for(;++l<o;){u(e=r(n[l]))&&(i=e-a,a+=i/++s,c+=i*(e-a))}}else{for(;++l<o;){u(e=r(t.call(n,n[l],l)))&&(i=e-a,a+=i/++s,c+=i*(e-a))}}return s>1?c/(s-1):void 0},ta.deviation=function(){var n=ta.variance.apply(this,arguments);return n?Math.sqrt(n):n};var ha=i(e);ta.bisectLeft=ha.left,ta.bisect=ta.bisectRight=ha.right,ta.bisector=function(n){return i(1===n.length?function(t,r){return e(n(t),r)}:n)},ta.shuffle=function(n,t,e){(i=arguments.length)<3&&(e=n.length,2>i&&(t=0));for(var r,u,i=e-t;i;){u=Math.random()*i--|0,r=n[i+t],n[i+t]=n[u+t],n[u+t]=r}return n},ta.permute=function(n,t){for(var e=t.length,r=new Array(e);e--;){r[e]=n[t[e]]}return r},ta.pairs=function(n){for(var t,e=0,r=n.length-1,u=n[0],i=new Array(0>r?0:r);r>e;){i[e]=[t=u,u=n[++e]]}return i},ta.zip=function(){if(!(r=arguments.length)){return[]}for(var n=-1,t=ta.min(arguments,o),e=new Array(t);++n<t;){for(var r,u=-1,i=e[n]=new Array(r);++u<r;){i[u]=arguments[u][n]}}return e},ta.transpose=function(n){return ta.zip.apply(ta,n)},ta.keys=function(n){var t=[];for(var e in n){t.push(e)}return t},ta.values=function(n){var t=[];for(var e in n){t.push(n[e])}return t},ta.entries=function(n){var t=[];for(var e in n){t.push({key:e,value:n[e]})}return t},ta.merge=function(n){for(var t,e,r,u=n.length,i=-1,o=0;++i<u;){o+=n[i].length}for(e=new Array(o);--u>=0;){for(r=n[u],t=r.length;--t>=0;){e[--o]=r[t]}}return e};var ga=Math.abs;ta.range=function(n,t,e){if(arguments.length<3&&(e=1,arguments.length<2&&(t=n,n=0)),(t-n)/e===1/0){throw new Error("infinite range")}var r,u=[],i=a(ga(e)),o=-1;if(n*=i,t*=i,e*=i,0>e){for(;(r=n+e*++o)>t;){u.push(r/i)}}else{for(;(r=n+e*++o)<t;){u.push(r/i)}}return u},ta.map=function(n,t){var e=new l;if(n instanceof l){n.forEach(function(n,t){e.set(n,t)})}else{if(Array.isArray(n)){var r,u=-1,i=n.length;if(1===arguments.length){for(;++u<i;){e.set(u,n[u])}}else{for(;++u<i;){e.set(t.call(n,r=n[u],u),r)}}}else{for(var o in n){e.set(o,n[o])}}}return e};var pa="__proto__",va="\x00";c(l,{has:h,get:function(n){return this._[s(n)]},set:function(n,t){return this._[s(n)]=t},remove:g,keys:p,values:function(){var n=[];for(var t in this._){n.push(this._[t])}return n},entries:function(){var n=[];for(var t in this._){n.push({key:f(t),value:this._[t]})}return n},size:v,empty:d,forEach:function(n){for(var t in this._){n.call(this,f(t),this._[t])}}}),ta.nest=function(){function n(t,o,a){if(a>=i.length){return r?r.call(u,o):e?o.sort(e):o}for(var c,s,f,h,g=-1,p=o.length,v=i[a++],d=new l;++g<p;){(h=d.get(c=v(s=o[g])))?h.push(s):d.set(c,[s])}return t?(s=t(),f=function(e,r){s.set(e,n(t,r,a))}):(s={},f=function(e,r){s[e]=n(t,r,a)}),d.forEach(f),s}function t(n,e){if(e>=i.length){return n}var r=[],u=o[e++];return n.forEach(function(n,u){r.push({key:n,values:t(u,e)})}),u?r.sort(function(n,t){return u(n.key,t.key)}):r}var e,r,u={},i=[],o=[];return u.map=function(t,e){return n(e,t,0)},u.entries=function(e){return t(n(ta.map,e,0),0)},u.key=function(n){return i.push(n),u},u.sortKeys=function(n){return o[i.length-1]=n,u},u.sortValues=function(n){return e=n,u},u.rollup=function(n){return r=n,u},u},ta.set=function(n){var t=new m;if(n){for(var e=0,r=n.length;r>e;++e){t.add(n[e])}}return t},c(m,{has:h,add:function(n){return this._[s(n+="")]=!0,n},remove:g,values:p,size:v,empty:d,forEach:function(n){for(var t in this._){n.call(this,f(t))}}}),ta.behavior={},ta.rebind=function(n,t){for(var e,r=1,u=arguments.length;++r<u;){n[e=arguments[r]]=M(n,t,t[e])}return n};var da=["webkit","ms","moz","Moz","o","O"];ta.dispatch=function(){for(var n=new _,t=-1,e=arguments.length;++t<e;){n[arguments[t]]=w(n)}return n},_.prototype.on=function(n,t){var e=n.indexOf("."),r="";if(e>=0&&(r=n.slice(e+1),n=n.slice(0,e)),n){return arguments.length<2?this[n].on(r):this[n].on(r,t)}if(2===arguments.length){if(null==t){for(n in this){this.hasOwnProperty(n)&&this[n].on(r,null)}}return this}},ta.event=null,ta.requote=function(n){return n.replace(ma,"\\$&")};var ma=/[\\\^\$\*\+\?\|\[\]\(\)\.\{\}]/g,ya={}.__proto__?function(n,t){n.__proto__=t}:function(n,t){for(var e in t){n[e]=t[e]}},Ma=function(n,t){return t.querySelector(n)},xa=function(n,t){return t.querySelectorAll(n)},ba=function(n,t){var e=n.matches||n[x(n,"matchesSelector")];return(ba=function(n,t){return e.call(n,t)})(n,t)};"function"==typeof Sizzle&&(Ma=function(n,t){return Sizzle(n,t)[0]||null},xa=Sizzle,ba=Sizzle.matchesSelector),ta.selection=function(){return ta.select(ua.documentElement)};var _a=ta.selection.prototype=[];_a.select=function(n){var t,e,r,u,i=[];n=N(n);for(var o=-1,a=this.length;++o<a;){i.push(t=[]),t.parentNode=(r=this[o]).parentNode;for(var c=-1,l=r.length;++c<l;){(u=r[c])?(t.push(e=n.call(u,u.__data__,c,o)),e&&"__data__" in u&&(e.__data__=u.__data__)):t.push(null)}}return A(i)},_a.selectAll=function(n){var t,e,r=[];n=C(n);for(var u=-1,i=this.length;++u<i;){for(var o=this[u],a=-1,c=o.length;++a<c;){(e=o[a])&&(r.push(t=ra(n.call(e,e.__data__,a,u))),t.parentNode=e)}}return A(r)};var wa={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};ta.ns={prefix:wa,qualify:function(n){var t=n.indexOf(":"),e=n;return t>=0&&(e=n.slice(0,t),n=n.slice(t+1)),wa.hasOwnProperty(e)?{space:wa[e],local:n}:n}},_a.attr=function(n,t){if(arguments.length<2){if("string"==typeof n){var e=this.node();return n=ta.ns.qualify(n),n.local?e.getAttributeNS(n.space,n.local):e.getAttribute(n)}for(t in n){this.each(z(t,n[t]))}return this}return this.each(z(n,t))},_a.classed=function(n,t){if(arguments.length<2){if("string"==typeof n){var e=this.node(),r=(n=T(n)).length,u=-1;if(t=e.classList){for(;++u<r;){if(!t.contains(n[u])){return !1}}}else{for(t=e.getAttribute("class");++u<r;){if(!L(n[u]).test(t)){return !1}}}return !0}for(t in n){this.each(R(t,n[t]))}return this}return this.each(R(n,t))},_a.style=function(n,e,r){var u=arguments.length;if(3>u){if("string"!=typeof n){2>u&&(e="");for(r in n){this.each(P(r,n[r],e))}return this}if(2>u){var i=this.node();return t(i).getComputedStyle(i,null).getPropertyValue(n)}r=""}return this.each(P(n,e,r))},_a.property=function(n,t){if(arguments.length<2){if("string"==typeof n){return this.node()[n]}for(t in n){this.each(U(t,n[t]))}return this}return this.each(U(n,t))},_a.text=function(n){return arguments.length?this.each("function"==typeof n?function(){var t=n.apply(this,arguments);this.textContent=null==t?"":t}:null==n?function(){this.textContent=""}:function(){this.textContent=n}):this.node().textContent},_a.html=function(n){return arguments.length?this.each("function"==typeof n?function(){var t=n.apply(this,arguments);this.innerHTML=null==t?"":t}:null==n?function(){this.innerHTML=""}:function(){this.innerHTML=n}):this.node().innerHTML},_a.append=function(n){return n=j(n),this.select(function(){return this.appendChild(n.apply(this,arguments))})},_a.insert=function(n,t){return n=j(n),t=N(t),this.select(function(){return this.insertBefore(n.apply(this,arguments),t.apply(this,arguments)||null)})},_a.remove=function(){return this.each(F)},_a.data=function(n,t){function e(n,e){var r,u,i,o=n.length,f=e.length,h=Math.min(o,f),g=new Array(f),p=new Array(f),v=new Array(o);if(t){var d,m=new l,y=new Array(o);for(r=-1;++r<o;){m.has(d=t.call(u=n[r],u.__data__,r))?v[r]=u:m.set(d,u),y[r]=d}for(r=-1;++r<f;){(u=m.get(d=t.call(e,i=e[r],r)))?u!==!0&&(g[r]=u,u.__data__=i):p[r]=H(i),m.set(d,!0)}for(r=-1;++r<o;){m.get(y[r])!==!0&&(v[r]=n[r])}}else{for(r=-1;++r<h;){u=n[r],i=e[r],u?(u.__data__=i,g[r]=u):p[r]=H(i)}for(;f>r;++r){p[r]=H(e[r])}for(;o>r;++r){v[r]=n[r]}}p.update=g,p.parentNode=g.parentNode=v.parentNode=n.parentNode,a.push(p),c.push(g),s.push(v)}var r,u,i=-1,o=this.length;if(!arguments.length){for(n=new Array(o=(r=this[0]).length);++i<o;){(u=r[i])&&(n[i]=u.__data__)}return n}var a=Z([]),c=A([]),s=A([]);if("function"==typeof n){for(;++i<o;){e(r=this[i],n.call(r,r.parentNode.__data__,i))}}else{for(;++i<o;){e(r=this[i],n)}}return c.enter=function(){return a},c.exit=function(){return s},c},_a.datum=function(n){return arguments.length?this.property("__data__",n):this.property("__data__")},_a.filter=function(n){var t,e,r,u=[];"function"!=typeof n&&(n=O(n));for(var i=0,o=this.length;o>i;i++){u.push(t=[]),t.parentNode=(e=this[i]).parentNode;for(var a=0,c=e.length;c>a;a++){(r=e[a])&&n.call(r,r.__data__,a,i)&&t.push(r)}}return A(u)},_a.order=function(){for(var n=-1,t=this.length;++n<t;){for(var e,r=this[n],u=r.length-1,i=r[u];--u>=0;){(e=r[u])&&(i&&i!==e.nextSibling&&i.parentNode.insertBefore(e,i),i=e)}}return this},_a.sort=function(n){n=I.apply(this,arguments);for(var t=-1,e=this.length;++t<e;){this[t].sort(n)}return this.order()},_a.each=function(n){return Y(this,function(t,e,r){n.call(t,t.__data__,e,r)})},_a.call=function(n){var t=ra(arguments);return n.apply(t[0]=this,t),this},_a.empty=function(){return !this.node()},_a.node=function(){for(var n=0,t=this.length;t>n;n++){for(var e=this[n],r=0,u=e.length;u>r;r++){var i=e[r];if(i){return i}}}return null},_a.size=function(){var n=0;return Y(this,function(){++n}),n};var Sa=[];ta.selection.enter=Z,ta.selection.enter.prototype=Sa,Sa.append=_a.append,Sa.empty=_a.empty,Sa.node=_a.node,Sa.call=_a.call,Sa.size=_a.size,Sa.select=function(n){for(var t,e,r,u,i,o=[],a=-1,c=this.length;++a<c;){r=(u=this[a]).update,o.push(t=[]),t.parentNode=u.parentNode;for(var l=-1,s=u.length;++l<s;){(i=u[l])?(t.push(r[l]=e=n.call(u.parentNode,i.__data__,l,a)),e.__data__=i.__data__):t.push(null)}}return A(o)},Sa.insert=function(n,t){return arguments.length<2&&(t=V(this)),_a.insert.call(this,n,t)},ta.select=function(t){var e;return"string"==typeof t?(e=[Ma(t,ua)],e.parentNode=ua.documentElement):(e=[t],e.parentNode=n(t)),A([e])},ta.selectAll=function(n){var t;return"string"==typeof n?(t=ra(xa(n,ua)),t.parentNode=ua.documentElement):(t=n,t.parentNode=null),A([t])},_a.on=function(n,t,e){var r=arguments.length;if(3>r){if("string"!=typeof n){2>r&&(t=!1);for(e in n){this.each(X(e,n[e],t))}return this}if(2>r){return(r=this.node()["__on"+n])&&r._}e=!1}return this.each(X(n,t,e))};var ka=ta.map({mouseenter:"mouseover",mouseleave:"mouseout"});ua&&ka.forEach(function(n){"on"+n in ua&&ka.remove(n)});var Ea,Aa=0;ta.mouse=function(n){return J(n,k())};var Na=this.navigator&&/WebKit/.test(this.navigator.userAgent)?-1:0;ta.touch=function(n,t,e){if(arguments.length<3&&(e=t,t=k().changedTouches),t){for(var r,u=0,i=t.length;i>u;++u){if((r=t[u]).identifier===e){return J(n,r)}}}},ta.behavior.drag=function(){function n(){this.on("mousedown.drag",i).on("touchstart.drag",o)}function e(n,t,e,i,o){return function(){function a(){var n,e,r=t(h,v);r&&(n=r[0]-M[0],e=r[1]-M[1],p|=n|e,M=r,g({type:"drag",x:r[0]+l[0],y:r[1]+l[1],dx:n,dy:e}))}function c(){t(h,v)&&(m.on(i+d,null).on(o+d,null),y(p&&ta.event.target===f),g({type:"dragend"}))}var l,s=this,f=ta.event.target,h=s.parentNode,g=r.of(s,arguments),p=0,v=n(),d=".drag"+(null==v?"":"-"+v),m=ta.select(e(f)).on(i+d,a).on(o+d,c),y=W(f),M=t(h,v);u?(l=u.apply(s,arguments),l=[l.x-M[0],l.y-M[1]]):l=[0,0],g({type:"dragstart"})}}var r=E(n,"drag","dragstart","dragend"),u=null,i=e(b,ta.mouse,t,"mousemove","mouseup"),o=e(G,ta.touch,y,"touchmove","touchend");return n.origin=function(t){return arguments.length?(u=t,n):u},ta.rebind(n,r,"on")},ta.touches=function(n,t){return arguments.length<2&&(t=k().touches),t?ra(t).map(function(t){var e=J(n,t);return e.identifier=t.identifier,e}):[]};var Ca=0.000001,za=Ca*Ca,qa=Math.PI,La=2*qa,Ta=La-Ca,Ra=qa/2,Da=qa/180,Pa=180/qa,Ua=Math.SQRT2,ja=2,Fa=4;ta.interpolateZoom=function(n,t){function e(n){var t=n*y;if(m){var e=rt(v),o=i/(ja*h)*(e*ut(Ua*t+v)-et(v));return[r+o*l,u+o*s,i*e/rt(Ua*t+v)]}return[r+n*l,u+n*s,i*Math.exp(Ua*t)]}var r=n[0],u=n[1],i=n[2],o=t[0],a=t[1],c=t[2],l=o-r,s=a-u,f=l*l+s*s,h=Math.sqrt(f),g=(c*c-i*i+Fa*f)/(2*i*ja*h),p=(c*c-i*i-Fa*f)/(2*c*ja*h),v=Math.log(Math.sqrt(g*g+1)-g),d=Math.log(Math.sqrt(p*p+1)-p),m=d-v,y=(m||Math.log(c/i))/Ua;return e.duration=1000*y,e},ta.behavior.zoom=function(){function n(n){n.on(q,f).on(Oa+".zoom",g).on("dblclick.zoom",p).on(R,h)}function e(n){return[(n[0]-k.x)/k.k,(n[1]-k.y)/k.k]}function r(n){return[n[0]*k.k+k.x,n[1]*k.k+k.y]}function u(n){k.k=Math.max(N[0],Math.min(N[1],n))}function i(n,t){t=r(t),k.x+=n[0]-t[0],k.y+=n[1]-t[1]}function o(t,e,r,o){t.__chart__={x:k.x,y:k.y,k:k.k},u(Math.pow(2,o)),i(d=e,r),t=ta.select(t),C>0&&(t=t.transition().duration(C)),t.call(n.event)}function a(){b&&b.domain(x.range().map(function(n){return(n-k.x)/k.k}).map(x.invert)),w&&w.domain(_.range().map(function(n){return(n-k.y)/k.k}).map(_.invert))}function c(n){z++||n({type:"zoomstart"})}function l(n){a(),n({type:"zoom",scale:k.k,translate:[k.x,k.y]})}function s(n){--z||n({type:"zoomend"}),d=null}function f(){function n(){f=1,i(ta.mouse(u),g),l(a)}function r(){h.on(L,null).on(T,null),p(f&&ta.event.target===o),s(a)}var u=this,o=ta.event.target,a=D.of(u,arguments),f=0,h=ta.select(t(u)).on(L,n).on(T,r),g=e(ta.mouse(u)),p=W(u);Dl.call(u),c(a)}function h(){function n(){var n=ta.touches(p);return g=k.k,n.forEach(function(n){n.identifier in d&&(d[n.identifier]=e(n))}),n}function t(){var t=ta.event.target;ta.select(t).on(x,r).on(b,a),_.push(t);for(var e=ta.event.changedTouches,u=0,i=e.length;i>u;++u){d[e[u].identifier]=null}var c=n(),l=Date.now();if(1===c.length){if(500>l-M){var s=c[0];o(p,s,d[s.identifier],Math.floor(Math.log(k.k)/Math.LN2)+1),S()}M=l}else{if(c.length>1){var s=c[0],f=c[1],h=s[0]-f[0],g=s[1]-f[1];m=h*h+g*g}}}function r(){var n,t,e,r,o=ta.touches(p);Dl.call(p);for(var a=0,c=o.length;c>a;++a,r=null){if(e=o[a],r=d[e.identifier]){if(t){break}n=e,t=r}}if(r){var s=(s=e[0]-n[0])*s+(s=e[1]-n[1])*s,f=m&&Math.sqrt(s/m);n=[(n[0]+e[0])/2,(n[1]+e[1])/2],t=[(t[0]+r[0])/2,(t[1]+r[1])/2],u(f*g)}M=null,i(n,t),l(v)}function a(){if(ta.event.touches.length){for(var t=ta.event.changedTouches,e=0,r=t.length;r>e;++e){delete d[t[e].identifier]}for(var u in d){return void n()}}ta.selectAll(_).on(y,null),w.on(q,f).on(R,h),E(),s(v)}var g,p=this,v=D.of(p,arguments),d={},m=0,y=".zoom-"+ta.event.changedTouches[0].identifier,x="touchmove"+y,b="touchend"+y,_=[],w=ta.select(p),E=W(p);t(),c(v),w.on(q,null).on(R,t)}function g(){var n=D.of(this,arguments);y?clearTimeout(y):(v=e(d=m||ta.mouse(this)),Dl.call(this),c(n)),y=setTimeout(function(){y=null,s(n)},50),S(),u(Math.pow(2,0.002*Ha())*k.k),i(d,v),l(n)}function p(){var n=ta.mouse(this),t=Math.log(k.k)/Math.LN2;o(this,n,e(n),ta.event.shiftKey?Math.ceil(t)-1:Math.floor(t)+1)}var v,d,m,y,M,x,b,_,w,k={x:0,y:0,k:1},A=[960,500],N=Ia,C=250,z=0,q="mousedown.zoom",L="mousemove.zoom",T="mouseup.zoom",R="touchstart.zoom",D=E(n,"zoomstart","zoom","zoomend");return Oa||(Oa="onwheel" in ua?(Ha=function(){return -ta.event.deltaY*(ta.event.deltaMode?120:1)},"wheel"):"onmousewheel" in ua?(Ha=function(){return ta.event.wheelDelta},"mousewheel"):(Ha=function(){return -ta.event.detail},"MozMousePixelScroll")),n.event=function(n){n.each(function(){var n=D.of(this,arguments),t=k;Tl?ta.select(this).transition().each("start.zoom",function(){k=this.__chart__||{x:0,y:0,k:1},c(n)}).tween("zoom:zoom",function(){var e=A[0],r=A[1],u=d?d[0]:e/2,i=d?d[1]:r/2,o=ta.interpolateZoom([(u-k.x)/k.k,(i-k.y)/k.k,e/k.k],[(u-t.x)/t.k,(i-t.y)/t.k,e/t.k]);return function(t){var r=o(t),a=e/r[2];this.__chart__=k={x:u-r[0]*a,y:i-r[1]*a,k:a},l(n)}}).each("interrupt.zoom",function(){s(n)}).each("end.zoom",function(){s(n)}):(this.__chart__=k,c(n),l(n),s(n))})},n.translate=function(t){return arguments.length?(k={x:+t[0],y:+t[1],k:k.k},a(),n):[k.x,k.y]},n.scale=function(t){return arguments.length?(k={x:k.x,y:k.y,k:+t},a(),n):k.k},n.scaleExtent=function(t){return arguments.length?(N=null==t?Ia:[+t[0],+t[1]],n):N},n.center=function(t){return arguments.length?(m=t&&[+t[0],+t[1]],n):m},n.size=function(t){return arguments.length?(A=t&&[+t[0],+t[1]],n):A},n.duration=function(t){return arguments.length?(C=+t,n):C},n.x=function(t){return arguments.length?(b=t,x=t.copy(),k={x:0,y:0,k:1},n):b},n.y=function(t){return arguments.length?(w=t,_=t.copy(),k={x:0,y:0,k:1},n):w},ta.rebind(n,D,"on")};var Ha,Oa,Ia=[0,1/0];ta.color=ot,ot.prototype.toString=function(){return this.rgb()+""},ta.hsl=at;var Ya=at.prototype=new ot;Ya.brighter=function(n){return n=Math.pow(0.7,arguments.length?n:1),new at(this.h,this.s,this.l/n)},Ya.darker=function(n){return n=Math.pow(0.7,arguments.length?n:1),new at(this.h,this.s,n*this.l)},Ya.rgb=function(){return ct(this.h,this.s,this.l)},ta.hcl=lt;var Za=lt.prototype=new ot;Za.brighter=function(n){return new lt(this.h,this.c,Math.min(100,this.l+Va*(arguments.length?n:1)))},Za.darker=function(n){return new lt(this.h,this.c,Math.max(0,this.l-Va*(arguments.length?n:1)))},Za.rgb=function(){return st(this.h,this.c,this.l).rgb()},ta.lab=ft;var Va=18,Xa=0.95047,$a=1,Ba=1.08883,Wa=ft.prototype=new ot;Wa.brighter=function(n){return new ft(Math.min(100,this.l+Va*(arguments.length?n:1)),this.a,this.b)},Wa.darker=function(n){return new ft(Math.max(0,this.l-Va*(arguments.length?n:1)),this.a,this.b)},Wa.rgb=function(){return ht(this.l,this.a,this.b)},ta.rgb=mt;var Ja=mt.prototype=new ot;Ja.brighter=function(n){n=Math.pow(0.7,arguments.length?n:1);var t=this.r,e=this.g,r=this.b,u=30;return t||e||r?(t&&u>t&&(t=u),e&&u>e&&(e=u),r&&u>r&&(r=u),new mt(Math.min(255,t/n),Math.min(255,e/n),Math.min(255,r/n))):new mt(u,u,u)},Ja.darker=function(n){return n=Math.pow(0.7,arguments.length?n:1),new mt(n*this.r,n*this.g,n*this.b)},Ja.hsl=function(){return _t(this.r,this.g,this.b)},Ja.toString=function(){return"#"+xt(this.r)+xt(this.g)+xt(this.b)};var Ga=ta.map({aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074});Ga.forEach(function(n,t){Ga.set(n,yt(t))}),ta.functor=Et,ta.xhr=At(y),ta.dsv=function(n,t){function e(n,e,i){arguments.length<3&&(i=e,e=null);var o=Nt(n,t,null==e?r:u(e),i);return o.row=function(n){return arguments.length?o.response(null==(e=n)?r:u(n)):e},o}function r(n){return e.parse(n.responseText)}function u(n){return function(t){return e.parse(t.responseText,n)}}function i(t){return t.map(o).join(n)}function o(n){return a.test(n)?'"'+n.replace(/\"/g,'""')+'"':n}var a=new RegExp('["'+n+"\n]"),c=n.charCodeAt(0);return e.parse=function(n,t){var r;return e.parseRows(n,function(n,e){if(r){return r(n,e-1)}var u=new Function("d","return {"+n.map(function(n,t){return JSON.stringify(n)+": d["+t+"]"}).join(",")+"}");r=t?function(n,e){return t(u(n),e)}:u})},e.parseRows=function(n,t){function e(){if(s>=l){return o}if(u){return u=!1,i}var t=s;if(34===n.charCodeAt(t)){for(var e=t;e++<l;){if(34===n.charCodeAt(e)){if(34!==n.charCodeAt(e+1)){break}++e}}s=e+2;var r=n.charCodeAt(e+1);return 13===r?(u=!0,10===n.charCodeAt(e+2)&&++s):10===r&&(u=!0),n.slice(t+1,e).replace(/""/g,'"')}for(;l>s;){var r=n.charCodeAt(s++),a=1;if(10===r){u=!0}else{if(13===r){u=!0,10===n.charCodeAt(s)&&(++s,++a)}else{if(r!==c){continue}}}return n.slice(t,s-a)}return n.slice(t)}for(var r,u,i={},o={},a=[],l=n.length,s=0,f=0;(r=e())!==o;){for(var h=[];r!==i&&r!==o;){h.push(r),r=e()}t&&null==(h=t(h,f++))||a.push(h)}return a},e.format=function(t){if(Array.isArray(t[0])){return e.formatRows(t)}var r=new m,u=[];return t.forEach(function(n){for(var t in n){r.has(t)||u.push(r.add(t))}}),[u.map(o).join(n)].concat(t.map(function(t){return u.map(function(n){return o(t[n])}).join(n)})).join("\n")},e.formatRows=function(n){return n.map(i).join("\n")},e},ta.csv=ta.dsv(",","text/csv"),ta.tsv=ta.dsv("	","text/tab-separated-values");var Ka,Qa,nc,tc,ec,rc=this[x(this,"requestAnimationFrame")]||function(n){setTimeout(n,17)};ta.timer=function(n,t,e){var r=arguments.length;2>r&&(t=0),3>r&&(e=Date.now());var u=e+t,i={c:n,t:u,f:!1,n:null};Qa?Qa.n=i:Ka=i,Qa=i,nc||(tc=clearTimeout(tc),nc=1,rc(qt))},ta.timer.flush=function(){Lt(),Tt()},ta.round=function(n,t){return t?Math.round(n*(t=Math.pow(10,t)))/t:Math.round(n)};var uc=["y","z","a","f","p","n","\xb5","m","","k","M","G","T","P","E","Z","Y"].map(Dt);ta.formatPrefix=function(n,t){var e=0;return n&&(0>n&&(n*=-1),t&&(n=ta.round(n,Rt(n,t))),e=1+Math.floor(1e-12+Math.log(n)/Math.LN10),e=Math.max(-24,Math.min(24,3*Math.floor((e-1)/3)))),uc[8+e/3]};var ic=/(?:([^{])?([<>=^]))?([+\- ])?([$#])?(0)?(\d+)?(,)?(\.-?\d+)?([a-z%])?/i,oc=ta.map({b:function(n){return n.toString(2)},c:function(n){return String.fromCharCode(n)},o:function(n){return n.toString(8)},x:function(n){return n.toString(16)},X:function(n){return n.toString(16).toUpperCase()},g:function(n,t){return n.toPrecision(t)},e:function(n,t){return n.toExponential(t)},f:function(n,t){return n.toFixed(t)},r:function(n,t){return(n=ta.round(n,Rt(n,t))).toFixed(Math.max(0,Math.min(20,Rt(n*(1+1e-15),t))))}}),ac=ta.time={},cc=Date;jt.prototype={getDate:function(){return this._.getUTCDate()},getDay:function(){return this._.getUTCDay()},getFullYear:function(){return this._.getUTCFullYear()},getHours:function(){return this._.getUTCHours()},getMilliseconds:function(){return this._.getUTCMilliseconds()},getMinutes:function(){return this._.getUTCMinutes()},getMonth:function(){return this._.getUTCMonth()},getSeconds:function(){return this._.getUTCSeconds()},getTime:function(){return this._.getTime()},getTimezoneOffset:function(){return 0},valueOf:function(){return this._.valueOf()},setDate:function(){lc.setUTCDate.apply(this._,arguments)},setDay:function(){lc.setUTCDay.apply(this._,arguments)},setFullYear:function(){lc.setUTCFullYear.apply(this._,arguments)},setHours:function(){lc.setUTCHours.apply(this._,arguments)},setMilliseconds:function(){lc.setUTCMilliseconds.apply(this._,arguments)},setMinutes:function(){lc.setUTCMinutes.apply(this._,arguments)},setMonth:function(){lc.setUTCMonth.apply(this._,arguments)},setSeconds:function(){lc.setUTCSeconds.apply(this._,arguments)},setTime:function(){lc.setTime.apply(this._,arguments)}};var lc=Date.prototype;ac.year=Ft(function(n){return n=ac.day(n),n.setMonth(0,1),n},function(n,t){n.setFullYear(n.getFullYear()+t)},function(n){return n.getFullYear()}),ac.years=ac.year.range,ac.years.utc=ac.year.utc.range,ac.day=Ft(function(n){var t=new cc(2000,0);return t.setFullYear(n.getFullYear(),n.getMonth(),n.getDate()),t},function(n,t){n.setDate(n.getDate()+t)},function(n){return n.getDate()-1}),ac.days=ac.day.range,ac.days.utc=ac.day.utc.range,ac.dayOfYear=function(n){var t=ac.year(n);return Math.floor((n-t-60000*(n.getTimezoneOffset()-t.getTimezoneOffset()))/86400000)},["sunday","monday","tuesday","wednesday","thursday","friday","saturday"].forEach(function(n,t){t=7-t;var e=ac[n]=Ft(function(n){return(n=ac.day(n)).setDate(n.getDate()-(n.getDay()+t)%7),n},function(n,t){n.setDate(n.getDate()+7*Math.floor(t))},function(n){var e=ac.year(n).getDay();return Math.floor((ac.dayOfYear(n)+(e+t)%7)/7)-(e!==t)});ac[n+"s"]=e.range,ac[n+"s"].utc=e.utc.range,ac[n+"OfYear"]=function(n){var e=ac.year(n).getDay();return Math.floor((ac.dayOfYear(n)+(e+t)%7)/7)}}),ac.week=ac.sunday,ac.weeks=ac.sunday.range,ac.weeks.utc=ac.sunday.utc.range,ac.weekOfYear=ac.sundayOfYear;var sc={"-":"",_:" ",0:"0"},fc=/^\s*\d+/,hc=/^%/;ta.locale=function(n){return{numberFormat:Pt(n),timeFormat:Ot(n)}};var gc=ta.locale({decimal:".",thousands:",",grouping:[3],currency:["$",""],dateTime:"%a %b %e %X %Y",date:"%m/%d/%Y",time:"%H:%M:%S",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]});ta.format=gc.numberFormat,ta.geo={},ce.prototype={s:0,t:0,add:function(n){le(n,this.t,pc),le(pc.s,this.s,this),this.s?this.t+=pc.t:this.s=pc.t},reset:function(){this.s=this.t=0},valueOf:function(){return this.s}};var pc=new ce;ta.geo.stream=function(n,t){n&&vc.hasOwnProperty(n.type)?vc[n.type](n,t):se(n,t)};var vc={Feature:function(n,t){se(n.geometry,t)},FeatureCollection:function(n,t){for(var e=n.features,r=-1,u=e.length;++r<u;){se(e[r].geometry,t)}}},dc={Sphere:function(n,t){t.sphere()},Point:function(n,t){n=n.coordinates,t.point(n[0],n[1],n[2])},MultiPoint:function(n,t){for(var e=n.coordinates,r=-1,u=e.length;++r<u;){n=e[r],t.point(n[0],n[1],n[2])}},LineString:function(n,t){fe(n.coordinates,t,0)},MultiLineString:function(n,t){for(var e=n.coordinates,r=-1,u=e.length;++r<u;){fe(e[r],t,0)}},Polygon:function(n,t){he(n.coordinates,t)},MultiPolygon:function(n,t){for(var e=n.coordinates,r=-1,u=e.length;++r<u;){he(e[r],t)}},GeometryCollection:function(n,t){for(var e=n.geometries,r=-1,u=e.length;++r<u;){se(e[r],t)}}};ta.geo.area=function(n){return mc=0,ta.geo.stream(n,Mc),mc};var mc,yc=new ce,Mc={sphere:function(){mc+=4*qa},point:b,lineStart:b,lineEnd:b,polygonStart:function(){yc.reset(),Mc.lineStart=ge},polygonEnd:function(){var n=2*yc;mc+=0>n?4*qa+n:n,Mc.lineStart=Mc.lineEnd=Mc.point=b}};ta.geo.bounds=function(){function n(n,t){M.push(x=[s=n,h=n]),f>t&&(f=t),t>g&&(g=t)}function t(t,e){var r=pe([t*Da,e*Da]);if(m){var u=de(m,r),i=[u[1],-u[0],0],o=de(i,u);Me(o),o=xe(o);var c=t-p,l=c>0?1:-1,v=o[0]*Pa*l,d=ga(c)>180;if(d^(v>l*p&&l*t>v)){var y=o[1]*Pa;y>g&&(g=y)}else{if(v=(v+360)%360-180,d^(v>l*p&&l*t>v)){var y=-o[1]*Pa;f>y&&(f=y)}else{f>e&&(f=e),e>g&&(g=e)}}d?p>t?a(s,t)>a(s,h)&&(h=t):a(t,h)>a(s,h)&&(s=t):h>=s?(s>t&&(s=t),t>h&&(h=t)):t>p?a(s,t)>a(s,h)&&(h=t):a(t,h)>a(s,h)&&(s=t)}else{n(t,e)}m=r,p=t}function e(){b.point=t}function r(){x[0]=s,x[1]=h,b.point=n,m=null}function u(n,e){if(m){var r=n-p;y+=ga(r)>180?r+(r>0?360:-360):r}else{v=n,d=e}Mc.point(n,e),t(n,e)}function i(){Mc.lineStart()}function o(){u(v,d),Mc.lineEnd(),ga(y)>Ca&&(s=-(h=180)),x[0]=s,x[1]=h,m=null}function a(n,t){return(t-=n)<0?t+360:t}function c(n,t){return n[0]-t[0]}function l(n,t){return t[0]<=t[1]?t[0]<=n&&n<=t[1]:n<t[0]||t[1]<n}var s,f,h,g,p,v,d,m,y,M,x,b={point:n,lineStart:e,lineEnd:r,polygonStart:function(){b.point=u,b.lineStart=i,b.lineEnd=o,y=0,Mc.polygonStart()},polygonEnd:function(){Mc.polygonEnd(),b.point=n,b.lineStart=e,b.lineEnd=r,0>yc?(s=-(h=180),f=-(g=90)):y>Ca?g=90:-Ca>y&&(f=-90),x[0]=s,x[1]=h}};return function(n){g=h=-(s=f=1/0),M=[],ta.geo.stream(n,b);var t=M.length;if(t){M.sort(c);for(var e,r=1,u=M[0],i=[u];t>r;++r){e=M[r],l(e[0],u)||l(e[1],u)?(a(u[0],e[1])>a(u[0],u[1])&&(u[1]=e[1]),a(e[0],u[1])>a(u[0],u[1])&&(u[0]=e[0])):i.push(u=e)}for(var o,e,p=-1/0,t=i.length-1,r=0,u=i[t];t>=r;u=e,++r){e=i[r],(o=a(u[1],e[0]))>p&&(p=o,s=e[0],h=u[1])}}return M=x=null,1/0===s||1/0===f?[[0/0,0/0],[0/0,0/0]]:[[s,f],[h,g]]}}(),ta.geo.centroid=function(n){xc=bc=_c=wc=Sc=kc=Ec=Ac=Nc=Cc=zc=0,ta.geo.stream(n,qc);var t=Nc,e=Cc,r=zc,u=t*t+e*e+r*r;return za>u&&(t=kc,e=Ec,r=Ac,Ca>bc&&(t=_c,e=wc,r=Sc),u=t*t+e*e+r*r,za>u)?[0/0,0/0]:[Math.atan2(e,t)*Pa,tt(r/Math.sqrt(u))*Pa]};var xc,bc,_c,wc,Sc,kc,Ec,Ac,Nc,Cc,zc,qc={sphere:b,point:_e,lineStart:Se,lineEnd:ke,polygonStart:function(){qc.lineStart=Ee},polygonEnd:function(){qc.lineStart=Se}},Lc=Le(Ne,Pe,je,[-qa,-qa/2]),Tc=1000000000;ta.geo.clipExtent=function(){var n,t,e,r,u,i,o={stream:function(n){return u&&(u.valid=!1),u=i(n),u.valid=!0,u},extent:function(a){return arguments.length?(i=Ie(n=+a[0][0],t=+a[0][1],e=+a[1][0],r=+a[1][1]),u&&(u.valid=!1,u=null),o):[[n,t],[e,r]]}};return o.extent([[0,0],[960,500]])},(ta.geo.conicEqualArea=function(){return Ye(Ze)}).raw=Ze,ta.geo.albers=function(){return ta.geo.conicEqualArea().rotate([96,0]).center([-0.6,38.7]).parallels([29.5,45.5]).scale(1070)},ta.geo.albersUsa=function(){function n(n){var i=n[0],o=n[1];return t=null,e(i,o),t||(r(i,o),t)||u(i,o),t}var t,e,r,u,i=ta.geo.albers(),o=ta.geo.conicEqualArea().rotate([154,0]).center([-2,58.5]).parallels([55,65]),a=ta.geo.conicEqualArea().rotate([157,0]).center([-3,19.9]).parallels([8,18]),c={point:function(n,e){t=[n,e]}};return n.invert=function(n){var t=i.scale(),e=i.translate(),r=(n[0]-e[0])/t,u=(n[1]-e[1])/t;return(u>=0.12&&0.234>u&&r>=-0.425&&-0.214>r?o:u>=0.166&&0.234>u&&r>=-0.214&&-0.115>r?a:i).invert(n)},n.stream=function(n){var t=i.stream(n),e=o.stream(n),r=a.stream(n);return{point:function(n,u){t.point(n,u),e.point(n,u),r.point(n,u)},sphere:function(){t.sphere(),e.sphere(),r.sphere()},lineStart:function(){t.lineStart(),e.lineStart(),r.lineStart()},lineEnd:function(){t.lineEnd(),e.lineEnd(),r.lineEnd()},polygonStart:function(){t.polygonStart(),e.polygonStart(),r.polygonStart()},polygonEnd:function(){t.polygonEnd(),e.polygonEnd(),r.polygonEnd()}}},n.precision=function(t){return arguments.length?(i.precision(t),o.precision(t),a.precision(t),n):i.precision()},n.scale=function(t){return arguments.length?(i.scale(t),o.scale(0.35*t),a.scale(t),n.translate(i.translate())):i.scale()},n.translate=function(t){if(!arguments.length){return i.translate()}var l=i.scale(),s=+t[0],f=+t[1];return e=i.translate(t).clipExtent([[s-0.455*l,f-0.238*l],[s+0.455*l,f+0.238*l]]).stream(c).point,r=o.translate([s-0.307*l,f+0.201*l]).clipExtent([[s-0.425*l+Ca,f+0.12*l+Ca],[s-0.214*l-Ca,f+0.234*l-Ca]]).stream(c).point,u=a.translate([s-0.205*l,f+0.212*l]).clipExtent([[s-0.214*l+Ca,f+0.166*l+Ca],[s-0.115*l-Ca,f+0.234*l-Ca]]).stream(c).point,n},n.scale(1070)};var Rc,Dc,Pc,Uc,jc,Fc,Hc={point:b,lineStart:b,lineEnd:b,polygonStart:function(){Dc=0,Hc.lineStart=Ve},polygonEnd:function(){Hc.lineStart=Hc.lineEnd=Hc.point=b,Rc+=ga(Dc/2)}},Oc={point:Xe,lineStart:b,lineEnd:b,polygonStart:b,polygonEnd:b},Ic={point:We,lineStart:Je,lineEnd:Ge,polygonStart:function(){Ic.lineStart=Ke},polygonEnd:function(){Ic.point=We,Ic.lineStart=Je,Ic.lineEnd=Ge}};ta.geo.path=function(){function n(n){return n&&("function"==typeof a&&i.pointRadius(+a.apply(this,arguments)),o&&o.valid||(o=u(i)),ta.geo.stream(n,o)),i.result()}function t(){return o=null,n}var e,r,u,i,o,a=4.5;return n.area=function(n){return Rc=0,ta.geo.stream(n,u(Hc)),Rc},n.centroid=function(n){return _c=wc=Sc=kc=Ec=Ac=Nc=Cc=zc=0,ta.geo.stream(n,u(Ic)),zc?[Nc/zc,Cc/zc]:Ac?[kc/Ac,Ec/Ac]:Sc?[_c/Sc,wc/Sc]:[0/0,0/0]},n.bounds=function(n){return jc=Fc=-(Pc=Uc=1/0),ta.geo.stream(n,u(Oc)),[[Pc,Uc],[jc,Fc]]},n.projection=function(n){return arguments.length?(u=(e=n)?n.stream||tr(n):y,t()):e},n.context=function(n){return arguments.length?(i=null==(r=n)?new $e:new Qe(n),"function"!=typeof a&&i.pointRadius(a),t()):r},n.pointRadius=function(t){return arguments.length?(a="function"==typeof t?t:(i.pointRadius(+t),+t),n):a},n.projection(ta.geo.albersUsa()).context(null)},ta.geo.transform=function(n){return{stream:function(t){var e=new er(t);for(var r in n){e[r]=n[r]}return e}}},er.prototype={point:function(n,t){this.stream.point(n,t)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}},ta.geo.projection=ur,ta.geo.projectionMutator=ir,(ta.geo.equirectangular=function(){return ur(ar)}).raw=ar.invert=ar,ta.geo.rotation=function(n){function t(t){return t=n(t[0]*Da,t[1]*Da),t[0]*=Pa,t[1]*=Pa,t}return n=lr(n[0]%360*Da,n[1]*Da,n.length>2?n[2]*Da:0),t.invert=function(t){return t=n.invert(t[0]*Da,t[1]*Da),t[0]*=Pa,t[1]*=Pa,t},t},cr.invert=ar,ta.geo.circle=function(){function n(){var n="function"==typeof r?r.apply(this,arguments):r,t=lr(-n[0]*Da,-n[1]*Da,0).invert,u=[];return e(null,null,1,{point:function(n,e){u.push(n=t(n,e)),n[0]*=Pa,n[1]*=Pa}}),{type:"Polygon",coordinates:[u]}}var t,e,r=[0,0],u=6;return n.origin=function(t){return arguments.length?(r=t,n):r},n.angle=function(r){return arguments.length?(e=gr((t=+r)*Da,u*Da),n):t},n.precision=function(r){return arguments.length?(e=gr(t*Da,(u=+r)*Da),n):u},n.angle(90)},ta.geo.distance=function(n,t){var e,r=(t[0]-n[0])*Da,u=n[1]*Da,i=t[1]*Da,o=Math.sin(r),a=Math.cos(r),c=Math.sin(u),l=Math.cos(u),s=Math.sin(i),f=Math.cos(i);return Math.atan2(Math.sqrt((e=f*o)*e+(e=l*s-c*f*a)*e),c*s+l*f*a)},ta.geo.graticule=function(){function n(){return{type:"MultiLineString",coordinates:t()}}function t(){return ta.range(Math.ceil(i/d)*d,u,d).map(h).concat(ta.range(Math.ceil(l/m)*m,c,m).map(g)).concat(ta.range(Math.ceil(r/p)*p,e,p).filter(function(n){return ga(n%d)>Ca}).map(s)).concat(ta.range(Math.ceil(a/v)*v,o,v).filter(function(n){return ga(n%m)>Ca}).map(f))}var e,r,u,i,o,a,c,l,s,f,h,g,p=10,v=p,d=90,m=360,y=2.5;return n.lines=function(){return t().map(function(n){return{type:"LineString",coordinates:n}})},n.outline=function(){return{type:"Polygon",coordinates:[h(i).concat(g(c).slice(1),h(u).reverse().slice(1),g(l).reverse().slice(1))]}},n.extent=function(t){return arguments.length?n.majorExtent(t).minorExtent(t):n.minorExtent()},n.majorExtent=function(t){return arguments.length?(i=+t[0][0],u=+t[1][0],l=+t[0][1],c=+t[1][1],i>u&&(t=i,i=u,u=t),l>c&&(t=l,l=c,c=t),n.precision(y)):[[i,l],[u,c]]},n.minorExtent=function(t){return arguments.length?(r=+t[0][0],e=+t[1][0],a=+t[0][1],o=+t[1][1],r>e&&(t=r,r=e,e=t),a>o&&(t=a,a=o,o=t),n.precision(y)):[[r,a],[e,o]]},n.step=function(t){return arguments.length?n.majorStep(t).minorStep(t):n.minorStep()},n.majorStep=function(t){return arguments.length?(d=+t[0],m=+t[1],n):[d,m]},n.minorStep=function(t){return arguments.length?(p=+t[0],v=+t[1],n):[p,v]},n.precision=function(t){return arguments.length?(y=+t,s=vr(a,o,90),f=dr(r,e,y),h=vr(l,c,90),g=dr(i,u,y),n):y},n.majorExtent([[-180,-90+Ca],[180,90-Ca]]).minorExtent([[-180,-80-Ca],[180,80+Ca]])},ta.geo.greatArc=function(){function n(){return{type:"LineString",coordinates:[t||r.apply(this,arguments),e||u.apply(this,arguments)]}}var t,e,r=mr,u=yr;return n.distance=function(){return ta.geo.distance(t||r.apply(this,arguments),e||u.apply(this,arguments))},n.source=function(e){return arguments.length?(r=e,t="function"==typeof e?null:e,n):r},n.target=function(t){return arguments.length?(u=t,e="function"==typeof t?null:t,n):u},n.precision=function(){return arguments.length?n:0},n},ta.geo.interpolate=function(n,t){return Mr(n[0]*Da,n[1]*Da,t[0]*Da,t[1]*Da)},ta.geo.length=function(n){return Yc=0,ta.geo.stream(n,Zc),Yc};var Yc,Zc={sphere:b,point:b,lineStart:xr,lineEnd:b,polygonStart:b,polygonEnd:b},Vc=br(function(n){return Math.sqrt(2/(1+n))},function(n){return 2*Math.asin(n/2)});(ta.geo.azimuthalEqualArea=function(){return ur(Vc)}).raw=Vc;var Xc=br(function(n){var t=Math.acos(n);return t&&t/Math.sin(t)},y);(ta.geo.azimuthalEquidistant=function(){return ur(Xc)}).raw=Xc,(ta.geo.conicConformal=function(){return Ye(_r)}).raw=_r,(ta.geo.conicEquidistant=function(){return Ye(wr)}).raw=wr;var $c=br(function(n){return 1/n},Math.atan);(ta.geo.gnomonic=function(){return ur($c)}).raw=$c,Sr.invert=function(n,t){return[n,2*Math.atan(Math.exp(t))-Ra]},(ta.geo.mercator=function(){return kr(Sr)}).raw=Sr;var Bc=br(function(){return 1},Math.asin);(ta.geo.orthographic=function(){return ur(Bc)}).raw=Bc;var Wc=br(function(n){return 1/(1+n)},function(n){return 2*Math.atan(n)});(ta.geo.stereographic=function(){return ur(Wc)}).raw=Wc,Er.invert=function(n,t){return[-t,2*Math.atan(Math.exp(n))-Ra]},(ta.geo.transverseMercator=function(){var n=kr(Er),t=n.center,e=n.rotate;return n.center=function(n){return n?t([-n[1],n[0]]):(n=t(),[n[1],-n[0]])},n.rotate=function(n){return n?e([n[0],n[1],n.length>2?n[2]+90:90]):(n=e(),[n[0],n[1],n[2]-90])},e([0,0,90])}).raw=Er,ta.geom={},ta.geom.hull=function(n){function t(n){if(n.length<3){return[]}var t,u=Et(e),i=Et(r),o=n.length,a=[],c=[];for(t=0;o>t;t++){a.push([+u.call(this,n[t],t),+i.call(this,n[t],t),t])}for(a.sort(zr),t=0;o>t;t++){c.push([a[t][0],-a[t][1]])}var l=Cr(a),s=Cr(c),f=s[0]===l[0],h=s[s.length-1]===l[l.length-1],g=[];for(t=l.length-1;t>=0;--t){g.push(n[a[l[t]][2]])}for(t=+f;t<s.length-h;++t){g.push(n[a[s[t]][2]])}return g}var e=Ar,r=Nr;return arguments.length?t(n):(t.x=function(n){return arguments.length?(e=n,t):e},t.y=function(n){return arguments.length?(r=n,t):r},t)},ta.geom.polygon=function(n){return ya(n,Jc),n};var Jc=ta.geom.polygon.prototype=[];Jc.area=function(){for(var n,t=-1,e=this.length,r=this[e-1],u=0;++t<e;){n=r,r=this[t],u+=n[1]*r[0]-n[0]*r[1]}return 0.5*u},Jc.centroid=function(n){var t,e,r=-1,u=this.length,i=0,o=0,a=this[u-1];for(arguments.length||(n=-1/(6*this.area()));++r<u;){t=a,a=this[r],e=t[0]*a[1]-a[0]*t[1],i+=(t[0]+a[0])*e,o+=(t[1]+a[1])*e}return[i*n,o*n]},Jc.clip=function(n){for(var t,e,r,u,i,o,a=Tr(n),c=-1,l=this.length-Tr(this),s=this[l-1];++c<l;){for(t=n.slice(),n.length=0,u=this[c],i=t[(r=t.length-a)-1],e=-1;++e<r;){o=t[e],qr(o,s,u)?(qr(i,s,u)||n.push(Lr(i,o,s,u)),n.push(o)):qr(i,s,u)&&n.push(Lr(i,o,s,u)),i=o}a&&n.push(n[0]),s=u}return n};var Gc,Kc,Qc,nl,tl,el=[],rl=[];Or.prototype.prepare=function(){for(var n,t=this.edges,e=t.length;e--;){n=t[e].edge,n.b&&n.a||t.splice(e,1)}return t.sort(Yr),t.length},Qr.prototype={start:function(){return this.edge.l===this.site?this.edge.a:this.edge.b},end:function(){return this.edge.l===this.site?this.edge.b:this.edge.a}},nu.prototype={insert:function(n,t){var e,r,u;if(n){if(t.P=n,t.N=n.N,n.N&&(n.N.P=t),n.N=t,n.R){for(n=n.R;n.L;){n=n.L}n.L=t}else{n.R=t}e=n}else{this._?(n=uu(this._),t.P=null,t.N=n,n.P=n.L=t,e=n):(t.P=t.N=null,this._=t,e=null)}for(t.L=t.R=null,t.U=e,t.C=!0,n=t;e&&e.C;){r=e.U,e===r.L?(u=r.R,u&&u.C?(e.C=u.C=!1,r.C=!0,n=r):(n===e.R&&(eu(this,e),n=e,e=n.U),e.C=!1,r.C=!0,ru(this,r))):(u=r.L,u&&u.C?(e.C=u.C=!1,r.C=!0,n=r):(n===e.L&&(ru(this,e),n=e,e=n.U),e.C=!1,r.C=!0,eu(this,r))),e=n.U}this._.C=!1},remove:function(n){n.N&&(n.N.P=n.P),n.P&&(n.P.N=n.N),n.N=n.P=null;var t,e,r,u=n.U,i=n.L,o=n.R;if(e=i?o?uu(o):i:o,u?u.L===n?u.L=e:u.R=e:this._=e,i&&o?(r=e.C,e.C=n.C,e.L=i,i.U=e,e!==o?(u=e.U,e.U=n.U,n=e.R,u.L=n,e.R=o,o.U=e):(e.U=u,u=e,n=e.R)):(r=n.C,n=e),n&&(n.U=u),!r){if(n&&n.C){return void (n.C=!1)}do{if(n===this._){break}if(n===u.L){if(t=u.R,t.C&&(t.C=!1,u.C=!0,eu(this,u),t=u.R),t.L&&t.L.C||t.R&&t.R.C){t.R&&t.R.C||(t.L.C=!1,t.C=!0,ru(this,t),t=u.R),t.C=u.C,u.C=t.R.C=!1,eu(this,u),n=this._;break}}else{if(t=u.L,t.C&&(t.C=!1,u.C=!0,ru(this,u),t=u.L),t.L&&t.L.C||t.R&&t.R.C){t.L&&t.L.C||(t.R.C=!1,t.C=!0,eu(this,t),t=u.L),t.C=u.C,u.C=t.L.C=!1,ru(this,u),n=this._;break}}t.C=!0,n=u,u=u.U}while(!n.C);n&&(n.C=!1)}}},ta.geom.voronoi=function(n){function t(n){var t=new Array(n.length),r=a[0][0],u=a[0][1],i=a[1][0],o=a[1][1];return iu(e(n),a).cells.forEach(function(e,a){var c=e.edges,l=e.site,s=t[a]=c.length?c.map(function(n){var t=n.start();return[t.x,t.y]}):l.x>=r&&l.x<=i&&l.y>=u&&l.y<=o?[[r,o],[i,o],[i,u],[r,u]]:[];s.point=n[a]}),t}function e(n){return n.map(function(n,t){return{x:Math.round(i(n,t)/Ca)*Ca,y:Math.round(o(n,t)/Ca)*Ca,i:t}})}var r=Ar,u=Nr,i=r,o=u,a=ul;return n?t(n):(t.links=function(n){return iu(e(n)).edges.filter(function(n){return n.l&&n.r}).map(function(t){return{source:n[t.l.i],target:n[t.r.i]}})},t.triangles=function(n){var t=[];return iu(e(n)).cells.forEach(function(e,r){for(var u,i,o=e.site,a=e.edges.sort(Yr),c=-1,l=a.length,s=a[l-1].edge,f=s.l===o?s.r:s.l;++c<l;){u=s,i=f,s=a[c].edge,f=s.l===o?s.r:s.l,r<i.i&&r<f.i&&au(o,i,f)<0&&t.push([n[r],n[i.i],n[f.i]])}}),t},t.x=function(n){return arguments.length?(i=Et(r=n),t):r},t.y=function(n){return arguments.length?(o=Et(u=n),t):u},t.clipExtent=function(n){return arguments.length?(a=null==n?ul:n,t):a===ul?null:a},t.size=function(n){return arguments.length?t.clipExtent(n&&[[0,0],n]):a===ul?null:a&&a[1]},t)};var ul=[[-1000000,-1000000],[1000000,1000000]];ta.geom.delaunay=function(n){return ta.geom.voronoi().triangles(n)},ta.geom.quadtree=function(n,t,e,r,u){function i(n){function i(n,t,e,r,u,i,o,a){if(!isNaN(e)&&!isNaN(r)){if(n.leaf){var c=n.x,s=n.y;if(null!=c){if(ga(c-e)+ga(s-r)<0.01){l(n,t,e,r,u,i,o,a)}else{var f=n.point;n.x=n.y=n.point=null,l(n,f,c,s,u,i,o,a),l(n,t,e,r,u,i,o,a)}}else{n.x=e,n.y=r,n.point=t}}else{l(n,t,e,r,u,i,o,a)}}}function l(n,t,e,r,u,o,a,c){var l=0.5*(u+a),s=0.5*(o+c),f=e>=l,h=r>=s,g=h<<1|f;n.leaf=!1,n=n.nodes[g]||(n.nodes[g]=su()),f?u=l:a=l,h?o=s:c=s,i(n,t,e,r,u,o,a,c)}var s,f,h,g,p,v,d,m,y,M=Et(a),x=Et(c);if(null!=t){v=t,d=e,m=r,y=u}else{if(m=y=-(v=d=1/0),f=[],h=[],p=n.length,o){for(g=0;p>g;++g){s=n[g],s.x<v&&(v=s.x),s.y<d&&(d=s.y),s.x>m&&(m=s.x),s.y>y&&(y=s.y),f.push(s.x),h.push(s.y)}}else{for(g=0;p>g;++g){var b=+M(s=n[g],g),_=+x(s,g);v>b&&(v=b),d>_&&(d=_),b>m&&(m=b),_>y&&(y=_),f.push(b),h.push(_)}}}var w=m-v,S=y-d;w>S?y=d+w:m=v+S;var k=su();if(k.add=function(n){i(k,n,+M(n,++g),+x(n,g),v,d,m,y)},k.visit=function(n){fu(n,k,v,d,m,y)},k.find=function(n){return hu(k,n[0],n[1],v,d,m,y)},g=-1,null==t){for(;++g<p;){i(k,n[g],f[g],h[g],v,d,m,y)}--g}else{n.forEach(k.add)}return f=h=n=s=null,k}var o,a=Ar,c=Nr;return(o=arguments.length)?(a=cu,c=lu,3===o&&(u=e,r=t,e=t=0),i(n)):(i.x=function(n){return arguments.length?(a=n,i):a},i.y=function(n){return arguments.length?(c=n,i):c},i.extent=function(n){return arguments.length?(null==n?t=e=r=u=null:(t=+n[0][0],e=+n[0][1],r=+n[1][0],u=+n[1][1]),i):null==t?null:[[t,e],[r,u]]},i.size=function(n){return arguments.length?(null==n?t=e=r=u=null:(t=e=0,r=+n[0],u=+n[1]),i):null==t?null:[r-t,u-e]},i)},ta.interpolateRgb=gu,ta.interpolateObject=pu,ta.interpolateNumber=vu,ta.interpolateString=du;var il=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,ol=new RegExp(il.source,"g");ta.interpolate=mu,ta.interpolators=[function(n,t){var e=typeof t;return("string"===e?Ga.has(t)||/^(#|rgb\(|hsl\()/.test(t)?gu:du:t instanceof ot?gu:Array.isArray(t)?yu:"object"===e&&isNaN(t)?pu:vu)(n,t)}],ta.interpolateArray=yu;var al=function(){return y},cl=ta.map({linear:al,poly:ku,quad:function(){return _u},cubic:function(){return wu},sin:function(){return Eu},exp:function(){return Au},circle:function(){return Nu},elastic:Cu,back:zu,bounce:function(){return qu}}),ll=ta.map({"in":y,out:xu,"in-out":bu,"out-in":function(n){return bu(xu(n))}});ta.ease=function(n){var t=n.indexOf("-"),e=t>=0?n.slice(0,t):n,r=t>=0?n.slice(t+1):"in";return e=cl.get(e)||al,r=ll.get(r)||y,Mu(r(e.apply(null,ea.call(arguments,1))))},ta.interpolateHcl=Lu,ta.interpolateHsl=Tu,ta.interpolateLab=Ru,ta.interpolateRound=Du,ta.transform=function(n){var t=ua.createElementNS(ta.ns.prefix.svg,"g");return(ta.transform=function(n){if(null!=n){t.setAttribute("transform",n);var e=t.transform.baseVal.consolidate()}return new Pu(e?e.matrix:sl)})(n)},Pu.prototype.toString=function(){return"translate("+this.translate+")rotate("+this.rotate+")skewX("+this.skew+")scale("+this.scale+")"};var sl={a:1,b:0,c:0,d:1,e:0,f:0};ta.interpolateTransform=Hu,ta.layout={},ta.layout.bundle=function(){return function(n){for(var t=[],e=-1,r=n.length;++e<r;){t.push(Yu(n[e]))}return t}},ta.layout.chord=function(){function n(){var n,l,f,h,g,p={},v=[],d=ta.range(i),m=[];for(e=[],r=[],n=0,h=-1;++h<i;){for(l=0,g=-1;++g<i;){l+=u[h][g]}v.push(l),m.push(ta.range(i)),n+=l}for(o&&d.sort(function(n,t){return o(v[n],v[t])}),a&&m.forEach(function(n,t){n.sort(function(n,e){return a(u[t][n],u[t][e])})}),n=(La-s*i)/n,l=0,h=-1;++h<i;){for(f=l,g=-1;++g<i;){var y=d[h],M=m[y][g],x=u[y][M],b=l,_=l+=x*n;p[y+"-"+M]={index:y,subindex:M,startAngle:b,endAngle:_,value:x}}r[y]={index:y,startAngle:f,endAngle:l,value:(l-f)/n},l+=s}for(h=-1;++h<i;){for(g=h-1;++g<i;){var w=p[h+"-"+g],S=p[g+"-"+h];(w.value||S.value)&&e.push(w.value<S.value?{source:S,target:w}:{source:w,target:S})}}c&&t()}function t(){e.sort(function(n,t){return c((n.source.value+n.target.value)/2,(t.source.value+t.target.value)/2)})}var e,r,u,i,o,a,c,l={},s=0;return l.matrix=function(n){return arguments.length?(i=(u=n)&&u.length,e=r=null,l):u},l.padding=function(n){return arguments.length?(s=n,e=r=null,l):s},l.sortGroups=function(n){return arguments.length?(o=n,e=r=null,l):o},l.sortSubgroups=function(n){return arguments.length?(a=n,e=null,l):a},l.sortChords=function(n){return arguments.length?(c=n,e&&t(),l):c},l.chords=function(){return e||n(),e},l.groups=function(){return r||n(),r},l},ta.layout.force=function(){function n(n){return function(t,e,r,u){if(t.point!==n){var i=t.cx-n.x,o=t.cy-n.y,a=u-e,c=i*i+o*o;if(c>a*a/d){if(p>c){var l=t.charge/c;n.px-=i*l,n.py-=o*l}return !0}if(t.point&&c&&p>c){var l=t.pointCharge/c;n.px-=i*l,n.py-=o*l}}return !t.charge}}function t(n){n.px=ta.event.x,n.py=ta.event.y,a.resume()}var e,r,u,i,o,a={},c=ta.dispatch("start","tick","end"),l=[1,1],s=0.9,f=fl,h=hl,g=-30,p=gl,v=0.1,d=0.64,m=[],M=[];return a.tick=function(){if((r*=0.99)<0.005){return c.end({type:"end",alpha:r=0}),!0}var t,e,a,f,h,p,d,y,x,b=m.length,_=M.length;for(e=0;_>e;++e){a=M[e],f=a.source,h=a.target,y=h.x-f.x,x=h.y-f.y,(p=y*y+x*x)&&(p=r*i[e]*((p=Math.sqrt(p))-u[e])/p,y*=p,x*=p,h.x-=y*(d=f.weight/(h.weight+f.weight)),h.y-=x*d,f.x+=y*(d=1-d),f.y+=x*d)}if((d=r*v)&&(y=l[0]/2,x=l[1]/2,e=-1,d)){for(;++e<b;){a=m[e],a.x+=(y-a.x)*d,a.y+=(x-a.y)*d}}if(g){for(Ju(t=ta.geom.quadtree(m),r,o),e=-1;++e<b;){(a=m[e]).fixed||t.visit(n(a))}}for(e=-1;++e<b;){a=m[e],a.fixed?(a.x=a.px,a.y=a.py):(a.x-=(a.px-(a.px=a.x))*s,a.y-=(a.py-(a.py=a.y))*s)}c.tick({type:"tick",alpha:r})},a.nodes=function(n){return arguments.length?(m=n,a):m},a.links=function(n){return arguments.length?(M=n,a):M},a.size=function(n){return arguments.length?(l=n,a):l},a.linkDistance=function(n){return arguments.length?(f="function"==typeof n?n:+n,a):f},a.distance=a.linkDistance,a.linkStrength=function(n){return arguments.length?(h="function"==typeof n?n:+n,a):h},a.friction=function(n){return arguments.length?(s=+n,a):s},a.charge=function(n){return arguments.length?(g="function"==typeof n?n:+n,a):g},a.chargeDistance=function(n){return arguments.length?(p=n*n,a):Math.sqrt(p)},a.gravity=function(n){return arguments.length?(v=+n,a):v},a.theta=function(n){return arguments.length?(d=n*n,a):Math.sqrt(d)},a.alpha=function(n){return arguments.length?(n=+n,r?r=n>0?n:0:n>0&&(c.start({type:"start",alpha:r=n}),ta.timer(a.tick)),a):r},a.start=function(){function n(n,r){if(!e){for(e=new Array(c),a=0;c>a;++a){e[a]=[]}for(a=0;s>a;++a){var u=M[a];e[u.source.index].push(u.target),e[u.target.index].push(u.source)}}for(var i,o=e[t],a=-1,l=o.length;++a<l;){if(!isNaN(i=o[a][n])){return i}}return Math.random()*r}var t,e,r,c=m.length,s=M.length,p=l[0],v=l[1];for(t=0;c>t;++t){(r=m[t]).index=t,r.weight=0}for(t=0;s>t;++t){r=M[t],"number"==typeof r.source&&(r.source=m[r.source]),"number"==typeof r.target&&(r.target=m[r.target]),++r.source.weight,++r.target.weight}for(t=0;c>t;++t){r=m[t],isNaN(r.x)&&(r.x=n("x",p)),isNaN(r.y)&&(r.y=n("y",v)),isNaN(r.px)&&(r.px=r.x),isNaN(r.py)&&(r.py=r.y)}if(u=[],"function"==typeof f){for(t=0;s>t;++t){u[t]=+f.call(this,M[t],t)}}else{for(t=0;s>t;++t){u[t]=f}}if(i=[],"function"==typeof h){for(t=0;s>t;++t){i[t]=+h.call(this,M[t],t)}}else{for(t=0;s>t;++t){i[t]=h}}if(o=[],"function"==typeof g){for(t=0;c>t;++t){o[t]=+g.call(this,m[t],t)}}else{for(t=0;c>t;++t){o[t]=g}}return a.resume()},a.resume=function(){return a.alpha(0.1)},a.stop=function(){return a.alpha(0)},a.drag=function(){return e||(e=ta.behavior.drag().origin(y).on("dragstart.force",Xu).on("drag.force",t).on("dragend.force",$u)),arguments.length?void this.on("mouseover.force",Bu).on("mouseout.force",Wu).call(e):e},ta.rebind(a,c,"on")};var fl=20,hl=1,gl=1/0;ta.layout.hierarchy=function(){function n(u){var i,o=[u],a=[];for(u.depth=0;null!=(i=o.pop());){if(a.push(i),(l=e.call(n,i,i.depth))&&(c=l.length)){for(var c,l,s;--c>=0;){o.push(s=l[c]),s.parent=i,s.depth=i.depth+1}r&&(i.value=0),i.children=l}else{r&&(i.value=+r.call(n,i,i.depth)||0),delete i.children}}return Qu(u,function(n){var e,u;t&&(e=n.children)&&e.sort(t),r&&(u=n.parent)&&(u.value+=n.value)}),a}var t=ei,e=ni,r=ti;return n.sort=function(e){return arguments.length?(t=e,n):t},n.children=function(t){return arguments.length?(e=t,n):e},n.value=function(t){return arguments.length?(r=t,n):r},n.revalue=function(t){return r&&(Ku(t,function(n){n.children&&(n.value=0)}),Qu(t,function(t){var e;t.children||(t.value=+r.call(n,t,t.depth)||0),(e=t.parent)&&(e.value+=t.value)})),t},n},ta.layout.partition=function(){function n(t,e,r,u){var i=t.children;if(t.x=e,t.y=t.depth*u,t.dx=r,t.dy=u,i&&(o=i.length)){var o,a,c,l=-1;for(r=t.value?r/t.value:0;++l<o;){n(a=i[l],e,c=a.value*r,u),e+=c}}}function t(n){var e=n.children,r=0;if(e&&(u=e.length)){for(var u,i=-1;++i<u;){r=Math.max(r,t(e[i]))}}return 1+r}function e(e,i){var o=r.call(this,e,i);return n(o[0],0,u[0],u[1]/t(o[0])),o}var r=ta.layout.hierarchy(),u=[1,1];return e.size=function(n){return arguments.length?(u=n,e):u},Gu(e,r)},ta.layout.pie=function(){function n(o){var a,c=o.length,l=o.map(function(e,r){return +t.call(n,e,r)}),s=+("function"==typeof r?r.apply(this,arguments):r),f=("function"==typeof u?u.apply(this,arguments):u)-s,h=Math.min(Math.abs(f)/c,+("function"==typeof i?i.apply(this,arguments):i)),g=h*(0>f?-1:1),p=(f-c*g)/ta.sum(l),v=ta.range(c),d=[];return null!=e&&v.sort(e===pl?function(n,t){return l[t]-l[n]}:function(n,t){return e(o[n],o[t])}),v.forEach(function(n){d[n]={data:o[n],value:a=l[n],startAngle:s,endAngle:s+=a*p+g,padAngle:h}}),d}var t=Number,e=pl,r=0,u=La,i=0;return n.value=function(e){return arguments.length?(t=e,n):t},n.sort=function(t){return arguments.length?(e=t,n):e},n.startAngle=function(t){return arguments.length?(r=t,n):r},n.endAngle=function(t){return arguments.length?(u=t,n):u},n.padAngle=function(t){return arguments.length?(i=t,n):i},n};var pl={};ta.layout.stack=function(){function n(a,c){if(!(h=a.length)){return a}var l=a.map(function(e,r){return t.call(n,e,r)}),s=l.map(function(t){return t.map(function(t,e){return[i.call(n,t,e),o.call(n,t,e)]})}),f=e.call(n,s,c);l=ta.permute(l,f),s=ta.permute(s,f);var h,g,p,v,d=r.call(n,s,c),m=l[0].length;for(p=0;m>p;++p){for(u.call(n,l[0][p],v=d[p],s[0][p][1]),g=1;h>g;++g){u.call(n,l[g][p],v+=s[g-1][p][1],s[g][p][1])}}return a}var t=y,e=ai,r=ci,u=oi,i=ui,o=ii;return n.values=function(e){return arguments.length?(t=e,n):t},n.order=function(t){return arguments.length?(e="function"==typeof t?t:vl.get(t)||ai,n):e},n.offset=function(t){return arguments.length?(r="function"==typeof t?t:dl.get(t)||ci,n):r},n.x=function(t){return arguments.length?(i=t,n):i},n.y=function(t){return arguments.length?(o=t,n):o},n.out=function(t){return arguments.length?(u=t,n):u},n};var vl=ta.map({"inside-out":function(n){var t,e,r=n.length,u=n.map(li),i=n.map(si),o=ta.range(r).sort(function(n,t){return u[n]-u[t]}),a=0,c=0,l=[],s=[];for(t=0;r>t;++t){e=o[t],c>a?(a+=i[e],l.push(e)):(c+=i[e],s.push(e))}return s.reverse().concat(l)},reverse:function(n){return ta.range(n.length).reverse()},"default":ai}),dl=ta.map({silhouette:function(n){var t,e,r,u=n.length,i=n[0].length,o=[],a=0,c=[];for(e=0;i>e;++e){for(t=0,r=0;u>t;t++){r+=n[t][e][1]}r>a&&(a=r),o.push(r)}for(e=0;i>e;++e){c[e]=(a-o[e])/2}return c},wiggle:function(n){var t,e,r,u,i,o,a,c,l,s=n.length,f=n[0],h=f.length,g=[];for(g[0]=c=l=0,e=1;h>e;++e){for(t=0,u=0;s>t;++t){u+=n[t][e][1]}for(t=0,i=0,a=f[e][0]-f[e-1][0];s>t;++t){for(r=0,o=(n[t][e][1]-n[t][e-1][1])/(2*a);t>r;++r){o+=(n[r][e][1]-n[r][e-1][1])/a}i+=o*n[t][e][1]}g[e]=c-=u?i/u*a:0,l>c&&(l=c)}for(e=0;h>e;++e){g[e]-=l}return g},expand:function(n){var t,e,r,u=n.length,i=n[0].length,o=1/u,a=[];for(e=0;i>e;++e){for(t=0,r=0;u>t;t++){r+=n[t][e][1]}if(r){for(t=0;u>t;t++){n[t][e][1]/=r}}else{for(t=0;u>t;t++){n[t][e][1]=o}}}for(e=0;i>e;++e){a[e]=0}return a},zero:ci});ta.layout.histogram=function(){function n(n,i){for(var o,a,c=[],l=n.map(e,this),s=r.call(this,l,i),f=u.call(this,s,l,i),i=-1,h=l.length,g=f.length-1,p=t?1:1/h;++i<g;){o=c[i]=[],o.dx=f[i+1]-(o.x=f[i]),o.y=0}if(g>0){for(i=-1;++i<h;){a=l[i],a>=s[0]&&a<=s[1]&&(o=c[ta.bisect(f,a,1,g)-1],o.y+=p,o.push(n[i]))}}return c}var t=!0,e=Number,r=pi,u=hi;return n.value=function(t){return arguments.length?(e=t,n):e},n.range=function(t){return arguments.length?(r=Et(t),n):r},n.bins=function(t){return arguments.length?(u="number"==typeof t?function(n){return gi(n,t)}:Et(t),n):u},n.frequency=function(e){return arguments.length?(t=!!e,n):t},n},ta.layout.pack=function(){function n(n,i){var o=e.call(this,n,i),a=o[0],c=u[0],l=u[1],s=null==t?Math.sqrt:"function"==typeof t?t:function(){return t};if(a.x=a.y=0,Qu(a,function(n){n.r=+s(n.value)}),Qu(a,Mi),r){var f=r*(t?1:Math.max(2*a.r/c,2*a.r/l))/2;Qu(a,function(n){n.r+=f}),Qu(a,Mi),Qu(a,function(n){n.r-=f})}return _i(a,c/2,l/2,t?1:1/Math.max(2*a.r/c,2*a.r/l)),o}var t,e=ta.layout.hierarchy().sort(vi),r=0,u=[1,1];return n.size=function(t){return arguments.length?(u=t,n):u},n.radius=function(e){return arguments.length?(t=null==e||"function"==typeof e?e:+e,n):t},n.padding=function(t){return arguments.length?(r=+t,n):r},Gu(n,e)},ta.layout.tree=function(){function n(n,u){var s=o.call(this,n,u),f=s[0],h=t(f);if(Qu(h,e),h.parent.m=-h.z,Ku(h,r),l){Ku(f,i)}else{var g=f,p=f,v=f;Ku(f,function(n){n.x<g.x&&(g=n),n.x>p.x&&(p=n),n.depth>v.depth&&(v=n)});var d=a(g,p)/2-g.x,m=c[0]/(p.x+a(p,g)/2+d),y=c[1]/(v.depth||1);Ku(f,function(n){n.x=(n.x+d)*m,n.y=n.depth*y})}return s}function t(n){for(var t,e={A:null,children:[n]},r=[e];null!=(t=r.pop());){for(var u,i=t.children,o=0,a=i.length;a>o;++o){r.push((i[o]=u={_:i[o],parent:t,children:(u=i[o].children)&&u.slice()||[],A:null,a:null,z:0,m:0,c:0,s:0,t:null,i:o}).a=u)}}return e.children[0]}function e(n){var t=n.children,e=n.parent.children,r=n.i?e[n.i-1]:null;if(t.length){Ni(n);var i=(t[0].z+t[t.length-1].z)/2;r?(n.z=r.z+a(n._,r._),n.m=n.z-i):n.z=i}else{r&&(n.z=r.z+a(n._,r._))}n.parent.A=u(n,r,n.parent.A||e[0])}function r(n){n._.x=n.z+n.parent.m,n.m+=n.parent.m}function u(n,t,e){if(t){for(var r,u=n,i=n,o=t,c=u.parent.children[0],l=u.m,s=i.m,f=o.m,h=c.m;o=Ei(o),u=ki(u),o&&u;){c=ki(c),i=Ei(i),i.a=n,r=o.z+f-u.z-l+a(o._,u._),r>0&&(Ai(Ci(o,n,e),n,r),l+=r,s+=r),f+=o.m,l+=u.m,h+=c.m,s+=i.m}o&&!Ei(i)&&(i.t=o,i.m+=f-s),u&&!ki(c)&&(c.t=u,c.m+=l-h,e=n)}return e}function i(n){n.x*=c[0],n.y=n.depth*c[1]}var o=ta.layout.hierarchy().sort(null).value(null),a=Si,c=[1,1],l=null;return n.separation=function(t){return arguments.length?(a=t,n):a},n.size=function(t){return arguments.length?(l=null==(c=t)?i:null,n):l?null:c},n.nodeSize=function(t){return arguments.length?(l=null==(c=t)?null:i,n):l?c:null},Gu(n,o)},ta.layout.cluster=function(){function n(n,i){var o,a=t.call(this,n,i),c=a[0],l=0;Qu(c,function(n){var t=n.children;t&&t.length?(n.x=qi(t),n.y=zi(t)):(n.x=o?l+=e(n,o):0,n.y=0,o=n)});var s=Li(c),f=Ti(c),h=s.x-e(s,f)/2,g=f.x+e(f,s)/2;return Qu(c,u?function(n){n.x=(n.x-c.x)*r[0],n.y=(c.y-n.y)*r[1]}:function(n){n.x=(n.x-h)/(g-h)*r[0],n.y=(1-(c.y?n.y/c.y:1))*r[1]}),a}var t=ta.layout.hierarchy().sort(null).value(null),e=Si,r=[1,1],u=!1;return n.separation=function(t){return arguments.length?(e=t,n):e},n.size=function(t){return arguments.length?(u=null==(r=t),n):u?null:r},n.nodeSize=function(t){return arguments.length?(u=null!=(r=t),n):u?r:null},Gu(n,t)},ta.layout.treemap=function(){function n(n,t){for(var e,r,u=-1,i=n.length;++u<i;){r=(e=n[u]).value*(0>t?0:t),e.area=isNaN(r)||0>=r?0:r}}function t(e){var i=e.children;if(i&&i.length){var o,a,c,l=f(e),s=[],h=i.slice(),p=1/0,v="slice"===g?l.dx:"dice"===g?l.dy:"slice-dice"===g?1&e.depth?l.dy:l.dx:Math.min(l.dx,l.dy);for(n(h,l.dx*l.dy/e.value),s.area=0;(c=h.length)>0;){s.push(o=h[c-1]),s.area+=o.area,"squarify"!==g||(a=r(s,v))<=p?(h.pop(),p=a):(s.area-=s.pop().area,u(s,v,l,!1),v=Math.min(l.dx,l.dy),s.length=s.area=0,p=1/0)}s.length&&(u(s,v,l,!0),s.length=s.area=0),i.forEach(t)}}function e(t){var r=t.children;if(r&&r.length){var i,o=f(t),a=r.slice(),c=[];for(n(a,o.dx*o.dy/t.value),c.area=0;i=a.pop();){c.push(i),c.area+=i.area,null!=i.z&&(u(c,i.z?o.dx:o.dy,o,!a.length),c.length=c.area=0)}r.forEach(e)}}function r(n,t){for(var e,r=n.area,u=0,i=1/0,o=-1,a=n.length;++o<a;){(e=n[o].area)&&(i>e&&(i=e),e>u&&(u=e))}return r*=r,t*=t,r?Math.max(t*u*p/r,r/(t*i*p)):1/0}function u(n,t,e,r){var u,i=-1,o=n.length,a=e.x,l=e.y,s=t?c(n.area/t):0;if(t==e.dx){for((r||s>e.dy)&&(s=e.dy);++i<o;){u=n[i],u.x=a,u.y=l,u.dy=s,a+=u.dx=Math.min(e.x+e.dx-a,s?c(u.area/s):0)}u.z=!0,u.dx+=e.x+e.dx-a,e.y+=s,e.dy-=s}else{for((r||s>e.dx)&&(s=e.dx);++i<o;){u=n[i],u.x=a,u.y=l,u.dx=s,l+=u.dy=Math.min(e.y+e.dy-l,s?c(u.area/s):0)}u.z=!1,u.dy+=e.y+e.dy-l,e.x+=s,e.dx-=s}}function i(r){var u=o||a(r),i=u[0];return i.x=0,i.y=0,i.dx=l[0],i.dy=l[1],o&&a.revalue(i),n([i],i.dx*i.dy/i.value),(o?e:t)(i),h&&(o=u),u}var o,a=ta.layout.hierarchy(),c=Math.round,l=[1,1],s=null,f=Ri,h=!1,g="squarify",p=0.5*(1+Math.sqrt(5));return i.size=function(n){return arguments.length?(l=n,i):l},i.padding=function(n){function t(t){var e=n.call(i,t,t.depth);return null==e?Ri(t):Di(t,"number"==typeof e?[e,e,e,e]:e)}function e(t){return Di(t,n)}if(!arguments.length){return s}var r;return f=null==(s=n)?Ri:"function"==(r=typeof n)?t:"number"===r?(n=[n,n,n,n],e):e,i},i.round=function(n){return arguments.length?(c=n?Math.round:Number,i):c!=Number},i.sticky=function(n){return arguments.length?(h=n,o=null,i):h},i.ratio=function(n){return arguments.length?(p=n,i):p},i.mode=function(n){return arguments.length?(g=n+"",i):g},Gu(i,a)},ta.random={normal:function(n,t){var e=arguments.length;return 2>e&&(t=1),1>e&&(n=0),function(){var e,r,u;do{e=2*Math.random()-1,r=2*Math.random()-1,u=e*e+r*r}while(!u||u>1);return n+t*e*Math.sqrt(-2*Math.log(u)/u)}},logNormal:function(){var n=ta.random.normal.apply(ta,arguments);return function(){return Math.exp(n())}},bates:function(n){var t=ta.random.irwinHall(n);return function(){return t()/n}},irwinHall:function(n){return function(){for(var t=0,e=0;n>e;e++){t+=Math.random()}return t}}},ta.scale={};var ml={floor:y,ceil:y};ta.scale.linear=function(){return Ii([0,1],[0,1],mu,!1)};var yl={s:1,g:1,p:1,r:1,e:1};ta.scale.log=function(){return Ji(ta.scale.linear().domain([0,1]),10,!0,[1,10])};var Ml=ta.format(".0e"),xl={floor:function(n){return -Math.ceil(-n)},ceil:function(n){return -Math.floor(-n)}};ta.scale.pow=function(){return Gi(ta.scale.linear(),1,[0,1])},ta.scale.sqrt=function(){return ta.scale.pow().exponent(0.5)},ta.scale.ordinal=function(){return Qi([],{t:"range",a:[[]]})},ta.scale.category10=function(){return ta.scale.ordinal().range(bl)},ta.scale.category20=function(){return ta.scale.ordinal().range(_l)},ta.scale.category20b=function(){return ta.scale.ordinal().range(wl)},ta.scale.category20c=function(){return ta.scale.ordinal().range(Sl)};var bl=[2062260,16744206,2924588,14034728,9725885,9197131,14907330,8355711,12369186,1556175].map(Mt),_l=[2062260,11454440,16744206,16759672,2924588,10018698,14034728,16750742,9725885,12955861,9197131,12885140,14907330,16234194,8355711,13092807,12369186,14408589,1556175,10410725].map(Mt),wl=[3750777,5395619,7040719,10264286,6519097,9216594,11915115,13556636,9202993,12426809,15186514,15190932,8666169,11356490,14049643,15177372,8077683,10834324,13528509,14589654].map(Mt),Sl=[3244733,7057110,10406625,13032431,15095053,16616764,16625259,16634018,3253076,7652470,10607003,13101504,7695281,10394312,12369372,14342891,6513507,9868950,12434877,14277081].map(Mt);ta.scale.quantile=function(){return no([],[])},ta.scale.quantize=function(){return to(0,1,[0,1])},ta.scale.threshold=function(){return eo([0.5],[0,1])},ta.scale.identity=function(){return ro([0,1])},ta.svg={},ta.svg.arc=function(){function n(){var n=Math.max(0,+e.apply(this,arguments)),l=Math.max(0,+r.apply(this,arguments)),s=o.apply(this,arguments)-Ra,f=a.apply(this,arguments)-Ra,h=Math.abs(f-s),g=s>f?0:1;if(n>l&&(p=l,l=n,n=p),h>=Ta){return t(l,g)+(n?t(n,1-g):"")+"Z"}var p,v,d,m,y,M,x,b,_,w,S,k,E=0,A=0,N=[];if((m=(+c.apply(this,arguments)||0)/2)&&(d=i===kl?Math.sqrt(n*n+l*l):+i.apply(this,arguments),g||(A*=-1),l&&(A=tt(d/l*Math.sin(m))),n&&(E=tt(d/n*Math.sin(m)))),l){y=l*Math.cos(s+A),M=l*Math.sin(s+A),x=l*Math.cos(f-A),b=l*Math.sin(f-A);var C=Math.abs(f-s-2*A)<=qa?0:1;if(A&&so(y,M,x,b)===g^C){var z=(s+f)/2;y=l*Math.cos(z),M=l*Math.sin(z),x=b=null}}else{y=M=0}if(n){_=n*Math.cos(f-E),w=n*Math.sin(f-E),S=n*Math.cos(s+E),k=n*Math.sin(s+E);var q=Math.abs(s-f+2*E)<=qa?0:1;if(E&&so(_,w,S,k)===1-g^q){var L=(s+f)/2;_=n*Math.cos(L),w=n*Math.sin(L),S=k=null}}else{_=w=0}if((p=Math.min(Math.abs(l-n)/2,+u.apply(this,arguments)))>0.001){v=l>n^g?0:1;var T=null==S?[_,w]:null==x?[y,M]:Lr([y,M],[S,k],[x,b],[_,w]),R=y-T[0],D=M-T[1],P=x-T[0],U=b-T[1],j=1/Math.sin(Math.acos((R*P+D*U)/(Math.sqrt(R*R+D*D)*Math.sqrt(P*P+U*U)))/2),F=Math.sqrt(T[0]*T[0]+T[1]*T[1]);if(null!=x){var H=Math.min(p,(l-F)/(j+1)),O=fo(null==S?[_,w]:[S,k],[y,M],l,H,g),I=fo([x,b],[_,w],l,H,g);p===H?N.push("M",O[0],"A",H,",",H," 0 0,",v," ",O[1],"A",l,",",l," 0 ",1-g^so(O[1][0],O[1][1],I[1][0],I[1][1]),",",g," ",I[1],"A",H,",",H," 0 0,",v," ",I[0]):N.push("M",O[0],"A",H,",",H," 0 1,",v," ",I[0])}else{N.push("M",y,",",M)}if(null!=S){var Y=Math.min(p,(n-F)/(j-1)),Z=fo([y,M],[S,k],n,-Y,g),V=fo([_,w],null==x?[y,M]:[x,b],n,-Y,g);p===Y?N.push("L",V[0],"A",Y,",",Y," 0 0,",v," ",V[1],"A",n,",",n," 0 ",g^so(V[1][0],V[1][1],Z[1][0],Z[1][1]),",",1-g," ",Z[1],"A",Y,",",Y," 0 0,",v," ",Z[0]):N.push("L",V[0],"A",Y,",",Y," 0 0,",v," ",Z[0])}else{N.push("L",_,",",w)}}else{N.push("M",y,",",M),null!=x&&N.push("A",l,",",l," 0 ",C,",",g," ",x,",",b),N.push("L",_,",",w),null!=S&&N.push("A",n,",",n," 0 ",q,",",1-g," ",S,",",k)}return N.push("Z"),N.join("")}function t(n,t){return"M0,"+n+"A"+n+","+n+" 0 1,"+t+" 0,"+-n+"A"+n+","+n+" 0 1,"+t+" 0,"+n}var e=io,r=oo,u=uo,i=kl,o=ao,a=co,c=lo;return n.innerRadius=function(t){return arguments.length?(e=Et(t),n):e},n.outerRadius=function(t){return arguments.length?(r=Et(t),n):r},n.cornerRadius=function(t){return arguments.length?(u=Et(t),n):u},n.padRadius=function(t){return arguments.length?(i=t==kl?kl:Et(t),n):i},n.startAngle=function(t){return arguments.length?(o=Et(t),n):o},n.endAngle=function(t){return arguments.length?(a=Et(t),n):a},n.padAngle=function(t){return arguments.length?(c=Et(t),n):c},n.centroid=function(){var n=(+e.apply(this,arguments)+ +r.apply(this,arguments))/2,t=(+o.apply(this,arguments)+ +a.apply(this,arguments))/2-Ra;return[Math.cos(t)*n,Math.sin(t)*n]},n};var kl="auto";ta.svg.line=function(){return ho(y)};var El=ta.map({linear:go,"linear-closed":po,step:vo,"step-before":mo,"step-after":yo,basis:So,"basis-open":ko,"basis-closed":Eo,bundle:Ao,cardinal:bo,"cardinal-open":Mo,"cardinal-closed":xo,monotone:To});El.forEach(function(n,t){t.key=n,t.closed=/-closed$/.test(n)});var Al=[0,2/3,1/3,0],Nl=[0,1/3,2/3,0],Cl=[0,1/6,2/3,1/6];ta.svg.line.radial=function(){var n=ho(Ro);return n.radius=n.x,delete n.x,n.angle=n.y,delete n.y,n},mo.reverse=yo,yo.reverse=mo,ta.svg.area=function(){return Do(y)},ta.svg.area.radial=function(){var n=Do(Ro);return n.radius=n.x,delete n.x,n.innerRadius=n.x0,delete n.x0,n.outerRadius=n.x1,delete n.x1,n.angle=n.y,delete n.y,n.startAngle=n.y0,delete n.y0,n.endAngle=n.y1,delete n.y1,n},ta.svg.chord=function(){function n(n,a){var c=t(this,i,n,a),l=t(this,o,n,a);return"M"+c.p0+r(c.r,c.p1,c.a1-c.a0)+(e(c,l)?u(c.r,c.p1,c.r,c.p0):u(c.r,c.p1,l.r,l.p0)+r(l.r,l.p1,l.a1-l.a0)+u(l.r,l.p1,c.r,c.p0))+"Z"}function t(n,t,e,r){var u=t.call(n,e,r),i=a.call(n,u,r),o=c.call(n,u,r)-Ra,s=l.call(n,u,r)-Ra;return{r:i,a0:o,a1:s,p0:[i*Math.cos(o),i*Math.sin(o)],p1:[i*Math.cos(s),i*Math.sin(s)]}}function e(n,t){return n.a0==t.a0&&n.a1==t.a1}function r(n,t,e){return"A"+n+","+n+" 0 "+ +(e>qa)+",1 "+t}function u(n,t,e,r){return"Q 0,0 "+r}var i=mr,o=yr,a=Po,c=ao,l=co;return n.radius=function(t){return arguments.length?(a=Et(t),n):a},n.source=function(t){return arguments.length?(i=Et(t),n):i},n.target=function(t){return arguments.length?(o=Et(t),n):o},n.startAngle=function(t){return arguments.length?(c=Et(t),n):c},n.endAngle=function(t){return arguments.length?(l=Et(t),n):l},n},ta.svg.diagonal=function(){function n(n,u){var i=t.call(this,n,u),o=e.call(this,n,u),a=(i.y+o.y)/2,c=[i,{x:i.x,y:a},{x:o.x,y:a},o];return c=c.map(r),"M"+c[0]+"C"+c[1]+" "+c[2]+" "+c[3]}var t=mr,e=yr,r=Uo;return n.source=function(e){return arguments.length?(t=Et(e),n):t},n.target=function(t){return arguments.length?(e=Et(t),n):e},n.projection=function(t){return arguments.length?(r=t,n):r},n},ta.svg.diagonal.radial=function(){var n=ta.svg.diagonal(),t=Uo,e=n.projection;return n.projection=function(n){return arguments.length?e(jo(t=n)):t},n},ta.svg.symbol=function(){function n(n,r){return(zl.get(t.call(this,n,r))||Oo)(e.call(this,n,r))}var t=Ho,e=Fo;return n.type=function(e){return arguments.length?(t=Et(e),n):t},n.size=function(t){return arguments.length?(e=Et(t),n):e},n};var zl=ta.map({circle:Oo,cross:function(n){var t=Math.sqrt(n/5)/2;return"M"+-3*t+","+-t+"H"+-t+"V"+-3*t+"H"+t+"V"+-t+"H"+3*t+"V"+t+"H"+t+"V"+3*t+"H"+-t+"V"+t+"H"+-3*t+"Z"},diamond:function(n){var t=Math.sqrt(n/(2*Ll)),e=t*Ll;return"M0,"+-t+"L"+e+",0 0,"+t+" "+-e+",0Z"},square:function(n){var t=Math.sqrt(n)/2;return"M"+-t+","+-t+"L"+t+","+-t+" "+t+","+t+" "+-t+","+t+"Z"},"triangle-down":function(n){var t=Math.sqrt(n/ql),e=t*ql/2;return"M0,"+e+"L"+t+","+-e+" "+-t+","+-e+"Z"},"triangle-up":function(n){var t=Math.sqrt(n/ql),e=t*ql/2;return"M0,"+-e+"L"+t+","+e+" "+-t+","+e+"Z"}});ta.svg.symbolTypes=zl.keys();var ql=Math.sqrt(3),Ll=Math.tan(30*Da);_a.transition=function(n){for(var t,e,r=Tl||++Ul,u=Xo(n),i=[],o=Rl||{time:Date.now(),ease:Su,delay:0,duration:250},a=-1,c=this.length;++a<c;){i.push(t=[]);for(var l=this[a],s=-1,f=l.length;++s<f;){(e=l[s])&&$o(e,s,u,r,o),t.push(e)}}return Yo(i,u,r)},_a.interrupt=function(n){return this.each(null==n?Dl:Io(Xo(n)))};var Tl,Rl,Dl=Io(Xo()),Pl=[],Ul=0;Pl.call=_a.call,Pl.empty=_a.empty,Pl.node=_a.node,Pl.size=_a.size,ta.transition=function(n,t){return n&&n.transition?Tl?n.transition(t):n:ta.selection().transition(n)},ta.transition.prototype=Pl,Pl.select=function(n){var t,e,r,u=this.id,i=this.namespace,o=[];n=N(n);for(var a=-1,c=this.length;++a<c;){o.push(t=[]);for(var l=this[a],s=-1,f=l.length;++s<f;){(r=l[s])&&(e=n.call(r,r.__data__,s,a))?("__data__" in r&&(e.__data__=r.__data__),$o(e,s,i,u,r[i][u]),t.push(e)):t.push(null)}}return Yo(o,i,u)},Pl.selectAll=function(n){var t,e,r,u,i,o=this.id,a=this.namespace,c=[];n=C(n);for(var l=-1,s=this.length;++l<s;){for(var f=this[l],h=-1,g=f.length;++h<g;){if(r=f[h]){i=r[a][o],e=n.call(r,r.__data__,h,l),c.push(t=[]);for(var p=-1,v=e.length;++p<v;){(u=e[p])&&$o(u,p,a,o,i),t.push(u)}}}}return Yo(c,a,o)},Pl.filter=function(n){var t,e,r,u=[];"function"!=typeof n&&(n=O(n));for(var i=0,o=this.length;o>i;i++){u.push(t=[]);for(var e=this[i],a=0,c=e.length;c>a;a++){(r=e[a])&&n.call(r,r.__data__,a,i)&&t.push(r)}}return Yo(u,this.namespace,this.id)},Pl.tween=function(n,t){var e=this.id,r=this.namespace;return arguments.length<2?this.node()[r][e].tween.get(n):Y(this,null==t?function(t){t[r][e].tween.remove(n)}:function(u){u[r][e].tween.set(n,t)})},Pl.attr=function(n,t){function e(){this.removeAttribute(a)}function r(){this.removeAttributeNS(a.space,a.local)}function u(n){return null==n?e:(n+="",function(){var t,e=this.getAttribute(a);return e!==n&&(t=o(e,n),function(n){this.setAttribute(a,t(n))})})}function i(n){return null==n?r:(n+="",function(){var t,e=this.getAttributeNS(a.space,a.local);return e!==n&&(t=o(e,n),function(n){this.setAttributeNS(a.space,a.local,t(n))})})}if(arguments.length<2){for(t in n){this.attr(t,n[t])}return this}var o="transform"==n?Hu:mu,a=ta.ns.qualify(n);return Zo(this,"attr."+n,t,a.local?i:u)},Pl.attrTween=function(n,t){function e(n,e){var r=t.call(this,n,e,this.getAttribute(u));return r&&function(n){this.setAttribute(u,r(n))}}function r(n,e){var r=t.call(this,n,e,this.getAttributeNS(u.space,u.local));return r&&function(n){this.setAttributeNS(u.space,u.local,r(n))}}var u=ta.ns.qualify(n);return this.tween("attr."+n,u.local?r:e)},Pl.style=function(n,e,r){function u(){this.style.removeProperty(n)}function i(e){return null==e?u:(e+="",function(){var u,i=t(this).getComputedStyle(this,null).getPropertyValue(n);return i!==e&&(u=mu(i,e),function(t){this.style.setProperty(n,u(t),r)})})}var o=arguments.length;if(3>o){if("string"!=typeof n){2>o&&(e="");for(r in n){this.style(r,n[r],e)}return this}r=""}return Zo(this,"style."+n,e,i)},Pl.styleTween=function(n,e,r){function u(u,i){var o=e.call(this,u,i,t(this).getComputedStyle(this,null).getPropertyValue(n));return o&&function(t){this.style.setProperty(n,o(t),r)}}return arguments.length<3&&(r=""),this.tween("style."+n,u)},Pl.text=function(n){return Zo(this,"text",n,Vo)},Pl.remove=function(){var n=this.namespace;return this.each("end.transition",function(){var t;this[n].count<2&&(t=this.parentNode)&&t.removeChild(this)})},Pl.ease=function(n){var t=this.id,e=this.namespace;return arguments.length<1?this.node()[e][t].ease:("function"!=typeof n&&(n=ta.ease.apply(ta,arguments)),Y(this,function(r){r[e][t].ease=n}))},Pl.delay=function(n){var t=this.id,e=this.namespace;return arguments.length<1?this.node()[e][t].delay:Y(this,"function"==typeof n?function(r,u,i){r[e][t].delay=+n.call(r,r.__data__,u,i)}:(n=+n,function(r){r[e][t].delay=n}))},Pl.duration=function(n){var t=this.id,e=this.namespace;return arguments.length<1?this.node()[e][t].duration:Y(this,"function"==typeof n?function(r,u,i){r[e][t].duration=Math.max(1,n.call(r,r.__data__,u,i))}:(n=Math.max(1,n),function(r){r[e][t].duration=n}))},Pl.each=function(n,t){var e=this.id,r=this.namespace;if(arguments.length<2){var u=Rl,i=Tl;try{Tl=e,Y(this,function(t,u,i){Rl=t[r][e],n.call(t,t.__data__,u,i)})}finally{Rl=u,Tl=i}}else{Y(this,function(u){var i=u[r][e];(i.event||(i.event=ta.dispatch("start","end","interrupt"))).on(n,t)})}return this},Pl.transition=function(){for(var n,t,e,r,u=this.id,i=++Ul,o=this.namespace,a=[],c=0,l=this.length;l>c;c++){a.push(n=[]);for(var t=this[c],s=0,f=t.length;f>s;s++){(e=t[s])&&(r=e[o][u],$o(e,s,o,i,{time:r.time,ease:r.ease,delay:r.delay+r.duration,duration:r.duration})),n.push(e)}}return Yo(a,o,i)},ta.svg.axis=function(){function n(n){n.each(function(){var n,l=ta.select(this),s=this.__chart__||e,f=this.__chart__=e.copy(),h=null==c?f.ticks?f.ticks.apply(f,a):f.domain():c,g=null==t?f.tickFormat?f.tickFormat.apply(f,a):y:t,p=l.selectAll(".tick").data(h,f),v=p.enter().insert("g",".domain").attr("class","tick").style("opacity",Ca),d=ta.transition(p.exit()).style("opacity",Ca).remove(),m=ta.transition(p.order()).style("opacity",1),M=Math.max(u,0)+o,x=Ui(f),b=l.selectAll(".domain").data([0]),_=(b.enter().append("path").attr("class","domain"),ta.transition(b));v.append("line"),v.append("text");var w,S,k,E,A=v.select("line"),N=m.select("line"),C=p.select("text").text(g),z=v.select("text"),q=m.select("text"),L="top"===r||"left"===r?-1:1;if("bottom"===r||"top"===r?(n=Bo,w="x",k="y",S="x2",E="y2",C.attr("dy",0>L?"0em":".71em").style("text-anchor","middle"),_.attr("d","M"+x[0]+","+L*i+"V0H"+x[1]+"V"+L*i)):(n=Wo,w="y",k="x",S="y2",E="x2",C.attr("dy",".32em").style("text-anchor",0>L?"end":"start"),_.attr("d","M"+L*i+","+x[0]+"H0V"+x[1]+"H"+L*i)),A.attr(E,L*u),z.attr(k,L*M),N.attr(S,0).attr(E,L*u),q.attr(w,0).attr(k,L*M),f.rangeBand){var T=f,R=T.rangeBand()/2;s=f=function(n){return T(n)+R}}else{s.rangeBand?s=f:d.call(n,f,s)}v.call(n,s,f),m.call(n,f,f)})}var t,e=ta.scale.linear(),r=jl,u=6,i=6,o=3,a=[10],c=null;return n.scale=function(t){return arguments.length?(e=t,n):e},n.orient=function(t){return arguments.length?(r=t in Fl?t+"":jl,n):r},n.ticks=function(){return arguments.length?(a=arguments,n):a},n.tickValues=function(t){return arguments.length?(c=t,n):c},n.tickFormat=function(e){return arguments.length?(t=e,n):t},n.tickSize=function(t){var e=arguments.length;return e?(u=+t,i=+arguments[e-1],n):u},n.innerTickSize=function(t){return arguments.length?(u=+t,n):u},n.outerTickSize=function(t){return arguments.length?(i=+t,n):i},n.tickPadding=function(t){return arguments.length?(o=+t,n):o},n.tickSubdivide=function(){return arguments.length&&n},n};var jl="bottom",Fl={top:1,right:1,bottom:1,left:1};ta.svg.brush=function(){function n(t){t.each(function(){var t=ta.select(this).style("pointer-events","all").style("-webkit-tap-highlight-color","rgba(0,0,0,0)").on("mousedown.brush",i).on("touchstart.brush",i),o=t.selectAll(".background").data([0]);o.enter().append("rect").attr("class","background").style("visibility","hidden").style("cursor","crosshair"),t.selectAll(".extent").data([0]).enter().append("rect").attr("class","extent").style("cursor","move");var a=t.selectAll(".resize").data(v,y);a.exit().remove(),a.enter().append("g").attr("class",function(n){return"resize "+n}).style("cursor",function(n){return Hl[n]}).append("rect").attr("x",function(n){return/[ew]$/.test(n)?-3:null}).attr("y",function(n){return/^[ns]/.test(n)?-3:null}).attr("width",6).attr("height",6).style("visibility","hidden"),a.style("display",n.empty()?"none":null);var c,f=ta.transition(t),h=ta.transition(o);l&&(c=Ui(l),h.attr("x",c[0]).attr("width",c[1]-c[0]),r(f)),s&&(c=Ui(s),h.attr("y",c[0]).attr("height",c[1]-c[0]),u(f)),e(f)})}function e(n){n.selectAll(".resize").attr("transform",function(n){return"translate("+f[+/e$/.test(n)]+","+h[+/^s/.test(n)]+")"})}function r(n){n.select(".extent").attr("x",f[0]),n.selectAll(".extent,.n>rect,.s>rect").attr("width",f[1]-f[0])}function u(n){n.select(".extent").attr("y",h[0]),n.selectAll(".extent,.e>rect,.w>rect").attr("height",h[1]-h[0])}function i(){function i(){32==ta.event.keyCode&&(C||(M=null,q[0]-=f[1],q[1]-=h[1],C=2),S())}function v(){32==ta.event.keyCode&&2==C&&(q[0]+=f[1],q[1]+=h[1],C=0,S())}function d(){var n=ta.mouse(b),t=!1;x&&(n[0]+=x[0],n[1]+=x[1]),C||(ta.event.altKey?(M||(M=[(f[0]+f[1])/2,(h[0]+h[1])/2]),q[0]=f[+(n[0]<M[0])],q[1]=h[+(n[1]<M[1])]):M=null),A&&m(n,l,0)&&(r(k),t=!0),N&&m(n,s,1)&&(u(k),t=!0),t&&(e(k),w({type:"brush",mode:C?"move":"resize"}))}function m(n,t,e){var r,u,i=Ui(t),c=i[0],l=i[1],s=q[e],v=e?h:f,d=v[1]-v[0];return C&&(c-=s,l-=d+s),r=(e?p:g)?Math.max(c,Math.min(l,n[e])):n[e],C?u=(r+=s)+d:(M&&(s=Math.max(c,Math.min(l,2*M[e]-r))),r>s?(u=r,r=s):u=s),v[0]!=r||v[1]!=u?(e?a=null:o=null,v[0]=r,v[1]=u,!0):void 0}function y(){d(),k.style("pointer-events","all").selectAll(".resize").style("display",n.empty()?"none":null),ta.select("body").style("cursor",null),L.on("mousemove.brush",null).on("mouseup.brush",null).on("touchmove.brush",null).on("touchend.brush",null).on("keydown.brush",null).on("keyup.brush",null),z(),w({type:"brushend"})}var M,x,b=this,_=ta.select(ta.event.target),w=c.of(b,arguments),k=ta.select(b),E=_.datum(),A=!/^(n|s)$/.test(E)&&l,N=!/^(e|w)$/.test(E)&&s,C=_.classed("extent"),z=W(b),q=ta.mouse(b),L=ta.select(t(b)).on("keydown.brush",i).on("keyup.brush",v);if(ta.event.changedTouches?L.on("touchmove.brush",d).on("touchend.brush",y):L.on("mousemove.brush",d).on("mouseup.brush",y),k.interrupt().selectAll("*").interrupt(),C){q[0]=f[0]-q[0],q[1]=h[0]-q[1]}else{if(E){var T=+/w$/.test(E),R=+/^n/.test(E);x=[f[1-T]-q[0],h[1-R]-q[1]],q[0]=f[T],q[1]=h[R]}else{ta.event.altKey&&(M=q.slice())}}k.style("pointer-events","none").selectAll(".resize").style("display",null),ta.select("body").style("cursor",_.style("cursor")),w({type:"brushstart"}),d()}var o,a,c=E(n,"brushstart","brush","brushend"),l=null,s=null,f=[0,0],h=[0,0],g=!0,p=!0,v=Ol[0];return n.event=function(n){n.each(function(){var n=c.of(this,arguments),t={x:f,y:h,i:o,j:a},e=this.__chart__||t;this.__chart__=t,Tl?ta.select(this).transition().each("start.brush",function(){o=e.i,a=e.j,f=e.x,h=e.y,n({type:"brushstart"})}).tween("brush:brush",function(){var e=yu(f,t.x),r=yu(h,t.y);return o=a=null,function(u){f=t.x=e(u),h=t.y=r(u),n({type:"brush",mode:"resize"})}}).each("end.brush",function(){o=t.i,a=t.j,n({type:"brush",mode:"resize"}),n({type:"brushend"})}):(n({type:"brushstart"}),n({type:"brush",mode:"resize"}),n({type:"brushend"}))})},n.x=function(t){return arguments.length?(l=t,v=Ol[!l<<1|!s],n):l},n.y=function(t){return arguments.length?(s=t,v=Ol[!l<<1|!s],n):s},n.clamp=function(t){return arguments.length?(l&&s?(g=!!t[0],p=!!t[1]):l?g=!!t:s&&(p=!!t),n):l&&s?[g,p]:l?g:s?p:null},n.extent=function(t){var e,r,u,i,c;return arguments.length?(l&&(e=t[0],r=t[1],s&&(e=e[0],r=r[0]),o=[e,r],l.invert&&(e=l(e),r=l(r)),e>r&&(c=e,e=r,r=c),(e!=f[0]||r!=f[1])&&(f=[e,r])),s&&(u=t[0],i=t[1],l&&(u=u[1],i=i[1]),a=[u,i],s.invert&&(u=s(u),i=s(i)),u>i&&(c=u,u=i,i=c),(u!=h[0]||i!=h[1])&&(h=[u,i])),n):(l&&(o?(e=o[0],r=o[1]):(e=f[0],r=f[1],l.invert&&(e=l.invert(e),r=l.invert(r)),e>r&&(c=e,e=r,r=c))),s&&(a?(u=a[0],i=a[1]):(u=h[0],i=h[1],s.invert&&(u=s.invert(u),i=s.invert(i)),u>i&&(c=u,u=i,i=c))),l&&s?[[e,u],[r,i]]:l?[e,r]:s&&[u,i])},n.clear=function(){return n.empty()||(f=[0,0],h=[0,0],o=a=null),n},n.empty=function(){return !!l&&f[0]==f[1]||!!s&&h[0]==h[1]},ta.rebind(n,c,"on")};var Hl={n:"ns-resize",e:"ew-resize",s:"ns-resize",w:"ew-resize",nw:"nwse-resize",ne:"nesw-resize",se:"nwse-resize",sw:"nesw-resize"},Ol=[["n","e","s","w","nw","ne","se","sw"],["e","w"],["n","s"],[]],Il=ac.format=gc.timeFormat,Yl=Il.utc,Zl=Yl("%Y-%m-%dT%H:%M:%S.%LZ");Il.iso=Date.prototype.toISOString&&+new Date("2000-01-01T00:00:00.000Z")?Jo:Zl,Jo.parse=function(n){var t=new Date(n);return isNaN(t)?null:t},Jo.toString=Zl.toString,ac.second=Ft(function(n){return new cc(1000*Math.floor(n/1000))},function(n,t){n.setTime(n.getTime()+1000*Math.floor(t))},function(n){return n.getSeconds()}),ac.seconds=ac.second.range,ac.seconds.utc=ac.second.utc.range,ac.minute=Ft(function(n){return new cc(60000*Math.floor(n/60000))},function(n,t){n.setTime(n.getTime()+60000*Math.floor(t))},function(n){return n.getMinutes()}),ac.minutes=ac.minute.range,ac.minutes.utc=ac.minute.utc.range,ac.hour=Ft(function(n){var t=n.getTimezoneOffset()/60;return new cc(3600000*(Math.floor(n/3600000-t)+t))},function(n,t){n.setTime(n.getTime()+3600000*Math.floor(t))},function(n){return n.getHours()}),ac.hours=ac.hour.range,ac.hours.utc=ac.hour.utc.range,ac.month=Ft(function(n){return n=ac.day(n),n.setDate(1),n},function(n,t){n.setMonth(n.getMonth()+t)},function(n){return n.getMonth()}),ac.months=ac.month.range,ac.months.utc=ac.month.utc.range;var Vl=[1000,5000,15000,30000,60000,300000,900000,1800000,3600000,10800000,21600000,43200000,86400000,172800000,604800000,2592000000,7776000000,31536000000],Xl=[[ac.second,1],[ac.second,5],[ac.second,15],[ac.second,30],[ac.minute,1],[ac.minute,5],[ac.minute,15],[ac.minute,30],[ac.hour,1],[ac.hour,3],[ac.hour,6],[ac.hour,12],[ac.day,1],[ac.day,2],[ac.week,1],[ac.month,1],[ac.month,3],[ac.year,1]],$l=Il.multi([[".%L",function(n){return n.getMilliseconds()}],[":%S",function(n){return n.getSeconds()}],["%I:%M",function(n){return n.getMinutes()}],["%I %p",function(n){return n.getHours()}],["%a %d",function(n){return n.getDay()&&1!=n.getDate()}],["%b %d",function(n){return 1!=n.getDate()}],["%B",function(n){return n.getMonth()}],["%Y",Ne]]),Bl={range:function(n,t,e){return ta.range(Math.ceil(n/e)*e,+t,e).map(Ko)},floor:y,ceil:y};Xl.year=ac.year,ac.scale=function(){return Go(ta.scale.linear(),Xl,$l)};var Wl=Xl.map(function(n){return[n[0].utc,n[1]]}),Jl=Yl.multi([[".%L",function(n){return n.getUTCMilliseconds()}],[":%S",function(n){return n.getUTCSeconds()}],["%I:%M",function(n){return n.getUTCMinutes()}],["%I %p",function(n){return n.getUTCHours()}],["%a %d",function(n){return n.getUTCDay()&&1!=n.getUTCDate()}],["%b %d",function(n){return 1!=n.getUTCDate()}],["%B",function(n){return n.getUTCMonth()}],["%Y",Ne]]);Wl.year=ac.year.utc,ac.scale.utc=function(){return Go(ta.scale.linear(),Wl,Jl)},ta.text=At(function(n){return n.responseText}),ta.json=function(n,t){return Nt(n,"application/json",Qo,t)},ta.html=function(n,t){return Nt(n,"text/html",na,t)},ta.xml=At(function(n){return n.responseXML}),"function"==typeof define&&define.amd?define(ta):"object"==typeof module&&module.exports&&(module.exports=ta),this.d3=ta}();(function(){_gliffy._GoogleTagManager=_gliffy.Class.extend({init:function(id){var w=window,d=document,s="script",l="dataLayer",i=id;if($.url().param("dev")!=="true"||$.url().param("gtm")==="true"){w[l]=w[l]||[];w[l].push({"gtm.start":new Date().getTime(),event:"gtm.js"});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!="dataLayer"?"&l="+l:"";j.async=true;j.src="//www.googletagmanager.com/gtm.js?id="+i+dl;f.parentNode.insertBefore(j,f)}}})}());(function($){var Popover=function(options){var o=$.extend({},{target:$("body"),title:"Title",content:"Content",contentAsHTML:null,placement:"e",zIndex:590000,cookieExpires:365,cookie:null,left:null,top:null,addClass:null,width:null,shouldShow:null,onShow:null,onHide:null},options),self=this;this.title=o.title;this.target=o.target;this.content=o.content;this.placement=o.placement;this.cookie=o.cookie;this.left=o.left;this.top=o.top;this.shouldShow=o.shouldShow;this.onShow=o.onShow;this.onHide=o.onHide;this.width=o.width;this.zIndex=o.zIndex;this.time=new Date().getTime();if(this.target&&this.target.length>0&&this.shouldRender()){var template=$("script[data-template-name='gliffy-popover-template']"),$popoverContent;if(template.length===0){template=$("#gliffy-popover")}this.htmlContent=$(Handlebars.compile(template.html())($.extend({title:o.title,content:o.content})));$popoverContent=$(this.htmlContent).find(".gliffy-popover-content");if(this.width){$(this.htmlContent).width(this.width)}if(o.contentAsHTML){$popoverContent.html(o.contentAsHTML);$popoverContent.css("white-space","")}else{$popoverContent.css("white-space","pre-wrap")}this.htmlContent.appendTo("body");if(o.addClass){this.htmlContent.addClass(o.addClass)}$(this.htmlContent).find(".gliffy-icon-sidebar-close").click(function(){self.hide()});this.addArrow();this.bindResize();this.position()}return this};Popover.prototype.getBoundingBox=function(){var $content=$(this.htmlContent);return _gliffy.Utils.getTextBoundingBox($content)};Popover.prototype.shouldRender=function(){if(this.cookie===null&&this.shouldShow){return this.shouldShow()}return this.cookie===null||!($.cookie(this.cookie)||window.localStorage.getItem(this.cookie))};Popover.prototype.addArrow=function(){var arrow=this.htmlContent.find(".gliffy-arrow"),arrowBorder=this.htmlContent.find(".gliffy-arrow-border");switch(this.placement){case"n":arrow.addClass("gliffy-arrow-down");arrowBorder.addClass("gliffy-arrow-border-down");break;case"nl":case"ne":arrow.addClass("gliffy-arrow-down-left");arrowBorder.addClass("gliffy-arrow-border-down-left");break;case"nr":case"nw":arrow.addClass("gliffy-arrow-down-right");arrowBorder.addClass("gliffy-arrow-border-down-right");break;case"e":arrow.addClass("gliffy-arrow-left");arrowBorder.addClass("gliffy-arrow-border-left");break;case"et":arrow.addClass("gliffy-arrow-left-top");arrowBorder.addClass("gliffy-arrow-border-left-top");break;case"eb":arrow.addClass("gliffy-arrow-left-bottom");arrowBorder.addClass("gliffy-arrow-border-left-bottom");break;case"w":arrow.addClass("gliffy-arrow-right");arrowBorder.addClass("gliffy-arrow-border-right");break;case"wt":arrow.addClass("gliffy-arrow-right-top");arrowBorder.addClass("gliffy-arrow-border-right-top");break;case"wb":arrow.addClass("gliffy-arrow-right-bottom");arrowBorder.addClass("gliffy-arrow-border-right-bottom");break;case"s":arrow.addClass("gliffy-arrow-up");arrowBorder.addClass("gliffy-arrow-border-up");break;case"sl":case"se":arrow.addClass("gliffy-arrow-up-left");arrowBorder.addClass("gliffy-arrow-border-up-left");break;case"sr":case"sw":arrow.addClass("gliffy-arrow-up-right");arrowBorder.addClass("gliffy-arrow-border-up-right");break}};Popover.prototype.position=function(){var topOffset=0,leftOffset=0,caret=7,width,height,parentWidth,parentHeight;height=this.htmlContent.outerHeight();width=this.htmlContent.outerWidth();if(this.left!=null&&this.top!=null){this.htmlContent.css({left:this.left,top:this.top,visibility:"visible",zIndex:this.zIndex});return}parentWidth=this.target.outerWidth();parentHeight=this.target.outerHeight();this.parentOffset=this.target.offset();if(this.placement.indexOf("n")>-1){topOffset=-height-caret}else{if(this.placement.indexOf("s")>-1){topOffset=parentHeight+caret}else{if(this.placement.indexOf("t")>-1){topOffset=0}else{if(this.placement.indexOf("b")>-1){topOffset=parentHeight-height}else{topOffset=parentHeight/2-height/2}}}}if(this.placement.indexOf("e")>-1){leftOffset=parentWidth+caret;if(this.placement.indexOf("n")>-1||this.placement.indexOf("s")>-1){leftOffset=leftOffset-caret-25}}else{if(this.placement.indexOf("w")>-1){leftOffset=-width-caret;if(this.placement.indexOf("n")>-1||this.placement.indexOf("s")>-1){leftOffset=leftOffset+caret+25}}else{if(this.placement.indexOf("l")>-1){leftOffset=0}else{if(this.placement.indexOf("r")>-1){leftOffset=parentWidth-width}else{leftOffset=parentWidth/2-width/2}}}}this.htmlContent.css({left:this.parentOffset.left+leftOffset,top:this.parentOffset.top+topOffset,visibility:"visible",zIndex:this.zIndex})};Popover.prototype.bindResize=function(){var self=this;$(window).bind("resize.popover."+this.time,function(){self.position()})};Popover.prototype.show=function(){if(this.onShow){this.onShow(this)}this.bindResize();this.htmlContent.show();return this};Popover.prototype.hide=function(){if(this.onHide){this.onHide(this)}if(this.cookie!==null){window.localStorage.setItem(this.cookie,true);$.cookie(this.cookie,true,{expires:this.cookieExpires})}$(window).unbind("resize.popover."+this.time);if(this.htmlContent){this.htmlContent.hide()}return this};Popover.prototype.remove=function(){if(this.cookie!==null){window.localStorage.setItem(this.cookie,true);$.cookie(this.cookie,true,{expires:this.cookieExpires})}$(window).unbind("resize.popover."+this.time);if(this.htmlContent){this.htmlContent.remove()}return this};_gliffy.Popover=Popover}(jQuery));context=(function(){var options={fadeSpeed:100,filter:function($obj){},above:"auto",left:"auto",preventDoubleContext:true,compress:false,className:null};function initialize(opts){options=$.extend({},options,opts);$(document).on("click",function(event){if(event.which!==3){$(".dropdown-context").fadeOut(options.fadeSpeed,function(){$(".dropdown-context").css({display:""}).find(".drop-left").removeClass("drop-left").find(".drop-up").removeClass("drop-up")})}});if(options.preventDoubleContext){$(document).on("contextmenu",".dropdown-context",function(e){e.preventDefault()})}$(document).on("mouseenter",".dropdown-submenu",function(){var $sub=$(this).find(".dropdown-context-sub:first"),$subMenu=$(this).find(".dropdown-context:first"),subWidth=$sub.width(),subMenuHeight=$subMenu.height(),subMenuTop=$subMenu.offset().top,subLeft=$sub.offset().left,horizCollision=(subWidth+subLeft)>window.innerWidth,verticalCollision=(subMenuHeight+subMenuTop)>window.innerHeight;if(horizCollision){$sub.addClass("drop-left")}if(verticalCollision){$sub.addClass("drop-up")}})}function updateOptions(opts){options=$.extend({},options,opts)}function buildMenu(data,id,subMenu){var subClass=(subMenu)?" dropdown-context-sub":"",compressed=options.compress?" compressed-context":"",$menu=$('<ul class="context-js dropdown-menu dropdown-context'+subClass+compressed+'" id="dropdown-'+id+'"></ul>');return buildMenuItems($menu,data,id,subMenu)}function buildMenuItems($menu,data,id,subMenu,addDynamicTag){var linkTarget="";for(var i=0;i<data.length;i++){if(typeof data[i].divider!=="undefined"){var divider='<li class="context-js divider';divider+=(addDynamicTag)?" dynamic-menu-item":"";divider+=data[i].className?" "+data[i].className:"";divider+='"></li>';$menu.append(divider)}else{if(typeof data[i].header!=="undefined"){var header='<li class="context-js nav-header';header+=(addDynamicTag)?" dynamic-menu-item":"";header+='">'+data[i].header+"</li>";$menu.append(header)}else{if(typeof data[i].menu_item_src!=="undefined"){var funcName;if(typeof data[i].menu_item_src==="function"){if(data[i].menu_item_src.name===""){for(var globalVar in window){if(data[i].menu_item_src==window[globalVar]){funcName=globalVar;break}}}else{funcName=data[i].menu_item_src.name}}else{funcName=data[i].menu_item_src}$menu.append('<li class="context-js dynamic-menu-src" data-src="'+funcName+'"></li>')}else{if(typeof data[i].href=="undefined"){data[i].href="#"}if(typeof data[i].target!=="undefined"){linkTarget=' target="'+data[i].target+'"'}if(typeof data[i].subMenu!=="undefined"){var sub_menu='<li class="context-js dropdown-submenu';sub_menu+=(addDynamicTag)?" dynamic-menu-item":"";sub_menu+='"><a tabindex="-1" href="'+data[i].href+'">'+data[i].text+"</a></li>";$sub=$(sub_menu)}else{var element="<li";element+=(addDynamicTag)?' class="context-js dynamic-menu-item"':"";element+='><a tabindex="-1" href="'+data[i].href+'"'+linkTarget+">";if(typeof data[i].icon!=="undefined"){element+='<span class="context-js glyphicon '+data[i].icon+'"></span> '}element+=data[i].text+"</a></li>";$sub=$(element)}if(typeof data[i].action!=="undefined"){$action=data[i].action;$sub.find("a").addClass("context-event").addClass("context-js").on("click",createCallback($action))}if(typeof data[i].className!=="undefined"){var aParent=$sub.find("a").parent();aParent.attr("class",(aParent.attr("class")?aParent.attr("class")+" ":"")+data[i].className)}$menu.append($sub);if(typeof data[i].subMenu!="undefined"){var subMenuData=buildMenu(data[i].subMenu,id,true);$menu.find("li:last").append(subMenuData)}}}}if(typeof options.filter=="function"){options.filter($menu.find("li:last"))}}return $menu}function addContext(selector,data,beforeShow){if(typeof data.id!=="undefined"&&typeof data.data!=="undefined"){var id=data.id;$menu=$("body").find("#dropdown-"+id)[0];if(typeof $menu==="undefined"){$menu=buildMenu(data.data,id);$("body").append($menu)}}else{var d=new Date(),id=d.getTime(),$menu=buildMenu(data,id);$("body").append($menu)}if($menu&&$menu.length>0&&options.className){$menu.addClass(options.className)}$("body").on("contextmenu",selector,function(e){var newData;e.preventDefault();e.stopPropagation();currentContextSelector=$(this);$(".dropdown-context:not(.dropdown-context-sub)").hide();$dd=$("#dropdown-"+id);if(beforeShow){beforeShow($dd)}$dd.find(".dynamic-menu-item").remove();$dd.find(".dynamic-menu-src").each(function(idx,element){var menuItems=window[$(element).data("src")]($(selector));$parentMenu=$(element).closest(".dropdown-menu.dropdown-context");$parentMenu=buildMenuItems($parentMenu,menuItems,id,undefined,true)});if(typeof options.above=="boolean"&&options.above){$dd.addClass("dropdown-context-up").css({top:e.pageY-20-$("#dropdown-"+id).height(),left:e.pageX-13}).fadeIn(options.fadeSpeed)}else{if(typeof options.above=="string"&&options.above=="auto"){$dd.removeClass("dropdown-context-up");var autoH=$dd.height()+12;if((e.pageY+autoH)>$("html").height()){$dd.addClass("dropdown-context-up").css({top:e.pageY-20-autoH,left:e.pageX-13}).fadeIn(options.fadeSpeed)}else{$dd.css({top:e.pageY+10,left:e.pageX-13}).fadeIn(options.fadeSpeed)}}}if(typeof options.left=="boolean"&&options.left){$dd.addClass("dropdown-context-left").css({left:e.pageX-$dd.width()}).fadeIn(options.fadeSpeed)}else{if(typeof options.left=="string"&&options.left=="auto"){$dd.removeClass("dropdown-context-left");var autoL=$dd.width()-12;if((e.pageX+autoL)>$("html").width()){$dd.addClass("dropdown-context-left").css({left:e.pageX-$dd.width()+13})}}}})}function destroyContext(selector){$(document).off("contextmenu",selector).off("click",".context-event")}return{init:initialize,settings:updateOptions,attach:addContext,destroy:destroyContext}})();var createCallback=function(func){return function(event){func(event,currentContextSelector);event.preventDefault()}};currentContextSelector=undefined;
/*!!
 * A class to parse color values
 * @author Stoyan Stefanov <sstoo@gmail.com>
 * @link   http://www.phpied.com/rgb-color-parser-in-javascript/
 * @license Use it if you like it
 */
(function(){var RGBColor=function(color_string){this.ok=false;if(color_string.charAt(0)=="#"){color_string=color_string.substr(1,6)}color_string=color_string.replace(/ /g,"");color_string=color_string.toLowerCase();var simple_colors={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};for(var key in simple_colors){if(color_string==key){color_string=simple_colors[key]}}var color_defs=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(bits){return[parseInt(bits[1]),parseInt(bits[2]),parseInt(bits[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(bits){return[parseInt(bits[1],16),parseInt(bits[2],16),parseInt(bits[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(bits){return[parseInt(bits[1]+bits[1],16),parseInt(bits[2]+bits[2],16),parseInt(bits[3]+bits[3],16)]}}];for(var i=0;i<color_defs.length;i++){var re=color_defs[i].re;var processor=color_defs[i].process;var bits=re.exec(color_string);if(bits){channels=processor(bits);this.r=channels[0];this.g=channels[1];this.b=channels[2];this.ok=true}}this.r=(this.r<0||isNaN(this.r))?0:((this.r>255)?255:this.r);this.g=(this.g<0||isNaN(this.g))?0:((this.g>255)?255:this.g);this.b=(this.b<0||isNaN(this.b))?0:((this.b>255)?255:this.b);this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"};this.toRGBA=function(a){return"rgba("+this.r+", "+this.g+", "+this.b+", "+a+")"};this.toHex=function(){var r=this.r.toString(16);var g=this.g.toString(16);var b=this.b.toString(16);if(r.length==1){r="0"+r}if(g.length==1){g="0"+g}if(b.length==1){b="0"+b}return"#"+r+g+b};this.getHelpXML=function(){var examples=new Array();for(var i=0;i<color_defs.length;i++){var example=color_defs[i].example;for(var j=0;j<example.length;j++){examples[examples.length]=example[j]}}for(var sc in simple_colors){examples[examples.length]=sc}var xml=document.createElement("ul");xml.setAttribute("id","rgbcolor-examples");for(var i=0;i<examples.length;i++){try{var list_item=document.createElement("li");var list_color=new RGBColor(examples[i]);var example_div=document.createElement("div");example_div.style.cssText="margin: 3px; border: 1px solid black; background:"+list_color.toHex()+"; color:"+list_color.toHex();example_div.appendChild(document.createTextNode("test"));var list_item_value=document.createTextNode(" "+examples[i]+" -> "+list_color.toRGB()+" -> "+list_color.toHex());list_item.appendChild(example_div);list_item.appendChild(list_item_value);xml.appendChild(list_item)}catch(e){}}return xml}};_gliffy.RGBColor=RGBColor})();(function(){var isFiniteNumber=function(num){return isFinite(num)&&!isNaN(num)};var isNumber=function(val){return typeof val=="number"};var checkFiniteNumbers=function(args){if(_gliffy.Debug.FINITE_NUMBER_CHECKS){var len=args.length;for(var i=0;i<len;i++){if(!isFiniteNumber(args[i])){throw Error("Invalid transform parameters")}}}};var AffineTransform=function(opt_m00,opt_m10,opt_m01,opt_m11,opt_m02,opt_m12){checkFiniteNumbers(arguments);if(arguments.length==6){this.setTransform((opt_m00),(opt_m10),(opt_m01),(opt_m11),(opt_m02),(opt_m12))}else{if(arguments.length!=0){throw Error("Insufficient matrix parameters")}else{this.m00_=this.m11_=1;this.m10_=this.m01_=this.m02_=this.m12_=0}}};AffineTransform.prototype.isIdentity=function(){return this.m00_==1&&this.m10_==0&&this.m01_==0&&this.m11_==1&&this.m02_==0&&this.m12_==0};AffineTransform.prototype.clone=function(){return new AffineTransform(this.m00_,this.m10_,this.m01_,this.m11_,this.m02_,this.m12_)};AffineTransform.prototype.setTransform=function(m00,m10,m01,m11,m02,m12){checkFiniteNumbers(arguments);this.m00_=m00;this.m10_=m10;this.m01_=m01;this.m11_=m11;this.m02_=m02;this.m12_=m12;return this};AffineTransform.prototype.copyFrom=function(tx){checkFiniteNumbers([tx.m00_,tx.m01_,tx.m02_,tx.m10_,tx.m11_,tx.m12_]);this.m00_=tx.m00_;this.m10_=tx.m10_;this.m01_=tx.m01_;this.m11_=tx.m11_;this.m02_=tx.m02_;this.m12_=tx.m12_;return this};AffineTransform.prototype.scale=function(sx,sy){checkFiniteNumbers(arguments);this.m00_*=sx;this.m10_*=sx;this.m01_*=sy;this.m11_*=sy;return this};AffineTransform.prototype.preScale=function(sx,sy){checkFiniteNumbers(arguments);this.m00_*=sx;this.m01_*=sx;this.m02_*=sx;this.m10_*=sy;this.m11_*=sy;this.m12_*=sy;return this};AffineTransform.prototype.translate=function(dx,dy){checkFiniteNumbers(arguments);this.m02_+=dx*this.m00_+dy*this.m01_;this.m12_+=dx*this.m10_+dy*this.m11_;return this};AffineTransform.prototype.preTranslate=function(dx,dy){checkFiniteNumbers(arguments);this.m02_+=dx;this.m12_+=dy;return this};AffineTransform.prototype.rotate=function(theta,x,y){checkFiniteNumbers(arguments);return this.concatenate(AffineTransform.getRotateInstance(theta,x,y))};AffineTransform.prototype.preRotate=function(theta,x,y){checkFiniteNumbers(arguments);return this.preConcatenate(AffineTransform.getRotateInstance(theta,x,y))};AffineTransform.prototype.shear=function(shx,shy){checkFiniteNumbers(arguments);var m00=this.m00_;var m10=this.m10_;this.m00_+=shy*this.m01_;this.m10_+=shy*this.m11_;this.m01_+=shx*m00;this.m11_+=shx*m10;return this};AffineTransform.prototype.preShear=function(shx,shy){checkFiniteNumbers(arguments);var m00=this.m00_;var m01=this.m01_;var m02=this.m02_;this.m00_+=shx*this.m10_;this.m01_+=shx*this.m11_;this.m02_+=shx*this.m12_;this.m10_+=shy*m00;this.m11_+=shy*m01;this.m12_+=shy*m02;return this};AffineTransform.prototype.toString=function(){return"matrix("+[this.m00_,this.m10_,this.m01_,this.m11_,this.m02_,this.m12_].join(",")+")"};AffineTransform.prototype.getValue=function(i){var arr=[this.m00_,this.m10_,this.m01_,this.m11_,this.m02_,this.m12_];return arr[i]};AffineTransform.prototype.getValues=function(){return[this.m00_,this.m10_,this.m01_,this.m11_,this.m02_,this.m12_]};AffineTransform.prototype.getScaleX=function(){return this.m00_};AffineTransform.prototype.getScaleY=function(){return this.m11_};AffineTransform.prototype.getTranslateX=function(){return this.m02_};AffineTransform.prototype.getTranslateY=function(){return this.m12_};AffineTransform.prototype.getShearX=function(){return this.m01_};AffineTransform.prototype.getShearY=function(){return this.m10_};AffineTransform.prototype.concatenate=function(tx){checkFiniteNumbers([tx.m00_,tx.m01_,tx.m02_,tx.m10_,tx.m11_,tx.m12_]);var m0=this.m00_;var m1=this.m01_;this.m00_=tx.m00_*m0+tx.m10_*m1;this.m01_=tx.m01_*m0+tx.m11_*m1;this.m02_+=tx.m02_*m0+tx.m12_*m1;m0=this.m10_;m1=this.m11_;this.m10_=tx.m00_*m0+tx.m10_*m1;this.m11_=tx.m01_*m0+tx.m11_*m1;this.m12_+=tx.m02_*m0+tx.m12_*m1;return this};AffineTransform.prototype.preConcatenate=function(tx){checkFiniteNumbers([tx.m00_,tx.m01_,tx.m02_,tx.m10_,tx.m11_,tx.m12_]);var m0=this.m00_;var m1=this.m10_;this.m00_=tx.m00_*m0+tx.m01_*m1;this.m10_=tx.m10_*m0+tx.m11_*m1;m0=this.m01_;m1=this.m11_;this.m01_=tx.m00_*m0+tx.m01_*m1;this.m11_=tx.m10_*m0+tx.m11_*m1;m0=this.m02_;m1=this.m12_;this.m02_=tx.m00_*m0+tx.m01_*m1+tx.m02_;this.m12_=tx.m10_*m0+tx.m11_*m1+tx.m12_;return this};AffineTransform.prototype.transform=function(src,srcOff,dst,dstOff,numPts){var i=srcOff;var j=dstOff;var srcEnd=srcOff+2*numPts;while(i<srcEnd){var x=src[i++];var y=src[i++];dst[j++]=x*this.m00_+y*this.m01_+this.m02_;dst[j++]=x*this.m10_+y*this.m11_+this.m12_}};AffineTransform.prototype.transformPoint=function(x,y){checkFiniteNumbers(arguments);return{x:x*this.m00_+y*this.m01_+this.m02_,y:x*this.m10_+y*this.m11_+this.m12_}};AffineTransform.prototype.getDeterminant=function(){return this.m00_*this.m11_-this.m01_*this.m10_};AffineTransform.prototype.isInvertible=function(){var det=this.getDeterminant();return isFiniteNumber(det)&&isFiniteNumber(this.m02_)&&isFiniteNumber(this.m12_)&&det!=0};AffineTransform.prototype.createInverse=function(){var det=this.getDeterminant();return new AffineTransform(this.m11_/det,-this.m10_/det,-this.m01_/det,this.m00_/det,(this.m01_*this.m12_-this.m11_*this.m02_)/det,(this.m10_*this.m02_-this.m00_*this.m12_)/det)};AffineTransform.getScaleInstance=function(sx,sy){checkFiniteNumbers(arguments);return new AffineTransform().setToScale(sx,sy)};AffineTransform.getTranslateInstance=function(dx,dy){checkFiniteNumbers(arguments);return new AffineTransform().setToTranslation(dx,dy)};AffineTransform.getShearInstance=function(shx,shy){checkFiniteNumbers(arguments);return new AffineTransform().setToShear(shx,shy)};AffineTransform.getRotateInstance=function(theta,x,y){checkFiniteNumbers(arguments);return new AffineTransform().setToRotation(theta,x,y)};AffineTransform.prototype.setToScale=function(sx,sy){checkFiniteNumbers(arguments);return this.setTransform(sx,0,0,sy,0,0)};AffineTransform.prototype.setToTranslation=function(dx,dy){checkFiniteNumbers(arguments);return this.setTransform(1,0,0,1,dx,dy)};AffineTransform.prototype.setToShear=function(shx,shy){checkFiniteNumbers(arguments);return this.setTransform(1,shy,shx,1,0,0)};AffineTransform.prototype.setToRotation=function(theta,x,y){checkFiniteNumbers(arguments);var cos=Math.cos(theta);var sin=Math.sin(theta);return this.setTransform(cos,sin,-sin,cos,x-x*cos+y*sin,y-x*sin-y*cos)};AffineTransform.prototype.equals=function(tx){checkFiniteNumbers(arguments);if(this==tx){return true}if(!tx){return false}return this.m00_==tx.m00_&&this.m01_==tx.m01_&&this.m02_==tx.m02_&&this.m10_==tx.m10_&&this.m11_==tx.m11_&&this.m12_==tx.m12_};AffineTransform.prototype.toCssNoTranslate=function(o){var options=$.extend({isMoz:false,roundTranslate:false},o);if(options.isMoz){return"matrix("+this.m00_.toFixed(8)+","+this.m10_.toFixed(8)+","+this.m01_.toFixed(8)+","+this.m11_.toFixed(8)+",0,0)"}else{return"matrix("+this.m00_.toFixed(8)+","+this.m10_.toFixed(8)+","+this.m01_.toFixed(8)+","+this.m11_.toFixed(8)+",0,0)"}};AffineTransform.prototype.toCss=function(o){var options=$.extend({isMoz:false,roundTranslate:false},o);var translateX=options.roundTranslate?Math.round(this.m02_):this.m02_;var translateY=options.roundTranslate?Math.round(this.m12_):this.m12_;if(options.isMoz){return"matrix("+this.m00_.toFixed(8)+","+this.m10_.toFixed(8)+","+this.m01_.toFixed(8)+","+this.m11_.toFixed(8)+","+translateX+"px,"+translateY+"px)"}else{return"matrix("+this.m00_.toFixed(8)+","+this.m10_.toFixed(8)+","+this.m01_.toFixed(8)+","+this.m11_.toFixed(8)+","+translateX+","+translateY+")"}};_gliffy.AffineTransform=AffineTransform})();(function(){var candash=function(){var MAX_POINTS=24;var __abscissa=[[],[],[-0.5773502691896257,0.5773502691896257],[0,-0.7745966692414834,0.7745966692414834],[-0.33998104358485626,0.33998104358485626,-0.8611363115940526,0.8611363115940526],[0,-0.5384693101056831,0.5384693101056831,-0.906179845938664,0.906179845938664],[0.6612093864662645,-0.6612093864662645,-0.2386191860831969,0.2386191860831969,-0.932469514203152,0.932469514203152],[0,0.4058451513773972,-0.4058451513773972,-0.7415311855993945,0.7415311855993945,-0.9491079123427585,0.9491079123427585],[-0.1834346424956498,0.1834346424956498,-0.525532409916329,0.525532409916329,-0.7966664774136267,0.7966664774136267,-0.9602898564975363,0.9602898564975363],[0,-0.8360311073266358,0.8360311073266358,-0.9681602395076261,0.9681602395076261,-0.3242534234038089,0.3242534234038089,-0.6133714327005904,0.6133714327005904],[-0.14887433898163122,0.14887433898163122,-0.4333953941292472,0.4333953941292472,-0.6794095682990244,0.6794095682990244,-0.8650633666889845,0.8650633666889845,-0.9739065285171717,0.9739065285171717],[0,-0.26954315595234496,0.26954315595234496,-0.5190961292068118,0.5190961292068118,-0.7301520055740494,0.7301520055740494,-0.8870625997680953,0.8870625997680953,-0.978228658146057,0.978228658146057],[-0.1252334085114689,0.1252334085114689,-0.3678314989981802,0.3678314989981802,-0.5873179542866175,0.5873179542866175,-0.7699026741943047,0.7699026741943047,-0.9041172563704749,0.9041172563704749,-0.9815606342467192,0.9815606342467192],[0,-0.2304583159551348,0.2304583159551348,-0.44849275103644687,0.44849275103644687,-0.6423493394403402,0.6423493394403402,-0.8015780907333099,0.8015780907333099,-0.9175983992229779,0.9175983992229779,-0.9841830547185881,0.9841830547185881],[-0.10805494870734367,0.10805494870734367,-0.31911236892788974,0.31911236892788974,-0.5152486363581541,0.5152486363581541,-0.6872929048116855,0.6872929048116855,-0.827201315069765,0.827201315069765,-0.9284348836635735,0.9284348836635735,-0.9862838086968123,0.9862838086968123],[0,-0.20119409399743451,0.20119409399743451,-0.3941513470775634,0.3941513470775634,-0.5709721726085388,0.5709721726085388,-0.7244177313601701,0.7244177313601701,-0.8482065834104272,0.8482065834104272,-0.937273392400706,0.937273392400706,-0.9879925180204854,0.9879925180204854],[-0.09501250983763744,0.09501250983763744,-0.2816035507792589,0.2816035507792589,-0.45801677765722737,0.45801677765722737,-0.6178762444026438,0.6178762444026438,-0.755404408355003,0.755404408355003,-0.8656312023878318,0.8656312023878318,-0.9445750230732326,0.9445750230732326,-0.9894009349916499,0.9894009349916499],[0,-0.17848418149584785,0.17848418149584785,-0.3512317634538763,0.3512317634538763,-0.5126905370864769,0.5126905370864769,-0.6576711592166907,0.6576711592166907,-0.7815140038968014,0.7815140038968014,-0.8802391537269859,0.8802391537269859,-0.9506755217687678,0.9506755217687678,-0.9905754753144174,0.9905754753144174],[-0.0847750130417353,0.0847750130417353,-0.2518862256915055,0.2518862256915055,-0.41175116146284263,0.41175116146284263,-0.5597708310739475,0.5597708310739475,-0.6916870430603532,0.6916870430603532,-0.8037049589725231,0.8037049589725231,-0.8926024664975557,0.8926024664975557,-0.9558239495713977,0.9558239495713977,-0.9915651684209309,0.9915651684209309],[0,-0.16035864564022537,0.16035864564022537,-0.31656409996362983,0.31656409996362983,-0.46457074137596094,0.46457074137596094,-0.600545304661681,0.600545304661681,-0.7209661773352294,0.7209661773352294,-0.8227146565371428,0.8227146565371428,-0.9031559036148179,0.9031559036148179,-0.96020815213483,0.96020815213483,-0.9924068438435844,0.9924068438435844],[-0.07652652113349734,0.07652652113349734,-0.22778585114164507,0.22778585114164507,-0.37370608871541955,0.37370608871541955,-0.5108670019508271,0.5108670019508271,-0.636053680726515,0.636053680726515,-0.7463319064601508,0.7463319064601508,-0.8391169718222188,0.8391169718222188,-0.912234428251326,0.912234428251326,-0.9639719272779138,0.9639719272779138,-0.9931285991850949,0.9931285991850949],[0,-0.1455618541608951,0.1455618541608951,-0.2880213168024011,0.2880213168024011,-0.4243421202074388,0.4243421202074388,-0.5516188358872198,0.5516188358872198,-0.6671388041974123,0.6671388041974123,-0.7684399634756779,0.7684399634756779,-0.8533633645833173,0.8533633645833173,-0.9200993341504008,0.9200993341504008,-0.9672268385663063,0.9672268385663063,-0.9937521706203895,0.9937521706203895],[-0.06973927331972223,0.06973927331972223,-0.20786042668822127,0.20786042668822127,-0.34193582089208424,0.34193582089208424,-0.469355837986757,0.469355837986757,-0.5876404035069116,0.5876404035069116,-0.6944872631866827,0.6944872631866827,-0.7878168059792081,0.7878168059792081,-0.8658125777203002,0.8658125777203002,-0.926956772187174,0.926956772187174,-0.9700604978354287,0.9700604978354287,-0.9942945854823992,0.9942945854823992],[0,-0.1332568242984661,0.1332568242984661,-0.26413568097034495,0.26413568097034495,-0.3903010380302908,0.3903010380302908,-0.5095014778460075,0.5095014778460075,-0.6196098757636461,0.6196098757636461,-0.7186613631319502,0.7186613631319502,-0.8048884016188399,0.8048884016188399,-0.8767523582704416,0.8767523582704416,-0.9329710868260161,0.9329710868260161,-0.9725424712181152,0.9725424712181152,-0.9947693349975522,0.9947693349975522],[-0.06405689286260563,0.06405689286260563,-0.1911188674736163,0.1911188674736163,-0.3150426796961634,0.3150426796961634,-0.4337935076260451,0.4337935076260451,-0.5454214713888396,0.5454214713888396,-0.6480936519369755,0.6480936519369755,-0.7401241915785544,0.7401241915785544,-0.820001985973903,0.820001985973903,-0.8864155270044011,0.8864155270044011,-0.9382745520027328,0.9382745520027328,-0.9747285559713095,0.9747285559713095,-0.9951872199970213,0.9951872199970213]];var __weight=[[],[],[1,1],[0.8888888888888888,0.5555555555555556,0.5555555555555556],[0.6521451548625461,0.6521451548625461,0.34785484513745385,0.34785484513745385],[0.5688888888888889,0.47862867049936647,0.47862867049936647,0.23692688505618908,0.23692688505618908],[0.3607615730481386,0.3607615730481386,0.46791393457269104,0.46791393457269104,0.17132449237917036,0.17132449237917036],[0.4179591836734694,0.3818300505051189,0.3818300505051189,0.27970539148927664,0.27970539148927664,0.1294849661688697,0.1294849661688697],[0.362683783378362,0.362683783378362,0.31370664587788727,0.31370664587788727,0.22238103445337448,0.22238103445337448,0.10122853629037626,0.10122853629037626],[0.3302393550012598,0.1806481606948574,0.1806481606948574,0.08127438836157441,0.08127438836157441,0.31234707704000286,0.31234707704000286,0.26061069640293544,0.26061069640293544],[0.29552422471475287,0.29552422471475287,0.26926671930999635,0.26926671930999635,0.21908636251598204,0.21908636251598204,0.1494513491505806,0.1494513491505806,0.06667134430868814,0.06667134430868814],[0.2729250867779006,0.26280454451024665,0.26280454451024665,0.23319376459199048,0.23319376459199048,0.18629021092773426,0.18629021092773426,0.1255803694649046,0.1255803694649046,0.05566856711617366,0.05566856711617366],[0.24914704581340277,0.24914704581340277,0.2334925365383548,0.2334925365383548,0.20316742672306592,0.20316742672306592,0.16007832854334622,0.16007832854334622,0.10693932599531843,0.10693932599531843,0.04717533638651183,0.04717533638651183],[0.2325515532308739,0.22628318026289723,0.22628318026289723,0.2078160475368885,0.2078160475368885,0.17814598076194574,0.17814598076194574,0.13887351021978725,0.13887351021978725,0.09212149983772845,0.09212149983772845,0.04048400476531588,0.04048400476531588],[0.2152638534631578,0.2152638534631578,0.2051984637212956,0.2051984637212956,0.18553839747793782,0.18553839747793782,0.15720316715819355,0.15720316715819355,0.12151857068790319,0.12151857068790319,0.08015808715976021,0.08015808715976021,0.03511946033175186,0.03511946033175186],[0.2025782419255613,0.19843148532711158,0.19843148532711158,0.1861610000155622,0.1861610000155622,0.16626920581699392,0.16626920581699392,0.13957067792615432,0.13957067792615432,0.10715922046717194,0.10715922046717194,0.07036604748810812,0.07036604748810812,0.03075324199611727,0.03075324199611727],[0.1894506104550685,0.1894506104550685,0.18260341504492358,0.18260341504492358,0.16915651939500254,0.16915651939500254,0.14959598881657674,0.14959598881657674,0.12462897125553388,0.12462897125553388,0.09515851168249279,0.09515851168249279,0.062253523938647894,0.062253523938647894,0.027152459411754096,0.027152459411754096],[0.17944647035620653,0.17656270536699264,0.17656270536699264,0.16800410215645004,0.16800410215645004,0.15404576107681028,0.15404576107681028,0.13513636846852548,0.13513636846852548,0.11188384719340397,0.11188384719340397,0.08503614831717918,0.08503614831717918,0.0554595293739872,0.0554595293739872,0.02414830286854793,0.02414830286854793],[0.1691423829631436,0.1691423829631436,0.16427648374583273,0.16427648374583273,0.15468467512626524,0.15468467512626524,0.14064291467065065,0.14064291467065065,0.12255520671147846,0.12255520671147846,0.10094204410628717,0.10094204410628717,0.07642573025488905,0.07642573025488905,0.0497145488949698,0.0497145488949698,0.02161601352648331,0.02161601352648331],[0.1610544498487837,0.15896884339395434,0.15896884339395434,0.15276604206585967,0.15276604206585967,0.1426067021736066,0.1426067021736066,0.12875396253933621,0.12875396253933621,0.11156664554733399,0.11156664554733399,0.09149002162245,0.09149002162245,0.06904454273764123,0.06904454273764123,0.0448142267656996,0.0448142267656996,0.019461788229726478,0.019461788229726478],[0.15275338713072584,0.15275338713072584,0.14917298647260374,0.14917298647260374,0.14209610931838204,0.14209610931838204,0.13168863844917664,0.13168863844917664,0.11819453196151841,0.11819453196151841,0.10193011981724044,0.10193011981724044,0.08327674157670475,0.08327674157670475,0.06267204833410907,0.06267204833410907,0.04060142980038694,0.04060142980038694,0.017614007139152118,0.017614007139152118],[0.14608113364969041,0.14452440398997005,0.14452440398997005,0.13988739479107315,0.13988739479107315,0.13226893863333747,0.13226893863333747,0.12183141605372853,0.12183141605372853,0.10879729916714838,0.10879729916714838,0.09344442345603386,0.09344442345603386,0.0761001136283793,0.0761001136283793,0.057134425426857205,0.057134425426857205,0.036953789770852494,0.036953789770852494,0.016017228257774335,0.016017228257774335],[0.13925187285563198,0.13925187285563198,0.13654149834601517,0.13654149834601517,0.13117350478706238,0.13117350478706238,0.12325237681051242,0.12325237681051242,0.11293229608053922,0.11293229608053922,0.10041414444288096,0.10041414444288096,0.08594160621706773,0.08594160621706773,0.06979646842452049,0.06979646842452049,0.052293335152683286,0.052293335152683286,0.03377490158481415,0.03377490158481415,0.0146279952982722,0.0146279952982722],[0.13365457218610619,0.1324620394046966,0.1324620394046966,0.12890572218808216,0.12890572218808216,0.12304908430672953,0.12304908430672953,0.11499664022241136,0.11499664022241136,0.10489209146454141,0.10489209146454141,0.09291576606003515,0.09291576606003515,0.07928141177671895,0.07928141177671895,0.06423242140852585,0.06423242140852585,0.04803767173108467,0.04803767173108467,0.030988005856979445,0.030988005856979445,0.013411859487141771,0.013411859487141771],[0.12793819534675216,0.12793819534675216,0.1258374563468283,0.1258374563468283,0.12167047292780339,0.12167047292780339,0.1155056680537256,0.1155056680537256,0.10744427011596563,0.10744427011596563,0.09761865210411388,0.09761865210411388,0.08619016153195327,0.08619016153195327,0.0733464814110803,0.0733464814110803,0.05929858491543678,0.05929858491543678,0.04427743881741981,0.04427743881741981,0.028531388628933663,0.028531388628933663,0.0123412297999872,0.0123412297999872]];var __approximateIntegralValue=function(_f,_a,_b,_n){if(!_n){_n=5}if(isNaN(_a)||isNaN(_b)){throw"invalid parameters: _a or _b is not a number"}if(_a>=_b){throw"invalid parameters: _a is greater or equal to _b"}if(!(typeof _f==="function")){throw"invalid parameters: _f is not a function"}if(isNaN(_n)||_n<2){throw"invalid parameters: _n is not a number or _n is less than 2"}var n=Math.max(_n,2);n=Math.min(n,MAX_POINTS);var sum=0;if(_a==-1&&_b==1){for(var i=0;i<n;++i){sum+=_f(__abscissa[n][i]*__weight[n][i])}return sum}else{var mult=0.5*(_b-_a);var ab2=0.5*(_a+_b);for(i=0;i<n;++i){sum+=_f(ab2+mult*__abscissa[n][i])*__weight[n][i]}return mult*sum}};var __quadraticCurve=function(t,p1,p2,p3){var mt=1-t;return mt*mt*p1+2*mt*t*p2+t*t*p3};var __cubicCurve=function(t,p1,p2,p3,p4){var mt=1-t;return mt*mt*mt*p1+3*mt*mt*t*p2+3*mt*t*t*p3+t*t*t*p4};var __base2=function(t,p1,p2,p3){return t*(2*p1-4*p2+2*p3)-2*p1+2*p2};var __base2Root=function(s,c,e){var numerator=s-c;var denominator=s-2*c+e;if(denominator===0){return -1}return numerator/denominator};var __base3=function(t,p1,p2,p3,p4){var t1=-3*p1+9*p2-9*p3+3*p4;var t2=t*t1+6*p1-12*p2+6*p3;return t*t2-3*p1+3*p2};var __base3Roots=function(s,c1,c2,e){var tl=-s+2*c1-c2;var tr=Math.sqrt(-s*(c2-e)+c1*c1-c1*(c2+e)+c2*c2);var denominator=-s+3*c1-3*c2+e;if(denominator===0){return[-1,-1]}return[(tl-tr)/denominator,(tl+tr)/denominator]};var __lineDistance=function(start,end){return Math.sqrt(Math.pow(end.x-start.x,2)+Math.pow(end.y-start.y,2))};var __quadraticBezierDistance=function(start,control,end,start_t,end_t,steps){if(start_t<0||start_t>1||start_t>end_t||end_t<0||end_t>1){throw new Error("values of t must be between 0 and 1.0")}return __approximateIntegralValue(function(_t){var xPrime=__base2(_t,start.x,control.x,end.x);var yPrime=__base2(_t,start.y,control.y,end.y);return Math.sqrt(xPrime*xPrime+yPrime*yPrime)},start_t,end_t,steps)};var __cubicBezierDistance=function(start,control1,control2,end,start_t,end_t,steps){if(start_t<0||start_t>1||start_t>end_t||end_t<0||end_t>1){throw new Error("values of t must be between 0 and 1.0")}return __approximateIntegralValue(function(_t){var xPrime=__base3(_t,start.x,control1.x,control2.x,end.x);var yPrime=__base3(_t,start.y,control1.y,control2.y,end.y);return Math.sqrt(xPrime*xPrime+yPrime*yPrime)},start_t,end_t,steps)};var __linearBoundingBox=function(start,end){return[{x:Math.min(start.x,end.x),y:Math.min(start.y,end.y)},{x:Math.max(start.x,end.x),y:Math.max(start.y,end.y)}]};var __quadraticBoundingBox=function(start,control1,end){var linearBounds=__linearBoundingBox(start,end);if(control1.x<linearBounds[0].x||control1.y<linearBounds[0].y||control1.x>linearBounds[1].x||control1.y>linearBounds[1].y){var tx=__base2Root(start.x,control1.x,end.x);if(tx>=0&&tx<=1){var x=__quadraticCurve(tx,start.x,control1.x,end.x);linearBounds[0].x=Math.min(linearBounds[0].x,x);linearBounds[1].x=Math.max(linearBounds[1].x,x)}var ty=__base2Root(start.y,control1.y,end.y);if(ty>=0&&ty<=1){var y=__quadraticCurve(ty,start.y,control1.y,end.y);linearBounds[0].y=Math.min(linearBounds[0].y,y);linearBounds[1].y=Math.max(linearBounds[1].y,y)}}return linearBounds};var __cubicBoundingBox=function(start,control1,control2,end){var linearBounds=__linearBoundingBox(start,end);if(control1.x<linearBounds[0].x||control1.y<linearBounds[0].y||control1.x>linearBounds[1].x||control1.y>linearBounds[1].y||control2.x<linearBounds[0].x||control2.y<linearBounds[0].y||control2.x>linearBounds[1].x||control2.y>linearBounds[1].y){var i;var tx=__base3Roots(start.x,control1.x,control2.x,end.x);for(i=0;i<tx.length;i++){var t=tx[i];if(t>=0&&t<=1){var x=__cubicCurve(t,start.x,control1.x,control2.x,end.x);linearBounds[0].x=Math.min(linearBounds[0].x,x);linearBounds[1].x=Math.max(linearBounds[1].x,x)}}var ty=__base3Roots(start.y,control1.y,control2.y,end.y);for(i=0;i<ty.length;i++){var t=ty[i];if(t>=0&&t<=1){var y=__cubicCurve(t,start.y,control1.y,control2.y,end.y);linearBounds[0].y=Math.min(linearBounds[0].y,y);linearBounds[1].y=Math.max(linearBounds[1].y,y)}}}return linearBounds};var __newtonsMethodQuadratic=function(start,control,end,distance,n,iterations){var xPrime=__base2(n,start.x,control.x,end.x);var yPrime=__base2(n,start.y,control.y,end.y);var nPlusOne=n-(__quadraticBezierDistance(start,control,end,0,n,12)-distance)/Math.sqrt(xPrime*xPrime+yPrime*yPrime);if(nPlusOne<=0){nPlusOne=0.00001}if(nPlusOne>=1){nPlusOne=0.99999}if(iterations===0){return nPlusOne}else{return __newtonsMethodQuadratic(start,control,end,distance,nPlusOne,--iterations)}};var __newtonsMethodCubic=function(start,control1,control2,end,distance,n,iterations){var xPrime=__base3(n,start.x,control1.x,control2.x,end.x);var yPrime=__base3(n,start.y,control1.y,control2.y,end.y);var nPlusOne=n-(__cubicBezierDistance(start,control1,control2,end,0,n,12)-distance)/Math.sqrt(xPrime*xPrime+yPrime*yPrime);if(nPlusOne<=0){nPlusOne=0.00001}if(nPlusOne>=1){nPlusOne=0.99999}if(iterations===0){return nPlusOne}else{return __newtonsMethodCubic(start,control1,control2,end,distance,nPlusOne,--iterations)}};var __splitQuadraticCurve=function(start,control,end,t){var a={x:(1-t)*start.x+t*control.x,y:(1-t)*start.y+t*control.y};var b={x:(1-t)*control.x+t*end.x,y:(1-t)*control.y+t*end.y};var c={x:(1-t)*a.x+t*b.x,y:(1-t)*a.y+t*b.y};return[[start,a,c],[c,b,end]]};var __splitCubicCurve=function(start,control1,control2,end,t){var a={x:(1-t)*start.x+t*control1.x,y:(1-t)*start.y+t*control1.y};var b={x:(1-t)*control1.x+t*control2.x,y:(1-t)*control1.y+t*control2.y};var c={x:(1-t)*control2.x+t*end.x,y:(1-t)*control2.y+t*end.y};var m={x:(1-t)*a.x+t*b.x,y:(1-t)*a.y+t*b.y};var n={x:(1-t)*b.x+t*c.x,y:(1-t)*b.y+t*c.y};var p={x:(1-t)*m.x+t*n.x,y:(1-t)*m.y+t*n.y};return[[start,a,m,p],[p,n,c,end]]};var __splitLine=function(start,end,distance){var splitPoint,unitVector,vector;vector=_gliffy.Vec2.difference(end,start);unitVector=vector.safeNormalize();splitPoint={x:start.x+distance*unitVector.x,y:start.y+distance*unitVector.y};return[[start,splitPoint],[splitPoint,end]]};var __zeroSumDashArrayFix=function(dasharray){var i,sum;sum=0;if(dasharray instanceof Array){for(i=0;i<dasharray.length;i++){sum+=parseFloat(dasharray[i])}}return sum===0||sum!==sum?[Number.MAX_VALUE]:dasharray};var RECURSIVE_CALL_LIMIT=3000;return{lineTo:function(start,end,ctx,callLayer){if(!callLayer){callLayer=0}if(callLayer>RECURSIVE_CALL_LIMIT){return}ctx.dasharray=__zeroSumDashArrayFix(ctx.dasharray);if(!ctx.dasharray){throw new Error("No dasharray property set on canvas context. Ex: ctx.dasharray = [10,5]")}if(!ctx.dashinfo){ctx.dashinfo={index:0,remainder:0}}var index=ctx.dashinfo.index%ctx.dasharray.length;var dash=ctx.dasharray[index];if(ctx.dashinfo.remainder&&ctx.dashinfo.remainder>0){dash=ctx.dashinfo.remainder}else{ctx.moveTo(start.x,start.y)}var distance=__lineDistance(start,end);if(distance<dash){if(index%2===0){ctx.lineTo(end.x,end.y)}ctx.dashinfo={remainder:(dash-distance),index:index}}else{var lines=__splitLine(start,end,dash);if(index%2===0){ctx.lineTo(lines[0][1].x,lines[0][1].y)}ctx.dashinfo={remainder:0,index:++index};this.lineTo(lines[1][0],lines[1][1],ctx,callLayer+1)}},quadraticCurveTo:function(start,control,end,ctx,callLayer){if(!callLayer){callLayer=0}if(callLayer>RECURSIVE_CALL_LIMIT){return}ctx.dasharray=__zeroSumDashArrayFix(ctx.dasharray);if(!ctx.dasharray){throw new Error("No dasharray property set on canvas context. Ex: ctx.dasharray = [10,5]")}if(!ctx.dashinfo){ctx.dashinfo={index:0,remainder:0}}var index=ctx.dashinfo.index%ctx.dasharray.length;var dash=ctx.dasharray[index];if(ctx.dashinfo.remainder&&ctx.dashinfo.remainder>0){dash=ctx.dashinfo.remainder}else{ctx.moveTo(start.x,start.y)}var distance=__quadraticBezierDistance(start,control,end,0,1,12);if(distance<dash){if(index%2===0){ctx.quadraticCurveTo(control.x,control.y,end.x,end.y)}ctx.dashinfo={remainder:dash-distance,index:index}}else{var t=__newtonsMethodQuadratic(start,control,end,dash,0.5,3);var curves=__splitQuadraticCurve(start,control,end,t);if(index%2===0){ctx.quadraticCurveTo(curves[0][1].x,curves[0][1].y,curves[0][2].x,curves[0][2].y)}ctx.dashinfo={remainder:0,index:++index};this.quadraticCurveTo(curves[1][0],curves[1][1],curves[1][2],ctx,callLayer+1)}},bezierCurveTo:function(start,control1,control2,end,ctx,callLayer){if(!callLayer){callLayer=0}if(callLayer>RECURSIVE_CALL_LIMIT){return}ctx.dasharray=__zeroSumDashArrayFix(ctx.dasharray);if(!ctx.dasharray){throw new Error("No dasharray property set on canvas context. Ex: ctx.dasharray = [10,5]")}if(!ctx.dashinfo){ctx.dashinfo={index:0,remainder:0}}var index=ctx.dashinfo.index%ctx.dasharray.length;var dash=ctx.dasharray[index];if(ctx.dashinfo.remainder&&ctx.dashinfo.remainder>0){dash=ctx.dashinfo.remainder}else{ctx.moveTo(start.x,start.y)}var distance=__cubicBezierDistance(start,control1,control2,end,0,1,12);if(distance<dash){if(index%2===0){ctx.bezierCurveTo(control1.x,control1.y,control2.x,control2.y,end.x,end.y)}ctx.dashinfo={remainder:dash-distance,index:index}}else{var t=__newtonsMethodCubic(start,control1,control2,end,dash,0.5,3);var curves=__splitCubicCurve(start,control1,control2,end,t);if(index%2===0){ctx.bezierCurveTo(curves[0][1].x,curves[0][1].y,curves[0][2].x,curves[0][2].y,curves[0][3].x,curves[0][3].y)}ctx.dashinfo={remainder:0,index:++index};this.bezierCurveTo(curves[1][0],curves[1][1],curves[1][2],curves[1][3],ctx,callLayer+1)}},cleanCtx:function(ctx){delete ctx.dashinfo;delete ctx.dasharray},getPathDistance:function(path){var totalDistance=0;var distanceArray=[];for(var i=0;i<path.length;i++){var line=path[i];switch(line.length){case 2:var d=__lineDistance(line[0],line[1]);distanceArray.push(d);totalDistance+=d;break;case 3:var d=__quadraticBezierDistance(line[0],line[1],line[2],0,1,12);distanceArray.push(d);totalDistance+=d;break;case 4:var d=__cubicBezierDistance(line[0],line[1],line[2],line[3],0,1,12);distanceArray.push(d);totalDistance+=d;break;default:throw new Error("a line with "+line.length+" points is unsupported")}}return{totalDistance:totalDistance,distanceArray:distanceArray}},getPointInPathAtT:function(path,t){if(t===0){return path[0][0]}else{if(t===1){var last=path[path.length-1];return last[last.length-1]}else{var d=this.getPathDistance(path);return this.getPointInPathAtDistance(path,d.totalDistance*t,d)}}},getBoundingBox:function(path){var bounds;for(var i=0;i<path.length;i++){var line=path[i];switch(line.length){case 2:var b=__linearBoundingBox(line[0],line[1]);if(!bounds){bounds=b}else{bounds[0].x=Math.min(bounds[0].x,b[0].x);bounds[0].y=Math.min(bounds[0].y,b[0].y);bounds[1].x=Math.max(bounds[1].x,b[1].x);bounds[1].y=Math.max(bounds[1].y,b[1].y)}break;case 3:var b=__quadraticBoundingBox(line[0],line[1],line[2]);if(!bounds){bounds=b}else{bounds[0].x=Math.min(bounds[0].x,b[0].x);bounds[0].y=Math.min(bounds[0].y,b[0].y);bounds[1].x=Math.max(bounds[1].x,b[1].x);bounds[1].y=Math.max(bounds[1].y,b[1].y)}break;case 4:var b=__cubicBoundingBox(line[0],line[1],line[2],line[3]);if(!bounds){bounds=b}else{bounds[0].x=Math.min(bounds[0].x,b[0].x);bounds[0].y=Math.min(bounds[0].y,b[0].y);bounds[1].x=Math.max(bounds[1].x,b[1].x);bounds[1].y=Math.max(bounds[1].y,b[1].y)}break;default:throw new Error("a line with "+line.length+" points is unsupported")}}return bounds},getPointInPathAtDistance:function(path,distance,distanceInfo){if(distance===0){return path[0][0]}else{var d=(distanceInfo)?distanceInfo:this.getPathDistance(path);var i=0,distanceLeft=distance;while(distanceLeft>d.distanceArray[i]){distanceLeft-=d.distanceArray[i];i++}if(i>=path.length){var points=path[i-1];return points[points.length-1]}switch(path[i].length){case 2:return __splitLine(path[i][0],path[i][1],distanceLeft)[0][1];case 3:var t=__newtonsMethodQuadratic(path[i][0],path[i][1],path[i][2],distanceLeft,0.5,3);return __splitQuadraticCurve(path[i][0],path[i][1],path[i][2],t)[0][2];case 4:var t=__newtonsMethodCubic(path[i][0],path[i][1],path[i][2],path[i][3],distanceLeft,0.5,3);return __splitCubicCurve(path[i][0],path[i][1],path[i][2],path[i][3],t)[0][3];default:throw new Error("a line with "+path[i].length+" points is unsupported")}}},library:{__splitLine:__splitLine}}};_gliffy.candash=candash()})();(function(){var Point,PathParser,Linevg,compressSpaces,trim,drawPath,generatedDrawPath;compressSpaces=function(s){return s.replace(/[\s\r\t\n]+/gm," ")};trim=function(s){return s.replace(/^\s+|\s+$/g,"")};Point=function(x,y){this.x=x;this.y=y};Point.prototype.angleTo=function(p){return Math.atan2(p.y-this.y,p.x-this.x)};Point.prototype.applyTransform=function(v){var xp=this.x*v[0]+this.y*v[2]+v[4];var yp=this.x*v[1]+this.y*v[3]+v[5];this.x=xp;this.y=yp};PathParser=function(d){var i,tokens=[];for(i=0;i<d.length;i++){tokens.push(d[i].name);tokens=tokens.concat(d[i].args.split(/[,\s+)]/))}this.tokens=tokens};PathParser.prototype.reset=function(){this.i=-1;this.command="";this.previousCommand="";this.start=new Point(0,0);this.control=new Point(0,0);this.current=new Point(0,0);this.points=[];this.angles=[]};PathParser.prototype.isEnd=function(){return this.i>=this.tokens.length-1};PathParser.prototype.isCommandOrEnd=function(){if(this.isEnd()){return true}return this.tokens[this.i+1].match(/^[A-Za-z]$/)!=null};PathParser.prototype.isRelativeCommand=function(){switch(this.command){case"m":case"l":case"h":case"v":case"c":case"s":case"q":case"t":case"a":case"z":return true;break}return false};PathParser.prototype.getToken=function(){this.i++;return this.tokens[this.i]};PathParser.prototype.getScalar=function(){return parseFloat(this.getToken())};PathParser.prototype.nextCommand=function(){this.previousCommand=this.command;this.command=this.getToken()};PathParser.prototype.getPoint=function(){var p=new Point(this.getScalar(),this.getScalar());return this.makeAbsolute(p)};PathParser.prototype.getAsControlPoint=function(){var p=this.getPoint();this.control=p;return p};PathParser.prototype.getAsCurrentPoint=function(){var p=this.getPoint();this.current=p;return p};PathParser.prototype.getReflectedControlPoint=function(){if(this.previousCommand.toLowerCase()!="c"&&this.previousCommand.toLowerCase()!="s"){return this.current}return new Point(2*this.current.x-this.control.x,2*this.current.y-this.control.y)};PathParser.prototype.makeAbsolute=function(p){if(this.isRelativeCommand()){p.x+=this.current.x;p.y+=this.current.y}return p};PathParser.prototype.addMarker=function(p,from,priorTo){var pointPath,length,referencePointForAngle;pointPath=_gliffy.Utils.buildPointsPathFromDrawingCommand(generatedDrawPath);length=_gliffy.candash.getPathDistance(pointPath);if(pointPath.length>0){referencePointForAngle=_gliffy.candash.getPointInPathAtDistance(pointPath,10,length)}else{referencePointForAngle=p}if(priorTo!=null&&this.angles.length>0&&this.angles[this.angles.length-1]==null){this.angles[this.angles.length-1]=this.points[this.points.length-1].angleTo(referencePointForAngle)}this.addMarkerAngle(p,from==null?null:from.angleTo(p))};PathParser.prototype.addMarkerAngle=function(p,a){this.points.push(p);this.angles.push(a)};PathParser.prototype.getMarkerPoints=function(){return this.points};PathParser.prototype.getMarkerAngles=function(){for(var i=0;i<this.angles.length;i++){if(this.angles[i]==null){for(var j=i+1;j<this.angles.length;j++){if(this.angles[j]!=null){this.angles[i]=this.angles[j];break}}}}return this.angles};PathParser.prototype.generateDrawPath=function(){var drawPath=[],drawCommandObject,coordinatePairCounter=1,self=this;_.each(this.tokens,function(pathToken){if(self.isPathCommand(pathToken)){if(drawCommandObject){drawPath.push(drawCommandObject);coordinatePairCounter=1}drawCommandObject={};drawCommandObject.name=pathToken}else{if(coordinatePairCounter%3===0){drawCommandObject.args+=" "+pathToken}else{if(drawCommandObject.args===undefined){drawCommandObject.args=pathToken}else{drawCommandObject.args+=","+pathToken}}coordinatePairCounter+=1}});return drawPath};PathParser.prototype.isPathCommand=function(path){switch(path.toLowerCase()){case"m":case"l":case"h":case"v":case"c":case"s":case"q":case"t":case"a":case"z":return true;break}return false};drawPath=function(ctx,pp){var p,c,curr,p1,cntrl,cp,currp,cpp,centp,newP,r,rx,ry,sx,sy,u,v,ad,a,m,l,a1,xAxisRotation,largeArcFlag,sweepFlag,halfWay;pp.reset();if(ctx!=null){ctx.beginPath()}while(!pp.isEnd()){pp.nextCommand();switch(pp.command){case"M":case"m":p=pp.getAsCurrentPoint();pp.addMarker(p);if(ctx!=null){ctx.moveTo(p.x,p.y)}pp.start=pp.current;while(!pp.isCommandOrEnd()){p=pp.getAsCurrentPoint();pp.addMarker(p,pp.start);if(ctx!=null){ctx.lineTo(p.x,p.y)}}break;case"L":case"l":while(!pp.isCommandOrEnd()){c=pp.current;p=pp.getAsCurrentPoint();pp.addMarker(p,c);if(ctx!=null){if(ctx.dasharray&&ctx.dasharray.length>0){_gliffy.candash.lineTo({x:c.x,y:c.y},{x:p.x,y:p.y},ctx)}else{ctx.lineTo(p.x,p.y)}}}break;case"H":case"h":while(!pp.isCommandOrEnd()){newP=new Point((pp.isRelativeCommand()?pp.current.x:0)+pp.getScalar(),pp.current.y);pp.addMarker(newP,pp.current);pp.current=newP;if(ctx!=null){ctx.lineTo(pp.current.x,pp.current.y)}}break;case"V":case"v":while(!pp.isCommandOrEnd()){newP=new Point(pp.current.x,(pp.isRelativeCommand()?pp.current.y:0)+pp.getScalar());pp.addMarker(newP,pp.current);pp.current=newP;if(ctx!=null){ctx.lineTo(pp.current.x,pp.current.y)}}break;case"C":case"c":while(!pp.isCommandOrEnd()){curr=pp.current;p1=pp.getPoint();cntrl=pp.getAsControlPoint();cp=pp.getAsCurrentPoint();pp.addMarker(cp,cntrl,p1);if(ctx!=null){if(ctx.dasharray&&ctx.dasharray.length>0){_gliffy.candash.bezierCurveTo({x:curr.x,y:curr.y},{x:p1.x,y:p1.y},{x:cntrl.x,y:cntrl.y},{x:cp.x,y:cp.y},ctx)}else{ctx.bezierCurveTo(p1.x,p1.y,cntrl.x,cntrl.y,cp.x,cp.y)}}}break;case"S":case"s":while(!pp.isCommandOrEnd()){curr=pp.current;p1=pp.getReflectedControlPoint();cntrl=pp.getAsControlPoint();cp=pp.getAsCurrentPoint();pp.addMarker(cp,cntrl,p1);if(ctx!=null){ctx.bezierCurveTo(p1.x,p1.y,cntrl.x,cntrl.y,cp.x,cp.y)}}break;case"Q":case"q":while(!pp.isCommandOrEnd()){curr=pp.current;cntrl=pp.getAsControlPoint();cp=pp.getAsCurrentPoint();pp.addMarker(cp,cntrl,cntrl);if(ctx!=null){if(ctx.dasharray&&ctx.dasharray.length>0){_gliffy.candash.quadraticCurveTo({x:curr.x,y:curr.y},{x:cntrl.x,y:cntrl.y},{x:cp.x,y:cp.y},ctx)}else{ctx.quadraticCurveTo(cntrl.x,cntrl.y,cp.x,cp.y)}}}break;case"T":case"t":while(!pp.isCommandOrEnd()){curr=pp.current;cntrl=pp.getReflectedControlPoint();pp.control=cntrl;cp=pp.getAsCurrentPoint();pp.addMarker(cp,cntrl,cntrl);if(ctx!=null){ctx.quadraticCurveTo(cntrl.x,cntrl.y,cp.x,cp.y)}}break;case"A":case"a":while(!pp.isCommandOrEnd()){curr=pp.current;rx=pp.getScalar();ry=pp.getScalar();xAxisRotation=pp.getScalar()*(Math.PI/180);largeArcFlag=pp.getScalar();sweepFlag=pp.getScalar();cp=pp.getAsCurrentPoint();currp=new Point(Math.cos(xAxisRotation)*(curr.x-cp.x)/2+Math.sin(xAxisRotation)*(curr.y-cp.y)/2,-Math.sin(xAxisRotation)*(curr.x-cp.x)/2+Math.cos(xAxisRotation)*(curr.y-cp.y)/2);l=Math.pow(currp.x,2)/Math.pow(rx,2)+Math.pow(currp.y,2)/Math.pow(ry,2);if(l>1){rx*=Math.sqrt(l);ry*=Math.sqrt(l)}var s=(largeArcFlag==sweepFlag?-1:1)*Math.sqrt(((Math.pow(rx,2)*Math.pow(ry,2))-(Math.pow(rx,2)*Math.pow(currp.y,2))-(Math.pow(ry,2)*Math.pow(currp.x,2)))/(Math.pow(rx,2)*Math.pow(currp.y,2)+Math.pow(ry,2)*Math.pow(currp.x,2)));if(isNaN(s)){s=0}cpp=new Point(s*rx*currp.y/ry,s*-ry*currp.x/rx);centp=new Point((curr.x+cp.x)/2+Math.cos(xAxisRotation)*cpp.x-Math.sin(xAxisRotation)*cpp.y,(curr.y+cp.y)/2+Math.sin(xAxisRotation)*cpp.x+Math.cos(xAxisRotation)*cpp.y);m=function(v){return Math.sqrt(Math.pow(v[0],2)+Math.pow(v[1],2))};r=function(u,v){return(u[0]*v[0]+u[1]*v[1])/(m(u)*m(v))};a=function(u,v){return(u[0]*v[1]<u[1]*v[0]?-1:1)*Math.acos(r(u,v))};a1=a([1,0],[(currp.x-cpp.x)/rx,(currp.y-cpp.y)/ry]);u=[(currp.x-cpp.x)/rx,(currp.y-cpp.y)/ry];v=[(-currp.x-cpp.x)/rx,(-currp.y-cpp.y)/ry];ad=a(u,v);if(r(u,v)<=-1){ad=Math.PI}if(r(u,v)>=1){ad=0}if(sweepFlag==0&&ad>0){ad=ad-2*Math.PI}if(sweepFlag==1&&ad<0){ad=ad+2*Math.PI}halfWay=new Point(centp.x-rx*Math.cos((a1+ad)/2),centp.y-ry*Math.sin((a1+ad)/2));pp.addMarkerAngle(halfWay,(a1+ad)/2+(sweepFlag==0?1:-1)*Math.PI/2);pp.addMarkerAngle(cp,ad+(sweepFlag==0?1:-1)*Math.PI/2);if(ctx!=null){r=rx>ry?rx:ry;sx=rx>ry?1:rx/ry;sy=rx>ry?ry/rx:1;ctx.translate(centp.x,centp.y);ctx.rotate(xAxisRotation);ctx.scale(sx,sy);ctx.arc(0,0,r,a1,a1+ad,1-sweepFlag);ctx.scale(1/sx,1/sy);ctx.rotate(-xAxisRotation);ctx.translate(-centp.x,-centp.y)}}break;case"Z":case"z":if(ctx!=null){ctx.closePath()}pp.current=pp.start}}ctx.stroke()};Linevg=function(d){this.PathParser=new PathParser(d)};Linevg.prototype.getMarkers=function(){var points=this.PathParser.getMarkerPoints();var angles=this.PathParser.getMarkerAngles();var markers=[];for(var i=0;i<points.length;i++){markers.push([points[i],angles[i]])}return markers};Linevg.prototype.drawPath=function(ctx,data){var angle,point,markers;ctx.save();if(data.stroke_width!==undefined&&data.stroke_width!==null){ctx.lineWidth=data.stroke_width}if(data.stroke_dasharray!==undefined&&data.stroke_dasharray!==null){ctx.dasharray=data.stroke_dasharray.split(",")}if(data.opacity!==undefined&&data.opacity!==null){ctx.globalAlpha=data.opacity}if(data.stroke_linejoin!==undefined&&data.stroke_linejoin!==null){ctx.lineJoin=data.stroke_linejoin}if(data.stroke!==undefined&&data.stroke!==null){ctx.strokeStyle=(data.strokeStyle==="none")?"rgba(0,0,0,0)":data.stroke}generatedDrawPath=this.PathParser.generateDrawPath();drawPath(ctx,this.PathParser);if(ctx.dasharray){_gliffy.candash.cleanCtx(ctx)}markers=this.getMarkers();if(data.start_arrow!==0&&data.start_arrow!==null&&data.start_arrow!==undefined&&data.start_arrow!=="none"){ctx.save();point=markers[0][0];angle=markers[0][1];ctx.translate(point.x,point.y);if(data.marker_start_orient==="auto"){ctx.rotate(angle)}else{ctx.rotate(data.marker_start_orient*Math.PI/180)}_gliffy.shapeLibrary.drawStencil(data.start_arrow_tid,ctx,data);ctx.restore()}if(data.end_arrow!==0&&data.end_arrow!==null&&data.end_arrow!==undefined&&data.end_arrow!=="none"){ctx.save();point=markers[markers.length-1][0];angle=markers[markers.length-1][1];ctx.translate(point.x,point.y);if(data.marker_end_orient==="auto"){ctx.rotate(angle)}else{ctx.rotate(data.marker_end_orient*Math.PI/180)}_gliffy.shapeLibrary.drawStencil(data.end_arrow_tid,ctx,data);ctx.restore()}ctx.restore()};_gliffy.Linevg=Linevg}());(function(){var styleProp=($.browser.msie)?"display":"pointerEvents";var KoreSampl=function(){};KoreSampl.prototype.fromEvent=function(e,lastElement){e=e||window.event;return this.atPoint(e.clientX,e.clientY,lastElement)};KoreSampl.prototype.atPoint=function(clientX,clientY,lastElement,previousElement){var d=(lastElement)?lastElement.ownerDocument:document;lastElement=lastElement||d.getElementsByTagName("html")[0];var element=d.elementFromPoint(clientX,clientY);if(element===null||element===undefined||element===previousElement){return[]}else{if(element===lastElement||element.nodeName==="HTML"){return[element]}else{var style=element.style[styleProp];element.style[styleProp]="none";var result=[element].concat(this.atPoint(clientX,clientY,lastElement,element));element.style[styleProp]=style;return result}}};_gliffy.KoreSampl=new KoreSampl()})();(function(){var isDef=function(val){return val!==undefined};var Coordinate=function(opt_x,opt_y){this.x=isDef(opt_x)?opt_x:0;this.y=isDef(opt_y)?opt_y:0};Coordinate.prototype.clone=function(){return new Coordinate(this.x,this.y)};Coordinate.prototype.toString=function(){return"("+this.x+", "+this.y+")"};Coordinate.equals=function(a,b){if(a==b){return true}if(!a||!b){return false}return a.x==b.x&&a.y==b.y};Coordinate.distance=function(a,b){var dx=a.x-b.x;var dy=a.y-b.y;return Math.sqrt(dx*dx+dy*dy)};Coordinate.squaredDistance=function(a,b){var dx=a.x-b.x;var dy=a.y-b.y;return dx*dx+dy*dy};Coordinate.difference=function(a,b){return new Coordinate(a.x-b.x,a.y-b.y)};Coordinate.sum=function(a,b){return new Coordinate(a.x+b.x,a.y+b.y)};_gliffy.Coordinate=Coordinate})();(function(){var inherits=function(childCtor,parentCtor){function tempCtor(){}tempCtor.prototype=parentCtor.prototype;childCtor.superClass_=parentCtor.prototype;childCtor.prototype=new tempCtor();childCtor.prototype.constructor=childCtor};var Vec2=function(x,y){this.x=x;this.y=y};inherits(Vec2,_gliffy.Coordinate);Vec2.randomUnit=function(){var angle=Math.random()*Math.PI*2;return new Vec2(Math.cos(angle),Math.sin(angle))};Vec2.random=function(){var mag=Math.sqrt(Math.random());var angle=Math.random()*Math.PI*2;return new Vec2(Math.cos(angle)*mag,Math.sin(angle)*mag)};Vec2.fromCoordinate=function(a){return new Vec2(a.x,a.y)};Vec2.prototype.clone=function(){return new Vec2(this.x,this.y)};Vec2.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};Vec2.prototype.squaredMagnitude=function(){return this.x*this.x+this.y*this.y};Vec2.prototype.scale=function(s){this.x*=s;this.y*=s;return this};Vec2.prototype.invert=function(){this.x=-this.x;this.y=-this.y;return this};Vec2.prototype.normalize=function(){return this.scale(1/this.magnitude())};Vec2.prototype.safeNormalize=function(){var mag=this.magnitude();if(mag>0.00001){return this.scale(1/mag)}return this};Vec2.prototype.add=function(b){this.x+=b.x;this.y+=b.y;return this};Vec2.prototype.subtract=function(b){this.x-=b.x;this.y-=b.y;return this};Vec2.prototype.rotate=function(angle){var cos=Math.cos(angle);var sin=Math.sin(angle);var newX=this.x*cos-this.y*sin;var newY=this.y*cos+this.x*sin;this.x=newX;this.y=newY;return this};Vec2.rotateAroundPoint=function(v,axisPoint,angle){var res=v.clone();return res.subtract(axisPoint).rotate(angle).add(axisPoint)};Vec2.prototype.equals=function(b){return this==b||!!b&&this.x==b.x&&this.y==b.y};Vec2.distance=_gliffy.Coordinate.distance;Vec2.squaredDistance=_gliffy.Coordinate.squaredDistance;Vec2.equals=_gliffy.Coordinate.equals;Vec2.sum=function(a,b){return new Vec2(a.x+b.x,a.y+b.y)};Vec2.difference=function(a,b){return new Vec2(a.x-b.x,a.y-b.y)};Vec2.dot=function(a,b){return a.x*b.x+a.y*b.y};var lerp=function(a,b,x){return a+x*(b-a)};Vec2.lerp=function(a,b,x){return new Vec2(lerp(a.x,b.x,x),lerp(a.y,b.y,x))};_gliffy.Vec2=Vec2})();(function($){var ColorPicker=function(){var ids={},inAction,charMin=65,visible,__callback,__newColor,__mode="fill",tpl="",defaults={eventName:"click",onShow:function(){},onBeforeShow:function(){},onHide:function(){},onChange:function(){},onSubmit:function(){},color:"ff0000",livePreview:true,flat:false},fillRGBFields=function(hsb,cal){var rgb=HSBToRGB(hsb);$(cal).data("colorpicker").fields.eq(1).val(rgb.r).end().eq(2).val(rgb.g).end().eq(3).val(rgb.b).end()},fillHSBFields=function(hsb,cal){$(cal).data("colorpicker").fields.eq(4).val(Math.round(hsb.h)).end().eq(5).val(Math.round(hsb.s)).end().eq(6).val(Math.round(hsb.b)).end()},fillHexFields=function(hsb,cal){$(cal).data("colorpicker").fields.eq(0).val(HSBToHex(hsb)).end()},setSelector=function(hsb,cal){$(cal).data("colorpicker").selector.css("backgroundColor","#"+HSBToHex({h:hsb.h,s:100,b:100}));$(cal).data("colorpicker").selectorIndic.css({left:parseInt(150*hsb.s/100,10),top:parseInt(150*(100-hsb.b)/100,10)})},setHue=function(hsb,cal){$(cal).data("colorpicker").hue.css("top",parseInt(150-150*hsb.h/360,10))},setCurrentColor=function(hsb,cal){$(cal).data("colorpicker").currentColor.css("backgroundColor","#"+HSBToHex(hsb))},setNewColor=function(hsb,cal){var tempHex="#"+HSBToHex(hsb);$(cal).data("colorpicker").newColor.css("backgroundColor",tempHex);__newColor=tempHex},keyDown=function(ev){var pressedKey=ev.charCode||ev.keyCode||-1;if((pressedKey>charMin&&pressedKey<=90)||pressedKey==32){return false}var cal=$(this).parent().parent();if(cal.data("colorpicker").livePreview===true){change.apply(this)}},change=function(ev){var cal=$(this).parent().parent(),col;if(this.parentNode.className.indexOf("_hex")>0){cal.data("colorpicker").color=col=HexToHSB(fixHex(this.value))}else{if(this.parentNode.className.indexOf("_hsb")>0){cal.data("colorpicker").color=col=fixHSB({h:parseInt(cal.data("colorpicker").fields.eq(4).val(),10),s:parseInt(cal.data("colorpicker").fields.eq(5).val(),10),b:parseInt(cal.data("colorpicker").fields.eq(6).val(),10)})}else{cal.data("colorpicker").color=col=RGBToHSB(fixRGB({r:parseInt(cal.data("colorpicker").fields.eq(1).val(),10),g:parseInt(cal.data("colorpicker").fields.eq(2).val(),10),b:parseInt(cal.data("colorpicker").fields.eq(3).val(),10)}))}}if(ev){fillRGBFields(col,cal.get(0));fillHexFields(col,cal.get(0));fillHSBFields(col,cal.get(0))}setSelector(col,cal.get(0));setHue(col,cal.get(0));setNewColor(col,cal.get(0));cal.data("colorpicker").onChange.apply(cal,[col,HSBToHex(col),HSBToRGB(col)])},blur=function(ev){var cal=$(this).parent().parent();cal.data("colorpicker").fields.parent().removeClass("colorpicker_focus")},focus=function(){charMin=this.parentNode.className.indexOf("_hex")>0?70:65;$(this).parent().parent().data("colorpicker").fields.parent().removeClass("colorpicker_focus");$(this).parent().addClass("colorpicker_focus")},downIncrement=function(ev){var field=$(this).parent().find("input").focus();var current={el:$(this).parent().addClass("colorpicker_slider"),max:this.parentNode.className.indexOf("_hsb_h")>0?360:(this.parentNode.className.indexOf("_hsb")>0?100:255),y:ev.pageY,field:field,val:parseInt(field.val(),10),preview:$(this).parent().parent().data("colorpicker").livePreview};$(document).bind("mouseup",current,upIncrement);$(document).bind("mousemove",current,moveIncrement)},moveIncrement=function(ev){ev.data.field.val(Math.max(0,Math.min(ev.data.max,parseInt(ev.data.val+ev.pageY-ev.data.y,10))));if(ev.data.preview){change.apply(ev.data.field.get(0),[true])}return false},upIncrement=function(ev){change.apply(ev.data.field.get(0),[true]);ev.data.el.removeClass("colorpicker_slider").find("input").focus();$(document).unbind("mouseup",upIncrement);$(document).unbind("mousemove",moveIncrement);return false},downHue=function(ev){var current={cal:$(this).parent(),y:$(this).offset().top};current.preview=current.cal.data("colorpicker").livePreview;$(document).bind("mouseup",current,upHue);$(document).bind("mousemove",current,moveHue);$(document).bind("mousedown",current,moveHue)},moveHue=function(ev){change.apply(ev.data.cal.data("colorpicker").fields.eq(4).val(parseInt(360*(150-Math.max(0,Math.min(150,(ev.pageY-ev.data.y))))/150,10)).get(0),[ev.data.preview]);return false},upHue=function(ev){fillRGBFields(ev.data.cal.data("colorpicker").color,ev.data.cal.get(0));fillHexFields(ev.data.cal.data("colorpicker").color,ev.data.cal.get(0));$(document).unbind("mouseup",upHue);$(document).unbind("mousemove",moveHue);$(document).unbind("mousedown",moveHue);return false},downSelector=function(ev){var current={cal:$(this).parent(),pos:$(this).offset()};current.preview=current.cal.data("colorpicker").livePreview;$(document).bind("mouseup",current,upSelector);$(document).bind("mousemove",current,moveSelector);$(document).bind("mousedown",current,moveSelector)},moveSelector=function(ev){change.apply(ev.data.cal.data("colorpicker").fields.eq(6).val(parseInt(100*(150-Math.max(0,Math.min(150,(ev.pageY-ev.data.pos.top))))/150,10)).end().eq(5).val(parseInt(100*(Math.max(0,Math.min(150,(ev.pageX-ev.data.pos.left))))/150,10)).get(0),[ev.data.preview]);return false},upSelector=function(ev){fillRGBFields(ev.data.cal.data("colorpicker").color,ev.data.cal.get(0));fillHexFields(ev.data.cal.data("colorpicker").color,ev.data.cal.get(0));$(document).unbind("mouseup",upSelector);$(document).unbind("mousemove",moveSelector);$(document).unbind("mousedown",moveSelector);return false},enterSubmit=function(ev){$(this).removeClass("gliffy-icon-colorpicker-submit").addClass("colorpicker_focus gliffy-icon-colorpicker-submit-hover")},leaveSubmit=function(ev){$(this).removeClass("colorpicker_focus gliffy-icon-colorpicker-submit-hover").addClass("gliffy-icon-colorpicker-submit")},clickSubmit=function(ev){var cal=$(this).parent();var col=cal.data("colorpicker").color;cal.data("colorpicker").origColor=col;setCurrentColor(col,cal.get(0));cal.data("colorpicker").onSubmit(col,HSBToHex(col),HSBToRGB(col),cal.data("colorpicker").el)},show=function(ev){var cal=$("#"+$(this).data("colorpickerId"));cal.data("colorpicker").onBeforeShow.apply(this,[cal.get(0)]);var pos=$(this).offset();var viewPort=getViewport();var top=pos.top+this.offsetHeight;var left=pos.left;if(top+176>viewPort.t+viewPort.h){top-=this.offsetHeight+176}if(left+356>viewPort.l+viewPort.w){left-=356}cal.css({left:left+"px",top:top+"px"});if(cal.data("colorpicker").onShow.apply(this,[cal.get(0)])!=false){cal.show()}$(document).bind("mousedown",{cal:cal},hide);return false},hide=function(ev){},isChildOf=function(parentEl,el,container){if(parentEl==el){return true}if(parentEl.contains){return parentEl.contains(el)}if(parentEl.compareDocumentPosition){return !!(parentEl.compareDocumentPosition(el)&16)}var prEl=el.parentNode;while(prEl&&prEl!=container){if(prEl==parentEl){return true}prEl=prEl.parentNode}return false},getViewport=function(){var m=document.compatMode=="CSS1Compat";return{l:window.pageXOffset||(m?document.documentElement.scrollLeft:document.body.scrollLeft),t:window.pageYOffset||(m?document.documentElement.scrollTop:document.body.scrollTop),w:window.innerWidth||(m?document.documentElement.clientWidth:document.body.clientWidth),h:window.innerHeight||(m?document.documentElement.clientHeight:document.body.clientHeight)}},fixHSB=function(hsb){return{h:Math.min(360,Math.max(0,hsb.h)),s:Math.min(100,Math.max(0,hsb.s)),b:Math.min(100,Math.max(0,hsb.b))}},fixRGB=function(rgb){return{r:Math.min(255,Math.max(0,rgb.r)),g:Math.min(255,Math.max(0,rgb.g)),b:Math.min(255,Math.max(0,rgb.b))}},fixHex=function(hex){var len=6-hex.length;if(len>0){var o=[];for(var i=0;i<len;i++){o.push("0")}o.push(hex);hex=o.join("")}return hex},HexToRGB=function(hex){var hex=parseInt(((hex.indexOf("#")>-1)?hex.substring(1):hex),16);return{r:hex>>16,g:(hex&65280)>>8,b:(hex&255)}},HexToHSB=function(hex){return RGBToHSB(HexToRGB(hex))},RGBToHSB=function(rgb){var hsb={h:0,s:0,b:0};var min=Math.min(rgb.r,rgb.g,rgb.b);var max=Math.max(rgb.r,rgb.g,rgb.b);var delta=max-min;hsb.b=max;if(max!=0){}hsb.s=max!=0?255*delta/max:0;if(hsb.s!=0){if(rgb.r==max){hsb.h=(rgb.g-rgb.b)/delta}else{if(rgb.g==max){hsb.h=2+(rgb.b-rgb.r)/delta}else{hsb.h=4+(rgb.r-rgb.g)/delta}}}else{hsb.h=-1}hsb.h*=60;if(hsb.h<0){hsb.h+=360}hsb.s*=100/255;hsb.b*=100/255;return hsb},HSBToRGB=function(hsb){var rgb={};var h=Math.round(hsb.h);var s=Math.round(hsb.s*255/100);var v=Math.round(hsb.b*255/100);if(s==0){rgb.r=rgb.g=rgb.b=v}else{var t1=v;var t2=(255-s)*v/255;var t3=(t1-t2)*(h%60)/60;if(h==360){h=0}if(h<60){rgb.r=t1;rgb.b=t2;rgb.g=t2+t3}else{if(h<120){rgb.g=t1;rgb.b=t2;rgb.r=t1-t3}else{if(h<180){rgb.g=t1;rgb.r=t2;rgb.b=t2+t3}else{if(h<240){rgb.b=t1;rgb.r=t2;rgb.g=t1-t3}else{if(h<300){rgb.b=t1;rgb.g=t2;rgb.r=t2+t3}else{if(h<360){rgb.r=t1;rgb.g=t2;rgb.b=t1-t3}else{rgb.r=0;rgb.g=0;rgb.b=0}}}}}}}return{r:Math.round(rgb.r),g:Math.round(rgb.g),b:Math.round(rgb.b)}},RGBToHex=function(rgb){var hex=[rgb.r.toString(16),rgb.g.toString(16),rgb.b.toString(16)];$.each(hex,function(nr,val){if(val.length==1){hex[nr]="0"+val}});return hex.join("")},HSBToHex=function(hsb){return RGBToHex(HSBToRGB(hsb))},restoreOriginal=function(){var cal=$(this).parent();var col=cal.data("colorpicker").origColor;cal.data("colorpicker").color=col;fillRGBFields(col,cal.get(0));fillHexFields(col,cal.get(0));fillHSBFields(col,cal.get(0));setSelector(col,cal.get(0));setHue(col,cal.get(0));setNewColor(col,cal.get(0))};return{init:function(opt){var isDE=$.i18n._("TINYMCE_LANGUAGE_CODE").indexOf("de")!==-1,isNL=$.i18n._("TINYMCE_LANGUAGE_CODE").indexOf("nl")!==-1;opt=$.extend({},defaults,opt||{});tpl='<div class="colorpicker gliffy-icon-colorpicker-background gliffy-dialog-dropshadow">   <div class="colorpicker_color">      <div class="gliffy-icon-colorpicker-overlay">          <div class="gliffy-icon-colorpicker-select"></div>      </div>   </div>   <div class="colorpicker_hue">       <div class="gliffy-icon-colorpicker-indic"></div>   </div>   <div class="colorpicker_new_color" title="'+$.i18n._("COLORPICKER_NEW_COLOR")+'"></div>   <div class="colorpicker_current_color" title="'+$.i18n._("COLORPICKER_CURRENT_COLOR")+'"></div>   <div class="colorpicker_hex gliffy-icon-colorpicker-hex">       <input type="text" maxlength="6" size="6" />   </div>   <div class="colorpicker_rgb_r gliffy-icon-colorpicker-rgb-r colorpicker_field">       <input type="text" maxlength="3" size="3" /><span></span>   </div>   <div class="colorpicker_rgb_g gliffy-icon-colorpicker-rgb-g colorpicker_field">       <input type="text" maxlength="3" size="3" /><span></span>   </div>   <div class="colorpicker_rgb_b gliffy-icon-colorpicker-rgb-b colorpicker_field">       <input type="text" maxlength="3" size="3" /><span></span>   </div>   <div class="colorpicker_hsb_h gliffy-icon-colorpicker-hsb-h colorpicker_field">       <input type="text" maxlength="3" size="3" /><span></span>   </div>   <div class="colorpicker_hsb_s gliffy-icon-colorpicker-hsb-s colorpicker_field">       <input type="text" maxlength="3" size="3" /><span></span>   </div>   <div class="colorpicker_hsb_b gliffy-icon-colorpicker-hsb-b colorpicker_field">       <input type="text" maxlength="3" size="3" /><span></span>   </div>   <div class="colorpicker_submit gliffy-icon-colorpicker-submit" title="'+$.i18n._("COLORPICKER_SET_NEW")+'"></div>   <button class="btn swatches-button" title="'+$.i18n._("COLORPICKER_COLOR_SWATCHES")+'">'+$.i18n._("COLORPICKER_SWATCHES")+'</button>   <button class="btn gliffy-btn-primary ok-button">'+$.i18n._("COLORPICKER_OK")+'</button>   <button class="btn cancel-button" '+(isDE||isNL?'style="width:80px"':"")+">"+$.i18n._("COLORPICKER_CANCEL")+"</button></div>";if(typeof opt.color=="string"){opt.color=HexToHSB(opt.color)}else{if(opt.color.r!=undefined&&opt.color.g!=undefined&&opt.color.b!=undefined){opt.color=RGBToHSB(opt.color)}else{if(opt.color.h!=undefined&&opt.color.s!=undefined&&opt.color.b!=undefined){opt.color=fixHSB(opt.color)}else{return this}}}return this.each(function(){if(!$(this).data("colorpickerId")){var options=$.extend({},opt);options.origColor=opt.color;var id="collorpicker_"+parseInt(Math.random()*1000);$(this).data("colorpickerId",id);var cal=$(tpl).attr("id",id);if(options.flat){cal.appendTo(this).show()}else{cal.appendTo(document.body)}options.fields=cal.find("input").bind("keyup",keyDown).bind("change",change).bind("blur",blur).bind("focus",focus);cal.find("span").bind("mousedown",downIncrement).end().find(">div.colorpicker_current_color").bind("click",restoreOriginal);options.selector=cal.find("div.colorpicker_color").bind("mousedown",downSelector);options.selectorIndic=options.selector.find("div div");options.el=this;options.hue=cal.find("div.colorpicker_hue div");cal.find("div.colorpicker_hue").bind("mousedown",downHue);options.newColor=cal.find("div.colorpicker_new_color");options.currentColor=cal.find("div.colorpicker_current_color");cal.data("colorpicker",options);cal.find("div.colorpicker_submit").bind("mouseenter",enterSubmit).bind("mouseleave",leaveSubmit).bind("click",clickSubmit);fillRGBFields(options.color,cal.get(0));fillHSBFields(options.color,cal.get(0));fillHexFields(options.color,cal.get(0));setHue(options.color,cal.get(0));setSelector(options.color,cal.get(0));setCurrentColor(options.color,cal.get(0));setNewColor(options.color,cal.get(0));if(options.flat){cal.css({position:"relative",display:"block"})}else{$(this).bind(options.eventName,show)}$(".colorpicker .swatches-button").click(function(e){GliffyApp.colorpickerController.handleSwatchesButtonClick(e)}).tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$(".colorpicker .ok-button").click(function(e){__callback(__newColor,__mode);GliffyApp.colorpickerController.addToColorMemory(__newColor);GliffyApp.colorpickerController.hideColorpicker()});$(".colorpicker .cancel-button").click(function(e){GliffyApp.colorpickerController.hideColorpicker()});$(".colorpicker_new_color").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$(".colorpicker_current_color").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$(".colorpicker_nofill").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$(".colorpicker_submit").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD)}})},showPicker:function(){return this.each(function(){if($(this).data("colorpickerId")){show.apply(this)}})},hidePicker:function(){return this.each(function(){if($(this).data("colorpickerId")){$("#"+$(this).data("colorpickerId")).hide()}})},setColor:function(col,mode){__mode=mode;$("div.colorpicker_nofill").hide();if(mode=="fill"){$("div.colorpicker_nofill").show()}if(col===null){col=Number("0x000000")}if(typeof col=="string"){col=HexToHSB(col)}else{if(col.r!=undefined&&col.g!=undefined&&col.b!=undefined){col=RGBToHSB(col)}else{if(col.h!=undefined&&col.s!=undefined&&col.b!=undefined){col=fixHSB(col)}else{return this}}}return this.each(function(){if($(this).data("colorpickerId")){var cal=$("#"+$(this).data("colorpickerId"));cal.data("colorpicker").color=col;cal.data("colorpicker").origColor=col;fillRGBFields(col,cal.get(0));fillHSBFields(col,cal.get(0));fillHexFields(col,cal.get(0));setHue(col,cal.get(0));setSelector(col,cal.get(0));setCurrentColor(col,cal.get(0));setNewColor(col,cal.get(0))}})},position:function(coords){$(".colorpicker").css("left",coords.x);$(".colorpicker").css("top",coords.y)},setCallback:function(callback){__callback=callback},getWidth:function(){return $(".colorpicker").width()},getHeight:function(){return $(".colorpicker").height()}}}();$.fn.extend({ColorPicker:ColorPicker.init,ColorPickerHide:ColorPicker.hidePicker,ColorPickerShow:ColorPicker.showPicker,ColorPickerSetColor:ColorPicker.setColor,ColorPickerPosition:ColorPicker.position,ColorPickerSetCallback:ColorPicker.setCallback,ColorPickerGetWidth:ColorPicker.getWidth,ColorPickerGetHeight:ColorPicker.getHeight})})(jQuery);Date.CultureInfo={name:"en-US",englishName:"English (United States)",nativeName:"English (United States)",dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],abbreviatedDayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],shortestDayNames:["Su","Mo","Tu","We","Th","Fr","Sa"],firstLetterDayNames:["S","M","T","W","T","F","S"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],abbreviatedMonthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],amDesignator:"AM",pmDesignator:"PM",firstDayOfWeek:0,twoDigitYearMax:2029,dateElementOrder:"mdy",formatPatterns:{shortDate:"M/d/yyyy",longDate:"dddd, MMMM dd, yyyy",shortTime:"h:mm tt",longTime:"h:mm:ss tt",fullDateTime:"dddd, MMMM dd, yyyy h:mm:ss tt",sortableDateTime:"yyyy-MM-ddTHH:mm:ss",universalSortableDateTime:"yyyy-MM-dd HH:mm:ssZ",rfc1123:"ddd, dd MMM yyyy HH:mm:ss GMT",monthDay:"MMMM dd",yearMonth:"MMMM, yyyy"},regexPatterns:{jan:/^jan(uary)?/i,feb:/^feb(ruary)?/i,mar:/^mar(ch)?/i,apr:/^apr(il)?/i,may:/^may/i,jun:/^jun(e)?/i,jul:/^jul(y)?/i,aug:/^aug(ust)?/i,sep:/^sep(t(ember)?)?/i,oct:/^oct(ober)?/i,nov:/^nov(ember)?/i,dec:/^dec(ember)?/i,sun:/^su(n(day)?)?/i,mon:/^mo(n(day)?)?/i,tue:/^tu(e(s(day)?)?)?/i,wed:/^we(d(nesday)?)?/i,thu:/^th(u(r(s(day)?)?)?)?/i,fri:/^fr(i(day)?)?/i,sat:/^sa(t(urday)?)?/i,future:/^next/i,past:/^last|past|prev(ious)?/i,add:/^(\+|after|from)/i,subtract:/^(\-|before|ago)/i,yesterday:/^yesterday/i,today:/^t(oday)?/i,tomorrow:/^tomorrow/i,now:/^n(ow)?/i,millisecond:/^ms|milli(second)?s?/i,second:/^sec(ond)?s?/i,minute:/^min(ute)?s?/i,hour:/^h(ou)?rs?/i,week:/^w(ee)?k/i,month:/^m(o(nth)?s?)?/i,day:/^d(ays?)?/i,year:/^y((ea)?rs?)?/i,shortMeridian:/^(a|p)/i,longMeridian:/^(a\.?m?\.?|p\.?m?\.?)/i,timezone:/^((e(s|d)t|c(s|d)t|m(s|d)t|p(s|d)t)|((gmt)?\s*(\+|\-)\s*\d\d\d\d?)|gmt)/i,ordinalSuffix:/^\s*(st|nd|rd|th)/i,timeContext:/^\s*(\:|a|p)/i},abbreviatedTimeZoneStandard:{GMT:"-000",EST:"-0400",CST:"-0500",MST:"-0600",PST:"-0700"},abbreviatedTimeZoneDST:{GMT:"-000",EDT:"-0500",CDT:"-0600",MDT:"-0700",PDT:"-0800"}};Date.getMonthNumberFromName=function(name){var n=Date.CultureInfo.monthNames,m=Date.CultureInfo.abbreviatedMonthNames,s=name.toLowerCase();for(var i=0;i<n.length;i++){if(n[i].toLowerCase()==s||m[i].toLowerCase()==s){return i}}return -1};Date.getDayNumberFromName=function(name){var n=Date.CultureInfo.dayNames,m=Date.CultureInfo.abbreviatedDayNames,o=Date.CultureInfo.shortestDayNames,s=name.toLowerCase();for(var i=0;i<n.length;i++){if(n[i].toLowerCase()==s||m[i].toLowerCase()==s){return i}}return -1};Date.isLeapYear=function(year){return(((year%4===0)&&(year%100!==0))||(year%400===0))};Date.getDaysInMonth=function(year,month){return[31,(Date.isLeapYear(year)?29:28),31,30,31,30,31,31,30,31,30,31][month]};Date.getTimezoneOffset=function(s,dst){return(dst||false)?Date.CultureInfo.abbreviatedTimeZoneDST[s.toUpperCase()]:Date.CultureInfo.abbreviatedTimeZoneStandard[s.toUpperCase()]};Date.getTimezoneAbbreviation=function(offset,dst){var n=(dst||false)?Date.CultureInfo.abbreviatedTimeZoneDST:Date.CultureInfo.abbreviatedTimeZoneStandard,p;for(p in n){if(n[p]===offset){return p}}return null};Date.prototype.clone=function(){return new Date(this.getTime())};Date.prototype.compareTo=function(date){if(isNaN(this)){throw new Error(this)}if(date instanceof Date&&!isNaN(date)){return(this>date)?1:(this<date)?-1:0}else{throw new TypeError(date)}};Date.prototype.equals=function(date){return(this.compareTo(date)===0)};Date.prototype.between=function(start,end){var t=this.getTime();return t>=start.getTime()&&t<=end.getTime()};Date.prototype.addMilliseconds=function(value){this.setMilliseconds(this.getMilliseconds()+value);return this};Date.prototype.addSeconds=function(value){return this.addMilliseconds(value*1000)};Date.prototype.addMinutes=function(value){return this.addMilliseconds(value*60000)};Date.prototype.addHours=function(value){return this.addMilliseconds(value*3600000)};Date.prototype.addDays=function(value){return this.addMilliseconds(value*86400000)};Date.prototype.addWeeks=function(value){return this.addMilliseconds(value*604800000)};Date.prototype.addMonths=function(value){var n=this.getDate();this.setDate(1);this.setMonth(this.getMonth()+value);this.setDate(Math.min(n,this.getDaysInMonth()));return this};Date.prototype.addYears=function(value){return this.addMonths(value*12)};Date.prototype.add=function(config){if(typeof config=="number"){this._orient=config;return this}var x=config;if(x.millisecond||x.milliseconds){this.addMilliseconds(x.millisecond||x.milliseconds)}if(x.second||x.seconds){this.addSeconds(x.second||x.seconds)}if(x.minute||x.minutes){this.addMinutes(x.minute||x.minutes)}if(x.hour||x.hours){this.addHours(x.hour||x.hours)}if(x.month||x.months){this.addMonths(x.month||x.months)}if(x.year||x.years){this.addYears(x.year||x.years)}if(x.day||x.days){this.addDays(x.day||x.days)}return this};Date._validate=function(value,min,max,name){if(typeof value!="number"){throw new TypeError(value+" is not a Number.")}else{if(value<min||value>max){throw new RangeError(value+" is not a valid value for "+name+".")}}return true};Date.validateMillisecond=function(n){return Date._validate(n,0,999,"milliseconds")};Date.validateSecond=function(n){return Date._validate(n,0,59,"seconds")};Date.validateMinute=function(n){return Date._validate(n,0,59,"minutes")};Date.validateHour=function(n){return Date._validate(n,0,23,"hours")};Date.validateDay=function(n,year,month){return Date._validate(n,1,Date.getDaysInMonth(year,month),"days")};Date.validateMonth=function(n){return Date._validate(n,0,11,"months")};Date.validateYear=function(n){return Date._validate(n,1,9999,"seconds")};Date.prototype.set=function(config){var x=config;if(!x.millisecond&&x.millisecond!==0){x.millisecond=-1}if(!x.second&&x.second!==0){x.second=-1}if(!x.minute&&x.minute!==0){x.minute=-1}if(!x.hour&&x.hour!==0){x.hour=-1}if(!x.day&&x.day!==0){x.day=-1}if(!x.month&&x.month!==0){x.month=-1}if(!x.year&&x.year!==0){x.year=-1}if(x.millisecond!=-1&&Date.validateMillisecond(x.millisecond)){this.addMilliseconds(x.millisecond-this.getMilliseconds())}if(x.second!=-1&&Date.validateSecond(x.second)){this.addSeconds(x.second-this.getSeconds())}if(x.minute!=-1&&Date.validateMinute(x.minute)){this.addMinutes(x.minute-this.getMinutes())}if(x.hour!=-1&&Date.validateHour(x.hour)){this.addHours(x.hour-this.getHours())}if(x.month!==-1&&Date.validateMonth(x.month)){this.addMonths(x.month-this.getMonth())}if(x.year!=-1&&Date.validateYear(x.year)){this.addYears(x.year-this.getFullYear())}if(x.day!=-1&&Date.validateDay(x.day,this.getFullYear(),this.getMonth())){this.addDays(x.day-this.getDate())}if(x.timezone){this.setTimezone(x.timezone)}if(x.timezoneOffset){this.setTimezoneOffset(x.timezoneOffset)}return this};Date.prototype.clearTime=function(){this.setHours(0);this.setMinutes(0);this.setSeconds(0);this.setMilliseconds(0);return this};Date.prototype.isLeapYear=function(){var y=this.getFullYear();return(((y%4===0)&&(y%100!==0))||(y%400===0))};Date.prototype.isWeekday=function(){return !(this.is().sat()||this.is().sun())};Date.prototype.getDaysInMonth=function(){return Date.getDaysInMonth(this.getFullYear(),this.getMonth())};Date.prototype.moveToFirstDayOfMonth=function(){return this.set({day:1})};Date.prototype.moveToLastDayOfMonth=function(){return this.set({day:this.getDaysInMonth()})};Date.prototype.moveToDayOfWeek=function(day,orient){var diff=(day-this.getDay()+7*(orient||+1))%7;return this.addDays((diff===0)?diff+=7*(orient||+1):diff)};Date.prototype.moveToMonth=function(month,orient){var diff=(month-this.getMonth()+12*(orient||+1))%12;return this.addMonths((diff===0)?diff+=12*(orient||+1):diff)};Date.prototype.getDayOfYear=function(){return Math.floor((this-new Date(this.getFullYear(),0,1))/86400000)};Date.prototype.getWeekOfYear=function(firstDayOfWeek){var y=this.getFullYear(),m=this.getMonth(),d=this.getDate();var dow=firstDayOfWeek||Date.CultureInfo.firstDayOfWeek;var offset=7+1-new Date(y,0,1).getDay();if(offset==8){offset=1}var daynum=((Date.UTC(y,m,d,0,0,0)-Date.UTC(y,0,1,0,0,0))/86400000)+1;var w=Math.floor((daynum-offset+7)/7);if(w===dow){y--;var prevOffset=7+1-new Date(y,0,1).getDay();if(prevOffset==2||prevOffset==8){w=53}else{w=52}}return w};Date.prototype.isDST=function(){console.log("isDST");return this.toString().match(/(E|C|M|P)(S|D)T/)[2]=="D"};Date.prototype.getTimezone=function(){return Date.getTimezoneAbbreviation(this.getUTCOffset,this.isDST())};Date.prototype.setTimezoneOffset=function(s){var here=this.getTimezoneOffset(),there=Number(s)*-6/10;this.addMinutes(there-here);return this};Date.prototype.setTimezone=function(s){return this.setTimezoneOffset(Date.getTimezoneOffset(s))};Date.prototype.getUTCOffset=function(){var n=this.getTimezoneOffset()*-10/6,r;if(n<0){r=(n-10000).toString();return r[0]+r.substr(2)}else{r=(n+10000).toString();return"+"+r.substr(1)}};Date.prototype.getDayName=function(abbrev){return abbrev?Date.CultureInfo.abbreviatedDayNames[this.getDay()]:Date.CultureInfo.dayNames[this.getDay()]};Date.prototype.getMonthName=function(abbrev){return abbrev?Date.CultureInfo.abbreviatedMonthNames[this.getMonth()]:Date.CultureInfo.monthNames[this.getMonth()]};Date.prototype._toString=Date.prototype.toString;Date.prototype.toString=function(format){var self=this;var p=function p(s){return(s.toString().length==1)?"0"+s:s};return format?format.replace(/dd?d?d?|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|zz?z?/g,function(format){switch(format){case"hh":return p(self.getHours()<13?self.getHours():(self.getHours()-12));case"h":return self.getHours()<13?self.getHours():(self.getHours()-12);case"HH":return p(self.getHours());case"H":return self.getHours();case"mm":return p(self.getMinutes());case"m":return self.getMinutes();case"ss":return p(self.getSeconds());case"s":return self.getSeconds();case"yyyy":return self.getFullYear();case"yy":return self.getFullYear().toString().substring(2,4);case"dddd":return self.getDayName();case"ddd":return self.getDayName(true);case"dd":return p(self.getDate());case"d":return self.getDate().toString();case"MMMM":return self.getMonthName();case"MMM":return self.getMonthName(true);case"MM":return p((self.getMonth()+1));case"M":return self.getMonth()+1;case"t":return self.getHours()<12?Date.CultureInfo.amDesignator.substring(0,1):Date.CultureInfo.pmDesignator.substring(0,1);case"tt":return self.getHours()<12?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator;case"zzz":case"zz":case"z":return""}}):this._toString()};Date.now=function(){return new Date()};Date.today=function(){return Date.now().clearTime()};Date.prototype._orient=+1;Date.prototype.next=function(){this._orient=+1;return this};Date.prototype.last=Date.prototype.prev=Date.prototype.previous=function(){this._orient=-1;return this};Date.prototype._is=false;Date.prototype.is=function(){this._is=true;return this};Number.prototype._dateElement="day";Number.prototype.fromNow=function(){var c={};c[this._dateElement]=this;return Date.now().add(c)};Number.prototype.ago=function(){var c={};c[this._dateElement]=this*-1;return Date.now().add(c)};(function(){var $D=Date.prototype,$N=Number.prototype;var dx=("sunday monday tuesday wednesday thursday friday saturday").split(/\s/),mx=("january february march april may june july august september october november december").split(/\s/),px=("Millisecond Second Minute Hour Day Week Month Year").split(/\s/),de;var df=function(n){return function(){if(this._is){this._is=false;return this.getDay()==n}return this.moveToDayOfWeek(n,this._orient)}};for(var i=0;i<dx.length;i++){$D[dx[i]]=$D[dx[i].substring(0,3)]=df(i)}var mf=function(n){return function(){if(this._is){this._is=false;return this.getMonth()===n}return this.moveToMonth(n,this._orient)}};for(var j=0;j<mx.length;j++){$D[mx[j]]=$D[mx[j].substring(0,3)]=mf(j)}var ef=function(j){return function(){if(j.substring(j.length-1)!="s"){j+="s"}return this["add"+j](this._orient)}};var nf=function(n){return function(){this._dateElement=n;return this}};for(var k=0;k<px.length;k++){de=px[k].toLowerCase();$D[de]=$D[de+"s"]=ef(px[k]);$N[de]=$N[de+"s"]=nf(de)}}());Date.prototype.toJSONString=function(){return this.toString("yyyy-MM-ddThh:mm:ssZ")};Date.prototype.toShortDateString=function(){return this.toString(Date.CultureInfo.formatPatterns.shortDatePattern)};Date.prototype.toLongDateString=function(){return this.toString(Date.CultureInfo.formatPatterns.longDatePattern)};Date.prototype.toShortTimeString=function(){return this.toString(Date.CultureInfo.formatPatterns.shortTimePattern)};Date.prototype.toLongTimeString=function(){return this.toString(Date.CultureInfo.formatPatterns.longTimePattern)};Date.prototype.getOrdinal=function(){switch(this.getDate()){case 1:case 21:case 31:return"st";case 2:case 22:return"nd";case 3:case 23:return"rd";default:return"th"}};(function(){Date.Parsing={Exception:function(s){this.message="Parse error at '"+s.substring(0,10)+" ...'"}};var $P=Date.Parsing;var _=$P.Operators={rtoken:function(r){return function(s){var mx=s.match(r);if(mx){return([mx[0],s.substring(mx[0].length)])}else{throw new $P.Exception(s)}}},token:function(s){return function(s){return _.rtoken(new RegExp("^s*"+s+"s*"))(s)}},stoken:function(s){return _.rtoken(new RegExp("^"+s))},until:function(p){return function(s){var qx=[],rx=null;while(s.length){try{rx=p.call(this,s)}catch(e){qx.push(rx[0]);s=rx[1];continue}break}return[qx,s]}},many:function(p){return function(s){var rx=[],r=null;while(s.length){try{r=p.call(this,s)}catch(e){return[rx,s]}rx.push(r[0]);s=r[1]}return[rx,s]}},optional:function(p){return function(s){var r=null;try{r=p.call(this,s)}catch(e){return[null,s]}return[r[0],r[1]]}},not:function(p){return function(s){try{p.call(this,s)}catch(e){return[null,s]}throw new $P.Exception(s)}},ignore:function(p){return p?function(s){var r=null;r=p.call(this,s);return[null,r[1]]}:null},product:function(){var px=arguments[0],qx=Array.prototype.slice.call(arguments,1),rx=[];for(var i=0;i<px.length;i++){rx.push(_.each(px[i],qx))}return rx},cache:function(rule){var cache={},r=null;return function(s){try{r=cache[s]=(cache[s]||rule.call(this,s))}catch(e){r=cache[s]=e}if(r instanceof $P.Exception){throw r}else{return r}}},any:function(){var px=arguments;return function(s){var r=null;for(var i=0;i<px.length;i++){if(px[i]==null){continue}try{r=(px[i].call(this,s))}catch(e){r=null}if(r){return r}}throw new $P.Exception(s)}},each:function(){var px=arguments;return function(s){var rx=[],r=null;for(var i=0;i<px.length;i++){if(px[i]==null){continue}try{r=(px[i].call(this,s))}catch(e){throw new $P.Exception(s)}rx.push(r[0]);s=r[1]}return[rx,s]}},all:function(){var px=arguments,_=_;return _.each(_.optional(px))},sequence:function(px,d,c){d=d||_.rtoken(/^\s*/);c=c||null;if(px.length==1){return px[0]}return function(s){var r=null,q=null;var rx=[];for(var i=0;i<px.length;i++){try{r=px[i].call(this,s)}catch(e){break}rx.push(r[0]);try{q=d.call(this,r[1])}catch(ex){q=null;break}s=q[1]}if(!r){throw new $P.Exception(s)}if(q){throw new $P.Exception(q[1])}if(c){try{r=c.call(this,r[1])}catch(ey){throw new $P.Exception(r[1])}}return[rx,(r?r[1]:s)]}},between:function(d1,p,d2){d2=d2||d1;var _fn=_.each(_.ignore(d1),p,_.ignore(d2));return function(s){var rx=_fn.call(this,s);return[[rx[0][0],r[0][2]],rx[1]]}},list:function(p,d,c){d=d||_.rtoken(/^\s*/);c=c||null;return(p instanceof Array?_.each(_.product(p.slice(0,-1),_.ignore(d)),p.slice(-1),_.ignore(c)):_.each(_.many(_.each(p,_.ignore(d))),px,_.ignore(c)))},set:function(px,d,c){d=d||_.rtoken(/^\s*/);c=c||null;return function(s){var r=null,p=null,q=null,rx=null,best=[[],s],last=false;for(var i=0;i<px.length;i++){q=null;p=null;r=null;last=(px.length==1);try{r=px[i].call(this,s)}catch(e){continue}rx=[[r[0]],r[1]];if(r[1].length>0&&!last){try{q=d.call(this,r[1])}catch(ex){last=true}}else{last=true}if(!last&&q[1].length===0){last=true}if(!last){var qx=[];for(var j=0;j<px.length;j++){if(i!=j){qx.push(px[j])}}p=_.set(qx,d).call(this,q[1]);if(p[0].length>0){rx[0]=rx[0].concat(p[0]);rx[1]=p[1]}}if(rx[1].length<best[1].length){best=rx}if(best[1].length===0){break}}if(best[0].length===0){return best}if(c){try{q=c.call(this,best[1])}catch(ey){throw new $P.Exception(best[1])}best[1]=q[1]}return best}},forward:function(gr,fname){return function(s){return gr[fname].call(this,s)}},replace:function(rule,repl){return function(s){var r=rule.call(this,s);return[repl,r[1]]}},process:function(rule,fn){return function(s){var r=rule.call(this,s);return[fn.call(this,r[0]),r[1]]}},min:function(min,rule){return function(s){var rx=rule.call(this,s);if(rx[0].length<min){throw new $P.Exception(s)}return rx}}};var _generator=function(op){return function(){var args=null,rx=[];if(arguments.length>1){args=Array.prototype.slice.call(arguments)}else{if(arguments[0] instanceof Array){args=arguments[0]}}if(args){for(var i=0,px=args.shift();i<px.length;i++){args.unshift(px[i]);rx.push(op.apply(null,args));args.shift();return rx}}else{return op.apply(null,arguments)}}};var gx="optional not ignore cache".split(/\s/);for(var i=0;i<gx.length;i++){_[gx[i]]=_generator(_[gx[i]])}var _vector=function(op){return function(){if(arguments[0] instanceof Array){return op.apply(null,arguments[0])}else{return op.apply(null,arguments)}}};var vx="each any all".split(/\s/);for(var j=0;j<vx.length;j++){_[vx[j]]=_vector(_[vx[j]])}}());(function(){var flattenAndCompact=function(ax){var rx=[];for(var i=0;i<ax.length;i++){if(ax[i] instanceof Array){rx=rx.concat(flattenAndCompact(ax[i]))}else{if(ax[i]){rx.push(ax[i])}}}return rx};Date.Grammar={};Date.Translator={hour:function(s){return function(){this.hour=Number(s)}},minute:function(s){return function(){this.minute=Number(s)}},second:function(s){return function(){this.second=Number(s)}},meridian:function(s){return function(){this.meridian=s.slice(0,1).toLowerCase()}},timezone:function(s){return function(){var n=s.replace(/[^\d\+\-]/g,"");if(n.length){this.timezoneOffset=Number(n)}else{this.timezone=s.toLowerCase()}}},day:function(x){var s=x[0];return function(){this.day=Number(s.match(/\d+/)[0])}},month:function(s){return function(){this.month=((s.length==3)?Date.getMonthNumberFromName(s):(Number(s)-1))}},year:function(s){return function(){var n=Number(s);this.year=((s.length>2)?n:(n+(((n+2000)<Date.CultureInfo.twoDigitYearMax)?2000:1900)))}},rday:function(s){return function(){switch(s){case"yesterday":this.days=-1;break;case"tomorrow":this.days=1;break;case"today":this.days=0;break;case"now":this.days=0;this.now=true;break}}},finishExact:function(x){x=(x instanceof Array)?x:[x];var now=new Date();this.year=now.getFullYear();this.month=now.getMonth();this.day=1;this.hour=0;this.minute=0;this.second=0;for(var i=0;i<x.length;i++){if(x[i]){x[i].call(this)}}this.hour=(this.meridian=="p"&&this.hour<13)?this.hour+12:this.hour;if(this.day>Date.getDaysInMonth(this.year,this.month)){throw new RangeError(this.day+" is not a valid value for days.")}var r=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second);if(this.timezone){r.set({timezone:this.timezone})}else{if(this.timezoneOffset){r.set({timezoneOffset:this.timezoneOffset})}}return r},finish:function(x){x=(x instanceof Array)?flattenAndCompact(x):[x];if(x.length===0){return null}for(var i=0;i<x.length;i++){if(typeof x[i]=="function"){x[i].call(this)}}if(this.now){return new Date()}var today=Date.today();var method=null;var expression=!!(this.days!=null||this.orient||this.operator);if(expression){var gap,mod,orient;orient=((this.orient=="past"||this.operator=="subtract")?-1:1);if(this.weekday){this.unit="day";gap=(Date.getDayNumberFromName(this.weekday)-today.getDay());mod=7;this.days=gap?((gap+(orient*mod))%mod):(orient*mod)}if(this.month){this.unit="month";gap=(this.month-today.getMonth());mod=12;this.months=gap?((gap+(orient*mod))%mod):(orient*mod);this.month=null}if(!this.unit){this.unit="day"}if(this[this.unit+"s"]==null||this.operator!=null){if(!this.value){this.value=1}if(this.unit=="week"){this.unit="day";this.value=this.value*7}this[this.unit+"s"]=this.value*orient}return today.add(this)}else{if(this.meridian&&this.hour){this.hour=(this.hour<13&&this.meridian=="p")?this.hour+12:this.hour}if(this.weekday&&!this.day){this.day=(today.addDays((Date.getDayNumberFromName(this.weekday)-today.getDay()))).getDate()}if(this.month&&!this.day){this.day=1}return today.set(this)}}};var _=Date.Parsing.Operators,g=Date.Grammar,t=Date.Translator,_fn;g.datePartDelimiter=_.rtoken(/^([\s\-\.\,\/\x27]+)/);g.timePartDelimiter=_.stoken(":");g.whiteSpace=_.rtoken(/^\s*/);g.generalDelimiter=_.rtoken(/^(([\s\,]|at|on)+)/);var _C={};g.ctoken=function(keys){var fn=_C[keys];if(!fn){var c=Date.CultureInfo.regexPatterns;var kx=keys.split(/\s+/),px=[];for(var i=0;i<kx.length;i++){px.push(_.replace(_.rtoken(c[kx[i]]),kx[i]))}fn=_C[keys]=_.any.apply(null,px)}return fn};g.ctoken2=function(key){return _.rtoken(Date.CultureInfo.regexPatterns[key])};g.h=_.cache(_.process(_.rtoken(/^(0[0-9]|1[0-2]|[1-9])/),t.hour));g.hh=_.cache(_.process(_.rtoken(/^(0[0-9]|1[0-2])/),t.hour));g.H=_.cache(_.process(_.rtoken(/^([0-1][0-9]|2[0-3]|[0-9])/),t.hour));g.HH=_.cache(_.process(_.rtoken(/^([0-1][0-9]|2[0-3])/),t.hour));g.m=_.cache(_.process(_.rtoken(/^([0-5][0-9]|[0-9])/),t.minute));g.mm=_.cache(_.process(_.rtoken(/^[0-5][0-9]/),t.minute));g.s=_.cache(_.process(_.rtoken(/^([0-5][0-9]|[0-9])/),t.second));g.ss=_.cache(_.process(_.rtoken(/^[0-5][0-9]/),t.second));g.hms=_.cache(_.sequence([g.H,g.mm,g.ss],g.timePartDelimiter));g.t=_.cache(_.process(g.ctoken2("shortMeridian"),t.meridian));g.tt=_.cache(_.process(g.ctoken2("longMeridian"),t.meridian));g.z=_.cache(_.process(_.rtoken(/^(\+|\-)?\s*\d\d\d\d?/),t.timezone));g.zz=_.cache(_.process(_.rtoken(/^(\+|\-)\s*\d\d\d\d/),t.timezone));g.zzz=_.cache(_.process(g.ctoken2("timezone"),t.timezone));g.timeSuffix=_.each(_.ignore(g.whiteSpace),_.set([g.tt,g.zzz]));g.time=_.each(_.optional(_.ignore(_.stoken("T"))),g.hms,g.timeSuffix);g.d=_.cache(_.process(_.each(_.rtoken(/^([0-2]\d|3[0-1]|\d)/),_.optional(g.ctoken2("ordinalSuffix"))),t.day));g.dd=_.cache(_.process(_.each(_.rtoken(/^([0-2]\d|3[0-1])/),_.optional(g.ctoken2("ordinalSuffix"))),t.day));g.ddd=g.dddd=_.cache(_.process(g.ctoken("sun mon tue wed thu fri sat"),function(s){return function(){this.weekday=s}}));g.M=_.cache(_.process(_.rtoken(/^(1[0-2]|0\d|\d)/),t.month));g.MM=_.cache(_.process(_.rtoken(/^(1[0-2]|0\d)/),t.month));g.MMM=g.MMMM=_.cache(_.process(g.ctoken("jan feb mar apr may jun jul aug sep oct nov dec"),t.month));g.y=_.cache(_.process(_.rtoken(/^(\d\d?)/),t.year));g.yy=_.cache(_.process(_.rtoken(/^(\d\d)/),t.year));g.yyy=_.cache(_.process(_.rtoken(/^(\d\d?\d?\d?)/),t.year));g.yyyy=_.cache(_.process(_.rtoken(/^(\d\d\d\d)/),t.year));_fn=function(){return _.each(_.any.apply(null,arguments),_.not(g.ctoken2("timeContext")))};g.day=_fn(g.d,g.dd);g.month=_fn(g.M,g.MMM);g.year=_fn(g.yyyy,g.yy);g.orientation=_.process(g.ctoken("past future"),function(s){return function(){this.orient=s}});g.operator=_.process(g.ctoken("add subtract"),function(s){return function(){this.operator=s}});g.rday=_.process(g.ctoken("yesterday tomorrow today now"),t.rday);g.unit=_.process(g.ctoken("minute hour day week month year"),function(s){return function(){this.unit=s}});g.value=_.process(_.rtoken(/^\d\d?(st|nd|rd|th)?/),function(s){return function(){this.value=s.replace(/\D/g,"")}});g.expression=_.set([g.rday,g.operator,g.value,g.unit,g.orientation,g.ddd,g.MMM]);_fn=function(){return _.set(arguments,g.datePartDelimiter)};g.mdy=_fn(g.ddd,g.month,g.day,g.year);g.ymd=_fn(g.ddd,g.year,g.month,g.day);g.dmy=_fn(g.ddd,g.day,g.month,g.year);g.date=function(s){return((g[Date.CultureInfo.dateElementOrder]||g.mdy).call(this,s))};g.format=_.process(_.many(_.any(_.process(_.rtoken(/^(dd?d?d?|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|zz?z?)/),function(fmt){if(g[fmt]){return g[fmt]}else{throw Date.Parsing.Exception(fmt)}}),_.process(_.rtoken(/^[^dMyhHmstz]+/),function(s){return _.ignore(_.stoken(s))}))),function(rules){return _.process(_.each.apply(null,rules),t.finishExact)});var _F={};var _get=function(f){return _F[f]=(_F[f]||g.format(f)[0])};g.formats=function(fx){if(fx instanceof Array){var rx=[];for(var i=0;i<fx.length;i++){rx.push(_get(fx[i]))}return _.any.apply(null,rx)}else{return _get(fx)}};g._formats=g.formats(["yyyy-MM-ddTHH:mm:ss","ddd, MMM dd, yyyy H:mm:ss tt","ddd MMM d yyyy HH:mm:ss zzz","d"]);g._start=_.process(_.set([g.date,g.time,g.expression],g.generalDelimiter,g.whiteSpace),t.finish);g.start=function(s){try{var r=g._formats.call({},s);if(r[1].length===0){return r}}catch(e){}return g._start.call({},s)}}());Date._parse=Date.parse;Date.parse=function(s){var r=null;if(!s){return null}try{r=Date.Grammar.start.call({},s)}catch(e){return null}return((r[1].length===0)?r[0]:null)};Date.getParseFunction=function(fx){var fn=Date.Grammar.formats(fx);return function(s){var r=null;try{r=fn.call({},s)}catch(e){return null}return((r[1].length===0)?r[0]:null)}};Date.parseExact=function(s,fx){return Date.getParseFunction(fx)(s)};Date.CultureInfo={name:"en-US",englishName:"English (United States)",nativeName:"English (United States)",dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],abbreviatedDayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],shortestDayNames:["Su","Mo","Tu","We","Th","Fr","Sa"],firstLetterDayNames:["S","M","T","W","T","F","S"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],abbreviatedMonthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],amDesignator:"AM",pmDesignator:"PM",firstDayOfWeek:0,twoDigitYearMax:2029,dateElementOrder:"mdy",formatPatterns:{shortDate:"M/d/yyyy",longDate:"dddd, MMMM dd, yyyy",shortTime:"h:mm tt",longTime:"h:mm:ss tt",fullDateTime:"dddd, MMMM dd, yyyy h:mm:ss tt",sortableDateTime:"yyyy-MM-ddTHH:mm:ss",universalSortableDateTime:"yyyy-MM-dd HH:mm:ssZ",rfc1123:"ddd, dd MMM yyyy HH:mm:ss GMT",monthDay:"MMMM dd",yearMonth:"MMMM, yyyy"},regexPatterns:{jan:/^jan(uary)?/i,feb:/^feb(ruary)?/i,mar:/^mar(ch)?/i,apr:/^apr(il)?/i,may:/^may/i,jun:/^jun(e)?/i,jul:/^jul(y)?/i,aug:/^aug(ust)?/i,sep:/^sep(t(ember)?)?/i,oct:/^oct(ober)?/i,nov:/^nov(ember)?/i,dec:/^dec(ember)?/i,sun:/^su(n(day)?)?/i,mon:/^mo(n(day)?)?/i,tue:/^tu(e(s(day)?)?)?/i,wed:/^we(d(nesday)?)?/i,thu:/^th(u(r(s(day)?)?)?)?/i,fri:/^fr(i(day)?)?/i,sat:/^sa(t(urday)?)?/i,future:/^next/i,past:/^last|past|prev(ious)?/i,add:/^(\+|after|from)/i,subtract:/^(\-|before|ago)/i,yesterday:/^yesterday/i,today:/^t(oday)?/i,tomorrow:/^tomorrow/i,now:/^n(ow)?/i,millisecond:/^ms|milli(second)?s?/i,second:/^sec(ond)?s?/i,minute:/^min(ute)?s?/i,hour:/^h(ou)?rs?/i,week:/^w(ee)?k/i,month:/^m(o(nth)?s?)?/i,day:/^d(ays?)?/i,year:/^y((ea)?rs?)?/i,shortMeridian:/^(a|p)/i,longMeridian:/^(a\.?m?\.?|p\.?m?\.?)/i,timezone:/^((e(s|d)t|c(s|d)t|m(s|d)t|p(s|d)t)|((gmt)?\s*(\+|\-)\s*\d\d\d\d?)|gmt)/i,ordinalSuffix:/^\s*(st|nd|rd|th)/i,timeContext:/^\s*(\:|a|p)/i},abbreviatedTimeZoneStandard:{GMT:"-000",EST:"-0400",CST:"-0500",MST:"-0600",PST:"-0700"},abbreviatedTimeZoneDST:{GMT:"-000",EDT:"-0500",CDT:"-0600",MDT:"-0700",PDT:"-0800"}};Date.getMonthNumberFromName=function(name){var n=Date.CultureInfo.monthNames,m=Date.CultureInfo.abbreviatedMonthNames,s=name.toLowerCase();for(var i=0;i<n.length;i++){if(n[i].toLowerCase()==s||m[i].toLowerCase()==s){return i}}return -1};Date.getDayNumberFromName=function(name){var n=Date.CultureInfo.dayNames,m=Date.CultureInfo.abbreviatedDayNames,o=Date.CultureInfo.shortestDayNames,s=name.toLowerCase();for(var i=0;i<n.length;i++){if(n[i].toLowerCase()==s||m[i].toLowerCase()==s){return i}}return -1};Date.isLeapYear=function(year){return(((year%4===0)&&(year%100!==0))||(year%400===0))};Date.getDaysInMonth=function(year,month){return[31,(Date.isLeapYear(year)?29:28),31,30,31,30,31,31,30,31,30,31][month]};Date.getTimezoneOffset=function(s,dst){return(dst||false)?Date.CultureInfo.abbreviatedTimeZoneDST[s.toUpperCase()]:Date.CultureInfo.abbreviatedTimeZoneStandard[s.toUpperCase()]};Date.getTimezoneAbbreviation=function(offset,dst){var n=(dst||false)?Date.CultureInfo.abbreviatedTimeZoneDST:Date.CultureInfo.abbreviatedTimeZoneStandard,p;for(p in n){if(n[p]===offset){return p}}return null};Date.prototype.clone=function(){return new Date(this.getTime())};Date.prototype.compareTo=function(date){if(isNaN(this)){throw new Error(this)}if(date instanceof Date&&!isNaN(date)){return(this>date)?1:(this<date)?-1:0}else{throw new TypeError(date)}};Date.prototype.equals=function(date){return(this.compareTo(date)===0)};Date.prototype.between=function(start,end){var t=this.getTime();return t>=start.getTime()&&t<=end.getTime()};Date.prototype.addMilliseconds=function(value){this.setMilliseconds(this.getMilliseconds()+value);return this};Date.prototype.addSeconds=function(value){return this.addMilliseconds(value*1000)};Date.prototype.addMinutes=function(value){return this.addMilliseconds(value*60000)};Date.prototype.addHours=function(value){return this.addMilliseconds(value*3600000)};Date.prototype.addDays=function(value){return this.addMilliseconds(value*86400000)};Date.prototype.addWeeks=function(value){return this.addMilliseconds(value*604800000)};Date.prototype.addMonths=function(value){var n=this.getDate();this.setDate(1);this.setMonth(this.getMonth()+value);this.setDate(Math.min(n,this.getDaysInMonth()));return this};Date.prototype.addYears=function(value){return this.addMonths(value*12)};Date.prototype.add=function(config){if(typeof config=="number"){this._orient=config;return this}var x=config;if(x.millisecond||x.milliseconds){this.addMilliseconds(x.millisecond||x.milliseconds)}if(x.second||x.seconds){this.addSeconds(x.second||x.seconds)}if(x.minute||x.minutes){this.addMinutes(x.minute||x.minutes)}if(x.hour||x.hours){this.addHours(x.hour||x.hours)}if(x.month||x.months){this.addMonths(x.month||x.months)}if(x.year||x.years){this.addYears(x.year||x.years)}if(x.day||x.days){this.addDays(x.day||x.days)}return this};Date._validate=function(value,min,max,name){if(typeof value!="number"){throw new TypeError(value+" is not a Number.")}else{if(value<min||value>max){throw new RangeError(value+" is not a valid value for "+name+".")}}return true};Date.validateMillisecond=function(n){return Date._validate(n,0,999,"milliseconds")};Date.validateSecond=function(n){return Date._validate(n,0,59,"seconds")};Date.validateMinute=function(n){return Date._validate(n,0,59,"minutes")};Date.validateHour=function(n){return Date._validate(n,0,23,"hours")};Date.validateDay=function(n,year,month){return Date._validate(n,1,Date.getDaysInMonth(year,month),"days")};Date.validateMonth=function(n){return Date._validate(n,0,11,"months")};Date.validateYear=function(n){return Date._validate(n,1,9999,"seconds")};Date.prototype.set=function(config){var x=config;if(!x.millisecond&&x.millisecond!==0){x.millisecond=-1}if(!x.second&&x.second!==0){x.second=-1}if(!x.minute&&x.minute!==0){x.minute=-1}if(!x.hour&&x.hour!==0){x.hour=-1}if(!x.day&&x.day!==0){x.day=-1}if(!x.month&&x.month!==0){x.month=-1}if(!x.year&&x.year!==0){x.year=-1}if(x.millisecond!=-1&&Date.validateMillisecond(x.millisecond)){this.addMilliseconds(x.millisecond-this.getMilliseconds())}if(x.second!=-1&&Date.validateSecond(x.second)){this.addSeconds(x.second-this.getSeconds())}if(x.minute!=-1&&Date.validateMinute(x.minute)){this.addMinutes(x.minute-this.getMinutes())}if(x.hour!=-1&&Date.validateHour(x.hour)){this.addHours(x.hour-this.getHours())}if(x.month!==-1&&Date.validateMonth(x.month)){this.addMonths(x.month-this.getMonth())}if(x.year!=-1&&Date.validateYear(x.year)){this.addYears(x.year-this.getFullYear())}if(x.day!=-1&&Date.validateDay(x.day,this.getFullYear(),this.getMonth())){this.addDays(x.day-this.getDate())}if(x.timezone){this.setTimezone(x.timezone)}if(x.timezoneOffset){this.setTimezoneOffset(x.timezoneOffset)}return this};Date.prototype.clearTime=function(){this.setHours(0);this.setMinutes(0);this.setSeconds(0);this.setMilliseconds(0);return this};Date.prototype.isLeapYear=function(){var y=this.getFullYear();return(((y%4===0)&&(y%100!==0))||(y%400===0))};Date.prototype.isWeekday=function(){return !(this.is().sat()||this.is().sun())};Date.prototype.getDaysInMonth=function(){return Date.getDaysInMonth(this.getFullYear(),this.getMonth())};Date.prototype.moveToFirstDayOfMonth=function(){return this.set({day:1})};Date.prototype.moveToLastDayOfMonth=function(){return this.set({day:this.getDaysInMonth()})};Date.prototype.moveToDayOfWeek=function(day,orient){var diff=(day-this.getDay()+7*(orient||+1))%7;return this.addDays((diff===0)?diff+=7*(orient||+1):diff)};Date.prototype.moveToMonth=function(month,orient){var diff=(month-this.getMonth()+12*(orient||+1))%12;return this.addMonths((diff===0)?diff+=12*(orient||+1):diff)};Date.prototype.getDayOfYear=function(){return Math.floor((this-new Date(this.getFullYear(),0,1))/86400000)};Date.prototype.getWeekOfYear=function(firstDayOfWeek){var y=this.getFullYear(),m=this.getMonth(),d=this.getDate();var dow=firstDayOfWeek||Date.CultureInfo.firstDayOfWeek;var offset=7+1-new Date(y,0,1).getDay();if(offset==8){offset=1}var daynum=((Date.UTC(y,m,d,0,0,0)-Date.UTC(y,0,1,0,0,0))/86400000)+1;var w=Math.floor((daynum-offset+7)/7);if(w===dow){y--;var prevOffset=7+1-new Date(y,0,1).getDay();if(prevOffset==2||prevOffset==8){w=53}else{w=52}}return w};Date.prototype.isDST=function(){console.log("isDST");return this.toString().match(/(E|C|M|P)(S|D)T/)[2]=="D"};Date.prototype.getTimezone=function(){return Date.getTimezoneAbbreviation(this.getUTCOffset,this.isDST())};Date.prototype.setTimezoneOffset=function(s){var here=this.getTimezoneOffset(),there=Number(s)*-6/10;this.addMinutes(there-here);return this};Date.prototype.setTimezone=function(s){return this.setTimezoneOffset(Date.getTimezoneOffset(s))};Date.prototype.getUTCOffset=function(){var n=this.getTimezoneOffset()*-10/6,r;if(n<0){r=(n-10000).toString();return r[0]+r.substr(2)}else{r=(n+10000).toString();return"+"+r.substr(1)}};Date.prototype.getDayName=function(abbrev){return abbrev?Date.CultureInfo.abbreviatedDayNames[this.getDay()]:Date.CultureInfo.dayNames[this.getDay()]};Date.prototype.getMonthName=function(abbrev){return abbrev?Date.CultureInfo.abbreviatedMonthNames[this.getMonth()]:Date.CultureInfo.monthNames[this.getMonth()]};if(!Date.prototype._toString){Date.prototype._toString=Date.prototype.toString}Date.prototype.toString=function(format){var self=this;var p=function p(s){return(s.toString().length==1)?"0"+s:s};return format?format.replace(/dd?d?d?|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|zz?z?/g,function(format){switch(format){case"hh":return p(self.getHours()<13?self.getHours():(self.getHours()-12));case"h":return self.getHours()<13?self.getHours():(self.getHours()-12);case"HH":return p(self.getHours());case"H":return self.getHours();case"mm":return p(self.getMinutes());case"m":return self.getMinutes();case"ss":return p(self.getSeconds());case"s":return self.getSeconds();case"yyyy":return self.getFullYear();case"yy":return self.getFullYear().toString().substring(2,4);case"dddd":return self.getDayName();case"ddd":return self.getDayName(true);case"dd":return p(self.getDate());case"d":return self.getDate().toString();case"MMMM":return self.getMonthName();case"MMM":return self.getMonthName(true);case"MM":return p((self.getMonth()+1));case"M":return self.getMonth()+1;case"t":return self.getHours()<12?Date.CultureInfo.amDesignator.substring(0,1):Date.CultureInfo.pmDesignator.substring(0,1);case"tt":return self.getHours()<12?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator;case"zzz":case"zz":case"z":return""}}):this._toString()};Date.now=function(){return new Date()};Date.today=function(){return Date.now().clearTime()};Date.prototype._orient=+1;Date.prototype.next=function(){this._orient=+1;return this};Date.prototype.last=Date.prototype.prev=Date.prototype.previous=function(){this._orient=-1;return this};Date.prototype._is=false;Date.prototype.is=function(){this._is=true;return this};Number.prototype._dateElement="day";Number.prototype.fromNow=function(){var c={};c[this._dateElement]=this;return Date.now().add(c)};Number.prototype.ago=function(){var c={};c[this._dateElement]=this*-1;return Date.now().add(c)};(function(){var $D=Date.prototype,$N=Number.prototype;var dx=("sunday monday tuesday wednesday thursday friday saturday").split(/\s/),mx=("january february march april may june july august september october november december").split(/\s/),px=("Millisecond Second Minute Hour Day Week Month Year").split(/\s/),de;var df=function(n){return function(){if(this._is){this._is=false;return this.getDay()==n}return this.moveToDayOfWeek(n,this._orient)}};for(var i=0;i<dx.length;i++){$D[dx[i]]=$D[dx[i].substring(0,3)]=df(i)}var mf=function(n){return function(){if(this._is){this._is=false;return this.getMonth()===n}return this.moveToMonth(n,this._orient)}};for(var j=0;j<mx.length;j++){$D[mx[j]]=$D[mx[j].substring(0,3)]=mf(j)}var ef=function(j){return function(){if(j.substring(j.length-1)!="s"){j+="s"}return this["add"+j](this._orient)}};var nf=function(n){return function(){this._dateElement=n;return this}};for(var k=0;k<px.length;k++){de=px[k].toLowerCase();$D[de]=$D[de+"s"]=ef(px[k]);$N[de]=$N[de+"s"]=nf(de)}}());Date.prototype.toJSONString=function(){return this.toString("yyyy-MM-ddThh:mm:ssZ")};Date.prototype.toShortDateString=function(){return this.toString(Date.CultureInfo.formatPatterns.shortDatePattern)};Date.prototype.toLongDateString=function(){return this.toString(Date.CultureInfo.formatPatterns.longDatePattern)};Date.prototype.toShortTimeString=function(){return this.toString(Date.CultureInfo.formatPatterns.shortTimePattern)};Date.prototype.toLongTimeString=function(){return this.toString(Date.CultureInfo.formatPatterns.longTimePattern)};Date.prototype.getOrdinal=function(){switch(this.getDate()){case 1:case 21:case 31:return"st";case 2:case 22:return"nd";case 3:case 23:return"rd";default:return"th"}};(function(){Date.Parsing={Exception:function(s){this.message="Parse error at '"+s.substring(0,10)+" ...'"}};var $P=Date.Parsing;var _=$P.Operators={rtoken:function(r){return function(s){var mx=s.match(r);if(mx){return([mx[0],s.substring(mx[0].length)])}else{throw new $P.Exception(s)}}},token:function(s){return function(s){return _.rtoken(new RegExp("^s*"+s+"s*"))(s)}},stoken:function(s){return _.rtoken(new RegExp("^"+s))},until:function(p){return function(s){var qx=[],rx=null;while(s.length){try{rx=p.call(this,s)}catch(e){qx.push(rx[0]);s=rx[1];continue}break}return[qx,s]}},many:function(p){return function(s){var rx=[],r=null;while(s.length){try{r=p.call(this,s)}catch(e){return[rx,s]}rx.push(r[0]);s=r[1]}return[rx,s]}},optional:function(p){return function(s){var r=null;try{r=p.call(this,s)}catch(e){return[null,s]}return[r[0],r[1]]}},not:function(p){return function(s){try{p.call(this,s)}catch(e){return[null,s]}throw new $P.Exception(s)}},ignore:function(p){return p?function(s){var r=null;r=p.call(this,s);return[null,r[1]]}:null},product:function(){var px=arguments[0],qx=Array.prototype.slice.call(arguments,1),rx=[];for(var i=0;i<px.length;i++){rx.push(_.each(px[i],qx))}return rx},cache:function(rule){var cache={},r=null;return function(s){try{r=cache[s]=(cache[s]||rule.call(this,s))}catch(e){r=cache[s]=e}if(r instanceof $P.Exception){throw r}else{return r}}},any:function(){var px=arguments;return function(s){var r=null;for(var i=0;i<px.length;i++){if(px[i]==null){continue}try{r=(px[i].call(this,s))}catch(e){r=null}if(r){return r}}throw new $P.Exception(s)}},each:function(){var px=arguments;return function(s){var rx=[],r=null;for(var i=0;i<px.length;i++){if(px[i]==null){continue}try{r=(px[i].call(this,s))}catch(e){throw new $P.Exception(s)}rx.push(r[0]);s=r[1]}return[rx,s]}},all:function(){var px=arguments,_=_;return _.each(_.optional(px))},sequence:function(px,d,c){d=d||_.rtoken(/^\s*/);c=c||null;if(px.length==1){return px[0]}return function(s){var r=null,q=null;var rx=[];for(var i=0;i<px.length;i++){try{r=px[i].call(this,s)}catch(e){break}rx.push(r[0]);try{q=d.call(this,r[1])}catch(ex){q=null;break}s=q[1]}if(!r){throw new $P.Exception(s)}if(q){throw new $P.Exception(q[1])}if(c){try{r=c.call(this,r[1])}catch(ey){throw new $P.Exception(r[1])}}return[rx,(r?r[1]:s)]}},between:function(d1,p,d2){d2=d2||d1;var _fn=_.each(_.ignore(d1),p,_.ignore(d2));return function(s){var rx=_fn.call(this,s);return[[rx[0][0],r[0][2]],rx[1]]}},list:function(p,d,c){d=d||_.rtoken(/^\s*/);c=c||null;return(p instanceof Array?_.each(_.product(p.slice(0,-1),_.ignore(d)),p.slice(-1),_.ignore(c)):_.each(_.many(_.each(p,_.ignore(d))),px,_.ignore(c)))},set:function(px,d,c){d=d||_.rtoken(/^\s*/);c=c||null;return function(s){var r=null,p=null,q=null,rx=null,best=[[],s],last=false;for(var i=0;i<px.length;i++){q=null;p=null;r=null;last=(px.length==1);try{r=px[i].call(this,s)}catch(e){continue}rx=[[r[0]],r[1]];if(r[1].length>0&&!last){try{q=d.call(this,r[1])}catch(ex){last=true}}else{last=true}if(!last&&q[1].length===0){last=true}if(!last){var qx=[];for(var j=0;j<px.length;j++){if(i!=j){qx.push(px[j])}}p=_.set(qx,d).call(this,q[1]);if(p[0].length>0){rx[0]=rx[0].concat(p[0]);rx[1]=p[1]}}if(rx[1].length<best[1].length){best=rx}if(best[1].length===0){break}}if(best[0].length===0){return best}if(c){try{q=c.call(this,best[1])}catch(ey){throw new $P.Exception(best[1])}best[1]=q[1]}return best}},forward:function(gr,fname){return function(s){return gr[fname].call(this,s)}},replace:function(rule,repl){return function(s){var r=rule.call(this,s);return[repl,r[1]]}},process:function(rule,fn){return function(s){var r=rule.call(this,s);return[fn.call(this,r[0]),r[1]]}},min:function(min,rule){return function(s){var rx=rule.call(this,s);if(rx[0].length<min){throw new $P.Exception(s)}return rx}}};var _generator=function(op){return function(){var args=null,rx=[];if(arguments.length>1){args=Array.prototype.slice.call(arguments)}else{if(arguments[0] instanceof Array){args=arguments[0]}}if(args){for(var i=0,px=args.shift();i<px.length;i++){args.unshift(px[i]);rx.push(op.apply(null,args));args.shift();return rx}}else{return op.apply(null,arguments)}}};var gx="optional not ignore cache".split(/\s/);for(var i=0;i<gx.length;i++){_[gx[i]]=_generator(_[gx[i]])}var _vector=function(op){return function(){if(arguments[0] instanceof Array){return op.apply(null,arguments[0])}else{return op.apply(null,arguments)}}};var vx="each any all".split(/\s/);for(var j=0;j<vx.length;j++){_[vx[j]]=_vector(_[vx[j]])}}());(function(){var flattenAndCompact=function(ax){var rx=[];for(var i=0;i<ax.length;i++){if(ax[i] instanceof Array){rx=rx.concat(flattenAndCompact(ax[i]))}else{if(ax[i]){rx.push(ax[i])}}}return rx};Date.Grammar={};Date.Translator={hour:function(s){return function(){this.hour=Number(s)}},minute:function(s){return function(){this.minute=Number(s)}},second:function(s){return function(){this.second=Number(s)}},meridian:function(s){return function(){this.meridian=s.slice(0,1).toLowerCase()}},timezone:function(s){return function(){var n=s.replace(/[^\d\+\-]/g,"");if(n.length){this.timezoneOffset=Number(n)}else{this.timezone=s.toLowerCase()}}},day:function(x){var s=x[0];return function(){this.day=Number(s.match(/\d+/)[0])}},month:function(s){return function(){this.month=((s.length==3)?Date.getMonthNumberFromName(s):(Number(s)-1))}},year:function(s){return function(){var n=Number(s);this.year=((s.length>2)?n:(n+(((n+2000)<Date.CultureInfo.twoDigitYearMax)?2000:1900)))}},rday:function(s){return function(){switch(s){case"yesterday":this.days=-1;break;case"tomorrow":this.days=1;break;case"today":this.days=0;break;case"now":this.days=0;this.now=true;break}}},finishExact:function(x){x=(x instanceof Array)?x:[x];var now=new Date();this.year=now.getFullYear();this.month=now.getMonth();this.day=1;this.hour=0;this.minute=0;this.second=0;for(var i=0;i<x.length;i++){if(x[i]){x[i].call(this)}}this.hour=(this.meridian=="p"&&this.hour<13)?this.hour+12:this.hour;if(this.day>Date.getDaysInMonth(this.year,this.month)){throw new RangeError(this.day+" is not a valid value for days.")}var r=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second);if(this.timezone){r.set({timezone:this.timezone})}else{if(this.timezoneOffset){r.set({timezoneOffset:this.timezoneOffset})}}return r},finish:function(x){x=(x instanceof Array)?flattenAndCompact(x):[x];if(x.length===0){return null}for(var i=0;i<x.length;i++){if(typeof x[i]=="function"){x[i].call(this)}}if(this.now){return new Date()}var today=Date.today();var method=null;var expression=!!(this.days!=null||this.orient||this.operator);if(expression){var gap,mod,orient;orient=((this.orient=="past"||this.operator=="subtract")?-1:1);if(this.weekday){this.unit="day";gap=(Date.getDayNumberFromName(this.weekday)-today.getDay());mod=7;this.days=gap?((gap+(orient*mod))%mod):(orient*mod)}if(this.month){this.unit="month";gap=(this.month-today.getMonth());mod=12;this.months=gap?((gap+(orient*mod))%mod):(orient*mod);this.month=null}if(!this.unit){this.unit="day"}if(this[this.unit+"s"]==null||this.operator!=null){if(!this.value){this.value=1}if(this.unit=="week"){this.unit="day";this.value=this.value*7}this[this.unit+"s"]=this.value*orient}return today.add(this)}else{if(this.meridian&&this.hour){this.hour=(this.hour<13&&this.meridian=="p")?this.hour+12:this.hour}if(this.weekday&&!this.day){this.day=(today.addDays((Date.getDayNumberFromName(this.weekday)-today.getDay()))).getDate()}if(this.month&&!this.day){this.day=1}return today.set(this)}}};var _=Date.Parsing.Operators,g=Date.Grammar,t=Date.Translator,_fn;g.datePartDelimiter=_.rtoken(/^([\s\-\.\,\/\x27]+)/);g.timePartDelimiter=_.stoken(":");g.whiteSpace=_.rtoken(/^\s*/);g.generalDelimiter=_.rtoken(/^(([\s\,]|at|on)+)/);var _C={};g.ctoken=function(keys){var fn=_C[keys];if(!fn){var c=Date.CultureInfo.regexPatterns;var kx=keys.split(/\s+/),px=[];for(var i=0;i<kx.length;i++){px.push(_.replace(_.rtoken(c[kx[i]]),kx[i]))}fn=_C[keys]=_.any.apply(null,px)}return fn};g.ctoken2=function(key){return _.rtoken(Date.CultureInfo.regexPatterns[key])};g.h=_.cache(_.process(_.rtoken(/^(0[0-9]|1[0-2]|[1-9])/),t.hour));g.hh=_.cache(_.process(_.rtoken(/^(0[0-9]|1[0-2])/),t.hour));g.H=_.cache(_.process(_.rtoken(/^([0-1][0-9]|2[0-3]|[0-9])/),t.hour));g.HH=_.cache(_.process(_.rtoken(/^([0-1][0-9]|2[0-3])/),t.hour));g.m=_.cache(_.process(_.rtoken(/^([0-5][0-9]|[0-9])/),t.minute));g.mm=_.cache(_.process(_.rtoken(/^[0-5][0-9]/),t.minute));g.s=_.cache(_.process(_.rtoken(/^([0-5][0-9]|[0-9])/),t.second));g.ss=_.cache(_.process(_.rtoken(/^[0-5][0-9]/),t.second));g.hms=_.cache(_.sequence([g.H,g.mm,g.ss],g.timePartDelimiter));g.t=_.cache(_.process(g.ctoken2("shortMeridian"),t.meridian));g.tt=_.cache(_.process(g.ctoken2("longMeridian"),t.meridian));g.z=_.cache(_.process(_.rtoken(/^(\+|\-)?\s*\d\d\d\d?/),t.timezone));g.zz=_.cache(_.process(_.rtoken(/^(\+|\-)\s*\d\d\d\d/),t.timezone));g.zzz=_.cache(_.process(g.ctoken2("timezone"),t.timezone));g.timeSuffix=_.each(_.ignore(g.whiteSpace),_.set([g.tt,g.zzz]));g.time=_.each(_.optional(_.ignore(_.stoken("T"))),g.hms,g.timeSuffix);g.d=_.cache(_.process(_.each(_.rtoken(/^([0-2]\d|3[0-1]|\d)/),_.optional(g.ctoken2("ordinalSuffix"))),t.day));g.dd=_.cache(_.process(_.each(_.rtoken(/^([0-2]\d|3[0-1])/),_.optional(g.ctoken2("ordinalSuffix"))),t.day));g.ddd=g.dddd=_.cache(_.process(g.ctoken("sun mon tue wed thu fri sat"),function(s){return function(){this.weekday=s}}));g.M=_.cache(_.process(_.rtoken(/^(1[0-2]|0\d|\d)/),t.month));g.MM=_.cache(_.process(_.rtoken(/^(1[0-2]|0\d)/),t.month));g.MMM=g.MMMM=_.cache(_.process(g.ctoken("jan feb mar apr may jun jul aug sep oct nov dec"),t.month));g.y=_.cache(_.process(_.rtoken(/^(\d\d?)/),t.year));g.yy=_.cache(_.process(_.rtoken(/^(\d\d)/),t.year));g.yyy=_.cache(_.process(_.rtoken(/^(\d\d?\d?\d?)/),t.year));g.yyyy=_.cache(_.process(_.rtoken(/^(\d\d\d\d)/),t.year));_fn=function(){return _.each(_.any.apply(null,arguments),_.not(g.ctoken2("timeContext")))};g.day=_fn(g.d,g.dd);g.month=_fn(g.M,g.MMM);g.year=_fn(g.yyyy,g.yy);g.orientation=_.process(g.ctoken("past future"),function(s){return function(){this.orient=s}});g.operator=_.process(g.ctoken("add subtract"),function(s){return function(){this.operator=s}});g.rday=_.process(g.ctoken("yesterday tomorrow today now"),t.rday);g.unit=_.process(g.ctoken("minute hour day week month year"),function(s){return function(){this.unit=s}});g.value=_.process(_.rtoken(/^\d\d?(st|nd|rd|th)?/),function(s){return function(){this.value=s.replace(/\D/g,"")}});g.expression=_.set([g.rday,g.operator,g.value,g.unit,g.orientation,g.ddd,g.MMM]);_fn=function(){return _.set(arguments,g.datePartDelimiter)};g.mdy=_fn(g.ddd,g.month,g.day,g.year);g.ymd=_fn(g.ddd,g.year,g.month,g.day);g.dmy=_fn(g.ddd,g.day,g.month,g.year);g.date=function(s){return((g[Date.CultureInfo.dateElementOrder]||g.mdy).call(this,s))};g.format=_.process(_.many(_.any(_.process(_.rtoken(/^(dd?d?d?|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|zz?z?)/),function(fmt){if(g[fmt]){return g[fmt]}else{throw Date.Parsing.Exception(fmt)}}),_.process(_.rtoken(/^[^dMyhHmstz]+/),function(s){return _.ignore(_.stoken(s))}))),function(rules){return _.process(_.each.apply(null,rules),t.finishExact)});var _F={};var _get=function(f){return _F[f]=(_F[f]||g.format(f)[0])};g.formats=function(fx){if(fx instanceof Array){var rx=[];for(var i=0;i<fx.length;i++){rx.push(_get(fx[i]))}return _.any.apply(null,rx)}else{return _get(fx)}};g._formats=g.formats(["yyyy-MM-ddTHH:mm:ss","ddd, MMM dd, yyyy H:mm:ss tt","ddd MMM d yyyy HH:mm:ss zzz","d"]);g._start=_.process(_.set([g.date,g.time,g.expression],g.generalDelimiter,g.whiteSpace),t.finish);g.start=function(s){try{var r=g._formats.call({},s);if(r[1].length===0){return r}}catch(e){}return g._start.call({},s)}}());Date._parse=Date.parse;Date.parse=function(s){var r=null;if(!s){return null}try{r=Date.Grammar.start.call({},s)}catch(e){return null}return((r[1].length===0)?r[0]:null)};Date.getParseFunction=function(fx){var fn=Date.Grammar.formats(fx);return function(s){var r=null;try{r=fn.call({},s)}catch(e){return null}return((r[1].length===0)?r[0]:null)}};Date.parseExact=function(s,fx){return Date.getParseFunction(fx)(s)};
/*!
 * jQuery Cookie Plugin v1.2
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2011, Klaus Hartl
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.opensource.org/licenses/GPL-2.0
 */
(function($,document,undefined){var pluses=/\+/g;function raw(s){return s}function decoded(s){return decodeURIComponent(s.replace(pluses," "))}var config=$.cookie=function(key,value,options){if(value!==undefined){options=$.extend({},config.defaults,options);if(value===null){options.expires=-1}if(typeof options.expires==="number"){var days=options.expires,t=options.expires=new Date();t.setDate(t.getDate()+days)}value=config.json?JSON.stringify(value):String(value);return(document.cookie=[encodeURIComponent(key),"=",config.raw?value:encodeURIComponent(value),options.expires?"; expires="+options.expires.toUTCString():"",options.path?"; path="+options.path:"",options.domain?"; domain="+options.domain:"",options.secure?"; secure":""].join(""))}var decode=config.raw?raw:decoded;var cookies=document.cookie.split("; ");for(var i=0,parts;(parts=cookies[i]&&cookies[i].split("="));i++){if(decode(parts.shift())===key){var cookie=decode(parts.join("="));return config.json?JSON.parse(cookie):cookie}}return null};config.defaults={};$.removeCookie=function(key,options){if($.cookie(key)!==null){$.cookie(key,null,options);return true}return false}})(jQuery,document);!function(window,document,undefined){var prefixes=["webkit","Moz","ms","O"],animations={},useCssAnimations;function createEl(tag,prop){var el=document.createElement(tag||"div"),n;for(n in prop){el[n]=prop[n]}return el}function ins(parent){for(var i=1,n=arguments.length;i<n;i++){parent.appendChild(arguments[i])}return parent}var sheet=function(){var el=createEl("style",{type:"text/css"});ins(document.getElementsByTagName("head")[0],el);return el.sheet||el.styleSheet}();function addAnimation(alpha,trail,i,lines){var name=["opacity",trail,~~(alpha*100),i,lines].join("-"),start=0.01+i/lines*100,z=Math.max(1-(1-alpha)/trail*(100-start),alpha),prefix=useCssAnimations.substring(0,useCssAnimations.indexOf("Animation")).toLowerCase(),pre=prefix&&"-"+prefix+"-"||"";if(!animations[name]){sheet.insertRule("@"+pre+"keyframes "+name+"{0%{opacity:"+z+"}"+start+"%{opacity:"+alpha+"}"+(start+0.01)+"%{opacity:1}"+(start+trail)%100+"%{opacity:"+alpha+"}100%{opacity:"+z+"}}",sheet.cssRules.length);animations[name]=1}return name}function vendor(el,prop){var s=el.style,pp,i;if(s[prop]!==undefined){return prop}prop=prop.charAt(0).toUpperCase()+prop.slice(1);for(i=0;i<prefixes.length;i++){pp=prefixes[i]+prop;if(s[pp]!==undefined){return pp}}}function css(el,prop){for(var n in prop){el.style[vendor(el,n)||n]=prop[n]}return el}function merge(obj){for(var i=1;i<arguments.length;i++){var def=arguments[i];for(var n in def){if(obj[n]===undefined){obj[n]=def[n]}}}return obj}function pos(el){var o={x:el.offsetLeft,y:el.offsetTop};while((el=el.offsetParent)){o.x+=el.offsetLeft,o.y+=el.offsetTop}return o}var defaults={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",speed:1,trail:100,opacity:1/4,fps:20,zIndex:2000000000,className:"spinner",top:"auto",left:"auto",position:"relative"};function Spinner(o){if(!this.spin){return new Spinner(o)}this.opts=merge(o||{},Spinner.defaults,defaults)}Spinner.defaults={};merge(Spinner.prototype,{spin:function(target){this.stop();var self=this,o=self.opts,el=self.el=css(createEl(0,{className:o.className}),{position:o.position,width:0,zIndex:o.zIndex}),mid=o.radius+o.length+o.width,ep,tp;if(target){target.insertBefore(el,target.firstChild||null);tp=pos(target);ep=pos(el);css(el,{left:(o.left=="auto"?tp.x-ep.x+(target.offsetWidth>>1):parseInt(o.left,10)+mid)+"px",top:(o.top=="auto"?tp.y-ep.y+(target.offsetHeight>>1):parseInt(o.top,10)+mid)+"px"})}el.setAttribute("aria-role","progressbar");self.lines(el,self.opts);if(!useCssAnimations){var i=0,fps=o.fps,f=fps/o.speed,ostep=(1-o.opacity)/(f*o.trail/100),astep=f/o.lines;(function anim(){i++;for(var s=o.lines;s;s--){var alpha=Math.max(1-(i+s*astep)%f*ostep,o.opacity);self.opacity(el,o.lines-s,alpha,o)}self.timeout=self.el&&setTimeout(anim,~~(1000/fps))})()}return self},stop:function(){var el=this.el;if(el){clearTimeout(this.timeout);if(el.parentNode){el.parentNode.removeChild(el)}this.el=undefined}return this},lines:function(el,o){var i=0,seg;function fill(color,shadow){return css(createEl(),{position:"absolute",width:(o.length+o.width)+"px",height:o.width+"px",background:color,boxShadow:shadow,transformOrigin:"left",transform:"rotate("+~~(360/o.lines*i+o.rotate)+"deg) translate("+o.radius+"px,0)",borderRadius:(o.corners*o.width>>1)+"px"})}for(;i<o.lines;i++){seg=css(createEl(),{position:"absolute",top:1+~(o.width/2)+"px",transform:o.hwaccel?"translate3d(0,0,0)":"",opacity:o.opacity,animation:useCssAnimations&&addAnimation(o.opacity,o.trail,i,o.lines)+" "+1/o.speed+"s linear infinite"});if(o.shadow){ins(seg,css(fill("#000","0 0 4px #000"),{top:2+"px"}))}ins(el,ins(seg,fill(o.color,"0 0 1px rgba(0,0,0,.1)")))}return el},opacity:function(el,i,val){if(i<el.childNodes.length){el.childNodes[i].style.opacity=val}}});(function(){function vml(tag,attr){return createEl("<"+tag+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',attr)}var s=css(createEl("group"),{behavior:"url(#default#VML)"});if(!vendor(s,"transform")&&s.adj){sheet.addRule(".spin-vml","behavior:url(#default#VML)");Spinner.prototype.lines=function(el,o){var r=o.length+o.width,s=2*r;function grp(){return css(vml("group",{coordsize:s+" "+s,coordorigin:-r+" "+-r}),{width:s,height:s})}var margin=-(o.width+o.length)*2+"px",g=css(grp(),{position:"absolute",top:margin,left:margin}),i;function seg(i,dx,filter){ins(g,ins(css(grp(),{rotation:360/o.lines*i+"deg",left:~~dx}),ins(css(vml("roundrect",{arcsize:o.corners}),{width:r,height:o.width,left:o.radius,top:-o.width>>1,filter:filter}),vml("fill",{color:o.color,opacity:o.opacity}),vml("stroke",{opacity:0}))))}if(o.shadow){for(i=1;i<=o.lines;i++){seg(i,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)")}}for(i=1;i<=o.lines;i++){seg(i)}return ins(el,g)};Spinner.prototype.opacity=function(el,i,val,o){var c=el.firstChild;o=o.shadow&&o.lines||0;if(c&&i+o<c.childNodes.length){c=c.childNodes[i+o];c=c&&c.firstChild;c=c&&c.firstChild;if(c){c.opacity=val}}}}else{useCssAnimations=vendor(s,"animation")}})();if(typeof define=="function"&&define.amd){define(function(){return Spinner})}else{window.Spinner=Spinner}}(window,document);if(!window.Silverlight){window.Silverlight={}}Silverlight._silverlightCount=0;Silverlight.__onSilverlightInstalledCalled=false;Silverlight.fwlinkRoot="http://go2.microsoft.com/fwlink/?LinkID=";Silverlight.__installationEventFired=false;Silverlight.onGetSilverlight=null;Silverlight.onSilverlightInstalled=function(){window.location.reload(false)};Silverlight.isInstalled=function(b){if(b==undefined){b=null}var a=false,m=null;try{var i=null,j=false;if(window.ActiveXObject){try{i=new ActiveXObject("AgControl.AgControl");if(b===null){a=true}else{if(i.IsVersionSupported(b)){a=true}}i=null}catch(l){j=true}}else{j=true}if(j){var k=navigator.plugins["Silverlight Plug-In"];if(k){if(b===null){a=true}else{var h=k.description;if(h==="1.0.30226.2"){h="2.0.30226.2"}var c=h.split(".");while(c.length>3){c.pop()}while(c.length<4){c.push(0)}var e=b.split(".");while(e.length>4){e.pop()}var d,g,f=0;do{d=parseInt(e[f]);g=parseInt(c[f]);f++}while(f<e.length&&d===g);if(d<=g&&!isNaN(d)){a=true}}}}}catch(l){a=false}return a};window.pauseSilverlightDetection=false;Silverlight.WaitForInstallCompletion=function(){if(!Silverlight.isBrowserRestartRequired&&Silverlight.onSilverlightInstalled){try{if(!window.pauseSilverlightDetection){navigator.plugins.refresh()}}catch(a){}if(Silverlight.isInstalled(null)&&!Silverlight.__onSilverlightInstalledCalled){Silverlight.onSilverlightInstalled();Silverlight.__onSilverlightInstalledCalled=true}else{setTimeout(Silverlight.WaitForInstallCompletion,3000)}}};Silverlight.__startup=function(){navigator.plugins.refresh();Silverlight.isBrowserRestartRequired=Silverlight.isInstalled(null);if(!Silverlight.isBrowserRestartRequired){Silverlight.WaitForInstallCompletion();if(!Silverlight.__installationEventFired){Silverlight.onInstallRequired();Silverlight.__installationEventFired=true}}else{if(window.navigator.mimeTypes){var b=navigator.mimeTypes["application/x-silverlight-2"],c=navigator.mimeTypes["application/x-silverlight-2-b2"],d=navigator.mimeTypes["application/x-silverlight-2-b1"],a=d;if(c){a=c}if(!b&&(d||c)){if(!Silverlight.__installationEventFired){Silverlight.onUpgradeRequired();Silverlight.__installationEventFired=true}}else{if(b&&a){if(b.enabledPlugin&&a.enabledPlugin){if(b.enabledPlugin.description!=a.enabledPlugin.description){if(!Silverlight.__installationEventFired){Silverlight.onRestartRequired();Silverlight.__installationEventFired=true}}}}}}}if(!Silverlight.disableAutoStartup){if(window.removeEventListener){window.removeEventListener("load",Silverlight.__startup,false)}else{window.detachEvent("onload",Silverlight.__startup)}}};if(!Silverlight.disableAutoStartup){if(window.addEventListener){window.addEventListener("load",Silverlight.__startup,false)}else{window.attachEvent("onload",Silverlight.__startup)}}Silverlight.createObject=function(m,f,e,k,l,h,j){var d={},a=k,c=l;d.version=a.version;a.source=m;d.alt=a.alt;if(h){a.initParams=h}if(a.isWindowless&&!a.windowless){a.windowless=a.isWindowless}if(a.framerate&&!a.maxFramerate){a.maxFramerate=a.framerate}if(e&&!a.id){a.id=e}delete a.ignoreBrowserVer;delete a.inplaceInstallPrompt;delete a.version;delete a.isWindowless;delete a.framerate;delete a.data;delete a.src;delete a.alt;if(Silverlight.isInstalled(d.version)){for(var b in c){if(c[b]){if(b=="onLoad"&&typeof c[b]=="function"&&c[b].length!=1){var i=c[b];c[b]=function(a){return i(document.getElementById(e),j,a)}}var g=Silverlight.__getHandlerName(c[b]);if(g!=null){a[b]=g;c[b]=null}else{throw"typeof events."+b+" must be 'function' or 'string'"}}}slPluginHTML=Silverlight.buildHTML(a)}else{slPluginHTML=Silverlight.buildPromptHTML(d)}if(f){f.innerHTML=slPluginHTML}else{return slPluginHTML}};Silverlight.buildHTML=function(a){var b=[];b.push('<object type="application/x-silverlight" data="data:application/x-silverlight,"');if(a.id!=null){b.push(' id="'+Silverlight.HtmlAttributeEncode(a.id)+'"')}if(a.width!=null){b.push(' width="'+a.width+'"')}if(a.height!=null){b.push(' height="'+a.height+'"')}b.push(" >");delete a.id;delete a.width;delete a.height;for(var c in a){if(a[c]){b.push('<param name="'+Silverlight.HtmlAttributeEncode(c)+'" value="'+Silverlight.HtmlAttributeEncode(a[c])+'" />')}}b.push("</object>");return b.join("")};Silverlight.createObjectEx=function(b){var a=b,c=Silverlight.createObject(a.source,a.parentElement,a.id,a.properties,a.events,a.initParams,a.context);if(a.parentElement==null){return c}};Silverlight.buildPromptHTML=function(b){var a="",d=Silverlight.fwlinkRoot,c=b.version;if(b.alt){a=b.alt}else{if(!c){c=""}a="<a href='javascript:Silverlight.getSilverlight(\"{1}\");' style='text-decoration: none;'><img src='{2}' alt='Get Microsoft Silverlight' style='border-style: none'/></a>";a=a.replace("{1}",c);a=a.replace("{2}",d+"108181")}return a};Silverlight.getSilverlight=function(e){if(Silverlight.onGetSilverlight){Silverlight.onGetSilverlight()}var b="",a=String(e).split(".");if(a.length>1){var c=parseInt(a[0]);if(isNaN(c)||c<2){b="1.0"}else{b=a[0]+"."+a[1]}}var d="";if(b.match(/^\d+\056\d+$/)){d="&v="+b}Silverlight.followFWLink("149156"+d)};Silverlight.followFWLink=function(a){top.location=Silverlight.fwlinkRoot+String(a)};Silverlight.HtmlAttributeEncode=function(c){var a,b="";if(c==null){return null}for(var d=0;d<c.length;d++){a=c.charCodeAt(d);if(a>96&&a<123||a>64&&a<91||a>43&&a<58&&a!=47||a==95){b=b+String.fromCharCode(a)}else{b=b+"&#"+a+";"}}return b};Silverlight.default_error_handler=function(e,b){var d,c=b.ErrorType;d=b.ErrorCode;var a="\nSilverlight error message     \n";a+="ErrorCode: "+d+"\n";a+="ErrorType: "+c+"       \n";a+="Message: "+b.ErrorMessage+"     \n";if(c=="ParserError"){a+="XamlFile: "+b.xamlFile+"     \n";a+="Line: "+b.lineNumber+"     \n";a+="Position: "+b.charPosition+"     \n"}else{if(c=="RuntimeError"){if(b.lineNumber!=0){a+="Line: "+b.lineNumber+"     \n";a+="Position: "+b.charPosition+"     \n"}a+="MethodName: "+b.methodName+"     \n"}}alert(a)};Silverlight.__cleanup=function(){for(var a=Silverlight._silverlightCount-1;a>=0;a--){window["__slEvent"+a]=null}Silverlight._silverlightCount=0;if(window.removeEventListener){window.removeEventListener("unload",Silverlight.__cleanup,false)}else{window.detachEvent("onunload",Silverlight.__cleanup)}};Silverlight.__getHandlerName=function(b){var a="";if(typeof b=="string"){a=b}else{if(typeof b=="function"){if(Silverlight._silverlightCount==0){if(window.addEventListener){window.addEventListener("unload",Silverlight.__cleanup,false)}else{window.attachEvent("onunload",Silverlight.__cleanup)}}var c=Silverlight._silverlightCount++;a="__slEvent"+c;window[a]=b}else{a=null}}return a};Silverlight.onRequiredVersionAvailable=function(){};Silverlight.onRestartRequired=function(){};Silverlight.onUpgradeRequired=function(){};Silverlight.onInstallRequired=function(){};Silverlight.IsVersionAvailableOnError=function(d,a){var b=false;try{if(a.ErrorCode==8001&&!Silverlight.__installationEventFired){Silverlight.onUpgradeRequired();Silverlight.__installationEventFired=true}else{if(a.ErrorCode==8002&&!Silverlight.__installationEventFired){Silverlight.onRestartRequired();Silverlight.__installationEventFired=true}else{if(a.ErrorCode==5014||a.ErrorCode==2106){if(Silverlight.__verifySilverlight2UpgradeSuccess(a.getHost())){b=true}}else{b=true}}}}catch(c){}return b};Silverlight.IsVersionAvailableOnLoad=function(b){var a=false;try{if(Silverlight.__verifySilverlight2UpgradeSuccess(b.getHost())){a=true}}catch(c){}return a};Silverlight.__verifySilverlight2UpgradeSuccess=function(d){var c=false,b="4.0.50401",a=null;try{if(d.IsVersionSupported(b+".99")){a=Silverlight.onRequiredVersionAvailable;c=true}else{if(d.IsVersionSupported(b+".0")){a=Silverlight.onRestartRequired}else{a=Silverlight.onUpgradeRequired}}if(a&&!Silverlight.__installationEventFired){a();Silverlight.__installationEventFired=true}}catch(e){}return c};(function(){window.dropfile=true;if(("FileReader" in window)){return}if(!Silverlight.isInstalled()){window.dropfile=false;return}var path=(function(){var s=document.getElementsByTagName("script"),p=s[s.length-1];return((p.src?p.src:p.getAttribute("src")).match(/(.*\/)/)||[""])[0]})();var sl;var el;var attach=function(){if(!document.getElementsByTagName("body").length){return false}sl=document.createElement("div");Silverlight.createObjectEx({source:path+"dropfile.xap",parentElement:sl,id:"SilverlightControl",properties:{width:"100%",height:"100%",version:"2.0",background:"#FFFFFF"}});sl.style.display="block";sl.id="SilverlightContainer";sl.style.position="fixed";sl.style.width=sl.style.height="80px";document.getElementsByTagName("body")[0].appendChild(sl);hide();addEvent((document.body||document),"dragenter",function(event){event=event||window.event;var _el=event.target||event.srcElement;if(_el.id==="SilverlightControl"||_el.id==="SilverlightContainer"){return}el=_el;addEvent(el,"dragover",function(e){e=e||window.event;if(!("pageX" in e)){e.pageX=e.clientX;e.pageY=e.clientY}sl.style.top=(e.pageY-5)+"px";sl.style.left=(e.pageX-5)+"px"});return false});return true};if(!attach()){addEvent(window,"load",attach)}function hide(e){sl.style.left=sl.style.top="-1000px"}function addEvent(el,name,func){if(el.addEventListener){el.removeEventListener(name,func,false);el.addEventListener(name,func,false)}else{el.detachEvent("on"+name,func);el.attachEvent("on"+name,func)}}window.dropfile=function(){hide(true);var dataTransfer={files:[]};for(var i=0;i<arguments.length;i++){var name=arguments[i].split(",")[0],base64=arguments[i].split(",")[1],mime={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",svg:"image/svg+xml"}[name.toLowerCase().match(/[^\.]*$/)[0]]||"";dataTransfer.files[i]={name:name,size:base64.length,data:base64,type:mime}}if(el.dispatchEvent){try{var dropEvent=document.createEvent("DragEvent");dropEvent.files=dataTransfer.files;dropEvent.initDragEvent("drop",true,true,window,0,0,0,0,0,false,false,false,false,0,null,dataTransfer);el.dispatchEvent(dropEvent)}catch(e){throw ("Whoops could not trigger the drop event")}}else{if(el.fireEvent){try{var dropEvent=document.createEventObject();dropEvent.files=dataTransfer.files;el.fireEvent("ondrop",dropEvent)}catch(e){throw ("Whoops could not trigger the drop event")}}}};window.FileReader=function(){this.onload;this.result;this.readAsDataURL=function(file){this.read("data:"+file.type+";base64,"+file.data)};this.readAsBinaryString=function(file){this.read(atob(file.data))};this.readAsText=function(file,encoding){this.read(atob(file.data))};this.readAsArrayBuffer=function(file){throw ("Whoops FileReader.readAsArrayBuffer is unimplemented")};this.read=function(result,opt){this.result=result;if(this.onload){this.onload({target:{result:result}})}else{throw ("Please define the onload event handler first")}}}})();if(!("btoa" in window)){window.btoa=function(s){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e=[],i=0,b,buf;while(i<s.length){b=[s.charCodeAt(i++),s.charCodeAt(i++),s.charCodeAt(i++)];buf=(b[0]<<16)+((b[1]||0)<<8)+(b[2]||0);e.push(c.charAt((buf&(63<<18))>>18),c.charAt((buf&(63<<12))>>12),c.charAt(isNaN(b[1])?64:(buf&(63<<6))>>6),c.charAt(isNaN(b[2])?64:(buf&63)))}return e.join("")}}if(!("atob" in window)){window.atob=function(s){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",buf,a=b=d=[],j=i=0;if((s.length%4!=0)||(new RegExp("[^"+c+"]").test(s))||(/=/.test(s)&&(/=[^=]/.test(s)||/={3}/.test(s)))){throw new Error("Invalid base64 data")}while(i<s.length){j=i;a=[];for(;i<j+4;i++){a.push(c.indexOf(s.charAt(i)))}buf=(a[0]<<18)+(a[1]<<12)+((a[2]&63)<<6)+(a[3]&63);b=[((buf&(255<<16))>>16),((a[2]==64)?-1:(buf&(255<<8))>>8),((a[3]==64)?-1:(buf&255))];for(j=0;j<3;j++){if(b[j]>=0||j===0){d.push(String.fromCharCode(b[j]))}}}return d.join("")}}if(!window.getComputedStyle){window.getComputedStyle=function(el,pseudo){this.el=el;this.getPropertyValue=function(prop){var re=/(\-([a-z]){1})/g;if(prop=="float"){prop="styleFloat"}if(re.test(prop)){prop=prop.replace(re,function(){return arguments[2].toUpperCase()})}return el.currentStyle[prop]?el.currentStyle[prop]:null};return this}}(function(window,document,undefined){var _html2canvas={},previousElement,computedCSS,html2canvas,cachedRectElements=[];_html2canvas.Util={};_html2canvas.Util.log=function(a){if(_html2canvas.logging&&window.console&&window.console.log){window.console.log(a)}};_html2canvas.Util.trimText=(function(isNative){return function(input){return isNative?isNative.apply(input):((input||"")+"").replace(/^\s+|\s+$/g,"")}})(String.prototype.trim);_html2canvas.Util.asFloat=function(v){return parseFloat(v)};(function(){var TEXT_SHADOW_PROPERTY=/((rgba|rgb)\([^\)]+\)(\s-?\d+px){0,})/g;var TEXT_SHADOW_VALUES=/(-?\d+px)|(#.+)|(rgb\(.+\))|(rgba\(.+\))/g;_html2canvas.Util.parseTextShadows=function(value){if(!value||value==="none"){return[]}var shadows=value.match(TEXT_SHADOW_PROPERTY),results=[];for(var i=0;shadows&&(i<shadows.length);i++){var s=shadows[i].match(TEXT_SHADOW_VALUES);results.push({color:s[0],offsetX:s[1]?s[1].replace("px",""):0,offsetY:s[2]?s[2].replace("px",""):0,blur:s[3]?s[3].replace("px",""):0})}return results}})();_html2canvas.Util.parseBackgroundImage=function(value){var whitespace=" \r\n\t",method,definition,prefix,prefix_i,block,results=[],c,mode=0,numParen=0,quote,args;var appendResult=function(){if(method){if(definition.substr(0,1)==='"'){definition=definition.substr(1,definition.length-2)}if(definition){args.push(definition)}if(method.substr(0,1)==="-"&&(prefix_i=method.indexOf("-",1)+1)>0){prefix=method.substr(0,prefix_i);method=method.substr(prefix_i)}results.push({prefix:prefix,method:method.toLowerCase(),value:block,args:args})}args=[];method=prefix=definition=block=""};appendResult();for(var i=0,ii=value.length;i<ii;i++){c=value[i];if(mode===0&&whitespace.indexOf(c)>-1){continue}switch(c){case'"':if(!quote){quote=c}else{if(quote===c){quote=null}}break;case"(":if(quote){break}else{if(mode===0){mode=1;block+=c;continue}else{numParen++}}break;case")":if(quote){break}else{if(mode===1){if(numParen===0){mode=0;block+=c;appendResult();continue}else{numParen--}}}break;case",":if(quote){break}else{if(mode===0){appendResult();continue}else{if(mode===1){if(numParen===0&&!method.match(/^url$/i)){args.push(definition);definition="";block+=c;continue}}}}break}block+=c;if(mode===0){method+=c}else{definition+=c}}appendResult();return results};_html2canvas.Util.Bounds=function(element){var clientRect,bounds={};if(element.getBoundingClientRect){if(!element.clientRect){element.clientRect=element.getBoundingClientRect();cachedRectElements.push(element)}clientRect=element.clientRect;bounds.top=clientRect.top;bounds.bottom=clientRect.bottom||(clientRect.top+clientRect.height);bounds.left=clientRect.left;bounds.width=element.offsetWidth;bounds.height=element.offsetHeight}return bounds};_html2canvas.Util.OffsetBounds=function(element){var parent=element.offsetParent?_html2canvas.Util.OffsetBounds(element.offsetParent):{top:0,left:0};return{top:element.offsetTop+parent.top,bottom:element.offsetTop+element.offsetHeight+parent.top,left:element.offsetLeft+parent.left,width:element.offsetWidth,height:element.offsetHeight}};function toPX(element,attribute,value){var rsLeft=element.runtimeStyle&&element.runtimeStyle[attribute],left,style=element.style;if(!/^-?[0-9]+\.?[0-9]*(?:px)?$/i.test(value)&&/^-?\d/.test(value)){left=style.left;if(rsLeft){element.runtimeStyle.left=element.currentStyle.left}style.left=attribute==="fontSize"?"1em":(value||0);value=style.pixelLeft+"px";style.left=left;if(rsLeft){element.runtimeStyle.left=rsLeft}}if(!/^(thin|medium|thick)$/i.test(value)){return Math.round(parseFloat(value))+"px"}return value}function asInt(val){return parseInt(val,10)}function parseBackgroundSizePosition(value,element,attribute,index){value=(value||"").split(",");value=value[index||0]||value[0]||"auto";value=_html2canvas.Util.trimText(value).split(" ");if(attribute==="backgroundSize"&&(!value[0]||value[0].match(/cover|contain|auto/))){}else{value[0]=(value[0].indexOf("%")===-1)?toPX(element,attribute+"X",value[0]):value[0];if(value[1]===undefined){if(attribute==="backgroundSize"){value[1]="auto";return value}else{value[1]=value[0]}}value[1]=(value[1].indexOf("%")===-1)?toPX(element,attribute+"Y",value[1]):value[1]}return value}_html2canvas.Util.getCSSGliffy=function(element,attribute,index){var computed=$(element).data("gliffy-computed-css"),$gmc,value;if(computed){return computed[attribute]}$gmc=$(".gliffy-mock-stage");if(previousElement!==element){computedCSS=document.defaultView.getComputedStyle(element,null);if(element.tagName.toLowerCase()==="html"||element.tagName.toLowerCase()==="body"||element===($gmc.length>0?$gmc[0]:null)||element===($gmc.parent().length>0?$gmc.parent()[0]:null)){($(element).data("gliffy-computed-css",computedCSS))}}value=computedCSS[attribute];previousElement=element;return value};_html2canvas.Util.getCSSH2C=function(element,attribute,index){if(previousElement!==element){computedCSS=document.defaultView.getComputedStyle(element,null)}var value=computedCSS[attribute];if(/^background(Size|Position)$/.test(attribute)){return parseBackgroundSizePosition(value,element,attribute,index)}else{if(/border(Top|Bottom)(Left|Right)Radius/.test(attribute)){var arr=value.split(" ");if(arr.length<=1){arr[1]=arr[0]}return arr.map(asInt)}}return value};_html2canvas.Util.resizeBounds=function(current_width,current_height,target_width,target_height,stretch_mode){var target_ratio=target_width/target_height,current_ratio=current_width/current_height,output_width,output_height;if(!stretch_mode||stretch_mode==="auto"){output_width=target_width;output_height=target_height}else{if(target_ratio<current_ratio^stretch_mode==="contain"){output_height=target_height;output_width=target_height*current_ratio}else{output_width=target_width;output_height=target_width/current_ratio}}return{width:output_width,height:output_height}};function backgroundBoundsFactory(prop,el,bounds,image,imageIndex,backgroundSize){var bgposition=_html2canvas.Util.getCSS(el,prop,imageIndex),topPos,left,percentage,val;if(bgposition.length===1){val=bgposition[0];bgposition=[];bgposition[0]=val;bgposition[1]=val}if(bgposition[0].toString().indexOf("%")!==-1){percentage=(parseFloat(bgposition[0])/100);left=bounds.width*percentage;if(prop!=="backgroundSize"){left-=(backgroundSize||image).width*percentage}}else{if(prop==="backgroundSize"){if(bgposition[0]==="auto"){left=image.width}else{if(/contain|cover/.test(bgposition[0])){var resized=_html2canvas.Util.resizeBounds(image.width,image.height,bounds.width,bounds.height,bgposition[0]);left=resized.width;topPos=resized.height}else{left=parseInt(bgposition[0],10)}}}else{left=parseInt(bgposition[0],10)}}if(bgposition[1]==="auto"){topPos=left/image.width*image.height}else{if(bgposition[1].toString().indexOf("%")!==-1){percentage=(parseFloat(bgposition[1])/100);topPos=bounds.height*percentage;if(prop!=="backgroundSize"){topPos-=(backgroundSize||image).height*percentage}}else{topPos=parseInt(bgposition[1],10)}}return[left,topPos]}_html2canvas.Util.BackgroundPosition=function(el,bounds,image,imageIndex,backgroundSize){var result=backgroundBoundsFactory("backgroundPosition",el,bounds,image,imageIndex,backgroundSize);return{left:result[0],top:result[1]}};_html2canvas.Util.BackgroundSize=function(el,bounds,image,imageIndex){var result=backgroundBoundsFactory("backgroundSize",el,bounds,image,imageIndex);return{width:result[0],height:result[1]}};_html2canvas.Util.Extend=function(options,defaults){for(var key in options){if(options.hasOwnProperty(key)){defaults[key]=options[key]}}return defaults};_html2canvas.Util.Children=function(elem){var children;try{children=(elem.nodeName&&elem.nodeName.toUpperCase()==="IFRAME")?elem.contentDocument||elem.contentWindow.document:(function(array){var ret=[];if(array!==null){(function(first,second){var i=first.length,j=0;if(typeof second.length==="number"){for(var l=second.length;j<l;j++){first[i++]=second[j]}}else{while(second[j]!==undefined){first[i++]=second[j++]}}first.length=i;return first})(ret,array)}return ret})(elem.childNodes)}catch(ex){_html2canvas.Util.log("html2canvas.Util.Children failed with exception: "+ex.message);children=[]}return children};_html2canvas.Util.isTransparent=function(backgroundColor){return(backgroundColor==="transparent"||backgroundColor==="rgba(0, 0, 0, 0)")};_html2canvas.Util.Font=(function(){var fontData={};return function(font,fontSize,doc){if(fontData[font+"-"+fontSize]!==undefined){return fontData[font+"-"+fontSize]}var container=doc.createElement("div"),img=doc.createElement("img"),span=doc.createElement("span"),sampleText="Hidden Text",baseline,middle,metricsObj;container.style.visibility="hidden";container.style.fontFamily=font;container.style.fontSize=fontSize;container.style.margin=0;container.style.padding=0;doc.body.appendChild(container);img.src="data:image/gif;base64,R0lGODlhAQABAIABAP///wAAACwAAAAAAQABAAACAkQBADs=";img.width=1;img.height=1;img.style.margin=0;img.style.padding=0;img.style.verticalAlign="baseline";span.style.fontFamily=font;span.style.fontSize=fontSize;span.style.margin=0;span.style.padding=0;span.appendChild(doc.createTextNode(sampleText));container.appendChild(span);container.appendChild(img);baseline=(img.offsetTop-span.offsetTop)+1;container.removeChild(span);container.appendChild(doc.createTextNode(sampleText));container.style.lineHeight="normal";img.style.verticalAlign="super";middle=(img.offsetTop-container.offsetTop)+1;metricsObj={baseline:baseline,lineWidth:1,middle:middle};fontData[font+"-"+fontSize]=metricsObj;doc.body.removeChild(container);return metricsObj}})();(function(){var Util=_html2canvas.Util,Generate={};_html2canvas.Generate=Generate;var reGradients=[/^(-webkit-linear-gradient)\(([a-z\s]+)([\w\d\.\s,%\(\)]+)\)$/,/^(-o-linear-gradient)\(([a-z\s]+)([\w\d\.\s,%\(\)]+)\)$/,/^(-webkit-gradient)\((linear|radial),\s((?:\d{1,3}%?)\s(?:\d{1,3}%?),\s(?:\d{1,3}%?)\s(?:\d{1,3}%?))([\w\d\.\s,%\(\)\-]+)\)$/,/^(-moz-linear-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?))([\w\d\.\s,%\(\)]+)\)$/,/^(-webkit-radial-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?)),\s(\w+)\s([a-z\-]+)([\w\d\.\s,%\(\)]+)\)$/,/^(-moz-radial-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?)),\s(\w+)\s?([a-z\-]*)([\w\d\.\s,%\(\)]+)\)$/,/^(-o-radial-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?)),\s(\w+)\s([a-z\-]+)([\w\d\.\s,%\(\)]+)\)$/];Generate.parseGradient=function(css,bounds){var gradient,i,len=reGradients.length,m1,stop,m2,m2Len,step,m3,tl,tr,br,bl;for(i=0;i<len;i+=1){m1=css.match(reGradients[i]);if(m1){break}}if(m1){switch(m1[1]){case"-webkit-linear-gradient":case"-o-linear-gradient":gradient={type:"linear",x0:null,y0:null,x1:null,y1:null,colorStops:[]};m2=m1[2].match(/\w+/g);if(m2){m2Len=m2.length;for(i=0;i<m2Len;i+=1){switch(m2[i]){case"top":gradient.y0=0;gradient.y1=bounds.height;break;case"right":gradient.x0=bounds.width;gradient.x1=0;break;case"bottom":gradient.y0=bounds.height;gradient.y1=0;break;case"left":gradient.x0=0;gradient.x1=bounds.width;break}}}if(gradient.x0===null&&gradient.x1===null){gradient.x0=gradient.x1=bounds.width/2}if(gradient.y0===null&&gradient.y1===null){gradient.y0=gradient.y1=bounds.height/2}m2=m1[3].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)(?:\s\d{1,3}(?:%|px))?)+/g);if(m2){m2Len=m2.length;step=1/Math.max(m2Len-1,1);for(i=0;i<m2Len;i+=1){m3=m2[i].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%|px)?/);if(m3[2]){stop=parseFloat(m3[2]);if(m3[3]==="%"){stop/=100}else{stop/=bounds.width}}else{stop=i*step}gradient.colorStops.push({color:m3[1],stop:stop})}}break;case"-webkit-gradient":gradient={type:m1[2]==="radial"?"circle":m1[2],x0:0,y0:0,x1:0,y1:0,colorStops:[]};m2=m1[3].match(/(\d{1,3})%?\s(\d{1,3})%?,\s(\d{1,3})%?\s(\d{1,3})%?/);if(m2){gradient.x0=(m2[1]*bounds.width)/100;gradient.y0=(m2[2]*bounds.height)/100;gradient.x1=(m2[3]*bounds.width)/100;gradient.y1=(m2[4]*bounds.height)/100}m2=m1[4].match(/((?:from|to|color-stop)\((?:[0-9\.]+,\s)?(?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)\))+/g);if(m2){m2Len=m2.length;for(i=0;i<m2Len;i+=1){m3=m2[i].match(/(from|to|color-stop)\(([0-9\.]+)?(?:,\s)?((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\)/);stop=parseFloat(m3[2]);if(m3[1]==="from"){stop=0}if(m3[1]==="to"){stop=1}gradient.colorStops.push({color:m3[3],stop:stop})}}break;case"-moz-linear-gradient":gradient={type:"linear",x0:0,y0:0,x1:0,y1:0,colorStops:[]};m2=m1[2].match(/(\d{1,3})%?\s(\d{1,3})%?/);if(m2){gradient.x0=(m2[1]*bounds.width)/100;gradient.y0=(m2[2]*bounds.height)/100;gradient.x1=bounds.width-gradient.x0;gradient.y1=bounds.height-gradient.y0}m2=m1[3].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)(?:\s\d{1,3}%)?)+/g);if(m2){m2Len=m2.length;step=1/Math.max(m2Len-1,1);for(i=0;i<m2Len;i+=1){m3=m2[i].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%)?/);if(m3[2]){stop=parseFloat(m3[2]);if(m3[3]){stop/=100}}else{stop=i*step}gradient.colorStops.push({color:m3[1],stop:stop})}}break;case"-webkit-radial-gradient":case"-moz-radial-gradient":case"-o-radial-gradient":gradient={type:"circle",x0:0,y0:0,x1:bounds.width,y1:bounds.height,cx:0,cy:0,rx:0,ry:0,colorStops:[]};m2=m1[2].match(/(\d{1,3})%?\s(\d{1,3})%?/);if(m2){gradient.cx=(m2[1]*bounds.width)/100;gradient.cy=(m2[2]*bounds.height)/100}m2=m1[3].match(/\w+/);m3=m1[4].match(/[a-z\-]*/);if(m2&&m3){switch(m3[0]){case"farthest-corner":case"cover":case"":tl=Math.sqrt(Math.pow(gradient.cx,2)+Math.pow(gradient.cy,2));tr=Math.sqrt(Math.pow(gradient.cx,2)+Math.pow(gradient.y1-gradient.cy,2));br=Math.sqrt(Math.pow(gradient.x1-gradient.cx,2)+Math.pow(gradient.y1-gradient.cy,2));bl=Math.sqrt(Math.pow(gradient.x1-gradient.cx,2)+Math.pow(gradient.cy,2));gradient.rx=gradient.ry=Math.max(tl,tr,br,bl);break;case"closest-corner":tl=Math.sqrt(Math.pow(gradient.cx,2)+Math.pow(gradient.cy,2));tr=Math.sqrt(Math.pow(gradient.cx,2)+Math.pow(gradient.y1-gradient.cy,2));br=Math.sqrt(Math.pow(gradient.x1-gradient.cx,2)+Math.pow(gradient.y1-gradient.cy,2));bl=Math.sqrt(Math.pow(gradient.x1-gradient.cx,2)+Math.pow(gradient.cy,2));gradient.rx=gradient.ry=Math.min(tl,tr,br,bl);break;case"farthest-side":if(m2[0]==="circle"){gradient.rx=gradient.ry=Math.max(gradient.cx,gradient.cy,gradient.x1-gradient.cx,gradient.y1-gradient.cy)}else{gradient.type=m2[0];gradient.rx=Math.max(gradient.cx,gradient.x1-gradient.cx);gradient.ry=Math.max(gradient.cy,gradient.y1-gradient.cy)}break;case"closest-side":case"contain":if(m2[0]==="circle"){gradient.rx=gradient.ry=Math.min(gradient.cx,gradient.cy,gradient.x1-gradient.cx,gradient.y1-gradient.cy)}else{gradient.type=m2[0];gradient.rx=Math.min(gradient.cx,gradient.x1-gradient.cx);gradient.ry=Math.min(gradient.cy,gradient.y1-gradient.cy)}break}}m2=m1[5].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)(?:\s\d{1,3}(?:%|px))?)+/g);if(m2){m2Len=m2.length;step=1/Math.max(m2Len-1,1);for(i=0;i<m2Len;i+=1){m3=m2[i].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%|px)?/);if(m3[2]){stop=parseFloat(m3[2]);if(m3[3]==="%"){stop/=100}else{stop/=bounds.width}}else{stop=i*step}gradient.colorStops.push({color:m3[1],stop:stop})}}break}}return gradient};function addScrollStops(grad){return function(colorStop){try{grad.addColorStop(colorStop.stop,colorStop.color)}catch(e){Util.log(["failed to add color stop: ",e,"; tried to add: ",colorStop])}}}Generate.Gradient=function(src,bounds){if(bounds.width===0||bounds.height===0){return}var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),gradient,grad;canvas.width=bounds.width;canvas.height=bounds.height;gradient=_html2canvas.Generate.parseGradient(src,bounds);if(gradient){switch(gradient.type){case"linear":grad=ctx.createLinearGradient(gradient.x0,gradient.y0,gradient.x1,gradient.y1);gradient.colorStops.forEach(addScrollStops(grad));ctx.fillStyle=grad;ctx.fillRect(0,0,bounds.width,bounds.height);break;case"circle":grad=ctx.createRadialGradient(gradient.cx,gradient.cy,0,gradient.cx,gradient.cy,gradient.rx);gradient.colorStops.forEach(addScrollStops(grad));ctx.fillStyle=grad;ctx.fillRect(0,0,bounds.width,bounds.height);break;case"ellipse":var canvasRadial=document.createElement("canvas"),ctxRadial=canvasRadial.getContext("2d"),ri=Math.max(gradient.rx,gradient.ry),di=ri*2;canvasRadial.width=canvasRadial.height=di;grad=ctxRadial.createRadialGradient(gradient.rx,gradient.ry,0,gradient.rx,gradient.ry,ri);gradient.colorStops.forEach(addScrollStops(grad));ctxRadial.fillStyle=grad;ctxRadial.fillRect(0,0,di,di);ctx.fillStyle=gradient.colorStops[gradient.colorStops.length-1].color;ctx.fillRect(0,0,canvas.width,canvas.height);ctx.drawImage(canvasRadial,gradient.cx-gradient.rx,gradient.cy-gradient.ry,2*gradient.rx,2*gradient.ry);break}}return canvas};Generate.ListAlpha=function(number){var tmp="",modulus;do{modulus=number%26;tmp=String.fromCharCode((modulus)+64)+tmp;number=number/26}while((number*26)>26);return tmp};Generate.ListRoman=function(number){var romanArray=["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"],decimal=[1000,900,500,400,100,90,50,40,10,9,5,4,1],roman="",v,len=romanArray.length;if(number<=0||number>=4000){return number}for(v=0;v<len;v+=1){while(number>=decimal[v]){number-=decimal[v];roman+=romanArray[v]}}return roman}})();function h2cRenderContext(width,height){var storage=[];return{storage:storage,width:width,height:height,clip:function(){storage.push({type:"function",name:"clip","arguments":arguments})},translate:function(){storage.push({type:"function",name:"translate","arguments":arguments})},fill:function(){storage.push({type:"function",name:"fill","arguments":arguments})},save:function(){storage.push({type:"function",name:"save","arguments":arguments})},restore:function(){storage.push({type:"function",name:"restore","arguments":arguments})},fillRect:function(){storage.push({type:"function",name:"fillRect","arguments":arguments})},createPattern:function(){storage.push({type:"function",name:"createPattern","arguments":arguments})},drawShape:function(){var shape=[];storage.push({type:"function",name:"drawShape","arguments":shape});return{moveTo:function(){shape.push({name:"moveTo","arguments":arguments})},lineTo:function(){shape.push({name:"lineTo","arguments":arguments})},arcTo:function(){shape.push({name:"arcTo","arguments":arguments})},bezierCurveTo:function(){shape.push({name:"bezierCurveTo","arguments":arguments})},quadraticCurveTo:function(){shape.push({name:"quadraticCurveTo","arguments":arguments})}}},drawImage:function(){storage.push({type:"function",name:"drawImage","arguments":arguments})},fillText:function(){storage.push({type:"function",name:"fillText","arguments":arguments})},setVariable:function(variable,value){storage.push({type:"variable",name:variable,"arguments":value});return value}}}_html2canvas.cachedWidth=null,_html2canvas.cachedHeight=null;_html2canvas.Parse=function(images,options){if(!_html2canvas.options.gliffyOpt){window.scroll(0,0)}var element=((options.elements===undefined)?document.body:options.elements[0]),numDraws=0,doc=element.ownerDocument,Util=_html2canvas.Util,support=Util.Support(options,doc),ignoreElementsRegExp=new RegExp("("+options.ignoreElements+")"),body=doc.body,getCSS=Util.getCSS,pseudoHide="___html2canvas___pseudoelement",hidePseudoElements=doc.createElement("style");hidePseudoElements.innerHTML="."+pseudoHide+'-before:before { content: "" !important; display: none !important; }.'+pseudoHide+'-after:after { content: "" !important; display: none !important; }';body.appendChild(hidePseudoElements);images=images||{};var documentWidthH2C=function(){return Math.max(Math.max(doc.body.scrollWidth,doc.documentElement.scrollWidth),Math.max(doc.body.offsetWidth,doc.documentElement.offsetWidth),Math.max(doc.body.clientWidth,doc.documentElement.clientWidth))};var documentHeightH2C=function(){return Math.max(Math.max(doc.body.scrollHeight,doc.documentElement.scrollHeight),Math.max(doc.body.offsetHeight,doc.documentElement.offsetHeight),Math.max(doc.body.clientHeight,doc.documentElement.clientHeight))};var documentWidthGliffy=function(){if(_html2canvas.cachedWidth!==null){return _html2canvas.cachedWidth}var docWidth=Math.max(Math.max(doc.body.scrollWidth,doc.documentElement.scrollWidth),Math.max(doc.body.offsetWidth,doc.documentElement.offsetWidth),Math.max(doc.body.clientWidth,doc.documentElement.clientWidth));_html2canvas.cachedWidth=docWidth;return docWidth};var documentHeightGliffy=function(){if(_html2canvas.cachedHeight!==null){return _html2canvas.cachedHeight}var docHeight=Math.max(Math.max(doc.body.scrollHeight,doc.documentElement.scrollHeight),Math.max(doc.body.offsetHeight,doc.documentElement.offsetHeight),Math.max(doc.body.clientHeight,doc.documentElement.clientHeight));_html2canvas.cachedHeight=docHeight;return docHeight};var documentWidth,documentHeight;if(_html2canvas.options.gliffyOpt){documentWidth=documentWidthGliffy;documentHeight=documentHeightGliffy}else{documentWidth=documentWidthH2C;documentHeight=documentHeightH2C}function getCSSInt(element,attribute){var val=parseInt(getCSS(element,attribute),10);return(isNaN(val))?0:val}function renderRect(ctx,x,y,w,h,bgcolor){if(bgcolor!=="transparent"){ctx.setVariable("fillStyle",bgcolor);ctx.fillRect(x,y,w,h);numDraws+=1}}function capitalize(m,p1,p2){if(m.length>0){return p1+p2.toUpperCase()}}function textTransform(text,transform){switch(transform){case"lowercase":return text.toLowerCase();case"capitalize":return text.replace(/(^|\s|:|-|\(|\))([a-z])/g,capitalize);case"uppercase":return text.toUpperCase();default:return text}}function noLetterSpacing(letter_spacing){return(/^(normal|none|0px)$/.test(letter_spacing))}function drawText(currentText,x,y,ctx){if(currentText!==null&&Util.trimText(currentText).length>0){ctx.fillText(currentText,x,y);numDraws+=1}}function getLink(el){if(el.nodeName==="A"&&el.getAttribute("href")){return el.getAttribute("href")}if(el.parentElement){return getLink(el.parentElement)}return null}function setTextVariables(ctx,el,text_decoration,color){var align=false,bold=getCSS(el,"fontWeight"),family=getCSS(el,"fontFamily"),size=getCSS(el,"fontSize"),lineHeight=getCSS(el,"lineHeight"),shadows=Util.parseTextShadows(getCSS(el,"textShadow")),link=getLink(el);switch(parseInt(bold,10)){case 401:bold="bold";break;case 400:bold="normal";break}if(link){ctx.setVariable("__fontHref",link);ctx.setVariable("__fontHrefTarget","_blank")}else{ctx.setVariable("__fontHref",null);ctx.setVariable("__fontHrefTarget",null)}ctx.setVariable("fillStyle",color);family=family.replace(/\"/g,"'");if(family.indexOf("'")===-1){family="'"+family+"'"}ctx.setVariable("font",[getCSS(el,"fontStyle"),getCSS(el,"fontVariant"),bold,size+"/"+lineHeight,family].join(" "));ctx.setVariable("textAlign",(align)?"right":"left");if(shadows.length){ctx.setVariable("shadowColor",shadows[0].color);ctx.setVariable("shadowOffsetX",shadows[0].offsetX);ctx.setVariable("shadowOffsetY",shadows[0].offsetY);ctx.setVariable("shadowBlur",shadows[0].blur)}if(text_decoration!=="none"||options.useSVGTextBaseline){return Util.Font(family,size,doc)}}function renderTextDecoration(ctx,text_decoration,bounds,metrics,color){switch(text_decoration){case"underline":renderRect(ctx,bounds.left,Math.round(bounds.top+metrics.baseline+metrics.lineWidth),bounds.width,1,color);break;case"overline":renderRect(ctx,bounds.left,Math.round(bounds.top),bounds.width,1,color);break;case"line-through":renderRect(ctx,bounds.left,Math.ceil(bounds.top+metrics.middle+metrics.lineWidth),bounds.width,1,color);break}}function getTextBounds(state,text,textDecoration,isLast,transform){var bounds;if(support.rangeBounds&&!transform){if(textDecoration!=="none"||Util.trimText(text).length!==0){bounds=textRangeBounds(text,state.node,state.textOffset)}state.textOffset+=text.length}else{if(state.node&&typeof state.node.nodeValue==="string"){var newTextNode=(isLast)?state.node.splitText(text.length):null;bounds=textWrapperBounds(state.node,transform);state.node=newTextNode}}return bounds}function textRangeBounds(text,textNode,textOffset){var range=doc.createRange(),clientRectangle=null;if(range){range.setStart(textNode,textOffset);range.setEnd(textNode,textOffset+text.length);clientRectangle=range.getBoundingClientRect()}return clientRectangle}function textWrapperBounds(oldTextNode,transform){var parent=oldTextNode.parentNode,wrapElement=doc.createElement("wrapper"),backupText=oldTextNode.cloneNode(true);wrapElement.appendChild(oldTextNode.cloneNode(true));parent.replaceChild(wrapElement,oldTextNode);var bounds=transform?Util.OffsetBounds(wrapElement):Util.Bounds(wrapElement);parent.replaceChild(backupText,wrapElement);return bounds}function getTextDecoration(el){var textDecoration=getCSS(el,"textDecoration"),split;if(textDecoration.indexOf("none")===0){var condition;if(_html2canvas.options.gliffyOpt){condition=el.parentElement&&el.parentElement!=$(".gliffy-mock-stage")[0]}else{condition=el.parentElement}if(condition){return getTextDecoration(el.parentElement)}}return textDecoration.split(" ")[0]}function renderText(el,textNode,stack){var ctx=stack.ctx,color=getCSS(el,"color"),textDecoration=getTextDecoration(el),textAlign=getCSS(el,"textAlign"),metrics,textList,x,y,state={node:textNode,textOffset:0};if(Util.trimText(textNode.nodeValue).length>0){textNode.nodeValue=textTransform(textNode.nodeValue,getCSS(el,"textTransform"));textAlign=textAlign.replace(["-webkit-auto"],["auto"]);textList=(!options.letterRendering&&/^(left|right|justify|auto)$/.test(textAlign)&&noLetterSpacing(getCSS(el,"letterSpacing")))?textNode.nodeValue.split(/(\b| )/):textNode.nodeValue.split("");metrics=setTextVariables(ctx,el,textDecoration,color);if(options.chinese){textList.forEach(function(word,index){if(/.*[\u4E00-\u9FA5].*$/.test(word)){word=word.split("");word.unshift(index,1);textList.splice.apply(textList,word)}})}textList.forEach(function(text,index){var bounds=getTextBounds(state,text,textDecoration,(index<textList.length-1),stack.transform.matrix);if(bounds){var x=bounds.left,y=bounds.bottom;if(options.useSVGTextBaseline){y=bounds.top+metrics.baseline}drawText(text,x,y,ctx);renderTextDecoration(ctx,textDecoration,bounds,metrics,color)}})}}function listPosition(element,val){var boundElement=doc.createElement("boundelement"),originalType,bounds;boundElement.style.display="inline";originalType=element.style.listStyleType;element.style.listStyleType="none";boundElement.appendChild(doc.createTextNode(val));element.insertBefore(boundElement,element.firstChild);bounds=Util.Bounds(boundElement);element.removeChild(boundElement);element.style.listStyleType=originalType;return bounds}function elementIndex(el){var i=-1,count=1,childs=el.parentNode.childNodes;if(el.parentNode){while(childs[++i]!==el){if(childs[i].nodeType===1){count++}}return count}else{return -1}}function listItemText(element,type){var currentIndex=elementIndex(element),text;switch(type){case"decimal":text=currentIndex;break;case"decimal-leading-zero":text=(currentIndex.toString().length===1)?currentIndex="0"+currentIndex.toString():currentIndex.toString();break;case"upper-roman":text=_html2canvas.Generate.ListRoman(currentIndex);break;case"lower-roman":text=_html2canvas.Generate.ListRoman(currentIndex).toLowerCase();break;case"lower-alpha":text=_html2canvas.Generate.ListAlpha(currentIndex).toLowerCase();break;case"upper-alpha":text=_html2canvas.Generate.ListAlpha(currentIndex);break}return text+". "}function renderListItem(element,stack,elBounds){var x,text,ctx=stack.ctx,type=getCSS(element,"listStyleType"),listBounds;if(/^(decimal|decimal-leading-zero|upper-alpha|upper-latin|upper-roman|lower-alpha|lower-greek|lower-latin|lower-roman)$/i.test(type)){text=listItemText(element,type);listBounds=listPosition(element,text);setTextVariables(ctx,element,"none",getCSS(element,"color"));if(getCSS(element,"listStylePosition")==="inside"){ctx.setVariable("textAlign","left");x=elBounds.left}else{return}drawText(text,x,listBounds.bottom,ctx)}}function loadImage(src){var img=images[src];return(img&&img.succeeded===true)?img.img:false}function clipBounds(src,dst){var x=Math.max(src.left,dst.left),y=Math.max(src.top,dst.top),x2=Math.min((src.left+src.width),(dst.left+dst.width)),y2=Math.min((src.top+src.height),(dst.top+dst.height));return{left:x,top:y,width:x2-x,height:y2-y}}function setZ(element,stack,parentStack){var newContext,isPositioned=stack.cssPosition!=="static",zIndex=isPositioned?getCSS(element,"zIndex"):"auto",opacity=getCSS(element,"opacity"),isFloated=getCSS(element,"cssFloat")!=="none";stack.zIndex=newContext=h2czContext(zIndex);newContext.isPositioned=isPositioned;newContext.isFloated=isFloated;newContext.opacity=opacity;newContext.ownStacking=(zIndex!=="auto"||opacity<1);if(parentStack){parentStack.zIndex.children.push(stack)}}function renderImage(ctx,element,image,bounds,borders){var paddingLeft=getCSSInt(element,"paddingLeft"),paddingTop=getCSSInt(element,"paddingTop"),paddingRight=getCSSInt(element,"paddingRight"),paddingBottom=getCSSInt(element,"paddingBottom");drawImage(ctx,image,0,0,image.width,image.height,bounds.left+paddingLeft+borders[3].width,bounds.top+paddingTop+borders[0].width,bounds.width-(borders[1].width+borders[3].width+paddingLeft+paddingRight),bounds.height-(borders[0].width+borders[2].width+paddingTop+paddingBottom))}function getBorderData(element){return["Top","Right","Bottom","Left"].map(function(side){return{width:getCSSInt(element,"border"+side+"Width"),color:getCSS(element,"border"+side+"Color")}})}function getBorderRadiusData(element){return["TopLeft","TopRight","BottomRight","BottomLeft"].map(function(side){return getCSS(element,"border"+side+"Radius")})}var getCurvePoints=(function(kappa){return function(x,y,r1,r2){var ox=(r1)*kappa,oy=(r2)*kappa,xm=x+r1,ym=y+r2;return{topLeft:bezierCurve({x:x,y:ym},{x:x,y:ym-oy},{x:xm-ox,y:y},{x:xm,y:y}),topRight:bezierCurve({x:x,y:y},{x:x+ox,y:y},{x:xm,y:ym-oy},{x:xm,y:ym}),bottomRight:bezierCurve({x:xm,y:y},{x:xm,y:y+oy},{x:x+ox,y:ym},{x:x,y:ym}),bottomLeft:bezierCurve({x:xm,y:ym},{x:xm-ox,y:ym},{x:x,y:y+oy},{x:x,y:y})}}})(4*((Math.sqrt(2)-1)/3));function bezierCurve(start,startControl,endControl,end){var lerp=function(a,b,t){return{x:a.x+(b.x-a.x)*t,y:a.y+(b.y-a.y)*t}};return{start:start,startControl:startControl,endControl:endControl,end:end,subdivide:function(t){var ab=lerp(start,startControl,t),bc=lerp(startControl,endControl,t),cd=lerp(endControl,end,t),abbc=lerp(ab,bc,t),bccd=lerp(bc,cd,t),dest=lerp(abbc,bccd,t);return[bezierCurve(start,ab,abbc,dest),bezierCurve(dest,bccd,cd,end)]},curveTo:function(borderArgs){borderArgs.push(["bezierCurve",startControl.x,startControl.y,endControl.x,endControl.y,end.x,end.y])},curveToReversed:function(borderArgs){borderArgs.push(["bezierCurve",endControl.x,endControl.y,startControl.x,startControl.y,start.x,start.y])}}}function parseCorner(borderArgs,radius1,radius2,corner1,corner2,x,y){if(radius1[0]>0||radius1[1]>0){borderArgs.push(["line",corner1[0].start.x,corner1[0].start.y]);corner1[0].curveTo(borderArgs);corner1[1].curveTo(borderArgs)}else{borderArgs.push(["line",x,y])}if(radius2[0]>0||radius2[1]>0){borderArgs.push(["line",corner2[0].start.x,corner2[0].start.y])}}function drawSide(borderData,radius1,radius2,outer1,inner1,outer2,inner2){var borderArgs=[];if(radius1[0]>0||radius1[1]>0){borderArgs.push(["line",outer1[1].start.x,outer1[1].start.y]);outer1[1].curveTo(borderArgs)}else{borderArgs.push(["line",borderData.c1[0],borderData.c1[1]])}if(radius2[0]>0||radius2[1]>0){borderArgs.push(["line",outer2[0].start.x,outer2[0].start.y]);outer2[0].curveTo(borderArgs);borderArgs.push(["line",inner2[0].end.x,inner2[0].end.y]);inner2[0].curveToReversed(borderArgs)}else{borderArgs.push(["line",borderData.c2[0],borderData.c2[1]]);borderArgs.push(["line",borderData.c3[0],borderData.c3[1]])}if(radius1[0]>0||radius1[1]>0){borderArgs.push(["line",inner1[1].end.x,inner1[1].end.y]);inner1[1].curveToReversed(borderArgs)}else{borderArgs.push(["line",borderData.c4[0],borderData.c4[1]])}return borderArgs}function calculateCurvePoints(bounds,borderRadius,borders){var x=bounds.left,y=bounds.top,width=bounds.width,height=bounds.height,tlh=borderRadius[0][0],tlv=borderRadius[0][1],trh=borderRadius[1][0],trv=borderRadius[1][1],brh=borderRadius[2][0],brv=borderRadius[2][1],blh=borderRadius[3][0],blv=borderRadius[3][1],topWidth=width-trh,rightHeight=height-brv,bottomWidth=width-brh,leftHeight=height-blv;return{topLeftOuter:getCurvePoints(x,y,tlh,tlv).topLeft.subdivide(0.5),topLeftInner:getCurvePoints(x+borders[3].width,y+borders[0].width,Math.max(0,tlh-borders[3].width),Math.max(0,tlv-borders[0].width)).topLeft.subdivide(0.5),topRightOuter:getCurvePoints(x+topWidth,y,trh,trv).topRight.subdivide(0.5),topRightInner:getCurvePoints(x+Math.min(topWidth,width+borders[3].width),y+borders[0].width,(topWidth>width+borders[3].width)?0:trh-borders[3].width,trv-borders[0].width).topRight.subdivide(0.5),bottomRightOuter:getCurvePoints(x+bottomWidth,y+rightHeight,brh,brv).bottomRight.subdivide(0.5),bottomRightInner:getCurvePoints(x+Math.min(bottomWidth,width+borders[3].width),y+Math.min(rightHeight,height+borders[0].width),Math.max(0,brh-borders[1].width),Math.max(0,brv-borders[2].width)).bottomRight.subdivide(0.5),bottomLeftOuter:getCurvePoints(x,y+leftHeight,blh,blv).bottomLeft.subdivide(0.5),bottomLeftInner:getCurvePoints(x+borders[3].width,y+leftHeight,Math.max(0,blh-borders[3].width),Math.max(0,blv-borders[2].width)).bottomLeft.subdivide(0.5)}}function getBorderClip(element,borderPoints,borders,radius,bounds){var backgroundClip=getCSS(element,"backgroundClip"),borderArgs=[];switch(backgroundClip){case"content-box":case"padding-box":parseCorner(borderArgs,radius[0],radius[1],borderPoints.topLeftInner,borderPoints.topRightInner,bounds.left+borders[3].width,bounds.top+borders[0].width);parseCorner(borderArgs,radius[1],radius[2],borderPoints.topRightInner,borderPoints.bottomRightInner,bounds.left+bounds.width-borders[1].width,bounds.top+borders[0].width);parseCorner(borderArgs,radius[2],radius[3],borderPoints.bottomRightInner,borderPoints.bottomLeftInner,bounds.left+bounds.width-borders[1].width,bounds.top+bounds.height-borders[2].width);parseCorner(borderArgs,radius[3],radius[0],borderPoints.bottomLeftInner,borderPoints.topLeftInner,bounds.left+borders[3].width,bounds.top+bounds.height-borders[2].width);break;default:parseCorner(borderArgs,radius[0],radius[1],borderPoints.topLeftOuter,borderPoints.topRightOuter,bounds.left,bounds.top);parseCorner(borderArgs,radius[1],radius[2],borderPoints.topRightOuter,borderPoints.bottomRightOuter,bounds.left+bounds.width,bounds.top);parseCorner(borderArgs,radius[2],radius[3],borderPoints.bottomRightOuter,borderPoints.bottomLeftOuter,bounds.left+bounds.width,bounds.top+bounds.height);parseCorner(borderArgs,radius[3],radius[0],borderPoints.bottomLeftOuter,borderPoints.topLeftOuter,bounds.left,bounds.top+bounds.height);break}return borderArgs}function parseBorders(element,bounds,borders){if(_html2canvas.options.gliffyOpt&&_html2canvas.options.doShapeOpt){return}var x=bounds.left,y=bounds.top,width=bounds.width,height=bounds.height,borderSide,bx,by,bw,bh,borderArgs,borderRadius=getBorderRadiusData(element),borderPoints=calculateCurvePoints(bounds,borderRadius,borders),borderData={clip:getBorderClip(element,borderPoints,borders,borderRadius,bounds),borders:[]};for(borderSide=0;borderSide<4;borderSide++){if(borders[borderSide].width>0){bx=x;by=y;bw=width;bh=height-(borders[2].width);switch(borderSide){case 0:bh=borders[0].width;borderArgs=drawSide({c1:[bx,by],c2:[bx+bw,by],c3:[bx+bw-borders[1].width,by+bh],c4:[bx+borders[3].width,by+bh]},borderRadius[0],borderRadius[1],borderPoints.topLeftOuter,borderPoints.topLeftInner,borderPoints.topRightOuter,borderPoints.topRightInner);break;case 1:bx=x+width-(borders[1].width);bw=borders[1].width;borderArgs=drawSide({c1:[bx+bw,by],c2:[bx+bw,by+bh+borders[2].width],c3:[bx,by+bh],c4:[bx,by+borders[0].width]},borderRadius[1],borderRadius[2],borderPoints.topRightOuter,borderPoints.topRightInner,borderPoints.bottomRightOuter,borderPoints.bottomRightInner);break;case 2:by=(by+height)-(borders[2].width);bh=borders[2].width;borderArgs=drawSide({c1:[bx+bw,by+bh],c2:[bx,by+bh],c3:[bx+borders[3].width,by],c4:[bx+bw-borders[3].width,by]},borderRadius[2],borderRadius[3],borderPoints.bottomRightOuter,borderPoints.bottomRightInner,borderPoints.bottomLeftOuter,borderPoints.bottomLeftInner);break;case 3:bw=borders[3].width;borderArgs=drawSide({c1:[bx,by+bh+borders[2].width],c2:[bx,by],c3:[bx+bw,by+borders[0].width],c4:[bx+bw,by+bh]},borderRadius[3],borderRadius[0],borderPoints.bottomLeftOuter,borderPoints.bottomLeftInner,borderPoints.topLeftOuter,borderPoints.topLeftInner);break}borderData.borders.push({args:borderArgs,color:borders[borderSide].color})}}return borderData}function createShape(ctx,args){var shape=ctx.drawShape();args.forEach(function(border,index){shape[(index===0)?"moveTo":border[0]+"To"].apply(null,border.slice(1))});return shape}function renderBorders(ctx,borderArgs,color){if(color!=="transparent"){ctx.setVariable("fillStyle",color);createShape(ctx,borderArgs);ctx.fill();numDraws+=1}}function renderFormValue(el,bounds,stack){var valueWrap=doc.createElement("valuewrap"),cssPropertyArray=["lineHeight","textAlign","fontFamily","color","fontSize","paddingLeft","paddingTop","width","height","border","borderLeftWidth","borderTopWidth"],textValue,textNode;cssPropertyArray.forEach(function(property){try{valueWrap.style[property]=getCSS(el,property)}catch(e){Util.log("html2canvas: Parse: Exception caught in renderFormValue: "+e.message)}});valueWrap.style.borderColor="black";valueWrap.style.borderStyle="solid";valueWrap.style.display="block";valueWrap.style.position="absolute";if(/^(submit|reset|button|text|password)$/.test(el.type)||el.nodeName==="SELECT"){valueWrap.style.lineHeight=getCSS(el,"height")}valueWrap.style.top=bounds.top+"px";valueWrap.style.left=bounds.left+"px";textValue=(el.nodeName==="SELECT")?(el.options[el.selectedIndex]||0).text:el.value;if(!textValue){textValue=el.placeholder}textNode=doc.createTextNode(textValue);valueWrap.appendChild(textNode);body.appendChild(valueWrap);renderText(el,textNode,stack);body.removeChild(valueWrap)}function drawImage(ctx){ctx.drawImage.apply(ctx,Array.prototype.slice.call(arguments,1));numDraws+=1}function getPseudoElement(el,which){var elStyle=window.getComputedStyle(el,which);if(!elStyle||!elStyle.content||elStyle.content==="none"||elStyle.content==="-moz-alt-content"||elStyle.display==="none"){return}var content=elStyle.content+"",first=content.substr(0,1);if(first===content.substr(content.length-1)&&first.match(/'|"/)){content=content.substr(1,content.length-2)}var isImage=content.substr(0,3)==="url",elps=document.createElement(isImage?"img":"span");elps.className=pseudoHide+"-before "+pseudoHide+"-after";Object.keys(elStyle).filter(indexedProperty).forEach(function(prop){try{elps.style[prop]=elStyle[prop]}catch(e){Util.log(["Tried to assign readonly property ",prop,"Error:",e])}});if(isImage){elps.src=Util.parseBackgroundImage(content)[0].args[0]}else{elps.innerHTML=content}return elps}function indexedProperty(property){return(isNaN(window.parseInt(property,10)))}function injectPseudoElements(el,stack){var before=getPseudoElement(el,":before"),after=getPseudoElement(el,":after");if(!before&&!after){return}if(before){el.className+=" "+pseudoHide+"-before";el.parentNode.insertBefore(before,el);parseElement(before,stack,true);el.parentNode.removeChild(before);el.className=el.className.replace(pseudoHide+"-before","").trim()}if(after){el.className+=" "+pseudoHide+"-after";el.appendChild(after);parseElement(after,stack,true);el.removeChild(after);el.className=el.className.replace(pseudoHide+"-after","").trim()}}function renderBackgroundRepeat(ctx,image,backgroundPosition,bounds){var offsetX=Math.round(bounds.left+backgroundPosition.left),offsetY=Math.round(bounds.top+backgroundPosition.top);ctx.createPattern(image);ctx.translate(offsetX,offsetY);ctx.fill();ctx.translate(-offsetX,-offsetY)}function backgroundRepeatShape(ctx,image,backgroundPosition,bounds,left,top,width,height){var args=[];args.push(["line",Math.round(left),Math.round(top)]);args.push(["line",Math.round(left+width),Math.round(top)]);args.push(["line",Math.round(left+width),Math.round(height+top)]);args.push(["line",Math.round(left),Math.round(height+top)]);createShape(ctx,args);ctx.save();ctx.clip();renderBackgroundRepeat(ctx,image,backgroundPosition,bounds);ctx.restore()}function renderBackgroundColor(ctx,backgroundBounds,bgcolor){renderRect(ctx,backgroundBounds.left,backgroundBounds.top,backgroundBounds.width,backgroundBounds.height,bgcolor)}function renderBackgroundRepeating(el,bounds,ctx,image,imageIndex){var backgroundSize=Util.BackgroundSize(el,bounds,image,imageIndex),backgroundPosition=Util.BackgroundPosition(el,bounds,image,imageIndex,backgroundSize),backgroundRepeat=getCSS(el,"backgroundRepeat").split(",").map(Util.trimText);image=resizeImage(image,backgroundSize);backgroundRepeat=backgroundRepeat[imageIndex]||backgroundRepeat[0];switch(backgroundRepeat){case"repeat-x":backgroundRepeatShape(ctx,image,backgroundPosition,bounds,bounds.left,bounds.top+backgroundPosition.top,99999,image.height);break;case"repeat-y":backgroundRepeatShape(ctx,image,backgroundPosition,bounds,bounds.left+backgroundPosition.left,bounds.top,image.width,99999);break;case"no-repeat":backgroundRepeatShape(ctx,image,backgroundPosition,bounds,bounds.left+backgroundPosition.left,bounds.top+backgroundPosition.top,image.width,image.height);break;default:renderBackgroundRepeat(ctx,image,backgroundPosition,{top:bounds.top,left:bounds.left,width:image.width,height:image.height});break}}function renderBackgroundImage(element,bounds,ctx){var backgroundImage=getCSS(element,"backgroundImage"),backgroundImages=Util.parseBackgroundImage(backgroundImage),image,imageIndex=backgroundImages.length;while(imageIndex--){backgroundImage=backgroundImages[imageIndex];if(!backgroundImage.args||backgroundImage.args.length===0){continue}var key=backgroundImage.method==="url"?backgroundImage.args[0]:backgroundImage.value;image=loadImage(key);if(image){renderBackgroundRepeating(element,bounds,ctx,image,imageIndex)}else{Util.log("html2canvas: Error loading background:",backgroundImage)}}}function resizeImage(image,bounds){if(image.width===bounds.width&&image.height===bounds.height){return image}var ctx,canvas=doc.createElement("canvas");canvas.width=bounds.width;canvas.height=bounds.height;ctx=canvas.getContext("2d");drawImage(ctx,image,0,0,image.width,image.height,0,0,bounds.width,bounds.height);return canvas}function setOpacity(ctx,element,parentStack){if(_html2canvas.options.gliffyOpt){return 1}return ctx.setVariable("globalAlpha",getCSS(element,"opacity")*((parentStack)?parentStack.opacity:1))}function removePx(str){return str.replace("px","")}var transformRegExp=/(matrix)\((.+)\)/;function concatMatrices(matrix1,matrix2){var matrixA={m00_:matrix1[0],m10_:matrix1[1],m01_:matrix1[2],m11_:matrix1[3],m02_:matrix1[4],m12_:matrix1[5]};var matrixB={m00_:matrix2[0],m10_:matrix2[1],m01_:matrix2[2],m11_:matrix2[3],m02_:matrix2[4],m12_:matrix2[5]};var m0=matrixA.m00_;var m1=matrixA.m01_;matrixA.m00_=matrixB.m00_*m0+matrixB.m10_*m1;matrixA.m01_=matrixB.m01_*m0+matrixB.m11_*m1;matrixA.m02_+=matrixB.m02_*m0+matrixB.m12_*m1;m0=matrixA.m10_;m1=matrixA.m11_;matrixA.m10_=matrixB.m00_*m0+matrixB.m10_*m1;matrixA.m11_=matrixB.m01_*m0+matrixB.m11_*m1;matrixA.m12_+=matrixB.m02_*m0+matrixB.m12_*m1;return[matrixA.m00_,matrixA.m10_,matrixA.m01_,matrixA.m11_,matrixA.m02_,matrixA.m12_]}function getTransform(element,parentStack){var transform=getCSS(element,"transform")||getCSS(element,"-webkit-transform")||getCSS(element,"-moz-transform")||getCSS(element,"-ms-transform")||getCSS(element,"-o-transform");var transformOrigin=getCSS(element,"transform-origin")||getCSS(element,"-webkit-transform-origin")||getCSS(element,"-moz-transform-origin")||getCSS(element,"-ms-transform-origin")||getCSS(element,"-o-transform-origin")||"0px 0px";transformOrigin=transformOrigin.split(" ").map(removePx).map(Util.asFloat);var matrix;if(transform&&transform!=="none"){var match=transform.match(transformRegExp);if(match){switch(match[1]){case"matrix":matrix=match[2].split(",").map(Util.trimText).map(Util.asFloat);break}}}if(parentStack&&parentStack.transform){if(matrix){matrix=concatMatrices(matrix,parentStack.transform.matrix)}else{matrix=parentStack.transform.matrix}if(transformOrigin){transformOrigin=parentStack.transform.origin}else{transformOrigin=parentStack.transform.origin}}return{origin:transformOrigin,matrix:matrix}}function createStack(element,parentStack,bounds,transform){var ctx=h2cRenderContext((!parentStack)?documentWidth():bounds.width,(!parentStack)?documentHeight():bounds.height),stack={ctx:ctx,opacity:setOpacity(ctx,element,parentStack),cssPosition:getCSS(element,"position"),borders:getBorderData(element),transform:transform,clip:(parentStack&&parentStack.clip)?Util.Extend({},parentStack.clip):null};setZ(element,stack,parentStack);if(options.useOverflow===true&&/(hidden|scroll|auto)/.test(getCSS(element,"overflow"))===true&&/(BODY)/i.test(element.nodeName)===false){stack.clip=(stack.clip)?clipBounds(stack.clip,bounds):bounds}return stack}function getBackgroundBounds(borders,bounds,clip){var backgroundBounds={left:bounds.left+borders[3].width,top:bounds.top+borders[0].width,width:bounds.width-(borders[1].width+borders[3].width),height:bounds.height-(borders[0].width+borders[2].width)};if(clip){backgroundBounds=clipBounds(backgroundBounds,clip)}return backgroundBounds}function getBounds(element,transform){var bounds=(transform.matrix)?Util.OffsetBounds(element):Util.Bounds(element);transform.origin[0]+=bounds.left;transform.origin[1]+=bounds.top;return bounds}function renderElement(element,parentStack,pseudoElement,ignoreBackground){var transform={matrix:null,origin:[0,0]},bounds=getBounds(element,transform),image,stack=createStack(element,parentStack,bounds,transform),borders=stack.borders,ctx=stack.ctx,backgroundBounds=getBackgroundBounds(borders,bounds,stack.clip),borderData=parseBorders(element,bounds,borders),backgroundColor=(ignoreElementsRegExp.test(element.nodeName))?"#efefef":getCSS(element,"backgroundColor");if(!_html2canvas.options.gliffyOpt||!_html2canvas.options.doShapeOpt){createShape(ctx,borderData.clip)}ctx.save();if(_html2canvas.options.clipBackgroundColor){ctx.clip()}if(backgroundBounds.height>0&&backgroundBounds.width>0&&!ignoreBackground){renderBackgroundColor(ctx,bounds,backgroundColor);renderBackgroundImage(element,backgroundBounds,ctx)}else{if(ignoreBackground){stack.backgroundColor=backgroundColor}}ctx.restore();if(!_html2canvas.options.gliffyOpt){borderData.borders.forEach(function(border){renderBorders(ctx,border.args,border.color)})}if(!pseudoElement){injectPseudoElements(element,stack)}switch(element.nodeName){case"IMG":if((image=loadImage(element.getAttribute("src")))){renderImage(ctx,element,image,bounds,borders)}else{Util.log("html2canvas: Error loading <img>:"+element.getAttribute("src"))}break;case"INPUT":if(/^(text|url|email|submit|button|reset)$/.test(element.type)&&(element.value||element.placeholder||"").length>0){renderFormValue(element,bounds,stack)}break;case"TEXTAREA":if((element.value||element.placeholder||"").length>0){renderFormValue(element,bounds,stack)}break;case"SELECT":if((element.options||element.placeholder||"").length>0){renderFormValue(element,bounds,stack)}break;case"LI":renderListItem(element,stack,backgroundBounds);break;case"CANVAS":renderImage(ctx,element,element,bounds,borders);break}return stack}function isElementVisible(element){return(getCSS(element,"display")!=="none"&&getCSS(element,"visibility")!=="hidden"&&!element.hasAttribute("data-html2canvas-ignore"))}function parseElement(element,stack,pseudoElement){if(isElementVisible(element)){stack=renderElement(element,stack,pseudoElement,false)||stack;if(!ignoreElementsRegExp.test(element.nodeName)){parseChildren(element,stack,pseudoElement)}}}function parseChildren(element,stack,pseudoElement){Util.Children(element).forEach(function(node){if(node.nodeType===node.ELEMENT_NODE){parseElement(node,stack,pseudoElement)}else{if(node.nodeType===node.TEXT_NODE){renderText(element,node,stack)}}})}function init(){var background=getCSS(document.documentElement,"backgroundColor"),transparentBackground=(Util.isTransparent(background)&&element===document.body),stack=renderElement(element,null,false,transparentBackground);parseChildren(element,stack);if(transparentBackground){background=stack.backgroundColor}body.removeChild(hidePseudoElements);return{backgroundColor:background,stack:stack}}return init()};function h2czContext(zindex){return{zindex:zindex,children:[]}}_html2canvas.Preload=function(options){var images={numLoaded:0,numFailed:0,numTotal:0,cleanupDone:false},pageOrigin,Util=_html2canvas.Util,methods,i,count=0,element=options.elements[0]||document.body,doc=element.ownerDocument,domImages=element.getElementsByTagName("img"),imgLen=domImages.length,link=doc.createElement("a"),supportCORS=(function(img){return(img.crossOrigin!==undefined)})(new Image()),timeoutTimer;link.href=window.location.href;pageOrigin=link.protocol+link.host;function isSameOrigin(url){link.href=url;link.href=link.href;var origin=link.protocol+link.host;return(origin===pageOrigin)}function start(){Util.log("html2canvas: start: images: "+images.numLoaded+" / "+images.numTotal+" (failed: "+images.numFailed+")");if(!images.firstRun&&images.numLoaded>=images.numTotal){Util.log("Finished loading images: # "+images.numTotal+" (failed: "+images.numFailed+")");if(typeof options.complete==="function"){options.complete(images)}}}function proxyGetImage(url,img,imageObj){var callback_name,scriptUrl=options.proxy,script;link.href=url;url=link.href;callback_name="html2canvas_"+(count++);imageObj.callbackname=callback_name;if(scriptUrl.indexOf("?")>-1){scriptUrl+="&"}else{scriptUrl+="?"}scriptUrl+="url="+encodeURIComponent(url)+"&callback="+callback_name;script=doc.createElement("script");window[callback_name]=function(a){if(a.substring(0,6)==="error:"){imageObj.succeeded=false;images.numLoaded++;images.numFailed++;start()}else{setImageLoadHandlers(img,imageObj);img.src=a}window[callback_name]=undefined;try{delete window[callback_name]}catch(ex){}script.parentNode.removeChild(script);script=null;delete imageObj.script;delete imageObj.callbackname};script.setAttribute("type","text/javascript");script.setAttribute("src",scriptUrl);imageObj.script=script;window.document.body.appendChild(script)}function loadPseudoElement(element,type){var style=window.getComputedStyle(element,type),content=style.content;if(content.substr(0,3)==="url"){methods.loadImage(_html2canvas.Util.parseBackgroundImage(content)[0].args[0])}loadBackgroundImages(style.backgroundImage,element)}function loadPseudoElementImages(element){loadPseudoElement(element,":before");loadPseudoElement(element,":after")}function loadGradientImage(backgroundImage,bounds){var img=_html2canvas.Generate.Gradient(backgroundImage,bounds);if(img!==undefined){images[backgroundImage]={img:img,succeeded:true};images.numTotal++;images.numLoaded++;start()}}function invalidBackgrounds(background_image){return(background_image&&background_image.method&&background_image.args&&background_image.args.length>0)}function loadBackgroundImages(background_image,el){var bounds;_html2canvas.Util.parseBackgroundImage(background_image).filter(invalidBackgrounds).forEach(function(background_image){if(background_image.method==="url"){methods.loadImage(background_image.args[0])}else{if(background_image.method.match(/\-?gradient$/)){if(bounds===undefined){bounds=_html2canvas.Util.Bounds(el)}loadGradientImage(background_image.value,bounds)}}})}function getImages(el){var elNodeType=false;if(_html2canvas.options.gliffyOpt){return}try{Util.Children(el).forEach(getImages)}catch(e){}try{elNodeType=el.nodeType}catch(ex){elNodeType=false;Util.log("html2canvas: failed to access some element's nodeType - Exception: "+ex.message)}if(elNodeType===1||elNodeType===undefined){loadPseudoElementImages(el);try{loadBackgroundImages(Util.getCSS(el,"backgroundImage"),el)}catch(e){Util.log("html2canvas: failed to get background-image - Exception: "+e.message)}loadBackgroundImages(el)}}function setImageLoadHandlers(img,imageObj){img.onload=function(){if(imageObj.timer!==undefined){window.clearTimeout(imageObj.timer)}images.numLoaded++;imageObj.succeeded=true;img.onerror=img.onload=null;start()};img.onerror=function(){if(img.crossOrigin==="anonymous"){window.clearTimeout(imageObj.timer);if(options.proxy){var src=img.src;img=new Image();imageObj.img=img;img.src=src;proxyGetImage(img.src,img,imageObj);return}}images.numLoaded++;images.numFailed++;imageObj.succeeded=false;img.onerror=img.onload=null;start()}}methods={loadImage:function(src){var img,imageObj;if(src&&images[src]===undefined){img=new Image();if(src.match(/data:image\/.*;base64,/i)){img.src=src.replace(/url\(['"]{0,}|['"]{0,}\)$/ig,"");imageObj=images[src]={img:img};images.numTotal++;setImageLoadHandlers(img,imageObj)}else{if(isSameOrigin(src)||options.allowTaint===true){imageObj=images[src]={img:img};images.numTotal++;setImageLoadHandlers(img,imageObj);img.src=src}else{if(supportCORS&&!options.allowTaint&&options.useCORS){img.crossOrigin="anonymous";imageObj=images[src]={img:img};images.numTotal++;setImageLoadHandlers(img,imageObj);img.src=src}else{if(options.proxy){imageObj=images[src]={img:img};images.numTotal++;proxyGetImage(src,img,imageObj)}}}}}},cleanupDOM:function(cause){var img,src;if(!images.cleanupDone){if(cause&&typeof cause==="string"){Util.log("html2canvas: Cleanup because: "+cause)}else{Util.log("html2canvas: Cleanup after timeout: "+options.timeout+" ms.")}for(src in images){if(images.hasOwnProperty(src)){img=images[src];if(typeof img==="object"&&img.callbackname&&img.succeeded===undefined){window[img.callbackname]=undefined;try{delete window[img.callbackname]}catch(ex){}if(img.script&&img.script.parentNode){img.script.setAttribute("src","about:blank");img.script.parentNode.removeChild(img.script)}images.numLoaded++;images.numFailed++;Util.log("html2canvas: Cleaned up failed img: '"+src+"' Steps: "+images.numLoaded+" / "+images.numTotal)}}}if(window.stop!==undefined){window.stop()}else{if(document.execCommand!==undefined){document.execCommand("Stop",false)}}if(document.close!==undefined){document.close()}images.cleanupDone=true;if(!(cause&&typeof cause==="string")){start()}}},renderingDone:function(){if(timeoutTimer){window.clearTimeout(timeoutTimer)}}};if(options.timeout>0){timeoutTimer=window.setTimeout(methods.cleanupDOM,options.timeout)}Util.log("html2canvas: Preload starts: finding background-images");images.firstRun=true;getImages(element);Util.log("html2canvas: Preload: Finding images");for(i=0;i<imgLen;i+=1){methods.loadImage(domImages[i].getAttribute("src"))}images.firstRun=false;Util.log("html2canvas: Preload: Done.");if(images.numTotal===images.numLoaded){start()}return methods};_html2canvas.Renderer=function(parseQueue,options){function createRenderQueue(parseQueue){var queue=[],rootContext;rootContext=(function buildStackingContext(rootNode){var rootContext={};function insert(context,node,specialParent){var zi=(node.zIndex.zindex==="auto")?0:Number(node.zIndex.zindex),contextForChildren=context,isPositioned=node.zIndex.isPositioned,isFloated=node.zIndex.isFloated,stub={node:node},childrenDest=specialParent;if(node.zIndex.ownStacking){contextForChildren=stub.context={"!":[{node:node,children:[]}]};childrenDest=undefined}else{if(isPositioned||isFloated){childrenDest=stub.children=[]}}if(zi===0&&specialParent){specialParent.push(stub)}else{if(!context[zi]){context[zi]=[]}context[zi].push(stub)}node.zIndex.children.forEach(function(childNode){insert(contextForChildren,childNode,childrenDest)})}insert(rootContext,rootNode);return rootContext})(parseQueue);function sortZ(context){Object.keys(context).sort().forEach(function(zi){var nonPositioned=[],floated=[],positioned=[],list=[];context[zi].forEach(function(v){if(v.node.zIndex.isPositioned||v.node.zIndex.opacity<1){positioned.push(v)}else{if(v.node.zIndex.isFloated){floated.push(v)}else{nonPositioned.push(v)}}});(function walk(arr){arr.forEach(function(v){list.push(v);if(v.children){walk(v.children)}})})(nonPositioned.concat(floated,positioned));list.forEach(function(v){if(v.context){sortZ(v.context)}else{queue.push(v.node)}})})}sortZ(rootContext);return queue}function getRenderer(rendererName){var renderer;if(typeof options.renderer==="string"&&_html2canvas.Renderer[rendererName]!==undefined){renderer=_html2canvas.Renderer[rendererName](options)}else{if(typeof rendererName==="function"){renderer=rendererName(options)}else{throw new Error("Unknown renderer")}}if(typeof renderer!=="function"){throw new Error("Invalid renderer defined")}return renderer}return getRenderer(options.renderer)(parseQueue,options,document,createRenderQueue(parseQueue.stack),_html2canvas)};_html2canvas.Util.Support=function(options,doc){function supportSVGRendering(){var img=new Image(),canvas=doc.createElement("canvas"),ctx=(canvas.getContext===undefined)?false:canvas.getContext("2d");if(ctx===false){return false}canvas.width=canvas.height=10;img.src=["data:image/svg+xml,","<svg xmlns='http://www.w3.org/2000/svg' width='10' height='10'>","<foreignObject width='10' height='10'>","<div xmlns='http://www.w3.org/1999/xhtml' style='width:10;height:10;'>","sup","</div>","</foreignObject>","</svg>"].join("");try{ctx.drawImage(img,0,0);canvas.toDataURL()}catch(e){return false}_html2canvas.Util.log("html2canvas: Parse: SVG powered rendering available");return true}function supportRangeBounds(){var r,testElement,rangeBounds,rangeHeight,support=false;if(_html2canvas.options.gliffyOpt){return true}if(doc.createRange){r=doc.createRange();if(r.getBoundingClientRect){testElement=doc.createElement("boundtest");testElement.style.height="123px";testElement.style.display="block";doc.body.appendChild(testElement);r.selectNode(testElement);rangeBounds=r.getBoundingClientRect();rangeHeight=rangeBounds.height;if(rangeHeight===123){support=true}doc.body.removeChild(testElement)}}return support}return{rangeBounds:supportRangeBounds(),svgRendering:options.svgRendering&&supportSVGRendering()}};window.html2canvasClearCache=function(){_html2canvas.cachedWidth=null,_html2canvas.cachedHeight=null};window.html2canvas=function(elements,opts){elements=(elements.length)?elements:[elements];var queue,canvas,options={logging:false,elements:elements,background:"#fff",proxy:null,timeout:0,useCORS:false,allowTaint:false,gliffyOpt:false,doShapeOpt:false,svgRendering:false,ignoreElements:"IFRAME|OBJECT|PARAM",useOverflow:true,letterRendering:false,chinese:false,clipBackgroundColor:true,async:true,width:null,height:null,resizeCanvas:true,taintTest:true,renderer:"Canvas"};options=_html2canvas.Util.Extend(opts,options);if(options.gliffyOpt){_html2canvas.Util.getCSS=_html2canvas.Util.getCSSGliffy}else{_html2canvas.Util.getCSS=_html2canvas.Util.getCSSH2C}_html2canvas.options=options;_html2canvas.logging=options.logging;options.complete=function(images){if(typeof options.onpreloaded==="function"){if(options.onpreloaded(images)===false){return}}queue=_html2canvas.Parse(images,options);if(typeof options.onparsed==="function"){if(options.onparsed(queue)===false){return}}canvas=_html2canvas.Renderer(queue,options);if(typeof options.onrendered==="function"){options.onrendered(canvas)}};if(options.async){window.setTimeout(function(){_html2canvas.Preload(options)},0)}else{_html2canvas.Preload(options)}return{render:function(queue,opts){return _html2canvas.Renderer(queue,_html2canvas.Util.Extend(opts,options))},parse:function(images,opts){return _html2canvas.Parse(images,_html2canvas.Util.Extend(opts,options))},preload:function(opts){return _html2canvas.Preload(_html2canvas.Util.Extend(opts,options))},log:_html2canvas.Util.log}};window.html2canvas.log=_html2canvas.Util.log;window.html2canvas.Renderer={Canvas:undefined};_html2canvas.Renderer.Canvas=function(options){options=options||{};var doc=document,safeImages=[],testCanvas=document.createElement("canvas"),testctx=testCanvas.getContext("2d"),Util=_html2canvas.Util,canvas=options.canvas||doc.createElement("canvas");function createShape(ctx,args){ctx.beginPath();args.forEach(function(arg){ctx[arg.name].apply(ctx,arg["arguments"])});ctx.closePath()}function safeImage(item){if(safeImages.indexOf(item["arguments"][0].src)===-1){testctx.drawImage(item["arguments"][0],0,0);try{testctx.getImageData(0,0,1,1)}catch(e){testCanvas=doc.createElement("canvas");testctx=testCanvas.getContext("2d");return false}safeImages.push(item["arguments"][0].src)}return true}function renderItem(ctx,item){switch(item.type){case"variable":ctx[item.name]=item["arguments"];break;case"function":switch(item.name){case"createPattern":if(item["arguments"][0].width>0&&item["arguments"][0].height>0){try{ctx.fillStyle=ctx.createPattern(item["arguments"][0],"repeat")}catch(e){Util.log("html2canvas: Renderer: Error creating pattern",e.message)}}break;case"drawShape":createShape(ctx,item["arguments"]);break;case"drawImage":if(item["arguments"][8]>0&&item["arguments"][7]>0){if(!options.taintTest||(options.taintTest&&safeImage(item))){ctx.drawImage.apply(ctx,item["arguments"])}}break;default:ctx[item.name].apply(ctx,item["arguments"])}break}}return function(parsedData,options,document,queue,_html2canvas){var ctx=canvas.getContext?canvas.getContext("2d"):canvas,newCanvas,bounds,fstyle,zStack=parsedData.stack,imgData,i;if(!options.resizeCanvas&&canvas.getContext){canvas.width=canvas.style.width=options.width||zStack.ctx.width;canvas.height=canvas.style.height=options.height||zStack.ctx.height}fstyle=ctx.fillStyle;ctx.fillStyle=(Util.isTransparent(zStack.backgroundColor)&&options.background!==undefined)?options.background:parsedData.backgroundColor;if(!options.resizeCanvas&&canvas.getContext){ctx.fillRect(0,0,canvas.width,canvas.height)}ctx.fillStyle=fstyle;queue.forEach(function(storageContext){ctx.textBaseline="bottom";ctx.save();if(storageContext.transform.matrix){ctx.translate(storageContext.transform.origin[0],storageContext.transform.origin[1]);ctx.transform.apply(ctx,storageContext.transform.matrix);ctx.translate(-storageContext.transform.origin[0],-storageContext.transform.origin[1])}if(storageContext.clip){ctx.beginPath();ctx.rect(storageContext.clip.left,storageContext.clip.top,storageContext.clip.width,storageContext.clip.height);ctx.clip()}if(storageContext.ctx.storage){storageContext.ctx.storage.forEach(function(item){renderItem(ctx,item)})}ctx.restore()});for(i=0;i<cachedRectElements.length;i++){delete cachedRectElements[i].clientRect}Util.log("html2canvas: Renderer: Canvas renderer done - returning canvas obj");return canvas}}})(window,document);
/*!!
 *  Canvas 2 Svg v1.0.4
 *  A low level canvas to SVG converter. Uses a mock canvas context to build an SVG document.
 *
 *  Licensed under the MIT license:
 *  http://www.opensource.org/licenses/mit-license.php
 *
 *  Author:
 *  Kerry Liu
 *
 *  Copyright (c) 2014 Gliffy Inc.
 */
(function(){var STYLES,ctx,CanvasGradient,CanvasPattern,namedEntities;function format(str,args){var keys=Object.keys(args),i;for(i=0;i<keys.length;i++){str=str.replace(new RegExp("\\{"+keys[i]+"\\}","gi"),args[keys[i]])}return str}function randomString(holder){var chars,randomstring,i;if(!holder){throw new Error("cannot create a random attribute name for an undefined object")}chars="ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";randomstring="";do{randomstring="";for(i=0;i<12;i++){randomstring+=chars[Math.floor(Math.random()*chars.length)]}}while(holder[randomstring]);return randomstring}function createNamedToNumberedLookup(items,radix){var i,entity,lookup={},base10,base16;items=items.split(",");radix=radix||10;for(i=0;i<items.length;i+=2){entity="&"+items[i+1]+";";base10=parseInt(items[i],radix);lookup[entity]="&#"+base10+";"}lookup["\\xa0"]="&#160;";return lookup}namedEntities=createNamedToNumberedLookup("50,nbsp,51,iexcl,52,cent,53,pound,54,curren,55,yen,56,brvbar,57,sect,58,uml,59,copy,5a,ordf,5b,laquo,5c,not,5d,shy,5e,reg,5f,macr,5g,deg,5h,plusmn,5i,sup2,5j,sup3,5k,acute,5l,micro,5m,para,5n,middot,5o,cedil,5p,sup1,5q,ordm,5r,raquo,5s,frac14,5t,frac12,5u,frac34,5v,iquest,60,Agrave,61,Aacute,62,Acirc,63,Atilde,64,Auml,65,Aring,66,AElig,67,Ccedil,68,Egrave,69,Eacute,6a,Ecirc,6b,Euml,6c,Igrave,6d,Iacute,6e,Icirc,6f,Iuml,6g,ETH,6h,Ntilde,6i,Ograve,6j,Oacute,6k,Ocirc,6l,Otilde,6m,Ouml,6n,times,6o,Oslash,6p,Ugrave,6q,Uacute,6r,Ucirc,6s,Uuml,6t,Yacute,6u,THORN,6v,szlig,70,agrave,71,aacute,72,acirc,73,atilde,74,auml,75,aring,76,aelig,77,ccedil,78,egrave,79,eacute,7a,ecirc,7b,euml,7c,igrave,7d,iacute,7e,icirc,7f,iuml,7g,eth,7h,ntilde,7i,ograve,7j,oacute,7k,ocirc,7l,otilde,7m,ouml,7n,divide,7o,oslash,7p,ugrave,7q,uacute,7r,ucirc,7s,uuml,7t,yacute,7u,thorn,7v,yuml,ci,fnof,sh,Alpha,si,Beta,sj,Gamma,sk,Delta,sl,Epsilon,sm,Zeta,sn,Eta,so,Theta,sp,Iota,sq,Kappa,sr,Lambda,ss,Mu,st,Nu,su,Xi,sv,Omicron,t0,Pi,t1,Rho,t3,Sigma,t4,Tau,t5,Upsilon,t6,Phi,t7,Chi,t8,Psi,t9,Omega,th,alpha,ti,beta,tj,gamma,tk,delta,tl,epsilon,tm,zeta,tn,eta,to,theta,tp,iota,tq,kappa,tr,lambda,ts,mu,tt,nu,tu,xi,tv,omicron,u0,pi,u1,rho,u2,sigmaf,u3,sigma,u4,tau,u5,upsilon,u6,phi,u7,chi,u8,psi,u9,omega,uh,thetasym,ui,upsih,um,piv,812,bull,816,hellip,81i,prime,81j,Prime,81u,oline,824,frasl,88o,weierp,88h,image,88s,real,892,trade,89l,alefsym,8cg,larr,8ch,uarr,8ci,rarr,8cj,darr,8ck,harr,8dl,crarr,8eg,lArr,8eh,uArr,8ei,rArr,8ej,dArr,8ek,hArr,8g0,forall,8g2,part,8g3,exist,8g5,empty,8g7,nabla,8g8,isin,8g9,notin,8gb,ni,8gf,prod,8gh,sum,8gi,minus,8gn,lowast,8gq,radic,8gt,prop,8gu,infin,8h0,ang,8h7,and,8h8,or,8h9,cap,8ha,cup,8hb,int,8hk,there4,8hs,sim,8i5,cong,8i8,asymp,8j0,ne,8j1,equiv,8j4,le,8j5,ge,8k2,sub,8k3,sup,8k4,nsub,8k6,sube,8k7,supe,8kl,oplus,8kn,otimes,8l5,perp,8m5,sdot,8o8,lceil,8o9,rceil,8oa,lfloor,8ob,rfloor,8p9,lang,8pa,rang,9ea,loz,9j0,spades,9j3,clubs,9j5,hearts,9j6,diams,ai,OElig,aj,oelig,b0,Scaron,b1,scaron,bo,Yuml,m6,circ,ms,tilde,802,ensp,803,emsp,809,thinsp,80c,zwnj,80d,zwj,80e,lrm,80f,rlm,80j,ndash,80k,mdash,80o,lsquo,80p,rsquo,80q,sbquo,80s,ldquo,80t,rdquo,80u,bdquo,810,dagger,811,Dagger,81g,permil,81p,lsaquo,81q,rsaquo,85c,euro",32);STYLES={strokeStyle:{svgAttr:"stroke",canvas:"#000000",svg:"none",apply:"stroke"},fillStyle:{svgAttr:"fill",canvas:"#000000",svg:null,apply:"fill"},lineCap:{svgAttr:"stroke-linecap",canvas:"butt",svg:"butt",apply:"stroke"},lineJoin:{svgAttr:"stroke-linejoin",canvas:"miter",svg:"miter",apply:"stroke"},miterLimit:{svgAttr:"stroke-miterlimit",canvas:10,svg:4,apply:"stroke"},lineWidth:{svgAttr:"stroke-width",canvas:1,svg:1,apply:"stroke"},globalAlpha:{svgAttr:"opacity",canvas:1,svg:1,apply:"fill stroke"},font:{canvas:"10px sans-serif"},shadowColor:{canvas:"#000000"},shadowOffsetX:{canvas:0},shadowOffsetY:{canvas:0},shadowBlur:{canvas:0},textAlign:{canvas:"start"},textBaseline:{canvas:"alphabetic"}};CanvasGradient=function(gradientNode){this.__root=gradientNode};CanvasGradient.prototype.addColorStop=function(offset,color){var stop=document.createElementNS("http://www.w3.org/2000/svg","stop"),regex,matches;stop.setAttribute("offset",offset);if(color.indexOf("rgba")!==-1){regex=/rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d?\.?\d*)\s*\)/gi;matches=regex.exec(color);stop.setAttribute("stop-color",format("rgb({r},{g},{b})",{r:matches[1],g:matches[2],b:matches[3]}));stop.setAttribute("stop-opacity",matches[4])}else{stop.setAttribute("stop-color",color)}this.__root.appendChild(stop)};CanvasPattern=function(pattern,ctx){this.__root=pattern;this.__ctx=ctx};ctx=function(o){var defaultOptions={width:500,height:500,enableMirroring:false},options;if(arguments.length>1){options=defaultOptions;options.width=arguments[0];options.height=arguments[1]}else{if(!o){options=defaultOptions}else{options=o}}if(!(this instanceof ctx)){return new ctx(options)}this.width=options.width||defaultOptions.width;this.height=options.height||defaultOptions.height;this.enableMirroring=options.enableMirroring!==undefined?options.enableMirroring:defaultOptions.enableMirroring;this.canvas=this;this.__canvas=document.createElement("canvas");this.__ctx=this.__canvas.getContext("2d");this.__setDefaultStyles();this.__stack=[this.__getStyleState()];this.__groupStack=[];this.__root=document.createElementNS("http://www.w3.org/2000/svg","svg");this.__root.setAttribute("version",1.1);this.__root.setAttribute("xmlns","http://www.w3.org/2000/svg");this.__root.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink");this.__root.setAttribute("width",this.width);this.__root.setAttribute("height",this.height);this.__ids={};this.__defs=document.createElementNS("http://www.w3.org/2000/svg","defs");this.__root.appendChild(this.__defs);this.__currentElement=document.createElementNS("http://www.w3.org/2000/svg","g");this.__root.appendChild(this.__currentElement)};ctx.prototype.__createElement=function(elementName,properties,resetFill){var element=document.createElementNS("http://www.w3.org/2000/svg",elementName),keys=Object.keys(properties),i,key;if(resetFill){element.setAttribute("fill","none");element.setAttribute("stroke","none")}for(i=0;i<keys.length;i++){key=keys[i];element.setAttribute(key,properties[key])}return element};ctx.prototype.__setDefaultStyles=function(){var keys=Object.keys(STYLES),i,key;for(i=0;i<keys.length;i++){key=keys[i];this[key]=STYLES[key].canvas}};ctx.prototype.__applyStyleState=function(styleState){var keys=Object.keys(styleState),i,key;for(i=0;i<keys.length;i++){key=keys[i];this[key]=styleState[key]}};ctx.prototype.__getStyleState=function(){var i,styleState={},keys=Object.keys(STYLES),key;for(i=0;i<keys.length;i++){key=keys[i];styleState[key]=this[key]}return styleState};ctx.prototype.__applyStyleToCurrentElement=function(type){var keys=Object.keys(STYLES),i,j,element,style,value,id,regex,matches;for(i=0;i<keys.length;i++){style=STYLES[keys[i]];value=this[keys[i]];if(style.apply){if(style.apply.indexOf("fill")!==-1&&value instanceof CanvasPattern){if(value.__ctx){for(j=0;j<value.__ctx.__defs.childNodes.length;j++){id=value.__ctx.__defs.childNodes[0].getAttribute("id");this.__ids[id]=id;element=value.__ctx.__defs.childNodes[j];element.setAttribute("patternUnits","userSpaceOnUse");this.__defs.appendChild(element)}}this.__currentElement.setAttribute("fill",format("url(#{id})",{id:value.__root.getAttribute("id")}))}else{if(style.apply.indexOf("fill")!==-1&&value instanceof CanvasGradient){this.__currentElement.setAttribute("fill",format("url(#{id})",{id:value.__root.getAttribute("id")}))}else{if(style.apply.indexOf(type)!==-1&&style.svg!==value){if((style.svgAttr==="stroke"||style.svgAttr==="fill")&&value.indexOf("rgba")!==-1){regex=/rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d?\.?\d*)\s*\)/gi;matches=regex.exec(value);this.__currentElement.setAttribute(style.svgAttr,format("rgb({r},{g},{b})",{r:matches[1],g:matches[2],b:matches[3]}));this.__currentElement.setAttribute(style.svgAttr+"-opacity",matches[4])}else{this.__currentElement.setAttribute(style.svgAttr,value)}}}}}}};ctx.prototype.__closestGroupOrSvg=function(node){node=node||this.__currentElement;if(node.nodeName==="g"||node.nodeName==="svg"){return node}else{return this.__closestGroupOrSvg(node.parentNode)}};ctx.prototype.getSerializedSvg=function(fixNamedEntities){var serialized=new XMLSerializer().serializeToString(this.__root),keys,i,key,value,regexp,xmlns;xmlns=/xmlns="http:\/\/www\.w3\.org\/2000\/svg".+xmlns="http:\/\/www\.w3\.org\/2000\/svg/gi;if(xmlns.test(serialized)){serialized=serialized.replace('xmlns="http://www.w3.org/2000/svg','xmlns:xlink="http://www.w3.org/1999/xlink')}if(fixNamedEntities){keys=Object.keys(namedEntities);for(i=0;i<keys.length;i++){key=keys[i];value=namedEntities[key];regexp=new RegExp(key,"gi");if(regexp.test(serialized)){serialized=serialized.replace(regexp,value)}}}return serialized};ctx.prototype.getSvg=function(){return this.__root};ctx.prototype.save=function(){var group=document.createElementNS("http://www.w3.org/2000/svg","g"),parent=this.__closestGroupOrSvg();this.__groupStack.push(parent);parent.appendChild(group);this.__currentElement=group;this.__stack.push(this.__getStyleState())};ctx.prototype.restore=function(){this.__currentElement=this.__groupStack.pop();var state=this.__stack.pop();this.__applyStyleState(state)};ctx.prototype.__addTransform=function(t){var transform=this.__currentElement.getAttribute("transform");if(transform){transform+=" "}else{transform=""}transform+=t;this.__currentElement.setAttribute("transform",transform)};ctx.prototype.scale=function(x,y){if(y===undefined){y=x}this.__addTransform(format("scale({x},{y})",{x:x,y:y}))};ctx.prototype.rotate=function(angle){var degrees=(angle*180/Math.PI);this.__addTransform(format("rotate({angle},{cx},{cy})",{angle:degrees,cx:0,cy:0}))};ctx.prototype.translate=function(x,y){this.__addTransform(format("translate({x},{y})",{x:x,y:y}))};ctx.prototype.transform=function(a,b,c,d,e,f){this.__addTransform(format("matrix({a},{b},{c},{d},{e},{f})",{a:a,b:b,c:c,d:d,e:e,f:f}))};ctx.prototype.beginPath=function(){var path,parent,a;path=this.__createElement("path",{},true);parent=this.__closestGroupOrSvg();if(this.__pathHref){a=this.__createElement("a",{"xlink:href":this.__pathHref,target:"_blank"});parent.appendChild(a);a.appendChild(path)}else{parent.appendChild(path)}this.__currentElement=path};ctx.prototype.__addPathCommand=function(command){if(this.__currentElement.nodeName==="path"){var d=this.__currentElement.getAttribute("d");if(d){d+=" "}else{d=""}d+=command;this.__currentElement.setAttribute("d",d)}else{throw new Error("Attempted to add path command to node "+this.__currentElement.nodeName)}};ctx.prototype.moveTo=function(x,y){this.__addPathCommand(format("M {x} {y}",{x:x,y:y}))};ctx.prototype.closePath=function(){this.__addPathCommand("Z")};ctx.prototype.lineTo=function(x,y){this.__addPathCommand(format("L {x} {y}",{x:x,y:y}))};ctx.prototype.bezierCurveTo=function(cp1x,cp1y,cp2x,cp2y,x,y){this.__addPathCommand(format("C {cp1x} {cp1y} {cp2x} {cp2y} {x} {y}",{cp1x:cp1x,cp1y:cp1y,cp2x:cp2x,cp2y:cp2y,x:x,y:y}))};ctx.prototype.quadraticCurveTo=function(cpx,cpy,x,y){this.__addPathCommand(format("Q {cpx} {cpy} {x} {y}",{cpx:cpx,cpy:cpy,x:x,y:y}))};ctx.prototype.stroke=function(){this.__applyStyleToCurrentElement("stroke")};ctx.prototype.fill=function(){this.__applyStyleToCurrentElement("fill")};ctx.prototype.rect=function(x,y,width,height){if(this.__currentElement.nodeName!=="path"){this.beginPath()}this.moveTo(x,y);this.lineTo(x+width,y);this.lineTo(x+width,y+height);this.lineTo(x,y+height);this.lineTo(x,y);this.closePath()};ctx.prototype.fillRect=function(x,y,width,height){var rect,parent;rect=this.__createElement("rect",{x:x,y:y,width:width,height:height},true);parent=this.__closestGroupOrSvg();parent.appendChild(rect);this.__currentElement=rect;this.__applyStyleToCurrentElement("fill")};ctx.prototype.strokeRect=function(x,y,width,height){var rect,parent;rect=this.__createElement("rect",{x:x,y:y,width:width,height:height},true);parent=this.__closestGroupOrSvg();parent.appendChild(rect);this.__currentElement=rect;this.__applyStyleToCurrentElement("stroke")};ctx.prototype.clearRect=function(x,y,width,height){var rect,parent=this.__closestGroupOrSvg();rect=this.__createElement("rect",{x:x,y:y,width:width,height:height,fill:"#FFFFFF"},true);parent.appendChild(rect)};ctx.prototype.createLinearGradient=function(x1,y1,x2,y2){var grad=this.__createElement("linearGradient",{id:randomString(this.__ids),x1:x1+"px",x2:x2+"px",y1:y1+"px",y2:y2+"px",gradientUnits:"userSpaceOnUse"},false);this.__defs.appendChild(grad);return new CanvasGradient(grad)};ctx.prototype.createRadialGradient=function(x0,y0,r0,x1,y1,r1){var grad=this.__createElement("radialGradient",{id:randomString(this.__ids),cx:x1+"px",cy:y1+"px",r:r1+"px",fx:x0+"px",fy:y0+"px",gradientUnits:"userSpaceOnUse"},false);this.__defs.appendChild(grad);return new CanvasGradient(grad)};ctx.prototype.__parseFont=function(){var font=this.font,parts,token,index=0,data={style:"normal",size:"10px",height:"normal",family:"sans-serif",weight:"normal",decoration:"none",href:null};var test=document.createElement("span");test.style.font=font;data.style=test.style.fontStyle;data.size=test.style.fontSize;data.family=test.style.fontFamily;data.weight=test.style.fontWeight;data.decoration=test.style.textDecoration;data.height=test.style.lineHeight;if(this.__fontUnderline==="underline"){data.decoration="underline"}if(this.__fontHref){data.href=this.__fontHref}if(this.__fontHrefTarget){data.hrefTarget=this.__fontHrefTarget}return data};ctx.prototype.__wrapTextLink=function(font,element){if(font.href){var a=document.createElementNS("http://www.w3.org/2000/svg","a");a.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",font.href);if(font.hrefTarget){a.setAttribute("target",font.hrefTarget)}a.appendChild(element);return a}return element};ctx.prototype.__applyText=function(text,x,y,action){var font=this.__parseFont(),parent=this.__closestGroupOrSvg(),textElement=this.__createElement("text",{"font-family":font.family,"font-size":font.size,"font-style":font.style,"font-weight":font.weight,"text-decoration":font.decoration,"line-height":font.height,x:x,y:y},true);textElement.appendChild(document.createTextNode(text));this.__currentElement=textElement;this.__applyStyleToCurrentElement(action);parent.appendChild(this.__wrapTextLink(font,textElement))};ctx.prototype.fillText=function(text,x,y){this.__applyText(text,x,y,"fill")};ctx.prototype.strokeText=function(text,x,y){this.__applyText(text,x,y,"stroke")};ctx.prototype.measureText=function(text){return this.__ctx.measureText(text)};ctx.prototype.arc=function(x,y,radius,startAngle,endAngle,counterClockwise){startAngle=startAngle%(2*Math.PI);endAngle=endAngle%(2*Math.PI);if(startAngle===endAngle){endAngle=((endAngle+(2*Math.PI))-0.001*(counterClockwise?-1:1))%(2*Math.PI)}var endX=x+radius*Math.cos(endAngle),endY=y+radius*Math.sin(endAngle),startX=x+radius*Math.cos(startAngle),startY=y+radius*Math.sin(startAngle),sweepFlag=counterClockwise?0:1,largeArcFlag=0,diff=endAngle-startAngle;if(diff<0){diff+=2*Math.PI}if(counterClockwise){largeArcFlag=diff>Math.PI?0:1}else{largeArcFlag=diff>Math.PI?1:0}this.moveTo(startX,startY);this.__addPathCommand(format("A {rx} {ry} {xAxisRotation} {largeArcFlag} {sweepFlag} {endX} {endY}",{rx:radius,ry:radius,xAxisRotation:0,largeArcFlag:largeArcFlag,sweepFlag:sweepFlag,endX:endX,endY:endY}))};ctx.prototype.clip=function(){var group=this.__closestGroupOrSvg(),clipPath=document.createElementNS("http://www.w3.org/2000/svg","clipPath"),id=randomString(this.__ids),newGroup=document.createElementNS("http://www.w3.org/2000/svg","g");try{group.removeChild(this.__currentElement)}catch(err){}clipPath.setAttribute("id",id);clipPath.appendChild(this.__currentElement);this.__defs.appendChild(clipPath);group.setAttribute("clip-path",format("url(#{id})",{id:id}));group.appendChild(newGroup);this.__currentElement=newGroup};ctx.prototype.drawImage=function(){var args=Array.prototype.slice.call(arguments),image=args[0],dx,dy,dw,dh,sx=0,sy=0,sw,sh,parent,svg,defs,group,currentElement,svgImage,canvas,context,id;if(args.length===3){dx=args[1];dy=args[2];sw=image.width;sh=image.height;dw=sw;dh=sh}else{if(args.length===5){dx=args[1];dy=args[2];dw=args[3];dh=args[4];sw=image.width;sh=image.height}else{if(args.length===9){sx=args[1];sy=args[2];sw=args[3];sh=args[4];dx=args[5];dy=args[6];dw=args[7];dh=args[8]}else{throw new Error("Inavlid number of arguments passed to drawImage: "+arguments.length)}}}parent=this.__closestGroupOrSvg();currentElement=this.__currentElement;if(image instanceof ctx){svg=image.getSvg();defs=svg.childNodes[0];while(defs.childNodes.length){id=defs.childNodes[0].getAttribute("id");this.__ids[id]=id;this.__defs.appendChild(defs.childNodes[0])}group=svg.childNodes[1];parent.appendChild(group);this.__currentElement=group;this.translate(dx,dy);this.__currentElement=currentElement}else{if(image.nodeName==="CANVAS"||image.nodeName==="IMG"){svgImage=document.createElementNS("http://www.w3.org/2000/svg","image");svgImage.setAttribute("width",dw);svgImage.setAttribute("height",dh);svgImage.setAttribute("preserveAspectRatio","none");if(sx||sy||sw!==image.width||sh!==image.height){canvas=document.createElement("canvas");canvas.width=dw;canvas.height=dh;context=canvas.getContext("2d");context.drawImage(image,sx,sy,sw,sh,0,0,dw,dh);image=canvas}svgImage.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",image.nodeName==="CANVAS"?image.toDataURL():image.getAttribute("src"));parent.appendChild(svgImage);if(this.__pathHref){var a=this.__createElement("a",{"xlink:href":this.__pathHref,target:"_blank"});parent.appendChild(a);a.appendChild(svgImage)}else{parent.appendChild(svgImage)}this.__currentElement=svgImage;this.translate(dx,dy);this.__currentElement=currentElement}}};ctx.prototype.createPattern=function(image,repetition){var pattern=document.createElementNS("http://www.w3.org/2000/svg","pattern"),id=randomString(this.__ids),img;pattern.setAttribute("id",id);pattern.setAttribute("width",image.width);pattern.setAttribute("height",image.height);if(image.nodeName==="CANVAS"||image.nodeName==="IMG"){img=document.createElementNS("http://www.w3.org/2000/svg","image");img.setAttribute("width",image.width);img.setAttribute("height",image.height);img.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",image.nodeName==="CANVAS"?image.toDataURL():image.getAttribute("src"));pattern.appendChild(img);this.__defs.appendChild(pattern)}else{if(image instanceof ctx){pattern.appendChild(image.__root.childNodes[1]);this.__defs.appendChild(pattern)}}return new CanvasPattern(pattern,this)};ctx.prototype.drawFocusRing=function(){};ctx.prototype.createImageData=function(){};ctx.prototype.getImageData=function(){};ctx.prototype.putImageData=function(){};ctx.prototype.globalCompositeOperation=function(){};ctx.prototype.arcTo=function(){};ctx.prototype.setTransform=function(){};window.C2S=ctx}());!function(){var t=function(e){var n=new t.Index;return n.pipeline.add(t.trimmer,t.stopWordFilter,t.stemmer),e&&e.call(n,n),n};t.version="0.5.7",t.utils={},t.utils.warn=function(t){return function(e){t.console&&console.warn&&console.warn(e)}}(this),t.EventEmitter=function(){this.events={}},t.EventEmitter.prototype.addListener=function(){var t=Array.prototype.slice.call(arguments),e=t.pop(),n=t;if("function"!=typeof e){throw new TypeError("last argument must be a function")}n.forEach(function(t){this.hasHandler(t)||(this.events[t]=[]),this.events[t].push(e)},this)},t.EventEmitter.prototype.removeListener=function(t,e){if(this.hasHandler(t)){var n=this.events[t].indexOf(e);this.events[t].splice(n,1),this.events[t].length||delete this.events[t]}},t.EventEmitter.prototype.emit=function(t){if(this.hasHandler(t)){var e=Array.prototype.slice.call(arguments,1);this.events[t].forEach(function(t){t.apply(void 0,e)})}},t.EventEmitter.prototype.hasHandler=function(t){return t in this.events},t.tokenizer=function(t){if(!arguments.length||null==t||void 0==t){return[]}if(Array.isArray(t)){return t.map(function(t){return t.toLowerCase()})}for(var e=t.toString().replace(/^\s+/,""),n=e.length-1;n>=0;n--){if(/\S/.test(e.charAt(n))){e=e.substring(0,n+1);break}}return e.split(/(?:\s+|\-)/).filter(function(t){return !!t}).map(function(t){return t.toLowerCase()})},t.Pipeline=function(){this._stack=[]},t.Pipeline.registeredFunctions={},t.Pipeline.registerFunction=function(e,n){n in this.registeredFunctions&&t.utils.warn("Overwriting existing registered function: "+n),e.label=n,t.Pipeline.registeredFunctions[e.label]=e},t.Pipeline.warnIfFunctionNotRegistered=function(e){var n=e.label&&e.label in this.registeredFunctions;n||t.utils.warn("Function is not registered with pipeline. This may cause problems when serialising the index.\n",e)},t.Pipeline.load=function(e){var n=new t.Pipeline;return e.forEach(function(e){var i=t.Pipeline.registeredFunctions[e];if(!i){throw new Error("Cannot load un-registered function: "+e)}n.add(i)}),n},t.Pipeline.prototype.add=function(){var e=Array.prototype.slice.call(arguments);e.forEach(function(e){t.Pipeline.warnIfFunctionNotRegistered(e),this._stack.push(e)},this)},t.Pipeline.prototype.after=function(e,n){t.Pipeline.warnIfFunctionNotRegistered(n);var i=this._stack.indexOf(e)+1;this._stack.splice(i,0,n)},t.Pipeline.prototype.before=function(e,n){t.Pipeline.warnIfFunctionNotRegistered(n);var i=this._stack.indexOf(e);this._stack.splice(i,0,n)},t.Pipeline.prototype.remove=function(t){var e=this._stack.indexOf(t);this._stack.splice(e,1)},t.Pipeline.prototype.run=function(t){for(var e=[],n=t.length,i=this._stack.length,o=0;n>o;o++){for(var r=t[o],s=0;i>s&&(r=this._stack[s](r,o,t),void 0!==r);s++){}void 0!==r&&e.push(r)}return e},t.Pipeline.prototype.reset=function(){this._stack=[]},t.Pipeline.prototype.toJSON=function(){return this._stack.map(function(e){return t.Pipeline.warnIfFunctionNotRegistered(e),e.label})},t.Vector=function(){this._magnitude=null,this.list=void 0,this.length=0},t.Vector.Node=function(t,e,n){this.idx=t,this.val=e,this.next=n},t.Vector.prototype.insert=function(e,n){var i=this.list;if(!i){return this.list=new t.Vector.Node(e,n,i),this.length++}for(var o=i,r=i.next;void 0!=r;){if(e<r.idx){return o.next=new t.Vector.Node(e,n,r),this.length++}o=r,r=r.next}return o.next=new t.Vector.Node(e,n,r),this.length++},t.Vector.prototype.magnitude=function(){if(this._magniture){return this._magnitude}for(var t,e=this.list,n=0;e;){t=e.val,n+=t*t,e=e.next}return this._magnitude=Math.sqrt(n)},t.Vector.prototype.dot=function(t){for(var e=this.list,n=t.list,i=0;e&&n;){e.idx<n.idx?e=e.next:e.idx>n.idx?n=n.next:(i+=e.val*n.val,e=e.next,n=n.next)}return i},t.Vector.prototype.similarity=function(t){return this.dot(t)/(this.magnitude()*t.magnitude())},t.SortedSet=function(){this.length=0,this.elements=[]},t.SortedSet.load=function(t){var e=new this;return e.elements=t,e.length=t.length,e},t.SortedSet.prototype.add=function(){Array.prototype.slice.call(arguments).forEach(function(t){~this.indexOf(t)||this.elements.splice(this.locationFor(t),0,t)},this),this.length=this.elements.length},t.SortedSet.prototype.toArray=function(){return this.elements.slice()},t.SortedSet.prototype.map=function(t,e){return this.elements.map(t,e)},t.SortedSet.prototype.forEach=function(t,e){return this.elements.forEach(t,e)},t.SortedSet.prototype.indexOf=function(t,e,n){var e=e||0,n=n||this.elements.length,i=n-e,o=e+Math.floor(i/2),r=this.elements[o];return 1>=i?r===t?o:-1:t>r?this.indexOf(t,o,n):r>t?this.indexOf(t,e,o):r===t?o:void 0},t.SortedSet.prototype.locationFor=function(t,e,n){var e=e||0,n=n||this.elements.length,i=n-e,o=e+Math.floor(i/2),r=this.elements[o];if(1>=i){if(r>t){return o}if(t>r){return o+1}}return t>r?this.locationFor(t,o,n):r>t?this.locationFor(t,e,o):void 0},t.SortedSet.prototype.intersect=function(e){for(var n=new t.SortedSet,i=0,o=0,r=this.length,s=e.length,a=this.elements,h=e.elements;;){if(i>r-1||o>s-1){break}a[i]!==h[o]?a[i]<h[o]?i++:a[i]>h[o]&&o++:(n.add(a[i]),i++,o++)}return n},t.SortedSet.prototype.clone=function(){var e=new t.SortedSet;return e.elements=this.toArray(),e.length=e.elements.length,e},t.SortedSet.prototype.union=function(t){var e,n,i;return this.length>=t.length?(e=this,n=t):(e=t,n=this),i=e.clone(),i.add.apply(i,n.toArray()),i},t.SortedSet.prototype.toJSON=function(){return this.toArray()},t.Index=function(){this._fields=[],this._ref="id",this.pipeline=new t.Pipeline,this.documentStore=new t.Store,this.tokenStore=new t.TokenStore,this.corpusTokens=new t.SortedSet,this.eventEmitter=new t.EventEmitter,this._idfCache={},this.on("add","remove","update",function(){this._idfCache={}}.bind(this))},t.Index.prototype.on=function(){var t=Array.prototype.slice.call(arguments);return this.eventEmitter.addListener.apply(this.eventEmitter,t)},t.Index.prototype.off=function(t,e){return this.eventEmitter.removeListener(t,e)},t.Index.load=function(e){e.version!==t.version&&t.utils.warn("version mismatch: current "+t.version+" importing "+e.version);var n=new this;return n._fields=e.fields,n._ref=e.ref,n.documentStore=t.Store.load(e.documentStore),n.tokenStore=t.TokenStore.load(e.tokenStore),n.corpusTokens=t.SortedSet.load(e.corpusTokens),n.pipeline=t.Pipeline.load(e.pipeline),n},t.Index.prototype.field=function(t,e){var e=e||{},n={name:t,boost:e.boost||1};return this._fields.push(n),this},t.Index.prototype.ref=function(t){return this._ref=t,this},t.Index.prototype.add=function(e,n){var i={},o=new t.SortedSet,r=e[this._ref],n=void 0===n?!0:n;this._fields.forEach(function(n){var r=this.pipeline.run(t.tokenizer(e[n.name]));i[n.name]=r,t.SortedSet.prototype.add.apply(o,r)},this),this.documentStore.set(r,o),t.SortedSet.prototype.add.apply(this.corpusTokens,o.toArray());for(var s=0;s<o.length;s++){var a=o.elements[s],h=this._fields.reduce(function(t,e){var n=i[e.name].length;if(!n){return t}var o=i[e.name].filter(function(t){return t===a}).length;return t+o/n*e.boost},0);this.tokenStore.add(a,{ref:r,tf:h})}n&&this.eventEmitter.emit("add",e,this)},t.Index.prototype.remove=function(t,e){var n=t[this._ref],e=void 0===e?!0:e;if(this.documentStore.has(n)){var i=this.documentStore.get(n);this.documentStore.remove(n),i.forEach(function(t){this.tokenStore.remove(t,n)},this),e&&this.eventEmitter.emit("remove",t,this)}},t.Index.prototype.update=function(t,e){var e=void 0===e?!0:e;this.remove(t,!1),this.add(t,!1),e&&this.eventEmitter.emit("update",t,this)},t.Index.prototype.idf=function(t){var e="@"+t;if(Object.prototype.hasOwnProperty.call(this._idfCache,e)){return this._idfCache[e]}var n=this.tokenStore.count(t),i=1;return n>0&&(i=1+Math.log(this.tokenStore.length/n)),this._idfCache[e]=i},t.Index.prototype.search=function(e){var n=this.pipeline.run(t.tokenizer(e)),i=new t.Vector,o=[],r=this._fields.reduce(function(t,e){return t+e.boost},0),s=n.some(function(t){return this.tokenStore.has(t)},this);if(!s){return[]}n.forEach(function(e,n,s){var a=1/s.length*this._fields.length*r,h=this,u=this.tokenStore.expand(e).reduce(function(n,o){var r=h.corpusTokens.indexOf(o),s=h.idf(o),u=1,l=new t.SortedSet;if(o!==e){var c=Math.max(3,o.length-e.length);u=1/Math.log(c)}return r>-1&&i.insert(r,a*s*u),Object.keys(h.tokenStore.get(o)).forEach(function(t){l.add(t)}),n.union(l)},new t.SortedSet);o.push(u)},this);var a=o.reduce(function(t,e){return t.intersect(e)});return a.map(function(t){return{ref:t,score:i.similarity(this.documentVector(t))}},this).sort(function(t,e){return e.score-t.score})},t.Index.prototype.documentVector=function(e){for(var n=this.documentStore.get(e),i=n.length,o=new t.Vector,r=0;i>r;r++){var s=n.elements[r],a=this.tokenStore.get(s)[e].tf,h=this.idf(s);o.insert(this.corpusTokens.indexOf(s),a*h)}return o},t.Index.prototype.toJSON=function(){return{version:t.version,fields:this._fields,ref:this._ref,documentStore:this.documentStore.toJSON(),tokenStore:this.tokenStore.toJSON(),corpusTokens:this.corpusTokens.toJSON(),pipeline:this.pipeline.toJSON()}},t.Index.prototype.use=function(t){var e=Array.prototype.slice.call(arguments,1);e.unshift(this),t.apply(this,e)},t.Store=function(){this.store={},this.length=0},t.Store.load=function(e){var n=new this;return n.length=e.length,n.store=Object.keys(e.store).reduce(function(n,i){return n[i]=t.SortedSet.load(e.store[i]),n},{}),n},t.Store.prototype.set=function(t,e){this.has(t)||this.length++,this.store[t]=e},t.Store.prototype.get=function(t){return this.store[t]},t.Store.prototype.has=function(t){return t in this.store},t.Store.prototype.remove=function(t){this.has(t)&&(delete this.store[t],this.length--)},t.Store.prototype.toJSON=function(){return{store:this.store,length:this.length}},t.stemmer=function(){var t={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},e={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},n="[^aeiou]",i="[aeiouy]",o=n+"[^aeiouy]*",r=i+"[aeiou]*",s="^("+o+")?"+r+o,a="^("+o+")?"+r+o+"("+r+")?$",h="^("+o+")?"+r+o+r+o,u="^("+o+")?"+i,l=new RegExp(s),c=new RegExp(h),p=new RegExp(a),f=new RegExp(u),d=/^(.+?)(ss|i)es$/,v=/^(.+?)([^s])s$/,m=/^(.+?)eed$/,g=/^(.+?)(ed|ing)$/,y=/.$/,S=/(at|bl|iz)$/,w=new RegExp("([^aeiouylsz])\\1$"),x=new RegExp("^"+o+i+"[^aeiouwxy]$"),k=/^(.+?[^aeiou])y$/,b=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,E=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,_=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/,O=/^(.+?)(s|t)(ion)$/,F=/^(.+?)e$/,P=/ll$/,T=new RegExp("^"+o+i+"[^aeiouwxy]$"),$=function(n){var i,o,r,s,a,h,u;if(n.length<3){return n}if(r=n.substr(0,1),"y"==r&&(n=r.toUpperCase()+n.substr(1)),s=d,a=v,s.test(n)?n=n.replace(s,"$1$2"):a.test(n)&&(n=n.replace(a,"$1$2")),s=m,a=g,s.test(n)){var $=s.exec(n);s=l,s.test($[1])&&(s=y,n=n.replace(s,""))}else{if(a.test(n)){var $=a.exec(n);i=$[1],a=f,a.test(i)&&(n=i,a=S,h=w,u=x,a.test(n)?n+="e":h.test(n)?(s=y,n=n.replace(s,"")):u.test(n)&&(n+="e"))}}if(s=k,s.test(n)){var $=s.exec(n);i=$[1],n=i+"i"}if(s=b,s.test(n)){var $=s.exec(n);i=$[1],o=$[2],s=l,s.test(i)&&(n=i+t[o])}if(s=E,s.test(n)){var $=s.exec(n);i=$[1],o=$[2],s=l,s.test(i)&&(n=i+e[o])}if(s=_,a=O,s.test(n)){var $=s.exec(n);i=$[1],s=c,s.test(i)&&(n=i)}else{if(a.test(n)){var $=a.exec(n);i=$[1]+$[2],a=c,a.test(i)&&(n=i)}}if(s=F,s.test(n)){var $=s.exec(n);i=$[1],s=c,a=p,h=T,(s.test(i)||a.test(i)&&!h.test(i))&&(n=i)}return s=P,a=c,s.test(n)&&a.test(n)&&(s=y,n=n.replace(s,"")),"y"==r&&(n=r.toLowerCase()+n.substr(1)),n};return $}(),t.Pipeline.registerFunction(t.stemmer,"stemmer"),t.stopWordFilter=function(e){return -1===t.stopWordFilter.stopWords.indexOf(e)?e:void 0},t.stopWordFilter.stopWords=new t.SortedSet,t.stopWordFilter.stopWords.length=119,t.stopWordFilter.stopWords.elements=["","a","able","about","across","after","all","almost","also","am","among","an","and","any","are","as","at","be","because","been","but","by","can","cannot","could","dear","did","do","does","either","else","ever","every","for","from","get","got","had","has","have","he","her","hers","him","his","how","however","i","if","in","into","is","it","its","just","least","let","like","likely","may","me","might","most","must","my","neither","no","nor","not","of","off","often","on","only","or","other","our","own","rather","said","say","says","she","should","since","so","some","than","that","the","their","them","then","there","these","they","this","tis","to","too","twas","us","wants","was","we","were","what","when","where","which","while","who","whom","why","will","with","would","yet","you","your"],t.Pipeline.registerFunction(t.stopWordFilter,"stopWordFilter"),t.trimmer=function(t){return t.replace(/^\W+/,"").replace(/\W+$/,"")},t.Pipeline.registerFunction(t.trimmer,"trimmer"),t.TokenStore=function(){this.root={docs:{}},this.length=0},t.TokenStore.load=function(t){var e=new this;return e.root=t.root,e.length=t.length,e},t.TokenStore.prototype.add=function(t,e,n){var n=n||this.root,i=t[0],o=t.slice(1);return i in n||(n[i]={docs:{}}),0===o.length?(n[i].docs[e.ref]=e,void (this.length+=1)):this.add(o,e,n[i])},t.TokenStore.prototype.has=function(t){if(!t){return !1}for(var e=this.root,n=0;n<t.length;n++){if(!e[t[n]]){return !1}e=e[t[n]]}return !0},t.TokenStore.prototype.getNode=function(t){if(!t){return{}}for(var e=this.root,n=0;n<t.length;n++){if(!e[t[n]]){return{}}e=e[t[n]]}return e},t.TokenStore.prototype.get=function(t,e){return this.getNode(t,e).docs||{}},t.TokenStore.prototype.count=function(t,e){return Object.keys(this.get(t,e)).length},t.TokenStore.prototype.remove=function(t,e){if(t){for(var n=this.root,i=0;i<t.length;i++){if(!(t[i] in n)){return}n=n[t[i]]}delete n.docs[e]}},t.TokenStore.prototype.expand=function(t,e){var n=this.getNode(t),i=n.docs||{},e=e||[];return Object.keys(i).length&&e.push(t),Object.keys(n).forEach(function(n){"docs"!==n&&e.concat(this.expand(t+n,e))},this),e},t.TokenStore.prototype.toJSON=function(){return{root:this.root,length:this.length}},function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():t.lunr=e()}(this,function(){return t})}();(function(window,document,undefined){var j=void 0,k=!0,l=null,p=!1;function q(a){return function(){return this[a]}}var aa=this;function ba(a,b){var c=a.split("."),d=aa;!(c[0] in d)&&d.execScript&&d.execScript("var "+c[0]);for(var e;c.length&&(e=c.shift());){!c.length&&b!==j?d[e]=b:d=d[e]?d[e]:d[e]={}}}aa.Ba=k;function ca(a,b,c){return a.call.apply(a.bind,arguments)}function da(a,b,c){if(!a){throw Error()}if(2<arguments.length){var d=Array.prototype.slice.call(arguments,2);return function(){var c=Array.prototype.slice.call(arguments);Array.prototype.unshift.apply(c,d);return a.apply(b,c)}}return function(){return a.apply(b,arguments)}}function s(a,b,c){s=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?ca:da;return s.apply(l,arguments)}var ea=Date.now||function(){return +new Date};function fa(a,b){this.G=a;this.u=b||a;this.z=this.u.document;this.R=j}fa.prototype.createElement=function(a,b,c){a=this.z.createElement(a);if(b){for(var d in b){if(b.hasOwnProperty(d)){if("style"==d){var e=a,f=b[d];ga(this)?e.setAttribute("style",f):e.style.cssText=f}else{a.setAttribute(d,b[d])}}}}c&&a.appendChild(this.z.createTextNode(c));return a};function t(a,b,c){a=a.z.getElementsByTagName(b)[0];a||(a=document.documentElement);a&&a.lastChild&&a.insertBefore(c,a.lastChild)}function u(a,b){return a.createElement("link",{rel:"stylesheet",href:b})}function ha(a,b){return a.createElement("script",{src:b})}function v(a,b){for(var c=a.className.split(/\s+/),d=0,e=c.length;d<e;d++){if(c[d]==b){return}}c.push(b);a.className=c.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function w(a,b){for(var c=a.className.split(/\s+/),d=[],e=0,f=c.length;e<f;e++){c[e]!=b&&d.push(c[e])}a.className=d.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function ia(a,b){for(var c=a.className.split(/\s+/),d=0,e=c.length;d<e;d++){if(c[d]==b){return k}}return p}function ga(a){if(a.R===j){var b=a.z.createElement("p");b.innerHTML='<a style="top:1px;">w</a>';a.R=/top/.test(b.getElementsByTagName("a")[0].getAttribute("style"))}return a.R}function x(a){var b=a.u.location.protocol;"about:"==b&&(b=a.G.location.protocol);return"https:"==b?"https:":"http:"}function y(a,b,c){this.w=a;this.T=b;this.Aa=c}ba("webfont.BrowserInfo",y);y.prototype.qa=q("w");y.prototype.hasWebFontSupport=y.prototype.qa;y.prototype.ra=q("T");y.prototype.hasWebKitFallbackBug=y.prototype.ra;y.prototype.sa=q("Aa");y.prototype.hasWebKitMetricsBug=y.prototype.sa;function z(a,b,c,d){this.e=a!=l?a:l;this.o=b!=l?b:l;this.ba=c!=l?c:l;this.f=d!=l?d:l}var ja=/^([0-9]+)(?:[\._-]([0-9]+))?(?:[\._-]([0-9]+))?(?:[\._+-]?(.*))?$/;z.prototype.toString=function(){return[this.e,this.o||"",this.ba||"",this.f||""].join("")};function A(a){a=ja.exec(a);var b=l,c=l,d=l,e=l;a&&(a[1]!==l&&a[1]&&(b=parseInt(a[1],10)),a[2]!==l&&a[2]&&(c=parseInt(a[2],10)),a[3]!==l&&a[3]&&(d=parseInt(a[3],10)),a[4]!==l&&a[4]&&(e=/^[0-9]+$/.test(a[4])?parseInt(a[4],10):a[4]));return new z(b,c,d,e)}function B(a,b,c,d,e,f,g,h,n,m,r){this.J=a;this.Ha=b;this.za=c;this.ga=d;this.Fa=e;this.fa=f;this.xa=g;this.Ga=h;this.wa=n;this.ea=m;this.k=r}ba("webfont.UserAgent",B);B.prototype.getName=q("J");B.prototype.getName=B.prototype.getName;B.prototype.pa=q("za");B.prototype.getVersion=B.prototype.pa;B.prototype.la=q("ga");B.prototype.getEngine=B.prototype.la;B.prototype.ma=q("fa");B.prototype.getEngineVersion=B.prototype.ma;B.prototype.na=q("xa");B.prototype.getPlatform=B.prototype.na;B.prototype.oa=q("wa");B.prototype.getPlatformVersion=B.prototype.oa;B.prototype.ka=q("ea");B.prototype.getDocumentMode=B.prototype.ka;B.prototype.ja=q("k");B.prototype.getBrowserInfo=B.prototype.ja;function C(a,b){this.a=a;this.H=b}var ka=new B("Unknown",new z,"Unknown","Unknown",new z,"Unknown","Unknown",new z,"Unknown",j,new y(p,p,p));C.prototype.parse=function(){var a;if(-1!=this.a.indexOf("MSIE")){a=D(this);var b=E(this),c=A(b),d=F(this.a,/MSIE ([\d\w\.]+)/,1),e=A(d);a=new B("MSIE",e,d,"MSIE",e,d,a,c,b,G(this.H),new y("Windows"==a&&6<=e.e||"Windows Phone"==a&&8<=c.e,p,p))}else{if(-1!=this.a.indexOf("Opera")){a:{a="Unknown";var b=F(this.a,/Presto\/([\d\w\.]+)/,1),c=A(b),d=E(this),e=A(d),f=G(this.H);c.e!==l?a="Presto":(-1!=this.a.indexOf("Gecko")&&(a="Gecko"),b=F(this.a,/rv:([^\)]+)/,1),c=A(b));if(-1!=this.a.indexOf("Opera Mini/")){var g=F(this.a,/Opera Mini\/([\d\.]+)/,1),h=A(g);a=new B("OperaMini",h,g,a,c,b,D(this),e,d,f,new y(p,p,p))}else{if(-1!=this.a.indexOf("Version/")&&(g=F(this.a,/Version\/([\d\.]+)/,1),h=A(g),h.e!==l)){a=new B("Opera",h,g,a,c,b,D(this),e,d,f,new y(10<=h.e,p,p));break a}g=F(this.a,/Opera[\/ ]([\d\.]+)/,1);h=A(g);a=h.e!==l?new B("Opera",h,g,a,c,b,D(this),e,d,f,new y(10<=h.e,p,p)):new B("Opera",new z,"Unknown",a,c,b,D(this),e,d,f,new y(p,p,p))}}}else{if(/AppleWeb(K|k)it/.test(this.a)){a=D(this);var b=E(this),c=A(b),d=F(this.a,/AppleWeb(?:K|k)it\/([\d\.\+]+)/,1),e=A(d),f="Unknown",g=new z,h="Unknown",n=p;-1!=this.a.indexOf("Chrome")||-1!=this.a.indexOf("CrMo")||-1!=this.a.indexOf("CriOS")?f="Chrome":/Silk\/\d/.test(this.a)?f="Silk":"BlackBerry"==a||"Android"==a?f="BuiltinBrowser":-1!=this.a.indexOf("Safari")?f="Safari":-1!=this.a.indexOf("AdobeAIR")&&(f="AdobeAIR");"BuiltinBrowser"==f?h="Unknown":"Silk"==f?h=F(this.a,/Silk\/([\d\._]+)/,1):"Chrome"==f?h=F(this.a,/(Chrome|CrMo|CriOS)\/([\d\.]+)/,2):-1!=this.a.indexOf("Version/")?h=F(this.a,/Version\/([\d\.\w]+)/,1):"AdobeAIR"==f&&(h=F(this.a,/AdobeAIR\/([\d\.]+)/,1));g=A(h);n="AdobeAIR"==f?2<g.e||2==g.e&&5<=g.o:"BlackBerry"==a?10<=c.e:"Android"==a?2<c.e||2==c.e&&1<c.o:526<=e.e||525<=e.e&&13<=e.o;a=new B(f,g,h,"AppleWebKit",e,d,a,c,b,G(this.H),new y(n,536>e.e||536==e.e&&11>e.o,"iPhone"==a||"iPad"==a||"iPod"==a||"Macintosh"==a))}else{-1!=this.a.indexOf("Gecko")?(a="Unknown",b=new z,c="Unknown",d=E(this),e=A(d),f=p,-1!=this.a.indexOf("Firefox")?(a="Firefox",c=F(this.a,/Firefox\/([\d\w\.]+)/,1),b=A(c),f=3<=b.e&&5<=b.o):-1!=this.a.indexOf("Mozilla")&&(a="Mozilla"),g=F(this.a,/rv:([^\)]+)/,1),h=A(g),f||(f=1<h.e||1==h.e&&9<h.o||1==h.e&&9==h.o&&2<=h.ba||g.match(/1\.9\.1b[123]/)!=l||g.match(/1\.9\.1\.[\d\.]+/)!=l),a=new B(a,b,c,"Gecko",h,g,D(this),e,d,G(this.H),new y(f,p,p))):a=ka}}}return a};function D(a){var b=F(a.a,/(iPod|iPad|iPhone|Android|Windows Phone|BB\d{2}|BlackBerry)/,1);if(""!=b){return/BB\d{2}/.test(b)&&(b="BlackBerry"),b}a=F(a.a,/(Linux|Mac_PowerPC|Macintosh|Windows|CrOS)/,1);return""!=a?("Mac_PowerPC"==a&&(a="Macintosh"),a):"Unknown"}function E(a){var b=F(a.a,/(OS X|Windows NT|Android) ([^;)]+)/,2);if(b||(b=F(a.a,/Windows Phone( OS)? ([^;)]+)/,2))||(b=F(a.a,/(iPhone )?OS ([\d_]+)/,2))){return b}if(b=F(a.a,/(?:Linux|CrOS) ([^;)]+)/,1)){for(var b=b.split(/\s/),c=0;c<b.length;c+=1){if(/^[\d\._]+$/.test(b[c])){return b[c]}}}return(a=F(a.a,/(BB\d{2}|BlackBerry).*?Version\/([^\s]*)/,2))?a:"Unknown"}function F(a,b,c){return(a=a.match(b))&&a[c]?a[c]:""}function G(a){if(a.documentMode){return a.documentMode}}function la(a){this.va=a||"-"}la.prototype.f=function(a){for(var b=[],c=0;c<arguments.length;c++){b.push(arguments[c].replace(/[\W_]+/g,"").toLowerCase())}return b.join(this.va)};function H(a,b){this.J=a;this.U=4;this.K="n";var c=(b||"n4").match(/^([nio])([1-9])$/i);c&&(this.K=c[1],this.U=parseInt(c[2],10))}H.prototype.getName=q("J");function I(a){return a.K+a.U}function ma(a){var b=4,c="n",d=l;a&&((d=a.match(/(normal|oblique|italic)/i))&&d[1]&&(c=d[1].substr(0,1).toLowerCase()),(d=a.match(/([1-9]00|normal|bold)/i))&&d[1]&&(/bold/i.test(d[1])?b=7:/[1-9]00/.test(d[1])&&(b=parseInt(d[1].substr(0,1),10))));return c+b}function na(a,b,c){this.c=a;this.h=b;this.M=c;this.j="wf";this.g=new la("-")}function pa(a){v(a.h,a.g.f(a.j,"loading"));J(a,"loading")}function K(a){w(a.h,a.g.f(a.j,"loading"));ia(a.h,a.g.f(a.j,"active"))||v(a.h,a.g.f(a.j,"inactive"));J(a,"inactive")}function J(a,b,c){if(a.M[b]){if(c){a.M[b](c.getName(),I(c))}else{a.M[b]()}}}function L(a,b){this.c=a;this.C=b;this.s=this.c.createElement("span",{"aria-hidden":"true"},this.C)}function M(a,b){var c=a.s,d;d=[];for(var e=b.J.split(/,\s*/),f=0;f<e.length;f++){var g=e[f].replace(/['"]/g,"");-1==g.indexOf(" ")?d.push(g):d.push("'"+g+"'")}d=d.join(",");e="normal";f=b.U+"00";"o"===b.K?e="oblique":"i"===b.K&&(e="italic");d="position:absolute;top:-999px;left:-999px;font-size:300px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:"+d+";"+("font-style:"+e+";font-weight:"+f+";");ga(a.c)?c.setAttribute("style",d):c.style.cssText=d}function N(a){t(a.c,"body",a.s)}L.prototype.remove=function(){var a=this.s;a.parentNode&&a.parentNode.removeChild(a)};function qa(a,b,c,d,e,f,g,h){this.V=a;this.ta=b;this.c=c;this.q=d;this.C=h||"BESbswy";this.k=e;this.F={};this.S=f||5000;this.Z=g||l;this.B=this.A=l;a=new L(this.c,this.C);N(a);for(var n in O){O.hasOwnProperty(n)&&(M(a,new H(O[n],I(this.q))),this.F[O[n]]=a.s.offsetWidth)}a.remove()}var O={Ea:"serif",Da:"sans-serif",Ca:"monospace"};qa.prototype.start=function(){this.A=new L(this.c,this.C);N(this.A);this.B=new L(this.c,this.C);N(this.B);this.ya=ea();M(this.A,new H(this.q.getName()+",serif",I(this.q)));M(this.B,new H(this.q.getName()+",sans-serif",I(this.q)));ra(this)};function sa(a,b,c){for(var d in O){if(O.hasOwnProperty(d)&&b===a.F[O[d]]&&c===a.F[O[d]]){return k}}return p}function ra(a){var b=a.A.s.offsetWidth,c=a.B.s.offsetWidth;b===a.F.serif&&c===a.F["sans-serif"]||a.k.T&&sa(a,b,c)?ea()-a.ya>=a.S?a.k.T&&sa(a,b,c)&&(a.Z===l||a.Z.hasOwnProperty(a.q.getName()))?P(a,a.V):P(a,a.ta):setTimeout(s(function(){ra(this)},a),25):P(a,a.V)}function P(a,b){a.A.remove();a.B.remove();b(a.q)}function R(a,b,c,d){this.c=b;this.t=c;this.N=0;this.ca=this.Y=p;this.S=d;this.k=a.k}function ta(a,b,c,d,e){if(0===b.length&&e){K(a.t)}else{a.N+=b.length;e&&(a.Y=e);for(e=0;e<b.length;e++){var f=b[e],g=c[f.getName()],h=a.t,n=f;v(h.h,h.g.f(h.j,n.getName(),I(n).toString(),"loading"));J(h,"fontloading",n);(new qa(s(a.ha,a),s(a.ia,a),a.c,f,a.k,a.S,d,g)).start()}}}R.prototype.ha=function(a){var b=this.t;w(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"loading"));w(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"inactive"));v(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"active"));J(b,"fontactive",a);this.ca=k;ua(this)};R.prototype.ia=function(a){var b=this.t;w(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"loading"));ia(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"active"))||v(b.h,b.g.f(b.j,a.getName(),I(a).toString(),"inactive"));J(b,"fontinactive",a);ua(this)};function ua(a){0==--a.N&&a.Y&&(a.ca?(a=a.t,w(a.h,a.g.f(a.j,"loading")),w(a.h,a.g.f(a.j,"inactive")),v(a.h,a.g.f(a.j,"active")),J(a,"active")):K(a.t))}function S(a,b,c){this.G=a;this.W=b;this.a=c;this.O=this.P=0}function T(a,b){U.W.$[a]=b}S.prototype.load=function(a){var b=a.context||this.G;this.c=new fa(this.G,b);b=new na(this.c,b.document.documentElement,a);if(this.a.k.w){var c=this.W,d=this.c,e=[],f;for(f in a){if(a.hasOwnProperty(f)){var g=c.$[f];g&&e.push(g(a[f],d))}}a=a.timeout;this.O=this.P=e.length;a=new R(this.a,this.c,b,a);f=0;for(c=e.length;f<c;f++){d=e[f],d.v(this.a,s(this.ua,this,d,b,a))}}else{K(b)}};S.prototype.ua=function(a,b,c,d){var e=this;d?a.load(function(a,d,h){var n=0==--e.P;n&&pa(b);setTimeout(function(){ta(c,a,d||{},h||l,n)},0)}):(a=0==--this.P,this.O--,a&&(0==this.O?K(b):pa(b)),ta(c,[],{},l,a))};var va=window,wa=(new C(navigator.userAgent,document)).parse(),U=va.WebFont=new S(window,new function(){this.$={}},wa);U.load=U.load;function V(a,b){this.c=a;this.d=b}V.prototype.load=function(a){var b,c,d=this.d.urls||[],e=this.d.families||[];b=0;for(c=d.length;b<c;b++){t(this.c,"head",u(this.c,d[b]))}d=[];b=0;for(c=e.length;b<c;b++){var f=e[b].split(":");if(f[1]){for(var g=f[1].split(","),h=0;h<g.length;h+=1){d.push(new H(f[0],g[h]))}}else{d.push(new H(f[0]))}}a(d)};V.prototype.v=function(a,b){return b(a.k.w)};T("custom",function(a,b){return new V(b,a)});function W(a,b){this.c=a;this.d=b}var xa={regular:"n4",bold:"n7",italic:"i4",bolditalic:"i7",r:"n4",b:"n7",i:"i4",bi:"i7"};W.prototype.v=function(a,b){return b(a.k.w)};W.prototype.load=function(a){t(this.c,"head",u(this.c,x(this.c)+"//webfonts.fontslive.com/css/"+this.d.key+".css"));for(var b=this.d.families,c=[],d=0,e=b.length;d<e;d++){c.push.apply(c,ya(b[d]))}a(c)};function ya(a){var b=a.split(":");a=b[0];if(b[1]){for(var c=b[1].split(","),b=[],d=0,e=c.length;d<e;d++){var f=c[d];if(f){var g=xa[f];b.push(g?g:f)}}c=[];for(d=0;d<b.length;d+=1){c.push(new H(a,b[d]))}return c}return[new H(a)]}T("ascender",function(a,b){return new W(b,a)});function X(a,b,c){this.a=a;this.c=b;this.d=c;this.m=[]}X.prototype.v=function(a,b){var c=this,d=c.d.projectId,e=c.d.version;if(d){var f=c.c.u,g=c.c.createElement("script");g.id="__MonotypeAPIScript__"+d;var h=p;g.onload=g.onreadystatechange=function(){if(!h&&(!this.readyState||"loaded"===this.readyState||"complete"===this.readyState)){h=k;if(f["__mti_fntLst"+d]){var e=f["__mti_fntLst"+d]();if(e){for(var m=0;m<e.length;m++){c.m.push(new H(e[m].fontfamily))}}}b(a.k.w);g.onload=g.onreadystatechange=l}};g.src=c.D(d,e);t(this.c,"head",g)}else{b(k)}};X.prototype.D=function(a,b){var c=x(this.c),d=(this.d.api||"fast.fonts.com/jsapi").replace(/^.*http(s?):(\/\/)?/,"");return c+"//"+d+"/"+a+".js"+(b?"?v="+b:"")};X.prototype.load=function(a){a(this.m)};T("monotype",function(a,b){var c=(new C(navigator.userAgent,document)).parse();return new X(c,b,a)});function Y(a,b){this.c=a;this.d=b;this.m=[]}Y.prototype.D=function(a){var b=x(this.c);return(this.d.api||b+"//use.typekit.net")+"/"+a+".js"};Y.prototype.v=function(a,b){var c=this.d.id,d=this.d,e=this.c.u,f=this;c?(e.__webfonttypekitmodule__||(e.__webfonttypekitmodule__={}),e.__webfonttypekitmodule__[c]=function(c){c(a,d,function(a,c,d){for(var e=0;e<c.length;e+=1){var g=d[c[e]];if(g){for(var Q=0;Q<g.length;Q+=1){f.m.push(new H(c[e],g[Q]))}}else{f.m.push(new H(c[e]))}}b(a)})},c=ha(this.c,this.D(c)),t(this.c,"head",c)):b(k)};Y.prototype.load=function(a){a(this.m)};T("typekit",function(a,b){return new Y(b,a)});function za(a,b,c){this.L=a?a:b+Aa;this.p=[];this.Q=[];this.da=c||""}var Aa="//fonts.googleapis.com/css";za.prototype.f=function(){if(0==this.p.length){throw Error("No fonts to load !")}if(-1!=this.L.indexOf("kit=")){return this.L}for(var a=this.p.length,b=[],c=0;c<a;c++){b.push(this.p[c].replace(/ /g,"+"))}a=this.L+"?family="+b.join("%7C");0<this.Q.length&&(a+="&subset="+this.Q.join(","));0<this.da.length&&(a+="&text="+encodeURIComponent(this.da));return a};function Ba(a){this.p=a;this.aa=[];this.I={}}var Ca={latin:"BESbswy",cyrillic:"&#1081;&#1103;&#1046;",greek:"&#945;&#946;&#931;",khmer:"&#x1780;&#x1781;&#x1782;",Hanuman:"&#x1780;&#x1781;&#x1782;"},Da={thin:"1",extralight:"2","extra-light":"2",ultralight:"2","ultra-light":"2",light:"3",regular:"4",book:"4",medium:"5","semi-bold":"6",semibold:"6","demi-bold":"6",demibold:"6",bold:"7","extra-bold":"8",extrabold:"8","ultra-bold":"8",ultrabold:"8",black:"9",heavy:"9",l:"3",r:"4",b:"7"},Ea={i:"i",italic:"i",n:"n",normal:"n"},Fa=RegExp("^(thin|(?:(?:extra|ultra)-?)?light|regular|book|medium|(?:(?:semi|demi|extra|ultra)-?)?bold|black|heavy|l|r|b|[1-9]00)?(n|i|normal|italic)?$");Ba.prototype.parse=function(){for(var a=this.p.length,b=0;b<a;b++){var c=this.p[b].split(":"),d=c[0].replace(/\+/g," "),e=["n4"];if(2<=c.length){var f;var g=c[1];f=[];if(g){for(var g=g.split(","),h=g.length,n=0;n<h;n++){var m;m=g[n];if(m.match(/^[\w]+$/)){m=Fa.exec(m.toLowerCase());var r=j;if(m==l){r=""}else{r=j;r=m[1];if(r==l||""==r){r="4"}else{var oa=Da[r],r=oa?oa:isNaN(r)?"4":r.substr(0,1)}r=[m[2]==l||""==m[2]?"n":Ea[m[2]],r].join("")}m=r}else{m=""}m&&f.push(m)}}0<f.length&&(e=f);3==c.length&&(c=c[2],f=[],c=!c?f:c.split(","),0<c.length&&(c=Ca[c[0]])&&(this.I[d]=c))}this.I[d]||(c=Ca[d])&&(this.I[d]=c);for(c=0;c<e.length;c+=1){this.aa.push(new H(d,e[c]))}}};function Z(a,b,c){this.a=a;this.c=b;this.d=c}var Ga={Arimo:k,Cousine:k,Tinos:k};Z.prototype.v=function(a,b){b(a.k.w)};Z.prototype.load=function(a){var b=this.c;if("MSIE"==this.a.getName()&&this.d.blocking!=k){var c=s(this.X,this,a),d=function(){b.z.body?c():setTimeout(d,0)};d()}else{this.X(a)}};Z.prototype.X=function(a){for(var b=this.c,c=new za(this.d.api,x(b),this.d.text),d=this.d.families,e=d.length,f=0;f<e;f++){var g=d[f].split(":");3==g.length&&c.Q.push(g.pop());var h="";2==g.length&&""!=g[1]&&(h=":");c.p.push(g.join(h))}d=new Ba(d);d.parse();t(b,"head",u(b,c.f()));a(d.aa,d.I,Ga)};T("google",function(a,b){var c=(new C(navigator.userAgent,document)).parse();return new Z(c,b,a)});function $(a,b){this.c=a;this.d=b;this.m=[]}$.prototype.D=function(a){return x(this.c)+(this.d.api||"//f.fontdeck.com/s/css/js/")+(this.c.u.location.hostname||this.c.G.location.hostname)+"/"+a+".js"};$.prototype.v=function(a,b){var c=this.d.id,d=this.c.u,e=this;c?(d.__webfontfontdeckmodule__||(d.__webfontfontdeckmodule__={}),d.__webfontfontdeckmodule__[c]=function(a,c){for(var d=0,n=c.fonts.length;d<n;++d){var m=c.fonts[d];e.m.push(new H(m.name,ma("font-weight:"+m.weight+";font-style:"+m.style)))}b(a)},c=ha(this.c,this.D(c)),t(this.c,"head",c)):b(k)};$.prototype.load=function(a){a(this.m)};T("fontdeck",function(a,b){return new $(b,a)});window.WebFontConfig&&U.load(window.WebFontConfig)})(this,document);(function($){
/*!! Simple JavaScript Inheritance
     * By John Resig http://ejohn.org/
     * MIT Licensed.
     * http://ejohn.org/blog/simple-javascript-inheritance
     *
     */
var initializing=false,fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;var Class=function(){};Class.extend=function(prop){var _super=this.prototype;initializing=true;var prototype=new this();initializing=false;for(var name in prop){prototype[name]=typeof prop[name]=="function"&&typeof _super[name]=="function"&&fnTest.test(prop[name])?(function(name,fn){return function(){var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);this._super=tmp;return ret}})(name,prop[name]):prop[name]}function Class(){if(!(this instanceof Class)){return new Class(arguments)}if(!initializing&&this.init){this.init.apply(this,arguments)}}Class.prototype=prototype;Class.prototype.constructor=Class;Class.extend=arguments.callee;return Class};var AnalyticsInterface=Class.extend({init:function(){},setAccount:function(){},trackEvent:function(){},trackPageView:function(){},logEvents:function(){},setLabel:function(){},runFuncIfAnalyticsExists:function(){}});var EventThrottler=Class.extend({__eventsRemaining:0,__maxEvents:0,__regenInterval:-1,__functionQueue:null,abort:function(){clearInterval(this.__regenInterval)},init:function(o){var options=$.extend({eventBucket:9,regen:1,per:1100},o),self=this;self.__eventsRemaining=options.eventBucket;self.__maxEvents=options.eventBucket;self.__functionQueue=[];self.__regenInterval=setInterval(function(){self.__eventsRemaining=Math.min(options.eventBucket,self.__eventsRemaining+options.regen);self.__runEvents()},options.per)},__runEvents:function(){var self=this,queueEntry;while(self.__eventsRemaining>0&&self.__functionQueue.length>0){queueEntry=self.__functionQueue.shift();queueEntry.func.apply(this,queueEntry.args);self.__eventsRemaining--}},addFunction:function(func,funcArgsArray){this.__functionQueue.push({func:func,args:funcArgsArray});this.__runEvents()}});var GoogleAnalytics=AnalyticsInterface.extend({_loaded:false,_trackerID:"",_logEvents:false,_logger:null,_activeLabel:null,_optPageName:null,_eventThrottler:null,_eventWarningCtr:450,_customVariableIndices:null,_canLog:function(){return this._logger!==null&&this._logEvents===true},init:function(trackerID,optPageName,onScriptLoadedFunc,debug){var s,ga=document.createElement("script"),self=this;this._optPageName=optPageName;if(debug===undefined){debug=false}ga.type="text/javascript";ga.async=true;ga.src=("https:"===document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/"+(debug?"u/ga_debug.js":"ga.js");s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(ga,s);this._trackerID=trackerID;this._eventWarningCtr=450;ga.onreadystatechange=function(){if(this.readyState==="complete"){self._scriptLoaded();if(onScriptLoadedFunc){onScriptLoadedFunc()}}};ga.onload=function(){self._scriptLoaded();if(onScriptLoadedFunc){onScriptLoadedFunc()}};self._customVariableIndices={product:1,license:2,numUsers:3};self._eventThrottler=new EventThrottler()},loaded:function(){return this._loaded},setAccount:function(account){this._push(["_setAccount",account])},setLabel:function(label){this._activeLabel=label},setCustomVariables:function(product,license,numUsers){var PAGE_SCOPE=3;if(product){this._push(["_setCustomVar",this._customVariableIndices.product,"product",product,PAGE_SCOPE])}this._push(["_setCustomVar",this._customVariableIndices.license,"license",license,PAGE_SCOPE]);this._push(["_setCustomVar",this._customVariableIndices.numUsers,"numUsers",numUsers,PAGE_SCOPE])},trackEvent:function(category,action,opt_label,opt_value,opt_non_interaction){opt_label=opt_label===undefined?null:opt_label;opt_value=opt_value===undefined?null:opt_value;opt_non_interaction===undefined?null:opt_non_interaction;if(opt_label===null&&this._activeLabel!==null){opt_label=this._activeLabel}this._push(["_trackEvent",category,action,opt_label,opt_value,opt_non_interaction]);if(--this._eventWarningCtr===0){this._push(["_trackEvent","warning","eventsExceed450",opt_label,null,null])}if(category==="lzxclient"){this._push(["_trackPageview","/lzxEvent/"+action])}},trackPageView:function(){if(this._optPageName){this._push(["_trackPageview",this._optPageName])}else{this._push(["_trackPageview"])}},logEvents:function(bool,logger){this._logEvents=bool;this._logger=logger},_scriptLoaded:function(){this._loaded=true;this._push(["_setDomainName","none"]);this.setAccount(this._trackerID);this.trackPageView()},_push:function(eventArray){var self=this;this._eventThrottler.addFunction(function(){if(typeof _gaq!="undefined"){_gaq.push(eventArray);if(self._canLog()){self._logger.log("ANALYTICS: "+eventArray.join(", "))}}})},runFuncIfAnalyticsExists:function(func){if(func){func()}}});var _AnalyticsListener=Class.extend({_analytics:null,_queuedEvents:null,init:function(){var self=this;self._queuedEvents=[];$(window).bind("init.gliffyAnalytics",function(event,o){var options=$.extend({},{accountType:"none",accountID:"UA-248648-8",debug:false,optPageName:null},o);if(!self._analytics){switch(options.accountType){case"google":self._analytics=new GoogleAnalytics(options.accountID,options.optPageName,function(){var typeAndOption;while(typeAndOption=self._queuedEvents.shift()){$(window).trigger(typeAndOption[0]+".gliffyAnalytics",typeAndOption[1])}},options.debug);break}}});$(window).bind("trackEvent.gliffyAnalytics",function(event,o){var options=$.extend({},{category:"",action:"",label:null,value:null,non_interaction:null},o);if(self._analytics&&self._analytics.loaded()){self._analytics.trackEvent(options.category,options.action,options.label,options.value,options.non_interaction)}else{self._queuedEvents.push(["trackEvent",o])}});$(window).bind("setLabel.gliffyAnalytics",function(event,o){var options=$.extend({},{label:null},o);if(self._analytics&&self._analytics.loaded()){self._analytics.setLabel(options.label)}else{self._queuedEvents.push(["setLabel",o])}});$(window).bind("logEvents.gliffyAnalytics",function(event,o){var options=$.extend({},{logEvents:false,logger:null},o);if(self._analytics&&self._analytics.loaded()){self._analytics.logEvents(options.logEvents,options.logger)}else{self._queuedEvents.push(["logEvents",o])}});$(window).bind("setCustomVariables.gliffyAnalytics",function(event,o){var options=$.extend({},{product:null,license:"none",numUsers:0},o);if(self._analytics&&self._analytics.loaded()){self._analytics.setCustomVariables(options.product,options.license,options.numUsers)}else{self._queuedEvents.push(["setCustomVariables",o])}});$(window).bind("runFuncIfAnalyticsExists.gliffyAnalytics",function(event,o){var options=$.extend({},{func:null},o);if(self._analytics){self._analytics.runFuncIfAnalyticsExists(options.func)}})}});var AnalyticsListener=new _AnalyticsListener()}(jQuery));(function(){var MAX_STACK_LENGTH=1000;_gliffy.logger=_gliffy.Class.extend({stack:null,init:function(){this.stack=[]},log:function(message){this.stack.push({type:"log",message:"[LOG]   "+message});this.__check_length()},error:function(message){this.stack.push({type:"error",message:"[ERROR] "+message});this.__check_length()},warn:function(message){this.stack.push({type:"warn",message:"[WARN] "+message});this.__check_length()},__check_length:function(){if(_gliffy.Debug.LOG_TO_CONSOLE){console.log(this.stack[this.stack.length-1].message)}while(this.stack.length>MAX_STACK_LENGTH){this.stack.shift()}},getLog:function(o){var options=$.extend({log:true,warn:true,error:true,tail:MAX_STACK_LENGTH},o),i,stack=[];for(i=0;i<this.stack.length;i++){if(options[this.stack[i].type]>=0&&(i>this.stack.length-options.tail-1)){stack.unshift(this.stack[i].message)}}return stack}});_gliffy.Logger=new _gliffy.logger()}());(function(){var __errorHandler=null,__globalTarget=null;_gliffy.handleError=function(key,args,exception,target){args=args||[];target=target||__globalTarget||null;var message=$.i18n._(key,args);if(exception&&exception.toString().indexOf("0x80040111 (NS_ERROR_NOT_AVAILABLE)")!==-1){_gliffy.Logger.warn("FF 0x80040111 (NS_ERROR_NOT_AVAILABLE) "+exception.toString())}else{__errorHandler.report(message,exception,target)}};_gliffy.setErrorHandler=function(errorHandler){__errorHandler=errorHandler};_gliffy.setGlobalErrorTarget=function(target){__globalTarget=target||null};var DefaultErrorHandler=_gliffy.Class.extend({feedbackDialog:function(message,exception,report){var prop,output="",zIndex,confluenceSpinner,isIFrame=window.parent.document!==window.document;_gliffy.Dialog.showGenericDialog({content:message+"  "+$.i18n._("ERRORHANDLER_PLEASE_SEND_A_REPORT_TO_GLIFFY.__YOU_CAN_VIEW_THE_REPORT_BEFORE_IT_IS_SENT.")+"  "+$.i18n._("ERRORHANDLER_SADLY,_YOU_MAY_NEED_TO_REFRESH_YOUR_BROWSER_TO_CONTINUE_WORKING_NORMALLY."),title:$.i18n._("ERRORHANDLER_ERROR"),cancelCallback:null,buttons:[{text:$.i18n._("ERRORHANDLER_SEND_ERROR_REPORT"),callback:function(){$("body").trigger("send-error.gliffy-body",{message:message,report:report})},primary:true,dismiss:true},{text:$.i18n._("ERRORHANDLER_NO_THANKS"),callback:null,primary:false,dismiss:true}]});if(isIFrame){confluenceSpinner=$(window.parent.document).find(".gliffy-spinner");if(confluenceSpinner.is(":visible")){confluenceSpinner.remove();_gliffy.Spinner.show("confluence")}}},getErrorReport:function(message,exception){var prop,output=$.i18n._("ERRORHANDLER_WHAT_WERE_YOU_DOING_JUST_BEFORE_THIS_ERROR?")+"\n===============================\n\n\n\n\n"+$.i18n._("ERRORHANDLER_ERROR_REPORT")+"\n============\n\nError Type: "+message+"\n\n";try{output+="Gliffy Version: ["+_gliffy.versionString+"] \n\n"}catch(e0){output+="Missing Gliffy Version\n\n"}try{output+="Confluence Build Number ["+_gliffy.confluenceVersion+"] \n\n"}catch(e0a){output+="Missing Confluence Build Number."}try{output+=_gliffy.BrowserDetect.dump()+"\n\n"}catch(e1){output+="Missing BrowserDetect\n\n"}if(!exception||exception===undefined){output+="No exception generated.\n\n"}else{try{output+="Exception: ["+exception.toString()+"]\n\n"}catch(e2){output+="Missing exception.toString().\n\n"}try{for(prop in exception){if(exception.hasOwnProperty(prop)){output+="Exception property: "+prop+" value: ["+exception[prop]+"]\n\n"}}}catch(e3){output+="Missing Exception properties.\n\n"}try{if(exception.stack!==undefined){output+="Stack: ["+exception.stack+"]\n\n"}else{output+="No stack available\n\n"}}catch(e4){output+="Missing Stack\n\n"}}try{output+="Logger: [\n"+_gliffy.Logger.getLog({tail:20}).join("\t\n")+"]\n\n"}catch(e5){output+="Missing Logger\n"}try{_gliffy.Mouse.editor.getDocumentManager().getActiveStage().commandHistory.forceFinalizeCommandBundle();output+=_gliffy.Mouse.editor.getDocumentManager().getActiveStage().commandHistory.getReport(10)}catch(e6){output+="Missing Command Report\n"}return output},report:function(message,exception,target){var report;if(message===null||message===undefined){message="An unknown error has occurred."}report=this.getErrorReport(message,exception);if(_gliffy.Debug.NO_ERROR_DIALOG!==true){if(_gliffy.Dialog){this.feedbackDialog(message,exception,report)}else{window.alert(message)}}window.console.log(report)}});_gliffy.setErrorHandler(new DefaultErrorHandler())}());(function(){var MAC_KEYS={command:String.fromCharCode(8984),shift:String.fromCharCode(8679),del:String.fromCharCode(9003),esc:String.fromCharCode(9099),alt:String.fromCharCode(8997)},uidCounter=0;_gliffy.Utils={SNAP_DEGREES_MULTIPLIER:360,FLOAT_EQUALS_THRESHOLD:0.0001,FLOAT_FIXED:4,SNAP_PIXELS:10,__urlParams:null,getValueOrDefault:function(value,defaultValue){if(value===undefined||value===null){return defaultValue}return value},getContext:function(canvas){return canvas.getContext("2d")},getMockContext:function(){return{width:0,height:0,canvas:document.createElement("canvas"),save:function(){},restore:function(){},scale:function(){},rotate:function(){},translate:function(){},transform:function(){},setTransform:function(){},globalAlpha:function(){},globalCompositeOperation:function(){},strokeStyle:"",fillStyle:"",createLinearGradient:function(){return{addColorStop:function(){}}},createRadialGradient:function(){return{addColorStop:function(){}}},createPattern:function(){},lineCap:"",lineJoin:"",miterLimit:"",shadowColor:"",shadowOffsetX:"",shadowOffsetY:"",shadowBlur:"",clearRect:function(){},fillRect:function(){},strokeRect:function(){},beginPath:function(){},moveTo:function(){},closePath:function(){},lineTo:function(){},quadraticCurveTo:function(){},bezierCurveTo:function(){},arcTo:function(){},arc:function(){},rect:function(){},fill:function(){},stroke:function(){},clip:function(){},isPointInPath:function(){},drawFocusRing:function(){},font:"",textAlign:"",textBaseline:"",fillText:function(){},strokeText:function(){},measureText:function(){return{width:0}},drawImage:function(){},createImageData:function(){},getImageData:function(){return{width:0,height:0,data:""}},putImageData:function(){}}},randomString:function(holder){var chars,randomstring,i;if(!holder){throw"cannot create a random attribute name for an undefined object"}chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";randomstring="";do{randomstring="";for(i=0;i<12;i++){randomstring+=chars[Math.floor(Math.random()*chars.length)]}}while(holder[randomstring]);return randomstring},simpleRandomString:function(){var chars,randomstring,i;chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";randomstring="";for(i=0;i<12;i++){randomstring+=chars[Math.floor(Math.random()*chars.length)]}return randomstring},forceMatrixOnly:false,transformCss:function(transform,o){var options=$.extend({originX:0,originY:0,roundTranslate:false,matrixOnly:false},o),transformCss,transform_origin;if(this.forceMatrixOnly){options.matrixOnly=true}if(options.matrixOnly){transformCss=transform.toCss({isMoz:false,roundTranslate:options.roundTranslate});transform_origin=options.originX+" "+options.originY;return{"-moz-transform":transform.toCss({isMoz:true,roundTranslate:options.roundTranslate}),"-webkit-transform":transformCss,"-o-transform":transformCss,msTransform:transformCss,transform:transformCss,"transform-origin":transform_origin,msTransformOrigin:transform_origin,"-webkit-transform-origin":transform_origin,"-moz-transform-origin":transform_origin,"-o-transform-origin":transform_origin}}else{transformCss=transform.toCssNoTranslate({isMoz:false,roundTranslate:options.roundTranslate});transform_origin=options.originX+" "+options.originY;return{"-moz-transform":transform.toCssNoTranslate({isMoz:true,roundTranslate:options.roundTranslate}),"-webkit-transform":transformCss,"-o-transform":transformCss,msTransform:transformCss,transform:transformCss,"transform-origin":transform_origin,msTransformOrigin:transform_origin,"-webkit-transform-origin":transform_origin,"-moz-transform-origin":transform_origin,"-o-transform-origin":transform_origin,top:transform.getTranslateY(),left:transform.getTranslateX()}}},posMod:function(x,y){if(y===0){return x}return x-y*Math.floor(x/y)},unwrapRadians:function(radians){return _gliffy.Utils.posMod(radians,Math.PI*2)},trim_right:function(text){if(String.prototype.trimRight){return text.trimRight()}else{return text.replace(/\s+$/,"")}},maxBounds:function(transform,width,height,stage){var maxX,maxY,i,inViewport=false,point,points=[{x:0,y:0},{x:width,y:0},{x:width,y:height},{x:0,y:height}];for(i=0;i<points.length;i++){point=transform.transformPoint(points[i].x,points[i].y);if(i===0){maxX=point.x;maxY=point.y}maxX=Math.max(point.x,maxX);maxY=Math.max(point.y,maxY);if(stage.autoFit){if(point.x>0&&point.y>0){inViewport=true}}else{if(point.x>0&&point.y>0&&point.x<stage.width*stage.getZoom()&&point.y<stage.height*stage.getZoom()){inViewport=true}}}return{x:maxX,y:maxY,inViewport:inViewport}},maxInArray:function(arr){return Math.max.apply(Math,arr)},minInArray:function(arr){return Math.min.apply(Math,arr)},tryCatch:function(tryFunc,catchFunc){if(_gliffy.Debug.SKIP_CATCH_ERRORS){return tryFunc()}else{try{return tryFunc()}catch(e){catchFunc(e)}}},cloneArray:function(arr){var out=[],i;for(i=0;i<arr.length;i++){if(arr[i].length){out[i]=_gliffy.Utils.cloneArray(arr[i])}else{out[i]=arr[i]}}return out},wrapDegrees:function(degree){while(degree<0){degree+=360}return degree%360},radiansToDegrees:function(radians){return(radians*180/Math.PI)},degreesToRadians:function(degrees){return(degrees*Math.PI/180)},convertRanges:function(oldValue,oldRangeStart,oldRangeEnd,newRangeStart,newRangeEnd){return(((oldValue-oldRangeStart)*(newRangeEnd-newRangeStart))/(oldRangeEnd-oldRangeStart))+newRangeStart},calculateLineSnap:function(curPoint,opposingPoint,snapDegrees){var pointToPoint=_gliffy.Vec2.difference(curPoint,opposingPoint),snapped,angle,degrees,mod,newDegrees;snapped=false;if(pointToPoint.x!==0||pointToPoint.y!==0){angle=_gliffy.Utils.unwrapRadians(Math.atan2(pointToPoint.y,pointToPoint.x));degrees=_gliffy.Utils.radiansToDegrees(angle);mod=_gliffy.Utils.posMod(degrees,90);if(mod>(90-snapDegrees)||mod<snapDegrees){snapped=true;newDegrees=Math.floor(_gliffy.Utils.posMod(degrees+snapDegrees,360)/90)*90;pointToPoint=pointToPoint.rotate(_gliffy.Utils.degreesToRadians(newDegrees-degrees));curPoint=_gliffy.Vec2.sum(pointToPoint,opposingPoint)}}return{snapped:snapped,point:curPoint}},floatEquals:function(float1,float2,threshold){threshold=threshold||this.FLOAT_EQUALS_THRESHOLD;return Math.abs(float1-float2)<=threshold},floatToString:function(floatz,fixed){var result;if(isNaN(fixed)){fixed=this.FLOAT_FIXED}result=floatz.toFixed(fixed).replace(/\.?0+$/,"");return(result==="-0")?"0":result},boundingBoxToCss:function(boundingBox,zoom){var topLeft=new _gliffy.Vec2(boundingBox.min.x,boundingBox.min.y),dimension=boundingBox.getDimension();if(zoom!==undefined){dimension.scale(zoom);topLeft.scale(zoom)}return{left:topLeft.x+"px",top:topLeft.y+"px",width:dimension.x+"px",height:dimension.y+"px"}},stealFocus:function(){if($(document.activeElement).get(0)!==document.body){$("<textarea />").prependTo($("body")).focus().blur().remove()}},hsv2rgb:function(hsv){var h=hsv.hue,s=hsv.sat,v=hsv.val,rgb,i,data=[];if(s===0){rgb=[v,v,v]}else{h=h/60;i=Math.floor(h);data=[v*(1-s),v*(1-s*(h-i)),v*(1-s*(1-(h-i)))];switch(i){case 0:rgb=[v,data[2],data[0]];break;case 1:rgb=[data[1],v,data[0]];break;case 2:rgb=[data[0],v,data[2]];break;case 3:rgb=[data[0],data[1],v];break;case 4:rgb=[data[2],data[0],v];break;default:rgb=[v,data[0],data[1]];break}}return"#"+rgb.map(function(x){return("0"+Math.round(x*255).toString(16)).slice(-2)}).join("")},selectAllTextInElement:function(element){var range,selection;element=$(element);if(element.length>0){element=element.get(0);if(document.body.createTextRange){range=document.body.createTextRange();range.moveToElementText(element);range.select()}else{if(window.getSelection){selection=window.getSelection();range=document.createRange();range.selectNodeContents(element);selection.removeAllRanges();selection.addRange(range)}}}},getTextBoundingBox:function(element,offset){var range,rect;element=$(element);if(element.length>0){element=element.get(0);offset=offset||{x:0,y:0};if(document.createRange){range=document.createRange();range.selectNodeContents(element);if(range.getBoundingClientRect){rect=range.getBoundingClientRect();if(rect){return new _gliffy.BoundingBox((rect.left+offset.x),(rect.top+offset.y),(rect.right+offset.x),(rect.bottom+offset.y))}}}}return new _gliffy.BoundingBox()},setSnapToGrid:function(auto){this.__autoGrid=auto},shouldSnapToGrid:function(){if(this.__autoGrid){return _gliffy.KeyManager.shiftKeyDown?!GliffyApp.documentModel.snapToGrid:GliffyApp.documentModel.snapToGrid}else{return false}},hasNonWhitespaceCharacter:function(str){var pattern=/\S+/;return pattern.test(str)},removeLineBreaks:function(str){return str.replace(/(\r\n|\n|\r)/gm,"")},getLocalOffset:function(startPosition,endPosition,node){var localSpace=node.worldTransform.createInverse();return _gliffy.Vec2.difference(localSpace.transformPoint(endPosition.x,endPosition.y),localSpace.transformPoint(startPosition.x,startPosition.y))},isHorizontal:function(startPoint,endPoint){return Math.abs(startPoint.y-endPoint.y)<0.001},clamp:function(value,min,max){return(value<min)?min:((value>max)?max:value)},parseBoolean:function(str){return(/true/i.test(str))},capitalize:function(str){return str.replace(/\w\S*/g,function(txt){return txt.charAt(0).toUpperCase()+txt.substr(1).toLowerCase()})},capitalizeFirstWord:function(word){word=word.toLowerCase();return word.charAt(0).toUpperCase().concat(word.slice(1,word.length))},hashCode:function(string){var hash=0,i,char_;if(string.length===0){return hash}for(i=0;i<string.length;i++){char_=string.charCodeAt(i);hash=((hash<<5)-hash)+char_;hash=hash&hash}return hash},equalPoints:function(p1,p2,tolerance){if(tolerance===undefined){tolerance=0}if($.isArray(p1)&&$.isArray(p2)){return((Math.abs(p1[0]-p2[0])<=tolerance)&&Math.abs(p1[1]-p2[1])<=tolerance)}return false},drawBoundingBox:function(boundingBox,style,parentElement){var css=$.extend(style||{backgroundColor:"#ff0000",opacity:0.5},_gliffy.Utils.boundingBoxToCss(boundingBox)),div=$("<div></div>");css.position="absolute";css.padding="0px";css.margin="0px";css.zIndex=530000;$(parentElement||"#container").append(div.css(css));$(document).dblclick(function(){div.remove()})},drawPoint:function(point,style,parentElement){style=$.extend(style||{},{backgroundColor:"#ffffff",outline:"5px solid #000000",opacity:0.5});_gliffy.Utils.drawBoundingBox(new _gliffy.BoundingBox(point.x,point.y,point.x+1,point.y+1),style,parentElement)},pointToColor:function(point,min,max,invert){var xColor=Math.round((point.x-min)/(max-min)*255),yColor=Math.round((point.y-min)/(max-min)*255),prefix="#00";if(invert){xColor=255-xColor;yColor=255-yColor;prefix="#ff"}xColor=xColor.toString(16);if(xColor.length===1){xColor="0"+xColor}yColor=yColor.toString(16);if(yColor.length===1){yColor="0"+yColor}return prefix+xColor+yColor},getRenderedStyle:function($ele,requestedStyle){var style="",DOCUMENT_TYPE=9;while((style===""||style===undefined||style===null)&&($ele.length>0)&&$ele[0].nodeType!==DOCUMENT_TYPE){style=$ele.css(requestedStyle);$ele=$ele.parent()}return(style===undefined||style===null)?"":style},addDynamicStyle:function(styleString){$("#gliffy-dynamic-style").append(styleString)},notify:function(type,title,message,fadeOutTime,rightOffset,topOffset){var html,template;if(Handlebars&&$("#gliffy-notify-popup-template").length>0){template=Handlebars.compile($("#gliffy-notify-popup-template").html());html=template({type:type,title:title,message:message});$(html).appendTo("body");if(rightOffset){$("#gliffy-notify-popup").css("right",rightOffset)}if(topOffset){$("#gliffy-notify-popup").css("top",topOffset)}if(fadeOutTime){setTimeout(function(){$("#gliffy-notify-popup").fadeOut(1000,function(){$("#gliffy-notify-popup").alert("close")})},fadeOutTime)}}else{window.alert(title+"\n\n"+message)}},analyticsEvent:function(type,options){$(window).trigger(type+".gliffyAnalytics",options);$(window).trigger([type,options.category].join("-"),options);$(window).trigger([type,options.category,options.action].join("-"),options)},analyticsTimerStart:function(name,alsoProfile){_gliffy.Timer.start(name,alsoProfile)},analyticsTimerEnd:function(name){var time=_gliffy.Timer.end(name);_gliffy.Utils.analyticsEvent("trackEvent",{category:"time",action:name,value:time/1000,non_interaction:true})},sortJson:function(myObj){var keys=[],k,i,len,out;for(k in myObj){if(myObj.hasOwnProperty(k)){keys.push(k)}}keys.sort();len=keys.length;for(i=0;i<len;i++){k=keys[i];out+='"'+k+'":"'+myObj[k]+'"\n'}window.console.log(out)},createIframe:function(name,onReady){var iframe,contents;iframe=$("<iframe />",{src:"",name:name,id:name}).appendTo("body");contents=iframe.contents();if(contents&&contents.get(0).readyState==="complete"){onReady(iframe)}else{iframe.bind("load.preajax",function(){iframe.unbind("load.preajax");onReady(iframe)})}},iframeDownload:function(url,successCallback,errorCallback){var name="iframeDownload"+uidCounter;uidCounter++;this.createIframe(name,function(iframe){iframe.bind("load.ajax",function(){if(successCallback){successCallback()}iframe.unbind(".ajax");iframe.remove()});iframe.bind("error.ajax",function(){if(errorCallback){errorCallback()}iframe.unbind(".ajax");iframe.remove()});iframe.attr("src",url)})},iframeAjax:function(url,data,successCallback,errorCallback){var name="iframeAjax"+uidCounter;uidCounter++;this.createIframe(name,function(iframe){var form,key;iframe.bind("load.ajax",function(){if(successCallback){successCallback()}iframe.unbind(".ajax");iframe.remove()});iframe.bind("error.ajax",function(){if(errorCallback){errorCallback()}iframe.unbind(".ajax");iframe.remove()});form=$("<form/>",{method:"post",action:url,target:iframe.attr("id")});for(key in data){if(data.hasOwnProperty(key)){form.append($("<input/>",{type:"hidden",name:key,value:data[key]}))}}form.appendTo($("body"));form.submit();form.remove()})},isEnglish:function(editor){return(!editor.language||editor.language.indexOf("en")===0)},getImageUrlFromHtml:function(html){html=html.replace("'",'"');var match=/<img\s+(\S+\s+)*src="([^"]+)"/.exec(html);if(match){return match[2]}else{return null}},disableExportsForBeta:function(){$(".gliffy-filemenu-exportAsGXML").addClass("disabled")},enableExportsForBeta:function(){$(".gliffy-filemenu-exportAsGXML").removeClass("disabled");$(".gliffy-filemenu-exportAsSVG").removeClass("disabled")},firstInArray:function(arr){if(Array.isArray(arr)&&arr.length>0){return arr[0]}return null},compareVersionNumbers:function(v1,v2){var i,v1_array,v1_element,v2_array,v2_element;v1_array=typeof v1==="string"?v1.split("."):[v1];v2_array=typeof v2==="string"?v2.split("."):[v2];for(i=0;i<v1_array.length;++i){v1_element=parseInt(v1_array[i]);v2_element=parseInt(v2_array[i]);if(v2_array.length===i){return 1}if(v1_element===v2_element){continue}if(v1_element>v2_element){return 1}return -1}if(v1_array.length!=v2_array.length){return -1}return 0},getNthNode:function(n){n=n||0;return _gliffy.Mouse.documentManager.getActiveStage().objects[n]},getCommandHistory:function(){return _gliffy.Mouse.documentManager.getActiveStage().commandHistory},getI18nDictionary:function(){var dictionary,english,otherLanguage=null,missingKeys=[],checkMissingKeys=true;english=GLIFFY.DICTIONARY?(GLIFFY.DICTIONARY.en||{}):{};if(GLIFFY.DICTIONARY){$.each(GLIFFY.DICTIONARY,function(key,value){if(key!=="en"){otherLanguage=value;return false}})}if(otherLanguage){if(checkMissingKeys){$.each(english,function(key){if(!otherLanguage[key]){missingKeys.push(key)}});if(missingKeys.length!==0){_gliffy.Logger.log("Warning, missing keys: "+JSON.stringify(missingKeys))}}dictionary=$.extend({},english,otherLanguage)}else{dictionary=english}return dictionary},moveEmberView:function($src,$dest){$src.closest(".ember-view").detach().appendTo($dest)},setupAnimationDelay:function(){var __requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1000/60)};jQuery.fn.extend({animationDelay:function(type){type=type||"fx";return this.queue(type,function(next){__requestAnimationFrame(next)})}})},buildPointsPathFromDrawingCommand:function(drawingCommands){var path=[],p,point,lastPoint,currPath,points;if(drawingCommands===null||drawingCommands===undefined){throw new Error("path is null")}_.each(drawingCommands,function(drawPath){switch(drawPath.name){case"M":point=drawPath.args.split(",");path.push([{x:parseFloat(point[0]),y:parseFloat(point[1])}]);break;case"L":lastPoint=path[path.length-1][path[path.length-1].length-1];point=drawPath.args.split(",");path.push([lastPoint,{x:parseFloat(point[0]),y:parseFloat(point[1])}]);break;case"C":case"Q":lastPoint=path[path.length-1][path[path.length-1].length-1];currPath=[lastPoint];points=drawPath.args.split(" ");_.each(points,function(point){p=point.split(",");currPath.push({x:parseFloat(p[0]),y:parseFloat(p[1])})});path.push(currPath);break;default:throw"We don't currently support "+drawPath.name+" please add an implementation to candash.js"}});path.splice(0,1);return path},isUIDPartOfGliffySymbolLibrary:function(uid,libraryId){return(uid!==null&&uid.indexOf("com.gliffy.shape")===0&&libraryId.indexOf("com.gliffy.libraries")===0&&uid.indexOf(libraryId.substring("com.gliffy.libraries".length))>0)},forceUnicodeEncoding:function(string){return unescape(encodeURIComponent(string))}};_gliffy.Utils.forceMatrixOnly=_gliffy.BrowserDetect.browser==="Safari"&&_gliffy.BrowserDetect.version===5.1}());(function(){var __requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1000/60)},__frameRate,__tasks=[],__stop=true;function currentTime(){return(new Date()).getTime()/1000}function FrameRate(){this.__div=$("<div class='gliffy-frame-rate'>Computing fps...</div>");$("body").append(this.__div);this.__deltaTime=0;this.__currentTime=currentTime();this.__frame=0;this.update=function(){var newTime=currentTime(),display;this.__frame++;this.__deltaTime=newTime-this.__currentTime;if(this.__deltaTime>1){display=(this.__frame/this.__deltaTime).toFixed(1)+" fps";this.__div.html(display);this.__deltaTime=0;this.__frame=0;this.__currentTime=newTime}};this.remove=function(){this.__div.remove();this.__div=null}}function __runTasks(){var i;for(i=0;i<__tasks.length;i++){__tasks[i]()}}function __catchError(e){_gliffy.RenderLoop.stop();_gliffy.Logger.error("Render loop failed: "+e.message);_gliffy.handleError("com.gliffy.error.render_loop",[],e)}function __loop(){var i;if(!__stop){__requestAnimationFrame(__loop);for(i=0;i<__tasks.length;i++){if(!__stop){_gliffy.Utils.tryCatch(__runTasks,__catchError)}}if(__frameRate){__frameRate.update()}}}_gliffy.RenderLoop={start:function(){if(__stop===true&&!_gliffy.Debug.SKIP_RENDER_LOOP){__stop=false;__requestAnimationFrame(__loop)}},stop:function(){_gliffy.Logger.warn("Render loop was stopped.");__stop=true},appendTask:function(task){__tasks.push(task)},removeTask:function(task){var index=__tasks.indexOf(task);if(index!==-1){__tasks.splice(index,1)}},showFrameRate:function(){__frameRate=new FrameRate()},hideFrameRate:function(){__frameRate.remove();__frameRate=null},toggleFrameRate:function(){if(__frameRate){this.hideFrameRate()}else{this.showFrameRate()}}}}());(function(){_gliffy.Serializable=_gliffy.Class.extend({toObject:function(){var serialized=this.__toObject();if(serialized){return $.extend(true,{},serialized)}else{return null}},fromObject:function(object,opt){this.__fromObject($.extend(true,{},object),opt);return this},__toObject:function(){throw new Error("__toObject is not implemented!")},__fromObject:function(object){throw new Error("__fromObject is not implemented!")}});_gliffy.Serializable.polymorphicToObject=function(instance){var object={type:instance.getClassName()};object[instance.getClassName()]=instance.toObject();return object};_gliffy.Serializable.polymorphicFromObject=function(object,node){var instance=new _gliffy[object.type]();instance.node=node;instance.fromObject(object[object.type]);return instance}}());(function(){var __tempArray=[];_gliffy.BoundingBox=_gliffy.Serializable.extend({min:null,max:null,init:function(minX,minY,maxX,maxY){this.min=new _gliffy.Vec2(minX||0,minY||0);this.max=new _gliffy.Vec2(maxX||0,maxY||0)},growPoint:function(point){return this.grow(point.x,point.y)},grow:function(x,y){if(x<this.min.x){this.min.x=x}if(x>this.max.x){this.max.x=x}if(y<this.min.y){this.min.y=y}if(y>this.max.y){this.max.y=y}return this},extend:function(amount){this.min.x-=amount;this.min.y-=amount;this.max.x+=amount;this.max.y+=amount;if(amount<0){this.fit([this.min.x,this.min.y,this.max.x,this.max.y])}return this},add:function(boundingBox){this.grow(boundingBox.min.x,boundingBox.min.y);this.grow(boundingBox.max.x,boundingBox.max.y);return this},copy:function(boundingBox){this.min.x=boundingBox.min.x;this.min.y=boundingBox.min.y;this.max.x=boundingBox.max.x;this.max.y=boundingBox.max.y;return this},fitPoints:function(points){var i,x,y;x=points[0].x;y=points[0].y;this.min.x=x;this.max.x=x;this.min.y=y;this.max.y=y;for(i=1;i<points.length;i++){this.grow(points[i].x,points[i].y)}return this},fit:function(coords){var i,x,y;if(coords.length<2){throw new Error("The parameter coords must be an array of at lest 2 length.")}x=coords[0];y=coords[1];this.min.x=x;this.max.x=x;this.min.y=y;this.max.y=y;for(i=2;i<coords.length;i+=2){this.grow(coords[i],coords[i+1])}return this},clone:function(){return new _gliffy.BoundingBox(this.min.x,this.min.y,this.max.x,this.max.y)},transform:function(affineTransform){this.fit(this.__toRectangle(affineTransform));return this},intersects:function(boundingBox,affineTransform){if(affineTransform){boundingBox=boundingBox.clone().transform(affineTransform)}if(this.max.x<boundingBox.min.x||this.min.x>boundingBox.max.x||this.max.y<boundingBox.min.y||this.min.y>boundingBox.max.y){return false}else{return true}},boundingBoxInside:function(boundingBox,affineTransform){if(affineTransform){boundingBox=boundingBox.clone().transform(affineTransform)}return this.min.x<=boundingBox.min.x&&this.min.y<=boundingBox.min.y&&this.max.x>=boundingBox.max.x&&this.max.y>=boundingBox.max.y},inBoundingBox:function(containingBoundingBox){return(this.max.x>containingBoundingBox.min.x)&&(this.max.y>containingBoundingBox.min.y)&&(this.min.x<containingBoundingBox.max.x)&&(this.min.y<containingBoundingBox.max.y)},pointInside:function(x,y){return x>=this.min.x&&x<=this.max.x&&y>=this.min.y&&y<=this.max.y},pointDistance:function(x,y){var xDistance=0,yDistance=0;if(x<this.min.x){xDistance=x-this.min.x}else{if(x>this.max.x){xDistance=x-this.max.x}}if(y<this.min.y){yDistance=y-this.min.y}else{if(y>this.max.y){yDistance=y-this.max.y}}return new _gliffy.Vec2(xDistance,yDistance)},setMinMax:function(minX,minY,maxX,maxY){this.min.x=minX||0;this.min.y=minY||0;this.max.x=maxX||0;this.max.y=maxY||0;return this},setByCenter:function(center,dimension){var halfX=dimension.x/2,halfY=dimension.y/2;this.min.x=center.x-halfX;this.min.y=center.y-halfY;this.max.x=center.x+halfX;this.max.y=center.y+halfY},toString:function(){return"min("+_gliffy.Utils.floatToString(this.min.x)+","+_gliffy.Utils.floatToString(this.min.y)+") max("+_gliffy.Utils.floatToString(this.max.x)+","+_gliffy.Utils.floatToString(this.max.y)+")"},equals:function(boundingBox){if(boundingBox){return _gliffy.Utils.floatEquals(this.min.x,boundingBox.min.x)&&_gliffy.Utils.floatEquals(this.max.x,boundingBox.max.x)&&_gliffy.Utils.floatEquals(this.min.y,boundingBox.min.y)&&_gliffy.Utils.floatEquals(this.max.y,boundingBox.max.y)}else{return false}},getDimension:function(){return _gliffy.Vec2.difference(this.max,this.min)},getWidth:function(){return this.getDimension().x},getHeight:function(){return this.getDimension().y},getCenter:function(){return _gliffy.Vec2.lerp(this.max,this.min,0.5)},__toRectangle:function(affineTransform){__tempArray[0]=this.min.x;__tempArray[1]=this.min.y;__tempArray[2]=this.min.x;__tempArray[3]=this.max.y;__tempArray[4]=this.max.x;__tempArray[5]=this.max.y;__tempArray[6]=this.max.x;__tempArray[7]=this.min.y;affineTransform.transform(__tempArray,0,__tempArray,0,4);return __tempArray},fromClientRect:function(clientRect){this.min.x=clientRect.left;this.max.x=clientRect.right;this.min.y=clientRect.top;this.max.y=clientRect.bottom;return this},toCss:function(){return{left:this.min.x+"px",top:this.min.y+"px",width:this.getWidth()+"px",height:this.getHeight()+"px"}},isZeroSize:function(){return this.getWidth()===0&&this.getHeight()===0},__toObject:function(){return{min:{x:this.min.x,y:this.min.y},max:{x:this.max.x,y:this.max.y}}},__fromObject:function(o){if(o&&o.max&&o.min){this.min.x=o.min.x;this.min.y=o.min.y;this.max.x=o.max.x;this.max.y=o.max.y}}});_gliffy.BoundingBox.INFINITE=new _gliffy.BoundingBox(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);_gliffy.BoundingBox.SMALLEST=new _gliffy.BoundingBox(Number.MAX_VALUE,Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}());(function(){var _compositeColor=new _gliffy.RGBColor("#000000");var MAX_BYTE=255;_gliffy.ColorUtils={multiply:function(sourceColor,destColor){sourceColor=new _gliffy.RGBColor(sourceColor);destColor=new _gliffy.RGBColor(destColor);_compositeColor.r=Math.floor(sourceColor.r*destColor.r/MAX_BYTE);_compositeColor.g=Math.floor(sourceColor.g*destColor.g/MAX_BYTE);_compositeColor.b=Math.floor(sourceColor.b*destColor.b/MAX_BYTE);return _compositeColor.toHex()},generator:function(type,sourceColor){return function(){return function(destColor){return _gliffy.ColorUtils[type](sourceColor,destColor)}}}}}());(function(){function WindowMessage(nameSpace,domainFilter,targetWindowName){this.__nameSpace=nameSpace;this.__domainFilter=domainFilter;this.__targetWindowName=targetWindowName||null}WindowMessage.prototype.setDomainFilter=function(domainFilter){this.__domainFilter=domainFilter};WindowMessage.prototype.setNameSpace=function(nameSpace){this.__nameSpace=nameSpace};WindowMessage.prototype.setTargetWindowName=function(targetWindowName){this.__targetWindowName=targetWindowName||null};WindowMessage.prototype.getTargetWindow=function(){var frame=null;if(this.__targetWindowName!==null){if(typeof(this.__targetWindowName)==="string"){frame=window.frames[this.__targetWindowName]}else{frame={window:this.__targetWindowName}}}else{frame=window.parent}if(frame&&frame.postMessage){return frame}else{if(frame&&frame.window&&frame.window.postMessage){return frame.window}else{if(frame&&frame.contentWindow&&frame.contentWindow.postMessage){return frame.contentWindow}else{throw new Error("The frame "+this.__targetWindowName+" was not found.")}}}};WindowMessage.prototype.send=function(action,data){if(this.__domainFilter){this.getTargetWindow().postMessage(JSON.stringify({nameSpace:this.__nameSpace,action:action,data:data||null}),this.__domainFilter)}else{throw new Error("No domain filter was set.")}};WindowMessage.prototype.receive=function(action,callback){var self=this,listener;listener=function(event){if(event.source===self.getTargetWindow()&&event.data){var data=JSON.parse(event.data);if(data.nameSpace===self.__nameSpace&&data.action===action){callback(data.data);window.removeEventListener("message",listener,false);listener=null}}};window.addEventListener("message",listener,false)};window.GLIFFY=window.GLIFFY||{};window.GLIFFY.WindowMessage=WindowMessage}());(function(){var STENCIL_DEPENDENCIES={RGBColor:_gliffy.RGBColor,candash:_gliffy.candash};_gliffy.ShapeLibrary=_gliffy.Class.extend({init:function(options){var o=$.extend({},{rootServiceURL:"../api"},options);this.rootServiceURL=o.rootServiceURL;this.svgToStencilTransformURL=o.svgToStencilTransformURL;if(this.svgToStencilTransformURL===undefined||this.svgToStencilTransformURL===null){this.svgToStencilTransformURL=this.rootServiceURL+"/stencils/svg.json"}this.shapes={};this.templates={};this.custom_function={};this.svgDim={};this.svgStencil={};this.libraries={};this.shapeLibrariesDeferred=new $.Deferred();this.loaded=this.shapeLibrariesDeferred.promise();this.time=new Date().getTime();this.DEFAULT_ICON_HEIGHT=50;this.DEFAULT_ICON_WIDTH=50},setup:function(options){var o=$.extend({},{rootServiceURL:this.rootServiceURL,svgToStencilTransformURL:this.svgToStencilTransformURL},options);this.rootServiceURL=o.rootServiceURL;this.svgToStencilTransformURL=o.svgToStencilTransformURL},shapes:null,svgDim:null,templates:null,custom_function:null,markersLoaded:false,libraries:null,svgStencil:null,defaultLibraries:[],loadAll:function(){var i,DELAY_EVERY_N=100,self=this;for(i=0;i<window.GLIFFY_LIBRARIES.length;i++){_gliffy.workQueue.queue(function(i){return function(next){var library;if(window.GLIFFY_LIBRARIES){library=window.GLIFFY_LIBRARIES[i];self.libraries[library.uid]=library}next()}}(i));if(i%DELAY_EVERY_N===0){_gliffy.workQueue.delay(1)}}_gliffy.workQueue.delay(1);for(i=0;i<window.GLIFFY_SHAPES.length;i++){_gliffy.workQueue.queue(function(i){return function(next){var shape;if(window.GLIFFY_SHAPES){var shape=window.GLIFFY_SHAPES[i];self.addShape(shape)}next()}}(i));if(i%DELAY_EVERY_N===0){_gliffy.workQueue.delay(1)}}_gliffy.workQueue.delay(1);for(i=0;i<window.GLIFFY_STENCILS.length;i++){_gliffy.workQueue.queue(function(i){return function(next){var stencil;if(window.GLIFFY_STENCILS){stencil=window.GLIFFY_STENCILS[i];self.__addStencil(stencil)}next()}}(i));if(i%DELAY_EVERY_N===0){_gliffy.workQueue.delay(1)}}_gliffy.workQueue.queue(function(next){window.GLIFFY_LIBRARIES=null;window.GLIFFY_SHAPES=null;window.GLIFFY_STENCILS=null;self.shapeLibrariesDeferred.resolve();next()})},loadSvgStencil:function(svg,resource,useDefaultFailHandler){var url=this.svgToStencilTransformURL,self=this,defer;if(!this.svgStencil[svg]){defer=$.Deferred();$.ajax({url:url,type:"POST",data:svg,dataType:"json",contentType:"application/svg+xml; charset=utf-8",traditional:true}).pipe(function(data){return data},function(xhr,text,error){defer.reject(xhr.responseText)}).then(function(data){try{self.templates[svg]=new Function("ctx","data","_gliffy",data.template);self.svgDim[svg]={width:parseFloat(data.width),height:parseFloat(data.height),x:parseFloat(data.x),y:parseFloat(data.y)};if(resource){resource.setX(parseFloat(data.x));resource.setY(parseFloat(data.y));resource.setWidth(parseFloat(data.width));resource.setHeight(parseFloat(data.height))}defer.resolve(data)}catch(e){var message="200, but failed to load svg:"+e+" ";if(e.stack!==undefined){message+="Stack: ["+e.stack+"]\n\n"}_gliffy.Logger.warn(message);defer.reject(svg)}});this.svgStencil[svg]=defer.promise()}if(useDefaultFailHandler){return this.svgStencil[svg].fail(function(xhr,text,error){_gliffy.Logger.warn("failed to load svg: "+svg);_gliffy.handleError("com.gliffy.error.stencil_load",[url],new Error(xhr.responseText))})}else{return this.svgStencil[svg]}},loadLibraries:function(libraryArray){var url=this.rootServiceURL+"/libraries.json?locale=en",i,libraries=[],promise,self=this;libraryArray=libraryArray||[];for(i=0;i<libraryArray.length;i++){if(libraryArray[i].indexOf("com.gliffy.libraries")===-1&&!this.libraries[libraryArray[i]]){libraries.push(libraryArray[i])}}if(libraries.length>0){promise=$.Deferred(function(defer){$.ajax({url:url,type:"POST",data:JSON.stringify(libraries),dataType:"json",contentType:"application/json; charset=utf-8",traditional:true}).then(function(data){for(i=0;i<data.libraries.length;i++){self.libraries[data.libraries[i].uid]=data.libraries[i]}defer.resolve()},defer.fail)}).promise();return $.when(promise,this.loaded).promise()}else{return this.loaded}},canDrawStencil:function(tid){return this.templates[tid]!==undefined},drawStencil:function(tid,ctx,data){if(this.canDrawStencil(tid)){this.templates[tid](ctx,data,STENCIL_DEPENDENCIES)}else{_gliffy.Logger.warn("Attempted to draw stencil "+tid+" but was not available")}},customFunction:function(tid,data){if(this.custom_function[tid]!==undefined&&this.custom_function[tid]!==null){this.custom_function[tid](data,STENCIL_DEPENDENCIES)}},__addStencil:function(stencil){var self=this;if(!self.templates[stencil.tid]){if(stencil.cfb){self.custom_function[stencil.tid]=new Function("data","_gliffy",stencil.cfb)}self.templates[stencil.tid]=new Function("ctx","data","_gliffy",stencil.template)}},addShape:function(shape){this.shapes[shape.uid]=shape},getShape:function(uid){var self=this;if(self.shapes[uid]){return self.shapes[uid]}return null},addDefaultLibrary:function(uid){if(uid&&this.defaultLibraries.indexOf(uid)===-1){this.defaultLibraries.push(uid)}},getShapePreview:function(library){var shapePreview={},shape;if(library&&library.shapes&&library.shapes[0]&&library.hasOwnProperty("largestShapeIndex")){shape=_gliffy.shapeLibrary.shapes[library.shapes[library.largestShapeIndex]];if(shape){shapePreview=shape.preview}}else{if(library&&library.shapes&&library.shapes[0]){shapePreview=_gliffy.shapeLibrary.shapes[library.shapes[0]].preview}}if(!shapePreview.hasOwnProperty("iconWidth")){shapePreview.iconWidth=_gliffy.shapeLibrary.DEFAULT_ICON_WIDTH;shapePreview.iconHeight=_gliffy.shapeLibrary.DEFAULT_ICON_HEIGHT}return shapePreview},EXISTING_SHAPE_UID_TO_LIBRARY_MAP:{"com.gliffy.shape.basic.basic_v1.default":["com.gliffy.libraries.basic.basic_v1.default"],"com.gliffy.shape.basic.basic_v2.default":["com.gliffy.libraries.basic.basic_v2.default"],"com.gliffy.shape.bpmn.bpmn_v1.activities":["com.gliffy.libraries.bpmn.bpmn_v1.events","com.gliffy.libraries.bpmn.bpmn_v1.data_artifacts","com.gliffy.libraries.bpmn.bpmn_v1.activities","com.gliffy.libraries.bpmn.bpmn_v1.connectors","com.gliffy.libraries.bpmn.bpmn_v1.gateways"],"com.gliffy.shape.bpmn.bpmn_v1.connectors":["com.gliffy.libraries.bpmn.bpmn_v1.events","com.gliffy.libraries.bpmn.bpmn_v1.data_artifacts","com.gliffy.libraries.bpmn.bpmn_v1.activities","com.gliffy.libraries.bpmn.bpmn_v1.connectors","com.gliffy.libraries.bpmn.bpmn_v1.gateways"],"com.gliffy.shape.bpmn.bpmn_v1.data_artifacts":["com.gliffy.libraries.bpmn.bpmn_v1.events","com.gliffy.libraries.bpmn.bpmn_v1.data_artifacts","com.gliffy.libraries.bpmn.bpmn_v1.activities","com.gliffy.libraries.bpmn.bpmn_v1.connectors","com.gliffy.libraries.bpmn.bpmn_v1.gateways"],"com.gliffy.shape.bpmn.bpmn_v1.events":["com.gliffy.libraries.bpmn.bpmn_v1.events","com.gliffy.libraries.bpmn.bpmn_v1.data_artifacts","com.gliffy.libraries.bpmn.bpmn_v1.activities","com.gliffy.libraries.bpmn.bpmn_v1.connectors","com.gliffy.libraries.bpmn.bpmn_v1.gateways"],"com.gliffy.shape.bpmn.bpmn_v1.gateways":["com.gliffy.libraries.bpmn.bpmn_v1.events","com.gliffy.libraries.bpmn.bpmn_v1.data_artifacts","com.gliffy.libraries.bpmn.bpmn_v1.activities","com.gliffy.libraries.bpmn.bpmn_v1.connectors","com.gliffy.libraries.bpmn.bpmn_v1.gateways"],"com.gliffy.shape.erd.erd_v1.default":["com.gliffy.libraries.erd.erd_v1.default"],"com.gliffy.shape.floorplan.floorplan_v1.default":["com.gliffy.libraries.floorplan.floorplan_v2.structure","com.gliffy.libraries.floorplan.floorplan_v2.bathroom","com.gliffy.libraries.floorplan.floorplan_v2.bedroom","com.gliffy.libraries.floorplan.floorplan_v2.dining_room","com.gliffy.libraries.floorplan.floorplan_v2.kitchen","com.gliffy.libraries.floorplan.floorplan_v2.living_room","com.gliffy.libraries.floorplan.floorplan_v2.miscellaneous","com.gliffy.libraries.floorplan.floorplan_v2.office"],"com.gliffy.shape.floorplan.floorplan_v2.structure":["com.gliffy.libraries.floorplan.floorplan_v2.structure","com.gliffy.libraries.floorplan.floorplan_v2.bathroom","com.gliffy.libraries.floorplan.floorplan_v2.bedroom","com.gliffy.libraries.floorplan.floorplan_v2.dining_room","com.gliffy.libraries.floorplan.floorplan_v2.kitchen","com.gliffy.libraries.floorplan.floorplan_v2.living_room","com.gliffy.libraries.floorplan.floorplan_v2.miscellaneous","com.gliffy.libraries.floorplan.floorplan_v2.office"],"com.gliffy.shape.floorplan.floorplan_v2.bathroom":["com.gliffy.libraries.floorplan.floorplan_v2.structure","com.gliffy.libraries.floorplan.floorplan_v2.bathroom","com.gliffy.libraries.floorplan.floorplan_v2.bedroom","com.gliffy.libraries.floorplan.floorplan_v2.dining_room","com.gliffy.libraries.floorplan.floorplan_v2.kitchen","com.gliffy.libraries.floorplan.floorplan_v2.living_room","com.gliffy.libraries.floorplan.floorplan_v2.miscellaneous","com.gliffy.libraries.floorplan.floorplan_v2.office"],"com.gliffy.shape.floorplan.floorplan_v2.bedroom":["com.gliffy.libraries.floorplan.floorplan_v2.structure","com.gliffy.libraries.floorplan.floorplan_v2.bathroom","com.gliffy.libraries.floorplan.floorplan_v2.bedroom","com.gliffy.libraries.floorplan.floorplan_v2.dining_room","com.gliffy.libraries.floorplan.floorplan_v2.kitchen","com.gliffy.libraries.floorplan.floorplan_v2.living_room","com.gliffy.libraries.floorplan.floorplan_v2.miscellaneous","com.gliffy.libraries.floorplan.floorplan_v2.office"],"com.gliffy.shape.floorplan.floorplan_v2.dining_room":["com.gliffy.libraries.floorplan.floorplan_v2.structure","com.gliffy.libraries.floorplan.floorplan_v2.bathroom","com.gliffy.libraries.floorplan.floorplan_v2.bedroom","com.gliffy.libraries.floorplan.floorplan_v2.dining_room","com.gliffy.libraries.floorplan.floorplan_v2.kitchen","com.gliffy.libraries.floorplan.floorplan_v2.living_room","com.gliffy.libraries.floorplan.floorplan_v2.miscellaneous","com.gliffy.libraries.floorplan.floorplan_v2.office"],"com.gliffy.shape.floorplan.floorplan_v2.kitchen":["com.gliffy.libraries.floorplan.floorplan_v2.structure","com.gliffy.libraries.floorplan.floorplan_v2.bathroom","com.gliffy.libraries.floorplan.floorplan_v2.bedroom","com.gliffy.libraries.floorplan.floorplan_v2.dining_room","com.gliffy.libraries.floorplan.floorplan_v2.kitchen","com.gliffy.libraries.floorplan.floorplan_v2.living_room","com.gliffy.libraries.floorplan.floorplan_v2.miscellaneous","com.gliffy.libraries.floorplan.floorplan_v2.office"],"com.gliffy.shape.floorplan.floorplan_v2.living_room":["com.gliffy.libraries.floorplan.floorplan_v2.structure","com.gliffy.libraries.floorplan.floorplan_v2.bathroom","com.gliffy.libraries.floorplan.floorplan_v2.bedroom","com.gliffy.libraries.floorplan.floorplan_v2.dining_room","com.gliffy.libraries.floorplan.floorplan_v2.kitchen","com.gliffy.libraries.floorplan.floorplan_v2.living_room","com.gliffy.libraries.floorplan.floorplan_v2.miscellaneous","com.gliffy.libraries.floorplan.floorplan_v2.office"],"com.gliffy.shape.floorplan.floorplan_v2.miscellaneous":["com.gliffy.libraries.floorplan.floorplan_v2.structure","com.gliffy.libraries.floorplan.floorplan_v2.bathroom","com.gliffy.libraries.floorplan.floorplan_v2.bedroom","com.gliffy.libraries.floorplan.floorplan_v2.dining_room","com.gliffy.libraries.floorplan.floorplan_v2.kitchen","com.gliffy.libraries.floorplan.floorplan_v2.living_room","com.gliffy.libraries.floorplan.floorplan_v2.miscellaneous","com.gliffy.libraries.floorplan.floorplan_v2.office"],"com.gliffy.shape.floorplan.floorplan_v2.office":["com.gliffy.libraries.floorplan.floorplan_v2.structure","com.gliffy.libraries.floorplan.floorplan_v2.bathroom","com.gliffy.libraries.floorplan.floorplan_v2.bedroom","com.gliffy.libraries.floorplan.floorplan_v2.dining_room","com.gliffy.libraries.floorplan.floorplan_v2.kitchen","com.gliffy.libraries.floorplan.floorplan_v2.living_room","com.gliffy.libraries.floorplan.floorplan_v2.miscellaneous","com.gliffy.libraries.floorplan.floorplan_v2.office"],"com.gliffy.shape.flowchart.flowchart_v1.default":["com.gliffy.libraries.flowchart.flowchart_v1.default"],"com.gliffy.shape.flowchart.flowchart_v2.default":["com.gliffy.libraries.flowchart.flowchart_v2.default"],"com.gliffy.shape.network.network_v1.default":["com.gliffy.libraries.network.network_v3.business","com.gliffy.libraries.network.network_v3.home","com.gliffy.libraries.network.network_v3.rack"],"com.gliffy.shape.network.network_v2.business":["com.gliffy.libraries.network.network_v3.business"],"com.gliffy.shape.network.network_v2.home":["com.gliffy.libraries.network.network_v3.home"],"com.gliffy.shape.network.network_v2.rack":["com.gliffy.libraries.network.network_v3.rack"],"com.gliffy.shape.network.network_v3.business":["com.gliffy.libraries.network.network_v3.business"],"com.gliffy.shape.network.network_v3.home":["com.gliffy.libraries.network.network_v3.home"],"com.gliffy.shape.network.network_v3.rack":["com.gliffy.libraries.network.network_v3.rack"],"com.gliffy.shape.sitemap.sitemap_v1.default":["com.gliffy.libraries.sitemap.sitemap_v1.default"],"com.gliffy.shape.sitemap.sitemap_v2":["com.gliffy.libraries.sitemap.sitemap_v2"],"com.gliffy.shape.swimlanes.swimlanes_v1.default":["com.gliffy.libraries.swimlanes.swimlanes_v1.default"],"com.gliffy.shape.ui.ui_v1.default":["com.gliffy.libraries.ui.ui_v2.content","com.gliffy.libraries.ui.ui_v2.forms_components","com.gliffy.libraries.ui.ui_v2.miscellaneous"],"com.gliffy.shape.ui.ui_v2.content":["com.gliffy.libraries.ui.ui_v2.content","com.gliffy.libraries.ui.ui_v2.forms_components","com.gliffy.libraries.ui.ui_v2.miscellaneous"],"com.gliffy.shape.ui.ui_v2.forms_components":["com.gliffy.libraries.ui.ui_v2.content","com.gliffy.libraries.ui.ui_v2.forms_components","com.gliffy.libraries.ui.ui_v2.miscellaneous"],"com.gliffy.shape.ui.ui_v2.miscellaneous":["com.gliffy.libraries.ui.ui_v2.content","com.gliffy.libraries.ui.ui_v2.forms_components","com.gliffy.libraries.ui.ui_v2.miscellaneous"],"com.gliffy.shape.uml.uml_v1.default":["com.gliffy.libraries.uml.uml_v1.default","com.gliffy.libraries.uml.uml_v2.class","com.gliffy.libraries.uml.uml_v2.sequence","com.gliffy.libraries.uml.uml_v2.activity","com.gliffy.libraries.uml.uml_v2.state_machine","com.gliffy.libraries.uml.uml_v2.component","com.gliffy.libraries.uml.uml_v2.deployment","com.gliffy.libraries.uml.uml_v2.use_case"],"com.gliffy.shape.venn.flat.default":["com.gliffy.libraries.venn.flat.default"],"com.gliffy.shape.venn.outline.default":["com.gliffy.libraries.venn.outline.default"],"com.gliffy.shape.venn.radial.default":["com.gliffy.libraries.venn.radial.default"]}});_gliffy.shapeLibrary=new _gliffy.ShapeLibrary({rootServiceURL:"../api"})}());(function(){_gliffy._Timer=_gliffy.Class.extend({_timers:null,_profileActive:false,init:function(){this._timers={}},start:function(name,shouldProfile){if(this._timers[name]!==undefined){_gliffy.Logger.log("Warning, overriding existing timer.")}this._timers[name]={startTime:(new Date()).getTime(),profile:shouldProfile===true};if(shouldProfile&&console&&console.profile){if(this._profileActive){_gliffy.Logger.log("Only one profile can be active at a time")}else{console.profile(name)}}},end:function(name){var timer=this._timers[name],timeMs=0;if(timer===undefined){_gliffy.Logger.log("Warning: timer does not exist: "+name)}else{timeMs=(new Date()).getTime()-timer.startTime;if(timer.profile&&console&&console.profile){console.profileEnd();this._profileActive=false}delete this._timers[name]}return timeMs},hasTimer:function(name){return this._timers[name]!==undefined}});_gliffy.Timer=new _gliffy._Timer()}());(function(){var _tempBB=new _gliffy.BoundingBox();function __sort(node1,node2){return node2.getOrder()-node1.getOrder()}_gliffy.Tree={tree:new _gliffy.RTree(5000),debugClear:function(){if(_gliffy.Debug.SHOW_RTREE||_gliffy.Debug.SHOW_LAYERS){$(".gliffy-stage").find(".rtree").remove();if($(".gliffy-stage").find(".gliffy-shift-notify").length===0){$(".gliffy-stage").append('<div class="gliffy-shift-notify" style="color:white;background-color:black">hold ctrl/cmd key down to show groups/selections for rtree/layers.</div>')}}},clear:function(){this.tree=new _gliffy.RTree(5000);this.debugClear()},searchPoint:function(x,y,padding){var rect=padding?{x:x-padding,y:y-padding,w:padding*2,h:padding*2}:{x:x,y:y,w:0,h:0};return this.tree.search(rect)},searchSelection:function(bb){var rect=this.createRectFromBB(bb);return this.tree.search(rect)},createRect:function(node,grow){if(node.parent===null&&(node.isSelection()||node.isGroup()||node.isStandAloneText()||node.isMultipartShape())){return this.createRectFromNode(node)}else{return this.createRectFromBB(node.worldOverlayAabb,grow)}},createRectFromBB:function(bb,grow){if(grow){bb=bb.clone().extend(grow)}var d=bb.getDimension(),rect={x:Math.max(bb.min.x,0),y:Math.max(bb.min.y,0),w:d.x,h:d.y};if(bb.min.x<0){rect.w+=bb.min.x}if(bb.min.y<0){rect.h+=bb.min.y}return rect},createRectFromNode:function(node){var rect={x:Math.max(node.getX(),0),y:Math.max(node.getY(),0),w:node.getWidth(),h:node.getHeight()},bb,dim;if(node.getX()<0){rect.w+=node.getX()}if(node.getY()<0){rect.h+=node.getY()}if(node.getRotation()>0){bb=new _gliffy.BoundingBox(0,0,rect.w,rect.h);bb.transform(node.worldTransform);dim=bb.getDimension();return{x:bb.min.x,y:bb.min.y,w:dim.x,h:dim.y}}else{return rect}},debugAdd:function(node,rect){var border,info,activeLayersDisplay=null;if(_gliffy.Debug.SHOW_RTREE||_gliffy.Debug.SHOW_LAYERS){if(_gliffy.Debug.SHOW_RTREE&&_gliffy.Debug.SHOW_LAYERS){_gliffy.Logger.error("cannot show rtree and layers.  pick one or the other!")}border="1px solid red";if(node.isSelection()){border="1px dotted blue"}else{if(node.isGroup()){border="1px dotted green"}}if(node.getActiveLayers()){activeLayersDisplay=_.map(node.getActiveLayers(),function(layer){return layer.getOrder()}).join(",")}info=node.getId()+" L:"+(activeLayersDisplay?activeLayersDisplay:"?");info+=" O:"+node.getOrder()+" "+node.getUid();if(!node.isText()){$(".gliffy-stage").append($("<div/>",{id:"rtree"+node.getId(),"class":"rtree"}).css({top:rect.y,left:rect.x,width:rect.w,height:rect.h,background:_gliffy.Debug.SHOW_RTREE?"green":"transparent",border:border,position:"absolute",opacity:_gliffy.Debug.SHOW_RTREE?0.25:1,zIndex:519900,pointerEvents:"none"}).text(info));if(node.isSelection()||node.isGroup()){$("#rtree"+node.getId()).addClass("rtree-group")}else{$("#rtree"+node.getId()).addClass("rtree-single")}}}},add:function(node,addChildren){var i,rect,grow;if(node.isSelectable()&&node.getId()!==null){if(node.getGraphic()&&node.getGraphic().getStrokeWidth){grow=node.getGraphic().getStrokeWidth()}rect=this.createRect(node,grow);this.debugAdd(node,rect);this.tree.insert(rect,""+node.getId());if(addChildren&&node.children&&node.children.length>0){for(i=0;i<node.children.length;i++){this.add(node.children[i],addChildren)}}}},debugRemove:function(node){if(_gliffy.Debug.SHOW_RTREE||_gliffy.Debug.SHOW_LAYERS){$(".gliffy-stage").find("#rtree"+node.getId()).remove()}},remove:function(node,removeChildren){var rect=this.createRect(node),removed,i;removed=this.tree.remove(rect,""+node.getId());this.debugRemove(node);if(!removed||removed.length===0){this.tree.remove({x:0,y:0,w:5000,h:5000},""+node.getId())}if(removeChildren&&node.children&&node.children.length>0){for(i=0;i<node.children.length;i++){this.remove(node.children[i],removeChildren)}}}};_gliffy.Pick={pickAllNodesInside:function(nodes,boundingBox,options){var o=$.extend({},{excludeUnpickableNodes:false},options),result;if(o.excludeUnpickableNodes){nodes=this.__removeUnpickableNodes(nodes)}result=this.__pickAllNodesInsideTree(nodes,boundingBox);return result},pickAllNodesPartiallyInside:function(nodes,boundingBox,options){var o=$.extend({},{excludeUnpickableNodes:false},options),result;if(o.excludeUnpickableNodes){nodes=this.__removeUnpickableNodes(nodes)}result=this.__pickAllNodesPartiallyInsideTree(nodes,boundingBox);return result},pickAllNodesAt:function(nodes,x,y,padding,options){var o=$.extend({},{excludeUnpickableNodes:false},options),result;if(o.excludeUnpickableNodes){nodes=this.__removeUnpickableNodes(nodes)}result=this.__pickAllNodesAtTree(nodes,x,y,padding);return result},selectNodesInclusive:function(nodes,boundingBox,options){var o=$.extend({},{excludeUnpickableNodes:false},options),i,search,node,result=[],stage;if(o.excludeUnpickableNodes){nodes=this.__removeUnpickableNodes(nodes)}if(nodes.length>0){stage=nodes.length>0?nodes[0].stage:null;if(stage){search=_gliffy.Tree.searchSelection(boundingBox);for(i=0;i<search.length;i++){node=stage.find(search[i]);if(node){result.push(node)}}result=$.grep(result,function(n,i){return $.inArray(n,nodes)!==-1});result.sort(__sort)}}return result},__removeUnpickableNodes:function(nodes){var pickableNodes;pickableNodes=_.select(nodes,function(node){return node.isPickable()});return pickableNodes},__pickAllNodesInsideTree:function(nodes,boundingBox){var i,search,node,result=[],stage;if(nodes.length>0){stage=nodes.length>0?nodes[0].stage:null;if(stage){search=_gliffy.Tree.searchSelection(boundingBox);for(i=0;i<search.length;i++){node=stage.find(search[i]);if(node&&this.isNodeInside(node,boundingBox)){result.push(node)}}result=$.grep(result,function(n,i){return $.inArray(n,nodes)!==-1});result.sort(__sort)}}return result},__pickAllNodesPartiallyInsideTree:function(nodes,boundingBox){var i,search,node,result=[],stage;if(nodes.length>0){stage=nodes.length>0?nodes[0].stage:null;if(stage){search=_gliffy.Tree.searchSelection(boundingBox);for(i=0;i<search.length;i++){node=stage.find(search[i]);if(node&&this.isNodePartiallyInside(node,boundingBox)){result.push(node)}}result=$.grep(result,function(n,i){return $.inArray(n,nodes)!==-1});result.sort(__sort)}}return result},__pickAllNodesInsideLinear:function(nodes,boundingBox){var i,node,result=[];for(i=0;i<nodes.length;i++){node=nodes[i];if(this.isNodeInside(node,boundingBox)){result.push(node)}}result.sort(__sort);return result},__isNodePicked:function(child,x,y,padding){if(child.getGraphic() instanceof _gliffy.Text){if(this.isNodePicked(child,x-child.getGraphic().style.x,y-child.getGraphic().style.y,padding)){return child}}else{if(this.isNodePicked(child,x,y,padding)){return child}}return null},__pickAllNodesAtLinear:function(nodes,x,y,padding){var i,j,k,node,child,child2,result=[];for(i=0;i<nodes.length;i++){node=nodes[i];if(node.children){for(j=0;j<node.children.length;j++){child=node.children[j];if(this.__isNodePicked(child,x,y,padding)){result.push(child)}for(k=0;child.children&&k<child.children.length;k++){child2=child.children[k];if(this.__isNodePicked(child2,x,y,padding)){result.push(child2)}}}}if(this.isNodePicked(node,x,y,padding)){result.push(node)}}result.sort(__sort);return result},flattenNodes:function(objects){var nodes=[],i;for(i=0;i<objects.length;i++){this.__preorder(objects[i],nodes)}return nodes},__preorder:function(node,array,forceUpdate){var c;if(!node){return}array.push(node);for(c=0;node.children&&c<node.children.length;c++){this.__preorder(node.children[c],array,forceUpdate)}},__pickAllNodesAtTree:function(nodes,x,y,padding){var i,search,node,result=[],flattenedNodes,stage,filter;if(nodes.length>0){stage=nodes.length>0?nodes[0].stage:null;if(stage!==null){filter=stage&&!(nodes.length===stage.objects.length&&nodes[0].getId()===stage.objects[0].getId()&&nodes[nodes.length-1].getId()===stage.objects[stage.objects.length-1].getId());search=_gliffy.Tree.searchPoint(x,y,padding);for(i=0;i<search.length;i++){node=stage.find(search[i]);if(node&&this.__isNodePicked(node,x,y,Math.max(padding,5))){result.push(node)}}if(filter){flattenedNodes=this.flattenNodes(nodes);result=$.grep(result,function(n,i){return $.inArray(n,flattenedNodes)!==-1})}result.sort(__sort)}}return result},pickFirstTextChildNode:function(nodes,x,y){var i,node;if(nodes){nodes=this.pickAllNodesAt(nodes,x,y,0);for(i=0;i<nodes.length;i++){if(nodes[i].isTextChild()){return nodes[i]}}}return null},isNodePicked:function(node,x,y,padding){var point;if(node.isSelectable()){point=node.worldTransform.createInverse().transformPoint(x,y);if(padding){return _tempBB.copy(node.aabb).extend(padding).pointInside(point.x,point.y)}else{return node.aabb.pointInside(point.x,point.y)}}else{return false}},isNodeInside:function(node,boundingBox){return boundingBox.boundingBoxInside(node.worldOverlayAabb)},isNodePartiallyInside:function(node,boundingBox){return boundingBox.inBoundingBox(node.worldOverlayAabb)},shouldBeSelected:function(node,x,y){return this.getAlphaAtPixel(node,x,y)>0||node.getGraphic() instanceof _gliffy.Text||node.getShapeInformation().boundingBoxSelect||node.getUid()===null},nearEdge:function(node,x,y){var bb=node.worldAabb.clone(),diff=10;if(Math.abs(bb.min.x-x)<diff){return true}else{if(Math.abs(bb.max.x-x)<diff){return true}else{if(Math.abs(bb.min.y-y)<diff){return true}else{if(Math.abs(bb.max.y-y)<diff){return true}}}}return false},_hasText:function(nodes){var i;for(i=0;i<nodes.length;i++){if(nodes[i].getGraphic() instanceof _gliffy.Text){return true}}return false},getNodeAt:function(nodes,x,y,options){return this.getNodeAtExt(nodes,x,y,options).node},getNodeAtExt:function(nodes,x,y,options){var i,node,parent,group,swimlaneNodes,tmp,bestSoFar=null,o=$.extend({},{doNotIncludeGroup:false,subNodeSelection:false,excludeUnpickableNodes:false},options);if(o.excludeUnpickableNodes){nodes=this.__removeUnpickableNodes(nodes)}if(nodes){nodes=this.pickAllNodesAt(nodes,x,y,0);for(i=0;i<nodes.length;i++){node=nodes[i];if(!node.isSwimlane()&&!node.isIcon()){if(this.shouldBeSelected(node,x,y)){if(node.getUid()===null){parent=node.getUidNode();if(parent&&parent.isSwimlane()&&parent.children){swimlaneNodes=this.pickAllNodesAt(parent.children,x,y,10);if(this._hasText(swimlaneNodes)){tmp=parent}else{if(swimlaneNodes.length>0&&swimlaneNodes[0].getGraphic()&&this.nearEdge(node,x,y)){tmp=parent}else{node=null}}}else{tmp=parent}}if(node){if(!o.doNotIncludeGroup){group=node.topGroup()}if(group&&node.getId()!==group.getId()){tmp=group}else{if(node.getUid()===null&&!o.subNodeSelection){tmp=parent}else{tmp=node}}if((node.getShapeInformation().boundingBoxSelect&&!(node.getShapeInformation().defaults&&node.getShapeInformation().defaults.isContainer))||node.getGraphic() instanceof _gliffy.Text||node.isMultipartShape()||this.isNodeOpaqueAt(node,x,y)||node.isSelection()){return{node:tmp,textChild:(node.isTextChild()?node:null)}}bestSoFar=bestSoFar||tmp}}}}}return{node:bestSoFar,textChild:null}},getAlphaAtPixel:function(node,x,y){var element,alphaAtPixel,point,scale,ctx=null;element=node.getDomElement();if(element){if(element.is("canvas")){ctx=element[0].getContext("2d")}else{if(element.is("img")){ctx=element.data("ctx")}}if(ctx){scale=element.data("scale");point=element.data("transform").createInverse().transformPoint(x*scale,y*scale);alphaAtPixel=ctx.getImageData(point.x,point.y,1,1).data[3]}return alphaAtPixel}return 0},isNodeOpaqueAt:function(node,x,y){if(node.isLine()){return this.getAlphaAtPixel(node,x,y)>0}else{return this.getAlphaAtPixel(node,x,y)>_gliffy.MIN_VISIBLE_VALUE||node.getGraphic() instanceof _gliffy.Text}},pickConnectionPoint:function(node,point,radius){var i,connectionPoint,closest=null,closestDist;if(node.supportsConnections()){radius*=radius;closestDist=radius;for(i=0;i<node.getConnections().length;i++){connectionPoint=node.getConnectionPoint(i);var currentDist=_gliffy.Vec2.squaredDistance(connectionPoint,point);if(currentDist<closestDist){closest=i;closestDist=currentDist}}}return closest}}}());(function(){var _unrenderedTemplates=[],_queued=false;_gliffy.Components={__render:function(){var render,unrenderedTemplates=_unrenderedTemplates;_unrenderedTemplates=[];while((render=unrenderedTemplates.pop())!==undefined){render()}if(unrenderedTemplates.length!==0){GLIFFY.Components.__deferredRender()}},__deferredRender:function(){if(_queued!==true){setTimeout(function(){_queued=false;GLIFFY.Components.__render()},1000/10);_queued=true}},appendTemplate:function(templateName,parent){parent=parent||"#gliffy";if($(parent).length>0){Ember.View.create({templateName:templateName}).appendTo(parent)}else{_unrenderedTemplates.push(function(){GLIFFY.Components.appendTemplate(templateName,parent)});GLIFFY.Components.__deferredRender()}},renderTemplate:function(templateName,container){if($(container).length>0){$(container).html("");Ember.View.create({templateName:templateName}).appendTo(container)}else{_unrenderedTemplates.push(function(){GLIFFY.Components.renderTemplate(templateName,container)});GLIFFY.Components.__deferredRender()}}}}());(function(){var _plugins=[],_activePlugins={},_id=0,_Plugin;_Plugin=_gliffy.Class.extend({activate:function(editor){},deactivate:function(){},isActive:function(){return _gliffy.Plugins.isActive(this.getName())},initTemplates:function(){_gliffy.Plugins.initTemplates(this.getTemplateNames())},getTemplateNames:function(){return[]},getName:function(){throw new Error("Please implement getName!")},addToolbarButton:function(actionName,title,className,id){var self=this;title=title||this.getName();_gliffy.Plugins.addToolbarButton(function(e){self[actionName](e)},title,className,id)},onAllPluginsActivated:function(editor){}});_gliffy.Plugins={create:function(plugin){plugin=new (_Plugin.extend(plugin))();_plugins.push(plugin);return plugin},activate:function(editor){var i,plugin;for(i=0;i<_plugins.length;i++){plugin=_plugins[i];plugin.initTemplates();plugin.activate(editor);_activePlugins[plugin.getName()]=plugin}for(i=0;i<_plugins.length;i++){plugin=_plugins[i];plugin.onAllPluginsActivated(editor)}if(editor.pluginsReadyCallback){setTimeout(function(){editor.pluginsReadyCallback(editor)},100)}},initTemplates:function(templateNames){var i;for(i=0;i<templateNames.length;i++){Ember.View.create({templateName:templateNames[i]}).appendTo("#gliffy")}},isActive:function(pluginName){return this.getInstance(pluginName)!==null},getInstance:function(pluginName){return _activePlugins[pluginName]||null},addToolbarButton:function(actionFunction,title,className,id){var self=this,button,activateFunc;id=id||("__gliffy_plugin__"+_id++);className=className||"";title=title||"";button=$("<button/>",{"class":"btn",id:id,title:title});button.append($("<div/>",{"class":className}));activateFunc=function(){var anchor=$("#gliffy-toolbar-extensions");if(anchor.length>0){anchor.append(button);button.click(actionFunction)}else{setTimeout(activateFunc,30)}};activateFunc()}}}());(function(){_gliffy.fontLoader=_gliffy.Class.extend({_loaded:null,_tinyMCEHasLoaded:false,_queuedStyleForTinyMCE:null,_fontPath:null,init:function(options){var i,nonWebFonts=_gliffy.TextUtils.getFontList(false);this._loaded={};this._queuedStyleForTinyMCE="";for(i=0;i<nonWebFonts.length;i++){this._loaded[nonWebFonts[i]]=true}},setPath:function(path){this._fontPath=path},attachPlaceholderFont:function(font){var fontWithDashes=font.replace(/\ /g,"-"),style,template=Handlebars.compile($("#gliffy-font-loader").html()),self=this,$selector;style=template($.extend({woffBase64:$("#gliffy-font-"+fontWithDashes+"-placeholder").html(),fontName:fontWithDashes+"Placeholder"}));this._appendStyle($("head"),style);$selector=$('span[title="'+font+'"]');$selector.css("font-family",fontWithDashes+"Placeholder")},_appendStyle:function($head,style){var $styleSheet=$head.find("#gliffy-font-style");if($styleSheet.length===0){$styleSheet=$('<style id="gliffy-font-style"></style>');$head.append($styleSheet)}$styleSheet.html($styleSheet.text()+"\n\n\n\n"+style)},attachLoadedFontsToTinyMCE:function(){this._tinyMCEHasLoaded=true;this._appendStyle($("#gliffy-edit-text_ifr").contents().find("head"),this._queuedStyleForTinyMCE);this._queuedStyleForTinyMCE=null},waitForWebfonts:function(fonts,callback){if(fonts.length===0){if(callback){callback()}return}WebFont.load({custom:{families:fonts},timeout:3000,active:function(which){if(callback){callback()}},fontinactive:function(){_gliffy.Logger.warn("unable to detect font load "+fonts.join(", "));if(callback){callback()}}})},loadFont:function(font,callback){var template,style,self=this;font=font.replace(/\'|\"/g,"");if(this._loaded[font]||(_gliffy.TextUtils.FONT_FIXES[font]&&!_gliffy.TextUtils.FONT_FIXES[font].isWebFont)){return}this._loaded[font]=true;template=Handlebars.compile($("#gliffy-font-loader").html());style=template($.extend({woffBase64:(this._fontPath?this._fontPath:"../images/rtefont/")+font+".woff",fontName:font}));self._appendStyle($("head"),style);if(_gliffy.Editor!==undefined){if(self._tinyMCEHasLoaded&&window.tinymce&&tinymce.activeEditor){self._appendStyle($("#gliffy-edit-text_ifr").contents().find("head"),style);tinymce.activeEditor.plugins.autoresize.forceResize()}else{self._queuedStyleForTinyMCE+=style}}if(callback){self.waitForWebfonts([font],callback)}},isLoadedOrLoading:function(fontName){return !!this._loaded[fontName]},getEmbeddableFonts:function(cb){var webFontsToLoad={},self=this,doLoad,noFonts,embeddableFont;for(var loadedFont in this._loaded){if(this._loaded.hasOwnProperty(loadedFont)&&_gliffy.TextUtils.FONT_FIXES[loadedFont]&&_gliffy.TextUtils.FONT_FIXES[loadedFont].isWebFont){webFontsToLoad[loadedFont]=null}}var doLoad=function(fontName,cb){var loadedEmbeddableFont,fullStyle;self.__loadEmbeddableFont(fontName,function(fontName,style){webFontsToLoad[fontName]=style;for(loadedEmbeddableFont in webFontsToLoad){if(webFontsToLoad.hasOwnProperty(loadedEmbeddableFont)&&webFontsToLoad[loadedEmbeddableFont]===null){return}}fullStyle="";for(loadedEmbeddableFont in webFontsToLoad){fullStyle+=webFontsToLoad[loadedEmbeddableFont]+"\n"}cb(fullStyle)})};noFonts=true;for(embeddableFont in webFontsToLoad){if(webFontsToLoad.hasOwnProperty(embeddableFont)){noFonts=false;doLoad(embeddableFont,cb)}}if(noFonts){cb("")}},__loadEmbeddableFont:function(font,callback){var fontName=font,url;font=font.replace(/\'|\"/g,"");url=(this._fontPath?this._fontPath:"../images/rtefont/")+font+".woff.txt";$.ajax({url:url,type:"GET"}).done(function(data){var dataURL="data:font/woff;base64,"+data.replace("\n",""),template=Handlebars.compile($("#gliffy-font-loader").html()),style=template($.extend({woffBase64:dataURL,fontName:font}));if(callback){callback(fontName,style)}}).error(function(xhr,text,error){_gliffy.Logger.warn("Failed to download: "+fontName+".  This font will not be in the SVG.");_gliffy.Logger.warn("xhr: "+xhr+", text: "+text+", error: "+error);if(callback){callback(fontName,"")}})}});$(function(){_gliffy.FontLoader=new _gliffy.fontLoader()})}());(function(){_gliffy.DebugUtils={pollLayerState:function(editor){var nodes=editor.getDocumentManager().getActiveStage().objects,checkSelection,checkOrder,checkGroup,checkForActiveLayer,interval;checkSelection=function(node){var errors=false;if(node.isSelection()){if(node.getLayerId()){_gliffy.Logger.warn("Layers: selection node "+node.getId()+" has a layerId that it should not have");errors=true}if(node.children){_.each(node.children,function(child){if(!child.getLayerId()){_gliffy.Logger.warn("Layers: selection node "+node.getId()+"  has child node "+child.getId()+" without layer id");errors=true}})}}return errors};checkGroup=function(node){var errors=false;if(node.isGroup()){if(!node.getLayerId()){_gliffy.Logger.warn("Layers: group node "+node.getId()+" does not have a layerId");errors=true}if(node.children){_.each(node.children,function(child){if(child.getLayerId()){_gliffy.Logger.warn("Layers: group child "+child.getId()+" has an layer id "+child.getLayerId()+" and should not have one.");errors=true}})}}return errors};checkOrder=function(stage){var errors=false,flattened=stage.flattenNodes(false),layer,layerOrder,nodeOrder,min,max;_.each(flattened,function(node){var activeLayers=node.getActiveLayers();if(!activeLayers){_gliffy.Logger.warn("Layers: node "+node.getId()+" does not have layer)");return true}if(!node.isSelection()){if(activeLayers.length!==1){_gliffy.Logger.warn("Layers: node "+node.getId()+" has more than one active layer and should not.");errors=true}else{if(activeLayers.length===0){_gliffy.Logger.warn("Layers: node "+node.getId()+" has more than zero active layers and should have at least one.");errors=true}else{layer=_.first(activeLayers);layerOrder=layer.getOrder();nodeOrder=node.getOrder();min=layerOrder*_gliffy.Layer.LAYER_OFFSET;max=(layerOrder+1)*_gliffy.Layer.LAYER_OFFSET;if(!_.inRange(nodeOrder,min,max)){_gliffy.Logger.warn("Layers: node "+node.getId()+" on layer with order "+layerOrder+" is not in range ("+min+", "+max+")");errors=true}}}}});return errors};checkForActiveLayer=function(stage){var errors=false;if(!stage.getActiveLayers()||stage.getActiveLayers().length<1){_gliffy.Logger.warn("Layers: stage has no active layers");errors=true}return errors};interval=setInterval(function(){var errors=false,stage=editor.getDocumentManager().getActiveStage();_.each(nodes,function(node){if(checkSelection(node)||checkGroup(node)){errors=true}});if(checkForActiveLayer(stage)||checkOrder(stage)){errors=true}if(errors){_gliffy.Logger.warn("Layers error detected.  Stopping layers error polling.  To resume type _gliffy.DebugUtils.pollLayerState(_gliffy.Mouse.editor) on the console.");alert("Layers Error, see console.");clearInterval(interval)}},1500)},debugRenderBoundingBox:function(options){var o=$.extend({},{className:"gliffy-debug-bounding-box",border:"1px solid red",$container:$(".gliffy-stage"),boundingBox:new _gliffy.BoundingBox()},options),$div=o.$container.find("."+o.className);if($div.length===0){o.$container.append($("<div>").addClass(o.className))}$div.css($.extend({},o.boundingBox.toCss(),{border:o.border,position:"absolute",zIndex:1000000}))},debugRenderPoint:function(options){var o=$.extend({},{point:{x:0,y:0},className:"gliffy-debug-point"},options);o.boundingBox=(new _gliffy.BoundingBox()).fitPoints([o.point]);this.debugRenderBoundingBox(o)}};_gliffy.Utils.forceMatrixOnly=_gliffy.BrowserDetect.browser==="Safari"&&_gliffy.BrowserDetect.version===5.1}());(function(){_gliffy.EmbeddedResource=_gliffy.Serializable.extend({id:null,mimeType:null,data:null,width:100,height:100,x:0,y:0,init:function(id,mimeType,data,x,y,width,height){this.id=id;this.mimeType=mimeType;this.data=data;this.x=x;this.y=y;this.width=width;this.height=height},getId:function(){return this.id},setId:function(id){this.id=id},setMimeType:function(mimeType){this.mimeType=mimeType},getMimeType:function(){return this.mimeType},setData:function(data){this.data=data},getData:function(){return this.data},getWidth:function(){return this.width},setWidth:function(width){this.width=width},getX:function(){return this.x},setX:function(x){this.x=x},getY:function(){return this.y},setY:function(y){this.y=y},getHeight:function(){return this.height},setHeight:function(height){this.height=height},__toObject:function(){return{id:this.getId(),mimeType:this.getMimeType(),data:this.getData(),x:this.getX(),y:this.getY(),width:this.getWidth(),height:this.getHeight()}},__fromObject:function(object){if(object.id!==undefined&&object.id!==null){this.setId(object.id)}if(object.mimeType!==undefined&&object.mimeType!==null){this.setMimeType(object.mimeType)}if(object.data!==undefined&&object.data!==null){this.setData(object.data)}if(object.x!==undefined&&object.x!==null){this.setX(object.x)}if(object.y!==undefined&&object.y!==null){this.setY(object.y)}if(object.width!==undefined&&object.width!==null){this.setWidth(object.width)}if(object.height!==undefined&&object.height!==null){this.setHeight(object.height)}return this}});_gliffy.EmbeddedResources=_gliffy.Serializable.extend({index:0,resources:null,_resourceMap:null,init:function(){this._resourceMap={}},getIndex:function(){return this.index},setIndex:function(index){this.index=index},add:function(mimeType,data,x,y,width,height){var resource,i;if(this.resources===null){this.resources=[]}resource=new _gliffy.EmbeddedResource(this.getIndex(),mimeType,data,x,y,width,height);for(i=0;i<this.resources.length;i++){if(this.resources[i].getData()===resource.getData()&&this.resources[i].getMimeType()===resource.getMimeType()){return this.resources[i]}}this.resources.push(resource);this._resourceMap[resource.getId()]=resource;this.index++;return resource},remove:function(resource){var index;if(this.resources!==null){index=$.inArray(resource,this.resources);if(index>=0){this.resources.splice(index,1);delete this._resourceMap[resource.getId()]}}},getResource:function(id){return this._resourceMap[id]},findExisitngResource:function(data,mimetype){var i;for(i=0;i<this.resources.length;i++){if(this.resources[i].getData()===data&&this.resources[i].getMimeType()===mimetype){return this.resources[i]}}return null},__toObject:function(){var i,resources=[],resource;for(i=0;this.resources&&i<this.resources.length;i++){resource=this.resources[i].toObject();resources.push(resource)}return{index:this.index,resources:resources}},__fromObject:function(object){var i,resource;if(object.index!==undefined&&object.index!==null){this.setIndex(object.index)}if(object.resources&&object.resources.length>0){this.resources=[];this._resourceMap={};for(i=0;i<object.resources.length;i++){resource=new _gliffy.EmbeddedResource();resource.fromObject(object.resources[i]);this.resources.push(resource);this._resourceMap[resource.getId()]=resource}}return this}})}());(function(){_gliffy.Graphic=_gliffy.Serializable.extend({_dirty:true,editable:null,init:function(){if(_gliffy.Editable){this.editable=_gliffy.Editable.getInstance(this)}},getTid:function(){throw new Error("getTid not implemented.")},markDirty:function(){this._dirty=true;if(this.node){this.node.markDirty();this.node.setFlag("skin")}},shouldBeDrawn:function(){if(this.node){return this.node.shouldBeDrawn()}return true},isDirty:function(){return this._dirty},hasParentOfType:function(type){return this.node&&this.node.parent&&this.node.parent.getGraphic() instanceof type},updateProperty:function(prop,value){if(this["set"+prop]!==undefined){this["set"+prop](value)}else{var msg="Property setter: set"+prop+" not found on graphic";throw new Error(msg)}},update:function(){throw new Error("update not implemented.")},applyStyle:function(style){throw new Error("applyStyle not implemented.")},getClassName:function(){throw new Error("getClassName not implemented.")},__toObject:function(){throw new Error("toObject not implemented.")},__fromObject:function(object){throw new Error("fromObject not implemented.")}})})();(function(){_gliffy.Editable=_gliffy.Serializable.extend({isEditable:false,__graphic:null,init:function(o){if(!o){throw new Error("editable init needs options")}if(!o.graphic){throw new Error("editable init options needs graphic")}this.__graphic=o.graphic},__toObject:function(){return{}},__fromObject:function(object){}});_gliffy.Editable.getInstance=function(graphic){var className="Editable"+graphic.getClassName();if(typeof _gliffy[className]==="function"){return new _gliffy[className]({graphic:graphic})}return new _gliffy.Editable({graphic:graphic})}})();(function(){_gliffy.AbstractGeometry=_gliffy.Graphic.extend({_strokeWidth:2,_strokeColor:"#000000",_dropShadow:true,_shadowX:5,_shadowY:5,_connections:null,_showConnections:false,svg:null,setStrokeWidth:function(strokeWidth){this._strokeWidth=strokeWidth;if(this.node){this.node.setFlag("bounds")}this.markDirty()},getStrokeWidth:function(){return this._strokeWidth},setStrokeColor:function(strokeColor){this._strokeColor=strokeColor;this.markDirty()},getStrokeColor:function(){return this._strokeColor},setDropShadow:function(dropShadow){this._dropShadow=dropShadow;if(dropShadow){this.setShadowX(4);this.setShadowY(4)}else{this.setShadowX(0);this.setShadowY(0)}if(this.node){this.node.setFlag("bounds");this.node.setFlag("skin")}this.markDirty()},isDropShadow:function(){return this._dropShadow},setShadowX:function(shadowX){this._shadowX=shadowX;this.markDirty()},getShadowX:function(){return this._shadowX},setShadowY:function(shadowY){this._shadowY=shadowY;this.markDirty()},getShadowY:function(){return this._shadowY},calculateShadowOffset:function(){if(this.isDropShadow()&&this.node){var shadow_x=this.getShadowX(),shadow_y=this.getShadowY(),rotation=this.node.getWorldRotation();var nx=0;var ny=0;var r=rotation%360;if(r<0){r+=360}if(r>=0&&r<=90){var rat1=0;if(r<45){rat1=r/45}else{rat1=(90-r)/45}var rat2=(45-r)/45;nx=shadow_x+shadow_x/3*rat1;ny=shadow_y*rat2}else{if(r>90&&r<=180){r=r-90;if(r<45){rat1=r/45}else{rat1=(90-r)/45}var rat2=(45-r)/45;nx=shadow_x*rat2;ny=-(shadow_y+shadow_y/3*rat1)}else{if(r>180&&r<=270){r=r-180;if(r<45){rat1=r/45}else{rat1=(90-r)/45}var rat2=(45-r)/45;nx=-(shadow_x+shadow_x/4*rat1);ny=-(shadow_y*rat2)}else{if(r<0){r=360+r}r=r-270;if(r<45){rat1=r/45}else{rat1=(90-r)/45}var rat2=(45-r)/45;nx=-(shadow_x*rat2);ny=shadow_y+shadow_y/3*rat1}}}return{x:nx,y:ny}}else{return{x:0,y:0}}}})}());(function(){var TID=null,OVERFLOW={name:"overflow",values:["left","none","right","both"],left:"left",right:"right",both:"both",none:"none"},VALIGN={name:"valign",values:["top","middle","bottom"],top:"top",middle:"middle",bottom:"bottom"},VPOSITION={name:"vposition",values:["above","none","below"],above:"above",none:"none",below:"below"},HPOSITION={name:"hposition",values:["left","none","right"],left:"left",none:"none",right:"right"},HORIZONTAL_MAGIC_OFFSETS={left:3,overflow_both:3,overflow_left:3,right:-2};var DEFAULT_FONT_FIX={9:0,10:0,11:0,12:0,13:0,14:0,16:0,18:0,20:0,24:0,36:0,48:0,64:0,72:0,96:0,110:0,127:0};_gliffy.TextUtils={FONT_FIXES:{Arial:{isOffset:true,isWebFont:false,isFontOption:true,normal:{9:1,10:1,11:1,12:2,13:2.5,14:2.5,16:2.5,18:2.5,20:2.75,24:3,36:5,48:5,64:8,72:8,96:10,110:12,127:16},bold:{9:1,10:1,11:1,12:2,13:2.5,14:2.5,16:2.5,18:2.5,20:2.75,24:3,36:5,48:5,64:8,72:8,96:10,110:12,127:16}},Verdana:{isOffset:true,isWebFont:false,isFontOption:true,normal:{9:2.5,10:2.5,11:2.5,12:2.5,13:3.5,14:3.5,16:3.75,18:4,20:4.25,24:5,36:8,48:10,64:12,72:15,96:21,110:24,127:28},bold:{9:2.5,10:2.5,11:2.5,12:2.5,13:3.5,14:3.5,16:3.75,18:4,20:4.25,24:5,36:8,48:10,64:12,72:15,96:21,110:24,127:28}},Helvetica:{isOffset:true,isWebFont:false,isFontOption:true,normal:DEFAULT_FONT_FIX,bold:DEFAULT_FONT_FIX},Courier:{isOffset:true,isWebFont:false,isFontOption:true,normal:DEFAULT_FONT_FIX,bold:DEFAULT_FONT_FIX},Times:{isOffset:true,isWebFont:false,isFontOption:true,normal:DEFAULT_FONT_FIX,bold:DEFAULT_FONT_FIX},"Times New Roman":{isOffset:true,isWebFont:false,isFontOption:false,normal:DEFAULT_FONT_FIX,bold:DEFAULT_FONT_FIX}},appendWebFontFixes:function(){if($("#gliffy-font-line-heights").length>0){var webFontFixes=JSON.parse($("#gliffy-font-line-heights").html());for(var fontName in webFontFixes){if(webFontFixes.hasOwnProperty(fontName)){var fixObj={isOffset:false,isWebFont:true,isFontOption:true,normal:{},bold:{}};for(var fontSize in webFontFixes[fontName]){if(webFontFixes[fontName].hasOwnProperty(fontSize)){fixObj.normal[parseInt(fontSize)]=parseFloat(webFontFixes[fontName][fontSize]);fixObj.bold[parseInt(fontSize)]=parseFloat(webFontFixes[fontName][fontSize])}}_gliffy.TextUtils.FONT_FIXES[fontName]=fixObj}}}},getFontList:function(webFonts){var fonts=[];for(var fontName in _gliffy.TextUtils.FONT_FIXES){if(_gliffy.TextUtils.FONT_FIXES.hasOwnProperty(fontName)){if(_gliffy.TextUtils.FONT_FIXES[fontName].isFontOption){if(webFonts===true&&_gliffy.TextUtils.FONT_FIXES[fontName].isWebFont){fonts.push(fontName)}else{if(webFonts===false&&!_gliffy.TextUtils.FONT_FIXES[fontName].isWebFont){fonts.push(fontName)}else{if(webFonts===null||webFonts===undefined){fonts.push(fontName)}}}}}}return fonts},removeErroneousTrailingParagraphs:function($html){var i,$paragraph,paragraphs,validParagraphFound;paragraphs=$html.find("p");if(paragraphs.length>1){validParagraphFound=false;i=paragraphs.length;while(i>0&&!validParagraphFound){i--;$paragraph=$(paragraphs[i]);if($paragraph.find("br").length>0&&$paragraph.text().length===0){$paragraph.remove()}else{validParagraphFound=true}}}return $html},validateAndFix:function(html){var $html;$html=$("<div>"+html+"</div>");if(_gliffy.BrowserDetect.browser==="Explorer"&&_gliffy.BrowserDetect.version===11){$html=this.removeErroneousTrailingParagraphs($html)}$html.contents().each(function(){if(this.nodeType===3&&_gliffy.Utils.hasNonWhitespaceCharacter(this.textContent)){$(this).wrap("<p />")}});$html.contents().each(function(){var $p=$(this);if($p.is("p")){if($p.attr("style")===null||$p.attr("style")===undefined||$p.attr("style").toLowerCase().indexOf("text-align")<0){$p.css("text-align","center")}$p.contents().each(function(){if(this.nodeType===3){$(this).wrap("<span />")}})}});$html.find("a").each(function(){var $this=$(this),spans;if($this.attr("target")===undefined||$this.attr("target")===null){$this.attr("target","_blank")}});return $html.html()},adjustHeightsAndColor:function(html){var textNode=$("<div>").append($(html)),spans=textNode.find("span"),color,isBlack,renderedColor;spans.each(function(index){var span=$(this),font=span.css("font-family"),weight=span.css("font-weight"),size=parseFloat(span.css("font-size").replace("px","")),height,needsLineHeight=false;if(span[0].childNodes.length===0){needsLineHeight=true}for(var i=0;i<span[0].childNodes.length;i++){if(span[0].childNodes[i].nodeType===3||span[0].childNodes[i].tagName.toLowerCase()==="a"){needsLineHeight=true;break}}font=_gliffy.Utils.getRenderedStyle(span,"font-family");font=font===""?"Arial":font;_gliffy.FontLoader.loadFont(font);if(needsLineHeight){weight=_gliffy.Utils.getRenderedStyle(span,"font-weight");size=parseFloat(_gliffy.Utils.getRenderedStyle(span,"font-size").replace("px",""));switch(weight){case"bold":case"700":weight="bold";break;case"":case"normal":case"400":weight="normal";break;default:weight="normal"}if(_gliffy.TextUtils.FONT_FIXES[font]===undefined){font="Arial"}if(_gliffy.TextUtils.FONT_FIXES[font][weight]===undefined){weight="normal"}if(isNaN(size)||_gliffy.TextUtils.FONT_FIXES[font][weight][size]===undefined){size=12}if(_gliffy.TextUtils.FONT_FIXES[font].isOffset){height=""+(size+_gliffy.TextUtils.FONT_FIXES[font][weight][size])+"px"}else{height=_gliffy.TextUtils.FONT_FIXES[font][weight][size]}if($(this).html().length===0){$(this).html("&nbsp;")}$(this).css("line-height",height)}else{$(this).css("line-height","")}if(!_gliffy.Utils.hasNonWhitespaceCharacter(span[0].textContent)){$(this).css("text-decoration","none")}isBlack=function(color){return color==="rgb(0, 0, 0)"||color==="black"||color==="#000000"||color==="#000"||color==="rgb(0,0,0)"};color=$(this).css("color");if(isBlack(color)){$(this).css("color","");renderedColor=_gliffy.Utils.getRenderedStyle($(this),"color");if(!isBlack(renderedColor)){$(this).css("color",color)}}});return textNode.html()},findFirstElementWithColor:function($html,notTopLevelCall){var black,$element,elementColor,firstElement;black="rgb(0, 0, 0)";$html.each(function(_,element){$element=$(element);elementColor=new _gliffy.RGBColor($element.css("color"));if(elementColor.toRGB()!==black){firstElement=firstElement||$element}else{if($element.children().length>0){firstElement=firstElement||_gliffy.TextUtils.findFirstElementWithColor($element.children(),{notTopLevelCall:true})}}});if(notTopLevelCall){return firstElement}else{return firstElement||$html.find("span")}}};_gliffy.Text=_gliffy.Graphic.extend({style_default:{width:200,height:100,x:0,y:0,type:"fixed",rotate:0},node:null,_lines:null,_valign:VALIGN.middle,_overflow:OVERFLOW.none,_vposition:VPOSITION.none,_hposition:HPOSITION.none,_html:null,_hashCode:null,_lineTValue:null,_linePerpValue:null,_cardinalityType:null,ruler:null,__padding_top:2,__padding_left:2,__padding_bottom:2,__padding_right:2,__outer_padding_top:null,__outer_padding_left:null,__outer_padding_bottom:null,__outer_padding_right:null,__legacyOuterPadding:{top:6,left:5,right:6,bottom:2},__webkit_height_offset:1,__cachedResult:null,__cachedDomResult:null,__computePositioning:false,__calculatedWidth:null,__calculatedHeight:null,__domRuler:null,init:function(){this.__domRuler=$("<div/>",{style:"visibility:hidden;padding:0;margin:0;position:fixed;","class":"gliffy-ruler-text"});this.style=$.extend({},this.style_default);this._super()},update:function(){if(this.node&&this._dirty){if(!this.editable.isEditable||!this.editable.getEditMode()){this.style=$.extend({},this.style_default,{width:this.node.getWidth(),height:this.node.getHeight()});this.__textHandler();this.__cachedDomResult=$(this._html)}this._dirty=false;return true}return false},markDirty:function(){this._dirty=true;if(this.node){this.node.markDirty()}},calculateWidth:function(){var width=0,recalcDimensions=this.node.isPartOfMultipartShape(),mapEntry;mapEntry=""+this.node.getId()+":"+this._hashCode;if(recalcDimensions||_gliffy.textDimensionMap.width[mapEntry]===undefined){if(!recalcDimensions&&++_gliffy.textDimensionMapSize.width>5000){_gliffy.textDimensionMap.width={};_gliffy.textDimensionMapSize.width=0}if(this.hasFixedWidth()){width=this.node.getWidth()}else{this.__domRuler.html(this._html).appendTo("body").css({width:""});width=this.__domRuler.width()}switch(this.getOverflow()){case OVERFLOW.none:width=width-this.getPaddingLeft()-this.getPaddingRight();break;case OVERFLOW.right:case OVERFLOW.both:width+=5;break}if(recalcDimensions){return width}_gliffy.textDimensionMap.width[mapEntry]=width}return _gliffy.textDimensionMap.width[mapEntry]},calculateHeight:function(forceRecalculate){var height,existingWidth,mapEntry;if(this.hasFixedWidth()){existingWidth=this.node.getWidth()-this.getPaddingLeft()-this.getPaddingRight();existingWidth=existingWidth.toFixed(2)}else{existingWidth=-1}mapEntry=""+this.node.getId()+":"+this._hashCode+":"+existingWidth;if(_gliffy.textDimensionMap.height[mapEntry]===undefined||forceRecalculate){if(++_gliffy.textDimensionMapSize.height>5000){_gliffy.textDimensionMap.height={};_gliffy.textDimensionMapSize.height=0}this.__domRuler.appendTo("body").css({width:""}).html(this._html);if(this.hasFixedWidth()){this.__domRuler.css("width",Number(existingWidth)+"px")}else{this.__domRuler.css("width","")}height=this.__domRuler.height();this.__domRuler.css("width","").remove();_gliffy.textDimensionMap.height[mapEntry]=height}return _gliffy.textDimensionMap.height[mapEntry]},invalidate:function(){this.setHTML(this.getHTML());this.calculateHeight(true)},getCalculatedHeight:function(){return this.calculateHeight()},getCalculatedWidth:function(){return this.calculateWidth()},setupDefaults:function(textDefaults){var spanStyle="",pStyle="",css={},valid,newHTML,key;valid=textDefaults&&textDefaults.length!==0;if(valid){this.fromObject(textDefaults[0]);if(textDefaults[0].html!==undefined&&textDefaults[0].html!==null){this.setHTML(textDefaults[0].html,true)}}if(valid&&textDefaults[0].bold===true){css["font-weight"]="bold"}if(valid&&textDefaults[0].italic===true){css["font-style"]="italic"}if(valid&&textDefaults[0].underline===true){css["text-decoration"]="underline"}if(valid&&textDefaults[0].face){css["font-family"]=textDefaults[0].face}else{css["font-family"]="Arial"}if(valid&&textDefaults[0].size){css["font-size"]=textDefaults[0].size+"px"}else{css["font-size"]="12px"}if(valid&&textDefaults[0].color){css.color=textDefaults[0].color}if(valid&&textDefaults[0].paddingLeft){this.setPaddingLeft(textDefaults[0].paddingLeft)}if(valid&&textDefaults[0].paddingRight){this.setPaddingRight(textDefaults[0].paddingRight)}if(valid&&textDefaults[0].paddingBottom){this.setPaddingBottom(textDefaults[0].paddingBottom)}if(valid&&textDefaults[0].paddingTop){this.setPaddingTop(textDefaults[0].paddingTop)}if(valid&&textDefaults[0].outerPaddingLeft){this.setOuterPaddingLeft(textDefaults[0].outerPaddingLeft)}if(valid&&textDefaults[0].outerPaddingRight){this.setOuterPaddingRight(textDefaults[0].outerPaddingRight)}if(valid&&textDefaults[0].outerPaddingBottom){this.setOuterPaddingBottom(textDefaults[0].outerPaddingBottom)}if(valid&&textDefaults[0].outerPaddingTop){this.setOuterPaddingTop(textDefaults[0].outerPaddingTop)}for(key in css){if(css.hasOwnProperty(key)){spanStyle+=key+":"+css[key]+";"}}if(valid&&textDefaults[0].align){pStyle+="text-align: "+textDefaults[0].align+"; "}newHTML=this.getHTML()&&this.getHTML().length!==0?this.getHTML():'<span class="gliffy-placeholder-text"><br></span>';newHTML='<p style="'+pStyle+'"><span style="'+spanStyle+'">'+newHTML+"</span></p>";this.setHTML(newHTML)},__setupCardinalityValues:function(cardinality){var line=this.node.parent.getGraphic(),totalDistance=line.getPathLength().totalDistance,arrow=line[(cardinality==="begin")?"getStartArrow":"getEndArrow"](),curDistance=(arrow===0?15:25),slopeVec,slope,isShortLine;isShortLine=totalDistance<80;this.setLinePerpValue(15*(cardinality==="end"&&isShortLine?-1:1));if(cardinality==="end"){curDistance=totalDistance-curDistance}this.setLineTValue(curDistance/totalDistance);slopeVec=line.getSlopeAtDistance(curDistance);slope=Math.atan2(slopeVec.y,slopeVec.x);if(slope>-1.571&&slope<1.57){this.setLinePerpValue(-15*(cardinality==="end"&&isShortLine?-1:1))}},__textHandler:function(){var hasMultipartParent,height,linePoint,offset,parent,slope,width;hasMultipartParent=this.node.isPartOfMultipartShape();if(this.node.hasRedrawCanvasFlag()||this.__calculatedWidth===null||this.__calculatedHeight===null){this.__calculatedWidth=this.calculateWidth();this.__calculatedHeight=this.calculateHeight();parent=this.node.getUidNode();if(hasMultipartParent){this.node.setHeight(this.__calculatedHeight+this.getPaddingTop()+this.getPaddingBottom());this.node.setWidth(this.__calculatedWidth+this.getPaddingLeft()+this.getPaddingRight())}else{if((parent&&parent.isLine())||!this.hasFixedWidth()){this.node.setHeight(this.__calculatedHeight);this.node.setWidth(this.__calculatedWidth)}else{if(this.node.parent&&!this.node.parent.isGroup()){this.node.setHeight(this.__calculatedHeight)}else{if(this.node.getHeight()<this.__calculatedHeight){this.node.setHeight(this.__calculatedHeight)}}}}}if(this.node.isStandAloneText()||!this.node.parent){height=this.node.getHeight();width=this.node.getWidth()}else{height=this.node.parent.getHeight();width=this.node.parent.getWidth()}this.style.width=this.node.getWidth();this.style.height=this.node.getHeight();if(this.getOverflow()===OVERFLOW.none){this.style.width=this.node.getWidth()-this.getPaddingLeft()-this.getPaddingRight()}else{if(hasMultipartParent){this.style.height=this.node.getHeight()-this.getPaddingTop()-this.getPaddingBottom()}}if(hasMultipartParent&&this.getValign()===VALIGN.bottom){this.style.height=this.node.getHeight()-this.getPaddingTop()-this.getPaddingBottom()}this.style.y=0;switch(this.getValign()){case VALIGN.top:this.style.y=this.getPaddingTop();break;case VALIGN.middle:this.style.y=(height-this.style.height)/2;break;case VALIGN.bottom:this.style.y=(height-this.style.height-this.getPaddingBottom())}switch(this.getVPosition()){case VPOSITION.above:this.style.y=-this.style.height-this.getOuterPaddingTop();break;case VPOSITION.below:this.style.y=height+this.getOuterPaddingBottom();break}switch(this.getHPosition()){case HPOSITION.right:this.style.x=width+this.getOuterPaddingRight()+HORIZONTAL_MAGIC_OFFSETS.right;break;case HPOSITION.left:this.style.x=-(this.style.width+this.getOuterPaddingLeft()+HORIZONTAL_MAGIC_OFFSETS.left);break;default:this.style.x=this.getPaddingLeft();break}switch(this.getOverflow()){case OVERFLOW.both:this.style.x=width/2-this.style.width/2-HORIZONTAL_MAGIC_OFFSETS.overflow_both;break;case OVERFLOW.left:this.style.x=-(this.getOuterPaddingLeft()+this.getCalculatedWidth()+HORIZONTAL_MAGIC_OFFSETS.overflow_left);break}if(this.node.parent&&this.node.parent.isLine()){if(this.node.stage){this.style.text_background_fill=this.node.stage.background}var cardinality=this.getCardinality();if(cardinality!==null){this.__setupCardinalityValues(cardinality)}linePoint=this.node.parent.getGraphic().getPointAt(this.getLineTValue());offset=new _gliffy.Vec2(0,0);if(this.getLinePerpValue()!==0){slope=this.node.parent.getGraphic().getSlopeAtT(this.getLineTValue());offset=slope.rotate(Math.PI/2).scale(this.getLinePerpValue())}this.style.x=offset.x+linePoint.x-this.style.width/2;this.style.y=offset.y+linePoint.y-this.style.height/2}},getLines:function(){return this._lines},setLines:function(lines){this._lines=lines;this.markDirty()},getValign:function(){return this._valign},setValign:function(valign){this._valign=valign;this.markDirty()},getHalign:function(){var html;html=this.getHTML();return $(html).css("text-align")},setHalign:function(halign){var html;html=this.getHTML();html=$("<div>").append($(html).css("text-align",halign)).html();this.setHTML(html,true);this.markDirty()},getFirstColor:function(){var $elementWithColor,$html;$html=$(this.getHTML());$elementWithColor=_gliffy.TextUtils.findFirstElementWithColor($html);return $elementWithColor.css("color")||"rgb(0, 0, 0)"},setFirstColor:function(color){var $elementWithColor,html,$html;$html=$(this.getHTML());$elementWithColor=_gliffy.TextUtils.findFirstElementWithColor($html);$elementWithColor.css("color",color);html=$("<div>").append($html).html();this.setHTML(html,true);this.markDirty()},setLineTValue:function(ratio){this._lineTValue=ratio;this.markDirty()},getLineTValue:function(){return(this._lineTValue!==null?this._lineTValue:0.5)},setLinePerpValue:function(px){this._linePerpValue=px},getLinePerpValue:function(){return(this._linePerpValue!==null?this._linePerpValue:0)},isCardinality:function(){return this._cardinalityType!==null},setCardinality:function(cardinalityType){this._cardinalityType=cardinalityType},getCardinality:function(){return this._cardinalityType},getOverflow:function(){return this._overflow},setOverflow:function(overflow){this._overflow=overflow;this.markDirty()},hasFixedWidth:function(){return !(this.getOverflow()===OVERFLOW.left||this.getOverflow()===OVERFLOW.right||this.getOverflow()===OVERFLOW.both)},getVPosition:function(){return this._vposition},setVPosition:function(vposition){this._vposition=vposition;this.markDirty()},setHTML:function(html,raw){if(raw!==true){html=_gliffy.TextUtils.validateAndFix(html);html=_gliffy.TextUtils.adjustHeightsAndColor(html)}this._html=html;this._hashCode=_gliffy.Utils.hashCode(this._html);if(this.node){this.node.setFlag("bounds")}this.markDirty()},getHTML:function(){return this._html||""},setContentHTML:function(html){var junk=$("<div>"+this._html+"</div>");$(junk[0].firstChild.firstChild).html(html);this.setHTML($(junk).html(),true)},getHPosition:function(){return this._hposition},setHPosition:function(hposition){this._hposition=hposition;this.markDirty()},getTid:function(){return TID},getClassName:function(){return"Text"},getNodeText:function(){var temporaryHtmlContainer,allInnerSpans,nodeText;temporaryHtmlContainer=document.createElement("div");temporaryHtmlContainer.innerHTML=this.getHTML();allInnerSpans=$("span",temporaryHtmlContainer);if(allInnerSpans.length>0){nodeText=allInnerSpans[0].textContent}return nodeText},setNodeText:function(text){var temporaryHtmlContainer,allInnerSpans;temporaryHtmlContainer=document.createElement("div");temporaryHtmlContainer.innerHTML=this.getHTML();allInnerSpans=$("span",temporaryHtmlContainer);if(allInnerSpans[0]){allInnerSpans[0].textContent=text;this.setHTML($(temporaryHtmlContainer).html())}else{this.setHTML("")}},getHtmlStyle:function(){var html,allInnerSpans,font="Ariel",weight="",size="12px",color="",textDecoration="",fontStyle="";html=this.getHTML();allInnerSpans=$("span",html);$.each(allInnerSpans,function(_,innerSpan){if($(innerSpan).text()){font=_gliffy.Utils.getRenderedStyle($(innerSpan),"font-family");weight=_gliffy.Utils.getRenderedStyle($(innerSpan),"font-weight");size=_gliffy.Utils.getRenderedStyle($(innerSpan),"font-size");color=_gliffy.Utils.getRenderedStyle($(innerSpan),"color");textDecoration=_gliffy.Utils.getRenderedStyle($(innerSpan),"text-decoration");fontStyle=_gliffy.Utils.getRenderedStyle($(innerSpan),"font-style");return false}});return{font:font,weight:weight,size:size,color:color,textDecoration:textDecoration,fontStyle:fontStyle}},applyStyleToHtml:function(style){var html=this.getHTML(),$temporaryHtmlContainer=$(document.createElement("div")),paragraphs,combinedText,$div,$paragraph,$outerSpan;$temporaryHtmlContainer.html(html);paragraphs=$temporaryHtmlContainer.find("p");combinedText=_.reduce(paragraphs,function(combinedText,paragraph){return combinedText+" "+$(paragraph).text()},"");if(combinedText&&style){$div=$(document.createElement("div"));$paragraph=$(document.createElement("p"));$outerSpan=$(document.createElement("span"));$paragraph.css({"text-align":"center"});$outerSpan.css({"font-family":style.font,"font-weight":style.weight,"font-size":style.size,color:style.color,"text-decoration":style.textDecoration,"font-style":style.fontStyle});$outerSpan.html(combinedText);$paragraph.append($outerSpan);$div.append($paragraph);this.setHTML($div.html())}else{this.setHTML(combinedText)}},isComputePositioning:function(){return this.__computePositioning},positionComputed:function(){this.__computePositioning=false},isStandalone:function(){return this.node&&this.node.isStandAloneText()},hasLineParent:function(){return this.hasParentOfType(_gliffy.Line)},setOuterPaddingLeft:function(outerPaddingLeft){this.__outer_padding_left=outerPaddingLeft},setOuterPaddingRight:function(outerPaddingRight){this.__outer_padding_right=outerPaddingRight},setOuterPaddingTop:function(outerPaddingTop){this.__outer_padding_top=outerPaddingTop},setOuterPaddingBottom:function(outerPaddingBottom){this.__outer_padding_bottom=outerPaddingBottom},getOuterPaddingLeft:function(){if(this.__outer_padding_top===null){return this.__legacyOuterPadding.left}else{return this.__outer_padding_top}},getOuterPaddingRight:function(){if(this.__outer_padding_right===null){return this.__legacyOuterPadding.right}else{return this.__outer_padding_right}},getOuterPaddingTop:function(){if(this.__outer_padding_top===null){return this.__legacyOuterPadding.top}else{return this.__outer_padding_top}},getOuterPaddingBottom:function(){if(this.__outer_padding_bottom===null){return this.__legacyOuterPadding.bottom}else{return this.__outer_padding_bottom}},hasLink:function(){return $(this._html).find("a").length!==0},getLinks:function(){var text=this.getHTML(),anchors=$(text).find("a");return $.map(anchors,function(anchor){return $(anchor).attr("href")})},setPaddingLeft:function(paddingLeft){this.__padding_left=paddingLeft},setPaddingRight:function(paddingRight){this.__padding_right=paddingRight},setPaddingTop:function(paddingTop){this.__padding_top=paddingTop},setPaddingBottom:function(paddingBottom){this.__padding_bottom=paddingBottom},getPaddingLeft:function(){return this.__padding_left},getPaddingRight:function(){return this.__padding_right},getPaddingTop:function(){return this.__padding_top},getPaddingBottom:function(){return this.__padding_bottom},getPosition:function(){var vPosition=this.getVPosition(),hPosition=this.getHPosition();if(vPosition===VPOSITION.above&&hPosition===HPOSITION.none){return"above"}if(vPosition===VPOSITION.below&&hPosition===HPOSITION.none){return"below"}if(vPosition===VPOSITION.none&&hPosition===HPOSITION.right){return"right"}if(vPosition===VPOSITION.none&&hPosition===HPOSITION.left){return"left"}if(vPosition===VPOSITION.none&&hPosition===HPOSITION.none){return"center"}_gliffy.Logger.warn("warning cannot find position in text.getPosition()");return null},setPosition:function(position,skipHalign){var hAlign,hPosition,overflow,vAlign,vPosition;switch(position){case"above":vPosition="above";hPosition="none";vAlign="bottom";hAlign="center";overflow="both";break;case"below":vPosition="below";hPosition="none";vAlign="top";hAlign="center";overflow="both";break;case"right":vPosition="none";hPosition="right";vAlign="middle";hAlign="left";overflow="right";break;case"left":vPosition="none";hPosition="left";vAlign="middle";hAlign="right";overflow="left";break;case"center":vPosition="none";hPosition="none";vAlign="middle";hAlign="center";overflow="both";break}this.setVPosition(vPosition);this.setHPosition(hPosition);this.setValign(vAlign);hAlign=skipHalign?this.getHalign():hAlign;this.setHalign(hAlign,{skipCommandRegistration:true});overflow=this.getOverflow()==="none"?"none":overflow;this.setOverflow(overflow);this.node.setFlag("bounds");this.markDirty()},runCallbackWhileEditing:function(overlay,callback){var $content,rte;rte=$("#gliffy-edit-text_ifr");if(rte.is(":visible")){$content=$("<div>").append(tinymce.activeEditor.getContent()).appendTo("body");this.editable.setEditMode(false);this.node.stage.commandHistory.addAndExecuteCommand(new _gliffy.SetTextCommand({node:this.node,text:_gliffy.Utils.removeLineBreaks($content.html())}));callback();overlay.editText(this.node)}},__toObject:function(){var obj={tid:this.getTid(),valign:this.getValign(),overflow:this.getOverflow(),vposition:this.getVPosition(),hposition:this.getHPosition(),html:this.getHTML(),paddingLeft:this.getPaddingLeft(),paddingRight:this.getPaddingRight(),paddingBottom:this.getPaddingBottom(),paddingTop:this.getPaddingTop(),outerPaddingLeft:this.getOuterPaddingLeft(),outerPaddingRight:this.getOuterPaddingRight(),outerPaddingBottom:this.getOuterPaddingBottom(),outerPaddingTop:this.getOuterPaddingTop()};if(this._lineTValue!==null){obj.lineTValue=this.getLineTValue()}if(this._linePerpValue!==null){obj.linePerpValue=this.getLinePerpValue()}if(this._cardinalityType!==null){obj.cardinalityType=this.getCardinality()}return obj},__fromObject:function(object){if(object.valign!==undefined&&object.valign!==null){this.setValign(object.valign)}if(object.overflow!==undefined&&object.overflow!==null){this.setOverflow(object.overflow)}if(object.vposition!==undefined&&object.vposition!==null){this.setVPosition(object.vposition)}if(object.hposition!==undefined&&object.hposition!==null){this.setHPosition(object.hposition)}if(object.html!==undefined&&object.html!==null){this.setHTML(object.html)}if(object.paddingLeft!==undefined&&object.paddingLeft!==null){this.setPaddingLeft(object.paddingLeft)}if(object.paddingRight!==undefined&&object.paddingRight!==null){this.setPaddingRight(object.paddingRight)}if(object.paddingBottom!==undefined&&object.paddingBottom!==null){this.setPaddingBottom(object.paddingBottom)}if(object.paddingTop!==undefined&&object.paddingTop!==null){this.setPaddingTop(object.paddingTop)}if(object.outerPaddingLeft!==undefined&&object.outerPaddingLeft!==null){this.setOuterPaddingLeft(object.outerPaddingLeft)}if(object.outerPaddingRight!==undefined&&object.outerPaddingRight!==null){this.setOuterPaddingRight(object.outerPaddingRight)}if(object.outerPaddingBottom!==undefined&&object.outerPaddingBottom!==null){this.setOuterPaddingBottom(object.outerPaddingBottom)}if(object.outerPaddingTop!==undefined&&object.outerPaddingTop!==null){this.setOuterPaddingTop(object.outerPaddingTop)}if(object.linePerpValue!==undefined&&object.linePerpValue!==null){this.setLinePerpValue(object.linePerpValue)}if(object.lineTValue!==undefined&&object.lineTValue!==null){this.setLineTValue(object.lineTValue)}if(object.cardinalityType!==undefined&&object.cardinalityType!==null){this.setCardinality(object.cardinalityType)}this.__computePositioning=true;return this}})}());(function(){var DEFAULT_STYLE={gradient_x1:"0%",gradient_x2:"0%",gradient_y1:"100%",gradient_y2:"-50%",stop_color_2:"#FFFFFF",zoom:1,stroke_dasharray:[Number.MAX_VALUE],stroke_linejoin:"miter",rx:10,ry:10};_gliffy.Shape=_gliffy.AbstractGeometry.extend({_tid:null,_fillColor:"#aaaaaa",_gradient:false,_opacity:1,style:null,node:null,svg:null,_dirty:true,_state:0,init:function(){this.style=$.extend({},DEFAULT_STYLE)},setTid:function(tid){this._tid=tid;this.style=$.extend({},DEFAULT_STYLE);this.markDirty()},getTid:function(){return this._tid},setFillColor:function(fillColor){this._fillColor=fillColor;if(this._fillColor==="none"){this._gradient=false}this.markDirty()},getFillColor:function(){return this._fillColor},setGradient:function(gradient){this._gradient=this._fillColor!=="none"&&gradient;this.markDirty()},getGradient:function(){return this._gradient},setDashStyle:function(dashArray,deserializing){if(this.hasMutable("dashStyle")||deserializing){if(dashArray instanceof Array){this.style.stroke_dasharray=dashArray}else{if(!dashArray||dashArray==="null"){this.style.stroke_dasharray=[Number.MAX_VALUE]}else{if(typeof dashArray==="string"){this.style.stroke_dasharray=$.map(dashArray.split(","),function(element){return parseFloat(element)})}}}this.markDirty()}return this.style.stroke_dasharray},getDashStyle:function(serializing){var dashStyle;if(serializing&&this.style.stroke_dasharray[0]>Number.MAX_VALUE/2){dashStyle=null}else{if(serializing){dashStyle=(this.style.stroke_dasharray||this.setDashStyle(null)).join(",")}else{dashStyle=this.style.stroke_dasharray||this.setDashStyle(null)}}return dashStyle},getMutableProperties:function(){if(this.node instanceof _gliffy.Node){return this.node.getShapeInformation().mutableProperties}else{return[]}},hasMutable:function(style){var mutableProperties;mutableProperties=this.getMutableProperties();return mutableProperties&&$.inArray(style,mutableProperties)>-1},isGradient:function(){return this.getGradient()},setOpacity:function(opacity){if(opacity!==this._opacity){this._opacity=opacity;this.markDirty()}},getOpacity:function(){return this._opacity},getState:function(){return this._state},setState:function(s){this._state=s;this.markDirty()},update:function(){var width=0,height=0,i=0,states;if(this._dirty){if(this.node){this.style.width=this.node.getWidth();this.style.height=this.node.getHeight()}this.style.opacity=this.getOpacity();this.style.stroke=this._strokeColor;this.style.gradient=this.getGradient();this.style.shadow=this.isDropShadow();if(this._fillColor!=="none"&&this.style.gradient){this.style.stop_multiply_color_2=_gliffy.ColorUtils.multiply(this._fillColor,"#AAAAAA")}this.style.fill=this._fillColor;this.style.stop_color_1=this._fillColor;this.style.center_x=width/2;this.style.center_y=height/2;if(this.node){states=this.node.getShapeInformation().states;if(states){for(i=0;i<states;i++){this.style["state"+i]=false}this.style["state"+this.getState()]=true}else{if(this.getState()===1){this.style.state0=false;this.style.state1=true}}}this.calculateStrokeOffset();this._dirty=false;return true}return false},getClassName:function(){return"Shape"},calculateGradientCoordinates:function(){var coords,width,height,rotation;if(this.node){width=this.node.getWidth();height=this.node.getHeight();rotation=this.node.getRotation()%360;if(rotation>135&&rotation<=225){coords={x1:"50%",y1:"150%",x2:"50%",y2:"0%"}}else{if(rotation>45&&rotation<=135){coords={x1:"-50%",y1:"50%",x2:"100%",y2:"50%"}}else{if(rotation>225&&rotation<=315){coords={x1:"150%",y1:"50%",x2:"0%",y2:"50%"}}else{coords={x1:"50%",y1:"-50%",x2:"50%",y2:"100%"}}}}}return coords},calculateStrokeOffset:function(){var width,height,maxMiter,shadow_offset;if(this.node){width=this.node?this.node.getWidth():0;height=this.node?this.node.getHeight():0;this.style.stroke_width=this.getStrokeWidth();maxMiter=this.maxMiterLength();this.style.graphic_width=width+maxMiter+2+this.style.stroke_width;this.style.graphic_height=height+maxMiter+2+this.style.stroke_width;shadow_offset=this.calculateShadowOffset();this.style.shadow_x=shadow_offset.x;this.style.shadow_y=shadow_offset.y;this.style.graphic_width=this.style.shadow?Math.abs(this.style.shadow_x)+this.style.graphic_width:this.style.graphic_width;this.style.graphic_height=this.style.shadow?Math.abs(this.style.shadow_y)+this.style.graphic_height:this.style.graphic_height;this.style.graphic_x_offset=maxMiter/2+-1*Math.min(shadow_offset.x,0);this.style.graphic_y_offset=maxMiter/2+-1*Math.min(shadow_offset.y,0);this.style.line_offset_x=0;this.style.line_offset_y=0;this.style.stroke_offset=this.style.stroke_width/2;if(_gliffy.shapeLibrary){_gliffy.shapeLibrary.customFunction(this.getTid(),this.style)}this.style.offset_x=this.style.graphic_x_offset+this.style.stroke_offset;this.style.offset_y=this.style.graphic_y_offset+this.style.stroke_offset}},maxMiterLength:function(){var defaultCanvasMiterLimit=10;return defaultCanvasMiterLimit*this.style.stroke_width},__toObject:function(){var dashStyle,returnObject;returnObject={tid:this.getTid(),strokeWidth:this.getStrokeWidth(),strokeColor:this.getStrokeColor(),fillColor:this.getFillColor(),gradient:this.isGradient(),dropShadow:this.isDropShadow(),state:this.getState(),shadowX:this.getShadowX(),shadowY:this.getShadowY(),opacity:this.getOpacity()};dashStyle=this.getDashStyle({serializing:true});if(dashStyle){returnObject.dashStyle=dashStyle}return returnObject},applyStyle:function(style){if(style==null){return}var shadowSize;this.setGradient(style.gradient);this.setDropShadow(style.shadow);this.setFillColor(style.fill);if(style.strokeWidth!==undefined&&style.strokeWidth!==null&&style.strokeWidth!=="null"){this.setStrokeWidth(style.strokeWidth)}if(style.stroke){this.setStrokeColor(style.stroke)}if(style.dashStyle){this.setDashStyle(style.dashStyle)}if(style.opacity){this.setOpacity(style.opacity)}if(style.shadow){this.setDropShadow(style.shadow)}},__fromObject:function(object){if(object.tid!==undefined){this.setTid(object.tid)}if(object.strokeWidth!==undefined){this.setStrokeWidth(object.strokeWidth)}if(object.strokeColor!==undefined){this.setStrokeColor(object.strokeColor)}if(object.dashStyle!==undefined){this.setDashStyle(object.dashStyle,{deserializing:true})}if(object.fillColor!==undefined){this.setFillColor(object.fillColor)}if(object.gradient!==undefined){this.setGradient(object.gradient)}if(object.dropShadow!==undefined){this.setDropShadow(object.dropShadow)}if(object.shadowX!==undefined){this.setShadowX(object.shadowX)}if(object.shadowY!==undefined){this.setShadowY(object.shadowY)}if(object.opacity!==undefined){this.setOpacity(object.opacity)}if(object.state!==undefined){this.setState(object.state)}return this}})}());(function(){var DEFAULT_STYLE={zoom:1,stroke_linejoin:"miter"},TID="com.gliffy.stencil.custom.svg.static";_gliffy.Svg=_gliffy.AbstractGeometry.extend({_url:null,style:null,node:null,_dirty:true,embeddedResourceId:null,init:function(node){this.node=node;this.style=$.extend({},DEFAULT_STYLE)},markDirty:function(){this._dirty=true;if(this.node){this.node.markDirty()}},getTid:function(){return TID},getEmbeddedResourceId:function(){return this.embeddedResourceId},setEmbeddedResourceId:function(id){this.embeddedResourceId=id;this.markDirty();if(this.node){this.node.setFlag("skin")}},setShadowX:function(shadowX){this._shadowX=shadowX;this.markDirty()},getShadowX:function(){return this._shadowX},setShadowY:function(shadowY){this._shadowY=shadowY;this.markDirty()},getShadowY:function(){return this._shadowY},update:function(){if(this._dirty){var width=0,height=0,shadow_offset,maxMiter;if(this.node){width=this.node.getWidth();height=this.node.getHeight();this.style.width=width;this.style.height=height}this.style.center_x=width/2;this.style.center_y=height/2;this.style.graphic_width=(this.node)?this.node.getWidth():0;this.style.graphic_height=(this.node)?this.node.getHeight():0;this.style.stroke_width=10;maxMiter=this.maxMiterLength();this.style.graphic_width=width+maxMiter+2+this.style.stroke_width;this.style.graphic_height=height+maxMiter+2+this.style.stroke_width;shadow_offset=this.calculateShadowOffset();this.style.shadow_x=shadow_offset.x;this.style.shadow_y=shadow_offset.y;this.style.graphic_width=this.style.shadow?Math.abs(this.style.shadow_x)+this.style.graphic_width:this.style.graphic_width;this.style.graphic_height=this.style.shadow?Math.abs(this.style.shadow_y)+this.style.graphic_height:this.style.graphic_height;this.style.graphic_x_offset=maxMiter/2+-1*Math.min(shadow_offset.x,0);this.style.graphic_y_offset=maxMiter/2+-1*Math.min(shadow_offset.y,0);this.style.line_offset_x=0;this.style.line_offset_y=0;this.style.stroke_offset=this.style.stroke_width/2;this.style.offset_x=this.style.graphic_x_offset+this.style.stroke_offset;this.style.offset_y=this.style.graphic_y_offset+this.style.stroke_offset;this._dirty=false;return true}return false},maxMiterLength:function(){var defaultCanvasMiterLimit=10;return defaultCanvasMiterLimit*this.style.stroke_width},getClassName:function(){return"Svg"},__toObject:function(){return{embeddedResourceId:this.getEmbeddedResourceId(),strokeWidth:this.getStrokeWidth(),strokeColor:this.getStrokeColor(),dropShadow:this.isDropShadow(),shadowX:this.getShadowX(),shadowY:this.getShadowY()}},__fromObject:function(object){if(object.embeddedResourceId!==undefined){this.setEmbeddedResourceId(object.embeddedResourceId)}if(object.strokeWidth!==undefined){this.setStrokeWidth(object.strokeWidth)}if(object.strokeColor!==undefined){this.setStrokeColor(object.strokeColor)}if(object.dropShadow!==undefined){this.setDropShadow(object.dropShadow)}if(object.shadowX!==undefined){this.setShadowX(object.shadowX)}if(object.shadowY!==undefined){this.setShadowY(object.shadowY)}}})}());(function(){var DEFAULT_STYLE={text_background:true,text_background_fill:true,start_arrow:"none",end_arrow:"none",zoom:1,stroke_dasharray:null,stroke_linejoin:"miter"},TID="path",START_MARKER="start",END_MARKER="end",ARROW_SIZE=10,INTERPOLATION_TYPE={linear:0,quadratic:1},INTERPOLATION_LOOKUP={0:"linear",1:"quadratic"};_gliffy.Line=_gliffy.Graphic.extend({_strokeWidth:2,_strokeColor:"#000000",_fillColor:"none",_fillId:null,_dashStyle:null,_startArrow:null,_endArrow:null,_pointPath:null,_drawCommands:null,_centerLinePoint:null,_startArrowRotation:"auto",_endArrowRotation:"auto",_interpolationType:INTERPOLATION_TYPE.linear,_ortho:false,_length:0,_controlPath:null,style:null,node:null,aabb:null,_dirty:true,OVERLAY_EXTEND:7,OVERLAY_DISPLAY_EXTEND:5,LINE_TYPE_STRAIGHT:"straight",LINE_TYPE_ORTHO_RIGHT_ANGLE:"ortho-right-angle",LINE_TYPE_ORTHO_ROUNDED:"ortho-rounded",LINE_TYPE_QUADRATIC_BEZIER:"quad-bezier",LINE_TYPE_ICON_MAP:{straight:"icon gliffy-icon-properties-button-straight",ortho_right_angle:"icon gliffy-icon-properties-button-ortho-right-angle",ortho_rounded:"icon gliffy-icon-properties-button-ortho-rounded",quad_bezier:"icon gliffy-icon-properties-button-quad-bezier"},_overlay:false,init:function(node,start,end){this.node=node;this.style=$.extend({},DEFAULT_STYLE);this.aabb=_gliffy.BoundingBox();if(start&&end){this._controlPath=[[start.x,start.y],[end.x,end.y]]}else{this._controlPath=[[0,0],[0,0]]}this._super()},getTid:function(){return TID},getLineStyle:function(){var style;style=new _gliffy.LineStyle();style.strokeWidth=this.getStrokeWidth();style.stroke=this.getStrokeColor();style.fill=this.getFillColor();style.dashStyle=this.getDashStyle();style.startArrow=this.getStartArrow();style.endArrow=this.getEndArrow();return style},setStartArrow:function(startArrow){this._startArrow=startArrow;this.markDirty()},getStartArrowTid:function(){if(this._startArrow!==0&&this._startArrow!==null&&this._startArrow!==undefined&&this._startArrow!=="none"){return"com.gliffy.stencil.marker_start.v"+this._startArrow}return null},getEndArrowTid:function(){if(this._endArrow!==0&&this._endArrow!==null&&this._endArrow!==undefined&&this._endArrow!=="none"){return"com.gliffy.stencil.marker_end.v"+this._endArrow}return null},setStartArrowRotation:function(rotation){this._startArrowRotation=rotation;this.markDirty()},getStartArrowRotation:function(){return this._startArrowRotation},setEndArrowRotation:function(rotation){this._endArrowRotation=rotation;this.markDirty()},getEndArrowRotation:function(){return this._endArrowRotation},getStartArrow:function(){if(this._startArrow==="none"||this._startArrow===null||this._startArrow===undefined){this._startArrow=0}return this._startArrow},setEndArrow:function(endArrow){this._endArrow=endArrow;this.markDirty()},getEndArrow:function(){if(this._endArrow==="none"||this._endArrow===null||this._endArrow===undefined){this._endArrow=0}return this._endArrow},setStrokeWidth:function(strokeWidth){this._strokeWidth=strokeWidth;if(strokeWidth<3){this.setFillColor(null)}if(this.node){this.node.setFlag("bounds")}this.markDirty()},getStrokeWidth:function(){return this._strokeWidth},setStrokeColor:function(strokeColor){this._strokeColor=strokeColor;this.markDirty()},getStrokeColor:function(){return this._strokeColor},setFillColor:function(fillColor){this._fillColor=fillColor;if(this._fillColor===null){this._fillColor="none"}this.markDirty()},getFillColor:function(){return this._fillColor},getStartConnectionId:function(){var constraint;if(this.node){constraint=this.node.getConstraints().getStartConstraint();if(constraint){return constraint.nodeId}else{return null}}else{return null}},getEndConnectionId:function(){var constraint;if(this.node){constraint=this.node.getConstraints().getEndConstraint();if(constraint){return constraint.nodeId}else{return null}}else{return null}},setStartConnection:function(node,ratio){var worldStartPoint;if(node){if(!ratio){worldStartPoint=this.getWorldControlPoint(0);ratio=node.worldPointToRatio(worldStartPoint.x,worldStartPoint.y)}this.node.getConstraints().add(new _gliffy.StartPositionConstraint(node,ratio.x,ratio.y))}else{this.node.getConstraints().removeStartConstraint()}this.markDirty()},getStartConnection:function(){var startConnectionId=this.getStartConnectionId(),node;if(startConnectionId!==null&&this.node&&this.node.stage){node=this.node.stage.find(startConnectionId);if(node&&node.hasConnectionIndices()){return node}}return null},getStartConnectionRatio:function(){var constraint=this.node.getConstraints().getStartConstraint();if(constraint){return constraint.getRatio()}else{return null}},setEndConnection:function(node,ratio){var worldEndPoint;if(node){if(!ratio){worldEndPoint=this.getWorldControlPoint(this.getControlPointCount()-1);ratio=node.worldPointToRatio(worldEndPoint.x,worldEndPoint.y)}this.node.getConstraints().add(new _gliffy.EndPositionConstraint(node,ratio.x,ratio.y))}else{this.node.getConstraints().removeEndConstraint()}this.markDirty()},connectedToUML2:function(){var startConnection=this.getStartConnection(),endConnection=this.getEndConnection();return((startConnection&&startConnection.isUML2())||(endConnection&&endConnection.isUML2()))},connectedToBPMN:function(){var startConnection=this.getStartConnection(),endConnection=this.getEndConnection();return((startConnection&&startConnection.isBPMN())||(endConnection&&endConnection.isBPMN()))},connectedToERD:function(){var startConnection=this.getStartConnection(),endConnection=this.getEndConnection();return((startConnection&&startConnection.isERD())||(endConnection&&endConnection.isERD()))},getEndConnectionRatio:function(){var constraint=this.node.getConstraints().getEndConstraint();if(constraint){return constraint.getRatio()}else{return null}},getEndConnection:function(){var endConnectionId=this.getEndConnectionId(),node;if(endConnectionId!==null&&this.node&&this.node.stage){node=this.node.stage.find(endConnectionId);if(node&&node.hasConnectionIndices()){return node}}return null},setDashStyle:function(dashStyle){this._dashStyle=dashStyle;this.markDirty()},setOverlay:function(overlay){this._overlay=overlay;this.markDirty()},getOverlay:function(){return this._overlay},getDashStyle:function(){return this._dashStyle},__getStrokePadding:function(){return Math.ceil(this.style.stroke_width+this.OVERLAY_EXTEND)/2},update:function(){if(this._dirty){var stage=null,background="#ffffff",width=0,height=0,padding,dashes,i;if(this.editable.isEditable&&this.node){this.editable.scaleControlPath(this.node.getScaleX(),this.node.getScaleY());this.editable.computeBestPath()}this._clearArrowMarkerAttributes(START_MARKER,this.style.start_arrow);this._clearArrowMarkerAttributes(END_MARKER,this.style.end_arrow);this.style.stroke=this._strokeColor;this.style.fill=this._fillColor;this.style.stroke_width=this.getStrokeWidth();if(this._dashStyle){dashes=this._dashStyle.split(",");for(i=0;i<dashes.length;i++){dashes[i]=parseFloat(dashes[i])*this.style.stroke_width}this.style.stroke_dasharray=dashes.join(",")}else{this.style.stroke_dasharray=null}this.style.start_arrow=this._startArrow||"none";this.style.end_arrow=this._endArrow||"none";this.style.start_arrow_tid=this.getStartArrowTid();this.style.end_arrow_tid=this.getEndArrowTid();this.aabb=this.getControlPathAabb(true);this.worldAabb=this.getWorldAabb(true);if(this.node){width=this.node.getWidth();height=this.node.getHeight();if(this.node.stage){stage=this.node.stage;background=stage.background}this.style.width=width;this.style.height=height}this.style.marker_fill=(background!=="transparent"?background:"#FFFFFF");this.style.center_x=width/2;this.style.center_y=height/2;this._drawCommands=this._generateDrawCommands();this._pointPath=_gliffy.Utils.buildPointsPathFromDrawingCommand(this._drawCommands);this._length=_gliffy.candash.getPathDistance(this._pointPath);if(this.editable.isEditable&&this.getInterpolationType()===INTERPOLATION_TYPE.quadratic){this.setStartArrowRotation(this.getQuadraticLineAngleAtStartPoint());this.setEndArrowRotation(this.getQuadraticLineAngleAtEndPoint())}else{this.setStartArrowRotation("auto");this.setEndArrowRotation("auto")}this.calculateStrokeOffset();this._dirty=false;return true}return false},calculateStrokeOffset:function(){if(this.node&&this.node.stage){var worldAabb,dimension;this.generateArrowMarkerAttributes(START_MARKER,this.style.start_arrow);this.generateArrowMarkerAttributes(END_MARKER,this.style.end_arrow);worldAabb=this.getWorldAabb();dimension=worldAabb.getDimension();this.style.width=dimension.x;this.style.height=dimension.y;this.style.stroke_offset=0;this.style.offset_x=this.node.worldTransform.getTranslateX()-worldAabb.min.x;this.style.offset_y=this.node.worldTransform.getTranslateY()-worldAabb.min.y;this.style.pos_x=this.node.worldTransform.getTranslateX();this.style.pos_y=this.node.worldTransform.getTranslateY();this.style.graphic_width=dimension.x;this.style.graphic_height=dimension.y}},maxMiterLength:function(){var defaultCanvasMiterLimit=10;return defaultCanvasMiterLimit*this.style.stroke_width},getClassName:function(){return"Line"},_clearArrowMarkerAttributes:function(arrowPos,arrowType){if(arrowType){delete this.style["marker_"+arrowPos+"_url"];delete this.style[arrowType+"_"+arrowPos];delete this.style["marker_"+arrowPos+"_width"];delete this.style["marker_"+arrowPos+"_height"];delete this.style["marker_"+arrowPos+"_viewbox"];delete this.style["marker_"+arrowPos+"_orient"];delete this.style["marker_"+arrowPos+"_clearx"];delete this.style["marker_"+arrowPos+"_cleary"];delete this.style["marker_"+arrowPos+"_refx"];delete this.style["marker_"+arrowPos+"_refy"]}},generateArrowMarkerAttributes:function(arrowPos,arrowType){this.style["marker_"+arrowPos+"_url"]=(arrowType!=="none")?"url(#"+arrowType+"_"+arrowPos+")":"none";this.style["marker_"+arrowPos+"_orient"]=(arrowPos==="start")?this.getStartArrowRotation():this.getEndArrowRotation();this.style[arrowType+"_"+arrowPos]=true;if(arrowType!=="none"){this.style["marker_"+arrowPos+"_viewbox"]="0 0 10 10";if(arrowType===1){this.style["marker_"+arrowPos+"_width"]=(this.style.stroke_width===1?20:10);this.style["marker_"+arrowPos+"_height"]=(this.style.stroke_width===1?20:10)}else{if(arrowType===2||arrowType===3){var w=22-4*this.style.stroke_width;var h=22-4*this.style.stroke_width;this.style["marker_"+arrowPos+"_width"]=Math.max(10,w);this.style["marker_"+arrowPos+"_height"]=Math.max(10,h)}else{if(arrowType===17){if(this.style.stroke_width<4){var w=30-5*this.style.stroke_width;var h=30-5*this.style.stroke_width;this.style["marker_"+arrowPos+"_width"]=Math.max(10,w);this.style["marker_"+arrowPos+"_height"]=Math.max(10,h)}else{this.style["marker_"+arrowPos+"_width"]=10+(10-this.style.stroke_width);this.style["marker_"+arrowPos+"_height"]=10+(10-this.style.stroke_width)}}else{this.style.marker_strokewidth=this.style.stroke_width;if(this.style.stroke_width===1){this.style.marker_viewbox_width=20;this.style.marker_viewbox_height=20;this.style["marker_"+arrowPos+"_width"]=20;this.style["marker_"+arrowPos+"_height"]=20;this.style.marker_start_refx=-1;this.style.marker_end_refx=15}else{this.style["marker_"+arrowPos+"_width"]=(this.style.stroke_width*10);this.style["marker_"+arrowPos+"_height"]=(this.style.stroke_width*10);this.style.marker_viewbox_width=(this.style.stroke_width*10);this.style.marker_viewbox_height=(this.style.stroke_width*10);this.style.marker_start_refx=-1*this.style.stroke_width;this.style.marker_end_refx=14+this.style.stroke_width}}}}if(arrowPos==="start"){if(arrowType===1){this.style.marker_start_cleary=3;this.style.marker_start_clearx=-2}else{if(arrowType===2){this.style.marker_start_cleary=4;this.style.marker_start_clearx=-2}else{if(arrowType===3){this.style.marker_start_cleary=4;this.style.marker_start_clearx=-2}else{if(arrowType===4){this.style.marker_start_cleary=5;this.style.marker_start_clearx=-12}else{if(arrowType===5){this.style.marker_start_cleary=5;this.style.marker_start_clearx=-12}else{if(arrowType===6){this.style.marker_start_cleary=5;this.style.marker_start_clearx=-12}else{if(arrowType===7){this.style.marker_start_cleary=4;this.style.marker_start_clearx=-10}else{if(arrowType===8){this.style.marker_start_cleary=0;this.style.marker_start_clearx=-10}else{if(arrowType===15){this.style.marker_start_cleary=1;this.style.marker_start_clearx=-12}else{if(arrowType===17){this.style.marker_start_cleary=0;this.style.marker_start_clearx=0}}}}}}}}}}}else{if(arrowType===1){this.style.marker_end_cleary=3;this.style.marker_end_clearx=9}else{if(arrowType===2){this.style.marker_end_cleary=4;this.style.marker_end_clearx=7}else{if(arrowType===3){this.style.marker_end_cleary=4;this.style.marker_end_clearx=7}else{if(arrowType===4){this.style.marker_end_cleary=5;this.style.marker_end_clearx=12}else{if(arrowType===5){this.style.marker_end_cleary=5;this.style.marker_end_clearx=12}else{if(arrowType===6){this.style.marker_end_cleary=5;this.style.marker_end_clearx=12}else{if(arrowType===7){this.style.marker_end_cleary=4;this.style.marker_end_clearx=10}else{if(arrowType===8){this.style.marker_end_cleary=0;if(this.style.stroke_width>3){this.style.marker_end_clearx=16}else{this.style.marker_end_clearx=13}}else{if(arrowType===15){this.style.marker_end_cleary=1;this.style.marker_end_clearx=15}else{if(arrowType===17){this.style.marker_end_cleary=0;this.style.marker_end_clearx=2}}}}}}}}}}}}},getControlPathAabb:function(excludeArrows){var boundingBox=_gliffy.BoundingBox.SMALLEST.clone(),controlPath=this.getControlPath(),strokePadding=this.__getStrokePadding(),i;for(i=0;i<controlPath.length;i++){boundingBox.grow(controlPath[i][0],controlPath[i][1])}boundingBox.extend(strokePadding);if(excludeArrows!==true){boundingBox.add(this.getStartArrowAabb());boundingBox.add(this.getEndArrowAabb())}return boundingBox},getWorldAabb:function(excludeArrows){var boundingBox=_gliffy.BoundingBox.SMALLEST.clone(),worldControlPath=this.getWorldControlPath(),i,strokePadding=this.__getStrokePadding();for(i=0;i<worldControlPath.length;i++){boundingBox.grow(worldControlPath[i][0],worldControlPath[i][1])}boundingBox.extend(strokePadding);if(excludeArrows!==true){boundingBox.add(this.getStartArrowWorldAabb());boundingBox.add(this.getEndArrowWorldAabb())}return boundingBox},getStartArrowWorldAabb:function(){var startPoint=this.getWorldControlPoint(0);if(this.style.start_arrow!=="none"){return this.__getArrowWorldAabb(startPoint)}else{return new _gliffy.BoundingBox(startPoint.x,startPoint.y,startPoint.x,startPoint.y)}},getEndArrowWorldAabb:function(){var endPoint=this.getWorldControlPoint(this.getControlPointCount()-1);if(this.style.end_arrow!=="none"){return this.__getArrowWorldAabb(endPoint)}else{return new _gliffy.BoundingBox(endPoint.x,endPoint.y,endPoint.x,endPoint.y)}},__getArrowWorldAabb:function(point){var boundingBox=new _gliffy.BoundingBox(point.x,point.y,point.x,point.y);boundingBox.extend(ARROW_SIZE+this.maxMiterLength());return boundingBox},getStartArrowAabb:function(){var startPoint=this.getControlPoint(0);if(this.style.start_arrow!=="none"){return this.__getArrowAabb(startPoint)}else{return new _gliffy.BoundingBox(startPoint.x,startPoint.y,startPoint.x,startPoint.y)}},getEndArrowAabb:function(){var endPoint=this.getControlPoint(this.getControlPointCount()-1);if(this.style.end_arrow!=="none"){return this.__getArrowAabb(endPoint)}else{return new _gliffy.BoundingBox(endPoint.x,endPoint.y,endPoint.x,endPoint.y)}},__getArrowAabb:function(point){var boundingBox=new _gliffy.BoundingBox(point.x,point.y,point.x,point.y);boundingBox.extend(ARROW_SIZE+this.maxMiterLength());return boundingBox},getControlPoint:function(index){return new _gliffy.Vec2(this._controlPath[index][0],this._controlPath[index][1])},getWorldControlPoint:function(index){var local=this.getControlPoint(index);if(this.node){return this.node.worldTransform.transformPoint(local.x,local.y)}},setControlPoint:function(index,point){if(this._controlPath){this._controlPath[index][0]=point.x;this._controlPath[index][1]=point.y}this.markDirty()},setWorldControlPoint:function(index,worldPoint){var local;if(this.node){local=this.node.worldTransform.createInverse().transformPoint(worldPoint.x,worldPoint.y)}else{local=worldPoint}this.setControlPoint(index,local)},getWorldControlPath:function(){if(this.node){return this.transformPath(this._controlPath,this.node.worldTransform)}else{return this.getControlPath()}},setWorldControlPath:function(worldControlPath){this.setControlPath(this.transformPath(worldControlPath,this.node.worldTransform.createInverse()))},getControlPath:function(){var path=[],i;for(i=0;i<this._controlPath.length;i++){path.push([this._controlPath[i][0],this._controlPath[i][1]])}return path},setControlPath:function(path){if(path){this._controlPath=path}else{this._controlPath=[[0,0],[0,0]]}},getControlPointCount:function(){return this._controlPath.length},getSegmentCount:function(){return this.getControlPointCount()-1},isSegmentHorizontal:function(index){return _gliffy.Utils.isHorizontal(this.getWorldControlPoint(index),this.getWorldControlPoint(index+1))},isLinearLine:function(){var i,numSegments=this.getSegmentCount(),horizontalCount=0,verticalCount=0;for(i=0;i<numSegments;i++){if(this.isSegmentHorizontal(i)){horizontalCount++}else{verticalCount++}}return((horizontalCount===numSegments)||(verticalCount===numSegments))},getNormalizedSegmentAngle:function(p1,p2){var x=0,y=1,dx=p2[x]-p1[x],dy=p2[y]-p1[y],rot=Math.atan(dy/dx)*180/Math.PI;if(p1[x]>p2[x]&&p1[y]<p2[y]){rot=180+rot}else{if(p2[x]<p1[x]&&p2[y]<=p1[y]){rot=180+rot}else{if(p2[x]>=p1[x]&&p2[y]<p1[y]){rot=360+rot}}}return rot},transformPath:function(path,transform){var i,controlPoint,result=[];for(i=0;i<path.length;i++){controlPoint=path[i];controlPoint=transform.transformPoint(controlPoint[0],controlPoint[1]);result.push([controlPoint.x,controlPoint.y])}return result},isOrtho:function(){return this._ortho},setOrtho:function(ortho){this._ortho=ortho;this.markDirty()},getLineType:function(){var lineType=this.LINE_TYPE_STRAIGHT;if(!this._ortho&&this._interpolationType===0&&this._cornerRadius===null){lineType=this.LINE_TYPE_STRAIGHT}else{if(this._ortho&&this._interpolationType===0&&this._cornerRadius===null){lineType=this.LINE_TYPE_ORTHO_RIGHT_ANGLE}else{if(this._ortho&&this._interpolationType===0&&this._cornerRadius===10){lineType=this.LINE_TYPE_ORTHO_ROUNDED}else{if(this._ortho&&this._interpolationType===1&&this._cornerRadius===null){lineType=this.LINE_TYPE_QUADRATIC_BEZIER}}}}return lineType},getInterpolationType:function(){return this._interpolationType},setInterpolationType:function(interpolationType){this._interpolationType=interpolationType;this.markDirty()},getCornerRadius:function(){return this._cornerRadius},setCornerRadius:function(cornerRadius){this._cornerRadius=cornerRadius;this.markDirty()},getPointAt:function(ratio){var linePoint;linePoint=_gliffy.candash.getPointInPathAtT(this._pointPath,ratio);linePoint=this.node.worldTransform.createInverse().transformPoint(linePoint.x,linePoint.y);return linePoint},getPointAtDistance:function(distance){var linePoint;linePoint=_gliffy.candash.getPointInPathAtDistance(this._pointPath,distance);linePoint=this.node.worldTransform.createInverse().transformPoint(linePoint.x,linePoint.y);return linePoint},getPathLength:function(){return this._length},getPointInPathAtT:function(ratio){return _gliffy.candash.getPointInPathAtT(this._pointPath,ratio)},getPointInPathAtDistance:function(distance){return _gliffy.candash.getPointInPathAtDistance(this._pointPath,distance,this._length)},getSlopeAtDistance:function(distance){var startDistance,endDistance;if(distance<3){startDistance=0;endDistance=4}else{if(distance>=this._length.totalDistance-2){startDistance=this._length.totalDistance-4;endDistance=this._length.totalDistance}else{startDistance=distance-2;endDistance=distance+2}}return _gliffy.Vec2.difference(_gliffy.candash.getPointInPathAtDistance(this._pointPath,endDistance,this._length),_gliffy.candash.getPointInPathAtDistance(this._pointPath,startDistance,this._length)).safeNormalize()},getSlopeAtT:function(t){return this.getSlopeAtDistance(this._length.totalDistance*t)},getPointPath:function(){return this._pointPath},getDrawCommands:function(){return this._drawCommands},hasCardinality:function(type){var i=0,graphic;type=type||null;if(this.node.children){for(i=0;i<this.node.children.length;i++){graphic=this.node.children[i].getGraphic();if(type){if(graphic.getCardinality&&graphic.getCardinality()===type){return true}}else{if(graphic.isCardinality&&graphic.isCardinality()){return true}}}}return false},getQuadraticLineAngleAtStartPoint:function(){var a,b,point=_gliffy.candash.getPointInPathAtDistance(this._pointPath,10,this._length);a=point.y-this._pointPath[0][0].y;b=point.x-this._pointPath[0][0].x;return this.__normalizeIncidenceAngle(Math.atan(a/b)*180/Math.PI,this.editable.getMagnitudeAndAxis("start"))},getQuadraticLineAngleAtEndPoint:function(){var a,b,point=_gliffy.candash.getPointInPathAtDistance(this._pointPath,this.getPathLength().totalDistance-10,this._length);a=point.y-this._pointPath[this._pointPath.length-1][this._pointPath[this._pointPath.length-1].length-1].y;b=point.x-this._pointPath[this._pointPath.length-1][this._pointPath[this._pointPath.length-1].length-1].x;return this.__normalizeIncidenceAngle(Math.atan(a/b)*180/Math.PI,this.editable.getMagnitudeAndAxis("end"))},__normalizeIncidenceAngle:function(angle,magAxis){if(magAxis.axis==="y"){if(magAxis.mag===1&&angle<0){angle=angle+180}else{if(magAxis.mag===-1&&angle>0){angle=angle-180}}}else{if(magAxis.mag===-1&&magAxis.axis==="x"){angle=angle+180}}return angle},applyStyle:function(style){if(style.strokeWidth){this.setStrokeWidth(style.strokeWidth)}if(style.stroke){this.setStrokeColor(style.stroke)}this.setStartArrow(style.startArrow);this.setEndArrow(style.endArrow);if(!this._ortho){this.editable.setOrthoMode(_gliffy.Editor.ORTHO_MODE.straight)}else{if(style.orthoMode!==undefined&&style.orthoMode!==null){this.editable.setOrthoMode(style.orthoMode)}}if(style.fill&&this._strokeWidth>2){this.setFillColor(style.fill)}else{this.setFillColor(null)}if(style.dashStyle!==undefined){this.setDashStyle(style.dashStyle)}},_generateDrawCommands:function(){if(this._controlPath.length>2&&this.getInterpolationType()===INTERPOLATION_TYPE.quadratic){return this._generateQuadratic(this.getWorldControlPath(),this.getCornerRadius())}else{return this._generateStraight(this.getWorldControlPath(),this.getCornerRadius())}},_generateStraight:function(controlPath,cornerRadius){var i,path=[],cur,next,offset0,offset0Mag,l,q1,q1Mag,prev;if(cornerRadius===null||cornerRadius===0||controlPath.length<3){for(i=0;i<controlPath.length;i++){path.push({name:(i===0?"M":"L"),args:this._controlPointToString(controlPath[i])})}}else{path.push({name:"M",args:this._controlPointToString(controlPath[0])});for(i=1;i<controlPath.length-1;i++){cur=new _gliffy.Vec2(controlPath[i][0],controlPath[i][1]);prev=new _gliffy.Vec2(controlPath[i-1][0],controlPath[i-1][1]);next=new _gliffy.Vec2(controlPath[i+1][0],controlPath[i+1][1]);offset0=cur.clone().subtract(prev);offset0Mag=offset0.magnitude();if(offset0Mag>cornerRadius*2){offset0.normalize().scale(cornerRadius)}else{offset0.safeNormalize().scale(offset0Mag/2)}l=cur.clone().subtract(offset0);q1=next.clone().subtract(cur);q1Mag=q1.magnitude();if(q1Mag>=cornerRadius*2){q1.normalize().scale(cornerRadius)}else{q1.safeNormalize().scale(q1Mag/2)}q1.add(cur);path.push({name:("L"),args:this._vec2ToString(l)});path.push({name:("Q"),args:this._vec2ToString(cur)+" "+this._vec2ToString(q1)})}path.push({name:"L",args:this._controlPointToString(controlPath[controlPath.length-1])})}return path},_generateQuadratic:function(controlPath,cornerRadius){if(controlPath.length<3){throw new Error("curved lines must have at least 3 points")}var len=controlPath.length,midPath,i,path;midPath=[controlPath[0]];for(i=1;i<len-2;i++){midPath.push(controlPath[i]);midPath.push([(controlPath[i][0]+controlPath[i+1][0])/2,(controlPath[i][1]+controlPath[i+1][1])/2])}midPath.push(controlPath[len-2]);midPath.push(controlPath[len-1]);path=[];path.push({name:"M",args:this._controlPointToString(midPath[0])});for(i=1;i<midPath.length-1;i+=2){path.push({name:"Q",args:this._controlPointToString(midPath[i])+" "+this._controlPointToString(midPath[i+1])})}return path},_controlPointToString:function(controlPoint){return(controlPoint[0])+","+(controlPoint[1])},_vec2ToString:function(vec2,offset){return(vec2.x)+","+(vec2.y)},__toObject:function(){this.update();return $.extend({strokeWidth:this.getStrokeWidth(),strokeColor:this.getStrokeColor(),fillColor:this.getFillColor(),dashStyle:this.getDashStyle(),startArrow:this.getStartArrow(),endArrow:this.getEndArrow(),startArrowRotation:this.getStartArrowRotation(),endArrowRotation:this.getEndArrowRotation(),ortho:this._ortho,interpolationType:INTERPOLATION_LOOKUP[this._interpolationType],cornerRadius:this._cornerRadius,controlPath:this._controlPath},this.editable.toObject())},__fromObject:function(object){if(object.strokeWidth!==undefined){this.setStrokeWidth(object.strokeWidth)}if(object.strokeColor!==undefined){this.setStrokeColor(object.strokeColor)}if(object.dashStyle!==undefined){this.setDashStyle(object.dashStyle)}if(object.startArrow!==undefined){this.setStartArrow(object.startArrow)}if(object.endArrow!==undefined){this.setEndArrow(object.endArrow)}if(object.startArrowRotation!==undefined){this.setStartArrowRotation(object.startArrowRotation)}if(object.endArrowRotation!==undefined){this.setEndArrowRotation(object.endArrowRotation)}if(object.fillColor!==undefined){this.setFillColor(object.fillColor)}if(object.interpolationType!==undefined){this._interpolationType=INTERPOLATION_TYPE[object.interpolationType]||INTERPOLATION_TYPE.linear}if(object.cornerRadius!==undefined){this._cornerRadius=object.cornerRadius}if(object.ortho!==undefined){this._ortho=object.ortho}if(object.controlPath!==undefined){this._controlPath=object.controlPath}if(this.editable.isEditable){this.editable.fromObject(object)}return this}});_gliffy.Line.INTERPOLATION_TYPE=INTERPOLATION_TYPE}());(function(){var DEFAULT_STYLE={zoom:1,stroke_linejoin:"miter"},TID="com.gliffy.shapes.image",CONNECTION_PT_PATTERN=["Midpoint","Octagon","Center"];_gliffy.Image=_gliffy.AbstractGeometry.extend({_url:null,style:null,node:null,svg:null,imgWidth:null,imgHeight:null,useOriginalDimensions:false,_dirty:true,init:function(node){this.node=node;this.style=$.extend({},DEFAULT_STYLE)},markDirty:function(){this._dirty=true;if(this.node){this.node.markDirty()}},setImgWidth:function(width){this.imgWidth=width},getImgWidth:function(){return this.imgWidth},setImgHeight:function(height){this.imgHeight=height},getImgHeight:function(){return this.imgHeight},resizeToOriginalDimensions:function(){this.useOriginalDimensions=true;this.markDirty();if(this.node){this.node.setFlag("skin")}},getTid:function(){return TID},setUrl:function(url){this._url=url;this.markDirty();if(this.node){this.node.setFlag("skin")}},getUrl:function(){return this._url},setShadowX:function(shadowX){this._shadowX=shadowX;this.markDirty()},getShadowX:function(){return this._shadowX},setShadowY:function(shadowY){this._shadowY=shadowY;this.markDirty()},getShadowY:function(){return this._shadowY},update:function(){if(this._dirty){var stage=null,width=0,height=0,shadow_offset;if(this.node){stage=this.node.stage;width=this.node.getWidth();height=this.node.getHeight();this.style.width=width;this.style.height=height}this.style.center_x=width/2;this.style.center_y=height/2;this.style.graphic_width=(this.node)?this.node.getWidth():0;this.style.graphic_height=(this.node)?this.node.getHeight():0;shadow_offset=this.calculateShadowOffset();this.style.shadow_x=shadow_offset.x;this.style.shadow_y=shadow_offset.y;this.style.graphic_width=this._dropShadow?Math.abs(this.style.shadow_x)+this.style.graphic_width:this.style.graphic_width;this.style.graphic_height=this._dropShadow?Math.abs(this.style.shadow_y)+this.style.graphic_height:this.style.graphic_height;this.style.graphic_x_offset=-1*Math.min(shadow_offset.x,0);this.style.graphic_y_offset=-1*Math.min(shadow_offset.y,0);this.style.line_offset_x=0;this.style.line_offset_y=0;this.style.stroke_offset=0;this.style.offset_x=this.style.graphic_x_offset+this.style.stroke_offset;this.style.offset_y=this.style.graphic_y_offset+this.style.stroke_offset;this._dirty=false;return true}return false},getClassName:function(){return"Image"},__toObject:function(){return{url:this.getUrl(),strokeWidth:this.getStrokeWidth(),strokeColor:this.getStrokeColor(),dropShadow:this.isDropShadow(),shadowX:this.getShadowX(),shadowY:this.getShadowY()}},__fromObject:function(object){if(object.url!==undefined){this.setUrl(object.url)}if(object.strokeWidth!==undefined){this.setStrokeWidth(object.strokeWidth)}if(object.strokeColor!==undefined){this.setStrokeColor(object.strokeColor)}if(object.dropShadow!==undefined){this.setDropShadow(object.dropShadow)}if(object.shadowX!==undefined){this.setShadowX(object.shadowX)}if(object.shadowY!==undefined){this.setShadowY(object.shadowY)}}})}());(function(){var DEFAULT_STYLE={zoom:1,stroke_linejoin:"miter"},TID="com.gliffy.shapes.proxy";_gliffy.Proxy=_gliffy.AbstractGeometry.extend({style:null,node:null,_dropShadow:false,_dirty:true,_createCommand:null,init:function(node){this.node=node;this.style=$.extend({},DEFAULT_STYLE)},markDirty:function(){this._dirty=true;if(this.node){this.node.markDirty()}},getTid:function(){return TID},replaceWith:function(graphic){var node=this.node;if(node){node.resetFlags();node.setSerializable(true);node.setGraphic(graphic);if(this._createCommand){this._createCommand.nodeObject=node.toObject()}this._createCommand=null;this.node=null}},getNode:function(){return this.node},activate:function(createCommand){if(this.node){this.node.setSerializable(false);this._createCommand=createCommand||null}},update:function(){if(this._dirty){var width=0,height=0;if(this.node){width=this.node.getWidth();height=this.node.getHeight();this.style.width=width;this.style.height=height}this.style.center_x=width/2;this.style.center_y=height/2;this.style.graphic_width=(this.node)?this.node.getWidth():0;this.style.graphic_height=(this.node)?this.node.getHeight():0;this.style.graphic_x_offset=0;this.style.graphic_y_offset=0;this.style.line_offset_x=0;this.style.line_offset_y=0;this.style.stroke_offset=0;this.style.offset_x=this.style.graphic_x_offset+this.style.stroke_offset;this.style.offset_y=this.style.graphic_y_offset+this.style.stroke_offset;this._dirty=false;return true}return false},getClassName:function(){return"Proxy"},__toObject:function(){return{}},__fromObject:function(object){}})}());(function(){var FLAGS=["bounds","skin","position","guide"];_gliffy.Node=_gliffy.Serializable.extend({_id:null,_x:0,_y:0,_rotation:0,_width:100,_height:100,_lockAspectRatio:false,_lockPosition:false,_scaleX:1,_scaleY:1,_order:null,worldTransform:null,_graphic:null,_domId:null,_uid:null,stage:null,children:null,parent:null,_dirty:true,_serialize:true,_dirty_flags:null,_current_bounds:null,_aspectRatio:null,_parentDirty:false,_activeGuides:null,_constraints:null,_selectable:true,_isHidden:false,_layerId:null,_isCopiedSelection:false,aabb:null,worldAabb:null,overlayAabb:null,worldOverlayAabb:null,__defaultTextGraphic:null,__editTextOnInit:true,init:function(stage,parent){this.stage=stage||null;this.parent=parent||null;this.worldTransform=new _gliffy.AffineTransform(1,0,0,1,0,0);this.worldAabb=new _gliffy.BoundingBox();this.aabb=new _gliffy.BoundingBox();this.overlayAabb=new _gliffy.BoundingBox();this.worldOverlayAabb=new _gliffy.BoundingBox();this._connections=null;if(_gliffy.Constraints){this._constraints=new _gliffy.Constraints(this)}this.hideGuides();this.resetFlags()},notify:function(){if(!isNaN(parseInt(this.getId(),10))){$(window).trigger("gliffy-node-update-"+this.getId(),[this.getId()])}},notifyRemove:function(){if(!isNaN(parseInt(this.getId(),10))){$(window).trigger("gliffy-node-remove-"+this.getId(),[this.getId()])}},getId:function(){return this._id},applyBestOrder:function(){var activeLayers=this.getActiveLayers();if(activeLayers){var layer=_.first(activeLayers);if(layer){this.setOrder(layer.getOrderForNewNode());layer.incrementNodeIndex();this.stage.sendSingleLayerToLayersController(layer)}}else{_gliffy.Logger.warn("node needs a layer id")}},setId:function(id){if(this.stage){if(id==="auto"){this._id=this.stage._node_index;if(this._order==="undefined"||this._order===null){this.setOrder(this.stage._node_index);this.applyBestOrder()}this.stage._node_index++}else{if(isNaN(parseInt(id,10))){throw new Error("node id is not a number:"+id)}this._id=id}this.stage._node_map[this._id]=this;this._domId="gliffy_node_"+this._id}else{this._id=id}},setUid:function(uid){this._uid=uid},getUid:function(){return this._uid},getTids:function(returnObject){var child,childIndex,tid,tids;tids={};if(this.getGraphic() instanceof _gliffy.Shape){tid=this.getGraphic().getTid();if(tid&&tid!=="null"){tids[this.getGraphic().getTid()]=true}}if(this.children instanceof Array){for(childIndex=0;childIndex<this.children.length;childIndex++){child=this.children[childIndex];tids=$.extend(tids,child.getTids({returnObject:true}))}}if(returnObject){return tids}else{return Object.keys(tids)}},setCopiedSelection:function(isCopiedSelection){this._isCopiedSelection=isCopiedSelection},isCopiedSelection:function(){return this._isCopiedSelection},getDomElement:function(){if(this._domId){return $("#"+this._domId)}return null},getDomElements:function(){var selector=["#"+this._domId],children=this.flattenChildren(),i;for(i=0;i<children.length;i++){selector=selector.concat(["#"+children[i]._domId])}return $(selector.join(","))},getDomViewbox:function(){if(this._domId){return $("#"+this._domId+"viewbox")}return null},setOrder:function(order){if(order!==this._order){this._order=order;this.setFlag("position");this._markDirty()}},getOrder:function(){if(this._order==="auto"){return(this.parent)?this.parent.getOrder():0}else{return this._order}},getRawOrder:function(){return this._order},setX:function(x){if(x!==this._x&&x!==undefined&&x!==null){this._x=x;this.setFlag("position");this._markDirty()}},getX:function(){return this._x},setY:function(y){if(y!==this._y&&y!==undefined&&y!==null){this._y=y;this.setFlag("position");this._markDirty()}},getY:function(){return this._y},getStage:function(){return this.stage},setStage:function(stage){this.stage=stage},__clampWidth:function(width){},__clampHeight:function(height){var ratio=this.getWidth()/this.getHeight();if(height<this.getHeight()){this.setHeight(height);this.setWidth(this.getHeight()*ratio)}},clampTo:function(boundingBox){var dimension=boundingBox.getDimension(),ratio;ratio=this.getHeight()/this.getWidth();if(dimension.x<this.getWidth()){this.setWidth(dimension.x);this.setHeight(this.getWidth()*ratio)}ratio=this.getWidth()/this.getHeight();if(dimension.y<this.getHeight()){this.setHeight(dimension.y);this.setWidth(this.getHeight()*ratio)}},getPosition:function(){return new _gliffy.Vec2(this._x,this._y)},getRotateOffsetX:function(){return this.getWidth()/2},getRotateOffsetY:function(){return this.getHeight()/2},getCenterPosition:function(){return new _gliffy.Vec2(this._x+this._width/2,this._y+this._height/2)},setRotation:function(rotation){rotation=_gliffy.Utils.wrapDegrees(rotation);if(rotation!==this._rotation){this._rotation=rotation;this.setFlag("position");this._markDirty();var graphic=this.getGraphic();if(graphic&&graphic.isDropShadow&&graphic.isDropShadow()){this.setFlag("skin")}}},supportsConstraints:function(){return _gliffy.Constraints&&this._constraints},subscribeAllConstraints:function(){var i;if(this.hasConstraints()){this.getConstraints().subscribeAll()}for(i=0;this.children&&i<this.children.length;i++){this.children[i].subscribeAllConstraints()}},hasConstraints:function(){return this.supportsConstraints()&&this._constraints.hasConstraints()},getConstraints:function(){return this._constraints},setConstraints:function(constraints){if(_gliffy.Constraints){if(this._constraints){this._constraints.unsubscribeAll()}if(constraints){this._constraints=constraints;this._constraints.subscribeAll()}}},getRotation:function(){return _gliffy.Utils.wrapDegrees(this._rotation)},getWorldRotation:function(){var current=this,totalRotation=0;while(current){totalRotation+=current.getRotation();current=current.parent}return totalRotation},setWidth:function(width){if(width!==this._width){this._width=Math.min(Math.max(width,this.getMinWidth()),5000);this._markDirty();this.setFlag("bounds")}},getWidth:function(){return Math.min(Math.max(this._width,1),5000)},setHeight:function(height){if(height!==this._height){this._height=Math.min(Math.max(height,this.getMinHeight()),5000);this._dirty_flags.bounds=true;this.setFlag("bounds");this._markDirty()}},hasChildren:function(){return this.children&&this.children.length>0},getHeight:function(){return Math.min(Math.max(this._height,1),5000)},getMinWidth:function(skipAspectRatio){var minWidth=1;if(this.hasConstraint(_gliffy.MinWidthConstraint)){minWidth=Math.max(minWidth,this.getConstraints().getConstraint(_gliffy.MinWidthConstraint).width)}if(this.hasConstraint(_gliffy.WidthConstraint)){minWidth=Math.max(minWidth,this.getConstraints().getConstraint(_gliffy.WidthConstraint).getMinWidth(_gliffy.Mouse.documentManager.getActiveStage()))}if(this.hasConstraint(_gliffy.ConstWidthConstraint)){minWidth=Math.max(minWidth,this.getConstraints().getConstraint(_gliffy.ConstWidthConstraint).width)}if(this.getShapeInformation()&&this.getShapeInformation().minWidth){minWidth=Math.max(minWidth,this.getShapeInformation().minWidth)}if(this.getLockAspectRatio()&&!skipAspectRatio){minWidth=Math.max(minWidth,this.getMinHeight({skipAspectRatio:true})*this.getAspectRatio())}return minWidth},getMinHeight:function(skipAspectRatio){var minHeight=1;if(this.hasConstraint(_gliffy.MinHeightConstraint)){minHeight=Math.max(minHeight,this.getConstraints().getConstraint(_gliffy.MinHeightConstraint).height)}if(this.hasConstraint(_gliffy.HeightConstraint)){minHeight=Math.max(minHeight,this.getConstraints().getConstraint(_gliffy.HeightConstraint).getMinHeight(_gliffy.Mouse.documentManager.getActiveStage()))}if(this.hasConstraint(_gliffy.ConstHeightConstraint)){minHeight=Math.max(minHeight,this.getConstraints().getConstraint(_gliffy.ConstHeightConstraint).height)}if(this.getShapeInformation()&&this.getShapeInformation().minHeight){minHeight=Math.max(minHeight,this.getShapeInformation().minHeight)}if(this.getLockAspectRatio()&&!skipAspectRatio){minHeight=Math.max(minHeight,this.getMinWidth({skipAspectRatio:true})/this.getAspectRatio())}return minHeight},hasConstraint:function(constraint){return this.hasConstraints()&&this.getConstraints().hasConstraint(constraint)},setScaleXNoRatio:function(scaleX){if(scaleX!==this._scaleX){this._scaleX=scaleX;this.setFlag("bounds");this._markDirty()}},setScaleYNoRatio:function(scaleY){if(scaleY!==this._scaleY){this._scaleY=scaleY;this.setFlag("bounds");this._markDirty()}},setScaleX:function(scaleX){if(scaleX!==this._scaleX&&!isNaN(scaleX)){this._scaleX=scaleX;if(this._lockAspectRatio){this._scaleY=scaleX}this.setFlag("bounds");this._markDirty()}},setScaleY:function(scaleY){if(scaleY!==this._scaleY&&!isNaN(scaleY)){this._scaleY=scaleY;if(this._lockAspectRatio){this._scaleX=scaleY}this.setFlag("bounds");this._markDirty()}},getScaleX:function(){return this._scaleX},getScaleY:function(){return this._scaleY},_applyScale:function(){var i,child;if(this._scaleX!==1||this._scaleY!==1){this.setWidth(this.getWidth()*this._scaleX);this.setHeight(this.getHeight()*this._scaleY);if(this.children){for(i=0;i<this.children.length;i++){child=this.children[i];if((!child.isTextChild())||child.getGraphic().getOverflow()==="none"){if(!child.hasConstraints()||child.getConstraints().parentCanScaleWidth()){child.setX(child.getX()*this._scaleX);child.setScaleXNoRatio(this._scaleX)}if(!child.hasConstraints()||child.getConstraints().parentCanScaleHeight()){child.setY(child.getY()*this._scaleY);child.setScaleYNoRatio(this._scaleY)}}}}}},clearCachedAspectRatio:function(){this._aspectRatio=null},getAspectRatio:function(){if(this.getLockAspectRatio()){if(this._aspectRatio===null){this._aspectRatio=this._width/this._height}return this._aspectRatio}else{return this._width/this._height}},getLockAspectRatio:function(){return this._lockAspectRatio},setLockAspectRatio:function(lockAspectRatio){this._lockAspectRatio=lockAspectRatio;if(!this._lockAspectRatio){this._aspectRatio=null}},getLockPosition:function(){return this._lockPosition},setLockPosition:function(lockPosition){this._lockPosition=lockPosition},getDefaultTextGraphic:function(){return this.__defaultTextGraphic},setDefaultTextGraphic:function(defaultTextGraphic){this.__defaultTextGraphic=defaultTextGraphic},isEditTextOnInit:function(){return this.__editTextOnInit},setEditTextOnInit:function(b){this.__editTextOnInit=b},getMinDimensions:function(){return{x:this.getMinWidth(),y:this.getMinHeight()}},setGraphic:function(graphic){if(this._graphic){this._graphic.node=null}this._graphic=graphic;if(this._graphic){this._graphic.node=this;if(this.getUid()===null){if(this._graphic instanceof _gliffy.Line){this.setUid("com.gliffy.shape.basic.basic_v1.default.line")}}this._graphic.markDirty()}else{if(this.stage){this.stage.removeDomNode(this)}}return this},getGraphic:function(){return this._graphic},updateProperty:function(prop,value){var graphic,props={};props[prop]=value;if(this.stage){this.stage.commandHistory.addAndExecuteCommand(new _gliffy.ModifyNodeCommand({node:this,props:props}))}else{graphic=this.getGraphic();if(this["set"+prop]!==undefined){this["set"+prop](value)}else{graphic=this.getGraphic();if(graphic){graphic.updateProperty(prop,value)}}}},getChildrenAabb:function(includeSelf){var i,child,aabb=(includeSelf===true)?this.aabb.clone():_gliffy.BoundingBox.SMALLEST.clone(),childTransform,graphic,offsetY;for(i=0;this.children&&i<this.children.length;i++){child=this.children[i];childTransform=child.getLocalTransform();if(child.getGraphic() instanceof _gliffy.Text){graphic=child.getGraphic();offsetY=(graphic.getValign()==="middle")?(child.getHeight()/2)-(graphic.getCalculatedHeight()/2):0;childTransform=childTransform.clone().translate(child.getGraphic().style.x,child.getGraphic().style.y+offsetY)}if(!(child.getGraphic() instanceof _gliffy.Link)){aabb.add(child.getChildrenAabb(true).transform(childTransform))}}return aabb},getChildrenWorldAabb:function(includeSelf){var i,child,aabb;if(includeSelf===true){if(this.getGraphic() instanceof _gliffy.Text){aabb=new _gliffy.BoundingBox(0,0,this.getGraphic().getCalculatedWidth(),this.getGraphic().getCalculatedHeight());aabb.transform(this.__getTextWorldTransform())}else{aabb=this.worldAabb.clone()}}else{if(this.children instanceof Array&&this.children.length>0){aabb=_gliffy.BoundingBox.SMALLEST.clone()}else{aabb=new _gliffy.BoundingBox()}}_.each(this.children,function(childNode){aabb.add(childNode.getChildrenWorldAabb(true))});return aabb},getLocalTransform:function(){var local=new _gliffy.AffineTransform(1,0,0,1,0,0);local.translate(this._x,this._y).rotate(this._rotation*(Math.PI/180),this.getRotateOffsetX(),this.getRotateOffsetY());return local},updateWorldTransform:function(){this.worldTransform=(this.parent)?this.parent.worldTransform.clone():new _gliffy.AffineTransform(1,0,0,1,0,0);this.worldTransform.translate(this._x,this._y).rotate(this._rotation*(Math.PI/180),this.getRotateOffsetX(),this.getRotateOffsetY())},update:function(){var self=this;_gliffy.Utils.tryCatch(function(){if(self._dirty){if(self.stage&&(self._dirty_flags.bounds||self._dirty_flags.position)&&_gliffy.Tree){_gliffy.Tree.remove(self)}self._applyScale();var i,child,grow=false,updateChildren;if(self.stage&&self.hasConstraints()){self.getConstraints().executeConstraints()}if(self.stage&&self.getGraphic() instanceof _gliffy.Text){if(self.parent===null||self.parent.isGroup()||self.parent.isSelection()){if(self.getUid()===null){self.setUid("com.gliffy.shape.basic.basic_v1.default.text")}}else{if(self.getUid()!==null){self.setUid(null)}}}self.updateWorldTransform();if(self._graphic){self._graphic.update();if(self._graphic.aabb){self.aabb.copy(self._graphic.aabb)}else{self.aabb.setMinMax(0,0,0,0);self.aabb.grow(self.getWidth(),self.getHeight())}if(self._graphic.worldAabb){self.worldAabb.copy(self._graphic.worldAabb)}else{if(self.getGraphic() instanceof _gliffy.Text){self.worldAabb.copy(self.aabb).transform(self.__getTextWorldTransform())}else{self.worldAabb.copy(self.aabb).transform(self.worldTransform)}}self.overlayAabb.copy(self.aabb)}else{self.aabb.setMinMax(0,0,0,0);self.aabb.grow(self.getWidth(),self.getHeight());if(self.isSelection()){self.overlayAabb.copy(self.aabb)}grow=true}if(self.children){updateChildren=(self._dirty_flags.bounds||self._dirty_flags.position);for(i=0;i<self.children.length;i++){child=self.children[i];if(updateChildren){if(self._dirty_flags.bounds){child.setFlag("bounds")}if(self._dirty_flags.position){child.setFlag("position")}child._markDirty();child._parentDirty=true}child.update();if(child.worldAabb){if(grow){if(self.isGroup()||self.isMultipartShape()){self.overlayAabb.copy(child.overlayAabb).transform(child.getLocalTransform())}self.worldAabb.copy(child.worldAabb);grow=false}else{if(self.isGroup()||self.isMultipartShape()){self.overlayAabb.add(child.overlayAabb.clone().transform(child.getLocalTransform()))}self.worldAabb.add(child.worldAabb)}}}}self.worldOverlayAabb.copy(self.overlayAabb).transform(self.worldTransform);if(self.stage&&(self._dirty_flags.bounds||self._dirty_flags.position)&&_gliffy.Tree){_gliffy.Tree.add(self)}self.setScaleX(1);self.setScaleY(1);self._dirty=false}self._parentDirty=false},function(e){_gliffy.Logger.error("Node "+self.getId()+" failed to update in node.js");if(self.stage){self.stage.removeNode(self)}_gliffy.handleError("com.gliffy.error.fatal_error",[],e)})},getBoundsOffset:function(){var worldPos=this.getWorldPosition();return _gliffy.Vec2.difference(worldPos,this.worldAabb.min)},getWorldPosition:function(){if(this.parent){return this.parent.worldTransform.transformPoint(this._x,this._y)}else{return{x:this._x,y:this._y}}},markClean:function(){this._dirty=false},markDirty:function(){this._dirty=true;if(this.stage&&!isNaN(parseInt(this.getId(),10))&&this.stage.find(this.getId())===this){this.stage.addDirtyNode(this)}},_markDirty:function(){if(this.getGraphic()){this.getGraphic().markDirty()}else{this.markDirty()}},shouldBeDrawn:function(){if(this.stage&&!isNaN(parseInt(this.getId(),10))){return this.stage.dirty[this.getId()]===this.getId()}return true},isDirty:function(){return this._dirty},isAChildOf:function(n){if(this.parent===n){return true}else{if(this.parent===null){return false}else{this.parent.isAChildOf(n)}}},getRootParent:function(){var n=this;while(n.parent){n=n.parent}return n},setLayerId:function(layer){this._layerId=layer;return this},getLayerId:function(layer){return this._layerId},getActiveLayers:function(){var guid,topmostParent=this,layer,layers;if(this.isSelection()){if(this.children){var layers=_.map(this.children,function(child){return this.stage.getLayerByGUID(child.getLayerId())},this);layers=_.unique(layers);return layers}return[]}else{while(topmostParent.parent!==null&&(topmostParent.parent.isCopiedSelection()||!topmostParent.parent.isSelection())){topmostParent=topmostParent.parent}guid=topmostParent.getLayerId();if(guid){layer=topmostParent.stage.getLayerByGUID(guid);if(layer){return[layer]}}}_gliffy.Logger.error("Couldn't find layer for node "+this.getUid());return[]},isPickable:function(){var firstActiveLayer=_.first(this.getActiveLayers());if(firstActiveLayer){return !firstActiveLayer.isLocked()&&firstActiveLayer.isVisible()}_gliffy.Logger.warn("cannot determine if node is pickable");return true},setHidden:function(hidden){if(this._isHidden!==hidden){this._isHidden=hidden;this.markDirty()}_.each(this.children,function(childNode){childNode.setHidden(hidden)})},getHidden:function(){return this._isHidden},getLayerHidden:function(){var activeLayers=this.getActiveLayers(),layer;if(activeLayers){layer=_.first(activeLayers);if(layer){return !layer.isVisible()}}return false},getNodeOrLayerHidden:function(){return this.getHidden()||this.getLayerHidden()},getLayerLocked:function(){var activeLayers=this.getActiveLayers(),layer;if(activeLayers&&activeLayers.length>0){layer=_.first(activeLayers);if(layer){return layer.isLocked()}}return false},setSerializable:function(serializable){this._serialize=serializable},toObjectNoGraphic:function(){return $.extend(true,{},this.__toObject(true))},__toObject:function(noGraphic){if(this._serialize){var i,object={x:this.getX(),y:this.getY(),rotation:this.getRotation(),id:this.getId(),uid:this.getUid(),width:this.getWidth(),height:this.getHeight(),lockAspectRatio:this.getLockAspectRatio(),lockShape:this.getLockPosition(),order:this._order,hidden:this.getHidden(),graphic:null,children:null,layerId:this.getLayerId()},graphic=this.getGraphic(),childrenArray,child;if(!noGraphic&&this.hasConstraints()){object.constraints=this._constraints.toObject()}if(!noGraphic&&graphic!==null){if(graphic instanceof _gliffy.Graphic){object.graphic=_gliffy.Serializable.polymorphicToObject(graphic)}else{throw new Error("The graphic for this node is not an instance of Geometry")}}if(this.children){childrenArray=[];for(i=0;this.children&&i<this.children.length;i++){child=this.children[i].__toObject(noGraphic);if(child){childrenArray.push(child)}}object.children=childrenArray}if(!noGraphic&&this.stage&&this._uid!==null&&!this.isGroup()&&!this.isSelection()){object.linkMap=this.generateLinkMap()}return object}else{return null}},__getTextWorldTransform:function(){var graphic,offsetY;if(this.getGraphic() instanceof _gliffy.Text){graphic=this.getGraphic();offsetY=(graphic.getValign()==="middle")?(this.getHeight()/2)-(graphic.getCalculatedHeight()/2):0;return new _gliffy.AffineTransform().concatenate(this.worldTransform).translate(graphic.style.x,graphic.style.y+offsetY)}else{return this.worldTransform}},generateLinkMap:function(){var nodes,node,domNode,links,boundingBox,css,cssNoTransform,linkMap=[],offset={x:0,y:0},container,i,shapeLinkInfo,debugBoundingBox=function(boundingBox){if($("#linkBoundingBox").length===0){$(".gliffy-stage").append('<div id="linkBoundingBox" style="border: 1px solid red;width: 100px;height: 100px;position: absolute;top: 0px;left: 0px;"></div>')}$("#linkBoundingBox").width(boundingBox.getWidth());$("#linkBoundingBox").height(boundingBox.getHeight());$("#linkBoundingBox").css({top:boundingBox.min.y+"px",left:boundingBox.min.x})},handleLink=function(index,link){var stageBB=new _gliffy.BoundingBox(0,0,5000,5000),stageOffset=_gliffy.Mouse.getStageOffset();boundingBox=(new _gliffy.BoundingBox()).fromClientRect(link.getBoundingClientRect());boundingBox.transform(_gliffy.AffineTransform.getTranslateInstance(stageOffset.left,stageOffset.top).scale(node.stage.zoom,node.stage.zoom).createInverse());if(stageBB.intersects(boundingBox)){linkMap.push({url:$(link).attr("href"),minX:Math.round(boundingBox.min.x),minY:Math.round(boundingBox.min.y),maxX:Math.round(boundingBox.max.x),maxY:Math.round(boundingBox.max.y)})}},getShapeLink=function(node){var shapeLinkNodes=node.findGraphic(_gliffy.Link),shapeLinkNode=shapeLinkNodes.length>0?shapeLinkNodes[0]:null,aabb;if(shapeLinkNode){aabb=(new _gliffy.BoundingBox()).copy(node.aabb).transform(node.worldTransform);return{url:shapeLinkNode.getGraphic().getHref(),minX:Math.round(aabb.min.x),minY:Math.round(aabb.min.y),maxX:Math.round(aabb.max.x),maxY:Math.round(aabb.max.y)}}return null};if(_gliffy.Mouse){container=_gliffy.Mouse.getContainerOffset();offset.x-=container.left;offset.y-=container.top}if(this.stage){offset.x-=this.stage.pan_x;offset.y-=this.stage.pan_y}shapeLinkInfo=getShapeLink(this);if(shapeLinkInfo){linkMap.push(shapeLinkInfo)}nodes=this.findGraphic(_gliffy.Text);for(i=0;i<nodes.length;i++){node=nodes[i];domNode=node.getDomElement();if(domNode&&domNode.length>0){links=domNode.find("a");links.each(handleLink)}}return linkMap},__fromObject:function(object,opt){var i,graphic=null,constraints,child,order,childOrder,options=$.extend({subscribeToConstraints:true},opt);if(object.uid!==undefined){this.setUid(object.uid)}if(object.x!==undefined){this.setX(object.x)}if(object.y!==undefined){this.setY(object.y)}if(object.rotation!==undefined){this.setRotation(object.rotation)}if(object.width!==undefined){this.setWidth(object.width)}if(object.height!==undefined){this.setHeight(object.height)}if(object.lockAspectRatio!==undefined){this.setLockAspectRatio(object.lockAspectRatio)}if(object.lockShape!==undefined){this.setLockPosition(object.lockShape)}if(object.id!==undefined){this.setId(object.id)}if(object.order!==undefined){this._order=object.order}if(object.hidden!==undefined){this.setHidden(object.hidden)}if(object.layerId!==undefined){this.setLayerId(object.layerId)}if(_gliffy.Constraints&&object.constraints!==undefined){constraints=new _gliffy.Constraints(this,options.subscribeToConstraints);constraints.fromObject(object.constraints);this.setConstraints(constraints)}if(object.graphic){graphic=_gliffy.Serializable.polymorphicFromObject(object.graphic,this);if(graphic instanceof _gliffy.Graphic){this.setGraphic(graphic);graphic.markDirty()}else{throw new Error("The graphic "+object.graphicClass+" is not an instance of Geometry.")}}order=0;if(object.children){this.children=[];for(i=0;i<object.children.length;i++){child=new _gliffy.Node().fromObject(object.children[i]);this.appendChild(child);childOrder=child.getOrder();if(order<childOrder){order=childOrder}}}if(this.isGroup()&&this.getOrder()<childOrder){this.setOrder(childOrder+1)}this.markDirty();return this},appendChild:function(node){if(this.stage&&this.stage.find(this.getId())===this){this.stage.appendNode(node,this)}else{if(!this.children){this.children=[]}node.parent=this;this.children.push(node)}},insertChild:function(node,index){if(this.stage&&this.stage.find(this.getId())===this){this.stage.insertNode(node,this,index)}else{if(!this.children){this.children=[]}node.parent=this;this.children.splice(index,0,node)}},prependChild:function(node){if(this.stage&&this.stage.find(this.getId())===this){this.stage.prependNode(node,this)}else{if(!this.children){this.children=[]}node.parent=this;this.children.unshift(node)}},removeChild:function(node,markForDeletion){if(this.stage&&this.stage.find(this.getId())===this){this.stage.removeNode(node,markForDeletion)}else{node.parent=null;this.__removeFromArray(this.children,node)}},__removeFromArray:function(array,object){var index=-1,other,i;for(i=0;array.length;i++){other=array[i];if((object.getId()!==null&&other.getId()===object.getId())||other===object){index=i;break}}if(index>-1&&index<array.length){array.splice(index,1)}},getShapeInformation:function(){return _gliffy.shapeLibrary.getShape(this.getUid())||{}},hasGroupDroppableCopyObject:function(){return this.getShapeInformation()&&this.getShapeInformation().defaults&&this.getShapeInformation().defaults.copyObject&&this.getShapeInformation().defaults.copyObject.uid==="com.gliffy.shape.basic.basic_v1.default.group_droppable"},resetFlags:function(){var i;this._dirty_flags={};for(i=0;i<FLAGS.length;i++){this._dirty_flags[FLAGS[i]]=false}},setFlag:function(flag){if($.inArray(flag,FLAGS)<0){throw new Error($.inArray(flag,FLAGS)>-1+" node does not have flag "+flag)}this._dirty_flags[flag]=true;if((flag==="position"||flag==="bounds")&&this.stage&&this.stage.setBoundsDirty){this.stage.setBoundsDirty()}},hasFlag:function(flag){var i;if(flag){return this._dirty_flags[flag]||false}else{for(i=0;i<FLAGS.length;i++){if(this._dirty_flags[FLAGS[i]]===true){return true}}}return false},hasRepositionCanvasFlag:function(){return this._dirty_flags.position||this._dirty_flags.bounds},hasRedrawCanvasFlag:function(){return this._dirty_flags.bounds||this._dirty_flags.skin},hasGuideFlag:function(){return this._dirty_flags.guide},closestGraphic:function(type){if(this.getGraphic() instanceof type){return this}else{if(this.parent){return this.parent.closestGraphic(type)}else{return null}}},closestGroup:function(){if(this.isGroup()){return this}else{if(this.parent){return this.parent.closestGroup()}else{return null}}},topGroup:function(){if(this.isGroup()&&(this.parent===null||this.parent.isSelection())){return this}else{if(this.parent){return this.parent.topGroup()}else{return null}}},getFirstNodeWithGraphic:function(){if(this.getGraphic()){return this}else{var i,node;for(i=0;i<this.children.length;i++){node=this.children[i].getFirstNodeWithGraphic();if(node){return node}}return null}},getFirstTopLevelNodeWithGraphic:function(type){var child,children,graphic,i;children=this.children;if(children&&children.length>0){for(i=0;i<children.length;i++){child=children[i];if(child instanceof _gliffy.Node&&!child.getUid()){graphic=child.getGraphic();if(graphic instanceof type){return child}}}}return null},findGraphic:function(type){var list=[],i;if((type!==null&&this.getGraphic() instanceof type)||(this.getGraphic()===null&&type===null)){list.push(this)}if(this.children&&this.children.length>0){for(i=0;i<this.children.length;i++){list=list.concat(this.children[i].findGraphic(type))}}return list},findImmediateChildGraphic:function(type){var list=[],i,child;if(this.children){for(i=0;i<this.children.length;i++){child=this.children[i];if((type!==null&&child.getGraphic() instanceof type)||(child.getGraphic()===null&&type===null)){list.push(child)}}}return list},findNodesWithGraphics:function(types){var list=[],i;for(i=0;i<types.length;i++){if((types[i]!==null&&this.getGraphic() instanceof types[i])||(this.getGraphic()===null&&types[i]===null)){list.push(this);break}}if(this.children&&this.children.length>0){for(i=0;i<this.children.length;i++){list=list.concat(this.children[i].findNodesWithGraphics(types))}}return list},getUidNode:function(){if(this.getUid()!==null){return this}else{if(this.parent){return this.parent.getUidNode()}else{return null}}},getLeafNodes:function(includeSelf){var list=[],i;if(includeSelf||(this.getUid()&&!(this.isGroup()||this.isSelection()))){list.push(this)}for(i=0;this.children&&i<this.children.length;i++){list=list.concat(this.children[i].getLeafNodes(false))}return list},findUid:function(uid){return this.findUidFunction(function(u){return u===uid})},findUidFunction:function(check){var list=[],i;if(check(this.getUid())){list.push(this)}if(this.children&&this.children.length>0){for(i=0;i<this.children.length;i++){list=list.concat(this.children[i].findUidFunction(check))}}return list},hasText:function(){var i=0;if(this.getGraphic() instanceof _gliffy.Text){return true}else{if(this.children&&this.children.length>0){for(i=0;i<this.children.length;i++){if(this.children[i].hasText()){return true}}}}return false},hasTextContent:function(){var i=0;if(this.getGraphic() instanceof _gliffy.Text&&this.getGraphic().getNodeText()&&this.getGraphic().getNodeText().trim()!==""){return true}else{if(this.children&&this.children.length>0){for(i=0;i<this.children.length;i++){if(this.children[i].hasTextContent()){return true}}}}return false},immediateChildrenHaveMixedRotation:function(){var i=0;if(this.children){for(i=0;i<this.children.length;i++){if(this.children[i].getRotation()!==0){return true}}}return false},isLine:function(){return this.getGraphic() instanceof _gliffy.Line&&!this.isGroup()&&!this.isSelection()&&!this.isMultipartShape()},isConnectedLine:function(){return this.isLine()&&(this.getGraphic().getStartConnection()||this.getGraphic().getEndConnection())},isGroup:function(){return this.getUid()==="com.gliffy.shape.basic.basic_v1.default.group"||this.isGroupDroppable()},isGroupDroppable:function(){return this.getUid()==="com.gliffy.shape.basic.basic_v1.default.group_droppable"},isOnlyNodeOnTheStage:function(){var objects;objects=this.getStage().objects;return(objects.length===1)&&(objects[0]===this)},isSelection:function(){return this.getUid()==="com.gliffy.shape.basic.basic_v1.default.selection"},isShape:function(){return !this.isGroup()&&!this.isSelection()&&((this.getUid()&&this.getGraphic() instanceof _gliffy.Shape)||this.isMultipartShape())},isShapePart:function(){return !this.getUid()&&this.getGraphic() instanceof _gliffy.Shape},isSvg:function(){return this.getGraphic() instanceof _gliffy.Svg&&this.getUid()==="com.gliffy.shape.basic.basic_v1.default.svg"},isProxy:function(){return _gliffy.Proxy&&this.getGraphic() instanceof _gliffy.Proxy},isPopupNote:function(){return _gliffy.PopupNote&&this.getGraphic() instanceof _gliffy.PopupNote},isImage:function(){return this.getGraphic() instanceof _gliffy.Image&&this.getUid()==="com.gliffy.shape.basic.basic_v1.default.image"},isMultipartShape:function(){return !this.isGroup()&&!this.isSelection()&&this.getUid()&&this.findNodesWithGraphics([_gliffy.Shape,null]).length>1},isStandAloneText:function(){return this.getUid()==="com.gliffy.shape.basic.basic_v1.default.text"&&this.getGraphic() instanceof _gliffy.Text},supportsDrawingGuides:function(){return(this.isShape()||this.isImage()||this.isStandAloneText()||this.isSvg())&&!this.getLayerHidden()&&!this.getHidden()},isAnnotation:function(){return this.getUid()==="com.gliffy.shape.bpmn.bpmn_v1.data_artifacts.annotation"},isText:function(){return this.getGraphic() instanceof _gliffy.Text},isLink:function(){return this.getGraphic() instanceof _gliffy.Link},isIcon:function(){return this.isLink()||this.isPopupNote()},isUML2:function(){return this.getUid()&&(this.getUid().indexOf("com.gliffy.shape.uml.uml_v2")===0)},isUML2Activation:function(){return this.getGraphic() instanceof _gliffy.Shape&&this.getUid()==="com.gliffy.shape.uml.uml_v2.sequence.activation"},isBPMN:function(){return this.getUid()&&(this.getUid().indexOf("com.gliffy.shape.bpmn")===0)},isERD:function(){return this.getUid()&&(this.getUid().indexOf("com.gliffy.shape.erd")===0)},isMindmap:function(){return(this.getUid()&&this.getUid().indexOf("com.gliffy.shape.mindmap")===0)},isTextChild:function(){return this.getGraphic() instanceof _gliffy.Text&&this.getUid()===null&&this.parent!==null},isSwimlane:function(){return(this.getUid()&&this.getUid().indexOf("com.gliffy.shape.swimlanes")===0)},isTable:function(){var uid=this.getUid();if(uid!==null&&uid!==undefined){return(uid.indexOf("com.gliffy.shape.table.table_v1")===-1&&((uid.indexOf("com.gliffy.shape.table")===0||uid==="com.gliffy.shape.ui.ui_v3.containers_content.table_three_by_three")))===true}else{return false}},isRackShape:function(){return(this.getUid()&&(this.getUid().indexOf("com.gliffy.shape.network.network_v4.rack")===0&&this.getUid().indexOf("7u_lcd")===-1))},isContainer:function(){var info=this.getShapeInformation();return info&&info.defaults&&info.defaults.isContainer},isPartOfMultipartShape:function(){var parent=this.getUidNode();return(parent&&parent.isMultipartShape()&&this!==parent)===true},__isPartOf:function(node,uid){if(node){return(node.getUid()===uid)||this.__isPartOf(node.parent,uid)}return false},isPartOf:function(uid){return this.__isPartOf(this.parent,uid)},__isPartOfRegExp:function(node,uidRegExp){if(node){return(node.getUid()&&node.getUid().match(uidRegExp))||this.__isPartOfRegExp(node.parent,uidRegExp)}return false},isPartOfRegExp:function(uidRegExp){return this.__isPartOfRegExp(this.parent,uidRegExp)},isPartOfGroup:function(){return this.isPartOf("com.gliffy.shape.basic.basic_v1.default.group")||this.isPartOf("com.gliffy.shape.basic.basic_v1.default.group_droppable")},isPartOfSelection:function(){return this.isPartOf("com.gliffy.shape.basic.basic_v1.default.selection")},isResizable:function(){var shapeInfo,mutableProps;shapeInfo=this.getShapeInformation();if(shapeInfo&&shapeInfo.mutableProperties){mutableProps=shapeInfo.mutableProperties;return $.inArray("width",mutableProps)!==-1||$.inArray("height",mutableProps)!==-1}else{return true}},supportsConnections:function(){var info=this.getShapeInformation();return !this.isProxy()&&info.defaults&&info.defaults.connPtPattern!==null&&info.defaults.connPtPattern!==undefined},supportsIcon:function(){return this.isImage()||this.isSvg()||(this.isShape()&&!this.isMultipartShape())},supportsStyleCopy:function(){return(!this.getLayerLocked()&&!this.isGroup()&&!this.isSelection())&&((this.isShape()&&!this.isMultipartShape())||this.isText()||this.isLine()||_gliffy.Utils.isUIDPartOfGliffySymbolLibrary(this.getUid(),"com.gliffy.libraries.basic.basic_v1.default"))},supportsCopyPaste:function(){return(this.findGraphic(_gliffy.Mindmap).length===0)},supportsLockAspect:function(){var i,info,supports=true,shapeNodes=this.findNodesWithGraphics([_gliffy.Shape,_gliffy.Image]);for(i=0;i<shapeNodes.length;i++){info=shapeNodes[i].getShapeInformation();if($.inArray("lockAspectRatio",info.mutableProperties)===-1){supports=false;break}}return supports},flattenChildren:function(){var nodes=[],i=0;for(i=0;this.children&&i<this.children.length;i++){this.__preorder(this.children[i],nodes)}nodes=nodes.sort(function(n1,n2){var result=n1.getOrder()-n2.getOrder();if(result===0){if(n1.isAChildOf(n2)){return 1}else{if(n2.isAChildOf(n1)){return -1}else{return n1.getId()>n2.getId()?1:-1}}}else{return result}});return nodes},getDrawingGuides:function(){var drawingGuides,optionalDrawingGuides,mergedGuides;drawingGuides={x:{left:this.worldOverlayAabb.min.x,center:(this.worldOverlayAabb.min.x+this.worldOverlayAabb.max.x)/2,right:this.worldOverlayAabb.max.x},y:{top:this.worldOverlayAabb.min.y,middle:(this.worldOverlayAabb.min.y+this.worldOverlayAabb.max.y)/2,bottom:this.worldOverlayAabb.max.y}};optionalDrawingGuides=this.__getOptionalDrawingGuides();mergedGuides=_.merge(drawingGuides,optionalDrawingGuides);return mergedGuides},__getOptionalDrawingGuides:function(){var optionalDrawingGuides,rotation,self,shapeInformation,x,y;x={};y={};rotation=Math.round(this.getRotation())%360;shapeInformation=this.getShapeInformation();if(shapeInformation&&shapeInformation.optionalDrawingGuides){optionalDrawingGuides=shapeInformation.optionalDrawingGuides;if(rotation===0){if(optionalDrawingGuides.left){x.containerLeft=this.worldOverlayAabb.min.x+optionalDrawingGuides.left}if(optionalDrawingGuides.right){x.containerRight=this.worldOverlayAabb.max.x-optionalDrawingGuides.right}if(optionalDrawingGuides.top){y.containerTop=this.worldOverlayAabb.min.y+optionalDrawingGuides.top}if(optionalDrawingGuides.bottom){y.containerBottom=this.worldOverlayAabb.max.y-optionalDrawingGuides.bottom}}else{if(rotation===90){if(optionalDrawingGuides.left){x.containerLeft=this.worldOverlayAabb.min.x+optionalDrawingGuides.bottom}if(optionalDrawingGuides.right){x.containerRight=this.worldOverlayAabb.max.x-optionalDrawingGuides.top}if(optionalDrawingGuides.top){y.containerTop=this.worldOverlayAabb.min.y+optionalDrawingGuides.left}if(optionalDrawingGuides.bottom){y.containerBottom=this.worldOverlayAabb.max.y-optionalDrawingGuides.right}}else{if(rotation===180){if(optionalDrawingGuides.left){x.containerLeft=this.worldOverlayAabb.min.x+optionalDrawingGuides.right}if(optionalDrawingGuides.right){x.containerRight=this.worldOverlayAabb.max.x-optionalDrawingGuides.left}if(optionalDrawingGuides.top){y.containerTop=this.worldOverlayAabb.min.y+optionalDrawingGuides.bottom}if(optionalDrawingGuides.bottom){y.containerBottom=this.worldOverlayAabb.max.y-optionalDrawingGuides.top}}else{if(rotation===270){if(optionalDrawingGuides.left){x.containerLeft=this.worldOverlayAabb.min.x+optionalDrawingGuides.top}if(optionalDrawingGuides.right){x.containerRight=this.worldOverlayAabb.max.x-optionalDrawingGuides.bottom}if(optionalDrawingGuides.top){y.containerTop=this.worldOverlayAabb.min.y+optionalDrawingGuides.right}if(optionalDrawingGuides.bottom){y.containerBottom=this.worldOverlayAabb.max.y-optionalDrawingGuides.left}}else{}}}}}return{x:x,y:y}},__hasDirtyGuides:function(){var hasDirtyGuides;hasDirtyGuides=_.any(this._activeGuides,function(xOrYGuides){return _.any(xOrYGuides,function(guideActiveFlag){return guideActiveFlag})});return hasDirtyGuides},hideGuides:function(){if(this.__hasDirtyGuides()){this.markDirty()}this._activeGuides={x:{},y:{}}},showDrawingGuide:function(xOrY,which){if((xOrY==="x"||xOrY==="y")){if(!this._activeGuides[xOrY][which]){this._activeGuides[xOrY][which]=true;this.setFlag("guide");this.markDirty()}}},shouldShowGuide:function(xOrY,which){if(xOrY==="x"||xOrY==="y"){return this._activeGuides[xOrY][which]}return false},worldPointToRatio:function(x,y){var point=this.worldTransform.createInverse().transformPoint(x,y);point.x/=this.getWidth();point.y/=this.getHeight();return point},ratioToWorldPoint:function(xRatio,yRatio){return this.worldTransform.transformPoint(xRatio*this.getWidth(),yRatio*this.getHeight())},__preorder:function(node,array){var c;if(!node){return}array.push(node);for(c=0;node.children&&c<node.children.length;c++){this.__preorder(node.children[c],array)}},getSubLibraryId:function(){var subLibraryId;if(this._uid!==null){if(this._uid.lastIndexOf(".")>-1){subLibraryId=this._uid.substring(0,this._uid.lastIndexOf("."))}}return subLibraryId},getConnections:function(){var i,patternStrings,patternString,pattern;if(!this._connections&&this.supportsConnections()){this._connections=[];patternStrings=this.getShapeInformation().defaults.connPtPattern;if(patternStrings){for(i=0;i<patternStrings.length;i++){patternString=patternStrings[i];pattern=_gliffy.ConnectionPointPattern.patterns[patternString];if(pattern){this._connections=this._connections.concat(pattern)}}}}else{if(!this._connections){this._connections=[]}}return this._connections},hasBoundsConnections:function(){var patternStrings,i;if(this.getShapeInformation().defaults){patternStrings=this.getShapeInformation().defaults.connPtPattern;if(patternStrings){for(i=0;i<patternStrings.length;i++){if(patternStrings[i]==="Bounds"){return true}}}}return false},updateGroupBounds:function(){var i,n,dimension,boundingBox;if(this.isGroup()||this.isSelection()){for(i=0;i<this.children.length;i++){n=this.children[i];n.updateGroupBounds();n.update()}boundingBox=this.getChildrenAabb();dimension=boundingBox.getDimension();this.setWidth(dimension.x);this.setHeight(dimension.y)}},getClosestConnectionPoint:function(point){point=this.worldTransform.createInverse().transformPoint(point.x,point.y);point.x/=this.getWidth();point.y/=this.getHeight();return this.getConnectionIndexByRatio(point)},hasConnectionIndices:function(){return this.getConnections()?true:false},getConnectionIndexByRatio:function(ratio){var connections=this.getConnections(),i,smallestDistance=Number.MAX_VALUE,index=0,distance;for(i=0;i<connections.length;i++){distance=_gliffy.Vec2.squaredDistance(ratio,connections[i].pos);if(distance<smallestDistance){index=i;smallestDistance=distance}}return index},getConnectionPointRatio:function(i){return this.getConnections()[i].pos},getConnectionPoint:function(i){var connLocal,xfm,pt;connLocal=this.getConnections()[i].pos;xfm=this.worldTransform.clone().translate(this.getWidth()*connLocal.x,this.getHeight()*connLocal.y);pt=xfm.transformPoint(0,0);return new _gliffy.Vec2(pt.x,pt.y)},getConnectionPointDom:function(i){return $("#cp"+i+"-"+this._domId)},getConnectionVector:function(i){var connections=this.getConnections();if(i<connections.length&&connections[i].vec){return(new _gliffy.Vec2(this.getConnections()[i].vec.x,this.getConnections()[i].vec.y)).rotate(this.getWorldRotation()*Math.PI/180)}else{return new _gliffy.Vec2(0,0)}},isSelectable:function(){return this._selectable},setSelectable:function(selectable){this._selectable=selectable},getLink:function(){var linkNode;if(!this.isGroup()&&!this.isSelection()&&this.children){linkNode=this.findGraphic(_gliffy.Link);if(linkNode.length>1){_gliffy.Logger.error("node found with more than one _gliffy.Link");return linkNode[0].getGraphic().getHref()}else{if(linkNode.length>0){return linkNode[0].getGraphic().getHref()}}}return null},isTableCellSelected:function(){if(this&&this.getDomViewbox()){return this.getDomViewbox().hasClass("table-border")}else{return false}},addTableSelectedCellClass:function(){if(this&&this.getDomViewbox()){this.getDomViewbox().addClass("table-border")}else{return false}},removeTableSelectedCellClass:function(){if(this&&this.getDomViewbox()){this.getDomViewbox().removeClass("table-border")}},isKnownShape:function(){return this.isText()||this.isLine()||this.isGroup()||this.isSelection()||this.isGroupDroppable()||this.isLink()||this.isPopupNote()||!!_gliffy.shapeLibrary.getShape(this.getUid())},setToActiveLayer:function(stage){stage=stage||this.stage;if(stage){this.setLayerId(stage.getTopmostActiveLayer().guid)}else{_gliffy.Logger.warn("node has no stage, can't set layer Id")}},getNodeAndChildrensBoundingBox:function(){var boundingBox=new _gliffy.BoundingBox(),nodeBoundingBox=this.worldOverlayAabb,minX,minY,maxX,maxY;maxY=_.max(this.children,function(child){return child.worldAabb.max.y});maxY=Math.max(maxY,nodeBoundingBox.max.y)}})}());(function(){var ZOOM_FIT_PADDING=20,MAX_ZOOM=8,MAX_WIDTH=5000,MAX_HEIGHT=5000;_gliffy.Stage=_gliffy.Serializable.extend({id:null,zoom:1,pan_x:0,pan_y:0,background:"#FFFFFF",__unsavedChanges:false,width:750,height:1000,maxWidth:MAX_WIDTH,maxHeight:MAX_HEIGHT,exportBorder:false,gridOn:true,snapToGrid:true,drawingGuidesOn:true,printModel:null,__viewportType:"default",fitBB:null,shapeStyles:null,lineStyles:null,textStyles:null,themeData:null,objects:null,_layers:null,_node_map:null,_node_index:0,_calculate_bounds:true,_pan_dirty:true,deletes:null,dirty:null,autoFit:true,gon:null,document:null,commandHistory:null,worldAabb:null,options:{zoom:true,pan_x:true,pan_y:true,background:true,width:true,height:true,autoFit:true},init:function(options,id){var key;this.objects=[];this.shapeStyles={};this.lineStyles={};this.textStyles={};this._node_map={};this.deletes=[];this.dirty={};if(window.GliffyApp&&window.GliffyApp.PrintModel){this.printModel=GliffyApp.PrintModel.createFromObject()}this.worldAabb=new _gliffy.BoundingBox();this.fitBB=new _gliffy.BoundingBox();this.id=id||_gliffy.Utils.randomString(_gliffy.stages);_gliffy.stages[this.id]=this;if(_gliffy.Editor!==undefined){this.commandHistory=new _gliffy.CommandHistory(this)}if(options){if(options.predefineLayers){this._layers=[(new _gliffy.Layer()).fromDefault()];this._layers[0].setActive(true);delete options.predefineLayers}for(key in options){if(options.hasOwnProperty(key)){if(this.options[key]){this[key]=options[key]}else{throw key+" is not a valid option for stage"}}}}},getViewportType:function(){return this.__viewportType},setViewportType:function(viewportType){this.__viewportType=viewportType||"default"},getLayers:function(){return this._layers},getLayerByGUID:function(guid){var layer;layer=_.find(this._layers,{guid:guid})||null;return layer},addDirtyNode:function(node){this.dirty[node.getId()]=node.getId()},removeDirtyNode:function(node){delete this.dirty[node.getId()]},update:function(){var i;for(i=0;i<this.objects.length;i++){this.objects[i].update()}this.updateBounds()},setBoundsDirty:function(){this._calculate_bounds=true},setBoundsClean:function(){this._calculate_bounds=false},updateBounds:function(){if(this._calculate_bounds){this.worldAabb=this.calculateBoundingBox();this.width=Math.ceil(Math.min(this.worldAabb.max.x,this.maxWidth));this.height=Math.ceil(Math.min(this.worldAabb.max.y,this.maxHeight));this.setBoundsClean();this.fitBB=this.worldAabb}},find:function(node_id){return this._node_map[node_id]||null},findGraphic:function(type){var list=[],i;for(i=0;i<this.objects.length;i++){list=list.concat(this.objects[i].findGraphic(type))}return list},findNodesByLayerId:function(guid){var nodes;nodes=_.filter(this.objects,function(node){return node.getLayerId()===guid});return nodes},iterateNodes:function(callback){$.each(this._node_map,function(key,node){callback(node)})},prependNode:function(new_node,parent){this.insertNode(new_node,parent,0)},insertNode:function(new_node,parent,index){this.removeNode(new_node,false);this.__resetNodeId(new_node);if(new_node&&parent){if(!parent.children){parent.children=[]}parent.children.splice(index,0,new_node);new_node.parent=parent;parent.markDirty()}else{this.objects.splice(index,0,new_node);new_node.markDirty()}if(new_node.supportsConstraints()){new_node.subscribeAllConstraints()}if(_gliffy.Editor&&new_node.isSelection()){_gliffy.Mouse.editor.overlayManager.addSelectionNodesToBreakup(new_node)}},appendNode:function(new_node,parent){var index;if(parent){if(parent.children){index=parent.children.length}else{index=0}}else{index=this.objects.length}this.insertNode(new_node,parent,index)},appendCopyNode:function(node){this.insertCopyNode(node,this.objects.length)},prependCopyNode:function(node){this.insertCopyNode(node,0)},insertCopyNode:function(node,index){var idMap={};this.__resetCopyNodeId(node,idMap);this.objects.splice(index,0,node);node.markDirty();if(node.supportsConstraints()){this.__updateConstraintIds(node,idMap)}if(node.isSelection()){_gliffy.Mouse.editor.overlayManager.addSelectionNodesToBreakup(node)}new _gliffy.BringToFrontCommand({node:node}).execute(this)},calculateBoundingBox:function(){var boundingBox;if(this.objects.length>0){boundingBox=_gliffy.BoundingBox.SMALLEST.clone();_.each(this.objects,function(node){boundingBox.add(node.getChildrenWorldAabb(true))})}else{boundingBox=new _gliffy.BoundingBox()}return boundingBox},__updateConstraintIds:function(node,idMap){var i;if(node.hasConstraints()){node.getConstraints().updateIds(idMap)}for(i=0;node.children&&i<node.children.length;i++){this.__updateConstraintIds(node.children[i],idMap)}},__resetNodeId:function(node){var i=0,id=node._id;node.stage=this;if(id===null||id===undefined||id<0){id="auto"}node.setId(id);for(i=0;node.children&&i<node.children.length;i++){this.__resetNodeId(node.children[i])}},__resetCopyNodeId:function(node,idMap){var i=0,id=node._id;node.stage=this;node.setId("auto");idMap[id]=node.getId();for(i=0;node.children&&i<node.children.length;i++){this.__resetCopyNodeId(node.children[i],idMap)}},removeNode:function(node,markForDeletion,isChild){var i,parent;this.setBoundsDirty();if(node){if(markForDeletion===undefined||markForDeletion===null){markForDeletion=true}node=this.find(node.getId());if(node){for(i=0;node.children&&i<node.children.length;i++){this.removeNode(node.children[i],markForDeletion,true)}if(markForDeletion){this.removeDomNode(node)}parent=node.parent;if(!isChild){if(parent===null){this.__removeFromArray(this.objects,node)}else{this.__removeFromArray(parent.children,node)}node.parent=null}if(markForDeletion){node.notifyRemove()}node.stage=null;delete this._node_map[node.getId()]}}return node},removeDomNode:function(node){if(node._domId){this.deletes.push("#"+node._domId)}},isDirty:function(){return this.deletes.length>0||Object.keys(this.dirty).length>0},hasUnsavedChanges:function(){return this.__unsavedChanges},setUnsavedChanges:function(hasChanges){if(_gliffy.Editor!==undefined&&hasChanges!==this.__unsavedChanges){this.__unsavedChanges=hasChanges;if(window.GliffyApp){GliffyApp.documentModel.update(this.document)}}},setBackground:function(color){this.background=color;if(window.GliffyApp){GliffyApp.documentModel.updateProperty("pageColor",color)}},__removeFromArray:function(array,object){var index=-1,other,i;for(i=0;i<array.length;i++){other=array[i];if(other.getId()===object.getId()){index=i;break}}if(index>-1&&index<array.length){array.splice(index,1)}},getStagePanX:function(){return -this.pan_x/this.zoom},getStagePanY:function(){return -this.pan_y/this.zoom},zoomAt:function(zoom,stageX,stageY,viewportWidth,viewportHeight){var stagePanX=this.getStagePanX(),stagePanY=this.getStagePanY(),zoomRatio;zoom=(zoom<MAX_ZOOM)?zoom:MAX_ZOOM;zoomRatio=zoom/this.zoom;stagePanX=(stagePanX-stageX)/(zoomRatio)+stageX;stagePanY=(stagePanY-stageY)/(zoomRatio)+stageY;viewportWidth=viewportWidth/zoomRatio;viewportHeight=viewportHeight/zoomRatio;this.setZoom(zoom);this.setStagePan(stagePanX,stagePanY,viewportWidth,viewportHeight)},setPanX:function(x){this.pan_x=x;this._pan_dirty=true},setPanY:function(y){this.pan_y=y;this._pan_dirty=true},setStagePan:function(x,y,viewportWidth,viewportHeight){this.setPan(-x*this.zoom,-y*this.zoom,viewportWidth,viewportHeight)},setPan:function(x,y,viewportWidth,viewportHeight){this.setPanX(x);this.setPanY(y);this.clampPanning(viewportWidth,viewportHeight)},offsetPan:function(x,y,viewportWidth,viewportHeight){this.setPan(this.pan_x+x,this.pan_y+y,viewportWidth,viewportHeight)},clampPanning:function(viewportWidth,viewportHeight){var stageWidth=(this.autoFit||this.width>this.maxWidth)?this.maxWidth:this.width,stageHeight=(this.autoFit||this.height>this.maxHeight)?this.maxHeight:this.height,minWidth=Math.ceil((viewportWidth-stageWidth)*this.zoom),minHeight=Math.ceil((viewportHeight-stageHeight)*this.zoom);if(minWidth>0){minWidth=0}if(minHeight>0){minHeight=0}if(this.pan_x>0){this.pan_x=0}else{if(this.pan_x<minWidth){this.pan_x=minWidth}}if(this.pan_y>0){this.pan_y=0}else{if(this.pan_y<minHeight){this.pan_y=minHeight}}this.pan_x=Math.ceil(this.pan_x);this.pan_y=Math.ceil(this.pan_y)},centerAt:function(stageX,stageY,viewportWidth,viewportHeight){this.setStagePan(stageX-viewportWidth/2,stageY-viewportHeight/2,viewportWidth,viewportHeight)},zoomToCenter:function(zoom,viewportWidth,viewportHeight){var zoomRatio,stageX=this.getStagePanX()+viewportWidth/2,stageY=this.getStagePanY()+viewportHeight/2;zoom=(zoom<MAX_ZOOM)?zoom:MAX_ZOOM;zoomRatio=this.zoom/zoom;this.setZoom(zoom);this.centerAt(stageX,stageY,viewportWidth*zoomRatio,viewportHeight*zoomRatio)},zoomToBox:function(boundingBox,viewportWidth,viewportHeight){var dimension,xZoom,yZoom,zoom,zoomRatio,center;dimension=boundingBox.getDimension();xZoom=viewportWidth*this.zoom/dimension.x;yZoom=viewportHeight*this.zoom/dimension.y;zoom=(xZoom<yZoom)?xZoom:yZoom;zoom=(zoom<MAX_ZOOM)?zoom:MAX_ZOOM;zoomRatio=this.zoom/zoom;viewportWidth=viewportWidth*zoomRatio;viewportHeight=viewportHeight*zoomRatio;center=boundingBox.getCenter();this.setZoom(zoom);this.centerAt(center.x,center.y,viewportWidth,viewportHeight)},zoomToFit:function(viewportWidth,viewportHeight){var i,aabb=new _gliffy.BoundingBox().copy(_gliffy.BoundingBox.SMALLEST),visibleObjects=this.visibleNodes();if(visibleObjects.length===0){this.pan_x=0;this.pan_y=0;this.setZoom(1)}else{_.each(visibleObjects,function(visibleNode){aabb.add(visibleNode.worldAabb)});aabb.extend(ZOOM_FIT_PADDING);this.zoomToBox(aabb,viewportWidth,viewportHeight)}},getZoom:function(){return this.zoom},setZoom:function(value){this.zoom=(value<MAX_ZOOM)?value:MAX_ZOOM;$(document).trigger("gliffy.zoom",value)},isGridVisible:function(){return this.gridOn},setGridVisible:function(b){this.gridOn=b},isPageBreaksVisible:function(){return this.pageBreaksOn},setPageBreaksVisible:function(b){this.pageBreaksOn=b},isSnapToGrid:function(){return this.snapToGrid},setSnapToGrid:function(b){this.snapToGrid=b},isDrawingGuideOn:function(){return this.drawingGuidesOn},setDrawingGuideOn:function(b){this.drawingGuidesOn=b},isExportBorder:function(){return this.exportBorder},setExportBorder:function(b){this.exportBorder=b},setMaxWidth:function(w){this.maxWidth=w;if(window.GliffyApp){GliffyApp.documentModel.updateProperty("maxWidth",w)}},setMaxHeight:function(h){this.maxHeight=h;if(window.GliffyApp){GliffyApp.documentModel.updateProperty("maxHeight",h)}},updateProperty:function(prop,value){if(this["set"+prop]!==undefined){this["set"+prop](value)}},__toObject:function(){var i,node,objects=[],layers,object,type,stageBoundingBox,stageObject,stageObjectsLength;stageBoundingBox=new _gliffy.BoundingBox(0,0,this.maxWidth,this.maxHeight);stageObjectsLength=this.objects.length;for(i=0;i<stageObjectsLength;i++){node=this.objects[i];if(node instanceof _gliffy.Node){object=node.toObject();if(object&&_gliffy.Pick.isNodePartiallyInside(node,stageBoundingBox)){objects.push(object)}}else{throw new Error("Stage contains an unknown object type.")}}layers=this.getLayersObject();stageObject={objects:objects,background:this.background,width:this.width,height:this.height,maxWidth:this.maxWidth,maxHeight:this.maxHeight,nodeIndex:this._node_index,autoFit:this.autoFit,exportBorder:this.exportBorder,gridOn:this.gridOn,snapToGrid:this.snapToGrid,drawingGuidesOn:this.drawingGuidesOn,pageBreaksOn:this.pageBreaksOn,printGridOn:this.printGridOn,printPaper:this.printPaper,printShrinkToFit:this.printShrinkToFit,printPortrait:this.printPortrait,shapeStyles:this.shapeStyles,lineStyles:this.lineStyles,textStyles:this.textStyles,themeData:this.themeData,viewportType:this.__viewportType,layers:layers,fitBB:this.fitBB.toObject()};if(this.printModel){stageObject.printModel=this.printModel.toObject()}return stageObject},getAnalyticsData:function(){var data={diagramCategory:"none",categories:{},nodeType:{nodes:0,lines:0,groups:0,shapes:0,shapeParts:0,textChildren:0,standaloneTexts:0,images:0,multipartShapes:0,rotatedNodes:0}},split,category,uid,max=0;$.each(this._node_map,function(key,node){data.nodeType.nodes++;if(node.isLine()){data.nodeType.lines++}if(node.isGroup()){data.nodeType.groups++}if(node.isShape()){data.nodeType.shapes++;uid=node.getUid();if(uid){split=uid.split(".");if(split.length>=4){category=split[3];if(!data.categories[category]){data.categories[category]=0}data.categories[category]++}}}if(node.isShapePart()){data.nodeType.shapeParts++}if(node.isImage()){data.nodeType.images++}if(node.isMultipartShape()){data.nodeType.multipartShapes++}if(node.isTextChild()){data.nodeType.textChildren++}if(node.isStandAloneText()){data.nodeType.standaloneTexts++}if(node.getRotation()!==0){data.nodeType.rotatedNodes++}});$.each(data.categories,function(category,num){if(num>max){data.diagramCategory=category;max=num}});delete data.nodeType;return data},getLayersObject:function(){var layers;layers=_.map(this._layers,function(layer){return layer.toObject()});return layers},setLayersFromObject:function(layersArray){this._layers=_.map(layersArray,function(layerJson){return(new _gliffy.Layer()).fromObject(layerJson)},this)},getActiveLayers:function(){var layers;layers=_.filter(this._layers,function(layer){return layer.isActive()});return layers},getTopmostActiveLayer:function(){var layer;layer=_.max(this.getActiveLayers(),function(layer){return layer.getOrder()});return layer},__retrofitForLayers:function(){this._layers=[new _gliffy.Layer().fromDefault()];this._layers[0].setActive(true);_.each(this.objects,function(node){if(node instanceof _gliffy.Node){node.setLayerId(this._layers[0].getGuid())}},this)},fixNoActiveLayers:function(){var anyActiveLayers;if(!this._layers){return}anyActiveLayers=_.some(this._layers,function(layer){return layer.isActive()});if(!anyActiveLayers&&this._layers.length>0){_gliffy.Logger.warn("detected no active layers, attempting fix.");_gliffy.Utils.analyticsEvent("trackEvent",{category:"layers",action:"noActiveLayerBug"});this._layers[0].setActive(true);_.each(this.objects,function(node){if(node instanceof _gliffy.Node&&!node.isSelection()){if(node.getLayerId()===null||this.getLayerByGUID(node.getLayerId())===null){node.setLayerId(this._layers[0].getGuid());node.setOrder(0)}}},this);this.reorderNodes(this.objects)}},__fromObject:function(object,opt){this.objects.length=0;this._node_index=0;this._node_map={};this.dirty={};if(object.nodeIndex!==undefined){this._node_index=object.nodeIndex}var i,node,o,options=$.extend({subscribeToConstraints:true},opt);for(i=0;i<object.objects.length;i++){o=object.objects[i];node=new _gliffy.Node(this);node.fromObject(o,options);this.objects.push(node)}if(object.background!==undefined){this.background=object.background}if(object.width!==undefined){this.width=object.width}if(object.height!==undefined){this.height=object.height}if(object.autoFit!==undefined){this.autoFit=object.autoFit}if(object.exportBorder!==undefined){this.exportBorder=object.exportBorder}if(object.gridOn!==undefined){this.gridOn=object.gridOn}if(object.snapToGrid!==undefined){this.snapToGrid=object.snapToGrid}if(object.themeData!==undefined){this.themeData=object.themeData}if(object.drawingGuidesOn!==undefined){this.drawingGuidesOn=object.drawingGuidesOn}if(object.pageBreaksOn!==undefined){this.pageBreaksOn=object.pageBreaksOn}if(object.printGridOn!==undefined){this.printGridOn=object.printGridOn}if(object.printPaper!==undefined){this.printPaper=object.printPaper}if(object.printShrinkToFit!==undefined){this.printShrinkToFit=object.printShrinkToFit}if(object.printPortrait!==undefined){this.printPortrait=object.printPortrait}if(object.maxHeight!==undefined){this.maxHeight=object.maxHeight||MAX_WIDTH}if(object.maxWidth!==undefined){this.maxWidth=object.maxWidth||MAX_HEIGHT}if(Array.isArray(object.layers)){this.setLayersFromObject(object.layers);if(this._layers.length===0){this._layers.push(new _gliffy.Layer().fromDefault());this._layers[0].setActive(true)}this.fixNoActiveLayers()}else{this.__retrofitForLayers()}this.sendAllLayersToLayersController();this.setViewportType(object.viewportType);if(object.fitBB!==undefined){this.fitBB.fromObject(object.fitBB)}if(object.printModel!==undefined&&this.printModel){this.printModel.fromObject(object.printModel)}if(_gliffy.Editor!==undefined){if(object.shapeStyles!==undefined){this.shapeStyles=this.__buildStyles(object.shapeStyles,"ShapeStyle")}if(object.lineStyles!==undefined){this.lineStyles=this.__buildStyles(object.lineStyles,"LineStyle")}if(object.textStyles!==undefined){this.textStyles=this.__buildStyles(object.textStyles,"TextStyle")}}return this},__buildStyles:function(stylesObject,type){var key,styles={};for(key in stylesObject){if(stylesObject.hasOwnProperty(key)){styles[key]=new _gliffy[type]();styles[key].fromObject(stylesObject[key])}}return styles},__bringFrontSendBackHelper:function(nodeOrNodes,isFront){var stageNodes,sendList,orderBegin,i,orderList,activeLayers=[],reorderOptions={},guids;if(nodeOrNodes!==null){stageNodes=this.flattenNodes(false);sendList=this.__separateNodeSendToList(nodeOrNodes,stageNodes);if(isFront){stageNodes=stageNodes.concat(sendList);orderBegin=_gliffy.Layer.ABOVE_ALL_LAYERS}else{stageNodes=sendList.concat(stageNodes);orderBegin=-_gliffy.Layer.ABOVE_ALL_LAYERS}i=0;_.each(sendList,function(node){node.prevOrder=node.getOrder();node.setOrder(orderBegin+i++);activeLayers=activeLayers.concat(node.getActiveLayers())});activeLayers=_.unique(activeLayers);guids=_.map(activeLayers,function(layer){return layer.guid});if(activeLayers.length===1){reorderOptions.layerIds=[activeLayers[0].guid]}orderList=this.reorderNodes(stageNodes,{layerIds:guids});return orderList}return[]},bringToFront:function(nodeOrNodes){return this.__bringFrontSendBackHelper(nodeOrNodes,true)},sendToBack:function(nodeOrNodes){return this.__bringFrontSendBackHelper(nodeOrNodes,false)},sendAllLayersToLayersController:function(){this.fixNoActiveLayers();$(window).trigger("gliffy-stage-all-layers-updated",[this.getLayersObject()])},sendSingleLayerToLayersController:function(layer){$(window).trigger("gliffy-stage-layer-updated",[layer])},reorderNodes:function(nodes,options){var orderList=[],currentNodeOrderInfo,allNodes=[],o=$.extend({layerIds:[]},{},options);nodes=this.flattenNodeArrayWithoutReorder(nodes);_.each(nodes,function(node){var layers=node.getActiveLayers(),layer;if(layers&&_.first(layers)){layer=_.first(layers);if(!layer.tmpNodes){layer.tmpNodes=[]}if(o.layerIds.length===0||_.indexOf(o.layerIds,layer.guid)>=0){layer.tmpNodes.push(node);layer.setNodeIndex(0)}}});_.each(this._layers,function(layer){if(layer.tmpNodes){layer.tmpNodes=_.sortBy(layer.tmpNodes,function(node){return node.getOrder()});allNodes=allNodes.concat(layer.tmpNodes);_.each(layer.tmpNodes,function(node){var newOrder;if(_gliffy.Debug.POLL_LAYER_STATE){if(_.first(node.getActiveLayers()).guid!==layer.guid){_gliffy.Logger.warn("mismatch detected between nodes' layer guid and the layer it thinks it's on")}}if(node.getRawOrder()!=="auto"){newOrder=layer.getOrderForNewNode();currentNodeOrderInfo=_.findWhere(orderList,{id:node.getId()});if(currentNodeOrderInfo){currentNodeOrderInfo.order=node.getOrder();currentNodeOrderInfo.newOrder=newOrder}else{orderList.push({id:node.getId(),order:node.getOrder(),newOrder:newOrder});if(_gliffy.Debug.SHOW_LAYERS){orderList[orderList.length-1].uid=node.getUid()}}node.setOrder(newOrder)}layer.incrementNodeIndex()});delete layer.tmpNodes}},this);this.sendAllLayersToLayersController();_.each(allNodes,function(node){if(node.prevOrder!==undefined&&node.prevOrder!==null){var foundIndex=_.findWhere(orderList,{id:node.getId()});if(foundIndex){foundIndex.order=node.prevOrder}delete node.prevOrder}});return orderList},__separateNodeSendToList:function(node,flatNodeList){var ids,i,j,n,childrenList,sendList=[];ids=(node instanceof _gliffy.Node)?[node]:node;for(i=0;i<ids.length;i++){n=ids[i];flatNodeList.splice($.inArray(n,flatNodeList),1);sendList.push(n);if(ids.length===1&&n.children&&n.children.length>0){childrenList=n.flattenChildren();for(j=0;j<childrenList.length;j++){flatNodeList.splice($.inArray(childrenList[j],flatNodeList),1)}sendList=sendList.concat(childrenList)}}return sendList},flattenNodeArrayWithoutReorder:function(nodes){var flattenRecursive=function(nodes,flattened){_.each(nodes,function(node){flattened.push(node);if(node.children instanceof Array){flattened=flattened.concat(flattenRecursive(node.children,[]))}});return flattened};return flattenRecursive(nodes,[])},flattenNodes:function(forceUpdate){var nodes=[],i=0;for(i=0;i<this.objects.length;i++){this.__preorder(this.objects[i],nodes,forceUpdate)}this.updateBounds();nodes=nodes.sort(function(n1,n2){var result=n1.getOrder()-n2.getOrder();if(result===0){if(n1.isAChildOf(n2)){return 1}else{if(n2.isAChildOf(n1)){return -1}else{return n1.getId()>n2.getId()?1:-1}}}else{return result}});return nodes},visibleFlattenedNodes:function(forceUpdate){var flattenedNodes,visibleFlattenedNodes;flattenedNodes=this.flattenNodes(forceUpdate);visibleFlattenedNodes=[];$.each(flattenedNodes,function(_,node){if(!node.getHidden()&&!node.getLayerHidden()){visibleFlattenedNodes.push(node)}});return visibleFlattenedNodes},visibleNodes:function(){var nodes;nodes=_.filter(this.objects,function(node){return !node.getNodeOrLayerHidden()});return nodes},__preorder:function(node,array,forceUpdate){var c=0;if(!node){return}if(forceUpdate){if(node.getGraphic()){node.getGraphic().markDirty()}node.markDirty()}if(node.isDirty()){node.update()}array.push(node);for(c=0;node.children&&c<node.children.length;c++){this.__preorder(node.children[c],array,forceUpdate)}},detachSelectionFromGroup:function(parentNode,childLayerMap){var stage=this,childNode,childTransform,childPos,parentParentNode,selectedNodeIds=[],children=[];if(parentNode.children){parentNode.children=_.sortBy(parentNode.children,function(child){return child.getOrder()})}while(parentNode.children.length){childNode=parentNode.children[0];if(childLayerMap&&childLayerMap[childNode.getId()]){childNode.setLayerId(childLayerMap[childNode.getId()])}else{if(parentNode.getLayerId()){childNode.setLayerId(parentNode.getLayerId())}}selectedNodeIds.push(childNode.getId());parentParentNode=childNode.parent.parent;childTransform=childNode.worldTransform.clone();childPos=childTransform.transformPoint(childNode.getWidth()/2,childNode.getHeight()/2);childNode.setX(childPos.x-childNode.getWidth()/2);childNode.setY(childPos.y-childNode.getHeight()/2);childNode.setRotation(childNode.getRotation()+parentNode.getRotation());stage.removeNode(childNode,false);stage.appendNode(childNode,parentParentNode);children.push(childNode)}parentNode.setCopiedSelection(false);return selectedNodeIds},attachSelectionToGroup:function(group,nodes){var boundingBox=_gliffy.BoundingBox.SMALLEST.clone(),i,node,stage=this;group.update();this.__updateGroupAndBounds(group,nodes,boundingBox);for(i=0;i<nodes.length;i++){node=nodes[i];if(!node.isProxy()){node.setX(node.getX()-group.getX());node.setY(node.getY()-group.getY());stage.removeNode(node,false);stage.appendNode(node,group)}}},__updateGroupAndBounds:function(group,nodes,boundingBox){var i,node,dimension,stage=this;for(i=0;i<nodes.length;i++){node=nodes[i];if(!node.isProxy()){node.update();boundingBox.add(node.worldOverlayAabb)}}group.setX(boundingBox.min.x);group.setY(boundingBox.min.y);dimension=boundingBox.getDimension();group.setWidth(dimension.x);group.setHeight(dimension.y)},invalidateTextWithFont:function(font){var nodes=this.findGraphic(_gliffy.Text),i;for(i=0;i<nodes.length;i++){var graphic=nodes[i].getGraphic();if(graphic.getHTML()&&graphic.getHTML().toLowerCase().indexOf(font)>=0){graphic.invalidate()}}},addSelectionToGroup:function(group,nodes){var i,node,stage=this,point,inverse,lastBB;group.update();lastBB=group.worldAabb.clone();this.__updateGroupAndBounds(group,nodes,group.worldAabb.clone());group.update();for(i=0;group.children&&i<group.children.length;i++){node=group.children[i];node.setX(node.getX()-(group.worldAabb.min.x-lastBB.min.x));node.setY(node.getY()-(group.worldAabb.min.y-lastBB.min.y))}for(i=0;i<nodes.length;i++){node=nodes[i];if(!node.isProxy()){node.update();stage.removeNode(node,false);stage.appendNode(node,group);node.setX(node.getX()-group.getX());node.setY(node.getY()-group.getY())}}},getWebFonts:function(){var stage=this,textNodes=stage.findGraphic(_gliffy.Text),loadMe={},i,textGraphic,fam,fontArray;for(i=0;i<textNodes.length;i++){textGraphic=textNodes[i].getGraphic();$(textGraphic.getHTML()).find("span").each(function(){fam=$(this).css("font-family");if(fam){fam=fam.replace(/[\'\"]/g,"");loadMe[fam]=true}})}fontArray=[];$.each(loadMe,function(key){if(_gliffy.TextUtils.FONT_FIXES[key]&&_gliffy.TextUtils.FONT_FIXES[key].isWebFont){fontArray.push("'"+key+"'")}});return fontArray},hasObjects:function(){return(this.objects!==null&&this.objects.length>0)},isTransparent:function(){return(this.background==="rgba(0, 0, 0, 0)")}})}());(function(){var CURRENT_VERSION="1.3",BETA_VERSION="1.3",CONTENT_TYPE="application/gliffy+json";function isValidVersion(version){if($.type(version)!=="string"){version=version.toString()}return CURRENT_VERSION.split(".")[0]===version.split(".")[0]}_gliffy.Gon=_gliffy.Serializable.extend({version:null,stage:null,metadata:null,embeddedResources:null,__devLinkMap:null,init:function(options){this.stage=new _gliffy.Stage(options);this.stage.gon=this;this.metadata=this.getDefaultMetadata();this.embeddedResources=new _gliffy.EmbeddedResources()},getDefaultMetadata:function(){return{title:"untitled",revision:0,exportBorder:false,loadPosition:"default"}},getMetadata:function(){return this.metadata},setMetadata:function(o){this.metadata=$.extend(this.getDefaultMetadata(),o)},getLibrariesMetadata:function(){if(this.metadata){return this.metadata.libraries}return null},setLibrariesMetadata:function(libraries){if(!this.metadata){this.metadata=this.getDefaultMetadata()}this.metadata.libraries=libraries},getEmbeddedResources:function(){return this.embeddedResources},setBetaVersion:function(){this.version=BETA_VERSION;_gliffy.Utils.disableExportsForBeta()},isBetaVersion:function(){return this.version===BETA_VERSION},setCurrentVersion:function(){this.version=CURRENT_VERSION;_gliffy.Utils.enableExportsForBeta()},updateProperty:function(prop,value){if(this["set"+prop]!==undefined){this["set"+prop](value)}else{this.stage.updateProperty(prop,value)}},__toObject:function(){var object=null,self=this,embeddedResources=null;_gliffy.Utils.tryCatch(function(){object=self.stage.toObject();embeddedResources=self.embeddedResources.toObject()},function(e){_gliffy.handleError("com.gliffy.error.file_save_malformed",[],e,self.errorTarget)});if(object!==null){return{contentType:CONTENT_TYPE,version:CURRENT_VERSION,metadata:this.metadata,embeddedResources:embeddedResources,stage:object}}else{return null}},fromObject:function(object,opt){if(!object.version||!isValidVersion(object.version)){_gliffy.Logger.error("gon.fromObject failed. The file being loaded is not a valid version:"+object.version);throw new Error("The file being loaded is not a valid version: "+object.version)}else{if(object.version===BETA_VERSION){_gliffy.Utils.disableExportsForBeta()}else{if(_gliffy.Utils.compareVersionNumbers(object.version,CURRENT_VERSION)>0){_gliffy.Logger.warn("Gliffy file is version "+object.version+" but current version is "+CURRENT_VERSION);_gliffy.Utils.notify("warn",$.i18n._("NEWER_VERSION_TITLE"),$.i18n._("NEWER_VERSION_MSG"))}}this.version=object.version||CURRENT_VERSION;this.setMetadata(object.metadata);this.stage.fromObject(object.stage,opt);this.embeddedResources.fromObject(object.embeddedResources)}return this},__populateUids:function(nodes,uids){var i,uid,node;for(i=0;i<nodes.length;i++){node=nodes[i];uid=node.getUid();if($.inArray(uid,uids)===-1&&uid){uids.push(uid)}if(node.children){this.__populateUids(node.children,uids)}}},loadEditableProperties:function(callback){if(!_gliffy.shapeLibrary){throw new Error("the shapeLibrary instance has not been initialized.")}var uids=[];this.__populateUids(this.stage.objects,uids);_gliffy.shapeLibrary.loaded.done(callback)},setDevLinkMap:function(map){this.__devLinkMap=map},getDevLinkMap:function(map){return this.__devLinkMap},__registerShapes:function(callback){var i,nodes,graphic,deferred=[],svg,resource;if(!_gliffy.shapeLibrary){throw new Error("the shapeLibrary instance has not been initialized.")}nodes=this.__flattenNodes(this.stage);for(i=0;i<nodes.length;i++){graphic=nodes[i].getGraphic();if(graphic&&graphic instanceof _gliffy.Svg&&graphic.getTid()==="com.gliffy.stencil.custom.svg.static"){resource=this.getEmbeddedResources().getResource(graphic.getEmbeddedResourceId());svg=resource.getData();deferred.push(_gliffy.shapeLibrary.loadSvgStencil(svg,resource,true))}}deferred.push(_gliffy.shapeLibrary.loaded);$.when.apply(null,deferred).done(callback)},__flattenNodes:function(stage){var i,nodes=[];for(i=0;i<stage.objects.length;i++){this.__preorder(stage.objects[i],nodes)}return nodes},__preorder:function(node,array){var c;if(!node){return}array.push(node);for(c=0;node.children&&c<node.children.length;c++){this.__preorder(node.children[c],array)}}})}());(function(){_gliffy.Document=_gliffy.Serializable.extend({__gon:null,__image:null,__title:"untitled",__revision:0,__urls:null,__autosaveDisabled:false,__devLinkMap:null,__loadPosition:"default",editable:null,errorTarget:null,init:function(options){this.__gon=new _gliffy.Gon(options);this.__gon.stage.document=this;this.__urls={};this.editable=_gliffy.Editor!==undefined},getUrls:function(){return this.__urls},getGon:function(){return this.__gon},getStage:function(){return this.__gon.stage},getImage:function(){return this.__image},setImage:function(image){this.__image=image},getMetadata:function(){return this.__gon.getMetadata()},getEmbeddedResources:function(){return this.__gon.getEmbeddedResources()},getLibrariesMetadata:function(){return this.__gon.getLibrariesMetadata()},setLibrariesMetadata:function(libraries){this.__gon.setLibrariesMetadata(libraries)},setMetadata:function(metadata){this.__gon.setMetadata(metadata)},setTitle:function(title){this.__title=title},getTitle:function(){return this.__title||"untitled"},getCurrentRevision:function(){return this.__revision||0},setCurrentRevision:function(rev){this.__revision=rev},setAutosaveDisabled:function(b){this.__autosaveDisabled=b},isAutosaveDisabled:function(){if(this.__autosaveDisabled===undefined||this.__autosaveDisabled===null){return false}return this.__autosaveDisabled},getLoadPosition:function(){return this.__loadPosition},setLoadPosition:function(loadPosition){this.__loadPosition=loadPosition||"default"},loadFromObject:function(object,callback){var self=this;try{if(window.GLIFFY.DevLinkMap){window.GLIFFY.DevLinkMap.getLinkMap(object,function(map){self.__gon.setDevLinkMap(map)})}this.fromObject(object);_gliffy.FontLoader.waitForWebfonts(this.getGon().stage.getWebFonts(),function(){self.__gon.__registerShapes(function(){if(self.editable){self.__gon.loadEditableProperties(function(){self.getStage().update();if(callback){callback()}})}else{if(callback){callback()}}})})}catch(e){if(callback){callback()}_gliffy.handleError("com.gliffy.error.file_malformed",[],e)}},loadFromText:function(text,callback){this.loadFromObject($.parseJSON(text),callback)},updateProperty:function(prop,value){if(this["set"+prop]!==undefined){this["set"+prop](value)}else{this.__gon.updateProperty(prop,value)}},refreshFromObject:function(object){this.__urls=object.urls||{};this.__title=object.title;this.__revision=object.revision;return this},isNewNotDirty:function(){return(this.getCurrentRevision()===0&&!this.getStage().isDirty())},convertToTemplate:function(){this.__title="untitled";this.__revision=0},__toObject:function(){var object=null,self=this;_gliffy.Utils.tryCatch(function(){if(_gliffy.FEATURES.allowDisableAutosave){self.setMetadata($.extend({},self.getMetadata(),{autosaveDisabled:self.__autosaveDisabled}))}self.setMetadata($.extend({},self.getMetadata(),{loadPosition:self.__loadPosition,lastSerialized:new Date().getTime(),analyticsProduct:_gliffy.analyticsProduct}));object=self.__gon.toObject()},function(e){_gliffy.handleError("com.gliffy.error.file_save_malformed",[],e,self.errorTarget)});if(object!==null){return{gon:object,image:this.__image,urls:this.__urls,title:this.__title,revision:this.__revision}}else{return null}},fromObject:function(object){if(object.gon){this.__gon.fromObject(object.gon);this.__image=object.image;this.__urls=object.urls||{};this.__title=object.title;this.__revision=object.revision;this.__metaDataFromObject(object.gon.metadata);return this}else{this.__gon.fromObject(object);this.__image=null;this.__urls=object.urls||{};this.__title=object.title;this.__revision=object.revision;this.__metaDataFromObject(object.metadata);return this}},__metaDataFromObject:function(metadata){if(metadata){if(_gliffy.FEATURES.allowDisableAutosave&&metadata.autosaveDisabled){this.setAutosaveDisabled(metadata.autosaveDisabled)}this.setLoadPosition(metadata.loadPosition)}}})}());(function(){_gliffy.MINDMAP_COLOR_SCHEME_GENERATION="generation";_gliffy.MINDMAP_COLOR_SCHEME_FAMILY="family";_gliffy.MINDMAP_SCHEME_NODE_TREE={family:[{uid:"com.gliffy.shape.mindmap.mindmap_v1.default.main_topic"},{uid:"com.gliffy.shape.mindmap.mindmap_v1.default.subtopic",fill:"line"},{uid:"com.gliffy.shape.mindmap.mindmap_v1.default.child_node"}],generation:[{uid:"com.gliffy.shape.mindmap.mindmap_v1.default.main_topic"},{uid:"com.gliffy.shape.mindmap.mindmap_v1.default.subtopic",fill:"line"},{uid:"com.gliffy.shape.mindmap.mindmap_v1.default.child_node"}]};_gliffy.Mindmap=_gliffy.Shape.extend({__rootNodeId:null,__parentNodeId:null,__childNodeIds:null,__treeDepth:0,__colorScheme:"family",__colorPalette:null,isCollapsed:false,getTreeDepth:function(){return this.__treeDepth},setTreeDepth:function(treeDepth){this.__treeDepth=treeDepth},getRootNodeId:function(){return this.__rootNodeId},setRootNodeId:function(rootNodeId){this.__rootNodeId=rootNodeId},getParentNodeId:function(){return this.__parentNodeId},setParentNodeId:function(parentNodeId){this.__parentNodeId=parentNodeId},getChildNodeIds:function(){if(this.__childNodeIds===null){this.__childNodeIds=[]}return this.__childNodeIds},setChildNodeIds:function(childNodeIds){this.__childNodeIds=childNodeIds},addChildNodeId:function(id){if(this.getChildNodeIds().indexOf(id)<0){this.getChildNodeIds().push(id)}},removeChildNodeId:function(id){if(this.__childNodeIds&&this.__childNodeIds.length>0){this.__childNodeIds.splice(this.__childNodeIds.indexOf(id),1)}},getColorScheme:function(){return this.__colorScheme},setColorScheme:function(colorScheme){this.__colorScheme=colorScheme;this.markDirty()},getColorPalette:function(){if(this.__colorPalette===null&&this.__treeDepth===0){this.__colorPalette=["#688a4f","#235695","#ff9900","#cc0000","#6342b8","#a64d79","#5b0f00","#666666"]}return this.__colorPalette},setColorPalette:function(colorPalette){this.__colorPalette=colorPalette;this.markDirty()},getClassName:function(){return"Mindmap"},removeNode:function(commandBundle){var stage=this.node.stage,parent,parentGraphic,childNodeIds;parent=stage.find(this.getParentNodeId());if(parent){this.getMindmapGraphic(parent).removeChildNodeId(this.node.getRootParent().getId())}this.getConnectedLines({commandBundle:commandBundle,removeConnectedLine:true});if(this.__childNodeIds){childNodeIds=this.__childNodeIds.slice();this.__removeChildren(childNodeIds,commandBundle)}},getConnectedLines:function(o){var i,options=$.extend({},{removeConnectedLine:false,commandBundle:null,ignoreLinesTo:false,ignoreLinesFrom:false},o),stage=this.node.stage,lines=stage.findGraphic(_gliffy.Line),line,connectionEndId,connectionStartId,topLevelNodeId,removeConnectedLine=options.removeConnectedLine,commandBundle=options.commandBundle,connectedLines=[];if(lines){for(i=0;i<lines.length;i++){line=lines[i].getGraphic();connectionEndId=line.getEndConnectionId();connectionStartId=line.getStartConnectionId();topLevelNodeId=this.node.getRootParent().getId();if((!options.ignoreLinesTo&&topLevelNodeId===connectionEndId)||(!options.ignoreLinesFrom&&topLevelNodeId===connectionStartId)){connectedLines.push(line.node);if(removeConnectedLine&&commandBundle){commandBundle.push(new _gliffy.RemoveNodeCommand({node:line.node}))}}}}return connectedLines},__removeChildren:function(childNodeIds,commandBundle){var i,stage=this.node.stage,child;if(childNodeIds){for(i=0;i<childNodeIds.length;i++){child=stage.find(childNodeIds[i]);if(child){this.getMindmapGraphic(child).removeNode(commandBundle);if(commandBundle){commandBundle.push(new _gliffy.RemoveNodeCommand({node:child}))}}}}},getMindmapGraphic:function(node){return node.findGraphic(_gliffy.Mindmap)[0].getGraphic()},addNode:function(stage){var self=this,parent,parentGraphic;setTimeout(function(){parent=stage.find(self.getParentNodeId());if(parent){self.getMindmapGraphic(parent).addChildNodeId(self.node.getRootParent().getId());self.setChildNodeIds(null)}},100)},getChildrenNodes:function(o){var options=$.extend({},{includeConnectedLines:false,excludeCollapsed:false},o),childrenNodes=[],i,childNode,childNodeGraphic;if(this.__childNodeIds){for(i=0;i<this.__childNodeIds.length;i++){childNode=this.node.stage.find(this.__childNodeIds[i]);if(childNode){childrenNodes.push(childNode);childNodeGraphic=this.getMindmapGraphic(childNode);if(options.excludeCollapsed&&childNodeGraphic.isCollapsed){if(options.includeConnectedLines){childrenNodes=childrenNodes.concat(childNodeGraphic.getConnectedLines({ignoreLinesFrom:true}))}}else{if(options.includeConnectedLines){childrenNodes=childrenNodes.concat(childNodeGraphic.getConnectedLines())}childrenNodes=childrenNodes.concat(this.getMindmapGraphic(childNode).getChildrenNodes(o))}}}}return childrenNodes},__toObject:function(){var o=this._super();o.rootNodeId=this.__rootNodeId;o.parentNodeId=this.__parentNodeId;o.childNodeIds=this.__childNodeIds;o.colorScheme=this.__colorScheme;o.treeDepth=this.__treeDepth;o.colorPalette=this.__colorPalette;return o},__fromObject:function(object){this._super(object);if(object.rootNodeId!==undefined){this.setRootNodeId(object.rootNodeId)}if(object.parentNodeId!==undefined){this.setParentNodeId(object.parentNodeId)}if(object.childNodeIds!==undefined){this.setChildNodeIds(object.childNodeIds)}if(object.colorScheme!==undefined){this.setColorScheme(object.colorScheme)}if(object.treeDepth!==undefined){this.setTreeDepth(object.treeDepth)}if(object.colorPalette!==undefined){this.setColorPalette(object.colorPalette)}return this}})}());(function(){_gliffy.Link=_gliffy.Graphic.extend({_href:null,_renderIcon:true,style:null,init:function(){this.style={}},getTid:function(){return"link"},markDirty:function(){this._dirty=true;if(this.node){this.node.markDirty();this.node.setFlag("skin");if(this.node.parent){this.node.parent.markDirty()}}},getRenderIcon:function(){return this._renderIcon},setRenderIcon:function(render){this._renderIcon=render},getHref:function(){return this._href},setHref:function(text){this._href=text;this.markDirty()},update:function(){},applyStyle:function(style){},getClassName:function(){return"Link"},__toObject:function(){this.update();return{href:this.getHref(),renderIcon:this.getRenderIcon()}},__fromObject:function(object){if(object.href!==undefined){this.setHref(object.href)}if(object.renderIcon!==undefined){this.setRenderIcon(object.renderIcon)}}})})();(function(){_gliffy.Layer=_gliffy.Serializable.extend({guid:null,_name:null,_active:null,_locked:null,_visible:null,_order:null,_nodeIndex:null,setName:function(name){this._name=name;return this},getName:function(){return this._name},setActive:function(active){this._active=active;return this},isActive:function(){return this._active},setLocked:function(locked){this._locked=locked;return this},setGuid:function(guid){this.guid=guid;return this},getGuid:function(){return this.guid},setOrder:function(order){this._order=order;return this},getOrder:function(){return this._order},isLocked:function(){return this._locked},setVisible:function(visible){this._visible=visible;return this},isVisible:function(){return this._visible},fromDefault:function(){return this.fromObject(_gliffy.Layer.DEFAULT_LAYER).setGuid(_gliffy.Utils.simpleRandomString())},getNodeIndex:function(){return this._nodeIndex},setNodeIndex:function(index){this._nodeIndex=index;return this},incrementNodeIndex:function(){this._nodeIndex++;return this},getOrderForNewNode:function(){return this.getOrder()*_gliffy.Layer.LAYER_OFFSET+this.getNodeIndex()},fromObject:function(object){if(object.name!==undefined){this.setName(object.name)}if(object.active!==undefined){this.setActive(object.active)}if(object.locked!==undefined){this.setLocked(object.locked)}if(object.visible!==undefined){this.setVisible(object.visible)}if(object.guid!==undefined){this.setGuid(object.guid)}if(object.order!==undefined){this.setOrder(object.order)}if(object.nodeIndex!==undefined){this.setNodeIndex(object.nodeIndex)}return this},toObject:function(){return{guid:this.getGuid(),order:this.getOrder(),name:this.getName(),active:this.isActive(),locked:this.isLocked(),visible:this.isVisible(),nodeIndex:this.getNodeIndex()}}});_gliffy.Layer.DEFAULT_LAYER={name:"Layer 0",active:false,locked:false,visible:true,order:0,nodeIndex:0};_gliffy.Layer.MAX_LAYERS=20;_gliffy.Layer.LAYER_OFFSET=10000;_gliffy.Layer.ABOVE_ALL_LAYERS=_gliffy.Layer.MAX_LAYERS*_gliffy.Layer.LAYER_OFFSET}());(function(){_gliffy.IntegrationHandler=_gliffy.Class.extend({closeLastTab:function(edtior){throw new Error("The integration point 'closeLastTab' is not defined and is required.")},getCustomShapes:function(libraryUid,successCallback,errorCallback){throw new Error("The integration point 'getCustomShapes' is not defined and is required.")},getCustomLibrary:function(libraryUid,successCallback,errorCallback){throw new Error("The integration point 'getCustomLibrary' is not defined and is required")},getCustomLibraryList:function(limit,offset,successCallback,errorCallback){throw new Error("the integration point 'getCustomLibraryList' is not defined and is required")},getFavoriteLibraryList:function(limit,offset,successCallback,errorCallback){throw new Error("the integration point 'getFavoriteLibraryList' is not defined and is required")},markFavoriteCustomLibrary:function(libraryUid,successCallback,errorCallback){throw new Error("The integration point 'markFavoriteCustomLibrary' is not defined and is required")},removeFavoriteCustomLibrary:function(libraryUid,successCallback,errorCallback){throw new Error("The integration point 'removeFavoriteCustomLibrary' is not defined and is required")},getShallowLibrary:function(libraryUid,successCallback,errorCallback){throw new Error("The integration point 'getShallowLibrary' is not defined and is required")},createCustomLibrary:function(library,successCallback,errorCallback){throw new Error("The integration point 'createCustomLibrary' is not defined and is required")},updateCustomLibrary:function(library,successCallback,errorCallback){throw new Error("The integration point 'updateCustomLibrary' is not defined and is required")},deleteCustomLibrary:function(libraryUid,successCallback,errorCallback){throw new Error("The integration point 'deleteCustomLibrary' is not defined and is required")},checkDraft:function(document,successCallback,errorCallback){throw new Error("The integration point 'checkDraft' is not defined and is required.")},saveDraft:function(document,successCallback,errorCallback){throw new Error("The integration point 'saveDraft' is not defined and is required.")},getDraft:function(url,successCallback,errorCallback){throw new Error("The integration point 'getDraft' is not defined and is required.")},deleteDraft:function(document,successCallback,errorCallback){throw new Error("The integration point 'deleteDraft' is not defined and is required.")}});_gliffy.IntegrationHandler.validate=function(integration){var key,integrationHandle;for(key in _gliffy.IntegrationHandler.prototype){integrationHandle=integration[key];if(integrationHandle===_gliffy.IntegrationHandler.prototype){throw new Error("The integration handle interface was not defined: "+key)}else{if(typeof(integrationHandle)!=="function"){throw new Error("The integration handler must be a function: "+key)}}}}}());(function(){_gliffy.EditableLine=_gliffy.Editable.extend({__lockSegments:null,__overridePoints:null,__adjustedPath:null,_startContraintUpdate:null,_endContraintUpdate:null,__CURVELENGTH:10,__OFFSET:40,allowComputeBestPath:false,allowClearLocks:true,__updateNum:0,__previousWorldControlPath:null,__previousEndPoint:null,__previousStartPoint:null,__TABLE:[[[["sp","tl","tr","br"],["sp","tl","tr","br","ep"],["sp","tl","tc","bc","br","ep"],["sp","tl","tc","bc","br"],["sp","tl","tr","br"]],[["tl","tr","br"],["tl","tr","br","ep"],["tl","tc","bc","br","ep"],["tl","tc","bc","br"],{path1:["tl","tc","bc","br"],path2:["tl","tr","br"]}],[["tl","cl","cr","br"],["tl","cl","cr","br","ep"],["tl","bl","br","ep"],["tl","bl","br"],{path1:["tl","bl","br"],path2:["tl","cl","cr","br"]}],[["sp","tl","cl","cr","br"],["sp","tl","cl","cr","br","ep"],["sp","tl","bl","br","ep"],["sp","tl","bl","br"],["sp","tl","bl","br"]],[{path1:["tl","tr","br"],path2:["tl","cl","cr","br"]},["tl","tr","br","ep"],["tl","bl","br","ep"],{path1:["tl","tc","bc","br"],path2:["tl","bl","br"]},null]],[[["sp","tr","tl","bl"],["sp","tr","tc","bc","bl"],["sp","tr","tc","bc","bl","ep"],["sp","tr","tl","bl","ep"],["sp","tr","tl","bl"]],[["sp","tr","cr","cl","bl"],["sp","tr","br","bl"],["sp","tr","br","bl","ep"],["sp","tr","cr","cl","bl","ep"],["sp","tr","br","bl"]],[["tr","cr","cl","bl"],["tr","br","bl"],["tr","br","bl","ep"],["tr","cr","cl","bl","ep"],{path1:["tr","br","bl"],path2:["tr","cr","cl","bl"]}],[["tr","tl","bl"],["tr","tc","bc","bl"],["tr","tc","bc","bl","ep"],["tr","tl","bl","ep"],{path1:["tr","tc","bc","bl"],path2:["tr","tl","bl"]}],[{path1:["tr","tl","bl"],path2:["tr","cr","cl","bl"]},{path1:["tr","tc","bc","bl"],path2:["tr","br","bl"]},["tr","br","bl","ep"],["tr","tl","bl","ep"],null]]],init:function(o){this._super(o);this.isEditable=true;this.__lockSegments={}},isSegmentHorizontal:function(index){return _gliffy.Utils.isHorizontal(this.__graphic.getWorldControlPoint(index),this.__graphic.getWorldControlPoint(index+1))},scaleControlPath:function(scaleX,scaleY){var i,controlPoint,controlPath;if(scaleX!==1||scaleY!==1){controlPath=this.__graphic.getControlPath();for(i=0;i<controlPath.length;i++){controlPoint=controlPath[i];controlPoint[0]*=scaleX;controlPoint[1]*=scaleY}this.__graphic.setControlPath(controlPath)}},setLockSegment:function(index,value){if(value){this.__lockSegments[index]=value}else{delete this.__lockSegments[index]}this.__graphic.markDirty()},getLockSegments:function(){return $.extend({},this.__lockSegments)},setLockSegments:function(lockSegments){this.__lockSegments=$.extend({},lockSegments)},isLockSegment:function(index){return this.__lockSegments[index]||false},clearLockSegments:function(){this.__lockSegments={};this.__graphic.markDirty()},setStartPoint:function(sp){this.__graphic.setControlPoint(0,sp)},setEndPoint:function(ep){this.__graphic.setControlPoint(this.__graphic.getControlPointCount()-1,ep)},setWorldStartPoint:function(sp){if(this.__graphic.getStartConnectionId()!==null){this.__graphic.setWorldControlPoint(0,sp)}},setWorldEndPoint:function(ep){if(this.__graphic.getEndConnectionId()!==null){this.__graphic.setWorldControlPoint(this.__graphic.getControlPointCount()-1,ep)}},setConnectionStart:function(graphicNode,graphicConnectionIdx){var ratio=null;if(graphicNode){if(!graphicNode.supportsConnections()){throw new Error("line.editable.setConnectionStart expects graphicNode to support connections")}ratio=graphicNode.getConnectionPointRatio(graphicConnectionIdx)}this.__graphic.setStartConnection(graphicNode,ratio)},clearConnectionStart:function(){this.__graphic.setStartConnection(null)},setConnectionEnd:function(graphicNode,graphicConnectionIdx){var ratio=null;if(graphicNode){if(!graphicNode.supportsConnections()){throw new Error("line.editable.setConnectionEnd expects graphicNode to support connections")}ratio=graphicNode.getConnectionPointRatio(graphicConnectionIdx)}this.__graphic.setEndConnection(graphicNode,ratio)},clearConnectionEnd:function(){this.__graphic.setEndConnection(null)},getConnectionStart:function(){var startConnection=this.__graphic.getStartConnection();if(startConnection){return{node:startConnection,index:startConnection.getConnectionIndexByRatio(this.__graphic.getStartConnectionRatio()),ratio:this.__graphic.getStartConnectionRatio()}}else{return null}},getConnectionEnd:function(){var endConnection=this.__graphic.getEndConnection();if(endConnection){return{node:endConnection,index:endConnection.getConnectionIndexByRatio(this.__graphic.getEndConnectionRatio()),ratio:this.__graphic.getEndConnectionRatio()}}else{return null}},getWorldStartPoint:function(){return this.__graphic.getWorldControlPoint(0)},getStartPoint:function(){return this.__graphic.getControlPoint(0)},getWorldEndPoint:function(){return this.__graphic.getWorldControlPoint(this.__graphic.getControlPointCount()-1)},getEndPoint:function(){return this.__graphic.getControlPoint(this.__graphic.getControlPointCount()-1)},__getOrthoBoundingBox:function(sp,ep,sv,ev,offset){var spPlusOffset=_gliffy.Vec2.sum(sp,sv.clone().scale(offset)),epPlusOffset=_gliffy.Vec2.sum(ep,ev.clone().scale(offset)),lp,rp,lv,rv,lpPlusOffset,rpPlusOffset,boundingBox;if(sp.x<ep.x){lp=sp;rp=ep;lv=sv;rv=ev;lpPlusOffset=spPlusOffset;rpPlusOffset=epPlusOffset}else{lp=ep;rp=sp;lv=ev;rv=sv;lpPlusOffset=epPlusOffset;rpPlusOffset=spPlusOffset}if(lv.x===1&&(lpPlusOffset.x>rp.x)){lpPlusOffset.x=rp.x}if(rv.x===-1&&(rpPlusOffset.x<lp.x)){rpPlusOffset.x=lp.x}if(ev.y===-1&&(epPlusOffset.y<sp.y)){epPlusOffset.y=sp.y}if(sv.y===1&&(spPlusOffset.y>sp.y)){spPlusOffset.y=ep.y}boundingBox=_gliffy.BoundingBox();boundingBox.fit([sp.x,sp.y,spPlusOffset.x,spPlusOffset.y,ep.x,ep.y,epPlusOffset.x,epPlusOffset.y]);return boundingBox},__isZero:function(vec){return vec.x===vec.y&&vec.x===0},__getMidpoint:function(sp,ep){return _gliffy.Vec2.sum(sp,ep).scale(0.5)},__orthoLine:function(entry,rect,sp,ep){var line=[],i=0,pt,mp=rect.getCenter(),points={sp:sp,ep:ep,tl:rect.min,br:rect.max,tr:new _gliffy.Vec2(rect.max.x,rect.min.y),bl:new _gliffy.Vec2(rect.min.x,rect.max.y),cl:new _gliffy.Vec2(rect.min.x,mp.y),cr:new _gliffy.Vec2(rect.max.x,mp.y),tc:new _gliffy.Vec2(mp.x,rect.min.y),bc:new _gliffy.Vec2(mp.x,rect.max.y)};for(i=0;i<entry.length;i++){pt=points[entry[i]];line.push([pt.x,pt.y])}return line},__enumCardinalUnitVec:function(vec){if(vec.x===0&&vec.y===0){return 4}if(vec.y===-1){return 0}if(vec.x===1){return 1}if(vec.y===1){return 2}if(vec.x===-1){return 3}},__getZigZag:function(sp,ep,bVertical){var mid=this.__getMidpoint(sp,ep);if(bVertical){return[[sp.x,sp.y],[mid.x,sp.y],[mid.x,ep.y],[ep.x,ep.y]]}else{return[[sp.x,sp.y],[sp.x,mid.y],[ep.x,mid.y],[ep.x,ep.y]]}},__sign:function(num){if(num<0){return -1}if(num>0){return 1}return 0},__toCardinalUnit:function(vec){if(this.__isZero(vec)){return vec}vec.normalize();if(Math.abs(vec.x)>Math.abs(vec.y)){return new _gliffy.Vec2(this.__sign(vec.x),0)}else{return new _gliffy.Vec2(0,this.__sign(vec.y))}},__facingVectors:function(entry){var valid={"020":true,"013":true,"120":true,"131":true,"014":true,"141":true,"124":true,"024":true,"134":true,"043":true,"040":true,"140":true};return valid[entry]===true},computeBestPath:function(){var worldControlPath=this.__graphic.getWorldControlPath(),sp_=new _gliffy.Vec2(worldControlPath[0][0],worldControlPath[0][1]),ep_=new _gliffy.Vec2(worldControlPath[worldControlPath.length-1][0],worldControlPath[worldControlPath.length-1][1]),sv_=new _gliffy.Vec2(0,0),ev_=new _gliffy.Vec2(0,0),sc=this.getConnectionStart(),ec=this.getConnectionEnd(),shapeGraphic,p,q,r,sp,ep,sv,ev,swapped,rect,entry,path,strEntry,dims,distance,snapData,snapDegrees,xInterp,yInterp,i;if(sc){shapeGraphic=sc.node.getGraphic();sv_=sc.node.getConnectionVector(sc.index)}if(ec){shapeGraphic=ec.node.getGraphic();ev_=ec.node.getConnectionVector(ec.index)}sv_=this.__toCardinalUnit(sv_);ev_=this.__toCardinalUnit(ev_);if(this.__graphic.isOrtho()){swapped=false;if(sp_.y<ep_.y){sp=sp_;sv=sv_;ep=ep_;ev=ev_}else{sp=ep_;sv=ev_;ep=sp_;ev=sv_;swapped=true}rect=this.__getOrthoBoundingBox(sp,ep,sv,ev,this.__OFFSET);p=(sp.x<ep.x)?0:1;q=this.__enumCardinalUnitVec(sv);r=this.__enumCardinalUnitVec(ev);entry=this.__TABLE[p][q][r];if(entry===null){dims=rect.getDimension();path=this.__getZigZag(sp,ep,dims.x>dims.y);strEntry=(dims.x>dims.y)?"z0":"z1"}else{if(entry instanceof Array){path=this.__orthoLine(this.__TABLE[p][q][r],rect,sp,ep);strEntry=[p,q,r].join("")}else{path=this.__orthoLine(this.__TABLE[p][q][r].path1,rect,sp,ep);if(Math.abs(path[path.length-1][0]-path[0][0])>Math.abs(path[path.length-1][1]-path[0][1])){strEntry=[p,q,r].join("")}else{path=this.__orthoLine(this.__TABLE[p][q][r].path2,rect,sp,ep)}}}if((sc||ec)&&this.__facingVectors(strEntry)){distance=(_gliffy.Vec2.distance(ep,sp));if(distance>15){snapDegrees=_gliffy.Utils.SNAP_DEGREES_MULTIPLIER/distance;snapData=_gliffy.Utils.calculateLineSnap(ep,sp,snapDegrees);if(snapData.snapped){this.allowComputeBestPath=true;this.__previousWorldControlPath=this.__graphic.getWorldControlPath();path[path.length-1][0]=snapData.point.x;path[path.length-1][1]=snapData.point.y;xInterp=(path[path.length-1][0]-path[0][0])/(path.length-1);yInterp=(path[path.length-1][1]-path[0][1])/(path.length-1);for(i=1;i<path.length-1;i++){path[i][0]=path[0][0]+xInterp*i;path[i][1]=path[0][1]+yInterp*i}}}}if(swapped){path.reverse()}if(this.__previousWorldControlPath!==undefined&&this.__previousWorldControlPath!==null&&this.allowClearLocks){if(this.__previousWorldControlPath.length!==path.length){this.__lockSegments={}}else{for(i=0;i<this.__graphic.getSegmentCount();i++){if(this.__isHorizontal(this.__previousWorldControlPath[i],this.__previousWorldControlPath[i+1])!==this.__isHorizontal(path[i],path[i+1])){this.__lockSegments={};break}}}}for(i=0;i<worldControlPath.length-1;i++){if(this.isLockSegment(i)){if(this.isSegmentHorizontal(i)){if(path[i]&&path[i].length>1&&worldControlPath[i]&&worldControlPath[i].length>1){path[i][1]=worldControlPath[i][1]}if(path[i+1]&&path[i+1].length>1&&worldControlPath[i+1]&&worldControlPath[i+1].length>1){path[i+1][1]=worldControlPath[i+1][1]}}else{if(path[i]&&path[i].length>0&&worldControlPath[i]&&worldControlPath[i].length>0){path[i][0]=worldControlPath[i][0]}if(path[i+1]&&path[i+1].length>0&&worldControlPath[i+1]&&worldControlPath[i+1].length>0){path[i+1][0]=worldControlPath[i+1][0]}}}}}else{path=[[sp_.x,sp_.y],[ep_.x,ep_.y]]}if(this.allowComputeBestPath&&this.__previousWorldControlPath!==null){this.__previousWorldControlPath=path;this.__graphic.setWorldControlPath(path)}if(this.__previousWorldControlPath===null){if(this.__updateNum>0){this.__previousWorldControlPath=this.__graphic.getWorldControlPath()}this.__updateNum++}},hasChangedStartPoint:function(){var hasChanged=false;if(this.__previousStartPoint){if(!_gliffy.Utils.equalPoints(this.__previousStartPoint,this.__graphic.getWorldControlPath()[0],0.1)){hasChanged=true}}this.__previousStartPoint=[this.__graphic.getWorldControlPath()[0][0],this.__graphic.getWorldControlPath()[0][1]];return hasChanged},hasChangedEndPoint:function(){var hasChanged=false,worldPath=this.__graphic.getWorldControlPath();if(this.__previousEndPoint){if(!_gliffy.Utils.equalPoints(this.__previousEndPoint,worldPath[worldPath.length-1],0.1)){hasChanged=true}}this.__previousEndPoint=[worldPath[worldPath.length-1][0],worldPath[worldPath.length-1][1]];return hasChanged},__isHorizontal:function(startPoint,endPoint){if(startPoint&&endPoint){return Math.abs(startPoint[1]-endPoint[1])<0.001}else{return false}},getMagnitudeAndAxis:function(pos){var mag=1,axis="x",rot=null,points=this.__graphic.getControlPath();if(this.__graphic.isOrtho()){if(pos==="start"){axis=this.getSegmentAxis(0);mag=this.getSegmentMagnitude(0,axis)}else{axis=this.getSegmentAxis(points.length-2);mag=this.getSegmentMagnitude(points.length-2,axis)}return{mag:mag,axis:axis}}else{rot=this.__graphic.getNormalizedSegmentAngle(points[0],points[1]);if(rot>45&&rot<135){mag=1;axis="y"}else{if(rot>135&&rot<225){mag=-1;axis="x"}else{if(rot>225&&rot<315){mag=-1;axis="y"}}}}return{mag:mag,axis:axis}},getSegmentAxis:function(segment){return this.isSegmentHorizontal(segment)?"x":"y"},getSegmentMagnitude:function(segment,axis){var path=this.__graphic.getControlPath(),idx=(axis==="y")?1:0;if(path[segment][idx]<path[segment+1][idx]){return 1}else{return -1}},setOrthoMode:function(orthoMode){switch(orthoMode){case _gliffy.Editor.ORTHO_MODE.bezel:this.__graphic.setInterpolationType(_gliffy.Line.INTERPOLATION_TYPE.linear);this.__graphic.setCornerRadius(10);break;case _gliffy.Editor.ORTHO_MODE.curved:this.__graphic.setInterpolationType(_gliffy.Line.INTERPOLATION_TYPE.quadratic);this.__graphic.setCornerRadius(null);break;default:this.__graphic.setInterpolationType(_gliffy.Line.INTERPOLATION_TYPE.linear);this.__graphic.setCornerRadius(null);break}},getOrthoMode:function(){if(this.__graphic.getInterpolationType()===_gliffy.Line.INTERPOLATION_TYPE.quadratic){return _gliffy.Editor.ORTHO_MODE.curved}else{if(this.__graphic.getCornerRadius()){return _gliffy.Editor.ORTHO_MODE.bezel}else{return _gliffy.Editor.ORTHO_MODE.straight}}},__toObject:function(){return{lockSegments:this.__lockSegments}},__fromObject:function(obj){if(obj.lockSegments!==undefined){this.__lockSegments=obj.lockSegments;if(this.__lockSegments===null){this.__lockSegments={}}}}})}());(function(){_gliffy.EditableText=_gliffy.Editable.extend({__editMode:false,__focusNextFrame:false,__selectNextFrame:false,__setCursorEndNextFrame:false,__keyEvent:null,__dMode:false,__prevDragMode:"none",init:function(o){this._super(o);this.isEditable=true},setEditMode:function(bool){var $document=$(document),self=this;if(this.__editMode!==bool){if(bool){$document.unbind("focus.editableText");$document.unbind("blur.editableText");$("#gliffy-edit-text-container").show();this.__prevDragMode=_gliffy.Mouse.getState();_gliffy.KeyManager.setState("rte");_gliffy.Mouse.setState("rte");$document.bind("blur.editableText",function(){var rte=$("#gliffy-edit-text_ifr");if(rte.length>0&&tinyMCE.activeEditor&&self.getEditMode()){_gliffy.KeyManager.setState("rte")}});$document.bind("focus.editableText",function(){var rte=$("#gliffy-edit-text_ifr");if(rte.length>0){_gliffy.KeyManager.setLastState()}})}else{$("#gliffy-edit-text-container").hide();_gliffy.KeyManager.setState("stage");_gliffy.Mouse.setState(this.__prevDragMode!==null?this.__prevDragMode:"none");$document.unbind("focus.editableText");$document.unbind("blur.editableText")}this.__editMode=bool;this.__graphic.markDirty()}},applyTheme:function(o){var ed,options=$.extend({color:null,bold:null,italic:null,underline:null},o),anyOptions=false,displayCSS;$.each(options,function(key,value){if(value){anyOptions=true}return false});if(anyOptions){ed=tinymce.activeEditor;displayCSS="";if(_gliffy.BrowserDetect.browser!=="Chrome"){displayCSS=$("#gliffy-edit-text-container").css("display");$("#gliffy-edit-text-container").css({display:""})}ed.focus();ed.setContent(this.__graphic.getHTML());ed.selection.select(ed.getBody(),true);$.each(options,function(key,value){if(value!==null){if(key==="color"){ed.execCommand("ForeColorOn",false,value)}else{ed.formatter[value?"apply":"remove"](key)}}});this.__graphic.setHTML(ed.getContent());this.__graphic.markDirty();_gliffy.Utils.stealFocus();if(_gliffy.BrowserDetect.browser!=="Chrome"){$("#gliffy-edit-text-container").css({display:displayCSS})}}},getEditMode:function(){return this.__editMode},focus:function(){this.__focusNextFrame=true},setCursorEnd:function(){this.__setCursorEndNextFrame=true},setKeyEvent:function(event){this.__keyEvent=event},getKeyEvent:function(){return this.__keyEvent},select:function(){this.__selectNextFrame=true},shouldFocus:function(){return this.__focusNextFrame},shouldSelect:function(){return this.__selectNextFrame},shouldSetCursorEnd:function(){return this.__setCursorEndNextFrame},clearModifiers:function(){this.__focusNextFrame=false;this.__selectNextFrame=false;this.__setCursorEndNextFrame=false;this.__keyEvent=null},__checkDMode:function(content,callback){var self=this,hsv,interval,prevBg;if($(content).text()==="D!sco Gl!ffy"){if(self.__dMode){self.__dMode=false}else{hsv={hue:0,sat:100,val:100};self.__dMode=true;prevBg=self.__graphic.node.stage.background;interval=setInterval(function(){if(self.__dMode){hsv.hue=(hsv.hue+1)%360;self.__graphic.node.stage.background=_gliffy.Utils.hsv2rgb(hsv)}else{clearInterval(interval);self.__graphic.node.stage.background=prevBg}if(callback){callback()}},16)}}},registerBlurHandler:function(callback){var $placeholderText,myText,editDom=$("#gliffy-edit-text"),self=this,hasContent=true,isMultipart=(self.__graphic.node.getUidNode()&&self.__graphic.node.getUidNode().isMultipartShape());editDom.unbind();editDom.bind("customblur.gliffy-edit-text",function(event,options){var skipSaveToDocument,$content,hasUndo,checkHasUndo;hasUndo=tinyMCE.activeEditor.undoManager.hasUndo()===true;$(this).unbind(event);if(options===undefined){options={}}skipSaveToDocument=options.skipSaveToDocument===true;checkHasUndo=options.checkHasUndo===true;$content=$("<div>").append(tinymce.activeEditor.getContent()).appendTo("body");$placeholderText=$content.find(".gliffy-placeholder-text");if($placeholderText.length>0){if(isMultipart){myText=self.__graphic.getHTML();if(myText===$content.html()){hasContent=false}else{$placeholderText.removeClass("gliffy-placeholder-text")}}else{$placeholderText.removeClass("gliffy-placeholder-text")}}else{$placeholderText.removeClass("gliffy-placeholder-text")}if(hasContent){hasContent=_gliffy.Utils.hasNonWhitespaceCharacter($content.text())}$content.detach();tinymce.activeEditor.setContent("");tinyMCE.activeEditor.undoManager.clear();$(window).trigger({type:"rte-remove.gliffy-edit-text",node:$("#gliffy-edit-text_ifr").data("node")});_gliffy.Utils.stealFocus();$("#gliffy-edit-text_container").css("display","none");self.setEditMode(false);self.__graphic.node.stage.commandHistory.forceFinalizeCommandBundle();self.__graphic.markDirty();if((hasContent||isMultipart)&&!(skipSaveToDocument)){self.__graphic.node.setFlag("bounds");if(!checkHasUndo||hasUndo){if($content.find(".gliffy-placeholder-text").length===0){self.__graphic.node.stage.commandHistory.addAndExecuteCommand(new _gliffy.SetTextCommand({node:self.__graphic.node,text:_gliffy.Utils.removeLineBreaks($content.html())}))}}}else{if(!isMultipart){self.__graphic.node.stage.commandHistory.addAndExecuteCommand(new _gliffy.RemoveNodeCommand({node:self.__graphic.node}))}}if(callback){callback()}})}})}());(function(){_gliffy._ConnectionPointPattern=_gliffy.Class.extend({patterns:{Midpoint:[{pos:{x:0.5,y:0},vec:{x:0,y:-1}},{pos:{x:0,y:0.5},vec:{x:-1,y:0}},{pos:{x:1,y:0.5},vec:{x:1,y:0}},{pos:{x:0.5,y:1},vec:{x:0,y:1}}],Center:[{pos:{x:0.5,y:0.5},vec:[{x:0,y:0}]}]},computePolyPoints:function(polygonSides){var halfAngle=Math.PI/polygonSides;var angle=2*halfAngle;var radius=0.5/Math.cos(halfAngle);var points=[];for(var i=0;i<polygonSides;i++){points.push(new _gliffy.Vec2(Math.cos(i*angle)*radius,Math.sin(i*angle)*radius))}var transform=new _gliffy.AffineTransform();if((polygonSides&1)==1){transform.rotate(-Math.PI/2,0.5,0.5)}else{transform.rotate(halfAngle-Math.PI/2,0.5,0.5)}var transformedPointsX=[];var transformedPointsY=[];for(var i=0;i<points.length;i++){var transformed=transform.transformPoint(points[i].x,points[i].y);transformedPointsX.push(transformed.x);transformedPointsY.push(transformed.y)}var transformedPoints=[];var maxPoint=new _gliffy.Vec2(_gliffy.Utils.maxInArray(transformedPointsX),_gliffy.Utils.maxInArray(transformedPointsY));var minPoint=new _gliffy.Vec2(_gliffy.Utils.minInArray(transformedPointsX),_gliffy.Utils.minInArray(transformedPointsY));for(var i=0;i<transformedPointsX.length&&i<transformedPointsY.length;i++){var x=_gliffy.Utils.convertRanges(transformedPointsX[i],minPoint.x,maxPoint.x,0,1);var y=_gliffy.Utils.convertRanges(transformedPointsY[i],minPoint.y,maxPoint.y,0,1);transformedPoints.push(new _gliffy.Vec2(x,y))}return transformedPoints},createPolyPattern:function(name,numSides){var almostPoint5=function(vec2){return vec2.x>0.49999999&&vec2.x<0.50000001&&vec2.y>0.49999999&&vec2.y<0.50000001};var points=this.computePolyPoints(numSides);this.patterns[name]=[];for(var i=0;i<points.length;i++){var vec=new _gliffy.Vec2(0,0);var point=points[i];if(!almostPoint5(point)){vec.x=point.x-0.5;vec.y=point.y-0.5;vec=vec.normalize()}this.patterns[name].push({pos:point,vec:vec})}},init:function(o){this.createPolyPattern("Triangle",3);this.createPolyPattern("Pentagon",5);this.createPolyPattern("Hexagon",6);this.createPolyPattern("Octagon",8);this.patterns.LeftRight=[$.extend(true,{},this.patterns.Midpoint[1]),$.extend(true,{},this.patterns.Midpoint[2])];this.createPolyPattern("RightTriangle",4);this.patterns.RightTriangle=this.patterns.RightTriangle.slice(1,4);this.patterns.LeftMidpoint=[$.extend(true,{},this.patterns.Midpoint[1])];this.patterns.TopMidpoint=[$.extend(true,{},this.patterns.Midpoint[0])];this.patterns.BottomMidpoint=[$.extend(true,{},this.patterns.Midpoint[3])];this.createPolyPattern("FourCorners",4);this.patterns.InvertedTriangle=[$.extend(true,{},this.patterns.FourCorners[0]),$.extend(true,{},this.patterns.FourCorners[3]),$.extend(true,{},this.patterns.Midpoint[0]),$.extend(true,{},this.patterns.Midpoint[3])]}});_gliffy.ConnectionPointPattern=new _gliffy._ConnectionPointPattern()})();(function(){var PIXEL_SNAP_OFFSET=0.5;_gliffy.Grid=_gliffy.Class.extend({__documentManager:null,__buffer:null,majorColor:"#ebebff",minorColor:"#f6f7fd",__prevZoom:null,__prevMajorColor:null,__prevMinorColor:null,__prevSpacing:null,__enabled:true,spacing:10,init:function(options){var self=this;this.__documentManager=options.documentManager;this.__buffer=document.createElement("canvas");this.spacing=options.spacing||this.spacing;this.majorColor=options.majorColor||this.majorColor;this.minorColor=options.minorColor||this.minorColor;_gliffy.RenderLoop.appendTask(function(){self.__draw()})},setEnabled:function(enabled){this.__enabled=enabled;if(!this.__enabled&&this.__documentManager.target!==null){this.__documentManager.target.find(".gliffy-stage").css({backgroundImage:""});this.__prevZoom=null}},__isDirty:function(){return this.__documentManager.getZoom()!==this.__prevZoom||this.majorColor!==this.__prevMajorColor||this.minorColor!==this.__prevMinorColor||this.spacing!==this.__prevSpacing},__markClean:function(){this.__prevZoom=this.__documentManager.getZoom();this.__prevMajorColor=this.majorColor;this.__prevMinorColor=this.minorColor;this.__prevSpacing=this.spacing},__draw:function(){var zoom,ctx,spacing,size,imageData,stage;if(this.__enabled&&this.__isDirty()&&$(".gliffy-stage").length>0){zoom=this.__documentManager.getZoom();ctx=this.__buffer.getContext("2d");spacing=zoom*this.spacing;size=spacing*2;this.__buffer.width=size;this.__buffer.height=size;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(PIXEL_SNAP_OFFSET,0);ctx.lineTo(PIXEL_SNAP_OFFSET,size);ctx.moveTo(0,PIXEL_SNAP_OFFSET);ctx.lineTo(size,PIXEL_SNAP_OFFSET);ctx.strokeStyle=this.majorColor;ctx.stroke();ctx.closePath();ctx.beginPath();ctx.moveTo(PIXEL_SNAP_OFFSET+spacing,0);ctx.lineTo(PIXEL_SNAP_OFFSET+spacing,size);ctx.moveTo(0,PIXEL_SNAP_OFFSET+spacing);ctx.lineTo(size,PIXEL_SNAP_OFFSET+spacing);ctx.strokeStyle=this.minorColor;ctx.stroke();ctx.closePath();imageData="url("+this.__buffer.toDataURL()+")";if(this.__documentManager.target){this.__documentManager.target.find(".gliffy-stage").css({backgroundImage:imageData})}this.__markClean()}}})}());(function(){var PAGE_BREAKS_COLOR,DASH_ARRAY,LINE_WIDTH,PIXEL_SNAP_OFFSET;PIXEL_SNAP_OFFSET=0;LINE_WIDTH=4;DASH_ARRAY=[5,5];PAGE_BREAKS_COLOR="#91AACA";_gliffy.PageBreaks=_gliffy.Class.extend({__documentManager:null,__canvas:null,container:null,__prevZoom:null,__enabled:false,__prevEnabled:false,init:function(options){this.__documentManager=options.documentManager;this.__canvas=document.createElement("canvas");this.container=$("<div>",{id:"gliffy-stage-overlay-page-breaks"});$(".gliffy-stage").append(this.container);_gliffy.RenderLoop.appendTask($.proxy(this.renderIfDirty,this))},setEnabled:function(enabled){this.__enabled=enabled},__isDirty:function(){return this.__documentManager.getZoom()!==this.__prevZoom||this.__enabled!==this.__prevEnabled||this.__dirty},__markClean:function(){this.__prevZoom=this.__documentManager.getZoom();this.__prevEnabled=this.__enabled;this.__dirty=false},markDirty:function(){this.__dirty=true},__draw:function(){var browser,ctx,ie9,imageData,printController,width,height,start,end,zoom,zoomAcceptable;zoom=this.__documentManager.getZoom();browser=_gliffy.BrowserDetect;ie9=browser.browser==="Explorer"&&browser.version===9;zoomAcceptable=(ie9&&zoom<=1)||(!ie9&&zoom<=4);if(this.__enabled&&zoomAcceptable){ctx=this.__canvas.getContext("2d");printController=GliffyApp.printController;width=printController.get("dimension").x*printController.get("gliffyNormalizedPixelsPerUnit")*zoom;height=printController.get("dimension").y*printController.get("gliffyNormalizedPixelsPerUnit")*zoom;this.__canvas.width=width;this.__canvas.height=height;ctx.clearRect(0,0,width,height);ctx.lineWidth=LINE_WIDTH;ctx.dasharray=DASH_ARRAY;ctx.beginPath();delete ctx.dashinfo;start={x:width-PIXEL_SNAP_OFFSET,y:PIXEL_SNAP_OFFSET};end={x:width-PIXEL_SNAP_OFFSET,y:height-PIXEL_SNAP_OFFSET};_gliffy.candash.lineTo(start,end,ctx);start={x:width-PIXEL_SNAP_OFFSET,y:height-PIXEL_SNAP_OFFSET};end={x:PIXEL_SNAP_OFFSET,y:height-PIXEL_SNAP_OFFSET};_gliffy.candash.lineTo(start,end,ctx);ctx.strokeStyle=PAGE_BREAKS_COLOR;ctx.stroke();ctx.closePath();imageData="url("+this.__canvas.toDataURL()+")";this.container.css({backgroundImage:imageData})}else{this.container.css({backgroundImage:""})}this.__markClean()},renderIfDirty:function(){if(this.__isDirty()){this.__draw()}}})}());(function(){_gliffy.AbstractStyle=_gliffy.Serializable.extend({__toObject:function(object){if(this._serialize){return{}}else{return null}},__fromObject:function(object){return this}});_gliffy.LineStyle=_gliffy.AbstractStyle.extend({strokeWidth:2,stroke:"#000000",fill:null,dashStyle:null,startArrow:0,endArrow:0,orthoMode:1,__fromObject:function(object){if(object.fill){this.fill=object.fill}if(object.stroke){this.stroke=object.stroke}if(object.strokeWidth){this.strokeWidth=object.strokeWidth}if(object.dashStyle!==undefined){this.dashStyle=object.dashStyle}if(object.startArrow){this.startArrow=object.startArrow}if(object.endArrow){this.endArrow=object.endArrow}if(object.orthoMode!==undefined&&object.orthoMode!==null){this.orthoMode=object.orthoMode}return this},fromTheme:function(theme){var translate={fill:"fillColor",stroke:"strokeColor",strokeWidth:"strokeWidth"},self=this;$.each(translate,function(key,value){if(theme[value]){self[key]=theme[value]}});if(this.startArrow!==0){this.startArrow=theme.arrowType}if(this.endArrow!==0){this.endArrow=theme.arrowType}if(theme.interpolationType==="linear"){if(theme.cornerRadius===0){this.orthoMode=0}else{this.orthoMode=1}}else{if(theme.interpolationType==="quadratic"){this.orthoMode=2}}return this}});_gliffy.ShapeStyle=_gliffy.AbstractStyle.extend({fill:"#D1D1D1",stroke:"#000000",strokeWidth:2,dashStyle:null,gradient:false,shadow:false,opacity:1,__fromObject:function(object){if(object.fill){this.fill=object.fill}if(object.stroke){this.stroke=object.stroke}if(object.stroke_width!==undefined){this.strokeWidth=object.stroke_width}if(object.strokeWidth!==undefined&&object.strokeWidth!==null&&object.strokeWidth!=="null"){this.strokeWidth=object.strokeWidth}if(object.dashStyle){this.dashStyle=object.dashStyle}else{if(typeof object.stroke_dasharray){this.dashStyle=object.stroke_dasharray}}if(object.gradient){this.gradient=object.gradient}if(object.shadow){this.shadow=object.shadow}if(object.opacity){this.opacity=object.opacity}return this},fromTheme:function(theme){var translate={fill:"fillColor",stroke:"strokeColor",strokeWidth:"strokeWidth",gradient:"gradient",shadow:"dropShadow"},self=this;$.each(translate,function(key,value){if(theme[value]){self[key]=theme[value]}});return this}});_gliffy.TextStyle=_gliffy.AbstractStyle.extend({bold:false,italic:false,underline:false,face:"Arial",size:"12px",color:"#000000",__fromObject:function(object){if(object.bold){this.bold=object.bold}if(object.italic){this.italic=object.italic}if(object.underline){this.underline=object.underline}if(object.face){this.face=object.face}if(object.size){this.size=object.size}if(object.color){this.color=object.color}},fromTheme:function(theme){var copy=["color","bold","italic","underline"],i,attr;for(i=0;i<copy.length;i++){attr=copy[i];if(theme[attr]){this[attr]=theme[attr]}}return this}})}());(function(){_gliffy._ShapeLinker=_gliffy.Class.extend({_editor:null,init:function(o){this._editor=o.editor},linkNavCallback:function(value,linkText,oldLinkText,shapeNode,hideIcon){var linkNode,linkGraphic,existingLinkNodes;if(shapeNode&&shapeNode.getGraphic()){_gliffy.Utils.analyticsEvent("trackEvent",{category:"link",action:"addToShape"});linkNode=new _gliffy.Node();linkGraphic=new _gliffy.Link();linkGraphic.setHref(value);linkGraphic.setRenderIcon(!hideIcon);linkNode.setGraphic(linkGraphic);existingLinkNodes=shapeNode.findGraphic(_gliffy.Link);_gliffy.ShapeLinker._editor.getDocumentManager().pushCommandBundle();if(existingLinkNodes.length>0){_gliffy.ShapeLinker._editor.getDocumentManager().addAndExecuteCommand(new _gliffy.RemoveNodeCommand({node:existingLinkNodes[0],markParentDirty:true}))}_gliffy.ShapeLinker._editor.getDocumentManager().addAndExecuteCommand(new _gliffy.AddNodeCommand({node:linkNode,target:shapeNode,markParentDirty:true}));_gliffy.ShapeLinker._editor.getDocumentManager().popCommandBundle();_gliffy.ShapeLinker._editor.getDocumentManager().redraw();GliffyApp.linkHudController.show({node:linkNode})}},setEditor:function(editor){this._editor=editor}})}());(function(){_gliffy.PanelDrag=_gliffy.Class.extend({registerPanelDrag:function(modeName,selector,callback){var $this,panelPlaceholder,panelWidth,panelHeight,panelBounds,left,top,containerHeight,spacer,places,panel,panelIndex,sidebar,sidebarHeight,sidebarOffset,calculatePlaces,positionPlaceholder,scroll,scrollTimeout;calculatePlaces=function(){places=[];$(selector).find(".gliffy-accordion-group").each(function(){places.push({top:$(this).offset().top,elem:$(this)})})};positionPlaceholder=function(event){left=Math.min(Math.max(event.pageX-10,0),panelBounds.left);top=Math.min(Math.max(event.pageY-panelHeight/2,panelBounds.top),panelBounds.top+containerHeight);panelPlaceholder.css({position:"absolute",left:left+"px",top:top+"px"})};_gliffy.Mouse.registerDragState([{modes:[modeName],dragStart:function(event){var panelTemplate,panelHTML;$this=$(event.currentTarget);spacer=$("<div/>",{"class":"gliffy-panel-spacer"});panelTemplate=Handlebars.compile($("#gliffy-panel-drag-placeholder").html());panelHTML=panelTemplate($.extend({title:$this.closest(".accordion-heading").find(".accordion-toggle").text()}));panelPlaceholder=$(panelHTML);panel=$this.closest(".gliffy-accordion-group");panelPlaceholder.css("width",panel.width());spacer.insertBefore(panel);panel=panel.detach();panelWidth=panelPlaceholder.width();panelHeight=panelPlaceholder.height();panelBounds=$(selector).offset();containerHeight=$(selector).height();sidebar=$(selector);sidebarHeight=sidebar.height();sidebarOffset=sidebar.offset();calculatePlaces();positionPlaceholder(event);$("#gliffy").append(panelPlaceholder);_gliffy.Mouse.lockDragUI("move")},drag:function(event){var threshold=50;panelIndex=0;positionPlaceholder(event);if(places.length>0){spacer.remove();for(panelIndex=0;panelIndex<places.length;panelIndex++){if(top<places[panelIndex].top){spacer.insertBefore(places[panelIndex].elem);break}}if(panelIndex===places.length){spacer.insertAfter(places[places.length-1].elem)}}scroll=sidebar.scrollTop();if(event.pageY<sidebarOffset.top+threshold){clearTimeout(scrollTimeout);scrollTimeout=setTimeout(function(){sidebar.scrollTop(scroll-10);calculatePlaces();if(scroll!==sidebar.scrollTop()){_gliffy.Mouse.__mousemove(event)}},25)}else{if(event.pageY>sidebarOffset.top+sidebarHeight-threshold){clearTimeout(scrollTimeout);scrollTimeout=setTimeout(function(){sidebar.scrollTop(scroll+10);calculatePlaces();if(scroll!==sidebar.scrollTop()){_gliffy.Mouse.__mousemove(event)}},25)}else{clearTimeout(scrollTimeout)}}},dragEnd:function(){spacer.replaceWith(panel);panelPlaceholder.remove();spacer.remove();if(callback){callback(panel,panelIndex)}}}])}})}());(function(){_gliffy._LayersContextMenu=_gliffy.Class.extend({_contextMenuDescriptor:null,_layersArray:null,_activeNode:null,init:function(){this._contextMenuDescriptor=[];this._layersArray=[];this._contextMenuDescriptor.push({text:$.i18n._("SEND_TO"),className:"gliffy-layers-context-send-to",subMenu:this.constructSendToMenu(8)})},getSendToLayerFunction:function(val){return function(){_gliffy.Utils.analyticsEvent("trackEvent",{category:"layers",action:"sendToLayer"});GliffyApp.layersController.sendToLayer(this._layersArray[val],this._activeNode)}},constructSendToMenu:function(maxPerLevel){var sendToSubMenu=[],numThisLevel=maxPerLevel-2,i;sendToSubMenu.push({text:$.i18n._("FRONT"),className:"gliffy-layers-context-front",action:function(){_gliffy.Utils.analyticsEvent("trackEvent",{category:"layers",action:"toBack"});GliffyApp.toolbarController.doBringToFront()}});sendToSubMenu.push({text:$.i18n._("BACK"),className:"gliffy-layers-context-back",action:function(){_gliffy.Utils.analyticsEvent("trackEvent",{category:"layers",action:"toFront"});GliffyApp.toolbarController.doSendToBack()}});sendToSubMenu.push({divider:true,className:"gliffy-front-back-divider"});for(i=0;i<numThisLevel;i++){sendToSubMenu.push({text:"Layer"+i,className:"gliffy-layers-context-"+i,action:$.proxy(this.getSendToLayerFunction(i),this)})}sendToSubMenu.push({text:"More",className:"gliffy-layers-context-more-"+i,subMenu:this.constructSendToMenuRecursive(i,_gliffy.Layer.MAX_LAYERS,6)});return sendToSubMenu},constructSendToMenuRecursive:function(startIdx,endIdx,maxPerLevel){var subMenu=[],i;for(i=startIdx;i<endIdx&&i<startIdx+maxPerLevel;i++){subMenu.push({text:"Layer"+i,className:"gliffy-layers-context-"+i,action:$.proxy(this.getSendToLayerFunction(i),this)})}if(i<endIdx){subMenu.push({text:"More",className:"gliffy-layers-context-more-"+i,subMenu:this.constructSendToMenuRecursive(i,endIdx,maxPerLevel)})}return subMenu},getContextMenuDescriptor:function(){return this._contextMenuDescriptor},beforeContextShow:function($menu,layersArray,activeNode){var i,numLayersToShow=layersArray.length,activeLayers,firstLayer,$back,$front,$divider;if(numLayersToShow===1){$menu.find(".gliffy-layers-context-send-to").hide();if(activeNode){$menu.find(".gliffy-context-menu-item-sendToFront,.gliffy-context-menu-item-sendToBack").show()}else{$menu.find(".gliffy-context-menu-item-sendToFront,.gliffy-context-menu-item-sendToBack").hide()}}else{if(!activeNode){$menu.find(".gliffy-layers-context-send-to").hide()}else{$menu.find(".gliffy-layers-context-send-to").show();$menu.find(".gliffy-context-menu-item-sendToFront,.gliffy-context-menu-item-sendToBack").hide();for(i=0;i<_gliffy.Layer.MAX_LAYERS;i++){if(i<numLayersToShow){$menu.find(".gliffy-layers-context-"+i).show();$menu.find(".gliffy-layers-context-more-"+i).show();$menu.find(".gliffy-layers-context-"+i).find("a").text(layersArray[i].getName())}else{$menu.find(".gliffy-layers-context-"+i).hide();$menu.find(".gliffy-layers-context-more-"+i).hide()}}$back=$menu.find(".gliffy-layers-context-back");$front=$menu.find(".gliffy-layers-context-front");$divider=$menu.find(".gliffy-front-back-divider");activeLayers=activeNode.getActiveLayers();if(activeLayers.length>1){$back.hide();$front.hide();$divider.hide()}else{$back.show();$front.show();$divider.show();firstLayer=_.first(activeLayers);if((layersArray.length>1)&&firstLayer){$back.find("a").text($.i18n._("BACK_OF")+" "+firstLayer.getName());$front.find("a").text($.i18n._("FRONT_OF")+" "+firstLayer.getName())}else{$back.find("a").text($.i18n._("BACK"));$front.find("a").text($.i18n._("FRONT"))}}}}this._layersArray=layersArray;this._activeNode=activeNode}})}());(function(){_gliffy.Command=_gliffy.Serializable.extend({action:"base_action",init:function(){throw new Error("init for command is not implemented")},execute:function(){throw new Error("execute for command is not implemented")},toString:function(){return JSON.stringify(this.toObject())},shortToString:function(){return this.action},__toObject:function(){return{action:this.action}},__fromObject:function(){}})}());(function(){_gliffy.UndoableCommand=_gliffy.Command.extend({undo:function(){throw new Error("undo is not implemented")}})}());(function(){_gliffy.CollapsibleCommand=_gliffy.UndoableCommand.extend({collapse:function(){throw new Error("collapse is not implemented")}})}());(function(){_gliffy.AddNodeCommand=_gliffy.CollapsibleCommand.extend({action:"add_node",node:null,target:null,textCollapse:false,init:function(o){var options=$.extend({node:null,target:null,prepend:false,markParentDirty:false},o);this.node=options.node;this.nodeObject=this.node.toObject();this.targetId=options.target?options.target.getId():null;this.prepend=options.prepend;this.textCollapse=false;this.markParentDirty=o.markParentDirty;if(!this.node){throw new Error("Node must be defined")}if(this.node.isProxy()){this.node.getGraphic().activate(this)}},execute:function(stage){var node=this.nodeObject.id!==null?new _gliffy.Node().fromObject(this.nodeObject):this.node,target,i,nodeObject;if(node.isMindmap()){node.findGraphic(_gliffy.Mindmap)[0].getGraphic().addNode(stage)}node.setToActiveLayer(stage);if(this.targetId===null){if(this.prepend){stage.prependNode(node)}else{stage.appendNode(node)}node.setToActiveLayer(stage)}else{target=stage.find(this.targetId);if(this.prepend){target.prependChild(node)}else{target.appendChild(node)}if(this.markParentDirty){target.markDirty()}}this.nodeId=node.getId();this.updateNodeObject(node);node.markDirty();if(node.getGraphic()){node.getGraphic().markDirty()}},undo:function(stage){var node=stage.find(this.nodeObject.id),targetNode;if(node){if(node.isMindmap()){node.findGraphic(_gliffy.Mindmap)[0].getGraphic().removeNode()}_gliffy.Tree.remove(node,true);if(this.targetId===null){this.updateNodeObject(node);stage.removeNode(node)}else{targetNode=stage.find(this.targetId);targetNode.removeChild(node);if(this.markParentDirty){targetNode.markDirty()}}}else{stage.commandHistory.undoCommand(stage);stage.commandHistory.removeCommand(this)}},updateNodeObject:function(node){var nodeObject=node.toObject();if(nodeObject){this.nodeObject=nodeObject}else{this.nodeObject.id=this.nodeId}},collapse:function(command,stage){if(this.nodeId===command.nodeId&&this.nodeObject.uid!=="com.gliffy.shape.basic.basic_v1.default.text"){if(command instanceof _gliffy.MoveNodeCommand){this.nodeObject.x=command.x;this.nodeObject.y=command.y;return true}else{if(command instanceof _gliffy.SetScaleCommand){this.nodeObject.scaleX=command.scaleX;this.nodeObject.scaleY=command.scaleY;this.nodeObject.x=command.x;this.nodeObject.y=command.y;return true}else{if(command instanceof _gliffy.SetWidthAndHeightCommand){this.nodeObject.width=command.width;this.nodeObject.height=command.height;return true}else{if(command instanceof _gliffy.SetTextCommand&&!this.textCollapse){this.nodeObject.graphic.Text.html=command.text;this.textCollapse=true;return true}else{if(command instanceof _gliffy.RemoveNodeCommand){stage.commandHistory.removeCommand(this);return true}}}}}}return false},__toObject:function(){return{action:this.action,nodeObject:this.nodeObject,targetId:this.targetId,prepend:this.prepend,textCollapse:this.textCollapse}}})}());(function(){_gliffy.AddCopyNodeCommand=_gliffy.CollapsibleCommand.extend({action:"add_copy_node",node:null,textCollapse:false,init:function(o){var options=$.extend({node:null},o);this.node=options.node;this.firstExecute=true;this.nodeObject=this.node.toObject();this.actionList=[];this.textCollapse=false;this.nodeObjectIsCopiedSelection=false;if(!this.node){throw new Error("Node must be defined")}},execute:function(stage){var node=this.firstExecute?this.node:new _gliffy.Node().fromObject(this.nodeObject),i;if(node.isMindmap()){node.findGraphic(_gliffy.Mindmap)[0].getGraphic().addNode(stage)}node.setLayerId(stage.getTopmostActiveLayer().guid);if(this.firstExecute){stage.appendCopyNode(node);if(this.actionList.length>0){for(i=0;i<this.actionList.length;i++){this.actionList[i](node)}node.getGraphic().editable.computeBestPath()}this.nodeId=node.getId();this.nodeObject=node.toObject();this.firstExecute=false}else{stage.appendNode(node);node.update()}if(node.isCopiedSelection()){this.nodeObjectIsCopiedSelection=true}node.markDirty()},undo:function(stage){var node=stage.find(this.nodeObject.id);if(node){this.nodeObject=node.toObject();new _gliffy.RemoveNodeCommand({node:node}).execute(stage)}if(this.nodeObjectIsCopiedSelection&&this.nodeObject.children){_.each(this.nodeObject.children,function(childNodeObject){var childNode=stage.find(childNodeObject.id);if(childNode){new _gliffy.RemoveNodeCommand({node:childNode}).execute(stage)}})}},collapse:function(command,stage){if(this.nodeId===command.nodeId&&this.nodeObject.uid!=="com.gliffy.shape.basic.basic_v1.default.text"){if(command instanceof _gliffy.MoveNodeCommand){this.nodeObject.x=command.x;this.nodeObject.y=command.y;return true}else{if(command instanceof _gliffy.SetScaleCommand){this.nodeObject.scaleX=command.scaleX;this.nodeObject.scaleY=command.scaleY;this.nodeObject.x=command.x;this.nodeObject.y=command.y;return true}else{if(command instanceof _gliffy.SetWidthAndHeightCommand){this.nodeObject.width=command.width;this.nodeObject.height=command.height;return true}else{if(command instanceof _gliffy.SetTextCommand&&!this.textCollapse){this.nodeObject.graphic.Text.html=command.text;this.textCollapse=true;return true}else{if(command instanceof _gliffy.RemoveNodeCommand){stage.commandHistory.removeCommand(this);return true}}}}}}return false},__toObject:function(){return{action:this.action,nodeObject:this.nodeObject,firstExecute:this.firstExecute,actionList:this.actionList,textCollapse:this.textCollapse}}})}());(function(){_gliffy.CopyCommand=_gliffy.Command.extend({action:"copy",nodeObject:null,transformCopy:null,embeddedResources:null,init:function(o){var i,svg,id,options=$.extend({node:null,transformCopy:null,embeddedResources:null},o);this.nodeObject=options.node.toObject();this.transformCopy=options.transformCopy;svg=options.node.findGraphic(_gliffy.Svg);if(options.embeddedResources&&svg.length>0){this.embeddedResourceMap={};for(i=0;i<svg.length;i++){id=svg[i].getGraphic().getEmbeddedResourceId();this.embeddedResourceMap[id]=options.embeddedResources.getResource(id).toObject()}}},execute:function(stage){stage.commandHistory.setClipboard(this)},__toObject:function(){return{action:this.action,nodeObject:this.nodeObject,transformCopy:this.transformCopy,embeddedResources:this.embeddedResources}}})}());(function(){_gliffy.CutCommand=_gliffy.UndoableCommand.extend({action:"cut",init:function(o){var i,svg,id,options=$.extend({node:null,embeddedResource:null},o);this.nodeId=options.node.getId();this.nodeObject=options.node.toObject();this.removeNodeCommands=[];svg=options.node.findGraphic(_gliffy.Svg);if(options.embeddedResources&&svg.length>0){this.embeddedResourceMap={};for(i=0;i<svg.length;i++){id=svg[i].getGraphic().getEmbeddedResourceId();this.embeddedResourceMap[id]=options.embeddedResources.getResource(id).toObject()}}},execute:function(stage){var overlayManager=_gliffy.Mouse.editor.overlayManager,node,children,i;stage.commandHistory.setClipboard(this);if(this.removeNodeCommands.length===0){node=stage.find(this.nodeId);if(node.isSelection()){children=[].concat(node.children);overlayManager.deselectAll();for(i=0;i<children.length;i++){this.removeNodeCommands.push(new _gliffy.RemoveNodeCommand({node:children[i]}))}}else{this.removeNodeCommands.push(new _gliffy.RemoveNodeCommand({node:node}))}}for(i=0;i<this.removeNodeCommands.length;i++){this.removeNodeCommands[i].execute(stage)}overlayManager.deselectAll()},undo:function(stage){var i;for(i=0;i<this.removeNodeCommands.length;i++){this.removeNodeCommands[i].undo(stage)}},__toObject:function(){return{action:this.action,nodeObject:this.nodeObject}}})}());(function(){_gliffy.GroupCommand=_gliffy.UndoableCommand.extend({action:"group",init:function(o){var i,options=$.extend({selectedNodeIds:[],node:null},o);this.selectedNodeIds=[];if(options.node&&options.node.isSelection()){for(i=0;i<options.node.children.length;i++){this.selectedNodeIds.push(options.node.children[i].getId())}this.groupNodeId=options.node.getId()}else{this.selectedNodeIds=options.selectedNodeIds}},_getChildLayerGuids:function(node){var childLayerGuids=[];if(node.children){childLayerGuids=_.map(node.children,function(child){return child.getLayerId()})}return childLayerGuids},_getChildLayerMap:function(node){var map={};if(node.children){_.each(node.children,function(child){map[child.getId()]=child.getLayerId()})}return map},_getTopmostLayer:function(layers,childLayerGuids){var topmostLayer;childLayerGuids=_.unique(childLayerGuids);layers=_.filter(layers,function(layer){return _.contains(childLayerGuids,layer.guid)});topmostLayer=_.max(layers,function(layer){return layer.getOrder()});return topmostLayer},_clearChildLayers:function(node){if(node.children){_.each(node.children,function(child){child.setLayerId(null)})}},_reorderNodesIfNecessary:function(stage,groupNode){var childLayerGuids=this._getChildLayerGuids(groupNode),topmost,needsReorder;this.childLayerMap=this._getChildLayerMap(groupNode);topmost=this._getTopmostLayer(stage.getLayers(),childLayerGuids);this._clearChildLayers(groupNode);groupNode.setLayerId(topmost.guid);groupNode.applyBestOrder();if(_.unique(childLayerGuids).length>1){new _gliffy.ReorderNodesCommand({node:null}).execute(stage)}$(window).trigger("gliffy-group-reorder",[groupNode])},execute:function(stage){var groupNode=new _gliffy.Node(),i=0,node,nodes=[];if(this.groupNodeId&&stage.find(this.groupNodeId)){groupNode=stage.find(this.groupNodeId);groupNode.setUid("com.gliffy.shape.basic.basic_v1.default.group");groupNode.setOrder(groupNode.getId());this._reorderNodesIfNecessary(stage,groupNode)}else{if(this.groupNodeId){groupNode.setId(this.groupNodeId);groupNode.setOrder(groupNode.getId())}groupNode.setUid("com.gliffy.shape.basic.basic_v1.default.group");stage.appendNode(groupNode);for(i=0;i<this.selectedNodeIds.length;i++){node=stage.find(this.selectedNodeIds[i]);nodes.push(node)}stage.attachSelectionToGroup(groupNode,nodes);this._reorderNodesIfNecessary(stage,groupNode);this.groupNodeId=groupNode.getId()}groupNode.markDirty()},undo:function(stage){var parentNode=stage.find(this.groupNodeId);stage.detachSelectionFromGroup(parentNode,this.childLayerMap);if(_.size(this.childLayerMap)>1){new _gliffy.ReorderNodesCommand({node:null}).execute(stage)}new _gliffy.RemoveNodeCommand({node:parentNode}).execute(stage)},__toObject:function(){return{action:this.action,selectedNodeIds:this.selectedNodeIds}}})}());(function(){_gliffy.PasteCommand=_gliffy.UndoableCommand.extend({action:"paste",offset:10,nodeId:null,nodeObject:null,init:function(o){var options=$.extend({offset:10,selectedNode:null},o);this.offset=options.offset;this.selectedNodeId=(options.selectedNode)?options.selectedNode.getId():null},__updateStaticPosition:function(stage,node,x,y){var nodePositionX,nodePositionY;if(this.position.x<0||this.position.y<0){this.__setNodePosition(stage,node,x+this.offset,y+this.offset);node.update();return node.worldTransform.clone()}else{if(node.isLine()){this.__setLineNodePosition(stage,node)}else{nodePositionX=(this.position.x-(node.getWidth()/2));nodePositionY=(this.position.y-(node.getHeight()/2));this.__setNodePosition(stage,node,nodePositionX,nodePositionY)}return null}},__setNodePosition:function(stage,node,x,y){if(x<0){x=0}if(y<0){y=0}if(x+node.getWidth()>stage.maxWidth){x=stage.maxWidth-node.getWidth()}if(y+node.getHeight()>stage.maxHeight){y=stage.maxHeight-node.getHeight()}node.setX(x);node.setY(y)},__setLineNodePosition:function(stage,node){var drawCommands,drawCommandStart,drawCommandEnd,x,y;drawCommands=node.getGraphic().getDrawCommands();drawCommandStart=drawCommands[0].args.split(",");drawCommandEnd=drawCommands[1].args.split(",");if(parseInt(drawCommandStart[0])>=parseInt(drawCommandEnd[0])){x=(this.position.x+(node.getWidth()/2))}else{x=(this.position.x-(node.getWidth()/2))}if(parseInt(drawCommandStart[1])>=parseInt(drawCommandEnd[1])){y=(this.position.y+(node.getHeight()/2))}else{y=(this.position.y-(node.getHeight()/2))}this.__setNodePosition(stage,node,x,y)},getNode:function(stage,callback){var node=new _gliffy.Node(),command=stage.commandHistory.getClipboard();if(command!==null&&command!==undefined){node.fromObject(command.nodeObject);callback(node)}else{callback(null)}},execute:function(stage){var command=stage.commandHistory.getClipboard(),node,x,y,selectedNode,p1,p2,p3,transform,children,i,overlayManager=_gliffy.Mouse.editor.overlayManager,resource,resourceIdMap,keys,id,svg,self=this;if(command&&command.embeddedResourceMap){resourceIdMap={};keys=Object.keys(command.embeddedResourceMap);for(i=0;i<keys.length;i++){resource=new _gliffy.EmbeddedResource();resource.fromObject(command.embeddedResourceMap[keys[i]]);id=resource.getId();resource=stage.document.getEmbeddedResources().add(resource.getMimeType(),resource.getData());resourceIdMap[id]=resource.getId()}}if(this.nodeObject){node=new _gliffy.Node();node=node.fromObject(this.nodeObject);svg=node.findGraphic(_gliffy.Svg);if(svg.length>0){for(i=0;i<svg.length;i++){svg[i].getGraphic().setEmbeddedResourceId(resourceIdMap[svg[i].getGraphic().getEmbeddedResourceId()])}}stage.appendNode(node)}else{node=this.getNode(stage,function(node){if(node===null){return}self.lastCommand=command||null;if(node.isSelection()){node.setCopiedSelection(true)}node.setToActiveLayer(stage);self.position=_gliffy.Mouse.lastMouseUpPosition();svg=node.findGraphic(_gliffy.Svg);if(svg.length>0){for(i=0;i<svg.length;i++){svg[i].getGraphic().setEmbeddedResourceId(resourceIdMap[svg[i].getGraphic().getEmbeddedResourceId()])}}node.update();transform=node.worldTransform.clone();x=node.getX();y=node.getY();if(self.selectedNodeId!==null&&command instanceof _gliffy.CopyCommand&&command.transformCopy){selectedNode=stage.find(self.selectedNodeId);p1=selectedNode.worldTransform.clone().transformPoint(0,0);p2=command.transformCopy.clone().transformPoint(0,0);if(node.parent!==null){p3=node.parent.worldTransform.clone().createInverse().transformPoint(p1.x-p2.x,p1.y-p2.y)}else{p3={x:p1.x-p2.x,y:p1.y-p2.y}}if(p3.x===0&&p3.y===0){transform=self.__updateStaticPosition(stage,node,x,y)}else{self.__setNodePosition(stage,node,selectedNode.getX()+p3.x,selectedNode.getY()+p3.y);transform=selectedNode.worldTransform.clone()}}else{if(!self.__updateStaticPosition(stage,node,x,y)){transform=null}}stage.appendCopyNode(node);node.update();self.nodeId=node.getId();self.nodeObject=node.toObject();if(node.isSelection()){children=[].concat(node.children);overlayManager.deselectAll();node=overlayManager.selectNodes(children);self.childrenIds=[];for(i=0;i<children.length;i++){self.childrenIds.push(children[i].getId())}}else{overlayManager.deselectAll();overlayManager.selectNode(node)}GliffyApp.contextualPropertiesController.showControls(overlayManager.getActiveOverlay());stage.commandHistory.setClipboard(new _gliffy.CopyCommand({node:node,transformCopy:transform,embeddedResource:resource}));_gliffy.Mouse.resetMouseUpPosition();if(!_gliffy.Pick.isNodeInside(node,_gliffy.Mouse.editor.getDocumentManager().getActiveStageViewPort())){_gliffy.Mouse.editor.getDocumentManager().centerOnStage(node)}})}},undo:function(stage){var i;if(this.nodeId!==null&&this.nodeId!==undefined&&stage.find(this.nodeId)){new _gliffy.RemoveNodeCommand({node:stage.find(this.nodeId)}).execute(stage);if(this.lastCommand){stage.commandHistory.setClipboard(this.lastCommand)}}else{if(this.childrenIds){for(i=0;i<this.childrenIds.length;i++){if(stage.find(this.childrenIds[i])){new _gliffy.RemoveNodeCommand({node:stage.find(this.childrenIds[i])}).execute(stage)}}if(this.lastCommand){stage.commandHistory.setClipboard(this.lastCommand)}}}},__toObject:function(){return{action:this.action,offset:this.offset,selectedNodeId:this.selectedNodeId}}})}());(function(){_gliffy.RemoveNodeCommand=_gliffy.CollapsibleCommand.extend({action:"remove_node",init:function(o){var options=$.extend({node:null},o),n=null;if(!options.node){throw new Error("Node must be defined")}this.nodeId=options.node.getId();this.nodeObject=options.node.toObject();this.targetId=options.node.parent?options.node.parent.getId():null;this.markParentDirty=options.markParentDirty},execute:function(stage){var node=stage.find(this.nodeId),target=null;if(node){this.nodeObject=node.toObject();_gliffy.Tree.remove(node,true);if(this.targetId!==null){target=stage.find(this.targetId)}}if(target){target.removeChild(node);if(this.markParentDirty){target.markDirty()}}else{stage.removeNode(node)}},undo:function(stage){var node=new _gliffy.Node().fromObject(this.nodeObject),target=null;if(node.isMindmap()){node.findGraphic(_gliffy.Mindmap)[0].getGraphic().addNode(stage)}if(this.targetId!==null){target=stage.find(this.targetId)}if(target){target.appendChild(node);if(this.markParentDirty){target.markDirty()}}else{stage.appendNode(node)}this.nodeId=node.getId()},collapse:function(command){return false},__toObject:function(){return{action:this.action,nodeObject:this.nodeObject,targetId:this.targetId}}})}());(function(){function getXform(node){var xform=node.toObject();xform.children=null;return xform}function setXform(node,xform){var children=node.children;node.children=null;node.fromObject(xform);node.children=children}_gliffy.UngroupCommand=_gliffy.UndoableCommand.extend({action:"ungroup",init:function(o){var options=$.extend({node:null},o),child,i;this.nodeId=options.node.getId();this.xform=getXform(options.node);this.childrenXform={};for(i=0;i<options.node.children.length;i++){child=options.node.children[i];this.childrenXform[child.getId()]=getXform(child)}},execute:function(stage){var parentNode=stage.find(this.nodeId);this.selectedNodeIds=stage.detachSelectionFromGroup(parentNode);new _gliffy.RemoveNodeCommand({node:parentNode}).execute(stage)},undo:function(stage){var groupNode=new _gliffy.Node(),i=0,node,nodes=[];if(this.nodeId){groupNode.setId(this.nodeId)}stage.appendNode(groupNode);for(i=0;i<this.selectedNodeIds.length;i++){node=stage.find(this.selectedNodeIds[i]);nodes.push(node)}stage.attachSelectionToGroup(groupNode,nodes);groupNode.setRotation(this.undoRotation);setXform(groupNode,this.xform);for(i=0;i<groupNode.children.length;i++){node=groupNode.children[i];setXform(node,this.childrenXform[node.getId()]);node.update()}this.nodeId=groupNode.getId()},__toObject:function(){return{action:this.action,nodeId:this.nodeId,xform:this.xform,childrenXform:this.childrenXform}}})}());(function(){_gliffy.BundledCommand=_gliffy.UndoableCommand.extend({action:"bundled_command",init:function(o){var options=$.extend({commands:null},o);if(!(options.commands&&options.commands.length>0)){throw new Error("no commands specified")}this.commands=options.commands},execute:function(stage){var i=0,c;for(i=0;i<this.commands.length;i++){c=this.commands[i];if(c instanceof _gliffy.Command){c.execute(stage)}else{throw new Error("bundled command is not a command:"+c)}}},undo:function(stage){var i=0,c;for(i=this.commands.length-1;i>=0;i--){c=this.commands[i];if(c instanceof _gliffy.UndoableCommand){c.undo(stage)}}},shortToString:function(){var shortString="",i;for(i=0;i<this.commands.length;i++){shortString+=this.commands[i].shortToString();if(i+1<this.commands.length){shortString+=","}}return this.action+"["+shortString+"]"},toString:function(){return"{ action:"+this.action+",commands:["+this.commands.join(",")+"] }"}})}());(function(){_gliffy.MoveNodeCommand=_gliffy.CollapsibleCommand.extend({action:"move_node",init:function(o){var options=$.extend({node:null,x:0,y:0},o);this.isSelection=options.node.isSelection();this.nodeId=options.node.getId();this.undoX=options.node.getX();this.undoY=options.node.getY();this.x=options.x;this.y=options.y},execute:function(stage){var node=stage.find(this.nodeId),i,child,selection,childNode,childTransform,childPos;if(node){if(this.isSelection&&!this.lastSelection){this.lastSelection=node.toObjectNoGraphic()}if(node.isLine()){this.constraints=node.getConstraints().toObject();node.getGraphic().editable.clearConnectionStart();node.getGraphic().editable.clearConnectionEnd()}node.setX(this.x);node.setY(this.y)}else{if(this.isSelection){selection=new _gliffy.Node().fromObject(this.lastSelection);selection.setX(this.x);selection.setY(this.y);selection.update();for(i=0;i<selection.children.length;i++){child=selection.children[i];childNode=stage.find(child.getId());childTransform=child.worldTransform.clone();childPos=childTransform.transformPoint(child.getWidth()/2,child.getHeight()/2);childNode.setX(childPos.x-child.getWidth()/2);childNode.setY(childPos.y-child.getHeight()/2);childNode.setRotation(child.getRotation()+selection.getRotation())}}}},undo:function(stage){var node=stage.find(this.nodeId),i,child,selection,childNode,childTransform,childPos;if(node){node.setX(this.undoX);node.setY(this.undoY);if(node.isLine()&&this.constraints&&node.getConstraints()){node.setConstraints(node.getConstraints().fromObject(this.constraints))}}else{selection=new _gliffy.Node().fromObject(this.lastSelection);selection.update();for(i=0;i<selection.children.length;i++){child=selection.children[i];childNode=stage.find(child.getId());childTransform=child.worldTransform.clone();childPos=childTransform.transformPoint(child.getWidth()/2,child.getHeight()/2);childNode.setX(childPos.x-child.getWidth()/2);childNode.setY(childPos.y-child.getHeight()/2);childNode.setRotation(child.getRotation()+selection.getRotation())}}},collapse:function(command){if(command instanceof _gliffy.MoveNodeCommand&&this.nodeId===command.nodeId){this.x=command.x;this.y=command.y;command.lastSelection=this.lastSelection;command.constraints=this.constraints;return true}else{return false}},__toObject:function(){return{action:this.action,isSelection:this.isSelection,nodeId:this.nodeId,x:this.x,y:this.y,undoX:this.undoX,undoY:this.undoY,constraints:this.constraints}}})}());(function(){_gliffy.ModifyNodeCommand=_gliffy.UndoableCommand.extend({action:"modify_node",node:null,target:null,init:function(o){var properties,prop,graphic,i,options=$.extend({node:null,props:{}},o),n=null;if(!options.node){throw new Error("Node must be defined")}this.nodeId=options.node.getId();this.props=options.props;properties=Object.keys(this.props);this.redoProps={};graphic=options.node.getGraphic();for(i=0;i<properties.length;i++){prop=properties[i];if(options.node["get"+prop]){this.redoProps[prop]=options.node["get"+prop]()}else{if(options.node["is"+prop]){this.redoProps[prop]=options.node["is"+prop]()}else{if(graphic&&graphic["get"+prop]){this.redoProps[prop]=graphic["get"+prop]()}else{if(graphic&&graphic["is"+prop]){this.redoProps[prop]=graphic["is"+prop]()}}}}}if(this.redoProps.length===0){_gliffy.Logger.warn("modifyNodeCommand cannot find a redo property.")}},execute:function(stage){var node=stage.find(this.nodeId),properties=Object.keys(this.props),graphic=node.getGraphic(),prop,i;for(i=0;i<properties.length;i++){prop=properties[i];if(node["set"+prop]){node["set"+prop](this.props[prop])}else{if(graphic&&graphic["set"+prop]){graphic["set"+prop](this.props[prop])}}}},undo:function(stage){var node=stage.find(this.nodeId),properties=Object.keys(this.redoProps),graphic,prop,i;if(node){graphic=node.getGraphic();for(i=0;i<properties.length;i++){prop=properties[i];if(node["set"+prop]){node["set"+prop](this.redoProps[prop])}else{if(graphic&&graphic["set"+prop]){graphic["set"+prop](this.redoProps[prop])}}}}},__toObject:function(){return{action:this.action,target:this.target,props:this.props,redoProps:this.redoProps}}})}());(function(){_gliffy.ModifyLayersCommand=_gliffy.UndoableCommand.extend({layers:null,prevLayers:null,init:function(o){var options=$.extend({layers:[],prevLayers:[]},o);this.layers=options.layers},execute:function(stage){this.prevLayers=stage.getLayersObject();GliffyApp.layersController.deserializeLayersObject(this.layers);stage.setLayersFromObject(this.layers)},undo:function(stage){GliffyApp.layersController.deserializeLayersObject(this.prevLayers);stage.setLayersFromObject(this.prevLayers)},__toObject:function(){return{layers:this.layers,prevLayers:this.prevLayers}}})}());(function(){_gliffy.ModifyLineCommand=_gliffy.CollapsibleCommand.extend({action:"modify_line",init:function(o){var options=$.extend({node:null},o),graphic=options.node.getGraphic();this.nodeId=options.node.getId();this.startSnapShot=this._createSnapShot(options.node);this.endSnapShot=this.startSnapShot},_createSnapShot:function(node){try{if(node){node.update();var graphic=node.getGraphic(),startConnection=graphic.getStartConnection(),endConnection=graphic.getEndConnection(),startConnectionRatio=null,endConnectionRatio=null;if(startConnection!==null){startConnection=startConnection.getId();startConnectionRatio=graphic.editable.getConnectionStart().ratio}if(endConnection!==null){endConnection=endConnection.getId();endConnectionRatio=graphic.editable.getConnectionEnd().ratio}return{controlPath:graphic.getControlPath(),segmentLocks:graphic.editable.getLockSegments(),startConnectionId:startConnection,startConnectionRatio:startConnectionRatio,endConnectionId:endConnection,endConnectionRatio:endConnectionRatio}}}catch(e){_gliffy.Logger.warn("Could not create line snapshot in modifyLineCommand:"+e.toString())}},_applySnapShot:function(node,snapShot){try{if(node&&snapShot){var graphic=node.getGraphic(),startConnection=node.stage.find(snapShot.startConnectionId),endConnection=node.stage.find(snapShot.endConnectionId);node.update();graphic.setControlPath(snapShot.controlPath);graphic.editable.setLockSegments(snapShot.segmentLocks);if(startConnection){graphic.setStartConnection(startConnection,snapShot.startConnectionRatio)}else{graphic.setStartConnection(null)}if(endConnection){graphic.setEndConnection(endConnection,snapShot.endConnectionRatio)}else{graphic.setEndConnection(null)}node.update()}}catch(e){_gliffy.Logger.warn("Could not apply line snapshot in modifyLineCommand:"+e.toString())}},takeSnapShot:function(stage){this.endSnapShot=this._createSnapShot(stage.find(this.nodeId))},execute:function(stage){var node=stage.find(this.nodeId);this._applySnapShot(node,this.endSnapShot)},undo:function(stage){var node=stage.find(this.nodeId);this._applySnapShot(node,this.startSnapShot)},collapse:function(command){return false},__toObject:function(){return{action:this.action,startSnapShot:this.startSnapShot,endSnapShot:this.endSnapShot,nodeId:this.nodeId}}})}());(function(){_gliffy.ModifyLineTextCommand=_gliffy.CollapsibleCommand.extend({action:"modify_line_text",init:function(o){var options=$.extend({node:null,lineTValue:null,linePerpValue:null},o);this.prevLineTValue=options.node.getGraphic().getLineTValue();this.prevLinePerpValue=options.node.getGraphic().getLinePerpValue();this.nodeId=options.node.getId();this.lineTValue=options.lineTValue;this.linePerpValue=options.linePerpValue},execute:function(stage){var node=stage.find(this.nodeId);node.getGraphic().setLineTValue(this.lineTValue);node.getGraphic().setLinePerpValue(this.linePerpValue);node.parent.markDirty()},undo:function(stage){var node=stage.find(this.nodeId);node.getGraphic().setLineTValue(this.prevLineTValue);node.getGraphic().setLinePerpValue(this.prevLinePerpValue);node.parent.markDirty()},collapse:function(command){return false}})}());(function(){_gliffy.ModifyNodeTextCommand=_gliffy.UndoableCommand.extend({action:"modify_node_text",init:function(o){var options=$.extend({hAlign:null,node:null,position:null,vAlign:null},o);if(options.node){this.nodeId=options.node.getId();this.position=options.position;this.hAlign=options.hAlign;this.vAlign=options.vAlign;this.undoTextObject=options.node.toObject();this.redoTextObject=null}},execute:function(stage){var graphic,node;node=stage.find(this.nodeId);if(node){if(this.redoTextObject){node.fromObject(this.redoTextObject)}else{graphic=node.getGraphic();graphic.setPosition(this.position);graphic.setHalign(this.hAlign,{skipCommandRegistration:true});graphic.setValign(this.vAlign)}node.parent.markDirty()}},undo:function(stage){var node=stage.find(this.nodeId);if(node){this.redoTextObject=node.toObject();node.fromObject(this.undoTextObject);node.parent.markDirty()}},__toObject:function(){return{hAlign:this.hAlign,nodeId:this.nodeId,position:this.position,redoTextObject:this.redoTextObject,undoTextObject:this.undoTextObject}}})}());(function(){_gliffy.NetworkRackResizeCommand=_gliffy.UndoableCommand.extend({action:"network_rack_resize",init:function(o){var options=$.extend({editor:null,node:null,height:1,oldHeight:0,shapeUnitOffset:0,units:0,PIXELS_TO_UNITS:0},o);this.editor=options.editor;this.node=options.node;this.height=options.height;this.oldHeight=options.oldHeight;this.units=options.units;this.PIXELS_TO_UNITS=options.PIXELS_TO_UNITS;this.shapeUnitOffset=options.shapeUnitOffset},updateNetworkRack:function(){if(this.node){this.node.setHeight(this.height);this.updateRackUnit(this.units);this.updateChildren(this.height)}},updateChildren:function(height){var child;if(this.node&&this.node.children&&this.node.children.length>0){for(child=0;child<this.node.children.length;child++){this.node.children[child].setHeight(height)}}},updateRackUnit:function(units){var childTextIndex=1;if(this.node&&this.node.children.length>0&&GliffyApp.networkRackTabController.isRack(this.node)){childTextIndex=4}this.node.children[childTextIndex].children[0].getGraphic().setNodeText(units+"u")},execute:function(stage){this.updateNetworkRack(stage)},undo:function(){if(this.node){this.node.setHeight(this.oldHeight+this.shapeUnitOffset);this.updateRackUnit(this.oldHeight/this.PIXELS_TO_UNITS);this.updateChildren(this.oldHeight+this.shapeUnitOffset)}}})}());(function(){_gliffy.SetLineTypeCommand=_gliffy.CollapsibleCommand.extend({action:"set_line_type",init:function(o){var options=$.extend({node:null,ortho:false,interpolation:null,cornerRadius:null},o);this.nodeId=options.node.getId();this.ortho=options.ortho;this.interpolation=options.interpolation;this.cornerRadius=options.cornerRadius;this.previousOrtho=options.node.getGraphic().isOrtho();this.previousInterpolation=options.node.getGraphic().getInterpolationType();this.previousCornerRadius=options.node.getGraphic().getCornerRadius()},execute:function(stage){var node=stage.find(this.nodeId);node.getGraphic().setOrtho(this.ortho);node.getGraphic().setInterpolationType(this.interpolation);node.getGraphic().setCornerRadius(this.cornerRadius)},undo:function(stage){var node=stage.find(this.nodeId);node.getGraphic().setOrtho(this.previousOrtho);node.getGraphic().setInterpolationType(this.previousInterpolation);node.getGraphic().setCornerRadius(this.previousCornerRadius)},collapse:function(command){return false},__toObject:function(){return{action:this.action,nodeId:this.nodeId,ortho:this.ortho,interpolation:this.interpolation,cornerRadius:this.cornerRadius,previousOrtho:this.previousOrtho,previousInterpolation:this.previousInterpolation,previousCornerRadius:this.previousCornerRadius}}})}());(function(){_gliffy.SetFillColorCommand=_gliffy.CollapsibleCommand.extend({action:"fill_color",init:function(o){if(Ember&&Ember.isArray(o)&&o.length>0){o=o[0]}var options=$.extend({node:null,fillColor:"none"},o);this.nodeId=options.node.getId();this.undoFillColor=options.node.getGraphic().getFillColor();this.fillColor=options.fillColor},execute:function(stage){var node=stage.find(this.nodeId);node.getGraphic().setFillColor(this.fillColor)},undo:function(stage){var node=stage.find(this.nodeId);node.getGraphic().setFillColor(this.undoFillColor)},collapse:function(command){if(command instanceof _gliffy.SetFillColorCommand&&this.nodeId===command.nodeId){this.fillColor=command.fillColor;return true}else{return false}},__toObject:function(){return{action:this.action,nodeId:this.nodeId,undoFillColor:this.undoFillColor,fillColor:this.fillColor}}})}());(function(){_gliffy.SetScaleCommand=_gliffy.CollapsibleCommand.extend({action:"scale_node",init:function(o){var options=$.extend({node:null,scaleX:1,scaleY:1,x:0,y:0},o);this.nodeId=options.node.getId();this.isSelection=options.node.isSelection();this.scaleX=options.scaleX;this.scaleY=options.scaleY;this.x=options.x;this.y=options.y;this.undoWidth=options.node.getWidth();this.undoHeight=options.node.getHeight();this.undoX=options.node.getX();this.undoY=options.node.getY()},execute:function(stage){var node=stage.find(this.nodeId),i,child,selection,childNode,childTransform,childPos;if(node){if(this.isSelection&&!this.lastSelection){this.lastSelection=node.toObjectNoGraphic()}node.setScaleX(this.scaleX);node.setScaleY(this.scaleY);node.setX(this.x);node.setY(this.y)}else{selection=new _gliffy.Node().fromObject(this.lastSelection);selection.setScaleX(this.scaleX);selection.setScaleY(this.scaleY);selection.setX(this.x);selection.setY(this.y);if(this.rotation){selection.setRotation(this.rotation)}selection.update();for(i=0;i<selection.children.length;i++){child=selection.children[i];childNode=stage.find(child.getId());childTransform=child.worldTransform.clone();childPos=childTransform.transformPoint(child.getWidth()/2,child.getHeight()/2);childNode.setScaleX(this.scaleX);childNode.setScaleY(this.scaleY);childNode.setX(childPos.x-child.getWidth()/2);childNode.setY(childPos.y-child.getHeight()/2);childNode.setRotation(child.getRotation()+selection.getRotation())}}},undo:function(stage){var node=stage.find(this.nodeId),i,child,selection,childNode,childTransform,childPos;if(node){node.setScaleX(1/(node.getWidth()/this.undoWidth));node.setScaleY(1/(node.getHeight()/this.undoHeight));node.setX(this.undoX);node.setY(this.undoY)}else{selection=new _gliffy.Node().fromObject(this.lastSelection);selection.update();for(i=0;i<selection.children.length;i++){child=selection.children[i];childNode=stage.find(child.getId());childTransform=child.worldTransform.clone();childPos=childTransform.transformPoint(child.getWidth()/2,child.getHeight()/2);childNode.setScaleX(child.getWidth()/childNode.getWidth());childNode.setScaleY(child.getHeight()/childNode.getHeight());childNode.setX(childPos.x-child.getWidth()/2);childNode.setY(childPos.y-child.getHeight()/2);childNode.setRotation(child.getRotation()+selection.getRotation());childNode.markDirty()}}},collapse:function(command){if(command instanceof _gliffy.SetScaleCommand&&this.nodeId===command.nodeId){this.scaleX*=command.scaleX;this.scaleY*=command.scaleY;this.x=command.x;this.y=command.y;command.lastSelection=this.lastSelection;return true}else{if(command instanceof _gliffy.SetRotationCommand&&this.nodeId===command.nodeId){this.rotation=command.rotation;command.lastSelection=this.lastSelection;return true}else{return false}}},__toObject:function(){return{action:this.action,nodeId:this.nodeId,isSelection:this.isSelection,scaleX:this.scaleX,scaleY:this.scaleY,x:this.x,y:this.y,undoX:this.undoX,undoY:this.undoY}}})}());(function(){_gliffy.SetRotationCommand=_gliffy.CollapsibleCommand.extend({action:"rotate_node",lastSelection:null,init:function(o){var i,options=$.extend({node:null,rotation:0},o);this.isSelection=options.node.isSelection();this.nodeId=options.node.getId();this.undoRotation=options.node.getRotation();this.rotation=options.rotation},execute:function(stage){var node=stage.find(this.nodeId),selection,child,childNode,childTransform,childPos,i;if(node){if(this.isSelection&&!this.lastSelection){this.lastSelection=node.toObjectNoGraphic()}node.setRotation(this.rotation)}else{selection=new _gliffy.Node().fromObject(this.lastSelection);selection.setRotation(this.rotation);selection.update();for(i=0;i<selection.children.length;i++){child=selection.children[i];childNode=stage.find(child.getId());childTransform=child.worldTransform.clone();childPos=childTransform.transformPoint(child.getWidth()/2,child.getHeight()/2);childNode.setX(childPos.x-child.getWidth()/2);childNode.setY(childPos.y-child.getHeight()/2);childNode.setRotation(child.getRotation()+selection.getRotation())}}},__updateLine:function(stage,node){var i;if(node.isLine()){for(i=0;i<node.getGraphic().editable.getSegmentCount();i++){stage.commandHistory.addAndExecuteCommand(new _gliffy.SetLockSegmentCommand({node:node,value:false,segment:i}))}}},undo:function(stage){var node=stage.find(this.nodeId),i,selection,childTransform,child,childNode,childPos;if(node){node.setRotation(this.undoRotation)}else{if(this.isSelection){selection=new _gliffy.Node().fromObject(this.lastSelection);selection.update();for(i=0;i<selection.children.length;i++){child=selection.children[i];childNode=stage.find(child.getId());childTransform=child.worldTransform.clone();childPos=childTransform.transformPoint(child.getWidth()/2,child.getHeight()/2);childNode.setX(childPos.x-child.getWidth()/2);childNode.setY(childPos.y-child.getHeight()/2);childNode.setRotation(child.getRotation()+selection.getRotation())}}}},collapse:function(command){if(command instanceof _gliffy.SetRotationCommand&&this.nodeId===command.nodeId){this.rotation=command.rotation;command.lastSelection=this.lastSelection;return true}else{return false}},__toObject:function(){return{action:this.action,isSelection:this.isSelection,nodeId:this.nodeId,rotation:this.rotation,undoRotation:this.undoRotation}}})}());(function(){_gliffy.SetStrokeColorCommand=_gliffy.CollapsibleCommand.extend({action:"stroke_color",init:function(o){if(Ember&&Ember.isArray(o)&&o.length>0){o=o[0]}var options=$.extend({node:null,strokeColor:"none"},o);this.nodeId=options.node.getId();this.undoStrokeColor=options.node.getGraphic().getStrokeColor();this.strokeColor=options.strokeColor},execute:function(stage){var node=stage.find(this.nodeId);node.getGraphic().setStrokeColor(this.strokeColor)},undo:function(stage){var node=stage.find(this.nodeId);node.getGraphic().setStrokeColor(this.undoStrokeColor)},collapse:function(command){if(command instanceof _gliffy.SetStrokeColorCommand&&this.nodeId===command.nodeId){this.strokeColor=command.strokeColor;return true}else{return false}},__toObject:function(){return{action:this.action,nodeId:this.nodeId,strokeColor:this.strokeColor,undoStrokeColor:this.undoStrokeColor}}})}());(function(){_gliffy.SetWidthAndHeightCommand=_gliffy.CollapsibleCommand.extend({action:"width_and_height",init:function(o){var options=$.extend({node:null,width:0,height:0},o);this.nodeId=options.node.getId();this.width=options.width;this.height=options.height;this.undoWidth=options.node.getWidth();this.undoHeight=options.node.getHeight()},execute:function(stage){var node=stage.find(this.nodeId);node.setWidth(this.width);node.setHeight(this.height)},undo:function(stage){var node=stage.find(this.nodeId);node.setWidth(this.undoWidth);node.setHeight(this.undoHeight)},collapse:function(command){if(command instanceof _gliffy.SetWidthAndHeightCommand&&this.nodeId===command.nodeId){this.width=command.width;this.height=command.height;return true}else{return false}},__toObject:function(){return{action:this.action,nodeId:this.nodeId,width:this.width,height:this.height,undoWidth:this.undoWidth,undoHeight:this.undoHeight}}})}());(function(){_gliffy.SetTextCommand=_gliffy.CollapsibleCommand.extend({action:"text",init:function(o){var options=$.extend({node:null,text:null},o);this.nodeId=options.node.getId();this.undoText=options.node.getGraphic().getHTML();this.text=options.text},execute:function(stage){var node=stage.find(this.nodeId);if(node&&node.isText()){if(node.getGraphic().getHTML()===this.text){stage.commandHistory.removeCommand(this)}node.getGraphic().setHTML(this.text)}},undo:function(stage){var node=stage.find(this.nodeId);if(node&&node.isText()){node.getGraphic().setHTML(this.undoText)}},collapse:function(command){return false},__toObject:function(){return{action:this.action,nodeId:this.nodeId,text:this.text,undoText:this.undoText}}})}());(function(){_gliffy.ReorderNodesCommand=_gliffy.UndoableCommand.extend({action:"reorder_nodes",init:function(o){var i,children,options=$.extend({node:null},o);if(options.node){this.isSelection=options.node.isSelection();if(this.isSelection){children=options.node.flattenChildren();this.selectionIds=[];for(i=0;i<children.length;i++){this.selectionIds.push(children[i].getId())}}this.nodeId=options.node.getId()}},execute:function(stage){var node=null,i=0,nodes=[];var reorderFunc=null;switch(this.action){case"bring_to_front":reorderFunc="bringToFront";break;case"send_to_back":reorderFunc="sendToBack";break;case"reorder_nodes":this.orderList=stage.reorderNodes(stage.objects);return;default:_gliffy.Logger.warn("don't know how to execute ReorderNodesCommand")}node=stage.find(this.nodeId);if(this.isSelection){for(i=0;i<this.selectionIds.length;i++){nodes.push(stage.find(this.selectionIds[i]))}this.orderList=stage[reorderFunc](nodes)}else{this.orderList=stage[reorderFunc](node)}},undo:function(stage){var i,orderInfo,node;for(i=0;i<this.orderList.length;i++){orderInfo=this.orderList[i];node=stage.find(orderInfo.id);if(node){node.setOrder(orderInfo.order)}}},__toObject:function(){return{action:this.action,isSelection:this.isSelection,nodeId:this.nodeId,selectionIds:this.selectionIds}}})}());(function(){_gliffy.BringToFrontCommand=_gliffy.ReorderNodesCommand.extend({action:"bring_to_front"})}());(function(){_gliffy.SendToBackCommand=_gliffy.ReorderNodesCommand.extend({action:"send_to_back"})}());(function(){_gliffy.TableInsertCellsCommand=_gliffy.UndoableCommand.extend({selectedCells:null,selectedCellPosition:null,action:"table_insert_cells",init:function(o){var options=$.extend({node:null,rows:1,columns:0,selectedCells:null,tableOverlay:null},o);options.node.update();this.nodeId=options.node.getId();this.rows=options.rows;this.columns=options.columns;this.origWidth=options.node.getWidth();this.origHeight=options.node.getHeight();this.worldTransform=options.node.worldTransform.clone();this.nodeObject=options.node.toObject();this.selectedCells=options.selectedCells;this.tableOverlay=options.tableOverlay},__distanceFromOrigin:function(point,transform,height,width){var p=transform.transformPoint(point.x*width,point.y*height);return Math.sqrt(Math.pow(p.x,2)+Math.pow(p.y,2))},updatePosition:function(node){var points=[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:0,y:1}],topLeft=0,minDistance=null,i,distance,point,currentPoint;node.update();for(i=0;i<points.length;i++){distance=this.__distanceFromOrigin(points[i],node.worldTransform,this.origHeight,this.origWidth);if(!minDistance){minDistance=distance}else{if(distance<minDistance){topLeft=i;minDistance=distance}}}point=this.worldTransform.transformPoint(points[topLeft].x*this.origWidth,points[topLeft].y*this.origHeight);currentPoint=node.worldTransform.transformPoint(points[topLeft].x*node.getWidth(),points[topLeft].y*node.getHeight());node.setX(node.getX()+(point.x-currentPoint.x));node.setY(node.getY()+(point.y-currentPoint.y))},__mapRowIds:function(node,oldColumns){var rowToAdd=[],matrixOfIdsByRow=[],colCount=0,i;if(node.children){for(i=0;i<node.children.length;i++){rowToAdd.push(node.children[i].getId());if(colCount===oldColumns-1){matrixOfIdsByRow.push(rowToAdd);rowToAdd=[];colCount=0}else{colCount++}}}return matrixOfIdsByRow},__mapColIds:function(node,oldColumns){var colToAdd=[],matrixOfIdsByCol=[],position,j,i;for(i=0;i<oldColumns;i++){colToAdd=[];if(node.children){position=node.children[i].getPosition();for(j=0;j<node.children.length;j++){if(position.x===node.children[j].getPosition().x){colToAdd.push(node.children[j].getId())}}}matrixOfIdsByCol.push(colToAdd)}return matrixOfIdsByCol},__selectedCellPosition:function(selectedId,matrixOfIdsByRow,matrixOfIdsByCol){var i,idPos,position=[];for(i=0;i<matrixOfIdsByRow.length;i++){for(idPos=0;idPos<matrixOfIdsByRow[i].length;idPos++){if(selectedId===matrixOfIdsByRow[i][idPos]){position.row=i}}}for(i=0;i<matrixOfIdsByCol.length;i++){for(idPos=0;idPos<matrixOfIdsByCol[i].length;idPos++){if(selectedId===matrixOfIdsByCol[i][idPos]){position.col=i}}}return position},updateCells:function(stage){var node=stage.find(this.nodeId),i,oldColumns,oldRows,position,newColumns,newRows,newWidth=0,newHeight=0,matrixOfIdsByRow,matrixOfIdsByCol,newPositionY=null;if(!node){return}oldColumns=0;if(node.children){for(i=0;i<node.children.length;i++){position=node.children[i].getPosition();if(newPositionY===null){newPositionY=position.y}if(Math.floor(position.y)!==Math.floor(newPositionY)){break}oldColumns++}}oldRows=node.children.length/oldColumns;newColumns=oldColumns+this.columns;newRows=oldRows+this.rows;if(newRows<=0||newColumns<=0){return}matrixOfIdsByRow=this.__mapRowIds(node,oldColumns);matrixOfIdsByCol=this.__mapColIds(node,oldColumns);if(this.columns>0&&this.selectedCells.length===0){newWidth=this.addColumnAtEnd(stage,node,matrixOfIdsByCol,newColumns)}else{if(this.columns>0&&this.selectedCells.length>0){newWidth=this.insertColumn(stage,node,matrixOfIdsByRow,matrixOfIdsByCol)}}if(this.columns<0&&this.selectedCells.length===0){newWidth=this.removeColumnAtEnd(stage,node,matrixOfIdsByCol)}else{if(this.columns<0&&this.selectedCells.length>0){newWidth=this.removeSelectedColumn(stage,node,matrixOfIdsByRow,matrixOfIdsByCol)}}if(this.rows>0&&this.selectedCells.length===0){newHeight=this.addRowAtEnd(stage,node,matrixOfIdsByRow,oldRows)}else{if(this.rows>0&&this.selectedCells.length>0){newHeight=this.insertRow(stage,node,matrixOfIdsByRow,matrixOfIdsByCol)}}if(this.rows<0&&this.selectedCells.length===0){newHeight=this.removeRowAtEnd(stage,node,matrixOfIdsByRow)}else{if(this.rows<0&&this.selectedCells.length>0){newHeight=this.removeSelectedRow(stage,node,matrixOfIdsByRow,matrixOfIdsByCol)}}node.setWidth(node.getWidth()+newWidth);node.setHeight(node.getHeight()+newHeight)},insertRow:function(stage,node,matrixOfIdsByRow,matrixOfIdsByCol){var selectedCellPos,cellObject,cell,j,ids,oldNode,newIds=[],k,posConstraints,posConstraintsArray;selectedCellPos=this.__selectedCellPosition(this.selectedCells[0].getId(),matrixOfIdsByRow,matrixOfIdsByCol);ids=matrixOfIdsByRow[selectedCellPos.row];for(j=0;j<ids.length;j++){oldNode=stage.find(ids[j]);cellObject=oldNode.toObject();cell=new _gliffy.Node().fromObject(cellObject);cell.setId("auto");if(cell.children!==null&&cell.children[0] instanceof _gliffy.Node){cell.children[0].setId("auto");cell.children[0].getGraphic().setNodeText("")}cell.setX(cell.getWidth()+cell.x);cell.setY(cell.getHeight()+cell.y);this.__addRowConstraints(cell,ids,newIds,matrixOfIdsByRow,oldNode,j);node.insertChild(cell,(selectedCellPos.row+1)*matrixOfIdsByCol.length+j);newIds.push(cell.getId())}if((matrixOfIdsByRow.length-1)>(selectedCellPos.row)){ids=matrixOfIdsByRow[selectedCellPos.row+1];for(j=0;j<ids.length;j++){oldNode=stage.find(ids[j]);oldNode.setY(oldNode.getY()+cellObject.height);posConstraints=oldNode.getConstraints();posConstraintsArray=posConstraints.getConstraints(_gliffy.PositionConstraint);for(k=0;k<posConstraintsArray.length;k++){if(posConstraintsArray[k].py===1){posConstraintsArray[k].nodeId=newIds[j]}}}}return cellObject.height},addRowAtEnd:function(stage,node,matrixOfIdsByRow){var cellObject,cell,j,ids,oldNode,newIds=[],childrenLen=node.children.length;ids=matrixOfIdsByRow[matrixOfIdsByRow.length-1];for(j=0;j<ids.length;j++){oldNode=stage.find(ids[j]);cellObject=oldNode.toObject();cell=new _gliffy.Node().fromObject(cellObject);cell.setId("auto");if(cell.children!==null&&cell.children[0] instanceof _gliffy.Node){cell.children[0].setId("auto");cell.children[0].getGraphic().setNodeText("")}cell.setX(cell.getWidth()+cell.x);cell.setY(cell.getHeight()+cell.y);this.__addRowConstraints(cell,ids,newIds,matrixOfIdsByRow,oldNode,j);node.insertChild(cell,childrenLen+j);newIds.push(cell.getId())}return cellObject.height},__addRowConstraints:function(cell,ids,newIds,matrixOfIdsByRow,oldNode,j){var k,posConstraints,newConstraint,posConstraintsArray;posConstraints=cell.getConstraints();posConstraintsArray=posConstraints.getConstraints(_gliffy.PositionConstraint);for(k=0;k<=posConstraintsArray.length-1;k++){if(posConstraintsArray[k].py===1){posConstraintsArray[k].nodeId=ids[j]}else{if(j!=0){posConstraintsArray[k].nodeId=newIds[j-1]}}if(!posConstraintsArray[k].py&&matrixOfIdsByRow.length===1){newConstraint=new _gliffy.PositionConstraint(oldNode,0,1);posConstraints.add(newConstraint)}}if(posConstraintsArray.length===0){newConstraint=new _gliffy.PositionConstraint(oldNode,0,1);posConstraints.add(newConstraint)}},removeRowAtEnd:function(stage,node,matrixOfIdsByRow){var j,oldNode,prevCellHeight,ids;ids=matrixOfIdsByRow[matrixOfIdsByRow.length-1];for(j=0;j<ids.length;j++){oldNode=stage.find(ids[j]);prevCellHeight=-oldNode.getHeight();new _gliffy.RemoveNodeCommand({node:oldNode}).execute(stage)}return prevCellHeight},removeSelectedRow:function(stage,node,matrixOfIdsByRow,matrixOfIdsByCol){var j,k,oldNode,prevCellHeight,ids,selectedCellPos,prevIds=[],nextIds,nextNode,prevNode,posConstraints,newConstraint,nextRow;selectedCellPos=this.__selectedCellPosition(this.selectedCells[0].getId(),matrixOfIdsByRow,matrixOfIdsByCol);ids=matrixOfIdsByRow[selectedCellPos.row];for(j=0;j<ids.length;j++){oldNode=stage.find(ids[j]);prevCellHeight=oldNode.getHeight();new _gliffy.RemoveNodeCommand({node:oldNode}).execute(stage)}if((matrixOfIdsByRow.length-1)>(selectedCellPos.row)&&selectedCellPos.row!==0){nextIds=matrixOfIdsByRow[selectedCellPos.row+1];prevIds=matrixOfIdsByRow[selectedCellPos.row-1];for(j=0;j<nextIds.length;j++){nextNode=stage.find(nextIds[j]);prevNode=stage.find(prevIds[j]);posConstraints=nextNode.getConstraints();newConstraint=new _gliffy.PositionConstraint(prevNode,0,1);posConstraints.add(newConstraint)}}for(j=selectedCellPos.row+1;j<matrixOfIdsByRow.length;j++){nextRow=matrixOfIdsByRow[j];for(k=0;k<nextRow.length;k++){nextNode=stage.find(nextRow[k]);nextNode.setY(nextNode.getY()-prevCellHeight)}}return -prevCellHeight},insertColumn:function(stage,node,matrixOfIdsByRow,matrixOfIdsByCol){var selectedCellPos,cellObject,cell,j,ids,oldNode,newIds=[],k,posConstraints,posConstraintsArray;selectedCellPos=this.__selectedCellPosition(this.selectedCells[0].getId(),matrixOfIdsByRow,matrixOfIdsByCol);ids=matrixOfIdsByCol[selectedCellPos.col];for(j=0;j<ids.length;j++){oldNode=stage.find(ids[j]);cellObject=oldNode.toObject();cell=new _gliffy.Node().fromObject(cellObject);cell.setId("auto");if(cell.children!==null&&cell.children[0] instanceof _gliffy.Node){cell.children[0].setId("auto");cell.children[0].getGraphic().setNodeText("")}cell.setX(cell.getWidth()+cell.x);cell.setY(cell.getHeight()+cell.y);this.__addColConstraints(cell,ids,newIds,matrixOfIdsByCol,oldNode,j);node.insertChild(cell,((j*(matrixOfIdsByCol.length+1))+1+selectedCellPos.col));newIds.push(cell.getId())}if((matrixOfIdsByCol.length-1)>(selectedCellPos.col)){ids=matrixOfIdsByCol[selectedCellPos.col+1];for(j=0;j<ids.length;j++){oldNode=stage.find(ids[j]);oldNode.setX(oldNode.getX()+cellObject.width);posConstraints=oldNode.getConstraints();posConstraintsArray=posConstraints.getConstraints(_gliffy.PositionConstraint);for(k=0;k<posConstraintsArray.length;k++){if(posConstraintsArray[k].px===1){posConstraintsArray[k].nodeId=newIds[j]}}}}this.tableOverlay.buildColumnResizeControls(node);return cellObject.width},addColumnAtEnd:function(stage,node,matrixOfIdsByCol,newColumns){var cellObject,cell,j,ids,oldNode,newIds=[];ids=matrixOfIdsByCol[matrixOfIdsByCol.length-1];for(j=0;j<ids.length;j++){oldNode=stage.find(ids[j]);cellObject=oldNode.toObject();cell=new _gliffy.Node().fromObject(cellObject);cell.setId("auto");if(cell.children!==null&&cell.children[0] instanceof _gliffy.Node){cell.children[0].setId("auto");cell.children[0].getGraphic().setNodeText("")}cell.setX(cell.getWidth()+cell.x);cell.setY(cell.getHeight()+cell.y);this.__addColConstraints(cell,ids,newIds,matrixOfIdsByCol,oldNode,j);node.insertChild(cell,(j+1)*newColumns-1);newIds.push(cell.getId())}return cellObject.width},__addColConstraints:function(cell,ids,newIds,matrixOfIdsByCol,oldNode,j){var posConstraints,newConstraint,posConstraintsArray,k;posConstraints=cell.getConstraints();posConstraintsArray=posConstraints.getConstraints(_gliffy.PositionConstraint);for(k=0;k<=posConstraintsArray.length-1;k++){if(posConstraintsArray[k].px===1){posConstraintsArray[k].nodeId=ids[j]}else{if(j!=0){posConstraintsArray[k].nodeId=newIds[j-1]}}if(!posConstraintsArray[k].px&&matrixOfIdsByCol.length===1){newConstraint=new _gliffy.PositionConstraint(oldNode,1,0);posConstraints.add(newConstraint)}}if(posConstraintsArray.length===0){newConstraint=new _gliffy.PositionConstraint(oldNode,1,0);posConstraints.add(newConstraint)}},removeColumnAtEnd:function(stage,node,matrixOfIdsByCol){var j,oldNode,prevCellWidth,ids;ids=matrixOfIdsByCol[matrixOfIdsByCol.length-1];for(j=0;j<ids.length;j++){oldNode=stage.find(ids[j]);prevCellWidth=-oldNode.getWidth();new _gliffy.RemoveNodeCommand({node:oldNode}).execute(stage)}return prevCellWidth},removeSelectedColumn:function(stage,node,matrixOfIdsByRow,matrixOfIdsByCol){var j,k,oldNode,prevCellWidth,ids,selectedCellPos,prevIds=[],nextIds,nextNode,prevNode,posConstraints,newConstraint,nextCol;selectedCellPos=this.__selectedCellPosition(this.selectedCells[0].getId(),matrixOfIdsByRow,matrixOfIdsByCol);ids=matrixOfIdsByCol[selectedCellPos.col];for(j=0;j<ids.length;j++){oldNode=stage.find(ids[j]);prevCellWidth=oldNode.getWidth();new _gliffy.RemoveNodeCommand({node:oldNode}).execute(stage)}if((matrixOfIdsByCol.length-1)>(selectedCellPos.col)&&selectedCellPos.col!==0){nextIds=matrixOfIdsByCol[selectedCellPos.col+1];prevIds=matrixOfIdsByCol[selectedCellPos.col-1];for(j=0;j<nextIds.length;j++){nextNode=stage.find(nextIds[j]);prevNode=stage.find(prevIds[j]);posConstraints=nextNode.getConstraints();newConstraint=new _gliffy.PositionConstraint(prevNode,1,0);posConstraints.add(newConstraint)}}for(j=selectedCellPos.col+1;j<matrixOfIdsByCol.length;j++){nextCol=matrixOfIdsByCol[j];for(k=0;k<nextCol.length;k++){nextNode=stage.find(nextCol[k]);nextNode.setX(nextNode.getX()-prevCellWidth)}}return -prevCellWidth},execute:function(stage){this.updateCells(stage);$(".tooltip").remove()},undo:function(stage){var node=stage.find(this.nodeId);while(node.children.length>1){if(node.children[node.children.length-1]){new _gliffy.RemoveNodeCommand({node:node.children[node.children.length-1]}).execute(stage)}}node.fromObject(this.nodeObject)}})}());(function(){_gliffy.TableResizeCommand=_gliffy.UndoableCommand.extend({action:"table_resize",init:function(o){var options=$.extend({editor:null,selectedNode:null,node:null,width:0,height:0,type:null,newWidth:0,oldWidth:0,idPositionArray:[],stage:null},o);options.node.update();this.__editor=options.editor;this.selectedNode=options.selectedNode;this.node=options.node;this.newHeight=options.height;this.oldHeight=this.node.getHeight();this.type=options.type;this.newWidth=options.width;this.oldWidth=this.node.getWidth();this.idPositionArray=options.idArray;this.stage=options.stage;this.MIN_CELL_SIZE=15},__updateColumnWidth:function(cell,width){var selectedNode=this.selectedNode,cellColIndex,originalWidth,siblingWidth,lastColumn=false,self=this,node;self.__editor.overlayManager.deselectAll();if(selectedNode){if(width>=self.MIN_CELL_SIZE){originalWidth=cell.getWidth();if(selectedNode.children){cellColIndex=self.__getCellIndex(cell);if(self.idPositionArray[cellColIndex]){if(self.idPositionArray[cellColIndex+1]){$.each(self.idPositionArray[cellColIndex+1].ids,function(_,cellId){node=self.stage.find(cellId);if(node){siblingWidth=node.getWidth()-(width-originalWidth);if(siblingWidth>self.MIN_CELL_SIZE){node.setWidth(siblingWidth);if(node.children.length>0){node.children[0].setWidth(siblingWidth)}}}})}else{lastColumn=true;selectedNode.setWidth(selectedNode.getWidth()+width-cell.getWidth())}if(lastColumn||(siblingWidth>self.MIN_CELL_SIZE)){$.each(self.idPositionArray[cellColIndex].ids,function(_,cellId){node=self.stage.find(cellId);if(node){node.setWidth(width);if(node.children.length>0){node.children[0].setWidth(width)}}})}}}}selectedNode.markDirty();this.__editor.getDocumentManager().redraw();this.__editor.overlayManager.selectNode(selectedNode)}},__updateRowHeight:function(cell,height,redrawOverlay){var selectedNode=this.selectedNode,cellRowIndex,originalHeight,lastRow=false,siblingHeight,self=this,node;if(redrawOverlay){self.__editor.overlayManager.deselectAll()}if(selectedNode){if(height>=self.MIN_CELL_SIZE){originalHeight=cell.getHeight();if(selectedNode.children){cellRowIndex=self.__getCellIndex(cell);if(self.idPositionArray[cellRowIndex]){if(self.idPositionArray[cellRowIndex+1]){$.each(self.idPositionArray[cellRowIndex+1].ids,function(_,cellId){node=self.stage.find(cellId);if(node){siblingHeight=node.getHeight()-(height-originalHeight);if(siblingHeight>self.MIN_CELL_SIZE){node.setHeight(siblingHeight)}}})}else{lastRow=true;selectedNode.setHeight(selectedNode.getHeight()+height-cell.getHeight())}if(lastRow||(siblingHeight>self.MIN_CELL_SIZE)){$.each(self.idPositionArray[cellRowIndex].ids,function(_,cellId){node=self.stage.find(cellId);if(node){node.setHeight(height)}})}}}}if(redrawOverlay){selectedNode.markDirty();this.__editor.getDocumentManager().redraw();this.__editor.overlayManager.selectNode(selectedNode)}}},__getCellIndex:function(cell){var dimensionIndex,idIndex;for(dimensionIndex=0;dimensionIndex<this.idPositionArray.length;dimensionIndex++){for(idIndex=0;idIndex<this.idPositionArray[dimensionIndex].ids.length;idIndex++){if(cell.getId()===this.idPositionArray[dimensionIndex].ids[idIndex]){return dimensionIndex}}}return -1},execute:function(stage){if(this.type==="width"){this.__updateColumnWidth(this.node,this.newWidth)}else{if(this.type==="height"){this.__updateRowHeight(this.node,this.newHeight,true)}else{if(this.type==="table-text-edit"){this.__updateRowHeight(this.node,this.newHeight,false)}}}},undo:function(stage){if(this.type==="width"){this.__updateColumnWidth(this.node,this.oldWidth)}else{if(this.type==="height"){this.__updateRowHeight(this.node,this.oldHeight)}}}})}());(function(){var THRESHOLD=0.05;_gliffy.UpdateLaneCommand=_gliffy.CollapsibleCommand.extend({action:"update_lane",init:function(o){var options=$.extend({selectedNode:null,node:null,sibling:null,nextSibling:null,mousePosition:null},o);this.selectedNodeId=options.selectedNode.getId();this.nodeId=options.node.getId();this.siblingId=options.sibling.getId();this.nextSiblingId=options.nextSibling?options.nextSibling.getId():null;this.mousePosition=options.mousePosition;this.lastNodeWidth=options.node.getWidth();this.lastSiblingWidth=options.sibling.getWidth();this.lastNodeConstraint=options.node.getConstraints().getConstraint(_gliffy.PositionConstraint).px},execute:function(stage){var node=stage.find(this.nodeId),sibling=stage.find(this.siblingId),selectedNode=stage.find(this.selectedNodeId),newValue,width=selectedNode.getWidth(),siblingConstraint,nodeConstraint,sibWidth,nodeWidth,nextSibling=stage.find(this.nextSiblingId),nextSiblingConstraintVal;newValue=selectedNode.worldPointToRatio(this.mousePosition.x,this.mousePosition.y).x;nodeConstraint=node.getConstraints().getConstraint(_gliffy.PositionConstraint);siblingConstraint=sibling.getConstraints().getConstraint(_gliffy.PositionConstraint);nextSiblingConstraintVal=nextSibling?nextSibling.getConstraints().getConstraint(_gliffy.PositionConstraint).px:1;if(newValue>0&&newValue<1&&newValue>siblingConstraint.px+THRESHOLD&&newValue<nextSiblingConstraintVal-THRESHOLD){sibWidth=(newValue-siblingConstraint.px)*width;nodeWidth=((node.getWidth()/width)+(nodeConstraint.px-newValue))*width;sibling.setWidth(sibWidth);sibling.children[0].setWidth(sibWidth);node.setWidth(nodeWidth);node.children[0].setWidth(nodeWidth);nodeConstraint.px=newValue}},undo:function(stage){var node=stage.find(this.nodeId),sibling=stage.find(this.siblingId);node.setWidth(this.lastNodeWidth);node.children[0].setWidth(this.lastNodeWidth);node.getConstraints().getConstraint(_gliffy.PositionConstraint).px=this.lastNodeConstraint;sibling.setWidth(this.lastSiblingWidth);sibling.children[0].setWidth(this.lastSiblingWidth)},collapse:function(command){if(command instanceof _gliffy.UpdateLaneCommand&&this.nodeId===command.nodeId){this.mousePosition=command.mousePosition;return true}else{return false}},__toObject:function(){return{action:this.action,nodeId:this.nodeId,siblingId:this.siblingId,nextSiblingId:this.nextSiblingId,mousePosition:this.mousePosition,lastNodeWidth:this.lastNodeWidth,lastSiblingWidth:this.lastSiblingWidth,lastNodeConstraint:this.lastNodeConstraint}}})}());(function(){_gliffy.UpdateLaneNumberCommand=_gliffy.UndoableCommand.extend({action:"update_lane_number",init:function(o){var options=$.extend({node:null,lanes:1},o);options.node.update();this.nodeId=options.node.getId();this.lanes=options.lanes;this.origWidth=options.node.getWidth();this.origHeight=options.node.getHeight();this.worldTransform=options.node.worldTransform.clone();this.nodeObject=options.node.toObject()},__distanceFromOrigin:function(point,transform,height,width){var p=transform.transformPoint(point.x*width,point.y*height);return Math.sqrt(Math.pow(p.x,2)+Math.pow(p.y,2))},updatePosition:function(node){var points=[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:0,y:1}],topLeft=0,minDistance,i,distance,point,currentPoint,topLeftPoint;node.update();for(i=0;i<points.length;i++){distance=this.__distanceFromOrigin(points[i],node.worldTransform,this.origHeight,this.origWidth);if(!minDistance){minDistance=distance}else{if(distance<minDistance){topLeft=i;minDistance=distance}}}point=this.worldTransform.transformPoint(points[topLeft].x*this.origWidth,points[topLeft].y*this.origHeight);currentPoint=node.worldTransform.transformPoint(points[topLeft].x*node.getWidth(),points[topLeft].y*node.getHeight());node.setX(node.getX()+(point.x-currentPoint.x));node.setY(node.getY()+(point.y-currentPoint.y))},updateLanes:function(stage,reverseOrder){var node=stage.find(this.nodeId),lanes,i,nodes,width,constraint,graphic,laneObject,lane,text,index;if(node.isSwimlane()){lanes=node.children.length-1;if(lanes<this.lanes){width=node.getWidth()/lanes;node.setWidth(width*this.lanes);node.children[0].setWidth(width*this.lanes);node.children[0].children[0].setWidth(width*this.lanes);index=(reverseOrder)?1:node.children.length-1;laneObject=node.children[index].toObject();text=new _gliffy.Node().fromObject(node.getShapeInformation().defaults.copyObject).children[0].children[0].getGraphic().getHTML();for(i=lanes;i<this.lanes;i++){lane=new _gliffy.Node().fromObject(laneObject);lane.setId("auto");lane.children[0].setId("auto");lane.children[0].getGraphic().setHTML(text);lane.setWidth(width);lane.children[0].setWidth(width);if(reverseOrder){node.insertChild(lane,1)}else{node.appendChild(lane)}}width=0;for(i=1;i<node.children.length;i++){constraint=node.children[i].getConstraints().getConstraint(_gliffy.PositionConstraint);constraint.px=width/node.getWidth();width+=node.children[i].getWidth()}}else{if(lanes>this.lanes){if(reverseOrder){nodes=node.children.slice(1,(node.children.length-this.lanes))}else{nodes=node.children.slice(this.lanes+1,node.children.length)}for(i=0;i<nodes.length;i++){new _gliffy.RemoveNodeCommand({node:nodes[i]}).execute(stage)}width=0;for(i=1;i<node.children.length;i++){width+=node.children[i].getWidth()}node.setWidth(width);node.children[0].setWidth(width);node.children[0].children[0].setWidth(width);width=0;for(i=1;i<node.children.length;i++){constraint=node.children[i].getConstraints().getConstraint(_gliffy.PositionConstraint);constraint.px=width/node.getWidth();width+=node.children[i].getWidth()}}}this.updatePosition(node)}},execute:function(stage){var node=stage.find(this.nodeId),reverseOrder=(node.getRotation()>135&&node.getRotation()<315);if(node.isSwimlane()){this.updateLanes(stage,reverseOrder)}},undo:function(stage){var node=stage.find(this.nodeId);while(node.children.length>1){if(node.children[node.children.length-1]){new _gliffy.RemoveNodeCommand({node:node.children[node.children.length-1]}).execute(stage)}}node.fromObject(this.nodeObject)},__toObject:function(){return{action:this.action,nodeId:this.nodeId,lanes:this.lanes,origWidth:this.origWidth,origHeight:this.origHeight,worldTransform:this.worldTransform,nodeObject:this.nodeObject}}})}());(function(){function recompute(group,newBoundingBox){var i,child,offset=_gliffy.Vec2.difference(group.aabb.min,newBoundingBox.min),dimension;for(i=0;i<group.children.length;i++){child=group.children[i];child.setX(child.getX()+offset.x);child.setY(child.getY()+offset.y)}dimension=newBoundingBox.getDimension();group.setX(group.getX()-offset.x);group.setY(group.getY()-offset.y);group.setWidth(dimension.x);group.setHeight(dimension.y)}_gliffy.UpdateGroupBoundsCommand=_gliffy.UndoableCommand.extend({action:"update_group_bounds",init:function(o){var options=$.extend({node:null},o);this.nodeId=options.node.getId();this.startAabb=options.node.aabb.clone();this.endAabb=options.node.getChildrenAabb()},execute:function(stage){var group=stage.find(this.nodeId);recompute(group,this.endAabb)},undo:function(stage){var group=stage.find(this.nodeId);recompute(group,this.startAabb)},__toObject:function(){return{action:this.action,nodeId:this.nodeId,startAabb:this.startAabb,endAabb:this.endAabb}}})}());(function(){var THRESHOLD=20;_gliffy.ScaleSwimlaneCommand=_gliffy.CollapsibleCommand.extend({action:"scale_swimlane",init:function(o){var options=$.extend({node:null,scaleX:1,scaleY:1,x:0,y:0,overlayCoords:{x:0,y:0}},o);this.nodeId=options.node.getId();this.overlayCoords=options.overlayCoords;this.scaleX=options.scaleX;this.scaleY=options.scaleY;this.width=options.node.getWidth();this.height=options.node.getHeight();this.x=options.x;this.y=options.y;this.undoX=options.node.getX();this.undoY=options.node.getY();this.originalLaneWidth=this.overlayCoords.x===0?options.node.children[1].getWidth():options.node.children[options.node.children.length-1].getWidth()},execute:function(stage){var node=stage.find(this.nodeId),width=this.scaleX*node.getWidth(),diff=width-node.getWidth(),i,child,positionConstraint,widthCounter=0,laneToUpdate=this.overlayCoords.x===0?node.children[1]:node.children[node.children.length-1],laneSize=laneToUpdate.getWidth()+diff;if(node&&laneSize>THRESHOLD){node.setWidth(width);node.children[0].setWidth(width);node.children[0].children[0].setWidth(width);node.setScaleY(this.scaleY);node.setX(this.x);node.setY(this.y);laneToUpdate.setWidth(laneSize);laneToUpdate.children[0].setWidth(laneSize);for(i=1;i<node.children.length;i++){child=node.children[i];positionConstraint=child.getConstraints().getConstraint(_gliffy.PositionConstraint);if(positionConstraint){positionConstraint.px=widthCounter/width}widthCounter+=child.getWidth()}}},undo:function(stage){var node=stage.find(this.nodeId),laneToUpdate=this.overlayCoords.x===0?node.children[1]:node.children[node.children.length-1],child,positionConstraint,widthCounter=0,i;if(node){node.setWidth(this.width);node.children[0].setWidth(this.width);node.children[0].children[0].setWidth(this.width);node.setScaleY(1/this.scaleY);node.setX(this.undoX);node.setY(this.undoY);laneToUpdate.setWidth(this.originalLaneWidth);laneToUpdate.children[0].setWidth(this.originalLaneWidth);for(i=1;i<node.children.length;i++){child=node.children[i];positionConstraint=child.getConstraints().getConstraint(_gliffy.PositionConstraint);if(positionConstraint){positionConstraint.px=widthCounter/this.width}widthCounter+=child.getWidth()}}},collapse:function(command,stage){if(command instanceof _gliffy.ScaleSwimlaneCommand&&this.nodeId===command.nodeId&&command.overlayCoords.x===this.overlayCoords.x&&command.overlayCoords.y===this.overlayCoords.y){var node=stage.find(command.nodeId),width=command.scaleX*node.getWidth(),diff=width-node.getWidth(),i,laneToUpdate=command.overlayCoords.x===0?node.children[1]:node.children[node.children.length-1],laneSize=laneToUpdate.getWidth()+diff;if(node&&laneSize>THRESHOLD){this.scaleX*=command.scaleX;this.scaleY*=command.scaleY;this.x=command.x;this.y=command.y}return true}else{return false}},__toObject:function(){return{action:this.action,nodeId:this.nodeID,overlayCoords:this.overlayCoords,scaleX:this.scaleX,scaleY:this.scaleY,width:this.width,height:this.height,x:this.x,y:this.y,undoX:this.undoX,undoY:this.undoY,originalLaneWidth:this.originalLaneWidth}}})}());(function(){_gliffy.SetPageColorCommand=_gliffy.UndoableCommand.extend({action:"page_color",init:function(o){if(Ember&&Ember.isArray(o)&&o.length>0){o=o[0]}var options=$.extend({stage:null,background:"#FFFFFF"},o);this.undoBackground=options.stage.background;this.background=options.background},execute:function(stage){stage.setBackground(this.background);this.__markLinesDirty(stage)},undo:function(stage){stage.setBackground(this.undoBackground);this.__markLinesDirty(stage)},__markLinesDirty:function(stage){var lines,line,i;lines=stage.findGraphic(_gliffy.Line);for(i=0;i<lines.length;i++){line=lines[i];if(line.getGraphic().getStartArrowTid()!==null||line.getGraphic().getEndArrowTid()!==null||(line.children&&line.children.length>0)){line.getGraphic().markDirty()}}},__toObject:function(){return{action:this.action,background:this.background,undoBackground:this.undoBackground}}})}());(function(){_gliffy.SetPageWidthCommand=_gliffy.UndoableCommand.extend({action:"page_width",init:function(o){if(Ember&&Ember.isArray(o)&&o.length>0){o=o[0]}var options=$.extend({stage:null,width:0},o);this.width=options.width;this.undoWidth=options.stage.maxWidth},execute:function(stage){stage.setMaxWidth(this.width)},undo:function(stage){stage.setMaxWidth(this.undoWidth)},__toObject:function(){return{action:this.action,width:this.width,undoWidth:this.undoWidth}}})}());(function(){_gliffy.SetPageHeightCommand=_gliffy.UndoableCommand.extend({action:"page_height",init:function(o){if(Ember&&Ember.isArray(o)&&o.length>0){o=o[0]}var options=$.extend({stage:null,height:0},o);this.height=options.height;this.undoHeight=options.stage.maxHeight},execute:function(stage){stage.setMaxHeight(this.height)},undo:function(stage){stage.setMaxHeight(this.undoHeight)},__toObject:function(){return{action:this.action,height:this.height,undoHeight:this.undoHeight}}})}());(function(){_gliffy.CleanSwimlanePositions=_gliffy.Command.extend({action:"clean_swimlane_positions",init:function(o){var i,options=$.extend({nodes:null},o);this.nodeIds=[];for(i=0;i<options.nodes.length;i++){this.nodeIds.push(options.nodes[i].getId())}},execute:function(stage){var node,n,i,currentLane,sibling,siblingConstraint,rounded,width;for(n=0;n<this.nodeIds.length;n++){node=stage.find(this.nodeIds[n]);if(node.isSwimlane()){width=0;for(i=1;i<node.children.length;i++){currentLane=node.children[i];sibling=(i+1<node.children.length)?node.children[i+1]:null;rounded=Math.round(currentLane.getWidth());if(currentLane.getWidth()!==rounded){if(sibling){siblingConstraint=sibling.getConstraints().getConstraint(_gliffy.PositionConstraint);siblingConstraint.px=(width+rounded)/node.getWidth()}else{rounded=node.getWidth()-width}currentLane.setWidth(rounded);currentLane.children[0].setWidth(rounded)}width+=currentLane.getWidth()}}}},__toObject:function(){return{action:this.action,nodeIds:this.nodeIds}}})}());(function(){_gliffy.UpdateThemeCommand=_gliffy.UndoableCommand.extend({action:"update_theme",stageObject:null,stageUndoObject:null,init:function(o){if(Ember&&Ember.isArray(o)&&o.length>0){o=o[0]}var options=$.extend({stageObject:null,stageUndoObject:null},o);this.stageObject=options.stageObject;this.stageUndoObject=options.stageUndoObject},execute:function(stage){stage.fromObject(this.stageObject)},undo:function(stage){stage.fromObject(this.stageUndoObject)},__toObject:function(){return{action:this.action,stageObject:this.stageObject,stageUndoObject:this.stageUndoObject}}})}());(function(){_gliffy.UpdateElementCountTabShapeCommand=_gliffy.UndoableCommand.extend({className:"UpdateElementCountTabShapeCommand",action:"update_element_count_tab_shape_command",init:function(o){var options=$.extend({node:null,cellCount:3},o);if(options.node){options.node.update();this.nodeId=options.node.getId();this.nodeObject=options.node.toObject();this.cellCount=options.cellCount;this.undoCellCount=options.node.children.length;this.tids={first:options.tids.first,middle:options.tids.middle,last:options.tids.last,single:options.tids.single,odd:options.tids.odd,even:options.tids.even}}else{_gliffy.Logger.warn("Failed to initialize "+this.className)}},execute:function(stage){var node;node=stage.find(this.nodeId);if(node){if(this.cellCount!==this.undoCellCount){this._updateCellCount(node,stage);this._updateConstraints(node);this._updateTids(node)}this._resolveColorConflicts(node)}},getSelected:function(node){var childIndex;for(childIndex=0;childIndex<node.children.length;childIndex++){if(node.children[childIndex].getGraphic().getState()===1){return childIndex+1}}return 0},getDeselectedColor:function(node){var childIndex,selected;selected=this.getSelected(node);if(selected===1&&node.children.length===1){return this.deselectedColor}else{if(selected>0&&node.children.length>0){for(childIndex=0;childIndex<node.children.length;childIndex++){if(childIndex+1!==selected){return node.children[childIndex].getGraphic().getFillColor()}}}else{return node.children[0].getGraphic().getFillColor()}}},getSelectedColor:function(){return GliffyApp.selectedTabV2Model.get("selectedColor")},_resolveColorConflicts:function(node){var cell,childIndex,cellColor,cellTextColor,deselectedColor,selectedColor,textNode;for(childIndex=0;childIndex<node.children.length;childIndex++){cell=node.children[childIndex];textNode=cell.getFirstTopLevelNodeWithGraphic(_gliffy.Text);cellColor=new _gliffy.RGBColor(cell.getGraphic().getFillColor()).toHex();cellTextColor=new _gliffy.RGBColor(textNode.getGraphic().getFirstColor()).toHex();if(cellColor===cellTextColor){deselectedColor=new _gliffy.RGBColor(this.getSelectedColor(node)).toHex();selectedColor=new _gliffy.RGBColor(this.getDeselectedColor(node)).toHex();switch(cellColor){case deselectedColor:textNode.getGraphic().setFirstColor(selectedColor);break;case selectedColor:default:textNode.getGraphic().setFirstColor(deselectedColor);break}}}},_updateCellCount:function(node,stage){var cell,child,childIndex,childObject,constraint,nodes;if(this.cellCount<this.undoCellCount){nodes=node.children.slice(this.cellCount,node.children.length);for(childIndex=0;childIndex<nodes.length;childIndex++){child=nodes[childIndex];new _gliffy.RemoveNodeCommand({node:child}).execute(stage)}}else{if(this.undoCellCount<this.cellCount){childObject=new _gliffy.Node().fromObject(node.children[node.children.length-1].toObject()).toObject();for(childIndex=node.children.length;childIndex<this.cellCount;childIndex++){cell=new _gliffy.Node().fromObject(childObject);cell.setId("auto");cell.children[0].setId("auto");cell.getGraphic().setFillColor(this.getDeselectedColor(node));cell.getGraphic().setStrokeColor(node.children[0].getGraphic().getStrokeColor());cell.setHeight(node.getHeight());cell.children[0].setHeight(node.getHeight());constraint=cell.getConstraints().getConstraint(_gliffy.PositionConstraint);constraint.nodeId=node.getId();node.appendChild(cell)}}}},_updateConstraints:function(node){var cell,cellWidth,childIndex,constraint;cellWidth=node.getWidth()/node.children.length;for(childIndex=0;childIndex<node.children.length;childIndex++){cell=node.children[childIndex];constraint=cell.getConstraints().getConstraint(_gliffy.PositionConstraint);constraint.px=childIndex*(1/node.children.length);constraint.nodeId=this.nodeId;cell.setWidth(cellWidth);cell.children[0].setWidth(cellWidth)}},_updateTids:function(node){var cell,childIndex;for(childIndex=0;childIndex<node.children.length;childIndex++){cell=node.children[childIndex];if(node.children.length===1){cell.getGraphic().setTid(this.tids.single)}else{if(childIndex===0){cell.getGraphic().setTid(this.tids.first)}else{if(childIndex===node.children.length-1){cell.getGraphic().setTid(this.tids.last)}else{cell.getGraphic().setTid(this.tids.middle)}}}}},undo:function(stage){var node=stage.find(this.nodeId);if(node){while(node.children.length>0){if(node.children[node.children.length-1]){new _gliffy.RemoveNodeCommand({node:node.children[node.children.length-1]}).execute(stage)}}node.fromObject(this.nodeObject)}},getItems:function(node){return node.children.length},__toObject:function(){return{nodeId:this.nodeId,cellCount:this.cellCount,nodeObject:this.nodeObject}}})}());(function(){_gliffy.UpdateSelectedTabV2ShapeCommand=_gliffy.UpdateElementCountTabShapeCommand.extend({action:"update_selected_tab_v2_shape_command",init:function(options){var options=$.extend({selectedColor:"#EEEEEE",deselectedColor:"#FFFFFF",selected:2},options);options.node.update();this.selected=options.selected;this.selectedColor=options.selectedColor;this.deselectedColor=options.deselectedColor;this.undoCells=this.getItems(options.node);this.undoSelected=this.getSelected(options.node);($.proxy(_gliffy.UpdateElementCountTabShapeCommand.prototype.init,this,options))()},execute:function(stage){var node;node=stage.find(this.nodeId);if(node){this.updateSelectedTab(node)}($.proxy(_gliffy.UpdateElementCountTabShapeCommand.prototype.execute,this,stage))()},updateSelectedTab:function(node){var deselectedColor,selectedColor;selectedColor=this.getSelectedColor(node);deselectedColor=this.getDeselectedColor(node);if(this.selected!==this.undoSelected){var newSelectedNode,oldSelectedNode;if(this.undoSelected>0&&this.undoSelected<=node.children.length){oldSelectedNode=node.children[this.undoSelected-1];oldSelectedNode.getGraphic().setState(0);oldSelectedNode.getGraphic().setFillColor(deselectedColor)}if(this.selected>0&&this.selected<=node.children.length){newSelectedNode=node.children[this.selected-1];newSelectedNode.getGraphic().setState(1);newSelectedNode.getGraphic().setFillColor(selectedColor)}}},__toObject:function(){return{nodeId:this.nodeId,cellCount:this.cellCount,selected:this.selected,nodeObject:this.nodeObject}}})}());(function(){_gliffy.ExecuteWithoutResolvingColorConflictsCommandModule={execute:function(stage){var node;node=stage.find(this.nodeId);if(node){if(this.cellCount!==this.undoCellCount){this._updateCellCount(node,stage);this._updateConstraints(node);this._updateTids(node)}if(this.selected!==this.undoSelected){this.updateSelectedTab(node)}}}}}());(function(){_gliffy.UpdateExpandingVerticalListConstraintsCommandModule={_updateConstraints:function(node){var child,childIndex,childPositionConstraint,elementCount,newNodeHeight,nodeHeightConstraint,overlay;elementCount=node.children.length;for(childIndex=0;childIndex<elementCount;childIndex++){child=node.children[childIndex];childPositionConstraint=child.getConstraints().getConstraint(_gliffy.PositionConstraint);childPositionConstraint.py=childIndex*(1/elementCount);childPositionConstraint.nodeId=this.nodeId;child.setScaleX(1);child.setScaleY(1)}nodeHeightConstraint=node.getConstraints().getConstraint(_gliffy.ConstHeightConstraint);node.getConstraints().remove(nodeHeightConstraint);overlay=_gliffy.Mouse.editor.overlayManager.getActiveOverlay();newNodeHeight=elementCount*node.children[0].getHeight();overlay.setScaleY(newNodeHeight)}}}());(function(){_gliffy.UpdateVerticalListConstraintsCommandModule={_updateConstraints:function(node){var cell,cellHeight,childIndex,constraint;cellHeight=node.getHeight()/node.children.length;for(childIndex=0;childIndex<node.children.length;childIndex++){cell=node.children[childIndex];constraint=cell.getConstraints().getConstraint(_gliffy.PositionConstraint);constraint.py=childIndex*(1/node.children.length);constraint.nodeId=this.nodeId;cell.setHeight(cellHeight);cell.children[0].setHeight(cellHeight)}}}}());(function(){_gliffy.UpdateAlternatingTidsCommandModule={_updateTids:function(node){var cell,childIndex;for(childIndex=0;childIndex<node.children.length;childIndex++){cell=node.children[childIndex];if(childIndex%2===0){cell.getGraphic().setTid(this.tids.odd)}else{cell.getGraphic().setTid(this.tids.even)}}}}}());(function(){_gliffy.UpdateSingleTidCommandModule={_updateTids:function(node){var cell,cellIndex;for(cellIndex=0;cellIndex<node.children.length;cellIndex++){cell=node.children[cellIndex];cell.getGraphic().setTid(this.tids.single)}}}}());(function(){_gliffy.UpdateTextColorWithSelectedTabFillCommandModule={updateSelectedTab:function(node){var deselectedColor,selectedColor;selectedColor=this.getSelectedColor(node);deselectedColor=this.getDeselectedColor(node);if(this.selected!==this.undoSelected){var newSelectedNode,newSelectedNodeText,oldSelectedNode,oldSelectedNodeText;if(this.undoSelected>0&&this.undoSelected<=node.children.length){oldSelectedNode=node.children[this.undoSelected-1];oldSelectedNodeText=oldSelectedNode.children[0].getGraphic();oldSelectedNode.getGraphic().setState(0);oldSelectedNode.getGraphic().setFillColor(deselectedColor);oldSelectedNodeText.setFirstColor("#999999")}if(this.selected>0&&this.selected<=node.children.length){newSelectedNode=node.children[this.selected-1];newSelectedNodeText=newSelectedNode.children[0].getGraphic();newSelectedNode.getGraphic().setState(1);newSelectedNode.getGraphic().setFillColor(selectedColor);newSelectedNodeText.setFirstColor(selectedColor)}}}}}());(function(){_gliffy.UpdateNavbarCommand=_gliffy.UpdateSelectedTabV2ShapeCommand.extend({action:"update_dropdown_command",init:function(o){var options=$.extend({node:null,cellCount:3,selected:1,selectedColor:"#EEEEEE",deselectedColor:"#FFFFFF",tids:{first:"com.gliffy.stencil.ui.ui_v3.navigation.navbar_left",middle:"com.gliffy.stencil.ui.ui_v3.navigation.navbar",last:"com.gliffy.stencil.ui.ui_v3.navigation.navbar_right",single:"com.gliffy.stencil.ui.ui_v3.navigation.navbar_single"}},o);($.proxy(_gliffy.UpdateSelectedTabV2ShapeCommand.prototype.init,this,options))()}})}());(function(){var SELECTED_COLOR="#DBEEFB",DESELECTED_COLOR="#FFFFFF";_gliffy.UpdateDropdownCommand=_gliffy.UndoableCommand.extend({action:"update_dropdown_command",init:function(o){var options=$.extend({node:null,cells:3,selected:1},o);options.node.update();this.nodeId=options.node.getId();this.nodeObject=options.node.toObject();this.cells=options.cells;this.selected=options.selected;this.undoCells=this.getItems(options.node);this.undoSelected=this.getSelected(options.node)},execute:function(stage){var node=stage.find(this.nodeId),nodes,i,childObject,cell,constraint,selectedColor,deselectedColor;selectedColor=this.getSelectedColor(node);deselectedColor=this.getDeselectedColor(node);if(this.cells!==this.undoCells){if(this.cells<this.undoCells){nodes=node.children.slice(this.cells,node.children.length);constraint=node.getConstraints().getConstraint(_gliffy.ConstHeightConstraint);for(i=0;i<nodes.length;i++){constraint.height=constraint.height-nodes[i].getHeight();new _gliffy.RemoveNodeCommand({node:nodes[i]}).execute(stage)}node.markDirty()}else{if(node.children.length<this.cells){childObject=new _gliffy.Node().fromObject(node.getShapeInformation().defaults.copyObject).children[0].toObject();for(i=node.children.length;i<this.cells;i++){cell=new _gliffy.Node().fromObject(childObject);cell.setId("auto");cell.children[0].setId("auto");cell.getGraphic().setFillColor(deselectedColor);constraint=cell.getConstraints().getConstraint(_gliffy.PositionConstraint);constraint.nodeId=node.children[i-1].getId();constraint.py=1;constraint.xOffset=0;constraint.yOffset=0;cell.getConstraints().getConstraint(_gliffy.WidthConstraint).widthInfo[0].id=node.getId();cell.children[0].getConstraints().getConstraint(_gliffy.WidthConstraint).widthInfo[0].id=node.children[0].getId();node.appendChild(cell);constraint=node.getConstraints().getConstraint(_gliffy.ConstHeightConstraint);constraint.height=constraint.height+cell.getHeight();node.markDirty()}}}}else{if(this.selected!==this.undoSelected){if(this.undoSelected>0&&this.undoSelected<=node.children.length){node.children[this.undoSelected-1].getGraphic().setState(0);node.children[this.undoSelected-1].getGraphic().setFillColor(deselectedColor)}if(this.selected>0){node.children[this.selected-1].getGraphic().setFillColor(selectedColor);node.children[this.selected-1].getGraphic().setState(1)}}}},undo:function(stage){var node=stage.find(this.nodeId);while(node.children.length>0){if(node.children[node.children.length-1]){new _gliffy.RemoveNodeCommand({node:node.children[node.children.length-1]}).execute(stage)}}node.fromObject(this.nodeObject)},getItems:function(node){return node.children.length},getSelected:function(node){for(var i=0;i<node.children.length;i++){if(node.children[i].getGraphic().getState()===1){return i+1}}return 0},getDeselectedColor:function(node){var selected=this.getSelected(node),i;if(selected===1&&node.children.length===1){return DESELECTED_COLOR}else{if(selected>0&&node.children.length>0){for(i=0;i<node.children.length;i++){if(i+1!==selected){return node.children[i].getGraphic().getFillColor()}}}else{return node.children[0].getGraphic().getFillColor()}}},getSelectedColor:function(node){var selected=this.getSelected(node);return selected===0?SELECTED_COLOR:node.children[selected-1].getGraphic().getFillColor()},__toObject:function(){return{nodeId:this.nodeId,cells:this.cells,selected:this.selected,nodeObject:this.nodeObject}}})}());(function(){_gliffy.UpdateButtonStackCommand=_gliffy.UndoableCommand.extend({action:"update_button_stack_command",init:function(o){var options=$.extend({node:null,cellCount:3},o);if(options.node){options.node.update();this.nodeId=options.node.getId();this.nodeObject=options.node.toObject();this.cellCount=options.cellCount;this.undoCellCount=options.node.children.length}else{_gliffy.Logger.warn("Failed to initialize UpdateButtonStackCommand")}},execute:function(stage){var cell,cellHeight,cellIndex,constraint,copyCell,node,nodeHeightConstraint,previousCell;node=stage.find(this.nodeId);if(node){if(this.cellCount!==this.undoCellCount){if(this.cellCount<this.undoCellCount){for(cellIndex=node.children.length-1;cellIndex>=this.cellCount;cellIndex--){cell=node.children[cellIndex];cellHeight=node.children[cellIndex].getHeight();new _gliffy.RemoveNodeCommand({node:cell}).execute(stage);nodeHeightConstraint=node.getConstraints().getConstraint(_gliffy.ConstHeightConstraint);nodeHeightConstraint.height-=cellHeight}node.children[cellIndex].getGraphic().setTid("com.gliffy.stencil.rectangle.no_fill_no_line_v1");node.markDirty()}else{if(this.undoCellCount<this.cellCount){copyCell=new _gliffy.Node().fromObject(node.getShapeInformation().defaults.copyObject).children[0].toObject();for(cellIndex=this.undoCellCount;cellIndex<this.cellCount;cellIndex++){cell=new _gliffy.Node().fromObject(copyCell);cell.setId("auto");cell.children[0].setId("auto");previousCell=node.children[cellIndex-1];constraint=cell.getConstraints().getConstraint(_gliffy.PositionConstraint);constraint.nodeId=previousCell.getId();constraint.py=1;cellHeight=cell.getHeight();node.appendChild(cell);nodeHeightConstraint=node.getConstraints().getConstraint(_gliffy.ConstHeightConstraint);nodeHeightConstraint.height+=cellHeight;previousCell.getGraphic().setTid("com.gliffy.stencil.rectangle.no_fill_line_bottom_v1");cell.getGraphic().setTid("com.gliffy.stencil.rectangle.no_fill_no_line_v1")}node.markDirty()}}}}},undo:function(stage){var node=stage.find(this.nodeId);if(node){while(node.children.length>0){if(node.children[node.children.length-1]){new _gliffy.RemoveNodeCommand({node:node.children[node.children.length-1]}).execute(stage)}}node.fromObject(this.nodeObject)}},getItems:function(node){return node.children.length},__toObject:function(){return{nodeId:this.nodeId,cellCount:this.cellCount,nodeObject:this.nodeObject}}})}());(function(){_gliffy.UpdateIphoneContextualMenuCommand=_gliffy.UndoableCommand.extend({action:"update_tabbed_shape_command",init:function(o){var options=$.extend({node:null,cellCount:3},o);if(options.node){options.node.update();this.nodeId=options.node.getId();this.nodeObject=options.node.toObject();this.cellCount=options.cellCount;this.undoCellCount=this.getItems(options.node)}else{_gliffy.Logger.warn("Failed to initialize UpdateIphoneContextualMenuCommand")}},execute:function(stage){var cell,cellIndex,cellWidth,cells,constraint,copyCell,copyObject,node;node=stage.find(this.nodeId);if(node){if(this.cellCount!==this.undoCellCount){if(this.cellCount<this.undoCellCount){cells=this.getChildren(node);for(cellIndex=cells.length-1;cellIndex>=this.cellCount;cellIndex--){cell=cells[cellIndex];cellWidth=cell.getWidth();new _gliffy.RemoveNodeCommand({node:cell}).execute(stage)}}else{if(this.undoCellCount<this.cellCount){copyObject=new _gliffy.Node().fromObject(node.getShapeInformation().defaults.copyObject);copyCell=this.getChildren(copyObject)[1].toObject();for(cellIndex=this.undoCellCount;cellIndex<this.cellCount;cellIndex++){cell=new _gliffy.Node().fromObject(copyCell);cell.setId("auto");cell.children[0].setId("auto");cell.getGraphic().setFillColor(this.getFillColor(node));cell.getGraphic().setStrokeColor(this.getStrokeColor(node));cell.setHeight(this.getChildren(node)[0].getHeight());cell.children[0].setHeight(node.getHeight());constraint=cell.getConstraints().getConstraint(_gliffy.PositionConstraint);constraint.nodeId=node.children[0].getId();node.children[0].appendChild(cell)}}}cells=this.getChildren(node);cellWidth=node.getWidth()/cells.length;node.children[0].setWidth(node.getWidth());for(cellIndex=0;cellIndex<this.getChildren(node).length;cellIndex++){cell=cells[cellIndex];constraint=cell.getConstraints().getConstraint(_gliffy.PositionConstraint);constraint.px=cellIndex*(1/cells.length);if(cellIndex!==0){cell.getGraphic().setTid("com.gliffy.stencil.ui.ui_v3.navigation.navbar")}cell.setWidth(cellWidth);cell.children[0].setWidth(cellWidth)}node.markDirty()}}},undo:function(stage){var node=stage.find(this.nodeId);if(node){while(this.getItems(node)>0){if(this.getChildren(node)[this.getItems(node)-1]){new _gliffy.RemoveNodeCommand({node:this.getChildren(node)[this.getItems(node)-1]}).execute(stage)}}node.fromObject(this.nodeObject)}},getFillColor:function(node){return this.getChildren(node)[0].getGraphic().getFillColor()},getStrokeColor:function(node){return this.getChildren(node)[0].getGraphic().getStrokeColor()},getItems:function(node){return this.getChildren(node).length},getChildren:function(node){return node.children[0].children},__toObject:function(){return{nodeId:this.nodeId,cellCount:this.cellCount,nodeObject:this.nodeObject}}})}());(function(){_gliffy.UpdateIphoneTableCommand=_gliffy.UpdateElementCountTabShapeCommand.extend($.extend({className:"UpdateIphoneTableCommand",action:"update_iphone_table_command",init:function(options){options=$.extend({tids:{single:"com.gliffy.stencil.iphone.iphone_ios7.partial_shapes.table_row"}},options);($.proxy(_gliffy.UpdateElementCountTabShapeCommand.prototype.init,this,options))()}},_gliffy.ExecuteWithoutResolvingColorConflictsCommandModule,_gliffy.UpdateExpandingVerticalListConstraintsCommandModule,_gliffy.UpdateSingleTidCommandModule))}());(function(){_gliffy.UpdateAndroidList1LineCommand=_gliffy.UpdateElementCountTabShapeCommand.extend($.extend({className:"UpdateAndroidList1LineCommand",action:"update_android_tabs_01_command",init:function(options){options=$.extend({tids:{odd:"com.gliffy.stencil.rectangle.white_no_line_opacity_68",even:"com.gliffy.stencil.rectangle.no_fill_no_line_v1"}},options);($.proxy(_gliffy.UpdateElementCountTabShapeCommand.prototype.init,this,options))()},superClass:_gliffy.UpdateElementCountTabShapeCommand},_gliffy.UpdateAlternatingTidsCommandModule,_gliffy.UpdateVerticalListConstraintsCommandModule))}());(function(){_gliffy.UpdateAndroidList2LineCommand=_gliffy.UpdateElementCountTabShapeCommand.extend($.extend({className:"UpdateAndroidList2LineCommand",action:"update_android_tabs_02_command",init:function(options){options=$.extend({tids:{odd:"com.gliffy.stencil.rectangle.fill_no_line_circle_left",even:"com.gliffy.stencil.rectangle.no_fill_no_line_circle_left"}},options);($.proxy(_gliffy.UpdateElementCountTabShapeCommand.prototype.init,this,options))()}},_gliffy.UpdateAlternatingTidsCommandModule,_gliffy.UpdateVerticalListConstraintsCommandModule))}());(function(){_gliffy.UpdateAndroidTabs01Command=_gliffy.UpdateElementCountTabShapeCommand.extend($.extend({className:"UpdateAndroidTabs01Command",action:"update_android_tabs_01_command",init:function(options){options=$.extend({tids:{single:"com.gliffy.stencil.rectangle.no_fill_no_line_v1"}},options);($.proxy(_gliffy.UpdateElementCountTabShapeCommand.prototype.init,this,options))()}},_gliffy.UpdateSingleTidCommandModule))}());(function(){_gliffy.UpdateAndroidTabs02Command=_gliffy.UpdateNavbarCommand.extend($.extend({className:"UpdateAndroidTabs01Command",action:"update_android_tabs_01_command",init:function(options){options=$.extend({tids:{single:"com.gliffy.stencil.rectangle.no_fill_line_bottom_2px_off"}},options);($.proxy(_gliffy.UpdateNavbarCommand.prototype.init,this,options))()}},_gliffy.ExecuteWithoutResolvingColorConflictsCommandModule,_gliffy.UpdateTextColorWithSelectedTabFillCommandModule,_gliffy.UpdateSingleTidCommandModule))}());(function(){var SELECTED_COLOR="#EEEEEE",DESELECTED_COLOR="#FFFFFF";_gliffy.UpdateNavbarVerticalCommand=_gliffy.UndoableCommand.extend({action:"update_dropdown_command",init:function(o){var options=$.extend({node:null,cells:3,selected:1},o);options.node.update();this.nodeId=options.node.getId();this.nodeObject=options.node.toObject();this.cells=options.cells;this.selected=options.selected;this.undoCells=this.getItems(options.node);this.undoSelected=this.getSelected(options.node)},execute:function(stage){var node=stage.find(this.nodeId),nodes,i,childObject,cell,constraint,cellWidth,selectedColor,deselectedColor;selectedColor=this.getSelectedColor(node);deselectedColor=this.getDeselectedColor(node);if(this.cells!==this.undoCells){if(this.cells<this.undoCells){nodes=node.children.slice(this.cells,node.children.length);constraint=node.getConstraints().getConstraint(_gliffy.ConstHeightConstraint);for(i=0;i<nodes.length;i++){constraint.height=constraint.height-nodes[i].getHeight();new _gliffy.RemoveNodeCommand({node:nodes[i]}).execute(stage)}node.setHeight(constraint.height)}else{if(node.children.length<this.cells){childObject=new _gliffy.Node().fromObject(node.getShapeInformation().defaults.copyObject).children[0].toObject();for(i=node.children.length;i<this.cells;i++){cell=new _gliffy.Node().fromObject(childObject);cell.setId("auto");cell.children[0].setId("auto");cell.getGraphic().setFillColor(deselectedColor);cell.getGraphic().setStrokeColor(node.children[0].getGraphic().getStrokeColor());constraint=cell.getConstraints().getConstraint(_gliffy.PositionConstraint);constraint.nodeId=node.children[i-1].getId();constraint.py=1;constraint.xOffset=0;constraint.yOffset=0;cell.getConstraints().getConstraint(_gliffy.WidthConstraint).widthInfo[0].id=node.getId();cell.children[0].getConstraints().getConstraint(_gliffy.WidthConstraint).widthInfo[0].id=node.children[0].getId();node.appendChild(cell);constraint=node.getConstraints().getConstraint(_gliffy.ConstHeightConstraint);constraint.height=constraint.height+cell.getHeight()}}}for(i=0;i<node.children.length;i++){cell=node.children[i];if(node.children.length===1){cell.getGraphic().setTid("com.gliffy.stencil.ui.ui_v3.navigation.navbar_vertical.cell_rounded")}else{if(i===0&&node.children.length>1){cell.getGraphic().setTid("com.gliffy.stencil.ui.ui_v3.navigation.navbar_vertical.cell_top")}else{if(i===node.children.length-1){cell.getGraphic().setTid("com.gliffy.stencil.ui.ui_v3.navigation.navbar_vertical.cell_bottom")}else{cell.getGraphic().setTid("com.gliffy.stencil.ui.ui_v3.navigation.navbar_vertical.cell")}}}}}else{if(this.selected!==this.undoSelected){if(this.undoSelected>0&&this.undoSelected<=node.children.length){node.children[this.undoSelected-1].getGraphic().setState(0);node.children[this.undoSelected-1].getGraphic().setFillColor(deselectedColor)}if(this.selected>0){node.children[this.selected-1].getGraphic().setFillColor(selectedColor);node.children[this.selected-1].getGraphic().setState(1)}}}},undo:function(stage){var node=stage.find(this.nodeId);while(node.children.length>0){if(node.children[node.children.length-1]){new _gliffy.RemoveNodeCommand({node:node.children[node.children.length-1]}).execute(stage)}}node.fromObject(this.nodeObject)},getItems:function(node){return node.children.length},getSelected:function(node){for(var i=0;i<node.children.length;i++){if(node.children[i].getGraphic().getState()===1){return i+1}}return 0},getDeselectedColor:function(node){var selected=this.getSelected(node),i;if(selected===1&&node.children.length===1){return DESELECTED_COLOR}else{if(selected>0&&node.children.length>0){for(i=0;i<node.children.length;i++){if(i+1!==selected){return node.children[i].getGraphic().getFillColor()}}}else{return node.children[0].getGraphic().getFillColor()}}},getSelectedColor:function(node){var selected=this.getSelected(node);return selected===0?SELECTED_COLOR:node.children[selected-1].getGraphic().getFillColor()},__toObject:function(){return{nodeId:this.nodeId,cells:this.cells,selected:this.selected,nodeObject:this.nodeObject}}})}());(function(){var MAX_STORED_COMMANDS=1000;_gliffy.clipboard=null;_gliffy.CommandHistory=_gliffy.Class.extend({_commands:null,_redo:null,_bundle:null,_bundleStackCount:0,stage:null,init:function(stage){this.stage=stage;this._commands=[];this._redo=[]},addAndExecuteCommand:function(command){var commandStack=this._bundle||this._commands,lastCommand,collapsed=false,tmp,i;if(!(command instanceof _gliffy.Command)){throw new Error("cannot add non-command to command history: "+command)}if(commandStack.length>0){lastCommand=commandStack[commandStack.length-1];if(command instanceof _gliffy.RemoveNodeCommand&&lastCommand instanceof _gliffy.BundledCommand){tmp=lastCommand.commands[lastCommand.commands.length-1];if(tmp instanceof _gliffy.AddNodeCommand){lastCommand=tmp}}else{if(command instanceof _gliffy.SetTextCommand&&lastCommand!==_gliffy.AddNodeCommand){for(i=commandStack.length-1;i>=0;i--){lastCommand=commandStack[i];if(lastCommand instanceof _gliffy.AddNodeCommand){break}}}}if(lastCommand instanceof _gliffy.CollapsibleCommand&&command instanceof _gliffy.CollapsibleCommand){collapsed=lastCommand.collapse(command,this.stage)}}if(!collapsed&&!(command instanceof _gliffy.CopyCommand)){commandStack.push(command)}while(this._commands.length>MAX_STORED_COMMANDS){this._commands.shift()}if(!this._bundle&&!(command instanceof _gliffy.CopyCommand)){this.stage.setUnsavedChanges(true)}command.execute(this.stage);this._redo=[]},undoCommand:function(){this.forceFinalizeCommandBundle();var command=this._commands.pop();if(command){if(command instanceof _gliffy.UndoableCommand){this._redo.push(command);command.undo(this.stage);this.stage.setUnsavedChanges(true)}else{this.undoCommand()}}},removeAndUndoLastCommand:function(){var command=this._commands.pop();if(command){if(command instanceof _gliffy.UndoableCommand){command.undo(this.stage)}else{this.removeAndUndoLastCommand()}}},removeCommand:function(command){var index=$.inArray(command,this._commands);if(index>-1){this._commands.splice(index,1)}else{if(this._bundle!==null){index=$.inArray(command,this._bundle);this._bundle.splice(index,1)}else{index=$.inArray(command,this._redo);if(index>-1){this._redo.splice(index,1)}}}},redoCommand:function(){this.forceFinalizeCommandBundle();var command=this._redo.pop();if(command){if(!command instanceof _gliffy.Command){throw new Error("cannot add non-command to command history: "+command)}this._commands.push(command);command.execute(this.stage);this.stage.setUnsavedChanges(true)}},pushCommandBundle:function(){if(this._bundle===null){this._bundle=[];this._bundleStackCount=0}this._bundleStackCount++},popCommandBundle:function(){if(this._bundle!==null){this._bundleStackCount--;if(this._bundleStackCount===0){if(this._bundle.length>0){this._commands.push(new _gliffy.BundledCommand({commands:this._bundle}));this.stage.setUnsavedChanges(true)}this._bundle=null}}},forceFinalizeCommandBundle:function(){var badCommands=[],i;if(this._bundle!==null&&this._bundle.length>0){for(i=0;i<this._bundle.length;i++){badCommands.push(this._bundle[i].toString())}_gliffy.Logger.warn("Was forced finalize to command bundle in commandHistory.js: "+badCommands.join(","))}while(this._bundle!==null){this.popCommandBundle()}},setClipboard:function(command){_gliffy.clipboard=command},getClipboard:function(){return _gliffy.clipboard},getSize:function(){return this._commands.length},getReport:function(maxLength){var i,commands=[],command,report="";report+="\n====Summary Command Report["+maxLength+"]====\n";report+=this.getShortReport(maxLength);report+="\n\n====Detailed Command Report["+maxLength+"]====\n";try{for(i=0;i<this._commands.length&&i<maxLength;i++){command=this._commands[this._commands.length-1-i];commands.unshift(command.toString())}report+="[ "+commands.join(",")+"]"}catch(e){report+="\nProblems generating Detailed command report: "+e}return report},getShortReport:function(maxLength){var shortString=[],i,addComma=false;for(i=0;i<this._commands.length&&i<maxLength;i++){addComma=i+1<this._commands.length&&i+1<maxLength;shortString=(addComma?",\n":"")+this._commands[this._commands.length-i-1].shortToString()+shortString}return shortString}})}());(function(){GliffyApp.StyleCopyController=Ember.ObjectController.extend({editor:null,__overlayManager:null,__stageDiv:null,__cachedShapeStyle:null,__cachedTextStyle:null,__cachedLineStyle:null,mouseMoved:false,init:function(){},config:function(options){this.editor=options.__editor;this.__overlayManager=this.editor.overlayManager;this.__documentManager=this.editor.getDocumentManager();this.__registerEventListeners()},__registerEventListeners:function(){var selectNodeEvents,deselectNodeEvents,self;self=this;selectNodeEvents=["gliffy-overlay-set-selected-node","gliffy-line-overlay-select-node"].join(" ");deselectNodeEvents=["gliffy-overlay-deselect","gliffy-line-overlay-deselect-node"].join(" ");$(window).on(selectNodeEvents,function(event,node){self.handleSelectNode(node)});$(window).on(deselectNodeEvents,function(){self.handleDeselectNode()})},handleSelectNode:function(node){if(node&&node.supportsStyleCopy()||this.editor.getDrawMode()===_gliffy.Editor.DRAW_MODE.styleCopy){$(".style-copy-button").removeClass("disabled")}else{$(".style-copy-button").addClass("disabled")}},handleDeselectNode:function(){if(this.editor.getDrawMode()===_gliffy.Editor.DRAW_MODE.styleCopy){_gliffy.CursorManager.setCursor("default")}else{$(".style-copy-button").addClass("disabled").removeClass("active")}},handleCopyStyleClick:function(){_gliffy.Utils.analyticsEvent("trackEvent",{category:"toolbarClick",action:"styleCopy"});this.copyStyle();$("#gliffy-style-copy").removeClass("disabled").addClass("active");this.editor.setDrawMode(_gliffy.Editor.DRAW_MODE.styleCopy);setTimeout(function(){_gliffy.CursorManager.setCursor(_gliffy.Editor.DRAW_MODE_CURSORS[_gliffy.Editor.DRAW_MODE.styleCopy])},1)},resetCache:function(){this.__cachedShapeStyle=null;this.__cachedLineStyle=null;this.__cachedTextStyle=null},isCacheFull:function(key){switch(key){case"text":return this.__cachedTextStyle!==null;case"line":return this.__cachedLineStyle!==null;case"shape":return this.__cachedShapeStyle!==null;default:return this.isCacheFull("text")&&this.isCacheFull("line")&&this.isCacheFull("shape")}},cacheStyle:function(key,style){switch(key){case"text":return this.__cachedTextStyle=style;case"line":return this.__cachedLineStyle=style;case"shape":this.__cachedShapeStyle=new _gliffy.ShapeStyle();return this.__cachedShapeStyle.fromObject(style);default:throw new Error("Invalid cache key for copy style : "+key)}},copyStyle:function(){this.resetCache();this.cacheNodeStyles(this.editor.overlayManager.getSelectedNode())},cacheNodeStyles:function(node){if(!node){return}if(this.isCacheFull()){return}if(node.isText()&&!this.isCacheFull("text")){this.cacheStyle("text",node.getGraphic().getHtmlStyle())}else{if(node.isLine()&&!this.isCacheFull("line")){this.cacheStyle("line",node.getGraphic().getLineStyle())}else{if(node.isShape()&&!this.isCacheFull("shape")){this.cacheStyle("shape",node.getGraphic().style)}}}_.each((node.children||[]),this.cacheNodeStyles,this)},dragStart:function(event,stageDiv,moveThreshold,CLASS_NAME){this.__stageDiv=stageDiv;this.__moveThreshold=moveThreshold;this.__stageDiv.setStartCorner(_gliffy.Mouse.getPosition());this.__stageDiv.setClassName(CLASS_NAME);this.__moveThreshold.reset(event);_gliffy.Utils.analyticsEvent("trackEvent",{category:"styleCopyController",action:"styleCopyDragStart"})},drag:function(event,moveThreshold){this.mouseMoved=moveThreshold.above(event);if(this.mouseMoved){this.__stageDiv.setEndCorner(_gliffy.Mouse.getPosition());this.__stageDiv.draw()}},dragEnd:function(){this.__stageDiv.hide();this.applyStyleCommand();$("#gliffy-style-copy").removeClass("active");_gliffy.Utils.analyticsEvent("trackEvent",{category:"styleCopyController",action:"styleCopyDragEnd"})},pasteStyle:function(){this.applyStyleCommand()},applyStyleCommand:function(){this.__documentManager.pushCommandBundle();this.__documentManager.addAndExecuteCommand(new _gliffy.StyleCopyCommand({editor:this.editor,documentManager:this.__documentManager,overlayManager:this.__overlayManager,stageDiv:this.__stageDiv,shapeStyle:this.__cachedShapeStyle,textStyle:this.__cachedTextStyle,lineStyle:this.__cachedLineStyle,mouseMoved:this.mouseMoved}));this.mouseMoved=false;this.__documentManager.popCommandBundle()}});GliffyApp.styleCopyController=GliffyApp.StyleCopyController.create()}());(function(){GliffyApp.StyleCopyView=Ember.View.extend({tagName:"button",elementId:"gliffy-style-copy",classNames:["btn","style-copy-button","disabled"],titleBinding:"foo",templateName:"style-copy",didInsertElement:function(event){$(".style-copy-button").on("click",function(){if($(this).hasClass("disabled")){_gliffy.Utils.analyticsEvent("trackEvent",{category:"toolbarClick",action:"styleCopyWhenDisabled"})}else{GliffyApp.styleCopyController.handleCopyStyleClick()}});$("#gliffy-style-copy").attr("title",$.i18n._("TOOLBAR_STYLE_COPY"));$("#gliffy-style-copy").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD)}})}());(function(){_gliffy.StyleCopyCommand=_gliffy.UndoableCommand.extend({action:"copy_style",init:function(o){var options=$.extend({editor:null,documentManager:null,overlayManager:null,stageDiv:null,shapeStyle:null,textStyle:null,mouseMoved:null},o);this.editor=options.editor;this.documentManager=options.documentManager;this.overlayManager=options.overlayManager;this.stageDiv=options.stageDiv;this.shapeStyle=options.shapeStyle;this.textStyle=options.textStyle;this.lineStyle=options.lineStyle;this.mouseMoved=options.mouseMoved;this.mousePosition=null;this.nodeAtPoint=null;this.lastStyleCommands=[]},execute:function(){var nodesFromSelection=null,self=this,commandObjects,selectedNodes;if(this.mouseMoved){nodesFromSelection=this.overlayManager.selectNodes(_gliffy.Pick.pickAllNodesInside(this.documentManager.getActiveStage().objects,this.stageDiv.getBoundingBox()));if(nodesFromSelection&&nodesFromSelection.isSelection()){selectedNodes=nodesFromSelection.children}else{selectedNodes=[nodesFromSelection]}if(selectedNodes){$.each(selectedNodes,function(_,node){commandObjects=self.getNodeStyleCommandObjects(node);self.updateNodeStyle(node);if(commandObjects.length>0){self.recordStyleCommands(commandObjects)}});_gliffy.Mouse.resetMouseUpPosition()}}else{this.mousePosition=_gliffy.Mouse.getPosition();this.nodeAtPoint=_gliffy.Pick.getNodeAt(this.documentManager.getActiveStage().objects,this.mousePosition.x,this.mousePosition.y);if(this.nodeAtPoint){commandObjects=this.getNodeStyleCommandObjects(this.nodeAtPoint);this.updateNodeStyle(this.nodeAtPoint)}else{if(this.editor.overlayManager.getSelectedNode()){commandObjects=this.getNodeStyleCommandObjects(this.editor.overlayManager.getSelectedNode());this.updateNodeStyle(this.editor.overlayManager.getSelectedNode())}}if(commandObjects){this.recordStyleCommands(commandObjects);this.editor.getDocumentManager().redraw()}}this.editor.setDrawMode(_gliffy.Editor.DRAW_MODE.none)},recordStyleCommands:function(command){this.lastStyleCommands=this.lastStyleCommands.concat(command)},undo:function(stage){var node,self=this;if(this.lastStyleCommands.length>0){$.each(this.lastStyleCommands,function(_,nodeStyleCommand){node=stage.find(nodeStyleCommand.id);self.shapeStyle=nodeStyleCommand.shapeInfo;self.textStyle=nodeStyleCommand.textInfo;self.lineStyle=nodeStyleCommand.lineInfo;if(node){self.updateNodeStyle(node);self.editor.getDocumentManager().redraw()}});this.lastStyleCommands=[]}_gliffy.Utils.analyticsEvent("trackEvent",{category:"styleCopyCommand",action:"styleCopyUndo"})},getNodeStyleCommandObjects:function(startNode){var commands=[];commands.push(this.getNodeStyleCommandObject(startNode));_.each((startNode.children||[]),function(node){var subCommands=this.getNodeStyleCommandObjects(node);commands=commands.concat(subCommands)},this);return commands},getNodeStyleCommandObject:function(node){var styleCommandObject,graphic,style;styleCommandObject={id:node.getId()};graphic=node.getGraphic();if(node&&node.supportsStyleCopy()){if(node.isText()){styleCommandObject.textInfo=graphic.getHtmlStyle()}else{if(node.isLine()){style=new _gliffy.LineStyle();if(graphic){style=graphic.getLineStyle()}styleCommandObject.lineInfo=style}else{if(node.isShape()||node.isPartOfMultipartShape()){style=new _gliffy.ShapeStyle();if(graphic&&graphic.style){style.fromObject(graphic.style)}styleCommandObject.shapeInfo=style}}}}return styleCommandObject},updateNodeStyle:function(node){if(node){if(node.isText()){this.updateTextShapeStyle(node)}else{if(node.isLine()){this.updateLineStyle(node)}else{if(node.isShape()||node.isPartOfMultipartShape()){this.updateShapeStyle(node)}}}}if(node.hasChildren()){_.each(node.children,this.updateNodeStyle,this)}},updateShapeStyle:function(node){if(this.shapeStyle&&node.getGraphic()!==null){node.getGraphic().applyStyle(this.shapeStyle)}if(currentNode.children&&currentNode.children.length>0){_.each(currentNode.children,function(childNode){if(self.shapeStyle&&childNode.getGraphic() instanceof _gliffy.Shape){childNode.getGraphic().applyStyle(self.shapeStyle);if(childNode.children&&childNode.children.length>0&&self.textStyle&&childNode.children[0].getGraphic() instanceof _gliffy.Text){childNode.children[0].getGraphic().applyStyleToHtml(self.textStyle)}}else{if(self.textStyle&&childNode.getGraphic() instanceof _gliffy.Text){childNode.getGraphic().applyStyleToHtml(self.textStyle)}}})}},updateTextShapeStyle:function(node){if(this.textStyle&&node.getGraphic()!==null){node.getGraphic().applyStyleToHtml(this.textStyle)}},updateLineStyle:function(node){var graphic=node.getGraphic(),orthoMode=graphic.editable.getOrthoMode();if(this.lineStyle){graphic.applyStyle(this.lineStyle);graphic.editable.setOrthoMode(orthoMode)}}})}());(function(){_gliffy.Constraint=_gliffy.Serializable.extend({UPDATE_EVENT:"gliffy-node-update-",REMOVE_EVENT:"gliffy-node-remove-",init:function(){throw new Error("init for constraint is not implemented")},execute:function(self,stage){throw new Error("execute for constraint is not implemented")},updateIdsForCopy:function(nodeIdMap){throw new Error("update ids for copy is not implemented")},subscribe:function(self,stage){throw new Error("subscribe is not implemented")},unsubscribe:function(self,stage){throw new Error("unsubscribe is not implemented")},getClassName:function(){throw new Error("classname is not provided")}})}());(function(){_gliffy.PositionConstraint=_gliffy.Constraint.extend({nodeId:null,px:null,py:null,xOffset:0,yOffset:0,init:function(node,px,py,xOffset,yOffset){if(node){this.nodeId=node.getId();this.px=px;this.py=py;this.xOffset=xOffset||0;this.yOffset=yOffset||0}},execute:function(self,stage){var constraintNode=stage.find(this.nodeId),transform,point;if(!constraintNode){constraintNode=self.parent}if(constraintNode){transform=constraintNode.worldTransform.clone();point=transform.transformPoint(this.px*constraintNode.getWidth(),this.py*constraintNode.getHeight());if(self.parent!==null){point=self.parent.worldTransform.clone().createInverse().transformPoint(point.x,point.y)}self.setX(point.x+this.xOffset);self.setY(point.y+this.yOffset)}},updateIdsForCopy:function(nodeIdMap){if(nodeIdMap[this.nodeId]!==undefined){this.nodeId=nodeIdMap[this.nodeId]}},subscribe:function(self,stage){var constraint=this;this.unsubscribe(self,stage);$(window).bind([this.UPDATE_EVENT,this.nodeId,".","pos-",self.getId()].join(""),function(event,id){if(stage.find(self.getId())===self){constraint.execute(self,stage)}});$(window).bind([this.REMOVE_EVENT,this.nodeId,".","pos-",self.getId()].join(""),function(event,id){self.getConstraints().remove(constraint)})},unsubscribe:function(self,stage){$(window).unbind([this.UPDATE_EVENT,this.nodeId,".","pos-",self.getId()].join(""));$(window).unbind([this.REMOVE_EVENT,this.nodeId,".","pos-",self.getId()].join(""))},__toObject:function(){var object={nodeId:this.nodeId,px:this.px,py:this.py};if(this.xOffset!==0||this.yOffset!==0){object.xOffset=this.xOffset||0;object.yOffset=this.yOffset||0}return object},__fromObject:function(object){this.nodeId=object.nodeId;this.px=object.px;this.py=object.py;this.xOffset=object.xOffset||0;this.yOffset=object.yOffset||0},getClassName:function(){return"PositionConstraint"}})}());(function(){_gliffy.WidthConstraint=_gliffy.Constraint.extend({widthInfo:null,isMin:null,minWidth:null,growParent:false,padding:0,init:function(widthArray,isMin,growParent){var i=0;this.isMin=isMin===true;this.growParent=growParent===true;if(widthArray){this.widthInfo=[];for(i=0;i<widthArray.length;i++){this.widthInfo.push({id:widthArray[i].node.getId(),magnitude:widthArray[i].magnitude})}}},execute:function(self,stage){var width=0,i,info,diff,parent;if(this.widthInfo&&this.widthInfo.length>0){for(i=0;i<this.widthInfo.length;i++){info=this.widthInfo[i];width+=stage.find(info.id).getWidth()*info.magnitude}width=width+this.padding;if(!this.isMin||(this.isMin&&self.getWidth()<width)){if(this.minWidth&&width<this.minWidth){width=this.minWidth}if(self.getWidth()!==width){if(this.growParent){parent=self.getUidNode();diff=width-self.getWidth();parent.setWidth(parent.getWidth()+diff)}self.setWidth(width)}}}},getMinWidth:function(stage){var minWidth=0,node;if(this.minWidth){return this.minWidth}else{if(this.widthInfo&&this.widthInfo.length>0){$.each(this.widthInfo,function(i,info){node=stage.find(info.id);if(node){if(this.isMin){minWidth+=node.getMinWidth()*info.magnitude}else{minWidth+=node.getWidth()*info.magnitude}}})}minWidth+=this.padding}return minWidth},updateIdsForCopy:function(nodeIdMap){var i;for(i=0;i<this.widthInfo.length;i++){if(nodeIdMap[this.widthInfo[i].id]!==undefined){this.widthInfo[i].id=nodeIdMap[this.widthInfo[i].id]}}},subscribe:function(self,stage){var i,info,node,constraint=this,updateHandler,removeHandler;this.unsubscribe(self,stage);updateHandler=function(){if(stage.find(self.getId())===self){constraint.execute(self,stage)}};removeHandler=function(event,id){var i;if(stage.find(self.getId())===self){if(constraint.widthInfo.length>1){for(i=0;i<constraint.widthInfo.length;i++){if(constraint.widthInfo[i].id===id){constraint.widthInfo.splice(i,1);break}}}else{self.getConstraints().remove(constraint)}}};for(i=0;i<this.widthInfo.length;i++){info=this.widthInfo[i];$(window).bind([this.UPDATE_EVENT,info.id,".","width-",self.getId()].join(""),updateHandler);$(window).bind([this.REMOVE_EVENT,info.id,".","width-",self.getId()].join(""),removeHandler)}},unsubscribe:function(self,stage){var i,info,node;for(i=0;i<this.widthInfo.length;i++){info=this.widthInfo[i];$(window).unbind([this.UPDATE_EVENT,info.id,".","width-",self.getId()].join(""));$(window).unbind([this.REMOVE_EVENT,info.id,".","width-",self.getId()].join(""))}},__toObject:function(){return{isMin:this.isMin,widthInfo:this.widthInfo,minWidth:this.minWidth,growParent:this.growParent,padding:this.padding}},__fromObject:function(object){this.isMin=object.isMin===true;this.widthInfo=object.widthInfo;this.minWidth=object.minWidth;this.growParent=object.growParent===true;this.padding=object.padding||0},getClassName:function(){return"WidthConstraint"}})}());(function(){_gliffy.MinWidthConstraint=_gliffy.Constraint.extend({width:null,init:function(width){this.width=width},execute:function(self,stage){if(self.getWidth()<this.width){self.setWidth(this.width)}},updateIdsForCopy:function(nodeIdMap){},subscribe:function(self,stage){},unsubscribe:function(self,stage){},__toObject:function(){return{width:this.width}},__fromObject:function(object){this.width=object.width},getClassName:function(){return"MinWidthConstraint"}})}());(function(){_gliffy.HeightConstraint=_gliffy.Constraint.extend({heightInfo:null,isMin:null,minHeight:null,growParent:false,padding:0,init:function(heightArray,isMin,growParent){var i=0;this.isMin=isMin===true;this.growParent=growParent===true;if(heightArray){this.heightInfo=[];for(i=0;i<heightArray.length;i++){this.heightInfo.push({id:heightArray[i].node.getId(),magnitude:heightArray[i].magnitude})}}},execute:function(self,stage){var height=0,i,info,diff,parent;if(this.heightInfo&&this.heightInfo.length>0){for(i=0;i<this.heightInfo.length;i++){info=this.heightInfo[i];height+=stage.find(info.id).getHeight()*info.magnitude}height=height+this.padding;if(!this.isMin||(this.isMin&&self.getHeight()<height)){if(this.minHeight&&height<this.minHeight){height=this.minHeight}if(self.getHeight()!==height){if(this.growParent){parent=self.getUidNode();diff=height-self.getHeight();parent.setHeight(parent.getHeight()+diff)}self.setHeight(height)}}}},getMinHeight:function(stage){var minHeight=0,node;if(this.minHeight){return this.minHeight}else{if(this.heightInfo&&this.heightInfo.length>0){$.each(this.heightInfo,function(i,info){node=stage.find(info.id);if(node){if(this.isMin){minHeight+=node.getMinHeight()*info.magnitude}else{minHeight+=node.getHeight()*info.magnitude}}})}minHeight+=this.padding}return minHeight},updateIdsForCopy:function(nodeIdMap){var i;for(i=0;i<this.heightInfo.length;i++){if(nodeIdMap[this.heightInfo[i].id]!==undefined){this.heightInfo[i].id=nodeIdMap[this.heightInfo[i].id]}}},subscribe:function(self,stage){var i,info,node,constraint=this,updateHandler,removeHandler;this.unsubscribe(self,stage);updateHandler=function(){if(stage.find(self.getId())===self){constraint.execute(self,stage)}};removeHandler=function(event,id){var i;if(stage.find(self.getId())===self){if(constraint.heightInfo.length>1){for(i=0;i<constraint.heightInfo.length;i++){if(constraint.heightInfo[i].id===id){constraint.heightInfo.splice(i,1);break}}}else{self.getConstraints().remove(constraint)}}};for(i=0;i<this.heightInfo.length;i++){info=this.heightInfo[i];$(window).bind([this.UPDATE_EVENT,info.id,".","height-",self.getId()].join(""),updateHandler);$(window).bind([this.REMOVE_EVENT,info.id,".","height-",self.getId()].join(""),removeHandler)}},unsubscribe:function(self,stage){var i,info,node;for(i=0;i<this.heightInfo.length;i++){info=this.heightInfo[i];$(window).unbind([this.UPDATE_EVENT,info.id,".","height-",self.getId()].join(""));$(window).unbind([this.REMOVE_EVENT,info.id,".","height-",self.getId()].join(""))}},__toObject:function(){return{isMin:this.isMin,heightInfo:this.heightInfo,minHeight:this.minHeight,growParent:this.growParent,padding:this.padding}},__fromObject:function(object){this.isMin=object.isMin===true;this.heightInfo=object.heightInfo;this.minHeight=object.minHeight;this.growParent=object.growParent===true;this.padding=object.padding||0},getClassName:function(){return"HeightConstraint"}})}());(function(){_gliffy.MinHeightConstraint=_gliffy.Constraint.extend({height:null,init:function(height){this.height=height},execute:function(self,stage){if(self.getHeight()<this.height){self.setHeight(this.height)}},updateIdsForCopy:function(nodeIdMap){},subscribe:function(self,stage){},unsubscribe:function(self,stage){},__toObject:function(){return{height:this.height}},__fromObject:function(object){this.height=object.height},getClassName:function(){return"MinHeightConstraint"}})}());(function(){_gliffy.LinePositionConstraint=_gliffy.Constraint.extend({nodeId:null,px:null,py:null,deleted:false,_prevConstraintHeight:null,_prevConstraintY:null,init:function(node,px,py){if(node){this.nodeId=node.getId();this.px=px;this.py=py}},execute:function(self,stage){var constraintNode=stage.find(this.nodeId),point,line;if(constraintNode){this.deleted=false;constraintNode.updateWorldTransform();if(constraintNode.isUML2Activation()){if(constraintNode.isPartOfGroup()||constraintNode.isPartOfSelection()||constraintNode.isPartOfRegExp(/^com\.gliffy\.shape\.uml\.uml_v2/)){this._clearActivationConstraints(constraintNode)}else{this._applyActivationConstraints(constraintNode)}}point=constraintNode.ratioToWorldPoint(this.px,this.py);self.updateWorldTransform();if(self.isLine()){line=self.getGraphic();if(line.editable&&this._hasChangedPoint(line)){line.editable.allowComputeBestPath=true}}self.getGraphic().setWorldControlPoint(this._getIndexOnLine(self.getGraphic()),point)}else{this.deleted=true}},getRatio:function(){return new _gliffy.Vec2(this.px,this.py)},updateIdsForCopy:function(nodeIdMap){if(nodeIdMap[this.nodeId]!==undefined){this.nodeId=nodeIdMap[this.nodeId]}},subscribe:function(self,stage){var constraint=this;this.unsubscribe(self,stage);$(window).bind([this.UPDATE_EVENT,this.nodeId,".",this._getPointPrefix(),self.getId()].join(""),function(event,id){if(stage.find(self.getId())===self){constraint.execute(self,stage)}});$(window).bind([this.REMOVE_EVENT,this.nodeId,".",this._getPointPrefix(),self.getId()].join(""),function(event,id){constraint.deleted=true})},unsubscribe:function(self,stage){$(window).unbind([this.UPDATE_EVENT,this.nodeId,".",this._getPointPrefix(),self.getId()].join(""));$(window).unbind([this.REMOVE_EVENT,this.nodeId,".",this._getPointPrefix(),self.getId()].join(""))},__toObject:function(){if(!this.deleted){return{nodeId:this.nodeId,px:this.px,py:this.py}}else{return null}},_applyActivationConstraints:function(constraintNode){var worldAabb=constraintNode.worldAabb,constraintY=constraintNode.worldAabb.min.y,aabbInitialized=!(worldAabb.min.x===0&&worldAabb.min.y===0&&worldAabb.max.x===0&&worldAabb.max.y===0);if(aabbInitialized&&this.py>=0.001&&this.py<=0.999){if(this._prevConstraintHeight===null){this._prevConstraintHeight=constraintNode.getHeight();this._prevConstraintY=constraintY}if(this._prevConstraintHeight!==constraintNode.getHeight()){this.py=this.py*this._prevConstraintHeight/constraintNode.getHeight();this._prevConstraintHeight=constraintNode.getHeight()}if(this._prevConstraintY!=constraintY){this.py=_gliffy.Utils.clamp(this.py+(this._prevConstraintY-constraintY)/constraintNode.getHeight(),0.001,0.999);this._prevConstraintY=constraintY}}},_clearActivationConstraints:function(constraintNode){this._prevConstraintHeight=null},_abstract:function(){_gliffy.Logger.error("LinePositionConstraint is abstract, please use StartPositionConstraint or EndPositionConstraint")},_getPointPrefix:function(){this._abstract()},_hasChangedPoint:function(lineGraphic){this._abstract()},_getIndexOnLine:function(lineGraphic){this._abstract()},__fromObject:function(object){this.nodeId=object.nodeId;this.px=object.px;this.py=object.py},getClassName:function(){return"LinePositionConstraint"}})}());(function(){_gliffy.EndPositionConstraint=_gliffy.LinePositionConstraint.extend({init:function(node,px,py){this._super(node,px,py)},getClassName:function(){return"EndPositionConstraint"},_getPointPrefix:function(){return"ep-"},_hasChangedPoint:function(lineGraphic){return lineGraphic.editable.hasChangedEndPoint()},_getIndexOnLine:function(lineGraphic){return lineGraphic.getControlPointCount()-1}})}());(function(){_gliffy.StartPositionConstraint=_gliffy.LinePositionConstraint.extend({init:function(node,px,py){this._super(node,px,py)},getClassName:function(){return"StartPositionConstraint"},_getPointPrefix:function(){return"sp-"},_hasChangedPoint:function(lineGraphic){return lineGraphic.editable.hasChangedStartPoint()},_getIndexOnLine:function(lineGraphic){return 0}})}());(function(){_gliffy.ConstHeightConstraint=_gliffy.Constraint.extend({height:null,init:function(height){this.height=height},execute:function(self){if(this.height){self.setHeight(this.height)}else{console.warn("ConstHeightConstraint must have a height. you should only see this error if you are using the shape creator")}},updateIdsForCopy:function(nodeIdMap){},subscribe:function(self,stage){},unsubscribe:function(self,stage){},__toObject:function(){return{height:this.height}},__fromObject:function(object){this.height=object.height},getClassName:function(){return"ConstHeightConstraint"}})}());(function(){_gliffy.ConstWidthConstraint=_gliffy.Constraint.extend({width:null,init:function(width){this.width=width},execute:function(self){if(this.width){self.setWidth(this.width)}else{console.warn("ConstWidthConstraint must have a width. you should only see this error if you are using the shape creator")}},updateIdsForCopy:function(nodeIdMap){},subscribe:function(self,stage){},unsubscribe:function(self,stage){},__toObject:function(){return{width:this.width}},__fromObject:function(object){this.width=object.width},getClassName:function(){return"ConstWidthConstraint"}})}());(function(){_gliffy.Constraints=_gliffy.Serializable.extend({node:null,stage:null,_subscribe_to_constraints:true,_constraints:null,_start_constraint:null,_end_constraint:null,init:function(node,subscribeToConstraints){this.node=node;if(node!==null){this.stage=node.stage}if(subscribeToConstraints===true||subscribeToConstraints===false){this._subscribe_to_constraints=subscribeToConstraints}this._constraints=[]},add:function(constraint){if(constraint instanceof _gliffy.Constraint){if(constraint instanceof _gliffy.EndPositionConstraint){if(this._end_constraint&&this._subscribe_to_constraints){this._end_constraint.unsubscribe(this.node,this.node.stage)}this._end_constraint=constraint}else{if(constraint instanceof _gliffy.StartPositionConstraint){if(this._start_constraint&&this._subscribe_to_constraints){this._start_constraint.unsubscribe(this.node,this.node.stage)}this._start_constraint=constraint}else{this._constraints.push(constraint)}}if(this.node.stage&&this._subscribe_to_constraints){constraint.subscribe(this.node,this.node.stage)}}else{throw new Error("object is not a constraint!"+constraint)}},remove:function(constraint){var index=$.inArray(constraint,this._constraints),removed;if(index>-1){removed=this._constraints.splice(index,1)[0];if(this.node.stage&&this._subscribe_to_constraints){removed.unsubscribe(this.node,this.node.stage)}}else{if(this._end_constraint===constraint){if(this.node.stage&&this._subscribe_to_constraints){this._end_constraint.unsubscribe(this.node,this.node.stage)}this._end_constraint=null}else{if(this._start_constraint===constraint){if(this.node.stage&&this._subscribe_to_constraints){this._start_constraint.unsubscribe(this.node,this.node.stage)}this._start_constraint=null}}}},updateIds:function(nodeIdMap){var i;this.unsubscribeAll();for(i=0;i<this._constraints.length;i++){this._constraints[i].updateIdsForCopy(nodeIdMap)}if(this._start_constraint){if(nodeIdMap[this._start_constraint.nodeId]!==undefined){this._start_constraint.updateIdsForCopy(nodeIdMap)}else{this.removeStartConstraint()}}if(this._end_constraint){if(nodeIdMap[this._end_constraint.nodeId]!==undefined){this._end_constraint.updateIdsForCopy(nodeIdMap)}else{this.removeEndConstraint()}}this.subscribeAll()},executeConstraints:function(){var i;if(this.node.stage){for(i=0;i<this._constraints.length;i++){this._constraints[i].execute(this.node,this.node.stage)}if(this._start_constraint){this._start_constraint.execute(this.node,this.node.stage)}if(this._end_constraint){this._end_constraint.execute(this.node,this.node.stage)}}},unsubscribeAll:function(){var i;if(this._subscribe_to_constraints&&this.node.stage){for(i=0;i<this._constraints.length;i++){this._constraints[i].unsubscribe(this.node,this.node.stage)}if(this._start_constraint){this._start_constraint.unsubscribe(this.node,this.node.stage)}if(this._end_constraint){this._end_constraint.unsubscribe(this.node,this.node.stage)}}},subscribeAll:function(){var i;if(this._subscribe_to_constraints&&this.node.stage){for(i=0;i<this._constraints.length;i++){this._constraints[i].subscribe(this.node,this.node.stage)}if(this._start_constraint){this._start_constraint.subscribe(this.node,this.node.stage)}if(this._end_constraint){this._end_constraint.subscribe(this.node,this.node.stage)}}},parentCanScaleHeight:function(){var i,constraint;if(!this.node.getUid()){for(i=0;i<this._constraints.length;i++){constraint=this._constraints[i];if(constraint instanceof _gliffy.MinHeightConstraint||constraint instanceof _gliffy.HeightConstraint||constraint instanceof _gliffy.ConstHeightConstraint){return false}}}return true},parentCanScaleWidth:function(){var i,constraint;if(!this.node.getUid()){for(i=0;i<this._constraints.length;i++){constraint=this._constraints[i];if(constraint instanceof _gliffy.MinWidthConstraint||constraint instanceof _gliffy.WidthConstraint){return false}}}return true},__toObject:function(){var i,constraint,constraints=[],obj,toObject;for(i=0;i<this._constraints.length;i++){constraint=this._constraints[i];obj=_gliffy.Serializable.polymorphicToObject(constraint);constraints.push(obj)}toObject={constraints:constraints};if(this._start_constraint&&!this._start_constraint.deleted){toObject.startConstraint=_gliffy.Serializable.polymorphicToObject(this._start_constraint)}if(this._end_constraint&&!this._end_constraint.deleted){toObject.endConstraint=_gliffy.Serializable.polymorphicToObject(this._end_constraint)}return toObject},__fromObject:function(object){var i,constraint;if(object.constraints){for(i=0;i<object.constraints.length;i++){constraint=_gliffy.Serializable.polymorphicFromObject(object.constraints[i]);this._constraints.push(constraint)}}if(object.startConstraint){constraint=_gliffy.Serializable.polymorphicFromObject(object.startConstraint);if(constraint.px>=0&&constraint.py>=0&&constraint.px<=1&&constraint.px<=1){this._start_constraint=constraint}}if(object.endConstraint){constraint=_gliffy.Serializable.polymorphicFromObject(object.endConstraint);if(constraint.px>=0&&constraint.py>=0&&constraint.px<=1&&constraint.px<=1){this._end_constraint=constraint}}},getConstraint:function(type){var i;if(this._start_constraint&&this._start_constraint instanceof type){return this._start_constraint}else{if(this._end_constraint&&this._end_constraint instanceof type){return this._end_constraint}else{for(i=0;i<this._constraints.length;i++){if(this._constraints[i] instanceof type){return this._constraints[i]}}}}},getConstraints:function(type){var i,constraints=[];for(i=0;i<this._constraints.length;i++){if(this._constraints[i] instanceof type){constraints[i]=this._constraints[i]}}return constraints},hasConstraints:function(){return this._start_constraint!==null||this._end_constraint!==null||this._constraints.length>0},hasConstraint:function(constraint){return !!this.getConstraint(constraint)},removeStartConstraint:function(){if(this._start_constraint){this.remove(this._start_constraint)}},removeEndConstraint:function(){if(this._end_constraint){this.remove(this._end_constraint)}},getStartConstraint:function(){return this._start_constraint},getEndConstraint:function(){return this._end_constraint}})}());(function(){_gliffy.Renderer=_gliffy.Class.extend({id:null,target:null,init:function(){throw"this is the renderer interface"},render:function(options){throw"check for renderer options later"}})})();(function(){_gliffy.Renderer.IconRenderer=_gliffy.Renderer.extend({id:"Gliffy.Renderer.IconRenderer",target:null,init:function(){_gliffy.renderers[this.id]=this},render:function(o){var options=$.extend({},{target:null,viewboxDom:null,iconClass:null,graphicType:null,oppositeGraphicType:null,renderLeftIfOppositeGraphicTypeExists:false,renderPopupPoints:false},o),node=options.target,graphic=null,iconDom,i,widthMultiplier=1,heightMultiplier=1,shapeInfo=node.getShapeInformation(),popupPoints,hasOpposingGraphicType=false,renderLeft=false;$.each(options,function(key,val){if(options[key]===undefined||options[key]===null){throw new Error("IconRenderer missing option "+key)}});if(node.supportsIcon()){if(!options.viewboxDom){return}if(node.children){for(i=0;i<node.children.length;i++){if(node.children[i].getGraphic() instanceof options.graphicType){graphic=node.children[i].getGraphic()}if(node.children[i].getGraphic() instanceof options.oppositeGraphicType){hasOpposingGraphicType=true}}}renderLeft=options.renderLeftIfOppositeGraphicTypeExists&&hasOpposingGraphicType;if(graphic){iconDom=options.viewboxDom.find("."+options.iconClass);if(iconDom.length===0){iconDom=$('<div class="'+options.iconClass+'" style="position:absolute"></div>');options.viewboxDom.append(iconDom)}if(!graphic.getRenderIcon()){iconDom.hide();return}iconDom.show();if(shapeInfo&&shapeInfo.defaults&&shapeInfo.defaults.popupNoteRatio){widthMultiplier=shapeInfo.defaults.popupNoteRatio.x;heightMultiplier=shapeInfo.defaults.popupNoteRatio.y}if(_gliffy.Debug.POPUP_NOTE_POSITION){if(_gliffy.Debug.popupWidthMultiplier!==undefined){widthMultiplier=_gliffy.Debug.popupWidthMultiplier}if(_gliffy.Debug.popupWidthMultiplier!==undefined){heightMultiplier=_gliffy.Debug.popupHeightMultiplier}}iconDom.css(_gliffy.Utils.transformCss(_gliffy.AffineTransform.getRotateInstance(-_gliffy.Utils.degreesToRadians(node.getWorldRotation()),7,7).preTranslate(node.getWidth()*widthMultiplier-9,node.getHeight()*heightMultiplier-9).translate(-(renderLeft?18:0),0)));if(options.renderPopupPoints){popupPoints=options.viewboxDom.find(".gliffy-popup-point");if(popupPoints.length===0){for(i=0;i<8;i++){popupPoints=$('<div class="gliffy-popup-point"></div>');options.viewboxDom.append(popupPoints)}popupPoints=options.viewboxDom.find(".gliffy-popup-point")}$(popupPoints[0]).css({left:node.getWidth()/2+"px",top:0+"px"}).addClass("gliffy-popup-point-n");$(popupPoints[1]).css({left:0+"px",top:node.getHeight()/2+"px"}).addClass("gliffy-popup-point-w");$(popupPoints[2]).css({left:node.getWidth()/2+"px",top:node.getHeight()+"px"}).addClass("gliffy-popup-point-s");$(popupPoints[3]).css({left:node.getWidth()+"px",top:node.getHeight()/2+"px"}).addClass("gliffy-popup-point-e");$(popupPoints[4]).css({left:0+"px",top:0+"px"}).addClass("gliffy-popup-point-nw");$(popupPoints[5]).css({left:node.getWidth()+"px",top:0+"px"}).addClass("gliffy-popup-point-ne");$(popupPoints[6]).css({left:node.getWidth()+"px",top:node.getHeight()+"px"}).addClass("gliffy-popup-point-se");$(popupPoints[7]).css({left:0+"px",top:node.getHeight()+"px"}).addClass("gliffy-popup-point-sw")}}else{options.viewboxDom.find("."+options.iconClass).remove();if(options.renderPopupPoints){options.viewboxDom.find(".gliffy-popup-point").remove()}}}if(options.renderCallback){options.renderCallback()}}})})();(function(){_gliffy.Renderer.TextDom=_gliffy.Renderer.extend({id:"Gliffy.Renderer.TextDom",target:null,__vertical_offset:0,__middle_valign_offset:0,__domElement:null,transform:null,init:function(){_gliffy.renderers[this.id]=this},render:function(o){if(!o){throw new Error("text renderer needs options")}if(!o.container){throw new Error("needs a target container")}if(!(o.object&&o.object instanceof _gliffy.Text)){throw new Error("needs a text object to render!")}var options=$.extend({},{renderCallback:null},o),text=options.object,container=options.container,domStage=options.stage,stage=text.node.stage,zIndex=options.zIndex,offsetY,transform,bounds,createTextNodes,stageZoom;if(!(text.editable.isEditable&&text.editable.getEditMode())&&(options.forceRedraw||text.node.hasRepositionCanvasFlag()||text.node.hasRedrawCanvasFlag())&&(text.node.getDomElement().css("display")!=="none")&&stage instanceof _gliffy.Stage){createTextNodes=!text.__cachedDomResult||text.node.hasRepositionCanvasFlag();if(createTextNodes){if(options.useClassDomObject){$("."+text.node._domId).remove()}else{text.node.getDomElement().remove()}text.__cachedDomResult=this.__buildDomObject(text,options.useClassDomObject);domStage.append(text.__cachedDomResult)}if(typeof text.__cachedDomResult=="string"||text.__cachedDomResult instanceof String){text.__cachedDomResult=$(text.__cachedDomResult)}text.__cachedDomResult.data("node",text.node);if(!options.zIndex){zIndex=0}this.__middle_valign_offset=(text.node.getHeight()/2)-(text.getCalculatedHeight()/2);offsetY=(text.getValign()==="middle")?this.__middle_valign_offset+this.__vertical_offset:this.__vertical_offset;stageZoom=stage.getZoom();transform=text.node.worldTransform;transform=new _gliffy.AffineTransform(1,0,0,1,0,0).scale(stageZoom,stageZoom).concatenate(transform).translate(text.style.x,text.style.y+offsetY);if(createTextNodes||text.node.hasRepositionCanvasFlag()){text.__cachedDomResult.css($.extend(_gliffy.Utils.transformCss(transform,{roundTranslate:true}),{width:this.__getObjectWidth(text),height:text.style.height,visibility:"visible",position:"absolute",zIndex:zIndex,display:"block",margin:0,padding:0}))}if(text.isComputePositioning()||options.forceRedraw){text.markDirty();text.update();if(options.useClassDomObject){$("."+text.node._domId).remove()}else{text.node.getDomElement().remove()}text.__cachedDomResult=this.__buildDomObject(text,options.useClassDomObject);text.__cachedDomResult.data("node",text.node);transform=new _gliffy.AffineTransform(1,0,0,1,0,0).scale(stageZoom,stageZoom).concatenate(text.node.worldTransform).translate(text.style.x,text.style.y+offsetY);this.transform=transform;if(o.removeTransform){transform=new _gliffy.AffineTransform()}text.__cachedDomResult.css($.extend(_gliffy.Utils.transformCss(transform,{roundTranslate:true}),{width:this.__getObjectWidth(text),height:text.style.height,visibility:"visible",position:"absolute",zIndex:zIndex,display:"block",margin:0,padding:0}));domStage.append(text.__cachedDomResult);text.positionComputed()}text.__cachedDomResult.data("transform",transform);if(stage.autoFit){bounds=_gliffy.Utils.maxBounds(transform,text.style.width,text.style.height,stage);text.node.current_bounds=bounds;if(bounds.x>stage.width||bounds.y>stage.height){stage.width=Math.max(stage.width,bounds.x);stage.height=Math.max(stage.height,bounds.y)}}text.node.resetFlags();this.__domElement=text.__cachedDomResult;if(options.cachePreRenderInfo){text.preRenderInfo={transform:this.transform,domElement:this.getDomElement()}}if(options.renderCallback){options.renderCallback()}}},getDomElement:function(){return this.__domElement},__getObjectWidth:function(object){return object.style.width},__buildDomObject:function(object,useClassDomObject){var textNode,class_,bgcolor="transparent",shapeInfo,themeType;class_="gliffy-text gliffy-graphic gliffy-rte-text";if(object.node.parent){if(object.node.parent.isLine()){class_+=" gliffy-text-with-line-parent";bgcolor=object.node.stage.background==="transparent"?"#ffffff":object.node.stage.background}else{if(object.node.parent.isShape()){shapeInfo=object.node.parent.getShapeInformation();themeType=(shapeInfo&&shapeInfo.defaults&&shapeInfo.defaults.themeType)?shapeInfo.defaults.themeType:null;if(themeType){class_+=" gliffy-text-with-shape-parent-"+themeType}}}}else{class_+=" gliffy-text-standalone"}if(useClassDomObject){class_+=" "+object.node._domId}if(object.node.getLayerLocked()){class_+="  gliffy-locked-layer"}textNode=$("<div/>",{id:useClassDomObject?"":object.node._domId,"class":class_}).css({width:this.__getObjectWidth(object),height:object.style.height,visibility:"hidden",overflow:"visible",display:"block",margin:0,padding:0,backgroundColor:bgcolor}).append(object.getHTML());return textNode}})}());_gliffy.Renderer.TextHtml2Canvas=_gliffy.Renderer.TextDom.extend({id:"Gliffy.Renderer.TextHtml2Canvas",target:null,init:function(){_gliffy.renderers[this.id]=this},render:function(o){var domElement,context=o.target,object=o.object,transform,values,isRenderingSVG=context.canvas.getContext===undefined,self=this,invZoom,doShapeOpt=true;if(o.preRender){this._super($.extend({},o,{forceRedraw:true,useClassDomObject:true,removeTransform:true,cachePreRenderInfo:true}))}else{try{domElement=object.preRenderInfo.domElement}catch(exception){_gliffy.Logger.error("need to call this rendererer with options.preRender = true first!")}transform=object.preRenderInfo.transform;if(transform){if(object.style.text_background_fill){domElement[0].style.backgroundColor=object.style.text_background_fill;doShapeOpt=false}context.save();if(o.ignoreZoom){invZoom=1/object.node.stage.getZoom();transform.preScale(invZoom,invZoom)}values=transform.getValues();context.transform(values[0],values[1],values[2],values[3],Math.round(values[4]),Math.round(values[5]));html2canvas(domElement[0],{async:false,canvas:context.canvas,background:"transparent",useSVGTextBaseline:isRenderingSVG,clipBackgroundColor:!isRenderingSVG,gliffyOpt:true,doShapeOpt:doShapeOpt,letterRendering:true,onrendered:function(canvas){context.restore();delete object.preRenderInfo}})}else{if(object.node){_gliffy.Logger.warn("cannot find transform for node ["+object.node.getId()+"]")}}if(o.renderCallback){o.renderCallback()}}}});(function(){_gliffy.Renderer.ShapeCanvas=_gliffy.Renderer.extend({id:"Gliffy.Renderer.ShapeCanvas",target:null,init:function(){_gliffy.renderers[this.id]=this},render:function(o){if(!o){throw new Error("shape renderer needs options")}if(!o.target){throw new Error("needs a target canvas context")}if(!o.object){throw new Error("no shape to render")}var ctx=o.target,object=o.object,renderCallback=o.renderCallback,transform,values,offsetX,offsetY,scale,data,shadow_scale_x,shadow_scale_y,originalFill,pan_x,pan_y,linkNodeArray;if(object.node&&object.node.stage){scale=object.node.stage.zoom;originalFill=object.style.fill;if(originalFill==="none"){object.style.fill="rgba(255,255,255,"+_gliffy.MIN_OPACITY+")"}if(object.style.single_canvas){if(o.ignoreZoom){scale=1}pan_x=(o.ignorePan)?0:object.node.stage.pan_x;pan_y=(o.ignorePan)?0:object.node.stage.pan_y;transform=new _gliffy.AffineTransform(1,0,0,1,0,0).translate(pan_x,pan_y).scale(scale,scale).concatenate(object.node.worldTransform);values=transform.getValues();object.style.matrix_a=values[0];object.style.matrix_b=values[1];object.style.matrix_c=values[2];object.style.matrix_d=values[3];object.style.matrix_e=values[4];object.style.matrix_f=values[5];offsetX=(object.style.stroke_width%2===1)?0.5:0;offsetY=(object.style.stroke_width%2===1)?0.5:0}else{offsetX=object.style.offset_x;offsetY=object.style.offset_y}data=object.style;ctx.save();linkNodeArray=object.node.findGraphic(_gliffy.Link);if(linkNodeArray.length>0){ctx.__pathHref=linkNodeArray[0].getGraphic().getHref()}ctx.translate(offsetX*scale,offsetY*scale);ctx.transform(data.matrix_a,data.matrix_b,data.matrix_c,data.matrix_d,data.matrix_e,data.matrix_f);if(object.isDropShadow()&&!(object.getFillColor()==="none"&&object.getStrokeWidth()===0)){ctx.save();if(originalFill!=="none"){shadow_scale_x=(object.style.width+object.style.stroke_width/2)/object.style.width;shadow_scale_y=(object.style.height+object.style.stroke_width/2)/object.style.height;ctx.translate(object.style.shadow_x,object.style.shadow_y);ctx.scale(shadow_scale_x,shadow_scale_y);_gliffy.shapeLibrary.drawStencil(object.getTid(),ctx,$.extend({},object.style,{fill:"#000000",opacity:0.294117647,stroke:"none",gradient:false}),_gliffy)}else{if(object.style.stroke_width>0){ctx.translate(object.style.shadow_x,object.style.shadow_y);_gliffy.shapeLibrary.drawStencil(object.getTid(),ctx,$.extend({},object.style,{opacity:0.294117647,fill:"none",gradient:false}))}}ctx.restore()}if(_gliffy.shapeLibrary.canDrawStencil(object.getTid())){_gliffy.shapeLibrary.drawStencil(object.getTid(),ctx,data);object.node.resetFlags()}else{_gliffy.Logger.warn("Could not draw stencil "+object.getTid());data.fill="#FF0000";data.stroke="#FF0000";data.stroke_width=2;_gliffy.shapeLibrary.drawStencil("com.gliffy.stencil.rectangle.unknown",ctx,data)}ctx.__pathHref=null;ctx.restore()}if(renderCallback){renderCallback()}}})}());(function(){_gliffy.Renderer.SvgCanvas=_gliffy.Renderer.extend({id:"Gliffy.Renderer.SvgCanvas",target:null,init:function(){_gliffy.renderers[this.id]=this},render:function(o){if(!o){throw new Error("svg renderer needs options")}if(!o.target){throw new Error("needs a target canvas context")}if(!o.object){throw new Error("no svg to render")}var ctx=o.target,object=o.object,renderCallback=o.renderCallback,transform,values,offsetX,offsetY,scale,data,originalFill,pan_x,pan_y,dim,svg,resource,linkNodeArray;if(object.node&&object.node.stage){scale=object.node.stage.zoom;originalFill=object.style.fill;if(originalFill==="none"){object.style.fill="rgba(255,255,255,"+_gliffy.MIN_OPACITY+")"}if(object.style.single_canvas){if(o.ignoreZoom){scale=1}pan_x=(o.ignorePan)?0:object.node.stage.pan_x;pan_y=(o.ignorePan)?0:object.node.stage.pan_y;transform=new _gliffy.AffineTransform(1,0,0,1,0,0).translate(pan_x,pan_y).scale(scale,scale).concatenate(object.node.worldTransform);values=transform.getValues();object.style.matrix_a=values[0];object.style.matrix_b=values[1];object.style.matrix_c=values[2];object.style.matrix_d=values[3];object.style.matrix_e=values[4];object.style.matrix_f=values[5]}offsetX=(object.style.single_canvas)?0:object.style.offset_x;offsetY=(object.style.single_canvas)?0:object.style.offset_y;data=object.style;ctx.save();linkNodeArray=object.node.findGraphic(_gliffy.Link);if(linkNodeArray.length>0){ctx.__pathHref=linkNodeArray[0].getGraphic().getHref()}ctx.translate(offsetX*scale,offsetY*scale);ctx.transform(data.matrix_a,data.matrix_b,data.matrix_c,data.matrix_d,data.matrix_e,data.matrix_f);resource=object.node.stage.gon.getEmbeddedResources().getResource(object.getEmbeddedResourceId());if(resource){svg=resource.getData();dim=_gliffy.shapeLibrary.svgDim[svg];ctx.scale(object.style.width/dim.width,object.style.height/dim.height);ctx.translate(-dim.x,-dim.y);if(_gliffy.shapeLibrary.canDrawStencil(svg)){_gliffy.shapeLibrary.drawStencil(svg,ctx,data);object.node.resetFlags()}}ctx.__pathHref=null;ctx.restore();object.style.fill=originalFill}if(renderCallback){renderCallback()}}})}());(function(){_gliffy.Renderer.LineCanvas=_gliffy.Renderer.extend({id:"Gliffy.Renderer.LineCanvas",target:null,init:function(){_gliffy.renderers[this.id]=this},render:function(o){if(!o){throw new Error("line renderer needs options")}if(!o.target){throw new Error("needs a target canvas context")}if(!o.object){throw new Error("no line to render")}var context=o.target,object=o.object,callback=o.renderCallback,self=this;if(object.getFillColor()&&object.getFillColor()!=="none"&&object.getFillColor()!==object.getStrokeColor()){o.renderCallback=function(){o.renderCallback=function(){if(callback){callback()}};self._renderFillLine(o)}}this._render(o)},_render:function(o){if(!o){throw new Error("line renderer needs options")}if(!o.target){throw new Error("needs a target canvas context")}if(!o.object){throw new Error("no line to render")}var style,context=o.target,line,object=o.object,data=object.style,callback=o.renderCallback,scale,c,tmpCtx,transform,values,pan_x,pan_y;if(object.node&&object.node.stage){scale=object.node.stage.zoom;line=new _gliffy.Linevg(object.getDrawCommands());if(!object.style.single_canvas){this._pushContextMatrix(context,data,scale);if(object.editable.isEditable){style=$.extend({},data,{stroke:object.node.stage.background==="transparent"?"#ffffff":object.node.stage.background,stroke_width:data.stroke_width+object.OVERLAY_EXTEND,opacity:0.008,stroke_dasharray:null,start_arrow:"none",end_arrow:"none"});line.drawPath(context,style)}if(object.getOverlay()){style=$.extend({},data,{stroke_width:data.stroke_width+object.OVERLAY_DISPLAY_EXTEND,stroke:"#97bfe0",stroke_dasharray:null,start_arrow:"none",end_arrow:"none"});line.drawPath(context,style)}line.drawPath(context,data);this._popContextMatrix(context)}else{if(o.ignoreZoom){scale=1}object.style.matrix_a=scale;object.style.matrix_b=0;object.style.matrix_c=0;object.style.matrix_d=scale;object.style.matrix_e=0;object.style.matrix_f=0;if(!object.getStartArrow()&&!object.getEndArrow()&&context instanceof window.C2S){tmpCtx=new C2S(object.style.graphic_width*scale,object.style.graphic_height*scale);c=tmpCtx.canvas}else{c=document.createElement("canvas");c.width=object.style.graphic_width*scale;c.height=object.style.graphic_height*scale;tmpCtx=_gliffy.Utils.getContext(c)}this._pushContextMatrix(tmpCtx,data,scale);line.drawPath(tmpCtx,data);this._popContextMatrix(tmpCtx);transform=new _gliffy.AffineTransform(1,0,0,1,0,0).scale(scale,scale).translate(object.style.pos_x,object.style.pos_y).translate(-object.style.offset_x,-object.style.offset_y).scale(1/scale,1/scale);values=transform.getValues();context.save();context.transform(values[0],values[1],values[2],values[3],values[4],values[5]);context.drawImage(c,0,0);context.restore()}}if(callback){callback()}},_pushContextMatrix:function(context,style,scale){context.save();context.translate(-style.pos_x*scale,-style.pos_y*scale);context.translate(style.offset_x*scale,style.offset_y*scale);context.transform(style.matrix_a,style.matrix_b,style.matrix_c,style.matrix_d,style.matrix_e,style.matrix_f)},_popContextMatrix:function(context){context.restore()},_renderFillLine:function(o){if(!o){throw new Error("line renderer needs options")}if(!o.target){throw new Error("needs a target canvas context")}if(!o.object){throw new Error("no line to render")}var context=o.target,object=o.object,callback=o.renderCallback,scale=object.node.stage.zoom,fillStyle=$.extend({},object.style),c,tmpCtx,fillLine,transform,values,offset,strokeScale=[1,2,3,17];fillStyle.stroke=object.style.fill;this.generateArrowMarkerAttributes("start",fillStyle,fillStyle.start_arrow);this.generateArrowMarkerAttributes("end",fillStyle,fillStyle.end_arrow);if(object.style.stroke_width===6&&((fillStyle.start_arrow&&strokeScale.indexOf(fillStyle.start_arrow)!==-1)||(fillStyle.end_arrow&&strokeScale.indexOf(fillStyle.end_arrow)!==-1))){fillStyle.stroke_width=object.style.stroke_width-0.3;offset=1}else{fillStyle.stroke_width=object.style.stroke_width>3?object.style.stroke_width-2:object.style.stroke_width;offset=2}fillStyle.offset_y-=2;fillStyle.path=this._calculatePath(object,fillStyle,offset);if(!object.getStartArrow()&&!object.getEndArrow()&&context instanceof window.C2S){tmpCtx=new C2S(object.style.graphic_width*scale,object.style.graphic_height*scale);c=tmpCtx.canvas}else{c=document.createElement("canvas");c.width=object.style.graphic_width*scale;c.height=object.style.graphic_height*scale;tmpCtx=_gliffy.Utils.getContext(c)}this._pushContextMatrix(tmpCtx,object.style,object.node.stage.zoom);fillLine=new _gliffy.Linevg(fillStyle.path);fillLine.drawPath(tmpCtx,fillStyle);this._popContextMatrix(tmpCtx);if(object.style.single_canvas){context.save();transform=new _gliffy.AffineTransform(1,0,0,1,0,0).scale(object.node.stage.zoom,object.node.stage.zoom).translate(object.style.pos_x,object.style.pos_y).translate(-object.style.offset_x,-object.style.offset_y).scale(1/scale,1/scale);values=transform.getValues();context.transform(values[0],values[1],values[2],values[3],values[4],values[5]);context.drawImage(c,0,0);context.restore()}else{context.drawImage(c,0,0)}if(callback){callback()}},generateArrowMarkerAttributes:function(arrowPos,style,arrowType){if(arrowType===17){switch(style.stroke_width){case 4:style["marker_"+arrowPos+"_width"]+=7;style["marker_"+arrowPos+"_height"]+=7;break;case 5:style["marker_"+arrowPos+"_width"]+=4;style["marker_"+arrowPos+"_height"]+=4;break;case 7:style["marker_"+arrowPos+"_width"]+=1;style["marker_"+arrowPos+"_height"]+=1;break;case 9:style["marker_"+arrowPos+"_width"]+=0.5;style["marker_"+arrowPos+"_height"]+=0.5;break}}else{if(arrowType<4){switch(style.stroke_width){case 4:style["marker_"+arrowPos+"_width"]+=7.6;style["marker_"+arrowPos+"_height"]+=7.6;break;case 5:style["marker_"+arrowPos+"_width"]+=5;style["marker_"+arrowPos+"_height"]+=5;break;case 7:style["marker_"+arrowPos+"_width"]+=2.9;style["marker_"+arrowPos+"_height"]+=2.9;break;case 9:style["marker_"+arrowPos+"_width"]+=2.1;style["marker_"+arrowPos+"_height"]+=2.1;break}}else{switch(style.stroke_width){case 4:style["marker_"+arrowPos+"_width"]-=6;style["marker_"+arrowPos+"_height"]-=6;break;case 5:style["marker_"+arrowPos+"_width"]-=6;style["marker_"+arrowPos+"_height"]-=6;break;case 7:style["marker_"+arrowPos+"_width"]-=8;style["marker_"+arrowPos+"_height"]-=8;break;case 9:style["marker_"+arrowPos+"_width"]-=10;style["marker_"+arrowPos+"_height"]-=10;break}}}},_calculatePath:function(object,fillStyle,offset){var distance,startDistance,endDistance,startPoint,endPoint;distance=object.getPathLength();startDistance=0;if(fillStyle.start_arrow>0){startDistance=offset}endDistance=distance.totalDistance;if(fillStyle.end_arrow>0){endDistance=distance.totalDistance-offset}startPoint=object.getPointInPathAtDistance(startDistance);endPoint=object.getPointInPathAtDistance(endDistance);return this._buildStylePath(object.getDrawCommands(),startPoint,endPoint)},_buildStylePath:function(path,start,end){var newPath=[],i=0,args;for(i=0;i<path.length;i++){newPath.push({name:path[i].name,args:path[i].args})}if(start){newPath[0].args=start.x+","+start.y}if(end){args=newPath[newPath.length-1].args.split(" ");args.pop();args.push(end.x+","+end.y);newPath[newPath.length-1].args=args.join(" ")}return newPath}})}());(function(){var imageNotAvailable="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAYAAACAvzbMAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNui8sowAAAAWdEVYdENyZWF0aW9uIFRpbWUAMTEvMjAvMTL51e9HAAAgAElEQVR4nO3dOXAbV7YG4L+xA1ywL6TElA6HE1KpUjnVhKPslSdV5rKjp3KmeplcL5NDK6VSpVQyVUNHU48pKRLERuw70C/gnOsGCIAg2EB3A/8X2WMOcUkC+HHuuYv2z3/+UwcREdEjeeQfXC6XleMgIiKHGA6HAP4TIC6XC3/961/RbrfRbrcRCAQQCAQsHSAREdmPruv497//DV3X/6xAAKDdbuP29hYejwfJZJIhQkREiq7rKBQKCAQCGA6HGJm3CgQC8Hg86PV6yGaz6HQ6Vo2TiIhsZDAYoFAooFarAQC63e79AEkmk3C5XBgOh8jlcmi325YMloiI7EPCQ9M0dLtdtNtt3OucBwIB7O3twev1shIhItpwUkw0Gg0AQDgcRqvVgq7r9wMEAPx+/0glcnNzw0qEiGjD6LqOfD6Per0OANjd3UU0GlX/feraXalEPB4P+v0+crkcut3u8kdMRESWGw6HyOfzaDQa0DQN0WgU8Xgcmqapr5m5+cPv9yOVSsHtdqPf7+P6+prTWUREa24wGCCXy6nKY2dnB9FodCQ8gAcCBLirRNLpNFwul/qmrESIiNZXoVBAs9mEpmmIRCKIx+MTv26u7ecSIrLE9+rqiiFCRLRmBoMBstmsmraKRCKIxWL3Kg8x9/klwWAQqVQKmqapxjqns4iI1kc+n0ez2QQARCIRRCKRmV//qAOwAoEAMpmMqkRubm5YiRAROdxgMMDNzY0Kj3g8PrHnMe7RJygGg0Ekk0nVWOc+ESIi55q02iocDs/1/13oCF4JEZfLhX6/j3w+z0qEiMhhZJ+HsWH+0LSV0cJnuIdCIdVY73a7bKwTETmITFvJDvNIJDLXtJXRky4BkUpEGuu5XI7TWUREDvCUykM8+RapYDCozs7qdrvIZrOsRIiIbEqW6kp4xGKxmUt1ZzHlGsJAIIBEIqE2G3KJLxGR/QyHQ7VJELg722rehvkkpt1jK/tEZIkvd6wTEdmH8VRdY+XxFKZehB4KhdQS316vh+vra4YIEZHF5EBcqTzC4TAikchC01ZGpgYIMLrEV87O6vV6Zj8MERHNQdd1FR7SMDceyf4UpgcIcFeJyCm+ssS33+8v46GIiGiKfr+v7nN6asN8kqUECHAXIolEApqmqa4/p7OIiFZj0ibB3d1dUx9jaQECAFtbW0in06oS4XQWEdHyyYf2VqsFTdPmPtvqsZYaIMCfjXWXy4Vut8vGOhHREknvWcJjGZWHWHqAAKPTWXJ2FisRIiJzScO81WrB5XIhHo8vtMN8XisJEADY3t5WZ2d1Oh1cXV0xRIiITCKno49XHmZPWxmtLECAu0pELmXn9bhERObQdR2FQkGFRywWe9IO83mtNECAu8a67FjvdDrIZrOsRIiIFtTv93F9fa1WW8XjcYTD4aVWHmLlAQLchYixJ8KbDYmIHm8wGKBQKKh9HstsmE9iSYAA91dn5XI5bjYkIprTcDhU19C6XC7EYrGlNswnsSxAgLvGunHH+rdv3zidRUT0ADnbqt1uA7i7DGpV01ZGlgYIcH/HOjcbEhFNp+u6us9DKo9VNMwnsTxAgD8b6263WzXWB4OB1cMiIrIVaZh3u1212sqMU3UXZYsAAe5CRJb49no9rs4iIjKQGRrjwYirbJhPYpsAAe56ItJY73Q6uLm5ga7rVg+LiMhScrZVu92Gy+VCMpm0bNrKyFYBAvwZIpqmodvt4vLykpUIEW0s2erQ6XSgaRqi0Si2t7etHhYAGwYIcDedJSEi1+NyiS8RbRpd19V9Hi6XC4lEwhaVh7BlgACjS3w7nQ6ur68ZIkS0MeRacKk84vE4dnZ2rB7WCNsGCDC6Y73X6+Hm5obTWUS09uQyKGmY2zE8AJsHCPBniBgb61ziS0Trqt/v4+rqSoVHIpGwfLXVNLYPEADY2dkZaaxfX1+zEiGitSNLde08bWXkiAABRqezut0u8vk8eyJEtDbGl+raufIQjgkQ4K4SkcZ6u93G9fU1p7OIyPHGl+ravfIQjgoQ4K4SicViI411ViJE5FTGHeZytpUTwgNwYIAAd5WINNbb7TZ3rBORI8lSXWPD3E77PB7iyAAB7kJEzs6SfSJsrBORU/T7feTz+ZGDEe2yw3xejg0QYDRE2u028vk8KxEisj1j5eF2u5FKpRxVeQhHBwgA7O7uqtVZ7XYbV1dX7IkQkW31ej3k83n0ej1VeWxtbVk9rIU4PkCA+9NZuVyOq7OIyHaMS3XdbjeSyaRjGuaTrEWAAH9WItJY56VURGQnxuOYpGHutJ7HuLUJEOB+JcIlvkRkB+NLdROJhGOnrYzWKkCAuxCJxWKqEsnlcmysE5Fler0erq6u0Ol01GVQTp62Mlq7AAGAcDg80lj/9u0bKxEiWjm5z0imreLx+FpUHmItAwS4u09EdqzL2VnsiRDRqkjDvNPpqKW661J5iLUNEOCuEpE71lutFs/OIqKV6PV6yGazIw3zdao8xFoHCHC/EuH1uES0TIPBAPl8XvU81jU8gA0IEODP1VlSibCxTkTL0O128e3bN7Xaap0a5pNsRIBomobd3V1Eo1HVWOcSXyIyk+ww7/f7a9kwn2QjAkTs7u4iEolA0zQ0m02enUVEpjAu1fV4PEin02tdeYiNChBN0xCNRtVmw1arxR3rRPQk0lsdDAaq8giFQlYPayU2KkCEsRKRnghDhIgeS1ZbSeWRSqXWftrKaCMDBAAikQgb60S0sG63q3qp67xUd5aNDRBprBsrkWw2y8Y6ET2o3+8jl8uh2+2q1VabMm1ltLEBIsLhsNonIpUIEdE0vV4P3759Q7fbVTvMnX6q7qI2PkA0TUM4HB652fD6+pqVCBHdI9NW0jBPJBIbWXmIjQ8QYdwn0mq1UCgU2FgnImUwGOD6+lpVHplMZuN6HuMYIAYyneVyudBsNnFzc4PhcGj1sIjIYt1uV52lp2kakskkgsGg1cOyHAPEQKazIpEIAKj7RFiJEG0uuQxKGubpdHqjp62MGCATGBvrsmOdiDZPt9vF5eWlCo9UKsXwMGCATKBpGiKRCKLRKACg2WxyxzrRhhlvmDM87mOAzBAOhxEOh3l2FtGG6Xa7uLq6Qq/Xg9vt5rTVFAyQGeRcG+N0Vi6XY2OdaI11Oh21gEbTNIbHDB6rB+AE4XAYg8EAlUoFjUYDuq4jmUzC7XZbPTQiMpHxeBKPx4NkMolAIGD1sGyLFcicotHoyFHwhULB6iERkYk6nY46zsjtdnOp7hwYIHOSo+AlRBqNBhvrRGui2+2qy6DkbCuGx8MYII8UiUTUPhEu8SVyPmmYd7tddRkUex7zYYA8kvFSKgBqxzorESLn6XQ6amEMd5g/HpvoCwqHwxgOhyiXy6qxnkql4HIxk4mcoNvtqmlor9fLhvkC+G73BDKdxX0iRM4iS3UHgwFcLhcSiQTDYwEMkCcwNtYBoNFocDqLyOZ6vR5yuRx6vZ66hpbTVothgJhgvBLhEl8ie+p2u/j27ZvaYb6pNwmahQFiAk3TEIvF1NlZrESI7Kfb7Y40zNPpNCuPJ2IT3UThcBj9fh/VahWNRkPNrWqaZvXQiDZau91GNpvFcDhU01bseTwdKxATydlZMp1Vq9WQz+d5dhaRheRen+FwqI5kZ3iYgwFiMpnO2tnZAQDU63UUi0WGCJEFJDzkbKtMJsPwMBEDZEni8bg6Cr5Wq7GxTrRi7XZ75GBEVh7mYw9kSWQ6CwAqlQrq9Tp0XUcikeApvkRL1ul0kM/nMRgM4Ha7GR5LwgBZslgsBgDqKHgASKfTVg6JaK11Oh1cXV1B13XuMF8yTmEtmfREjJsN2VgnWg7peei6rq6hZXgsDyuQFZAQ0XUdlUoFtVoNw+EQyWSSZ2cRmUR6HnK2VSqVgt/vt3pYa43vXisUi8VUY73RaKBYLFo9JKK1IJWH9DySySTDYwUYICskjfVwOAwAqNVq3LFO9ETjS3XT6TSnrVaEAWKBaDSK3d1dAHc9kVKpZPGIiJzJeA0tl+quHnsgFtA0DYlEAi6XC+VyGfV6HcDd3hH2RIjm02631YIU7jC3BgPEQtFoFIPBALVaDbVaTU1x8ewsotmMZ1uxYW4dBoiFpBKR3erVahUAGCJEM7RarZGzrdgwtw4DxGISIrquj4RILBbjdBbRGAkPWaqbTqfh8/msHtbG4juUTcTjcezs7EDTNFSrVS7xJRrTarXUqkVpmDM8rMUKxCakFJcAqdfragMiKxHadMaGudvtxt7eHrxer9XD2ngMEJuJx+Mj01m6riOZTFo9LCLLtFotZLNZdbZVKpVieNgEP9rajPREjJsNi8UidF23eGREq9dqtZDP56HrOlwuF9LpNBvmNsIAsSFZzru9vQ3g7iTfQqHAEKGN0mw21Q5zr9eL/f199jxshgFiY4lEAru7u2qZLxvrtCmMq63YMLcvBoiNuVwuJBIJVYnwjnXaBDJtNRwO1TW0nLayJzbRHUA2FlarVbVjPZFIWD0sItPJDnNd1+Hz+ZBMJll52BgDxAFcLtfI6iwJkVgsxh3rtDbGG+actrI/BohDGO9Yr9VqqFQq6o51IqeTTYJythV3mDsDeyAOIpWI9ESq1Spub28tHhXR0zSbTRUebreblYeDsAJxGCntAaBer+P29hbD4ZDTWeRIslRXGubcYe4sDBCHkp5Io9FApVJR/xuRU0jlIQ1z7jB3Hk5hOZTb7UY6ncbOzg6Au+msUqnEzYbkCMaGuZxtxWkr52EF4nDxeBzD4RCNRgPlchnD4ZCNdbK1RqOBXC43Unm43W6rh0ULYAXicHKKr7ESYWOd7KrZbKpjeaSKZuXhXKxA1oCEiFQit7e3GAwGvNmQbKVer6NQKGA4HMLn8yGTycDj4VuQk7ECWSPGY0+kJ0JkB81mUx1PItNWDA/n419wjcgaeuDu057xelxWImSVRqOhriTweDxIp9NcbbUmGCBrKJFIqBN8uWOdrGRsmPv9fiSTSYbHGuEU1hoa37Feq9VQLpe5xJdWqtlsqsqDO8zXEyuQNSWNddlsWCqVVGOdaNnq9bra5+H3+7lJcE2xAlljcux7KBQCcNdYl13rRMtiXKrr8Xg4bbXGGCBrzu12I5PJIBQKQdd1lEol7linpanVaupsK5/Pxx3ma44BsiGSyaQKkUqlgnK5bPWQaM00Go2RfR6ctlp/DJANIbt+t7a2oOs6yuUybm9vWYmQKWSToK7r8Hq9rDw2BJvoG0TTNNVYbzabqgqJRqMWj4ycbFLDnGdbbQZWIBtGVmdJJXJ7e8vGOi1Mpq2k8uC01WZhgGwgmc6S1VnFYpHTWfRo9XpdNcz9fj/29/cZHhuGAbLBpLEOAOVymY11mluj0VDTVjySfXMxQDaYLPFlY50eY3za6tmzZ6w8NhSb6IREIqEa6xIgsVjM6mGRDdVqNRUe0jDnQZ2bixUIqXOKtra2AACVSkWd5EskjKfqer1enqpLDBC643K5kEql1GZDaawTAaM7zP1+P/b29nifBzFA6E9ydlYgEFA9EVYiZOx58DIoMmKA0AiPx4P9/X0Eg0FVifAo+M1VrVZHVlvt7e1x2ooUBghNlEwmVYjc3t6yEtlAtVoNxWJRTVul02ku1aURDBCaSK4elRAplUrqdkNafxIeUnmwYU6TMEBoKpfLNTFEaL1Vq1V1qm4gEGDDnKZigNBMcnYWp7M2g7Hy4MGI9BAGCD3I4/Fgb29Prc4qFouczlpDUnnouo5AIID9/X1WHjQTA4TmlkqlRqazWImsD2PlEQgEkEwmucOcHsQAobl5PB5kMpl7IcJKxNnGp624VJfmxQChR9E0baQSkX0i5EyVSmWkYZ5Op1l50NwYIPRocnaWhAh3rDtTvV5Xh2fKPg/2POgxGCC0EDkK3liJcImvc1QqFeTzeVV5ZDIZrraiR2OA0MLkjnVZnVUqlVCv160eFj2gXq+jVCqphjmX6tKiGCD0JLLE1+fzQdd1FAoFNtZtStf1kaW6crYVp61oUQwQejJN09R01nA4RLFYRK1Ws3pYNKZaraqzrYLBIDKZDBvm9CQMEDKFx+NBKpVSlQins+xD13VUKhXVMOeR7GQWBgiZxu12Y29vT1Ui+XyejXUbKJfLKJVKGA6HCIVC2NvbY8+DTMEAIVO53W4kk0lWIjZRrVbVfS6BQACJRILhQaZhgJDpPB4Pnj17plZnFQoFViIrJgdfyg5zqTw4bUVmYoDQUsiO9UAggOFwiFKpxMb6CtVqNVV5BINBJBIJNszJdAwQWhq5lMrv96vNhpzOWi5pmMs+D1ltxcqDloEBQkslO9alEmFjfbmq1apqmAeDQaRSKVYetDQMEFo6OTtLKhFOZy2HhIdUHtxhTsvGAKGV8Hg82N/fH7mUiiFiDjnQUhrmMm3F8KBlY4DQyhjPzhoOhygUCmg0GlYPy/Gq1araJMjLoGiVGCC0Ul6vF+l0Gl6vVy3xZWN9MZMa5ryGllaJAUIrZ2ysDwYD5PN5TmctYDw8ksmk1UOiDcMAIUt4vV4kk0lViZRKJU5nzUl6HjJtFQwGeRkUWYIBQpbxer3Y29tTlUgul2MlModSqaQqj1AohHQ6DZeLL2VaPT7ryFIej2fk7Cw21merVCrq+uBQKIRkMsnwIMvwmUeWk0pEQoQ9kftkms9YeXCpLlmNAUK24Ha71bEnXOJ7X7lcRqVSUeHBhjnZAQOEbGPSEt9NDxE5VVcORtza2kI6nWblQbbAACFbkTvW/X6/aqxv8j6RcrmswkMqD24SJLtggJDtyPW4Uonk8/mNrESM19BubW2xYU62w2cj2ZLX68Xz589HGuubUokYL4MCoJbqctqK7IYBQraladpIYz2fz6PZbFo9rKWTaSsAbJiTrXHrKtma1+vFs2fPrB7GSkWjUUSjUauHQfQgViBERLQQBggRES2EAUJERAthgBAR0UIYIEREtBAGCBERLYQBQkREC2GAEBHRQhggRES0EAYIEREthAFCREQLYYAQEdFCGCBERLSQjTqN97/+67/UP799+xaHh4cWjmZznZyc4PPnz+rfH/O3OD8/x/v37wEAr169wvfff7+UMS7LxcUF3r17p/7diT+DvI4ODw/x9u3buf+bGcz8+y97rJuAFQhZ7uPHj7a756NYLOL8/Bzn5+emju3Lly8j//7161fTvjfRqjFAyHLFYvHeG6vVTk9P8f79e7x//x6Xl5emfd+zs7ORfy8Wi7i4uDDt+xOt0kZNYZF9ff78GUdHRzg4OLB6KEtzdnaGVqsFAHj+/LkKpq9fvzrq5/7f//1fq4dANsEKhCx1fHys/vnTp08WjmT5Tk9P1T+/efMGwWAQwP2qhMgpWIHMoVgsolgsAsDUZm+z2VSfKOPxOOLx+KMf5/z8XP3zot/DOI7nz58jFAo9+nsI48/91O81zYsXL0b6DV++fMHLly9NfYyLi4uRT/7L+Dke0mw28ccffwC4+9seHBzg6OgIX79+RbFYxNnZGY6OjlY+LjOec3Z5fOPfeRkLZFbxenAaBoiBrO44ODjA69evcX5+jo8fP6onDQAEg0G8fPlSrf64uLjAp0+fRl4IwN0T7M2bNw9OTVxcXODk5ES9uRjF43EcHR3h1atXDz5Zp43j8PAQr1+/xsHBwb2fb5Jms4kvX77gy5cv6sVo/JlevnyJFy9ezBzLY7158wY//vgjgLsVWsfHx09+cTabTXz69Glk2kjM+jk+ffqEi4uLkb/577//rsYjv8vHMlYZEhQSIPLfpwXI6emp+rpZfztRLBbx8ePHqV//1OfcPM+jWcx6zgOzn6/Hx8f4/vvvnxRKVrwenIQBYmB88z09PcVvv/1272tarRY+f/6MVquFo6MjfPjw4d4TCwAuLy/x/v17vH37duobzrTHENJcPj09Xfj7nJ+f4927d/j73/9+L1zGXVxc4Ndffx158xz/mX777Td8/foVP/zwg2mfwOLxOF69eqV+rx8/fsQ//vGPhb/fxcUF3r9/P/HvAsz+OS4uLu79noxN9Gnf8yHGRQJSYR0dHSEYDKLVas2cxvruu+/U3/f8/PzBN9fT01P1MxinCOW/PfU599DzaBaznvPA3d9i1iKHr1+/4uzs7MHvM41VrwcnYYBMIG8iwWAQL168UJ8MjZ8E5UnearVweHiI4+NjJBIJFAoFfP36Fefn52i1Wjg5OZn4ZlgsFkdeSMbvIWP48uULisUiWq0Wfv31V/zyyy/3vs/5+fnI9zk+PsbR0RFCodDIWB7qLzSbzZE33fHxnJ2dqZ/3/Pwcv/76q6lr57///ns1nfPHH3/g/Px8oWmIYrE48+f4v//7P/U4sqfg559/Vv9/eaOZNl0hfYvHjsk4rWj8RCxViITIpCokHo+PNN3Pzs5mfuo1Lg02fj+znnOLMvvxjaE8/rz//Pmz+j7v37/HL7/88qg3eKtfD07BAJmg1WohGAze++Qib2jyAm21Wjg+PsabN29GvubFixf48ccf1ZvhJMaG6vj3kO9zfHyMd+/eqTezi4uLe5+kZKoCAH744YeRNwwZy8ePHx/cb/Dx40f1Yvn73/9+7w3q8PAQr169Up/4zs/PcXp6amr5/ubNGzU98vHjR/z000+P/lRn/DkmbTQ7PDzEy5cv1c9xeXmJk5MT9XUyJWPc7Pi3v/3tSXPqxje68d+XcRrr9PR06jTWixcv1IeAWQFinH4bnwo06zm3qGU8/rTX6YsXL/D+/Xv1Qe7Tp0/3Hm8WO7wenICrsKaYNtdtfIEHg8Gpc8DGqYNJJb/xf5u2mzYUCo18n/Hpk9PTU/Vm8erVq6lvPm/evJn5BnhxcaGC7tWrV1NfBKFQaORFaPbqIXkDARbbG2Kcfjo8PJz5e3379q2qJpa9B2VS/8P47zKOP/74Y+qmRePzYNbXTas+AHOec0+xjMef1Wdc9Llql9eDE7ACmWLWk0ZIybyI169fqxfHok0+4wvyoU8+x8fHU+eujW86D62AOjg4UNMp06qrp3j9+rVqfD92b8hjfo5QKDQyfbTolNlDzs/PR6bCJv2tx5vpk/6WoVAIf/nLX9TvfNrXyZuYNKONzHjOPYXZjz/pZxz/7/I7e8zf2E6vB7tjBTLB8+fP5/q6p7wIDg4OcHh4OPUJLSXxrE/HsoM5GAw+OJbvvvvuwe9zeHg4VyAav9e0BuOiQqHQSFX3mL0hxh3d8yyJNf7ul7Ub3DhtM+3NyDjWWZ9ijYEx6evOzs7U32PSz2/Gc+4pzH78ecLA+Fyd929sp9eD3bECmWCVqykuLi5wdnamqoPHrHCRpuo8n9BnBYzxsY0HTs6jWCya/mn2xYsXqvn/mL0h8nPM+wFAGqIAlnYWl/GN/suXLw/2ov7444+pv1Pjqi2ZxjI+V42PNev39ZTnnBnMevx5nnfG18a8f2O7vR7sjAFikWaziY8fP84se2Vj1apf4HYwvjfk6Oho7hemXZZTyiodMe+ZWmdnZzOrlWnTXRIgh4eHE39XVj/nrH58Mh8DxCLj69dlqebBwYHaqXxwcICTk5OVvZji8fi9fQPz/H+WNRbj3pDff//9SXtDrLBoU/X09HRqgLx8+XJigBg3TE77G1r9nLP68R/LTq8Hu2KAWOD09HTk2JOHVklNI9MZ88y7znpByvcJBoO2uptifG/I2dnZzOriMb8P4G5PiDD7MEPj0SUA8D//8z8PVkay9Pvy8nLqVIi82crvRKaxpNcSDAYn9j/Mes4tahmPP09Pw/g18/6N7fp6sCM20S1g/GT60Atp1jLGSZve5nnMad/n8vJyrnliWS67ik+JxmWSnz59mjm+x/w+gMXeXOZl7HXMezSL8Y1/ViPZWJ2cnZ2NhNW0lYFmPecWtYzHn2dKcJG/sZ1fD3bDALGA8QXy0KewWW/8xjcc42qfccViceZ/n3cVkHyvd+/e4f379/j9999nfq0ZZOOfPPbJycnUr5339yHfS950py2vfQrj4897SKJxumTev/vZ2dnI105bzm3Wc25Ry3h8OU1gmmazObKsed6/sZ1fD3bDALGA8TiMWS+A8YMcxxmf6J8/f574plksFqee1yWOj4/VmGZ9ym82m/jw4YP6d7NPzZ3m1atXanyzPnWOf4KfNcVhfLE/9HM8doWW8eiSaVNKk8j0lHyPaeOX/Q3A3fPH+CY57c3ZrOfcopb1+L///vvUv8+nT59GTiWYl91fD3bCALGA8Q3lw4cPI2/8sgP7xx9/xNevX0deeONP5Hg8PrJn4rfffsN///d/4+TkBCcnJ/jw4QN+/PFHXF5ezlzaGgqF1Fxvq9XCu3fvcHp6qh6v2WyqG/qMZzqt6tiG8R2/00jjHfjzoL2Tk5ORN6SzszO8f/9+pPp46Of49OmT+p3O8+ZmnH567BHtxq+fteRXvk6W9ALTm+fj3/cpz7lFLevx5dBSY6VwcXGBDx8+qN/fY5+rdn892Amb6BZ48eIFvnz5gsvLS7RaLfz2228TTyh9/vw5/va3v6nzoX799VcAozfCyace2XAn5zsZSdPy3bt3U8f08uVLXFxcqKb1tDHJuFZ9cNzR0REODw8fnGf+/vvvUSwW1Q7zz58/qzOtxsXj8akru46OjtT/r1gsqn/+7rvvHpwKmWdKaZrj42MVQKenp1OPyjk6Ohr5hP3QY5n5nFvEMh7/5cuXODs7w+Xlpfq6ccFg8FFnYBm/t51fD3bBCsQib9++VdMQ44LBIF69eoWff/4Zh4eHD26Me/nyJX755RccHx+PvLk9f/4cr169wk8//TRXA/HNmzf44YcfZr5BHh8f4+3bt5bstTDe4vfQ171+/Xrm1x4fH+Onn36a+rMeHBw8atpDGI8umTWlNI1xGmvWMe9yFIuYtvfDyMzn3CLMfnw5SHHa7/jw8BA///zzwgsk7P56sAPtn//8p/zm7vgAABVESURBVO5yufDXv/7V6rFsJLmNTsrj77777t4Lotls4uvXr2g2m+omu8e6uLhQFchf/vKXB/dUnJ+f31vmOu/RDnby1J/DeMNjMBh01N3l06zqObfKx5fd7cBduB4eHpr6t1qX14NZ/vWvf2E4HDJANoXxIp9Jx5wTEc1LAoQ9EAeT61cBPHgj2qxjvomIFsEeiIPJmUGzbhyU84ek+SxHRhARPRUrEAc7Pj7GyckJWq2WOr3W2EyVuWbjSp0ffvjBquES0ZphD8ThLi4u8Ouvvz64PyEYDOIf//jHSs8/IqL1xB7Imjg4OMBPP/2kjrSQO6CBP1cNHR0dzX0eExHRvBggayAUCuHFixcbuROWiKzDJjoRES2EAUJERAthgBAR0UIYIEREtBAGCBERLYQBQkREC2GAEBHRQrgPhBwtm82i2WxC0zSEw2FEo1Fommb1sGZqNpvI5/MYDAZwu93Y39+H1+u1elhEj8YKhByp3+/j+vpahUcsFkMsFrN9eAB3Gz+TySQ0TcNgMMDNzQ263a7VwyJ6NAYIOc5wOEShUFBHtuzu7iIcDls8qscJhUJIpVJwu93odru4ublBr9ezelhEj8IAIUcZDAZq2srlciEejyMWi1k9rIVsbW0hmUzC5XKh1+shm82yEiFHYYCQY/T7feTzebTbbWiahkgkgnA47Ihpq2lCoRASiYQKkXw+j36/b/WwiObCACFH0HUduVxOVR7RaNRx01bTbG9vq+msTqeDb9++sRIhR2CAkO31+33c3NyoyiMajSISiTi68hgnlYg01vP5PEOEbI8BQram6zry+bxabRWJRLC7u2v1sJZia2sL6XQaHo8HnU4H19fXnM4iW2OAkG1Jw7zVakHTNMTjcUfs83iK8UqEq7PIzhggZEuDwQC5XE6FxzpXHuOMS3w7nQ5ubm4wGAysHhbRPQwQsh1pmLdaLbVUNxKJWD2sldra2lKVSLfbxfX1NSsRsh0GCNlKv98fmbaSymOdp62mGQ+RXC7HngjZCgOEbMU4bRWLxdZmqe6idnZ2kEql4HK52Fgn22GAkC3I2VayVDcejzt+k6BZtra2EI/HoWkaer0eG+tkGwwQstx4wzwajW5Mw3xeUolIYz2bzULXdauHRRuOAUKWkqW6Unlw2mo6Y0+k1+vh27dvrETIUgwQsky/30cul0On04GmaUgkEpy2eoAcwGhsrHOJL1mFAUKW0HVdrbaSpbrb29tWD8sR5OwsaaxfXV2xEiFLMEBo5aRh3u12VeWxqUt1FzU+nZXP5xkitHIMEFopaZgbex6sPBazvb2NZDIJt9uNdruNbDbL6SxaKQYIrYyxYe5yuZBMJtkwf6Lt7e2RSoRLfGmVGCC0EnIkuzTMo9EoKw+TyHSWy+VCu91GPp/nEl9aCQYILZ2u6+o+D5fLpVZbkXl2dnbUZsN2u42rqyvuWKelY4DQUvV6PVxfX6vKIx6PY2dnx+phraWdnR3EYjFomoZOp8MlvrR0DBBaGrkMyng8CcNjucLhMJLJpJrOYmOdlokBQkvR7/dxdXWlwkOW6tLybW9vj1QiNzc3nM6ipWCAkOlkqS6nrayzs7Mz0li/ubmxeki0hhggZCpj5SENc1Yeq6dpmgoRqUS+ffvGSoRMxQAh0xj3IbDysIft7W21OouNdTIbA4RMMRgM1D4PqTwYHvawu7vLxjotBQOEnkyW6srZVslkkuFhM+OVCBvrZAYGCD1Jv99HPp8fORhxa2vL6mHRBBIixsY6d6zTUzBAaGFSebTbbbjdbqRSKVYeNqZpGnZ3d0ca67xjnZ6CAUILMR4hLqfqsvJwBuM+kXa7jUKhwEqEFsIAoUcznqrrdrvZ83CgcDiseiLNZpOVCC2EAUKPMr5UN5FI8FRdh9rd3UUkEhmpRLg6ix6DAUJzM14GJUt1OW3lbJFIBLFYDC6XC81mEzc3NxgOh1YPixyCAUJz6fV6uLq6Uvs8OG21HjRNQzgcRiQSAQC0223kcjlOZ9FcGCD0oF6vh1wuN7LDnJXHegmHwyOVSC6Xs3pI5AAMEJqp3+8jm82i0+lwqe4a0zRNTWdJT4SNdXoIA4Sm6na7yGazrDw2yO7uLqLRKDRNQ6vVQj6fZ0+EpmKA0EQybdXtdlXlwdVWm0GmsyRE2FinaRggdE+321VnW0nDnJXH5pDG+niIcDqLxjFAaITsMO/3+2qfRygUsnpYZIFJ01lERgwQUoxLdT0eD9LpNKetNpg01mXHeqvVwtXVFSsRUhggBOBu2kouG5KGOSsPAv7csQ6AZ2fRCAYIodfrqaW6Ho8HqVSKPQ8aEY1G1Sm+smOdx54QA2TDdbtd1SDlfR40y+7uLsLhMACg2Wzy7CxigGyyfr+vlurKaitOW9Es0WhUNdYbjQby+TynszYYA2RD9Xo9fPv2jfs86FE0TUM0GlU9ETn2hJXIZmKAbCCZtpKGOZfq0mNFIhF1FLxUIrR5GCAbZjAYqE2CbrcbmUyGPQ96NLmFMhaLAQAb6xuKAbJBOp0Orq6uVOWRTCYRDAatHhY5WDgcRjgcHqlEeOzJ5mCAbAjjTYIulwvpdJrTVmSKWCymGuvNZpON9Q3CANkAUnn0+3243W6GB5lKdqzLEt9Go8HprA3BAFlzxh3mLpcLqVSK01a0FMYlvlKJ0HpjgKyxbreLq6sr9Ho9dbYVw4OWRZb4GkMkm82yElljDJA11el01D0Omqax8qCVkTvWWYmsPwbIGpJ9HlJ5ZDIZBAIBq4dFG0J6ItFoFABUiHB11vphgKyZTqeDbDarGuZcqktWGG+s12o1hsgaYoCskW63qy6DkrOtGB5kpVgsNrJPpFgsWj0kMpHH6gGQOaRhPhwO4fF4GB5kC3K3jKZpKJfLqNVq0HUd8Xgcbrfb6uHRE7ECWQOdTge5XE41zBkeZDfRaBS7u7sAgHq9jkKhYPGIyAwMEIfrdrvIZrPodrvwer3Y29tjeJDtyKGd0ljnsSfrgQHiYLJUVzYJJhIJrrYiWzNWImysOx97IA7VbrdVeHg8HiQSCVYe5AjxeBwulwuVSgWNRkMt+CDnYQXiQMbwkKW6PNuKnEKOgjdWIjw7y5kYIA7T6XSQz+dVePB4EnIqWeIL3PVE2Fh3HgaIg7TbbVxfX6PX68Hr9SKdTrPnQY4lS3zHr8dlT8Q5GCAO0W631YtLTtVleNA6iEajCIfD0HUd9Xqd94k4CAPEASQ8+v2+OtvK7/dbPSwiU0hPZHzHOkPE/hggNicNcwkPVh60jmQ6a2dnBwBQrVZRKBQYIjbHALGx8YY5w4PWXSwWw87ODjRNQ61WQ6lUsnpINAP3gdiUXEOr6zq8Xi+SySTDg9ae7AmRfSKVSgXD4VDtHSF74V/EhqTnoeu6ugyK4UGbRCoRAKxEbIwViM0YNwl6vV6kUik2zGnjyNlZUolUq1UAUCf7kj2wArERqTyMO8wZHrSppLG+vb0N4K6xztVZ9sIKxCZarZa6DIqrrYj+lEgkoGka6vW6qkQSiYTFoyKAAWILMm0ll0ExPIj+ZDxssVaroVqtqkup2Fi3Fn/7FjPuMOdSXaLpjPtEarUar8e1AVYgFpKzrXRdh8/nQyqVgs/ns3pYRLY0vsS3Xq/D5XIhFouxsW4RViAWabVauLm5ga7r6mwrhgfRw2SJr67rqFQq3LFuIQaIBVqtllpt5fV68ezZM4YH0Zxkia8cBV+r1XB7e2vxqDYTA2TFpPKQmwRTqRS8Xq/VwyJylPGzs8rlMisRCzBAVqjdbqs7oN1uN/b29rjPg+gJYrEYtra2ANztE2ElsloMkBVptVq4vr5Gv9+H1+tFJpNh5UH0RHIrp1QilUqFmw1XiAGyArJJUBrm6XSalQeRieLxOLa2tlRjnWdnrQaX8S5Zs9lUR7LLNbRsmBOZy7jEt1aroVKpQNM0RKNRLvFdIlYgS2RcbSUNc4YH0XJIiEhPpFwuo1QqcTpriViBLIlMW8nxJJlMhuFBtAJyTlaz2USlUgFwN8VF5mMFsgTNZhPZbBb9fh8+n4/TVkQrJI114+osNtaXgwFismazqdajyw5zNsyJVi+RSIw01nl2lvkYICZqNBq4ublBv9+H3+/H/v4+Kw8ii8gHOOMBjLe3t6xETMQAMYmx8pDLoBgeRNaSY0+kErm9veV0lonYRDdBs9lUR7L7/X6k02l4PPzVEtmBpmlIJpMjl1J5PB5EIhGrh+Z4rECeqNlsqsugfD4fkskkw4PIZmQ6Sxrrt7e3XOJrAr7TPYFxh7mcbeV2u60eFhFNIUt8G40GyuWy2mxIi2EFsqBGo4FsNovBYACfz8fwIHIAufUzFAoBuNtsyMb64hggCxhvmHOfB5FzSE/E2FjnKb6L4RTWI9XrdRQKBdXzyGQy7HkQOYzb7UYikYCu62rHutvtVpdU0XxYgTyCHIwo4ZFKpRgeRA5l3LGu6zqKxSKX+D4SA2ROjUZDTVt5PB5OWxGtAdknIj2RarWqzs+ihzFA5tBoNJDL5dQOc14GRbQ+3G43MpnMSE+ES3znwwB5gLHykBUcrDyI1o9UIrquo1wuo1wuWz0k22OAzFCr1dR9HnK2FSsPovUkHxCN94lwOms2BsgUjUZDNdS8Xi9SqRTDg2jNyY51qURKpRIb6zMwQCao1WpqtVUgEGDlQbRBZJ+IhEilUmElMgUDZIz0PORgxGQyyR3mRBtGGuuyOuv29hblcpmVyBgGiIFsEpRpK662Itpsxkrk9vYW1WrV6iHZCgPkP+r1OvL5vGqYZzIZVh5EG04a64FAQIVIpVJhJfIfDBCMLtVlw5yIjFwuF9LpNEKhEIbDIUqlEpf4/sfGB0i9Xh+5DIoNcyIaJ2dnSSVSLpc5nYUND5BGo6Hu85CzrThtRUSTeDwe7O3tqZ5IsVjc+KPgNzZAxqetnj17xsqDiGaSs7OCwaCqRGq1mtXDssxGBsj4DvNMJgNN06weFhE5gMfjQSaTUSEiPZFNrEQ2LkDGd5in02lWHkT0KJqmIZVKIRgMYjgcbuwS340KkEqlMtIw39vb430eRLQQWeJrrEQ2LUQ2JkBqtZo6opmXQRGRGWTHuoRIsVjcqOmsjQiQSqWipq0CgQAb5kRkGjk7y7jZcFMqkbUPEKk8hsMhgsEgkskkG+ZEZCqPx4P9/f2R6axarbb2lchaB0itVlOVh9/v5w5zIloqYyVSKBTWfonv2gZItVpVp+oGAgGebUVES+fxeJBOp+H3+1UlUq/XrR7W0qxlgEyqPBgeRLQK0lgPBAIYDofI5/Nre5/I2gWIVB7SMN/f3+dqKyJaKVnia6xE1nE6a60CxFh5BAIBNsyJyDLSWJeeSLFYXLtKZG0CZHzaam9vjw1zIrKULPGVHevrVomsRYBUKpWRhnk6nWblQUS2IHcMyXRWsVhcmxBxfIDU63V1pLLf70c6nWbPg4hsZbyxXigU1mKzoaMD5Pb2Fvl8nkt1icj2xhvr61CJODZAqtWqqjwCgQCX6hKR7Y031p1eiTguQOQSl1KpBAAIBAI8VZeIHGP87CwnVyKOCxCpPIbDIUKhEFKpFBvmROQoXq8Xe3t7jp/OckyA6LqOSqVyb9qKlQcROZGmaUin0yONdaeFiGMCRKatpPJIp9NwuRwzfCKie+TsLK/XqyqRRqNh9bDm5oh34Gq1qi5pCQQCSCQSbJgT0Vpwu91qOms4HCKXyzmmErF1gMjlLLLDPBQKsWFORGvH4/EglUrB5/Op1VlOqERsHSC1Wk1VHsFgEIlEgg1zIlpL0lg3hojdKxFbBog0zOUO82AwiEwmw8qDiNaa2+1WjfXBYIBCoWDr+0RsGSDVanXkGlou1SWiTSFnZzmhsW67AJHwkMqDO8yJaNN4PB51dtZgMLBtY902ASI7zKVhLtNWDA8i2kRerxfJZNLWlYhtAsTY8+BlUEREdyEiZ2fJ9bh2qkQsDxBZqnt7ewsACAaDvIaWiOg/3G43ksmk2idipyW+lgfI7e2tWqorZ1sREdGfvF4vMpmMms6yy+osywJEeh6VSgW6rmNrawvpdJo9DyKiCeRSKr/fj8FggHw+j2azaemYLAuQUqmkDkYMhULseRARPUCW+Lrdbui6bnmIWBIglUoF1WpVVR7JZJIHIxIRzcHr9eLZs2fw+Xxqia9V01krfdfWdR2lUkmttpJTdTltRUQ0P+PZWbI6y4pKZKUBYux5yLQVERE9ns/nQzqdhsfjsewAxpUEiCzVldVWbJgTET2drM7y+/3o9/vI5XIrDZGVBEi5XB5ZqsuGORGROXw+30hjvVgsrmw6a+kBYryGlg1zIiLzyY51qURubm5W0lhf2ju58TIoAGyYExEtkZydZeyJLLsSWVqAyLQVADbMiYhWwOfzqUupZHXWMnsipgeIzMEZG+Y8VZeIaDVks6Fxn0ir1VrKY5keIMVicWSpbiKRMPshiIhoBp/Ppz6467qOXC63lOks0wJEeh5y1PDOzg57HkREFvF4PNjf31eVyM3NDdrttqmPYUqAyLSVcbVVIpHgUl0iIgvJdJbL5YKu67i5uTF1OsuUALm9vUW1WgUAbG9vc58HEZFN+Hw+PHv2DF6v1/SeyJMCRJaKVSoVAMDW1pZKOyIisgepRDwej5rOMiNEnvROXyqV1Km629vbbJgTEdmU3+/H3t4e3G63WuL71J7IQgEiPY/xaSs2zImI7Mt4s2G/38f19fWTKpGFAsS4VHdnZ4cNcyIih/D7/Uin06qxns/nFw6RRwfIeMM8Ho+z50FE5CA+nw/7+/uqEll0n8jc7/zSML+9vQVwFx5smBMROZOc4iuN9UVWZ8397m+sPLa2thCPxx83WiIishW/349MJgOPx6Ma648JkQcDZDgcjizV5Q5zIqL1ITcb+nw+9Pt9ZLPZuVdnPRggxqW6rDyIiNaP3+8f2bE+byUyNUCk5yHTVru7u7wMiohoTUlj3efzodfrzXV21sQ0mLTPI5FIMDyIiNaYz+dTe/qGwyFyudzMEJmYCBIemqapfR5ERLT+ZMe6x+NRS3w7nc7Erx0JEGmYj+8wZ+VBRLQ5jEt8Zcf6pEpkJBnGp63YMCci2kyBQEDtWJclvuOVyEiAyE7EcDjMTYJERBtO9ol4vV70er17lchIQsRiMSQSCcRisZUPlIiI7CcQCKiCQhrrHo8HAOAB7nof//rXvywdJBER2Zfb7UYoFEK/31eH53rkPw6HQ8sGRkRE9jYcDtFoNOB2u9Hv9wEA/w9ZPyqYyhmyLwAAAABJRU5ErkJggg==";_gliffy.Renderer.ImageCanvas=_gliffy.Renderer.extend({id:"Gliffy.Renderer.ImageCanvas",target:null,init:function(){_gliffy.renderers[this.id]=this},getUrl:function(object){return object.getUrl()},render:function(o){if(!o){throw new Error("shape renderer needs options")}if(!o.target){throw new Error("needs a target canvas context")}if(!o.object){throw new Error("no shape to render")}var context=o.target,object=o.object,renderCallback=o.renderCallback,scale,transform,offsetX,self=this,offsetY,image,url=this.getUrl(object),canvas,ctx;if(object.node&&object.node.stage){scale=object.node.stage.zoom;offsetX=(object.style.single_canvas)?0:object.style.offset_x;offsetY=(object.style.single_canvas)?0:object.style.offset_y;if(url===undefined||url===null){url=imageNotAvailable}if(object.node.hasFlag("skin")){if(url===imageNotAvailable){_gliffy.Logger.error("image does not have a valid url.")}image=new Image();image.onload=function(){if(url&&(url===self.getUrl(object)||url===imageNotAvailable)){object.imgWidth=image.width;object.imgHeight=image.height;if(object.node&&object.useOriginalDimensions){object.node.setWidth(object.imgWidth);object.node.setHeight(object.imgHeight);object.node.clampTo(_gliffy.Mouse.editor.getDocumentManager().getActiveStageViewPort());object.node.update();object.useOriginalDimensions=false}context.save();if(object.style.single_canvas){transform=object.node.worldTransform.getValues();if(!o.ignorePan){context.translate(object.node.stage.pan_x,object.node.stage.pan_y)}if(!o.ignoreZoom){context.scale(scale,scale)}context.transform(transform[0],transform[1],transform[2],transform[3],transform[4],transform[5])}else{context.canvas.width=object.style.graphic_width*scale;context.canvas.height=object.style.graphic_height*scale;context.scale(scale,scale);$(context.canvas).css({width:"",height:""})}if(object.isDropShadow()===true){context.save();context.translate(object.style.shadow_x,object.style.shadow_y);context.fillStyle="rgba(0,0,0,0.294117647)";context.fillRect(0,0,object.style.width,object.style.height);context.restore()}var linkNodeArray=object.node.findGraphic(_gliffy.Link);if(linkNodeArray.length>0){context.__pathHref=linkNodeArray[0].getGraphic().getHref()}if(context instanceof C2S&&url.indexOf("data:")===-1){canvas=document.createElement("canvas");canvas.width=image.width;canvas.height=image.height;ctx=canvas.getContext("2d");ctx.drawImage(image,0,0);context.drawImage(canvas,offsetX,offsetY,object.style.width,object.style.height)}else{context.drawImage(image,offsetX,offsetY,object.style.width,object.style.height)}context.__pathHref=null;context.restore();object.node.resetFlags();if(renderCallback){renderCallback()}}};image.onerror=function(){_gliffy.Logger.error("image did not load.");_gliffy.handleError("com.gliffy.error.file_malformed",[],new Error("image did not load"));image.src=imageNotAvailable};image.src=url}else{$(context.canvas).css({width:object.style.graphic_width*scale,height:object.style.graphic_height*scale});object.node.resetFlags();if(renderCallback){renderCallback()}}}else{if(renderCallback){renderCallback()}}}});_gliffy.Renderer.ImageCanvas.imageNotAvailable=imageNotAvailable}());(function(){_gliffy.Renderer.NodeCanvas=_gliffy.Renderer.extend({id:"Gliffy.Renderer.NodeCanvas",target:null,init:function(){_gliffy.renderers[this.id]=this},render:function(o){var ctx=o.target,object=o.object,callback=o.renderCallback,renderers=o.renderers,singleCanvas=o.singleCanvas,viewbox=o.viewboxDom,loadImage=singleCanvas||o.loadImage,graphic=object.getGraphic(),ignorePan=o.ignorePan||false,ignoreZoom=o.ignoreZoom||false,nodeCallback;_gliffy.Utils.tryCatch(function(){if(!o){throw new Error("shape renderer needs options")}if(!o.target&&!o.container){throw new Error("needs a target")}if(!o.object){throw new Error("no shape to render")}if(!o.renderers){throw new Error("no renderers defined for node")}nodeCallback=function(){if(!object.isProxy()&&object.supportsIcon()){if(renderers.popupNotes){_gliffy.renderers[renderers.popupNotes.prototype.id].render({target:object,viewboxDom:viewbox})}if(renderers.link){_gliffy.renderers[renderers.link.prototype.id].render({target:object,viewboxDom:viewbox})}}if(!object.isProxy()&&object.supportsConnections()&&renderers.controls){_gliffy.renderers[renderers.controls.prototype.id].render({target:object,renderCallback:callback,viewboxDom:viewbox})}else{if(callback){callback()}}};if(graphic&&(singleCanvas||graphic.node.hasRedrawCanvasFlag()||(graphic instanceof _gliffy.Text&&graphic.node.hasFlag()))){graphic.style.single_canvas=singleCanvas;if(graphic instanceof _gliffy.Line){_gliffy.renderers[renderers.line.prototype.id].render({target:ctx,object:graphic,renderCallback:nodeCallback,ignorePan:ignorePan,ignoreZoom:ignoreZoom})}else{if(graphic instanceof _gliffy.Image){if(singleCanvas){object.setFlag("skin")}_gliffy.renderers[renderers.image.prototype.id].render({target:ctx,object:graphic,renderCallback:nodeCallback,loadImage:loadImage,ignorePan:ignorePan,ignoreZoom:ignoreZoom})}else{if(graphic instanceof _gliffy.Svg){_gliffy.renderers[renderers.svg.prototype.id].render({target:ctx,object:graphic,renderCallback:nodeCallback,ignorePan:ignorePan,ignoreZoom:ignoreZoom})}else{if(graphic instanceof _gliffy.Shape){_gliffy.renderers[renderers.shape.prototype.id].render({target:ctx,object:graphic,renderCallback:nodeCallback,ignorePan:ignorePan,ignoreZoom:ignoreZoom})}else{if(graphic instanceof _gliffy.Text){_gliffy.renderers[renderers.text.prototype.id].render({target:ctx,object:graphic,renderCallback:nodeCallback,stage:o.stage,container:o.container,zIndex:o.zIndex,ignorePan:ignorePan,ignoreZoom:ignoreZoom,preRender:o.preRender})}else{if(_gliffy.Proxy&&graphic instanceof _gliffy.Proxy){if(singleCanvas){object.setFlag("skin")}if(renderers.proxy){_gliffy.renderers[renderers.proxy.prototype.id].render({target:ctx,object:graphic,renderCallback:nodeCallback,loadImage:loadImage,ignorePan:ignorePan,ignoreZoom:ignoreZoom})}else{_gliffy.Logger.warn("Unable to render proxy node because proxy renderer does not exist.")}}else{if((_gliffy.PopupNote&&graphic instanceof _gliffy.PopupNote)||graphic instanceof _gliffy.Link){if(nodeCallback){nodeCallback()}}else{throw"draw not implemented for "+graphic.getClassName()}}}}}}}}else{nodeCallback()}},function(e){if(graphic){_gliffy.Logger.error("Node "+graphic.node.getId()+" failed to render. "+JSON.stringify(graphic.node.toObject()))}else{_gliffy.Logger.error("Node failed to render.")}throw e})}})}());(function(){_gliffy.Renderer.StageSingleCanvas=_gliffy.Renderer.extend({id:"Gliffy.Renderer.StageSingleCanvas",target:null,_mockStageInfo:null,init:function(){_gliffy.renderers[this.id]=this},render:function(o){if(!o){throw"stage renderer needs options"}if(!o.target){throw"needs a target container"}if(!(o.object&&o.object instanceof _gliffy.Stage)){throw"needs a stage object to render!"}var options=$.extend({},{renderCallback:null,textRenderer:_gliffy.Renderer.TextHtml2Canvas,shapeRenderer:_gliffy.Renderer.ShapeCanvas,svgRenderer:_gliffy.Renderer.SvgCanvas,lineRenderer:_gliffy.Renderer.LineCanvas,imageRenderer:_gliffy.Renderer.ImageCanvas,forceUpdate:false,whitespace_x_padding:20,whitespace_y_padding:20,show_progress_bar:false,ignorePan:true,ignoreZoom:false,hideHiddenNodes:true,boundingBoxFit:false,linkMap:false},o),i=0,stage=options.object,container=options.target,ctx=o.context,forceUpdate=options.forceUpdate,nodeRenderer,c,width,height,objects,renderers={text:options.textRenderer,shape:options.shapeRenderer,line:options.lineRenderer,image:options.imageRenderer,svg:options.svgRenderer},bb,scale,offsetX=0,offsetY=0,bounds,self=this,delayEvery;_gliffy.Utils.setupAnimationDelay();this._mockStageInfo=this._setupMockStage(options);html2canvasClearCache();if(!_gliffy.renderers[options.textRenderer.prototype.id]){_gliffy.renderers[options.textRenderer.prototype.id]=new options.textRenderer()}if(!_gliffy.renderers[options.shapeRenderer.prototype.id]){_gliffy.renderers[options.shapeRenderer.prototype.id]=new options.shapeRenderer()}if(!_gliffy.renderers[options.svgRenderer.prototype.id]){_gliffy.renderers[options.svgRenderer.prototype.id]=new options.svgRenderer()}if(!_gliffy.renderers[options.lineRenderer.prototype.id]){_gliffy.renderers[options.lineRenderer.prototype.id]=new options.lineRenderer()}if(!_gliffy.renderers[options.imageRenderer.prototype.id]){_gliffy.renderers[options.imageRenderer.prototype.id]=new options.imageRenderer()}if(!_gliffy.renderers[_gliffy.Renderer.NodeCanvas.prototype.id]){_gliffy.renderers[_gliffy.Renderer.NodeCanvas.prototype.id]=new _gliffy.Renderer.NodeCanvas()}nodeRenderer=_gliffy.renderers[_gliffy.Renderer.NodeCanvas.prototype.id];if(options.show_progress_bar){GliffyApp.progressBarController.show("Exporting to Image")}window.pauseSilverlightDetection=true;if(!ctx){c=$("<canvas/>");stage.update();bb=stage.calculateBoundingBox();scale=stage.zoom;if(options.ignoreZoom){scale=1}bounds=new _gliffy.BoundingBox();bounds.min.x=Math.max(0,bb.min.x-options.whitespace_x_padding)*scale;bounds.min.y=Math.max(0,bb.min.y-options.whitespace_y_padding)*scale;bounds.max.x=Math.min(bb.max.x+options.whitespace_x_padding,stage.maxWidth)*scale;bounds.max.y=Math.min(bb.max.y+options.whitespace_y_padding,stage.maxHeight)*scale;if(options.boundingBoxFit){width=bounds.getDimension().x;height=bounds.getDimension().y;offsetX=-bounds.min.x;offsetY=-bounds.min.y}else{width=bounds.max.x;height=bounds.max.y}c.get(0).width=width;c.get(0).height=height;container.append(c);ctx=_gliffy.Utils.getContext(c.get(0))}ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);ctx.save();ctx.fillStyle=stage.background;ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);ctx.restore();ctx.translate(offsetX,offsetY);ctx.save();stage.update();if(options.hideHiddenNodes){objects=stage.visibleFlattenedNodes(forceUpdate)}else{objects=stage.flattenNodes(forceUpdate)}if(renderers.text===_gliffy.Renderer.TextHtml2Canvas){for(i=0;i<objects.length;i++){if(objects[i].isText()){_gliffy.workQueue.queue(this.__createWorkQueueFunction(nodeRenderer,objects,i,ctx,renderers,container,$.extend({},{preRender:true},options)))}}}delayEvery=Math.max(Math.floor(objects.length/10),10);_gliffy.workQueue.animationDelay();for(i=0;i<objects.length;i++){if(i%delayEvery===0){_gliffy.workQueue.animationDelay()}_gliffy.workQueue.queue(this.__createWorkQueueFunction(nodeRenderer,objects,i,ctx,renderers,container,options))}_gliffy.workQueue.animationDelay().queue(function(next){if(options.show_progress_bar){GliffyApp.progressBarController.getBar().animate({width:"100%"})}window.pauseSilverlightDetection=false;ctx.restore();if(options.renderCallback){options.renderCallback();if(options.linkMap){self._generateDevLinkMap(stage.gon,options.target,ctx.canvas.width,ctx.canvas.height)}}next()})},_generateDevLinkMap:function(gon,target,width,height){var interval=setInterval(function(){var map=gon.getDevLinkMap();if(map){var transparentGifSrc="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";target.prepend($('<img id="gliffy-linkmap-image" usemap="#gliffy-dev-imagemap" width="'+width+'" height="'+height+'" src="'+transparentGifSrc+'"/>').css("position","absolute"));target.prepend(map);$("#gliffy-linkmap-image").maphilight({alwaysOn:true,strokeWidth:1,strokeColor:"0000ff",fillOpacity:"0.05"});$("#gliffy-linkmap-image").parent().css("position","absolute");clearInterval(interval)}},250)},_setupMockStage:function(options){var stageWidth,stageHeight,domStage,stage=options.object,container=options.target,self=this;if(options.fixedDrawingSpace){stageWidth=stage.maxWidth*stage.zoom;stageHeight=stage.maxHeight*stage.zoom}else{stageWidth=stage.width*stage.zoom;stageHeight=stage.height*stage.zoom}domStage=container.find(".gliffy-mock-stage");if(domStage.length===0){domStage=$('<div class="gliffy-stage gliffy-mock-stage"/>');domStage.css({position:"absolute",width:stageWidth+"px",height:stageHeight+"px",top:"0px",left:"0px",zIndex:-100});if(_gliffy.Debug.EXPORT_TEXT_DISPLAY){domStage.css({zIndex:610000,backgroundColor:"white"})}container.append(domStage)}return{domStage:domStage,stageWidth:stageWidth,stageHeight:stageHeight}},__createWorkQueueFunction:function(nodeRenderer,objects,i,ctx,renderers,container,options){var self=this;var date=new Date();return function(next){_gliffy.Utils.tryCatch(function(){nodeRenderer.render({object:objects[i],stage:self._mockStageInfo.domStage,target:ctx,renderCallback:function(){if(options.show_progress_bar){GliffyApp.progressBarController.getBar().queue(function(n){$(this).width(Math.floor(((i+1)/objects.length)*100)+"%");n()})}next()},renderers:renderers,container:container,singleCanvas:true,ignorePan:options.ignorePan,ignoreZoom:options.ignoreZoom,preRender:options.preRender})},function(e){_gliffy.workQueue.clearQueue();if(options.renderCallback()){options.renderCallback()}_gliffy.handleError("com.gliffy.error.render_failed",[],e,options.target)})}}})}());(function(){var AUTOFIT_PADDING=25;_gliffy.Renderer.StageMultiCanvas=_gliffy.Renderer.extend({id:"Gliffy.Renderer.StageMultiCanvas",target:null,__bindToScroll:true,__setupScrollEvent:false,init:function(){_gliffy.renderers[this.id]=this},disableScroll:function(){this.__bindToScroll=false},enableScroll:function(){this.__bindToScroll=true},__fixWebkitIframeFlicker:function(){if($.browser.webkit&&!_gliffy.EmbeddableViewer){var chromeFix,transform,canvasStyle;chromeFix=$("#gliffy-webkit-fix");if(chromeFix.length===0){transform=new _gliffy.AffineTransform(1,0,0,1,0,0);canvasStyle=$.extend(_gliffy.Utils.transformCss(transform),{visibility:"hidden",position:"absolute",zIndex:1});chromeFix=$("<canvas />",{id:"gliffy-webkit-fix"}).css(canvasStyle).addClass("gliffy-graphic");$(".gliffy-stage").append(chromeFix);chromeFix.get(0).width=1000;chromeFix.get(0).height=1000;_gliffy.Utils.getContext(chromeFix.get(0)).fillRect(0,0,1000,1000)}}},render:function(o){if(!o){throw new Error("stage renderer needs options")}if(!o.target){throw new Error("needs a target container")}if(!(o.object&&o.object instanceof _gliffy.Stage)){throw new Error("needs a stage object to render!")}var options=$.extend({},{renderCallback:null,useTimer:false,textRenderer:_gliffy.Renderer.TextDom,shapeRenderer:_gliffy.Renderer.ShapeCanvas,lineRenderer:_gliffy.Renderer.LineCanvas,imageRenderer:_gliffy.Renderer.ImageCanvas,svgRenderer:_gliffy.Renderer.SvgCanvas,proxyRenderer:_gliffy.Renderer.ProxyRenderer||false,controlRenderer:_gliffy.Renderer.ControlRenderer||false,popupNotesRenderer:_gliffy.Renderer.PopupNotesRenderer||false,linkRenderer:_gliffy.Renderer.LinkRenderer,cssPan:false,panOnly:false,scrollForPan:_gliffy.Editor!==undefined,forceUpdate:false,queueRender:false,delayEvery:1,resizeTarget:true,pointerEvents:"auto",showGrid:_gliffy.Editor!==undefined,fixedDrawingSpace:_gliffy.Editor!==undefined,useImages:false,renderViewbox:true,renderGuides:_gliffy.Editor!==undefined,autoFitPadding:false},o),stage=options.object,container=options.target,renderers,stageInfo,canvasInfo,contexts,nodeRenderer,render_complete,flattenedNodes,j,node,object,currentStage,hiddenNodes=[],flattenedNonHiddenNodes=[],stageMulti=this;renderers=options.renderers={text:options.textRenderer,shape:options.shapeRenderer,line:options.lineRenderer,image:options.imageRenderer,controls:options.controlRenderer,popupNotes:options.popupNotesRenderer,link:options.linkRenderer,svg:options.svgRenderer,proxy:options.proxyRenderer};if(_gliffy.Editor&&!this.__setupScrollEvent){container.bind("scroll.gliffy_pan",function(){if(stageMulti.__bindToScroll){currentStage=_gliffy.Mouse.editor.getDocumentManager().getActiveStage();currentStage.pan_x=-container.scrollLeft();currentStage.pan_y=-container.scrollTop()}});this.__setupScrollEvent=true}stageInfo=this.__setupStageAndPan(options);this.__fixWebkitIframeFlicker();contexts=container.data("contexts");if(!contexts){contexts={}}this.__deleteNodes(stage.deletes,stageInfo.domStage,contexts);stage.deletes=[];render_complete=this.__afterRenderComplete(container,stage,stageInfo,contexts,options);if(options.cssPan){$(options.target).css({position:"absolute",left:stage.pan_x+"px",top:stage.pan_y+"px"});render_complete()}if(!options.panOnly){if(!_gliffy.renderers[options.textRenderer.prototype.id]){_gliffy.renderers[options.textRenderer.prototype.id]=new options.textRenderer()}if(!_gliffy.renderers[options.shapeRenderer.prototype.id]){_gliffy.renderers[options.shapeRenderer.prototype.id]=new options.shapeRenderer()}if(!_gliffy.renderers[options.svgRenderer.prototype.id]){_gliffy.renderers[options.svgRenderer.prototype.id]=new options.svgRenderer()}if(!_gliffy.renderers[options.lineRenderer.prototype.id]){_gliffy.renderers[options.lineRenderer.prototype.id]=new options.lineRenderer()}if(!_gliffy.renderers[options.imageRenderer.prototype.id]){_gliffy.renderers[options.imageRenderer.prototype.id]=new options.imageRenderer()}if(options.proxyRenderer&&!_gliffy.renderers[options.proxyRenderer.prototype.id]){_gliffy.renderers[options.proxyRenderer.prototype.id]=new options.proxyRenderer()}if(options.controlRenderer&&!_gliffy.renderers[options.controlRenderer.prototype.id]){_gliffy.renderers[options.controlRenderer.prototype.id]=new options.controlRenderer()}if(options.popupNotesRenderer&&!_gliffy.renderers[options.popupNotesRenderer.prototype.id]){_gliffy.renderers[options.popupNotesRenderer.prototype.id]=new options.popupNotesRenderer()}if(options.linkRenderer&&!_gliffy.renderers[options.linkRenderer.prototype.id]){_gliffy.renderers[options.linkRenderer.prototype.id]=new options.linkRenderer()}if(!_gliffy.renderers[_gliffy.Renderer.NodeCanvas.prototype.id]){_gliffy.renderers[_gliffy.Renderer.NodeCanvas.prototype.id]=new _gliffy.Renderer.NodeCanvas()}nodeRenderer=_gliffy.renderers[_gliffy.Renderer.NodeCanvas.prototype.id];if(!options.forceUpdate){this.__notifyNodes(stage);this.__notifyNodes(stage)}if(options.forceUpdate){stage.setBoundsDirty()}flattenedNodes=this.__flattenNodes(stage,options.forceUpdate);$.each(flattenedNodes,function(_,node){if(node.getNodeOrLayerHidden()){hiddenNodes.push("#gliffy_node_"+node.getId())}else{flattenedNonHiddenNodes.push(node)}});flattenedNodes=flattenedNonHiddenNodes;this.__deleteNodes(hiddenNodes,stageInfo.domStage,contexts);if(flattenedNodes.length===0){render_complete()}else{$(".gliffy-drawing-guide:hidden").remove();for(j=0;j<flattenedNodes.length;j++){node=flattenedNodes[j];object=node.getGraphic();canvasInfo=this.__setupNodeCanvas(node,object,contexts,stage,stageInfo,container,options);container.data("contexts",contexts);if(options.queueRender){if(j%options.delayEvery===0){_gliffy.workQueue.delay(1)}_gliffy.workQueue.queue(this.__createWorkQueueFunction(j,node,canvasInfo,options,flattenedNodes,render_complete,nodeRenderer,container,stageInfo))}else{_gliffy.Utils.tryCatch(function(){if(options.fixedDrawingSpace||canvasInfo.bounds.inViewport){nodeRenderer.render({object:node,target:canvasInfo.ctx,renderCallback:stageMulti.__createSimpleLoopCallback(canvasInfo,options,node),renderers:renderers,singleCanvas:false,container:container,stage:stageInfo.domStage,zIndex:node.getOrder(),viewboxDom:canvasInfo.viewbox,loadImage:!canvasInfo.ctx||options.forceUpdate||options.useImages})}else{stage.removeDirtyNode(node)}if(j===flattenedNodes.length-1){render_complete()}},function(e){render_complete();_gliffy.RenderLoop.stop();_gliffy.handleError("com.gliffy.error.render_failed",[],e,options.target)})}}}}else{if(options.renderCallback){options.renderCallback()}}},__createWorkQueueFunction:function(j,node,canvasInfo,options,flattenedNodes,render_complete,nodeRenderer,container,stageInfo){return function(next){_gliffy.Utils.tryCatch(function(){var callback=function(){if(node&&node.stage){node.stage.removeDirtyNode(node)}if(options.useImages&&canvasInfo.canvas&&canvasInfo.ctx){canvasInfo.canvas.attr("src",canvasInfo.ctx.canvas.toDataURL())}next();if(j===flattenedNodes.length-1){render_complete()}};if(options.fixedDrawingSpace||canvasInfo.bounds.inViewport){nodeRenderer.render({object:node,target:canvasInfo.ctx,renderCallback:callback,renderers:options.renderers,singleCanvas:false,container:container,stage:stageInfo.domStage,zIndex:node.getOrder(),viewboxDom:canvasInfo.viewbox,loadImage:!canvasInfo.ctx||options.forceUpdate||options.useImages})}else{callback()}},function(e){_gliffy.workQueue.clearQueue();render_complete();_gliffy.RenderLoop.stop();_gliffy.handleError("com.gliffy.error.render_failed",[],e,options.target)})}},__createSimpleLoopCallback:function(canvasInfo,options,node){return function(){delete node.stage.dirty[node.getId()];if(options.useImages&&canvasInfo.canvas&&canvasInfo.ctx){canvasInfo.canvas.attr("src",canvasInfo.ctx.canvas.toDataURL())}}},__setupNodeCanvas:function(node,object,contexts,stage,stageInfo,container,options){var ctx,canvas,viewbox,guides,bounds={inViewport:true},scale,transform,dirtyWidth,dirtyHeight,canvasStyle,guideData,show,viewboxStyles,chromeFix,zoom,graphicsRequiringViewbox,$guideLine,horizontalVertical,guideId,linkGraphic,self=this;if((node.isGroup()||(!object&&node.isMultipartShape()))&&options.renderViewbox){viewbox=$("#"+node._domId+"viewbox");if(viewbox.length===0){viewbox=$("<div/>",{id:node._domId+"viewbox"}).addClass("gliffy-viewbox");if(node.isGroup()){viewbox.addClass("gliffy-group")}}viewbox.css($.extend({position:"absolute",zIndex:node.getOrder()+1,width:node.getWidth(),height:node.getHeight()},_gliffy.Utils.transformCss(new _gliffy.AffineTransform(1,0,0,1,0,0).scale(stage.zoom,stage.zoom).concatenate(node.worldTransform))));if(_gliffy.Editor===undefined){viewbox.css("display","none");viewbox.css("pointerEvents","none")}stageInfo.domStage.append(viewbox);if(node.isShape()&&node.getShapeInformation().quickConnectionOverlay==="arrows-mindmap"){viewbox.addClass("gliffy-qc-overlay-arrows-viewbox");node.getDomElement().addClass("gliffy-qc-overlay-arrows-canvas")}}else{if(!(object instanceof _gliffy.Text)&&!(_gliffy.PopupNote&&object instanceof _gliffy.PopupNote)&&!(object instanceof _gliffy.Link)){ctx=contexts[node._domId];canvas=$("#"+node._domId);viewbox=(options.renderViewbox)?$("#"+node._domId+"viewbox"):null;if(options.forceUpdate||!ctx){node.setFlag("bounds");node.setFlag("skin")}if(!ctx){if(options.renderViewbox){viewbox=$("<div/>",{id:node._domId+"viewbox"}).addClass("gliffy-viewbox");linkGraphic=node.findGraphic(_gliffy.Link);if(node&&linkGraphic.length>0){viewbox.attr("data-href",linkGraphic[0].getGraphic().getHref())}}if(options.useImages){canvas=$("<img/>",{id:node._domId}).addClass("gliffy-graphic");ctx=_gliffy.Utils.getContext(document.createElement("canvas"));canvas.data("ctx",ctx)}else{canvas=$("<canvas/>",{id:node._domId}).addClass("gliffy-graphic");ctx=_gliffy.Utils.getContext(canvas.get(0))}if(options.renderViewbox){stageInfo.domStage.append(viewbox)}stageInfo.domStage.append(canvas);contexts[node._domId]=ctx;container.data(contexts);if(node.getRootParent().isShape()&&node.getRootParent().getShapeInformation().quickConnectionOverlay==="arrows-mindmap"){viewbox.addClass("gliffy-qc-overlay-arrows-viewbox");node.getDomElement().addClass("gliffy-qc-overlay-arrows-canvas")}}$("#"+node._domId).data("node",node);scale=stage.zoom;dirtyWidth=object.style.graphic_width*scale;dirtyHeight=object.style.graphic_height*scale;zoom=stage?stage.getZoom():1;if(object instanceof _gliffy.Line){transform=new _gliffy.AffineTransform(1,0,0,1,0,0).scale(zoom,zoom).translate(object.style.pos_x,object.style.pos_y).translate(-object.style.offset_x,-object.style.offset_y).scale(1/scale,1/scale)}else{transform=new _gliffy.AffineTransform(1,0,0,1,0,0).scale(zoom,zoom).concatenate(object.node.worldTransform).translate(-object.style.offset_x,-object.style.offset_y).scale(1/scale,1/scale)}if(node.hasRedrawCanvasFlag()){if(!(object instanceof _gliffy.Image||(_gliffy.Proxy&&object instanceof _gliffy.Proxy))){ctx.canvas.width=Math.min(dirtyWidth,32767);ctx.canvas.height=Math.min(dirtyHeight,32767)}}bounds=_gliffy.Utils.maxBounds(transform,dirtyWidth,dirtyHeight,stage);node._current_bounds=bounds;object.style.matrix_a=scale;object.style.matrix_b=0;object.style.matrix_c=0;object.style.matrix_d=scale;object.style.matrix_e=0;object.style.matrix_f=0;if(node.hasRepositionCanvasFlag()){canvasStyle=$.extend(_gliffy.Utils.transformCss(transform),{"pointer-events":options.pointerEvents,visibility:node.getNodeOrLayerHidden()?"hidden":"visible",position:"absolute",zIndex:node.getOrder()});this.__getNodeDomElements(node,stageInfo.domStage).css("visibility",node.getHidden()?"hidden":"visible");canvas.css(canvasStyle).data("transform",transform).data("scale",scale);if($.browser.webkit){chromeFix=$("#gliffy-chrome-fix");if(chromeFix.length===0){chromeFix=$("<canvas />",{id:"gliffy-chrome-fix"}).css(canvasStyle).css("visibility","hidden").addClass("gliffy-graphic");$(".gliffy-stage").append(chromeFix);chromeFix.get(0).width=1000;chromeFix.get(0).height=1000;chromeFix.get(0).getContext("2d").fillRect(0,0,1000,1000)}}if(options.renderViewbox){viewboxStyles={position:"absolute",zIndex:node.getOrder()+1,width:node.getWidth(),height:node.getHeight(),pointerEvents:"none"};viewbox.css($.extend(viewboxStyles,_gliffy.Utils.transformCss(new _gliffy.AffineTransform(1,0,0,1,0,0).scale(stage.zoom,stage.zoom).concatenate(object.node.worldTransform))));graphicsRequiringViewbox=[_gliffy.Link];if(_gliffy.PopupNote){graphicsRequiringViewbox.push(_gliffy.PopupNote)}if(_gliffy.Editor===undefined&&node.findNodesWithGraphics(graphicsRequiringViewbox).length===0){viewbox.css("display","none")}}}}}if(options.renderViewbox&&(object instanceof _gliffy.Shape||node.isMultipartShape())&&node.hasBoundsConnections()){viewbox.addClass("gliffy-shape-bounds-viewbox")}if(node.hasGuideFlag()&&options.renderGuides&&node.supportsDrawingGuides()){guides={};guideData=node.getDrawingGuides();_.each(guideData,function(xOrYGuides,xOrY){guides[xOrY]={};horizontalVertical=xOrY==="x"?"gliffy-drawing-guide-vertical":"gliffy-drawing-guide-horizontal";_.each(xOrYGuides,function(guide,guideReference){guideId=node._domId+"guide"+guideReference;$guideLine=$("#"+guideId);if($guideLine.length===0){$guideLine=$("<div/>",{id:guideId,"class":["gliffy-drawing-guide",horizontalVertical].join(" ")});stageInfo.domStage.append($guideLine)}guides[xOrY][guideReference]=$guideLine})});_.each(guides,function(xOrYGuides,xOrY){_.mapValues(xOrYGuides,function(guide,guideReference){show=node.shouldShowGuide(xOrY,guideReference);transform=_gliffy.AffineTransform.getScaleInstance(stage.zoom,stage.zoom);switch(xOrY){case"x":transform=transform.translate(guideData[xOrY][guideReference],-stage.pan_y/stage.zoom);break;case"y":transform=transform.translate(-stage.pan_x/stage.zoom,guideData[xOrY][guideReference]);break}guide.css({top:transform.getTranslateY()+"px",left:transform.getTranslateX()+"px",display:show||_gliffy.Debug.DISPLAY_GUIDES?"block":"none",opacity:show?"0.3":"0.1"})})})}else{$("."+node._domId+"guide").remove()}if(node.isText()){setTimeout(function(){self.__getNodeDomElements(node,stageInfo.domStage).css("visibility",node.getHidden()?"hidden":"visible")},0)}return{canvas:canvas,viewbox:viewbox,ctx:ctx,bounds:bounds}},__setupStageAndPan:function(options){var stageWidth,stageHeight,domStage,stageBackground,panTransform,stage=options.object,container=options.target,self=this;if(options.fixedDrawingSpace){stageWidth=stage.maxWidth*stage.zoom;stageHeight=stage.maxHeight*stage.zoom}else{stageWidth=stage.width*stage.zoom;stageHeight=stage.height*stage.zoom}domStage=container.find(".gliffy-stage");if(domStage.length===0){domStage=$('<div class="gliffy-stage"/>');container.append(domStage)}stageBackground=stage.background;domStage.css({backgroundColor:stageBackground,width:stageWidth,height:stageHeight});if(options.scrollForPan){if(stage._pan_dirty){container.scrollTop(-stage.pan_y).scrollLeft(-stage.pan_x);stage._pan_dirty=false}}else{panTransform=new _gliffy.AffineTransform(1,0,0,1,stage.pan_x,stage.pan_y);domStage.css(_gliffy.Utils.transformCss(panTransform,{roundTranslate:true}))}return{domStage:domStage,stageWidth:stageWidth,stageHeight:stageHeight}},__afterRenderComplete:function(container,stage,stageInfo,contexts,options){return function(){var autoFitWidth,autoFitHeight,zoom;zoom=stage?stage.getZoom():1;if(options.fixedDrawingSpace){stageInfo.domStage.css({width:stageInfo.stageWidth,height:stageInfo.stageHeight})}else{if(options.resizeTarget){autoFitWidth=(options.autoFitPadding)?stage.width+AUTOFIT_PADDING:stage.width;autoFitHeight=(options.autoFitPadding)?stage.height+AUTOFIT_PADDING:stage.height;autoFitWidth=Math.min(autoFitWidth,stage.maxWidth);autoFitHeight=Math.min(autoFitHeight,stage.maxHeight);container.css({width:autoFitWidth*zoom,height:autoFitHeight*zoom});stageInfo.domStage.css({width:autoFitWidth*zoom,height:autoFitHeight*zoom})}}if(options.renderCallback){options.renderCallback()}}},__flattenNodes:function(stage,forceUpdate){var nodes=[],i,dirtyNodes,node;if(forceUpdate){dirtyNodes=stage.objects}else{dirtyNodes=Object.keys(stage.dirty)}for(i=0;i<dirtyNodes.length;i++){node=dirtyNodes[i];if(!forceUpdate){node=stage.find(dirtyNodes[i]);if(!node){delete stage.dirty[dirtyNodes[i]]}}this.__preorder(node,nodes,forceUpdate)}stage.updateBounds();return nodes},__preorder:function(node,array,forceUpdate){var i;if(!node){return}if(node.shouldBeDrawn()||forceUpdate){if(forceUpdate){node.setFlag("bounds");if(node.getGraphic()){node.getGraphic().markDirty()}node.markDirty()}if(node.isDirty()){node.update()}if(node.getGraphic()||(node.supportsConnections()&&node.isMultipartShape())||(node.getGraphic()===null&&node.isMultipartShape()&&node.hasGuideFlag())){array.push(node)}else{node.stage.removeDirtyNode(node)}}else{node.stage.removeDirtyNode(node)}for(i=0;node.children&&i<node.children.length;i++){this.__preorder(node.children[i],array,forceUpdate)}},__preorderNotify:function(node){var c;if(!node){return}if(node.shouldBeDrawn()){if(node.isDirty()){node.update()}node.notify()}for(c=0;node.children&&c<node.children.length;c++){this.__preorderNotify(node.children[c])}},__notifyNodes:function(stage){var i,dirtyNodes,node;dirtyNodes=Object.keys(stage.dirty);for(i=0;i<dirtyNodes.length;i++){node=dirtyNodes[i];node=stage.find(dirtyNodes[i]);this.__preorderNotify(node)}},__deleteNodes:function(nodes,domStage,contexts){var removeNodeSel="",i,j;if(nodes.length>0){for(i=0;i<nodes.length;i++){removeNodeSel+=nodes[i]+","+nodes[i]+"viewbox,";for(j=0;j<6;j++){removeNodeSel+=nodes[i]+"guide"+j+(j<5?",":"")}removeNodeSel+=(i<nodes.length-1)?",":"";delete contexts[nodes[i].substr(1)]}domStage.find(removeNodeSel).remove()}},__getNodeDomElements:function(node,domStage){var nodeSelector,j;nodeSelector="#gliffy_node_"+node.getId()+",#gliffy_node_"+node.getId()+"viewbox,";for(j=0;j<6;j++){nodeSelector+="#gliffy_node_"+node.getId()+"guide"+j+(j<5?",":"")}return domStage.find(nodeSelector)}})}());(function(){var PROXY_IMAGE_URL="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIIAAABsCAYAAACmTWoPAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAABx0RVh0U29mdHdhcmUAQWRvYmUgRmlyZXdvcmtzIENTNui8sowAAAAUdEVYdENyZWF0aW9uIFRpbWUAMy8xLzEzaGTUYwAACmpJREFUeJztnU1W2zoYhp/23DnsgBQt4HJXQLoC0mFGDTPPoCto7gpKZ55hRhk2rICwgqYLUGtWcMMKegeSEuPmx/qx5QQ/5+QAcSSL+LVe6dOP33DASCl7wJl+AfQLh883JPsBLPTvs8LPhRBiHrSALeD3798AvIlcjqBIKfvAgNXFPwp8imdgjhLGTAgxC5x/4xyEEKSUx8AIdfE33eF1cw9MgakQYrHrw21jb4WgL/5Avy4iF6fMPZAJIaaxC1KVvROC9vsRcE34Kj80z8ANShR55LJsZW+EoAUwBj7GLYkzd8C4rYJovRAOQABlWimIVgtBSjlmPyzAlmfgRggxjl0QQyuFoLt/GXAStyS18wSM2tD9bJUQdE9gDFxFLkrTfEXZRbRuZ2uEoEUwA/6OXJRYPAGDWFFLI4S3MU5eYsrrFQEoG/wupRzFLERUIeg2QayIYNu4lVJmsU7+V6wTa0YNnCNHjQ+Y1wJ42tSNk1KaMYqefplxi17dBQU+6m7zoOl2Q9Q2gpRyRvgaIUe1OabAY6gvVF+gc9QIZp96hfED6DchhlY0FgMKYYG68HdNdcmklBesxjyOazhFI2JoixAy/CKHOarbeR+rC6Z7PRe6HL3A2dcuhrYIYQTcOiTNUf3vu6AF8kRK+ZHwgqhVDK0QAoCU8jurGUS7WADXbRNAGSnlFUoQoSzjUQjRD5TXC9oUR/jAamrYNqbAu7aLAEAI8RV4hypzCM7r7lpGrxFg6bPfeDmn0JADn/ZpskcRKeUAZX8haodPQoibAPksaY01FNF9+HNWX9pcCHEfsUhB0F3Pb1S3wG28D9kzaqUQDhld633BP4j2DPRCNR7b1EZ4FQghFkKIS1Qj0ocj1FB9ULoaIQIe3eYiH0K0mzpriEwAMTwBZ74W0VlDZIQQGfDJI4sT/G1mSVcjREZKeYtfA/Kdz4TYYDWClPJYzyvocEA3IH1mJwWJK4Swhgx40IGTDjeqRlfXcRHiRvQSgr74ZtlZpvvKHZboqv3SI4uxbxmchaAvelZ4q5b+7WtBdwVdx1HOdVTWGZ8aIePPBSgXnUV4cY27RVz7nNip16Av9rcNh4OGQF8bnvEF6x6Ec69hjSWU6SzCAx1fcO1FONfGLtaQsXtNYmcRfrgGmpztwcoadlhCmc4iPJBSPrB+fsYu/rFZNWVtDRUsoUxnEX649iBGLolsrCHDfpl6ZxGO6LZC7pDU6fuuJIRS4MiWLtDkjkutcOISU9gpBAdLKNNZhDuZY7q+bYIqNUKG/84lnUU4oGMCLl3Jvm2CrULwtIQynUW44TJ5t2+bYKMQAlhCmc4i3HCZjnakZ05XZluNkBF+M6vOIizRMQGXWIxVg3GtEAJbQpnOIuz54ZDGTwg1WEKZziLsmTmk6dl8eF2NkFH//oaVLSJJhjdJMgy6zGvbOZo4nwMuPYeezYdfbJ1TsyWUyaSUVcYiQiwT20XxHG18JoNLG6Fn8+GlEBqwhDLGIrwaj0ky7LPqLmVpOsk3HJun6WRaODZCfVkL1FrLP75s/RlDD8jTdJJtyANgUTweEBdxWm1aWrSGjOa3vPXqRSTJcAw8oAZaRsCvJBkO1hwbAN/0e+aYmUY+5uX2fiYv8/staqbwALgt5HGjjw10HiHWNa6liRHct9C4JZRx6kUkyfAY+Azcp+mkh6ren1hN7z4G7tJ00kvTyRl655E16fo7TvUM9HUeT4U8rnQeZxXyiILN9/o2giWUce1FGF/PANJ0suDlPs6m8TdLkuGC1V1/VjyeppM58LjlPHP9GViNBtrmEQKX/Cu3r94SxxLK+FhEsdos3gEzVLU9R83cKffFQ8Qyjjf8vnf8JYSodAH0IooHy/xr2/uHVQPqGpjp6nrA6oKfAF/TdHKdJMMzVKNuXkg3Aqb62Dl2d9wyjyQZznRef1vmYTvjy4UHKeXWD/z8+RNgWvfOq6HukvMkGf4uvfcetbv5VZIM5/pcJ6wabI/6mLnQz6iqclBK17MtTJpOFkkyvEQ1Fv8rH9cNys9pOnmz7W8hxBsp5RTPnpMnC+CyshCEELNd6lpDiM22r1kvqHmaTmb6jly2FwrdxwFKFMcoL8/1e3maTrKCCHJeds+uN/xe/jtHiRFWG34am8p4GQ3c9vclqrEZy1ouT09PF7aTV8t35U6EEAe54jpJhjkrkfVRtc6lSxyhAYvYxPT09PQDNLA/wgEPMA1QtUBf/+0kAlgud3MZbvZhQWG9pW2N8At7Tw26C9ihom+YXzRnER+EEFPXlU5PDifsOaR5dejooc+KaBum5f2XbIWQO5y0iUGjg6Ahi1gruE4I7eMS9xXRlfJfN3ZhKwSXUbDuUT0W1GwRf1iCoQkhmKhkR0VqsoitArMSgp5n71JtxYyc7SuhLWKtJRhc4gguo2CdECwJbBEbLcHgIoSZQ5oT23n2HUuL+OqZTSVBNSUE8Nzj5xUzxq23ZthqCQZrIegFF7lDgUYOaV49nhaRVd2423WswWU93lHsx97uKzpEb2sRORZb8LgKIXNMN3ZM12FvEZUsweAkBA97OOlqBTcsLeKr7UCfzzC0a2t27HHOV01Fi8hx+I59hOAa+TqRUnY9CHfGbK+NrSzB4CwEHWV03flrfMATVmplh0VYW4LBd4bS2DFdtyLagw0WkeNhu15C0LXCzDF5t2mGH2NeWoSTJRhCzFn81yNt1oWe3ShZhLMlGLyFoAvg2lY4ovlJmweD/u5DPEsyzMO99F39yyOLOyHEKERZOuwI+rg/3VbwGSX7KKUchyhLhxsh1zWM8Rsl+9xFHeMRTAiBJlLcdmKIQ9CVTp4NR8OtlDLzL02HDcHXJeqI4Xf8F7bcAdfdgz/qpdaHhOtt4r8HyOoHMPB55G1b0MEzs8ZjAcxsnrRSF7U/LT7A09ANz6iaIQuQV+NoAdywfpezR2AUU+i1CwGCPAC7yD1KEHmg/GpFx1Zu2L1J2TPQj1U7BI0jbEI/ADtU5PACmO9DvEGXcU61nepaMQBX+yYWuvH4QNg1kE/AuG12oe1wjOVml5rLGP9PI9ZgqEkMoASRATexehf6fxuhpuu7CMBwX3Vjs5A0KgSoVQyGOyqs6AmFbgSaV4jtCevcgW4jjQsBGhEDqMbXFDVPYhaqcakbf339CnXxi7weIcBSDGYP4yZ4Qo2BzPTPXL8/X2cnhZXbPf3q658+1X4VoozARhOCQUr5hW4ZXJEoe0010n3chhDiE/XvDrIvzGJvOBZNCLB87O172vmwjKaYAx9iF6I1m2G+Uqu4Af6NObAWvY2wDt1Q+8Lhb8A1Bz7FtgNoqRAMUsorVITu0BbBLFDBL5+Z30FptRBg2c2s7fE4EchQtUCrGsetF4JBB3I+s7+CyFDtgDxyOdayN0Iw6Briis3b9reJBaoheNdWARj2TghFpJQXrJ7H0CbM/oj3bbOATey1EAy6ljCi6BOnpjDjGnf7cvGLHIQQyui5kuesBofqEMYM1f2bCSFc9pJqFQcphDK6oXmCikscs3rIxjGbYxU5q4Gpmf45B3603e9dMEL4H5gPYf/2gra6AAAAAElFTkSuQmCC",PROXY_IMAGE;PROXY_IMAGE=new Image();PROXY_IMAGE.src=PROXY_IMAGE_URL;_gliffy.Renderer.ProxyRenderer=_gliffy.Renderer.extend({id:"Gliffy.Renderer.ProxyRenderer",target:null,init:function(){_gliffy.renderers[this.id]=this},render:function(o){if(!o){throw new Error("shape renderer needs options")}if(!o.target){throw new Error("needs a target canvas context")}if(!o.object){throw new Error("no shape to render")}var context=o.target,object=o.object,renderCallback=o.renderCallback,scale,transform,offsetX,offsetY;scale=object.node.stage.zoom;offsetX=(object.style.single_canvas)?0:object.style.offset_x;offsetY=(object.style.single_canvas)?0:object.style.offset_y;if(object.node.hasFlag("skin")){if(object.node){object.node.setWidth(PROXY_IMAGE.width);object.node.setHeight(PROXY_IMAGE.height);object.node.update();object.node.resetFlags()}context.save();if(object.style.single_canvas){transform=object.node.worldTransform.getValues();if(!o.ignorePan){context.translate(object.node.stage.pan_x,object.node.stage.pan_y)}if(!o.ignoreZoom){context.scale(scale,scale)}context.transform(transform[0],transform[1],transform[2],transform[3],transform[4],transform[5])}else{context.canvas.width=object.style.graphic_width*scale;context.canvas.height=object.style.graphic_height*scale;context.scale(scale,scale);$(context.canvas).css({width:"",height:""})}context.drawImage(PROXY_IMAGE,offsetX,offsetY,object.style.width,object.style.height);context.restore();if(renderCallback){renderCallback()}}else{$(context.canvas).css({width:object.style.graphic_width*scale,height:object.style.graphic_height*scale});if(object.node){object.node.resetFlags()}if(renderCallback){renderCallback()}}}})}());(function(){_gliffy.Renderer.ControlRenderer=_gliffy.Renderer.extend({id:"Gliffy.Renderer.ControlRenderer",target:null,init:function(){_gliffy.renderers[this.id]=this},render:function(o){if(!o){throw new Error("control renderer needs options")}if(!o.target){throw new Error("needs a target node to render controls for")}var viewboxDom=o.viewboxDom,node=o.target,renderCallback=o.renderCallback,connectionPoints,i,id,connectionId,connectionPoint,connection,highlight;viewboxDom.css("z-index",node.getOrder()+1);if(node.supportsConnections()){id=node._domId;connectionPoints=viewboxDom.data("connectionPoints")||{};for(i=0;i<node.getConnections().length;i++){connectionId=this.cpId(i,id);connectionPoint=connectionPoints[connectionId];if(!connectionPoint){connectionPoint=$("<div/>",{id:connectionId}).addClass("gliffy-connection-point gliffy-icon-overlay-plus");viewboxDom.append(connectionPoint)}connectionPoints[connectionId]=connectionPoint;connection=node.getConnections()[i];connectionPoint.data({i:i,id:node.getId()});connectionPoint.css({top:connection.pos.y*node.getHeight()-7+"px",left:connection.pos.x*node.getWidth()-7+"px"})}viewboxDom.data({connectionPoints:connectionPoints});if(viewboxDom.find(".gliffy-highlighter").length===0){highlight=$("<div/>",{id:"highlight-"+id}).addClass("gliffy-highlighter");viewboxDom.append(highlight)}}if(renderCallback){renderCallback()}},cpId:function(idx,nodeId){return"cp"+idx+"-"+nodeId}})})();(function(){_gliffy.Renderer.LinkRenderer=_gliffy.Renderer.IconRenderer.extend({id:"Gliffy.Renderer.LinkRenderer",init:function(){_gliffy.renderers[this.id]=this},render:function(o){o.iconClass="gliffy-viewerIcon-link";o.graphicType=_gliffy.Link;o.oppositeGraphicType=_gliffy.PopupNote?_gliffy.PopupNote:null;o.renderLeftIfOppositeGraphicTypeExists=true;o.renderPopupPoints=false;this._super(o)}})})();(function(){_gliffy.Renderer.StageSvg=_gliffy.Renderer.extend({id:"Gliffy.Renderer.StageSvg",target:null,_mockStageInfo:null,init:function(){_gliffy.renderers[this.id]=this},render:function(o){if(!o){throw"stage renderer needs options"}if(!(o.object&&o.object instanceof _gliffy.Stage)){throw"needs a stage object to render!"}var options=$.extend({},{renderCallback:null,textRenderer:_gliffy.Renderer.TextHtml2Canvas,shapeRenderer:_gliffy.Renderer.ShapeCanvas,svgRenderer:_gliffy.Renderer.SvgCanvas,lineRenderer:_gliffy.Renderer.LineCanvas,imageRenderer:_gliffy.Renderer.ImageCanvas,forceUpdate:false,whitespace_x_padding:20,whitespace_y_padding:20,show_progress_bar:false,ignorePan:true,ignoreZoom:true,hideHiddenNodes:true,boundingBoxFit:false},o),i=0,stage=options.object,container=options.target||document.createElement("div"),ctx,forceUpdate=options.forceUpdate,nodeRenderer,width,height,objects,renderers={text:options.textRenderer,shape:options.shapeRenderer,line:options.lineRenderer,image:options.imageRenderer,svg:options.svgRenderer},bb,scale,offsetX=0,offsetY=0,bounds,self=this,delayEvery;this._mockStageInfo=this._setupMockStage(options);_gliffy.Utils.setupAnimationDelay();html2canvasClearCache();if(!_gliffy.renderers[options.textRenderer.prototype.id]){_gliffy.renderers[options.textRenderer.prototype.id]=new options.textRenderer()}if(!_gliffy.renderers[options.shapeRenderer.prototype.id]){_gliffy.renderers[options.shapeRenderer.prototype.id]=new options.shapeRenderer()}if(!_gliffy.renderers[options.svgRenderer.prototype.id]){_gliffy.renderers[options.svgRenderer.prototype.id]=new options.svgRenderer()}if(!_gliffy.renderers[options.lineRenderer.prototype.id]){_gliffy.renderers[options.lineRenderer.prototype.id]=new options.lineRenderer()}if(!_gliffy.renderers[options.imageRenderer.prototype.id]){_gliffy.renderers[options.imageRenderer.prototype.id]=new options.imageRenderer()}if(!_gliffy.renderers[_gliffy.Renderer.NodeCanvas.prototype.id]){_gliffy.renderers[_gliffy.Renderer.NodeCanvas.prototype.id]=new _gliffy.Renderer.NodeCanvas()}nodeRenderer=_gliffy.renderers[_gliffy.Renderer.NodeCanvas.prototype.id];if(options.show_progress_bar){GliffyApp.progressBarController.show("Exporting to SVG")}window.pauseSilverlightDetection=true;stage.update();bb=stage.calculateBoundingBox();scale=stage.zoom;if(options.ignoreZoom){scale=1}bounds=new _gliffy.BoundingBox();bounds.min.x=Math.max(0,bb.min.x-options.whitespace_x_padding)*scale;bounds.min.y=Math.max(0,bb.min.y-options.whitespace_y_padding)*scale;bounds.max.x=Math.min(bb.max.x+options.whitespace_x_padding,stage.maxWidth)*scale;bounds.max.y=Math.min(bb.max.y+options.whitespace_y_padding,stage.maxHeight)*scale;if(options.boundingBoxFit){width=bounds.getDimension().x;height=bounds.getDimension().y;offsetX=-bounds.min.x;offsetY=-bounds.min.y}else{width=bounds.max.x;height=bounds.max.y}ctx=new C2S({width:width,height:height});ctx.canvas.width=width;ctx.canvas.height=height;ctx.save();ctx.fillStyle=stage.background;ctx.fillRect(0,0,width,height);ctx.restore();ctx.translate(offsetX,offsetY);stage.update();if(options.hideHiddenNodes){objects=stage.visibleFlattenedNodes(forceUpdate)}else{objects=stage.flattenNodes(forceUpdate)}objects=this.__moveTextWithLinksToEnd(objects);if(renderers.text===_gliffy.Renderer.TextHtml2Canvas){for(i=0;i<objects.length;i++){if(objects[i].isText()){_gliffy.workQueue.queue(this.__createWorkQueueFunction(nodeRenderer,objects,i,ctx,renderers,container,$.extend({},{preRender:true},options)))}}}delayEvery=Math.max(Math.floor(objects.length/10),10);for(i=0;i<objects.length;i++){if(i%delayEvery===0){_gliffy.workQueue.animationDelay()}_gliffy.workQueue.queue(this.__createWorkQueueFunction(nodeRenderer,objects,i,ctx,renderers,container,options))}_gliffy.workQueue.animationDelay().queue(function(next){if(options.show_progress_bar){GliffyApp.progressBarController.getBar().animate({width:"100%"})}window.pauseSilverlightDetection=false;if(options.renderCallback){if(options.target){_gliffy.FontLoader.getEmbeddableFonts(function(style){$(ctx.getSvg()).prepend($("<style>"+style+"</style>"));$(container).append(ctx.getSvg());options.renderCallback(ctx)})}}next()})},_setupMockStage:function(options){var stageWidth,stageHeight,domStage,stage=options.object,container=options.target,self=this;if(options.fixedDrawingSpace){stageWidth=stage.maxWidth*stage.zoom;stageHeight=stage.maxHeight*stage.zoom}else{stageWidth=stage.width*stage.zoom;stageHeight=stage.height*stage.zoom}domStage=container.find(".gliffy-mock-stage");if(domStage.length===0){domStage=$('<div class="gliffy-stage gliffy-mock-stage"/>');domStage.css({position:"absolute",width:stageWidth+"px",height:stageHeight+"px",top:"0px",left:"0px",zIndex:-10000});container.append(domStage)}return{domStage:domStage,stageWidth:stageWidth,stageHeight:stageHeight}},__createWorkQueueFunction:function(nodeRenderer,objects,i,ctx,renderers,container,options){var self=this;return function(next){_gliffy.Utils.tryCatch(function(){nodeRenderer.render({object:objects[i],stage:self._mockStageInfo.domStage,target:ctx,renderCallback:function(){if(options.show_progress_bar){GliffyApp.progressBarController.getBar().queue(function(n){$(this).width(Math.floor(((i+1)/objects.length)*100)+"%");n()})}next()},renderers:renderers,container:container,singleCanvas:true,ignorePan:options.ignorePan,ignoreZoom:options.ignoreZoom,preRender:options.preRender})},function(e){_gliffy.Logger.warn("Problems exporting to svg, skipping to next node. "+e);next()})}},__moveTextWithLinksToEnd:function(objects){var textObjects=[];for(var i=0;i<objects.length;i++){if(objects[i].getGraphic() instanceof _gliffy.Text&&objects[i].getGraphic().hasLink()){textObjects.push(objects.splice(i,1)[0])}}return objects.concat(textObjects)}})}());(function(){_gliffy.FileHandler=_gliffy.Class.extend({MAX_FILE_SIZE_BYTES:512000,init:function(){throw new Error("init for filehandler is not implemented")},handle:function(file){throw new Error("not implemented")},handleCustomLibraryUpload:function(){throw new Error("not implemented")},canHandleFile:function(){throw new Error("not implemented")}})}());(function(){_gliffy.FileHandlerRegister=_gliffy.Class.extend({fileHandlers:null,drawManager:null,init:function(drawManager){this.fileHandlers=[];this.drawManager=drawManager;this.DEFAULT_FILE_HANDLER=new _gliffy.DefaultFileHandler(drawManager);this.IMAGE_FILE_HANDLER=new _gliffy.ImageFileHandler(drawManager);this.SVG_FILE_HANDLER=new _gliffy.SvgFileHandler(drawManager);this.register(this.drawManager)},register:function(drawManager){this.add(this.SVG_FILE_HANDLER);this.add(this.IMAGE_FILE_HANDLER);this.add(this.DEFAULT_FILE_HANDLER)},add:function(fileHandler){this.fileHandlers.push(fileHandler)},getFileHandlers:function(){return this.fileHandlers}})}());(function(){_gliffy.DefaultFileHandler=_gliffy.FileHandler.extend({init:function(){},handle:function(file){},handleCustomLibraryUpload:function(file){},canHandleFile:function(file){return true}})}());(function(){_gliffy.ImageFileHandler=_gliffy.FileHandler.extend({init:function(drawManager){this.drawManager=drawManager},handle:function(file,index){var reader=new window.FileReader(),position=_gliffy.Mouse.getPosition(),self=this,OFFSET=100;if(position.x<0){position.x=100}if(position.y<0){position.y=100}if(index&&index>0){position.x+=index%5*OFFSET;position.y+=Math.floor(index/5)*OFFSET}reader.onload=function(event){if(file.size>self.MAX_FILE_SIZE_BYTES){self.__resizeImage(event.target.result).then(function(imageData){self.__addImage(file.name,imageData,position)})}else{self.__addImage(file.name,event.target.result,position)}};reader.readAsDataURL(file)},handleCustomLibraryUpload:function(file,index,model){var reader=new window.FileReader(),self=this;reader.onload=function(event){self.__generateThumbnail(event.target.result,50).then(function(thumbnail){if(file.size>self.MAX_FILE_SIZE_BYTES){self.__resizeImage(event.target.result).then(function(imageData){model.addFile({name:file.name,uid:"com.gliffy.shape.basic.basic_v1.default.image",data:imageData,thumbnail:thumbnail})})}else{model.addFile({name:file.name,uid:"com.gliffy.shape.basic.basic_v1.default.image",data:event.target.result,thumbnail:thumbnail})}},function(){model.addFile({name:file.name,uid:"com.gliffy.shape.basic.basic_v1.default.image",data:event.target.result,thumbnail:event.target.result});_gliffy.Logger.warn("Failed to generate a thumbnail")})};reader.readAsDataURL(file)},__addImage:function(name,imageData,position){var node,params;node=new _gliffy.Node();params={name:name,thumbnail:imageData,doNotProxyImage:true,image:imageData,uid:"com.gliffy.shape.basic.basic_v1.default.image",tid:"com.gliffy.stencil.image",useOriginalDimensions:true};_gliffy.Utils.analyticsEvent("trackEvent",{category:"fileDragAndDrop",action:"image"});this.drawManager.setupShape(node,params,position)},__generateThumbnail:function(imageData,thumbnailSize){var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),img=new Image(),deferred=new $.Deferred(),thumbnail,dim,self=this;img.onload=function(){dim=self.__resize(img.width,img.height,thumbnailSize,thumbnailSize);canvas.width=thumbnailSize;canvas.height=thumbnailSize;ctx.drawImage(img,dim.x,dim.y,dim.w,dim.h);thumbnail=canvas.toDataURL("image/png");deferred.resolve(thumbnail)};img.onerror=function(){deferred.reject()};img.src=imageData;return deferred.promise()},__resizeImage:function(imageData){var canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),img=new Image(),deferred=new $.Deferred(),thumbnail,dim,self=this;img.onload=function(){var ratio=1;do{dim=self.__resize(img.width,img.height,img.width/ratio,img.height/ratio);canvas.width=img.width/ratio;canvas.height=img.height/ratio;ctx.drawImage(img,dim.x,dim.y,dim.w,dim.h);thumbnail=canvas.toDataURL("image/png");ratio=ratio*2}while(thumbnail.length>self.MAX_FILE_SIZE_BYTES);deferred.resolve(thumbnail)};img.onerror=function(){deferred.reject()};img.src=imageData;return deferred.promise()},__resize:function(imagewidth,imageheight,thumbwidth,thumbheight){var w=0,h=0,x=0,y=0,widthratio=imagewidth/thumbwidth,heightratio=imageheight/thumbheight,maxratio=Math.max(widthratio,heightratio);if(maxratio>1){w=imagewidth/maxratio;h=imageheight/maxratio}else{w=imagewidth;h=imageheight}x=(thumbwidth-w)/2;y=(thumbheight-h)/2;return{w:w,h:h,x:x,y:y}},canHandleFile:function(file){return file.type==="image/jpeg"||file.type==="image/png"||file.type==="image/gif"}})}());(function(){_gliffy.SvgFileHandler=_gliffy.FileHandler.extend({init:function(drawManager){this.drawManager=drawManager},handle:function(file,index){if(file.size<this.MAX_FILE_SIZE_BYTES){var reader=new FileReader(),position=_gliffy.Mouse.getPosition(),node,params,self=this,OFFSET=100;if(position.x<0){position.x=100}if(position.y<0){position.y=100}if(index&&index>0){position.x+=index%5*OFFSET;position.y+=Math.floor(index/5)*OFFSET}reader.onload=function(event){node=new _gliffy.Node();if(file.type.indexOf("svg")!==-1){params={name:file.name,svg:event.target.result,uid:"com.gliffy.shape.basic.basic_v1.default.svg",tid:"com.gliffy.stencil.custom.svg.static"};_gliffy.Utils.analyticsEvent("trackEvent",{category:"fileDragAndDrop",action:"svg"});self.drawManager.setupShape(node,params,position)}};reader.readAsText(file)}else{_gliffy.Utils.notify("info",$.i18n._("SVG_FILE_HANDLER_FILE_TOO_LARGE_TITLE"),$.i18n._("SVG_FILE_HANDLER_FILE_TOO_LARGE_MESSAGE"))}},handleCustomLibraryUpload:function(file,index,model){if(file.size<this.MAX_FILE_SIZE_BYTES){var reader=new FileReader();reader.onload=function(event){if(file.type.indexOf("svg")!==-1){model.addFile({name:file.name,data:event.target.result,uid:"com.gliffy.shape.basic.basic_v1.default.svg"})}};reader.readAsText(file)}else{_gliffy.Utils.notify("info",$.i18n._("SVG_FILE_HANDLER_FILE_TOO_LARGE_TITLE"),$.i18n._("SVG_FILE_HANDLER_FILE_TOO_LARGE_MESSAGE"))}},canHandleFile:function(file){return file.type==="image/svg+xml"}})}());(function(){_gliffy.CustomLibraryDrop=_gliffy.Class.extend({init:function(){throw new Error("init for shapeDrop is not implemented")},setupShape:function(node,addCommand){throw new Error("not implemented")},afterDrop:function(node,palletteShape){throw new Error("not implemented")},getUid:function(){throw new Error("not implemented")},getUids:function(){return[this.getUid()]}})}());(function(){_gliffy.DefaultLibraryDrop=_gliffy.CustomLibraryDrop.extend({init:function(editor){this.editor=editor},setupShape:function(node,addCommand){},afterDrop:function(node){if(node.isLine()){this.editor.overlayManager.lineOverlay.isNewlyCreatedLine=false;GliffyApp.contextualPropertiesController.showControls(this.editor.overlayManager.lineOverlay);this.editor.overlayManager.lineOverlay.showConnectionPoints(true,true);if(this.editor.overlayManager.lineOverlay.getSelectedNode().isEditTextOnInit()){this.editor.overlayManager.lineOverlay.makeTextEditable()}}else{if(node.isEditTextOnInit()){this.editor.overlayManager.overlay.makeTextEditable()}else{GliffyApp.contextualPropertiesController.showControls(this.editor.overlayManager.overlay);this.editor.overlayManager.overlay.configControlsDisplay();this.editor.overlayManager.overlay.hideAllDrawingGuides()}}},getUid:function(){return""}})}());(function(){_gliffy.AnnotationLibraryDrop=_gliffy.DefaultLibraryDrop.extend({init:function(editor){this.editor=editor},setupShape:function(node,addCommand){if(addCommand){this.editor.getDocumentManager().getActiveStage().commandHistory.pushCommandBundle()}},afterDrop:function(node){this.createBPMNAnnotationLine(node);this.editor.getDocumentManager().getActiveStage().commandHistory.popCommandBundle();this._super(node)},getUid:function(){return"com.gliffy.shape.bpmn.bpmn_v1.data_artifacts.annotation"},createBPMNAnnotationLine:function(node){var annoLineNode,ratio,graphic;ratio=node.getConnectionPointRatio(0);graphic=new _gliffy.Line();graphic.setDashStyle("4.0,4.0");graphic.setStrokeWidth(1);graphic.setControlPath([[0,50],[100,0]]);annoLineNode=new _gliffy.Node();annoLineNode.setUid("com.gliffy.shape.basic.basic_v1.default.line");annoLineNode.setGraphic(graphic);annoLineNode.setX(node.getX()-100);annoLineNode.setY(node.getY()+15);annoLineNode.getGraphic().setEndConnection(node,ratio);this.editor.getDocumentManager().addAndExecuteCommand(new _gliffy.AddNodeCommand({node:annoLineNode}))}})}());(function(){_gliffy.RecursiveMessageLibraryDrop=_gliffy.DefaultLibraryDrop.extend({__tempGroupUid:null,init:function(editor){this.editor=editor},setupShape:function(node,addCommand){this.__tempGroupUid=node.getUid();node.setUid(this.getUid());if(addCommand){this.editor.getDocumentManager().getActiveStage().commandHistory.pushCommandBundle()}},afterDrop:function(node){var lineNode,stage=this.editor.getDocumentManager().getActiveStage(),nodeIds;node.setUid(this.__tempGroupUid);nodeIds=stage.detachSelectionFromGroup(node);this.editor.overlayManager.deselectAll();stage.removeNode(node,true,false);lineNode=stage.find(nodeIds[1]);lineNode.setEditTextOnInit(false);this.editor.overlayManager.selectNodes([lineNode]);this._super(lineNode);_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeAdded",action:this.getUid()});this.editor.overlayManager.overlay.hideAllDrawingGuides()},getUid:function(){return"com.gliffy.shape.uml.uml_v2.sequence.recursive_message"}})}());(function(){_gliffy.UngroupAndSelectFirstShapeDrop=_gliffy.DefaultLibraryDrop.extend({init:function(editor){this.editor=editor},setupShape:function(node,addCommand){if(addCommand){this.editor.getDocumentManager().getActiveStage().commandHistory.pushCommandBundle()}},afterDrop:function(node){var shapes=node.findGraphic(_gliffy.Shape),self=this;self.editor.overlayManager.ungroupifyGroup();if(shapes.length>0){self.editor.overlayManager.selectNode(shapes[0])}self.editor.getDocumentManager().getActiveStage().commandHistory.popCommandBundle();self.editor.overlayManager.overlay.hideAllDrawingGuides()},getUid:function(){return null}})}());(function(){_gliffy.SelfMessageLibraryDrop=_gliffy.DefaultLibraryDrop.extend({init:function(editor){this.editor=editor},setupShape:function(node,addCommand){var graphic=node.getGraphic();graphic.setOrtho(true);graphic.editable.setOrthoMode(_gliffy.Editor.ORTHO_MODE.curved);graphic.setControlPath([[-23,21],[12.5,21],[12.5,58],[-62,58]]);graphic.editable.setLockSegment("1",true);node.markDirty();if(addCommand){this.editor.getDocumentManager().getActiveStage().commandHistory.pushCommandBundle()}},getUid:function(){return"com.gliffy.shape.uml.uml_v2.sequence.self_message"}})}());(function(){_gliffy.UmlV2LostMessageLibraryDrop=_gliffy.DefaultLibraryDrop.extend({__tempGroupUid:null,init:function(editor){this.editor=editor},setupShape:function(node,addCommand){this.__tempGroupUid=node.getUid();node.setUid(this.getUid());if(addCommand){this.editor.getDocumentManager().getActiveStage().commandHistory.pushCommandBundle()}},afterDrop:function(node){var lineNode,stage=this.editor.getDocumentManager().getActiveStage(),nodeIds;node.setUid(this.__tempGroupUid);nodeIds=stage.detachSelectionFromGroup(node);this.editor.overlayManager.deselectAll();stage.removeNode(node,true,false);lineNode=stage.find(nodeIds[1]);lineNode.setEditTextOnInit(false);this.editor.overlayManager.selectNodes([lineNode]);this._super(lineNode);_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeAdded",action:this.getUid()});this.editor.overlayManager.overlay.hideAllDrawingGuides()},getUid:function(){return"com.gliffy.shape.uml.uml_v2.sequence.lost_message"}})}());(function(){_gliffy.UmlV2FoundMessageLibraryDrop=_gliffy.DefaultLibraryDrop.extend({__tempGroupUid:null,init:function(editor){this.editor=editor},setupShape:function(node,addCommand){this.__tempGroupUid=node.getUid();node.setUid(this.getUid());if(addCommand){this.editor.getDocumentManager().getActiveStage().commandHistory.pushCommandBundle()}},afterDrop:function(node){var lineNode,stage=this.editor.getDocumentManager().getActiveStage(),nodeIds;node.setUid(this.__tempGroupUid);nodeIds=stage.detachSelectionFromGroup(node);this.editor.overlayManager.deselectAll();stage.removeNode(node,true,false);lineNode=stage.find(nodeIds[1]);lineNode.setEditTextOnInit(false);this.editor.overlayManager.selectNodes([lineNode]);this._super(lineNode);_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeAdded",action:this.getUid()});this.editor.overlayManager.overlay.hideAllDrawingGuides()},getUid:function(){return"com.gliffy.shape.uml.uml_v2.sequence.found_message"}})}());(function(){_gliffy.ImageLibraryDrop=_gliffy.CustomLibraryDrop.extend({init:function(editor){this.editor=editor},setupShape:function(node,addCommand){},afterDrop:function(node,palletteShape){node.setLockAspectRatio(true);GliffyApp.contextualPropertiesController.showControls(this.editor.overlayManager.overlay);this.editor.overlayManager.overlay.configControlsDisplay();this.editor.overlayManager.overlay.hideAllDrawingGuides()},getUid:function(){return"com.gliffy.shape.basic.basic_v1.default.image"}})}());(function(){_gliffy.SvgLibraryDrop=_gliffy.CustomLibraryDrop.extend({init:function(editor){this.editor=editor},setupShape:function(node,addCommand){},afterDrop:function(node,palletteShape){node.setLockAspectRatio(true);GliffyApp.contextualPropertiesController.showControls(this.editor.overlayManager.overlay);this.editor.overlayManager.overlay.configControlsDisplay();this.editor.overlayManager.overlay.hideAllDrawingGuides()},getUid:function(){return"com.gliffy.shape.basic.basic_v1.default.svg"}})}());(function(){_gliffy.TableLibraryDrop=_gliffy.CustomLibraryDrop.extend({init:function(editor){this.editor=editor},setupShape:function(node,addCommand){},afterDrop:function(node,palletteShape){var nodeBox=node.getWorldPosition(),stageOffset=_gliffy.Mouse.getContainerOffset(),padding=20,popover,top;top=nodeBox.y+stageOffset.top-node.getHeight();popover=new _gliffy.Popover({left:nodeBox.x+stageOffset.left-padding,top:top,title:$.i18n._("TABLE_POPOVER_TITLE"),content:$.i18n._("TABLE_POPOVER_CONTENT"),cookie:"gliffy-tables",cookieExpires:30,placement:"n"});this.editor.overlayManager.overlay.makeTextEditable();this.editor.overlayManager.overlay.hideAllDrawingGuides()},getUids:function(){return["com.gliffy.shape.table.table_v2.default.table_three_by_three","com.gliffy.shape.table.table_v2.default.table_horizontal_title_three_by_two","com.gliffy.shape.table.table_v2.default.table_vertical_title_three_by_two","com.gliffy.shape.table.table_v2.default.table_horizontal_and_vertical_title_three_by_two"]}})}());(function(){_gliffy.MindmapMainNodeLibraryDrop=_gliffy.CustomLibraryDrop.extend({init:function(editor){this.editor=editor},setupShape:function(node,addCommand){},afterDrop:function(node,palletteShape){var nodeBox=node.getWorldPosition(),stageOffset=_gliffy.Mouse.getContainerOffset(),leftOffset=5,topOffset=15,popover,content,popoverWidth=400;content="<p>"+$.i18n._("MINDMAPS_MAIN_TOPIC_CONTENT")+"</p><p>check check</p>";popover=new _gliffy.Popover({title:$.i18n._("MINDMAPS_MAIN_TOPIC_TIP"),content:"",cookie:"gliffy-mindmap-main-topic-popover",cookieExpires:30,placement:"n",width:popoverWidth});$(popover.htmlContent).find(".gliffy-popover-content").html("<p>"+Ember.Handlebars.helpers.i18n_os("MINDMAPS_MAIN_TOPIC_CONTENT_LINE_1").toString()+"</p><p>"+$.i18n._("MINDMAPS_MAIN_TOPIC_CONTENT_LINE_2")+"</p><p>"+$.i18n._("MINDMAPS_MAIN_TOPIC_CONTENT_LINE_3")+"</p>");$(popover.htmlContent).find(".gliffy-arrow").css("left",popoverWidth/2);$(popover.htmlContent).find(".gliffy-arrow-border").css("left",popoverWidth/2);$(popover.htmlContent).css("left",nodeBox.x+stageOffset.left-$(popover.htmlContent).width()/2+node.getWidth()/2-leftOffset);$(popover.htmlContent).css("top",nodeBox.y+stageOffset.top-$(popover.htmlContent).height()-topOffset);this.editor.overlayManager.overlay.hideAllDrawingGuides();GliffyApp.contextualPropertiesController.showControls(this.editor.overlayManager.overlay)},getUids:function(){return["com.gliffy.shape.mindmap.mindmap_v1.default.main_topic"]}})}());(function(){_gliffy.CustomLibraryDropRegister=_gliffy.Class.extend({libraryDropHandlers:null,init:function(editor){this.libraryDropHandlers={};this.editor=editor;this.ANNOTATION_LIBRARY_DROP=new _gliffy.AnnotationLibraryDrop(editor);this.RECURSIVE_MESSAGE_LIBRARY_DROP=new _gliffy.RecursiveMessageLibraryDrop(editor);this.UNGROUP_AND_SELECT_FIRST_SHAPE_DROP=new _gliffy.UngroupAndSelectFirstShapeDrop(editor);this.SELF_MESSAGE_LIBRARY_DROP=new _gliffy.SelfMessageLibraryDrop(editor);this.UML_V2_LOST_MESSAGE_LIBRARY_DROP=new _gliffy.UmlV2LostMessageLibraryDrop(editor);this.UML_V2_FOUND_MESSAGE_LIBRARY_DROP=new _gliffy.UmlV2FoundMessageLibraryDrop(editor);this.IMAGE_LIBRARY_DROP=new _gliffy.ImageLibraryDrop(editor);this.DEFAULT_LIBRARY_DROP=new _gliffy.DefaultLibraryDrop(editor);this.SVG_LIBRARY_DROP=new _gliffy.SvgLibraryDrop(editor);this.TABLE_LIBRARY_DROP=new _gliffy.TableLibraryDrop(editor);this.MINDMAP_MAIN_NODE_LIBRARY_DROP=new _gliffy.MindmapMainNodeLibraryDrop(editor);this.register()},register:function(){this.add(this.ANNOTATION_LIBRARY_DROP);this.add(this.RECURSIVE_MESSAGE_LIBRARY_DROP);this.add(this.SELF_MESSAGE_LIBRARY_DROP);this.add(this.UML_V2_LOST_MESSAGE_LIBRARY_DROP);this.add(this.UML_V2_FOUND_MESSAGE_LIBRARY_DROP);this.add(this.IMAGE_LIBRARY_DROP);this.add(this.SVG_LIBRARY_DROP);this.add(this.TABLE_LIBRARY_DROP);this.add(this.MINDMAP_MAIN_NODE_LIBRARY_DROP)},add:function(libraryDrop){var uids=libraryDrop.getUids(),i;for(i=0;i<uids.length;i++){this.libraryDropHandlers[uids[i]]=libraryDrop}},getCustomHandler:function(node){if(this.libraryDropHandlers[node.getUid()]){return this.libraryDropHandlers[node.getUid()]}if(node.hasGroupDroppableCopyObject()||node.isGroupDroppable()){return this.UNGROUP_AND_SELECT_FIRST_SHAPE_DROP}return this.DEFAULT_LIBRARY_DROP}})}());(function(){_gliffy._Mouse=_gliffy.Class.extend({super_ui_blocker:$("<div class='gliffy-super-ui-blocker'></div>"),_states:null,_state:null,_clickMode:null,_dragging:false,_did_drag:false,_begin_initial_drag:false,_dragLockTimeout:false,_clickModeMap:null,__mousePos:null,__intentPos:null,__lastMouseUp:null,__mouseDelta:null,__staticOffset:null,__offset:null,__mouseDown:false,__mouseVelocity:0,__mouseTravel:0,__contextMenuMouseDownPosition:null,__intentHandlers:[],editor:null,documentManager:null,__touchHandler:function(event){var touches=event.changedTouches,first=touches[0],type="";switch(event.type){case"touchstart":type="mousedown";break;case"touchmove":type="mousemove";break;case"touchend":type="mouseup";break;default:return}var simulatedEvent=document.createEvent("MouseEvent");simulatedEvent.initMouseEvent(type,true,true,window,1,first.screenX,first.screenY,first.clientX,first.clientY,false,false,false,false,0,null);first.target.dispatchEvent(simulatedEvent);event.preventDefault()},init:function(o){var self=this,blocker;this.editor=o.editor;this.documentManager=this.editor.getDocumentManager();this.__mousePos={x:0,y:0};this.__intentPos={x:0,y:0};this.__lastMouseUp={x:-1,y:-1};this.__mouseDelta={x:0,y:0};this._states={};this._state={};this._clickModeMap={};this.__intentHandlers=[];document.addEventListener("touchstart",this.__touchHandler,true);document.addEventListener("touchmove",this.__touchHandler,true);document.addEventListener("touchend",this.__touchHandler,true);document.addEventListener("touchcancel",this.__touchHandler,true);$(function(){$(document).mousemove(function(event){self.updatePosition(event);self.__mousemove(event)}).mouseup(function(event){self.updatePosition(event);self.__mouseDown=false;if(self.getClickMode()==="stage"){self.__lastMouseUp=self.getPosition()}else{self.__lastMouseUp={x:-1,y:-1}}self.__mouseup(event)}).mousedown(function(event){self.__mouseDown=true}).bind("mousewheel",function(ev,delta,deltaX,deltaY){if(ev.metaKey||ev.ctrlKey||ev.altKey){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");self.editor.overlayManager.deselectAll();if(deltaY<0){self.editor.zoomOverlay.keyboardZoom(false)}else{if(deltaY>0){self.editor.zoomOverlay.keyboardZoom(true)}}ev.stopImmediatePropagation();ev.preventDefault();return false}return true});self.mouseVelocityUpdate();if(_gliffy.BrowserDetect.OS==="Mac"&&$.browser.webkit){$("body").on("mousedown",function(event){if(_gliffy.KeyManager.macCtrlKeyDown){event.stopImmediatePropagation();return false}})}});blocker=$(".gliffy-super-ui-blocker");if(blocker.length===0){this.super_ui_blocker.appendTo("body").hide()}else{this.super_ui_blocker=blocker}this.__autoPanUpdate=function(position){self.setPosition(position);self.__autoPanDrag()}},mouseVelocityUpdate:function(){var currentTime=new Date().getTime(),self=this;if(this.lastVelocityTime&&currentTime!==this.lastVelocityTime){this.__mouseVelocity=Math.round(this.__mouseTravel/(currentTime-this.lastVelocityTime)*1000);this.__mouseTravel=0;if(this.__mouseVelocity===0){this.__mouseIntent=this.__mousePos;if(!_gliffy.Vec2.equals(this.__mouseIntent,this.lastIntent)){this.__handleChangeIntent()}this.lastIntent=this.__mouseIntent}}this.lastVelocityTime=currentTime;setTimeout(function(){self.mouseVelocityUpdate()},250)},__handleChangeIntent:function(callback){var i=0;for(i=0;i<this.__intentHandlers.length;i++){this.__intentHandlers[i](this.getIntent())}},onChangeIntent:function(callback){this.__intentHandlers.push(callback)},registerClickState:function(o){this._clickModeMap[o.name]=o.modes;$("body").on("mousedown",o.target,function(event){if($(event.target).hasClass("link-scroll-container")){return}event.preventDefault();if(event.which===1){o.mouseDown(event)}})},__mousedown:function(event){var self=this;self._dragging=true;self._did_drag=false;self.disableUI();_gliffy.Utils.tryCatch(function(){self.__dragStart(event)},function(e){_gliffy.Logger.error("Error in Mouse Drag Start. clickmode:"+self.getClickMode()+" state:"+self.getState()+" error:"+e.message);_gliffy.handleError("com.gliffy.error.mouse_drag_failed",[],e)})},__mousemove:function(event){var self=this;if(self._dragging){self._did_drag=true;_gliffy.Utils.tryCatch(function(){self.__drag(event)},function(e){_gliffy.Logger.error("Error in Mouse Drag. clickmode: "+self.getClickMode()+" state: "+self.getState()+" error:"+e.message);_gliffy.handleError("com.gliffy.error.mouse_drag_failed",[],e)})}},__mouseup:function(event){var self=this;if(self._dragging){self._dragging=false;_gliffy.Utils.tryCatch(function(){self.__dragEnd(event)},function(e){_gliffy.Logger.error("Error in Mouse Drag End. clickmode: "+self.getClickMode()+" state: "+self.getState()+" error:"+e.message);_gliffy.handleError("com.gliffy.error.mouse_drag_failed",[],e)});$("body").click()}self.enableUI()},registerDragState:function(states){var state,i,j,autoPan;for(i=0;i<states.length;i++){state=states[i];for(j=0;j<state.modes.length;j++){if(state.autoPan){if(!(state.autoPan instanceof (_gliffy.AutoPan))){if(state.autoPan===true){autoPan={editor:this.editor,callback:this.__autoPanUpdate}}else{autoPan=$.extend(true,{editor:this.editor,callback:this.__autoPanUpdate},state.autoPan)}state.autoPan=new _gliffy.AutoPan(autoPan)}}this._states[state.modes[j]]=state}}},__dragStart:function(event){var state;this._begin_initial_drag=false;if(this.getState()&&this._states[this.getState()]){state=this._states[this.getState()];if(state.autoPan){state.autoPan.start(event)}state.dragStart(event)}},__drag:function(event){var state;if(!this.getDragLockTimeout()&&this.getState()&&this._states[this.getState()]){state=this._states[this.getState()];if(state.autoPan){state.autoPan.update(event)}state.drag(event)}},__autoPanDrag:function(){var state;if(this.getState()&&this._states[this.getState()]){state=this._states[this.getState()];state.drag()}},__dragEnd:function(event){var state;if(this.getState()&&this._states[this.getState()]){state=this._states[this.getState()];if(state.autoPan){state.autoPan.stop()}state.dragEnd(event,this._did_drag,this._begin_initial_drag)}},isDragging:function(){return this._dragging},lockDragUI:function(cursorStyle){this.disableUI();_gliffy.CursorManager.setCursor(cursorStyle||null,this.super_ui_blocker)},setCursor:function(cursorStyle){_gliffy.CursorManager.setCursor(cursorStyle||null,this.super_ui_blocker)},disableUI:function(){GliffyApp.contextMenuController.clearAll();this.super_ui_blocker.show()},enableUI:function(){if(this.super_ui_blocker.is(":visible")){this.super_ui_blocker.hide();_gliffy.CursorManager.clearCursor(this.super_ui_blocker)}},setDragLockTimeout:function(dragLockTimeout){this.clearDragLockTimeout();this._dragLockTimeout=dragLockTimeout},getDragLockTimeout:function(){return typeof this._dragLockTimeout==="number"},clearDragLockTimeout:function(){if(this.getDragLockTimeout()){clearTimeout(this._dragLockTimeout)}this._dragLockTimeout=false},setState:function(state){var keys,i;if($.inArray(state,this._clickModeMap[this.getClickMode()])!==-1){this._state[this.getClickMode()]=state}else{keys=Object.keys(this._clickModeMap);for(i=0;i<keys.length;i++){if($.inArray(state,this._clickModeMap[keys[i]])!==-1){this._state[keys[i]]=state}}}},getState:function(){return this._state[this.getClickMode()]},getClickMode:function(){return this._clickMode},setClickMode:function(name){this._clickMode=name},beginInitialDrag:function(clickMode,state){this.setClickMode(clickMode);this.setState(state);var s=this._states[this.getState()];if(s.autoPan){s.autoPan.start()}this._dragging=true;this._did_drag=false;this._begin_initial_drag=true},setPosition:function(position){this.__mouseDelta={x:position.x-this.__mousePos.x,y:position.y-this.__mousePos.y};this.__mousePos={x:position.x,y:position.y}},updatePosition:function(event){var x,y,self=this,zoom;if(self.documentManager){zoom=self.documentManager.getZoom();self.updateOffset();x=(event.pageX-self.__offset.left)/zoom;y=(event.pageY-self.__offset.top)/zoom;self.__mouseDelta={x:x-self.__mousePos.x,y:y-self.__mousePos.y};self.__mousePos={x:x,y:y};if(!self.__mouseTravel){self.__mouseTravel=0}self.__mouseTravel+=Math.sqrt(self.__mouseDelta.x*self.__mouseDelta.x+self.__mouseDelta.y*self.__mouseDelta.y)*zoom}},getVelocity:function(){return this.__mouseVelocity},updateOffset:function(){var offset;offset={left:0,top:0};this.__staticOffset={left:this.editor.containerBounds.min.x,top:this.editor.containerBounds.min.y};offset.left=this.__staticOffset.left+this.documentManager.getActiveStage().pan_x;offset.top=this.__staticOffset.top+this.documentManager.getActiveStage().pan_y;this.__offset=offset},reset:function(){this.__mousePos.x=0;this.__mousePos.x=0;this.__mouseDelta.x=0;this.__mouseDelta.y=0},resetMouseUpPosition:function(){this.__lastMouseUp={x:-1,y:-1}},lastMouseUpPosition:function(){return $.extend({},this.__lastMouseUp)},setLastMouseUpPosition:function(pos){this.__lastMouseUp=pos},getPosition:function(){return $.extend({},this.__mousePos)},getDelta:function(){return $.extend({},this.__mouseDelta)},getContainerOffset:function(){return $.extend({},this.__staticOffset)},getStageOffset:function(){return $.extend({},this.__offset)},getLocalDelta:function(node){return _gliffy.Utils.getLocalOffset(_gliffy.Vec2.difference(this.getPosition(),this.getDelta()),this.getPosition(),node)},isUp:function(){return this.__mouseDown},isDown:function(){return this.__mouseDown},getContextMenuMouseDownPosition:function(){return this.__contextMenuMouseDownPosition},setContextMenuMouseDownPosition:function(pos){this.__contextMenuMouseDownPosition=pos},getIntent:function(){return this.__mouseIntent}})}());(function(){var DEFAULTS={threshold:5,distance:50,multiplier:[0,100,100,100,200,200,400,800,1600],intervalTime:1000/20,callback:null,renderCallback:null,minMoveDistance:20};_gliffy.AutoPan=_gliffy.Class.extend({threshold:null,distance:null,multiplier:null,intervalTime:null,minMoveDistance:null,__documentManager:null,__autoPanCallback:null,__renderCallback:null,__autoPanId:null,__autoPanOffset:null,__position:null,__enabled:true,__moveThreshold:null,__startTime:0,__offsetX:0,__offsetY:0,__previousGuides:null,init:function(o){var options=$.extend({},DEFAULTS,o),self=this;if(!options.editor){throw new Error("Invalid options: a editor is required.")}this.__editor=options.editor;this.__autoPanCallback=options.callback;this.__renderCallback=options.renderCallback;this.threshold=options.threshold;this.distance=options.distance;this.multiplier=options.multiplier;this.__intervalCallback=function(){self.__pan()};this.__moveThreshold=new _gliffy.MoveThreshold(this.minMoveDistance)},__pan:function(){if(this.__isEnabled()){var stage,deltaTime,offsetX,offsetY,originalX,originalY,currentTime,dimension=this.__editor.getDocumentManager().getActiveStageViewPort().getDimension(),zoom=this.__editor.getDocumentManager().getActiveStage().getZoom();stage=this.__editor.getDocumentManager().getActiveStage();originalX=stage.pan_x;originalY=stage.pan_y;currentTime=this.__getCurrentTime();deltaTime=currentTime-this.__startTime;this.__startTime=currentTime;this.__offsetX+=this.__autoPanOffset.x*deltaTime;this.__offsetY+=this.__autoPanOffset.y*deltaTime;offsetX=this.__offsetX>0?Math.floor(this.__offsetX):Math.ceil(this.__offsetX);offsetY=this.__offsetY>0?Math.floor(this.__offsetY):Math.ceil(this.__offsetY);this.__offsetX-=offsetX;this.__offsetY-=offsetY;stage.offsetPan(offsetX,offsetY,dimension.x,dimension.y);offsetX=originalX-stage.pan_x;offsetY=originalY-stage.pan_y;if(Math.abs(offsetX)>0||Math.abs(offsetY)>0){this.__position.x+=offsetX/zoom;this.__position.y+=offsetY/zoom;if(this.__autoPanCallback){this.__autoPanCallback(this.__position)}this.__editor.getDocumentManager().redraw(this.__renderCallback)}}},__isEnabled:function(){return this.__enabled},__getCurrentTime:function(){return(new Date()).getTime()/1000},start:function(event,position){position=position||_gliffy.Mouse.getPosition();if(this.__getStageViewPort().pointInside(position.x,position.y)){this.__moveThreshold.setAbove(true)}else{if(event){this.__moveThreshold.reset(event)}}this.__previousGuides=GliffyApp.documentModel.drawingGuides},enable:function(){this.__enabled=true},disable:function(){this.__enabled=false},__getStageViewPort:function(){var zoom=this.__editor.getDocumentManager().getActiveStage().getZoom();return this.__editor.getDocumentManager().getActiveStageViewPort().clone().extend(-this.distance/zoom)},update:function(event,position){if(this.__moveThreshold.above(event)){var zoomedStageViewPort,offset,x,y,xMag,yMag,actualStageViewPort,stage,zoom;zoomedStageViewPort=this.__getStageViewPort();actualStageViewPort=this.__editor.getDocumentManager().getActiveStageViewPort();stage=this.__editor.getDocumentManager().getActiveStage();zoom=stage.getZoom();position=position||_gliffy.Mouse.getPosition();this.__position=new _gliffy.Vec2(position.x,position.y);if(!zoomedStageViewPort.pointInside(this.__position.x,this.__position.y)){offset=zoomedStageViewPort.pointDistance(this.__position.x,this.__position.y);x=offset.x*zoom/this.threshold;y=offset.y*zoom/this.threshold;xMag=x>0?-1:1;yMag=y>0?-1:1;x=Math.ceil(Math.abs(x));y=Math.ceil(Math.abs(y));offset.x=xMag*(x<this.multiplier.length?this.multiplier[x]:this.multiplier[this.multiplier.length-1]);offset.y=yMag*(y<this.multiplier.length?this.multiplier[y]:this.multiplier[this.multiplier.length-1]);if((actualStageViewPort.min.x<=0&&offset.x>0)||(actualStageViewPort.min.y<=0&&offset.y>0)||(actualStageViewPort.max.x>=stage.maxWidth&&offset.x<0)||(actualStageViewPort.max.y>=stage.maxHeight&&offset.y<0)){this.stop()}else{this.__autoPanOffset=offset;if(this.__autoPanId===null){this.__editor.getDocumentManager().renderer.disableScroll();_gliffy.Utils.setSnapToGrid(false);this.__editor.overlayManager.overlay.hideAllDrawingGuides();GliffyApp.documentModel.set("drawingGuides",false);this.__startTime=this.__getCurrentTime();this.__autoPanId=setInterval(this.__intervalCallback,this.intervalTime)}}}else{this.stop()}}},stop:function(){if(this.__autoPanId!==null){clearInterval(this.__autoPanId);this.__autoPanId=null;this.__autoPanOffset=null;this.__offsetX=0;this.__offsetY=0;this.__startTime=0;this.__editor.getDocumentManager().renderer.enableScroll();GliffyApp.documentModel.set("drawingGuides",this.__previousGuides);this.__editor.overlayManager.overlay.cacheDrawingGuidesInView()}_gliffy.Utils.setSnapToGrid(true)}})}());(function(){var GLIFFY_KEY_NAMESPACE=".gliffyKey";_gliffy._KeyManager=_gliffy.Class.extend({__container:null,__editor:null,__enabled:true,__bindings:null,__onEnterState:null,__onExitState:null,__keyMap:null,__state:null,__lastState:null,__metaCtrlKeyCode:17,shiftKeyDown:false,metaCtrlKeyDown:false,macCtrlKeyDown:false,tabKeyDown:false,__registerEvents:function(){var self=this,panDownPrevMode=null;$(document).keydown(function(e){if(!$("#gliffy-edit-text_ifr").is(":visible")){if(e.which===16){self.shiftKeyDown=true}if(e.which===self.__metaCtrlKeyCode){$(".gliffy-stage").addClass("gliffy-control-key-down");self.metaCtrlKeyDown=true}if(_gliffy.BrowserDetect.OS==="Mac"&&e.which===17){self.macCtrlKeyDown=true}}if(e.which===9){self.tabKeyDown=true}});$(document).keyup(function(e){if(e.which===16){self.shiftKeyDown=false}if(e.which===self.__metaCtrlKeyCode){$(".gliffy-stage").removeClass("gliffy-control-key-down");self.metaCtrlKeyDown=false}if(_gliffy.BrowserDetect.OS==="Mac"&&e.which===17){self.macCtrlKeyDown=false}if(e.which===9){self.tabKeyDown=false}});$(document).on("focus","input",function(event){self.setState("input")});$(document).on("blur","input",function(event){if(self.getState()==="input"){self.setLastState()}});$(window).on("blur",function(e){if($(document.activeElement).is("body")){self.resetModifierKeys()}});$(window).on("focus",function(){self.resetModifierKeys()})},__refreshCurrentState:function(){this.__bindState(null,this.__state);this.__bindState(this.__state,null)},init:function(o){var self=this,panDownPrevMode=null;this.__container=o.container;this.__editor=o.editor;this.__bindings={};this.__onEnterState={};this.__onExitState={};this.__keyMap={};if(_gliffy.BrowserDetect.OS==="Mac"){this.__metaCtrlKeyCode=91;if(_gliffy.BrowserDetect.browser==="Firefox"){this.__metaCtrlKeyCode=224}}setTimeout(function(){self.__registerEvents()},1);this.registerState("default",null,[{action:"blur",keydown:function(e){e.stopImmediatePropagation();self.handleEscKeypress()}},{action:"selectAll",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();self.handleEscKeypress();GliffyApp.toolbarController.doSelectAll()}},{action:"toggleFrameRate",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();_gliffy.RenderLoop.toggleFrameRate()}},{action:"toggleVersionInfo",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.toggleVersionInfo()}},{action:"undo",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.doUndo()}},{action:"redo",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.doRedo()}},{action:"textMode",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();$("#gliffy-toolbar-button-textTool").click()}},{action:"ellipseMode",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();$("#gliffy-toolbar-button-ellipseTool").click()}},{action:"rectMode",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();$("#gliffy-toolbar-button-rectangleTool").click()}},{action:"connectMode",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();$("#gliffy-toolbar-button-connectorTool").click()}},{action:"lineMode",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();$("#gliffy-toolbar-button-lineTool").click()}},{action:"dumpFile",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();self.__editor.viewActiveDocumentSource()}},{action:"doNothing",keydown:function(e){e.stopImmediatePropagation();e.preventDefault()}},{action:"save",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.doSave();return false}},{action:"delete",keydown:function(e){e.preventDefault()}},{action:"zoomIn",keydown:function(e){if((_gliffy.BrowserDetect.browser==="Explorer"&&e.ctrlKey)||(_gliffy.BrowserDetect.browser!=="Explorer"&&e.altKey)){if(_gliffy.BrowserDetect.browser==="Explorer"){_gliffy.Dialog.showAlertDialog({content:$.i18n._("DIALOG_IE9_ZOOM_ERROR_DESCRIPTION"),title:$.i18n._("DIALOG_IE9_ZOOM_ERROR")})}return true}self.__editor.overlayManager.deselectAll();self.__editor.zoomOverlay.keyboardZoom(true);e.stopImmediatePropagation();e.preventDefault();return false}},{action:"zoomOut",keydown:function(e){if((_gliffy.BrowserDetect.browser==="Explorer"&&e.ctrlKey)||(_gliffy.BrowserDetect.browser!=="Explorer"&&e.altKey)){if(_gliffy.BrowserDetect.browser==="Explorer"){_gliffy.Dialog.showAlertDialog({content:$.i18n._("DIALOG_IE9_ZOOM_ERROR_DESCRIPTION"),title:$.i18n._("DIALOG_IE9_ZOOM_ERROR")})}return true}self.__editor.overlayManager.deselectAll();self.__editor.zoomOverlay.keyboardZoom(false);e.stopImmediatePropagation();e.preventDefault();return false}},{action:"pan",keydown:function(e){if(!_gliffy.Mouse.isDown()&&panDownPrevMode===null){panDownPrevMode=self.__editor.getDrawMode();GliffyApp.toolbarController.updateDrawMode(_gliffy.Editor.DRAW_MODE.pan)}e.stopImmediatePropagation();e.preventDefault();return false},keyup:function(e){if(panDownPrevMode!==null){GliffyApp.toolbarController.updateDrawMode(panDownPrevMode);panDownPrevMode=null}e.stopImmediatePropagation();e.preventDefault();return false}},{action:"print",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.openPrintDialog();return false}}]);this.registerState("stage","default",[{action:"nudgeStageLeft",keydown:function(e){return self.__moveStage(e,10,0)}},{action:"nudgeStageRight",keydown:function(e){return self.__moveStage(e,-10,0)}},{action:"nudgeStageUp",keydown:function(e){return self.__moveStage(e,0,10)}},{action:"nudgeStageDown",keydown:function(e){return self.__moveStage(e,0,-10)}},{action:"jumpStageLeft",keydown:function(e){return self.__moveStage(e,10000,0)}},{action:"jumpStageRight",keydown:function(e){return self.__moveStage(e,-10000,0)}},{action:"jumpStageUp",keydown:function(e){return self.__moveStage(e,0,10000)}},{action:"jumpStageDown",keydown:function(e){return self.__moveStage(e,0,-10000)}},{action:"paste",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.doPaste()}}]);this.registerState("input",null,[]);this.setState("stage")},resetModifierKeys:function(){this.metaCtrlKeyDown=false;this.shiftKeyDown=false;this.macCtrlKeyDown=false},__moveStage:function(e,x,y){var dimension=this.__editor.getDocumentManager().getActiveStageViewPort().getDimension();e.stopImmediatePropagation();e.preventDefault();this.__editor.getDocumentManager().getActiveStage().offsetPan(x,y,dimension.x,dimension.y);this.__editor.getDocumentManager().redraw();return false},addKeyBindings:function(keyBindings){this.__keyMap=$.extend(this.__keyMap,keyBindings);this.__refreshCurrentState()},addActionsToState:function(state,actionsArray){var i,j,k,actionExists,existsIdx,keyStates=["keyup","keydown","keypress"],self=this;actionExists=function(action){for(j=0;j<self.__bindings[state].length;j++){if(self.__bindings[state][j].action===actionsArray[i].action){return j}}return -1};var mergeActions=function(keyState,curBinding,newBinding){var curFunc=curBinding[keyState];var newFunc=newBinding[keyState];curBinding[keyState]=function(e){if(curFunc){curFunc(e)}if(newFunc){newFunc(e)}}};for(i=0;i<actionsArray.length;i++){existsIdx=actionExists(actionsArray[i].action);if(existsIdx>=0){for(k=0;k<keyStates.length;k++){mergeActions(keyStates[k],this.__bindings[state][existsIdx],actionsArray[i])}}else{this.__bindings[state].push(actionsArray[i])}}this.__refreshCurrentState()},isControlKey:function(ev){return ev.charCode===0||ev.metaKey||ev.ctrlKey||ev.altKey},registerState:function(state,baseState,bindings,onEnterState,onExitState){if(baseState){baseState=this.__bindings[baseState];if(baseState){bindings=baseState.concat(bindings)}}if(bindings!==undefined){this.__bindings[state]=bindings}if(onEnterState!==undefined){this.__onEnterState[state]=onEnterState}if(onExitState!==undefined){this.__onExitState[state]=onExitState}},__getKeyNameSpace:function(state){return GLIFFY_KEY_NAMESPACE+state},wrapAction:function(handler,state,binding){var self=this;return function(e){if(!(_gliffy.Mouse.isDragging()||self.__editor.overlayManager.overlay.isDragging||self.__editor.overlayManager.lineOverlay.isDragging)){_gliffy.Utils.analyticsEvent("trackEvent",{category:"keyboard."+state,action:binding.action});handler(e)}else{e.preventDefault()}}},__bindState:function(state,previousState){var $document=$(document),bindings,i,binding,id,keys=null;if(state===previousState){return}if(previousState!==null){$document.unbind(this.__getKeyNameSpace(previousState))}if(state!==null){bindings=this.__bindings[state];if(bindings){id=this.__getKeyNameSpace(state);for(i=0;i<bindings.length;i++){binding=bindings[i];if(binding.action){keys=this.__keyMap[binding.action];if(keys){if(binding.keydown){$document.bind("keydown"+id,keys,this.wrapAction(binding.keydown,state,binding))}if(binding.keypress){$document.bind("keypress"+id,keys,this.wrapAction(binding.keypress,state,binding))}if(binding.keyup){$document.bind("keyup"+id,keys,this.wrapAction(binding.keyup,state,binding))}}}else{if(binding.keydown){$document.bind("keydown"+id,this.wrapAction(binding.keydown,state,binding))}if(binding.keypress){$document.bind("keypress"+id,this.wrapAction(binding.keypress,state,binding))}if(binding.keyup){$document.bind("keyup"+id,this.wrapAction(binding.keyup,state,binding))}}}}}},getState:function(){return this.__state},setState:function(state){this.__bindState(state,this.__state);if(this.__state!==state){if(this.__onExitState[this.__state]!==undefined){this.__onExitState[this.__state]()}if(this.__onEnterState[state]!==undefined){this.__onEnterState[state]()}}if(this.__lastState!==this.__state){this.__lastState=this.__state}this.__state=state},setLastState:function(){this.setState(this.__lastState)},handleEscKeypress:function(){GliffyApp.contextMenuController.clearAll();$("#gliffy-toolbar-button-pointer").click()},getActionNames:function(){var names={},i,key,binding,action,result=[];for(key in this.__bindings){if(this.__bindings.hasOwnProperty(key)){binding=this.__bindings[key];for(i=0;i<binding.length;i++){action=binding[i];if(action&&!names[action]){result.push(action);names[action]=true}}}}return result}})}());(function(){_gliffy.DocumentManager=_gliffy.Class.extend({__documents:null,__activeDocument:null,__editor:null,target:null,renderer:null,__pan_on:false,__beforeRenderCallback:null,__panDragInitFunc:null,__panDragFunc:null,__renderCallbacks:null,__forceUpdate:false,__render:false,__draftManager:null,__defaultLibraries:[],init:function(o){var options=$.extend({},{rootServiceURL:_gliffy.shapeLibrary.rootServiceURL},o),self=this,__loop;this.__documents=[];this.__editor=o.editor;_gliffy.shapeLibrary.setup({rootServiceURL:this.__editor.rootServiceUrl,svgToStencilTransformURL:this.__editor.svgToStencilTransformURL});this.__renderCallbacks=[];this.__fireRenderCallbacks2=function(){self.__fireRenderCallbacks()};_gliffy.RenderLoop.appendTask(function(){if(self.__render){self.__deferredRender();self.__render=false}});this.__draftManager=new _gliffy.DraftManager({editor:this.__editor});GliffyApp.printController.registerEventListeners({documentManager:this})},getDraftManager:function(){return this.__draftManager},__fireRenderCallbacks:function(){var i;for(i=0;i<this.__renderCallbacks.length;i++){this.__renderCallbacks[i](this)}this.__renderCallbacks.length=0},__addRenderCallback:function(callback){if(callback&&this.__renderCallbacks.indexOf(callback)===-1){this.__renderCallbacks.push(callback)}},__setForceUpdate:function(forceUpdate){if(forceUpdate){this.__forceUpdate=true}},__renderFunc:function(renderer){var self=this,guideNode;renderer.render({object:self.getActiveStage(),target:self.target,renderCallback:function(){if(self.__fireRenderCallbacks2){self.__fireRenderCallbacks2()}if(self.__forceUpdate){self.__forceUpdate=false}_gliffy.Spinner.hide({context:"forceUpdate"})},forceUpdate:self.__forceUpdate,queueRender:self.__forceUpdate,delayEvery:30,fixedDrawingSpace:true,renderGuides:GliffyApp.documentModel.drawingGuides})},__deferredRender:function(){var renderer=this.renderer,self=this;if(this.renderer){if(this.__forceUpdate){_gliffy.Spinner.show({context:"forceUpdate"});setTimeout(function(){self.__renderFunc(renderer)},1)}else{this.__renderFunc(renderer)}}},setActiveDocument:function(document,skipPanels){var i,tempDocumentMatch=null;$("#gliffy-tabs-container li").removeClass("active");for(i=0;i<this.__documents.length;i++){if(this.__documents[i]===document){tempDocumentMatch=this.__documents[i];this.__documents[i].tabDomElement.parent().addClass("active")}}if(tempDocumentMatch===null&&document!==null){this.__documents.push(document);GliffyApp.documentTabsController.createNewTab(document)}if(this.getActiveDocument()){this.__editor.overlayManager.deselectAll()}this.__activeDocument=document;if(this.renderer!==null){this.getDraftManager().enable();if(!skipPanels){this.loadLibraryPanels()}this.redrawActiveDocument()}$(this).trigger("gliffy-document-manager-set-active-document")},redrawActiveDocument:function(){var self=this;if(this.__activeDocument!==null){GliffyApp.documentModel.update(this.__activeDocument);if(this.renderer!==null){_gliffy.KeyManager.handleEscKeypress();this.__editor.container.removeData("contexts").find(".gliffy-viewbox, .gliffy-graphic").remove();this.redraw(null,true)}}if(this.getActiveStage().getLayers()){GliffyApp.layersController.deserializeLayersObject(this.getActiveStage().getLayersObject())}this.__editor.grid.setEnabled(this.getActiveStage().gridOn);GliffyApp.toolbarController.syncButtons(this.getActiveStage())},loadLibraryPanels:function(){var document=this.getActiveDocument(),i,j,uid,libIds,nodes,libraries;if(document&&document.getLibrariesMetadata()){if(GliffyApp.shapeLibraryModel){GliffyApp.shapeLibraryModel.overridePanels(document.getLibrariesMetadata())}}else{if(GliffyApp.shapeLibraryModel){_gliffy.shapeLibrary.defaultLibraries=[];nodes=this.getActiveStage().flattenNodes(false);for(i=0;i<nodes.length;i++){uid=nodes[i].getUid();if(uid){libIds=_gliffy.shapeLibrary.EXISTING_SHAPE_UID_TO_LIBRARY_MAP[uid.substring(0,uid.lastIndexOf("."))];if(libIds){for(j=0;j<libIds.length;j++){_gliffy.shapeLibrary.addDefaultLibrary(libIds[j])}}}}if(_gliffy.shapeLibrary.defaultLibraries.length===0){libraries=["com.gliffy.libraries.basic.basic_v1.default","com.gliffy.libraries.flowchart.flowchart_v1.default"];if(this.__editor.enableImagePanel){libraries.push("com.gliffy.libraries.images")}GliffyApp.shapeLibraryModel.overridePanels(libraries)}else{_gliffy.shapeLibrary.addDefaultLibrary("com.gliffy.libraries.basic.basic_v1.default");if(this.__editor.enableImagePanel){_gliffy.shapeLibrary.addDefaultLibrary("com.gliffy.libraries.images")}GliffyApp.shapeLibraryModel.overridePanels(_gliffy.shapeLibrary.defaultLibraries)}}}},addAndExecuteCommand:function(command){this.getActiveStage().commandHistory.addAndExecuteCommand(command)},pushCommandBundle:function(){this.getActiveStage().commandHistory.pushCommandBundle()},popCommandBundle:function(){this.getActiveStage().commandHistory.popCommandBundle()},undoCommand:function(){this.getActiveStage().commandHistory.undoCommand()},redoCommand:function(){this.getActiveStage().commandHistory.redoCommand()},forceFinalizeCommandBundle:function(){this.getActiveStage().commandHistory.forceFinalizeCommandBundle()},getActiveStage:function(){return this.getActiveDocument().getStage()},getActiveDocument:function(){return this.__activeDocument},getDocumentCount:function(){return this.__documents.length},removeDocument:function(document){var i,currentIdx=-1;for(i=0;i<this.__documents.length;i++){if(this.__documents[i]===document){this.__documents.splice(i,1);currentIdx=i;GliffyApp.documentTabsController.removeTab(document);this.getDraftManager().removeDraftState(document);break}}if(currentIdx>-1&&document===this.__activeDocument){if(this.__documents.length>0){if(currentIdx<this.__documents.length){this.setActiveDocument(this.__documents[currentIdx])}else{this.setActiveDocument(this.__documents[currentIdx-1])}}else{this.setActiveDocument(null)}}},getDocuments:function(){return this.__documents},setBeforeRenderCallback:function(cb){this.__beforeRenderCallback=cb},render:function(o){var self,loadedCallback,readyCallback,contents,draftManager=this.getDraftManager(),nodes,options=$.extend({},{renderer:_gliffy.Renderer.StageMultiCanvas,url:null,json:null,jsonObj:null,target:null,iframe:false,callback:null,scale:1,textId:null,fixedDrawingSpace:true,pan:false,dirty:false,checkForDrafts:true,useShapeStyles:true,loadLibraryPanels:true},o);if(!options.target){throw new Error("No target specified")}if(!options.url&&!options.json&&!options.jsonObj&&!options.textId){throw new Error("No diagram to view. Pass in a url or json string.")}if(this.__beforeRenderCallback!==null){this.__beforeRenderCallback()}this.target=options.target;if(!_gliffy.renderers[options.renderer.prototype.id]){_gliffy.renderers[options.renderer.prototype.id]=new options.renderer()}this.renderer=_gliffy.renderers[options.renderer.prototype.id];self=this;draftManager.disable();if(options.checkForDrafts){draftManager.hideNotifications();draftManager.removeDraftState(this.getActiveDocument())}loadedCallback=function(){_gliffy.Spinner.show({context:"loaded"});if(!window.tinymce&&!_gliffy.Spinner.isShown({context:"tinymce"})){_gliffy.Spinner.show({context:"tinymce"});var interval=setInterval(function(){if(window.tinymce){self.__editor.overlayManager.textControl.reset(function(){_gliffy.Spinner.hide({context:"tinymce"})});clearInterval(interval)}},50)}_gliffy.Spinner.hide({context:"preload"});setTimeout(function(){_gliffy.Utils.tryCatch(function(){if(!options.useShapeStyles){self.getActiveStage().shapeStyles={};self.getActiveStage().lineStyles={};self.getActiveStage().textStyles={}}self.getActiveStage().setUnsavedChanges(options.dirty);self.getActiveStage().setZoom(options.scale);self.cleanTarget();if(self.getActiveStage().objects&&self.getActiveStage().objects.length>0){_gliffy.Utils.analyticsTimerStart("renderFile")}self.renderer.render({object:self.getActiveStage(),target:self.target,forceUpdate:true,queueRender:true,delayEvery:30,renderCallback:function(){var dimension=self.getActiveStageViewPort().getDimension(),i;if(options.loadLibraryPanels){self.loadLibraryPanels()}_gliffy.Spinner.hide({context:"loaded"});if(_gliffy.Timer.hasTimer("renderFile")){_gliffy.Utils.analyticsTimerEnd("renderFile")}draftManager.enable(self.getActiveDocument());self.enableRenderLoop();if(self.getActiveDocument().getLoadPosition()==="center"){self.getActiveStage().zoomToFit(dimension.x,dimension.y);self.zoomToCenter(1)}if(options.callback){options.callback()}if(self.__forceUpdate){self.__forceUpdate=false}}});GliffyApp.documentModel.reset();GliffyApp.documentModel.update(self.getActiveDocument());self.__editor.grid.setEnabled(self.getActiveStage().gridOn);GliffyApp.toolbarController.syncButtons(self.getActiveStage());$(self).trigger("gliffy-document-manager-loaded-callback")},function(e){_gliffy.Spinner.hide({context:"loaded"});_gliffy.handleError("com.gliffy.error.render_failed",[],e)})},1)};readyCallback=function(){self.cleanTarget();_gliffy.Utils.tryCatch(function(){_gliffy.Spinner.show({context:"preload"});if(options.json){self.getActiveDocument().loadFromText(options.json,loadedCallback)}else{if(options.jsonObj){self.getActiveDocument().loadFromObject(options.jsonObj,loadedCallback)}else{if(options.url){self.__editor.performAction("open",options.url,function(document){self.getActiveDocument().loadFromObject(document,loadedCallback);if(self.hasTransformExceptions(document)){_gliffy.Utils.notify("error",$.i18n._("DOCUMENTMGR_WE_COULD_NOT_CONVERT_ALL_OF_YOUR_SHAPES."),$.i18n._("DOCUMENTMGR_TRY_TO_FIND_EQUIVALENT_SHAPES_IN_THE_GLIFFY_LIBRARIES_OR_UPLOAD_IMAGES_TO_REPLACE_THEM."))}},function(xhr,text,error){if(xhr.status===404){window.GLIFFY.Dialog.showAlertDialog({content:$.i18n._("com.gliffy.error.file_not_found"),title:$.i18n._("com.gliffy.error.uh_oh")});if(loadedCallback){loadedCallback()}}else{if(xhr.status===401){window.GLIFFY.Dialog.showAlertDialog({content:$.i18n._("com.gliffy.error.file_not_authorized"),title:$.i18n._("com.gliffy.error.uh_oh")});if(loadedCallback){loadedCallback()}}else{if(xhr.status===403){window.GLIFFY.Dialog.showAlertDialog({content:$.i18n._("com.gliffy.error.file_forbidden"),title:$.i18n._("com.gliffy.error.uh_oh")});if(loadedCallback){loadedCallback()}}else{_gliffy.handleError("com.gliffy.error.file_malformed",[options.url],error,self.errorTarget)}}}})}else{if(options.textId){self.getActiveDocument().loadFromText($(options.textId),loadedCallback)}}}}},function(e){_gliffy.handleError("com.gliffy.error.file_load",[],e)})};if(options.iframe){contents=options.target.contents();if(contents&&contents.get(0).readyState==="complete"&&contents.find("#container").length>0){self.target=contents.find("#container");readyCallback()}else{options.target.load(function(){self.target=options.target.contents().find("#container");readyCallback()})}}else{readyCallback()}},hasTransformExceptions:function(documentData){var hasTransformException=false,i,errors;if(documentData.gon&&documentData.gon.errors){errors=documentData.gon.errors;for(i=0;i<errors.length;i++){_gliffy.Logger.warn("Transform:"+errors[i].level+" : "+errors[i].exception+" : "+errors[i].message);if(errors[i].level==="exception"){hasTransformException=true}}}return hasTransformException},cleanTarget:function(){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text",{skipSaveToDocument:true});this.target.find(".gliffy-stage").find(".gliffy-graphic,.gliffy-text,.gliffy-viewbox,.gliffy-drawing-guide").remove();this.target.data("contexts",null);_gliffy.Tree.clear()},redrawDebug:function(callback,forceUpdate){var self=this;this.__addRenderCallback(callback);this.__setForceUpdate(forceUpdate);_gliffy.Utils.tryCatch(function(){self.__deferredRender()},function(e){_gliffy.handleError("com.gliffy.error.render_failed",[],e)})},disableRenderLoop:function(){this.__renderLoopEnabled=false;this.__render=false},enableRenderLoop:function(){this.__renderLoopEnabled=true},redraw:function(callback,forceUpdate){if(this.__renderLoopEnabled){if(_gliffy.Debug.SKIP_RENDER_LOOP){this.redrawDebug()}else{this.__addRenderCallback(callback);this.__setForceUpdate(forceUpdate);this.__render=true}}},getActiveStageViewPort:function(){var dimension=this.__editor.containerBounds.getDimension(),minX=-this.getActiveStage().pan_x,minY=-this.getActiveStage().pan_y,zoom=this.getZoom();return new _gliffy.BoundingBox(minX/zoom,minY/zoom,(minX+dimension.x)/zoom,(minY+dimension.y)/zoom)},zoomToBox:function(boundingBox,callback){var dimension=this.getActiveStageViewPort().getDimension();this.getActiveStage().zoomToBox(boundingBox,dimension.x,dimension.y);GliffyApp.documentModel.update(this.getActiveDocument());this.redraw(callback,true)},zoomToCenter:function(zoom,callback){var dimension=this.getActiveStageViewPort().getDimension();this.getActiveStage().zoomToCenter(zoom,dimension.x,dimension.y);GliffyApp.documentModel.update(this.getActiveDocument());this.redraw(callback,true)},zoomAt:function(zoom,stageX,stageY,callback){var dimension=this.getActiveStageViewPort().getDimension();this.getActiveStage().zoomAt(zoom,stageX,stageY,dimension.x,dimension.y);GliffyApp.documentModel.update(this.getActiveDocument());this.redraw(callback,true)},zoomToFit:function(callback){var dimension=this.getActiveStageViewPort().getDimension();this.getActiveStage().zoomToFit(dimension.x,dimension.y);GliffyApp.documentModel.update(this.getActiveDocument());this.redraw(callback,true)},zoom:function(zoomValue,callback){this.getActiveStage().setZoom(zoomValue);GliffyApp.documentModel.update(this.getActiveDocument());this.redraw(callback,true)},getZoom:function(){return this.getActiveStage().getZoom()},reset:function(callback){this.getActiveStage().pan_x=0;this.getActiveStage().pan_y=0;this.getActiveStage().setZoom(1);this.redraw(callback,true)},pan:function(x,y,callback){this.getActiveStage().pan_x=x;this.getActiveStage().pan_y=y;this.redraw(callback)},getPreviewImageFromGon:function(gon,callback){var self=this,tmp,gonObject=new _gliffy.Gon();gonObject.fromObject(gon,{subscribeToConstraints:false});gonObject.__registerShapes(function(){self.getImageData(gonObject.stage,"image/png",callback,true)})},getSvgData:function(stage,callback,showProgressBar){var rendererId,svgRenderTarget;rendererId=_gliffy.Renderer.StageSvg.prototype.id;if(!_gliffy.renderers[rendererId]){_gliffy.renderers[rendererId]=new _gliffy.Renderer.StageSvg()}svgRenderTarget=$("<div>");$("body").append(svgRenderTarget);_gliffy.renderers[rendererId].render({object:stage,show_progress_bar:showProgressBar,target:svgRenderTarget,renderCallback:callback})},getImageData:function(stage,contentType,callback,showProgressBar,scale){var deferred,tmp,isTransparentJPG,tmpStageBackground,prevZoom;deferred=new $.Deferred();isTransparentJPG=(stage.isTransparent()&&contentType==="image/jpeg");prevZoom=stage.getZoom();stage.setZoom(scale);if(isTransparentJPG){tmpStageBackground=stage.background;stage.background="#FFFFFF"}tmp=$("<div/>");$("body").append(tmp);if(!_gliffy.renderers[_gliffy.Renderer.StageSingleCanvas.prototype.id]){_gliffy.renderers[_gliffy.Renderer.StageSingleCanvas.prototype.id]=new _gliffy.Renderer.StageSingleCanvas()}_gliffy.renderers[_gliffy.Renderer.StageSingleCanvas.prototype.id].render({object:stage,target:tmp,show_progress_bar:showProgressBar,boundingBoxFit:(stage.getViewportType()==="fit")?true:false,ignoreZoom:false,renderCallback:function(){var $canvas,canvas,imageData,imageData2;$canvas=tmp.find("canvas");canvas=$canvas.get(0);if(contentType==="smallest"){imageData=canvas.toDataURL("image/png");imageData2=canvas.toDataURL("image/jpeg");if(imageData.length>imageData2.length){imageData=imageData2;imageData2=null}}else{imageData=canvas.toDataURL(contentType)}if(!_gliffy.Debug.EXPORT_TEXT_DISPLAY){tmp.remove()}stage.setZoom(prevZoom);callback(imageData,deferred)}});if(isTransparentJPG){stage.background=tmpStageBackground}return deferred.promise()},updateTextDefaults:function(prop,value){var activeDocument=this.getActiveDocument();if(!activeDocument.getStage().textStyles.global){activeDocument.getStage().textStyles.global=new _gliffy.TextStyle()}switch(prop){case"bold":case"italic":case"underline":activeDocument.getStage().textStyles.global[prop]=!activeDocument.getStage().textStyles.global[prop];break;case"face":case"size":case"color":activeDocument.getStage().textStyles.global[prop]=value;break}},applyTextDefaults:function(html,themeType){var $html,globalDefaults,$span,textTheme;$html=$(html);globalDefaults=this.getActiveDocument().getStage().textStyles.global;if(_gliffy.FEATURES.alwaysUseStaticShapeStyleDefaults){globalDefaults=null}if(!globalDefaults){globalDefaults=new _gliffy.TextStyle()}if(this.getActiveDocument().getStage().themeData&&themeType){if(themeType==="text"){textTheme=this.getActiveDocument().getStage().themeData.text}else{if(themeType==="line"){textTheme=this.getActiveDocument().getStage().themeData.line.text}else{textTheme=this.getActiveDocument().getStage().themeData.shape[themeType].text}}globalDefaults.fromTheme(textTheme)}$("body").append($html);$span=$html.find("span:first");if(globalDefaults&&$span.length===1){if(globalDefaults.bold){$span.css("font-weight","bold")}if(globalDefaults.italic){$span.css("font-style","italic")}if(globalDefaults.underline){$span.css("text-decoration","underline")}if(globalDefaults.face){$span.css("font-family",globalDefaults.face)}if(globalDefaults.size){$span.css("font-size",globalDefaults.size)}if(globalDefaults.color){$span.css("color",globalDefaults.color)}}$html.remove();return $html[0].outerHTML},updateStyleDefaultsForNode:function(node,prop,value){var subLibraryId=node.getSubLibraryId(),nodeStyle,activeDocument=this.getActiveDocument();if(node.isLine()){nodeStyle=activeDocument.getStage().lineStyles.global}else{if(subLibraryId&&!node.getShapeInformation().useStaticStyleDefaults){nodeStyle=activeDocument.getStage().shapeStyles[subLibraryId]}}if(prop==="BorderWidth"||prop==="LineThickness"){prop="strokeWidth"}if(prop==="DropShadow"){prop="shadow"}prop=prop.charAt(0).toLowerCase()+prop.slice(1);if(nodeStyle&&nodeStyle[prop]!==undefined){nodeStyle[prop]=value}},generateSvg:function(callback){var activeStage,deferred;deferred=new $.Deferred();activeStage=this.getActiveStage();this.getSvgData(activeStage,function(mockContext){GliffyApp.progressBarController.getBar().delay(500).queue(function(next){GliffyApp.progressBarController.hide();next()});var svgDiagramSerialized=mockContext.getSvg(true);if(callback){callback(svgDiagramSerialized,deferred)}},true);return deferred.promise()},centerOnStage:function(node){var deferred=$.Deferred(),dimension=this.getActiveStageViewPort().getDimension(),self=this;this.__editor.overlayManager.overlay.isDragging=true;this.getActiveStage().centerAt(node.getX(),node.getY(),dimension.x,dimension.y);GliffyApp.documentModel.update(this.getActiveDocument());this.redraw(function(){setTimeout(function(){self.__editor.overlayManager.overlay.isDragging=false;_gliffy.Mouse.updateOffset();GliffyApp.contextualPropertiesController.showControls(self.__editor.overlayManager.getActiveOverlay())},1);deferred.resolve()},false);return deferred.promise()}})}());(function(){var LINE_THRESHOLD=13*13,MIN_SIZE=3,CLASS_NAME="gliffy-text-selector";_gliffy.DrawManager=_gliffy.Class.extend({__active:false,__orthoMode:0,__documentManager:null,__dragStageDiv:null,fileHandlerRegister:null,customLibraryDropRegister:null,init:function(o){if(!o){throw new Error("Selector init needs options")}if(!o.documentManager){throw new Error("DrawManager init options needs document manager")}if(!o.dragStageDiv){throw new Error("DrawManager init options needs dragStageDiv")}this.__documentManager=o.documentManager;this.__editor=this.__documentManager.__editor;this.__dragStageDiv=o.dragStageDiv;this.fileHandlerRegister=new _gliffy.FileHandlerRegister(this);this.customLibraryDropRegister=new _gliffy.CustomLibraryDropRegister(this.__editor);this.bindDropHandler()},bindDropHandler:function(){var element=(this.__editor&&this.__editor.container)?this.__editor.container.get(0):null,self=this;document.ondragover=function(){return false};document.ondragend=function(){return false};document.ondrop=function(e){e.preventDefault()};if(element){element.ondragover=function(){return false};element.ondragend=function(){return false};element.ondrop=function(e){e.preventDefault();_gliffy.Mouse.updatePosition(e);var files,source,i,j,handler,file,fileHandlers=self.fileHandlerRegister.getFileHandlers(),url;if(e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length>0){files=(e.files||e.dataTransfer.files)}else{if(e.dataTransfer){files=[];try{source=e.dataTransfer.getData("text/html");url=_gliffy.Utils.getImageUrlFromHtml(source)}catch(error){source=e.dataTransfer.getData("TEXT");if(source!==null){url=_gliffy.Utils.getImageUrlFromHtml(source)}else{url=e.dataTransfer.getData("URL")}}if(url&&url.length>0){files.push({url:url,source:source,type:"url"})}}}for(i=0;i<files.length;i++){file=files[i];for(j=0;j<fileHandlers.length;j++){handler=fileHandlers[j];if(handler.canHandleFile(file)){handler.handle(file,i);break}}}return false}}},bindDrawHandlers:function(){var editor=this.__editor,stage=editor.container.find(".gliffy-stage"),self=this,shapeInfo,startPos,lastpos;_gliffy.Mouse.registerDragState([{modes:["ellipse","rectangle"],dragStart:function(){shapeInfo=self.shapeToolStartDrag(editor.getDrawMode())},drag:function(){if(shapeInfo){self.shapeToolDrag(shapeInfo.node,shapeInfo.initX,shapeInfo.initY)}},dragEnd:function(){if(shapeInfo){self.shapeToolDragEnd(shapeInfo,editor.overlayManager)}shapeInfo=null},autoPan:true},{modes:["text"],dragStart:function(){self.__dragStageDiv.setClassName(CLASS_NAME);self.__dragStageDiv.setStartCorner(_gliffy.Mouse.getPosition())},drag:function(){self.__dragStageDiv.setEndCorner(_gliffy.Mouse.getPosition());if(!self.__dragStageDiv.isScreenDiagonalLessThan(MIN_SIZE)){self.__dragStageDiv.draw()}else{self.__dragStageDiv.hide()}},dragEnd:function(){var node,pos,w,h,bounds;node=new _gliffy.Node();pos=_gliffy.Mouse.getPosition();w=150;h=0;bounds=self.__dragStageDiv.getBoundingBox();if(self.__dragStageDiv.isVisible()&&(bounds.max.x-bounds.min.x>10)&&(bounds.max.x-bounds.min.x>10)){pos.x=(bounds.min.x+bounds.max.x)/2;pos.y=(bounds.min.y+bounds.max.y)/2;w=bounds.max.x-bounds.min.x}self.__dragStageDiv.hide();self.createText(node,pos.x-(w*0.5),pos.y-(h*0.5),w,h);editor.getDocumentManager().addAndExecuteCommand(new _gliffy.AddNodeCommand({node:node,prepend:true}));editor.getDocumentManager().redraw(function(){node.getGraphic().editable.setEditMode(true);node.getGraphic().editable.focus();node.getGraphic().editable.select();editor.overlayManager.textControl.edit(node.getGraphic());node.getGraphic().editable.registerBlurHandler(function(){GliffyApp.contextualPropertiesController.blurRTE();editor.getDocumentManager().redraw()})})},autoPan:true},{modes:["ortho","line"],dragStart:function(){editor.getDocumentManager().pushCommandBundle();var node,pos,line,lineStyle,themeData=null;node=new _gliffy.Node();pos=_gliffy.Mouse.getPosition();startPos=pos;editor.drawManager.createLine(node,pos.x,pos.y);line=node.getGraphic();line.setOrtho(editor.getDrawMode()===_gliffy.Editor.DRAW_MODE.ortho);if(!editor.getDocumentManager().getActiveDocument().getStage().lineStyles.global){lineStyle=new _gliffy.LineStyle();editor.getDocumentManager().getActiveDocument().getStage().lineStyles.global=lineStyle}else{lineStyle=editor.getDocumentManager().getActiveDocument().getStage().lineStyles.global}themeData=editor.getDocumentManager().getActiveStage().themeData;if(themeData){lineStyle.fromTheme(themeData.line)}line.applyStyle(lineStyle);node.update();editor.__documentManager.addAndExecuteCommand(new _gliffy.AddNodeCommand({node:node,prepend:true}));editor.overlayManager.ungroupSelectedNodes();editor.overlayManager.lineOverlay.isNewlyCreatedLine=true;editor.overlayManager.selectNode(node);editor.overlayManager.lineOverlay.simulateControlDrag(0,pos,"start");editor.overlayManager.lineOverlay.simulateControlDrag(0,pos);editor.overlayManager.lineOverlay.simulateControlDrag(0,pos,"end");editor.overlayManager.lineOverlay.simulateControlDrag(1,pos,"start");_gliffy.Mouse.setCursor("move")},drag:function(){editor.overlayManager.lineOverlay.simulateControlDrag(1,_gliffy.Mouse.getPosition())},dragEnd:function(){var pos,dist2,selectedNode,currentNode;pos=_gliffy.Mouse.getPosition();editor.overlayManager.lineOverlay.isNewlyCreatedLine=false;editor.overlayManager.lineOverlay.simulateControlDrag(1,pos,"end");editor.__documentManager.addAndExecuteCommand(new _gliffy.ModifyLineCommand({node:editor.overlayManager.lineOverlay.getSelectedNode()}));editor.getDocumentManager().popCommandBundle();dist2=_gliffy.Vec2.squaredDistance(startPos,pos);selectedNode=editor.overlayManager.lineOverlay.getSelectedNode();if(selectedNode){selectedNode.setHeight(Math.abs(pos.y-startPos.y));selectedNode.setWidth(Math.abs(pos.x-startPos.x))}if(dist2<=LINE_THRESHOLD){editor.overlayManager.deselectAll();editor.getDocumentManager().getActiveStage().commandHistory.removeAndUndoLastCommand();currentNode=_gliffy.Pick.getNodeAt(editor.getDocumentManager().getActiveStage().objects,pos.x,pos.y);if(currentNode){$("#gliffy-toolbar-button-pointer").trigger({type:"click",deselect:false});editor.overlayManager.selectNode(currentNode);GliffyApp.contextualPropertiesController.showControls(editor.overlayManager.getActiveOverlay())}else{editor.overlayManager.lineOverlay.showConnectionPoints(true)}}},autoPan:true},{modes:["pan"],dragStart:function(event){_gliffy.CursorManager.setCursor("hand-closed");_gliffy.Mouse.lockDragUI("hand-closed");lastpos={x:event.pageX,y:event.pageY}},drag:function(event){var xDiff,yDiff,dimension=editor.getDocumentManager().getActiveStageViewPort().getDimension();xDiff=event.pageX-lastpos.x;yDiff=event.pageY-lastpos.y;lastpos={x:event.pageX,y:event.pageY};editor.getDocumentManager().getActiveStage().offsetPan(xDiff,yDiff,dimension.x,dimension.y);editor.getDocumentManager().renderer.render({object:editor.getDocumentManager().getActiveStage(),target:editor.getDocumentManager().target,panOnly:true})},dragEnd:function(){_gliffy.CursorManager.setCursor("hand")}}])},createLine:function(node,x1,y1,x2,y2){var line;if(x2===undefined){line=new _gliffy.Line(node)}else{line=new _gliffy.Line(node,new _gliffy.Vec2(0,0),new _gliffy.Vec2(x2-x1,y2-y1))}line.editable.allowComputeBestPath=true;node.setEditTextOnInit(false);node.setX(x1);node.setY(y1);node.setGraphic(line);return node},createShape:function(node,x,y){var shape=new _gliffy.Shape(node);node.setGraphic(shape);shape.setGradient(true);node.setX(x-50);node.setY(y-50);return node},createImage:function(node,params,x,y){var proxy=new _gliffy.Proxy(node),default_text=node.getShapeInformation().defaults?node.getShapeInformation().defaults.default_text_style:[{}],self=this,swapProxy,downloadImage,img;node.setGraphic(proxy);node.setEditTextOnInit(false);node.setX(x-50);node.setY(y-50);node.setLockAspectRatio(true);this.setupTextDefaults(node,default_text,true,null);swapProxy=function(){var node=proxy.getNode(),image=new _gliffy.Image(node),isSmall=img.width<15||img.height<15;proxy.replaceWith(image);image.setDropShadow(false);image.setUrl(img.src);image.imgWidth=img.width;image.imgHeight=img.height;node.setWidth(Math.max(img.width,15));node.setHeight(Math.max(img.height,15));node.clearCachedAspectRatio();node.update();if(self.__editor.overlayManager.overlay.isActive()){if(isSmall){node.setLockAspectRatio(false);self.__editor.overlayManager.overlay.setLockAspectRatio(false)}self.__editor.overlayManager.overlay.refresh();GliffyApp.contextualPropertiesController.configureDialogControls();self.__editor.overlayManager.overlay.setSelectedNode(node)}self.redraw();img=null;swapProxy=null};downloadImage=function(url){if(url){img=new Image();img.onload=swapProxy;img.onerror=function(){img=new Image();img.onload=swapProxy;img.src=_gliffy.Renderer.ImageCanvas.imageNotAvailable};img.src=url}else{img=new Image();img.onload=swapProxy;img.src=_gliffy.Renderer.ImageCanvas.imageNotAvailable}};if(params.image){if(params.doNotProxyImage){downloadImage(params.image)}else{this.__editor.performAction("image",params.image,downloadImage,function(xhr,text,error){})}}else{if(params.getImageUrl){params.getImageUrl(downloadImage)}}return node},createSvg:function(node,params,x,y){var proxy=new _gliffy.Proxy(node),resources,resource,dim,self=this,default_text=node.getShapeInformation().defaults?node.getShapeInformation().defaults.default_text_style:[{}];node.setEditTextOnInit(false);proxy.setDropShadow(false);node.setGraphic(proxy);node.setX(x-50);node.setY(y-50);node.setLockAspectRatio(true);this.setupTextDefaults(node,default_text,true,null);_gliffy.shapeLibrary.loadSvgStencil(params.svg).then(function(data){dim=_gliffy.shapeLibrary.svgDim[params.svg];var width=dim.width,height=dim.height,svg=new _gliffy.Svg(node);node=proxy.getNode();if(dim.height>0&&dim.width>0){if(dim.width>1000||dim.height>1000){while(width>1000||height>1000){width/=2;height/=2;node.setHeight(height);node.setWidth(width)}}else{node.setHeight(dim.height);node.setWidth(dim.width)}}resources=self.__documentManager.getActiveDocument().getEmbeddedResources();dim=_gliffy.shapeLibrary.svgDim[params.svg];resource=resources.add("image/svg+xml",params.svg,dim.x,dim.y,dim.width,dim.height);svg.setEmbeddedResourceId(resource.getId());proxy.replaceWith(svg);node.setFlag("bounds");node.update();if(self.__editor.overlayManager.overlay.isActive()){self.__editor.overlayManager.overlay.refresh();GliffyApp.contextualPropertiesController.configureDialogControls()}self.redraw()},function(text){_gliffy.Utils.notify("info",$.i18n._("SVG_FILE_HANDLER_NOTIFY_TITLE"),$.i18n._("SVG_FILE_HANDLER_NOTIFY_MESSAGE"));new _gliffy.RemoveNodeCommand({node:proxy.getNode()}).execute(self.__documentManager.getActiveStage());self.redraw();_gliffy.Logger.warn("Could not import svg: "+text)});return node},setupShape:function(node,params,pos,addCommand){var defaults=null,shapeInfo,customHandler,tid,shapeStyle,themeType;node.setUid(params.uid);customHandler=this.customLibraryDropRegister.getCustomHandler(node);shapeInfo=node.getShapeInformation();addCommand=(addCommand!==false&&pos!==undefined&&pos!==null);if(shapeInfo&&shapeInfo.defaults&&shapeInfo.defaults.copyObject){node.fromObject(shapeInfo.defaults.copyObject);node.setEditTextOnInit(shapeInfo.defaults.editTextOnInit===true);customHandler.setupShape(node,addCommand);if(node.getShapeInformation()&&node.getShapeInformation().defaults&&node.getShapeInformation().defaults.themeType&&this.__documentManager.getActiveStage().themeData){shapeStyle=new _gliffy.ShapeStyle();themeType=node.getShapeInformation().defaults.themeType;shapeStyle.fromTheme(this.__documentManager.getActiveStage().themeData.shape[themeType]);if(node.getGraphic()){node.getGraphic().applyStyle(shapeStyle)}if(node.isMultipartShape()){_.each(node.findGraphic(_gliffy.Shape),function(shapeNode){shapeNode.getGraphic().applyStyle(shapeStyle)})}}if(addCommand){this.__documentManager.addAndExecuteCommand(new _gliffy.AddCopyNodeCommand({node:node}));this.__documentManager.redraw()}}else{if(params.tid==="com.gliffy.stencil.image"){this.createImage(node,params,pos.x,pos.y)}else{if(params.tid==="com.gliffy.stencil.custom.svg.static"){this.createSvg(node,params,pos.x,pos.y)}else{defaults=(shapeInfo)?shapeInfo.defaults:null;if(params.tid==="com.gliffy.stencil.line"){this.createLine(node,pos.x-50,pos.y,pos.x+50,pos.y);this.setupLineDefaults(node,defaults)}else{this.createShape(node,pos.x,pos.y);tid=params.tid;if(!tid&&_gliffy.shapeLibrary.shapes[params.uid]){tid=_gliffy.shapeLibrary.shapes[params.uid].tids[0]}if(tid){node.getGraphic().setTid(tid)}else{_gliffy.Logger.error("Error: cannot find TID for shape with UID: "+params.uid)}this.setupShapeDefaults(node,defaults)}}}customHandler.setupShape(node,addCommand);if(addCommand){this.__documentManager.addAndExecuteCommand(new _gliffy.AddNodeCommand({node:node,prepend:true}));this.__documentManager.redraw()}}},setupShapeDefaults:function(node,defaults){var graphic=node.getGraphic(),themeType,shapeInfo;if(defaults){node.setWidth(defaults.width);node.setHeight(defaults.height);node.setRotation(defaults.rotate);node.setLockAspectRatio(defaults.lockAspectRatio);if(defaults.opacity){node.getGraphic().setOpacity(defaults.opacity)}if(defaults.editTextOnInit!==undefined){node.setEditTextOnInit(defaults.editTextOnInit)}this.setupShapeGraphicStyleDefaults(node,defaults);shapeInfo=node.getShapeInformation();themeType=(shapeInfo&&shapeInfo.defaults&&shapeInfo.defaults.themeType)?shapeInfo.defaults.themeType:null;this.setupTextDefaults(node,defaults.default_text_style,node.getShapeInformation().useStaticTextStyleDefaults,themeType)}},setupShapeGraphicStyleDefaults:function(node,defaults){var graphic,subLibraryId,shapeStyle,useStaticStyleDefaults;graphic=node.getGraphic();subLibraryId=node.getSubLibraryId();useStaticStyleDefaults=node.getShapeInformation().useStaticStyleDefaults;if(_gliffy.FEATURES.alwaysUseStaticShapeStyleDefaults){useStaticStyleDefaults=true}if(node.getShapeInformation()&&node.getShapeInformation().defaults&&node.getShapeInformation().defaults.themeType&&this.__documentManager.getActiveStage().themeData){shapeStyle=new _gliffy.ShapeStyle();shapeStyle.fromTheme(this.__documentManager.getActiveStage().themeData.shape[node.getShapeInformation().defaults.themeType])}else{if(useStaticStyleDefaults){shapeStyle=new _gliffy.ShapeStyle();shapeStyle.fromObject(defaults)}else{if(this.__documentManager.getActiveStage().shapeStyles[subLibraryId]){shapeStyle=this.__documentManager.getActiveStage().shapeStyles[subLibraryId]}else{shapeStyle=new _gliffy.ShapeStyle();shapeStyle.fromObject(defaults);this.__documentManager.getActiveStage().shapeStyles[subLibraryId]=shapeStyle}}}graphic.applyStyle(shapeStyle)},setupLineDefaults:function(node,defaults){var graphic,useStaticStyleDefaults;graphic=node.getGraphic();useStaticStyleDefaults=node.getShapeInformation().useStaticStyleDefaults;if(_gliffy.FEATURES.alwaysUseStaticShapeStyleDefaults){useStaticStyleDefaults=true}if(defaults){if(defaults.orthoMode>=0){graphic.setOrtho(true)}graphic.applyStyle(defaults);if(defaults.editTextOnInit!==undefined){node.setEditTextOnInit(defaults.editTextOnInit)}this.setupTextDefaults(node,defaults.default_text_style,useStaticStyleDefaults,"line")}},setupTextDefaults:function(node,textDefaults,ignoreGlobalOverrides,themeType){var text=new _gliffy.Text();text.setupDefaults(textDefaults);if(!ignoreGlobalOverrides){text.setHTML(this.__documentManager.applyTextDefaults(text.getHTML(),themeType))}node.setDefaultTextGraphic(text)},createText:function(node,x,y,width,height){var text=new _gliffy.Text(node);text.setOverflow("none");text.setVPosition("none");node.setX(x);node.setY(y);node.setWidth(width);node.setHeight(height);node.setGraphic(text);node.setUid("com.gliffy.shape.basic.basic_v1.default.text");return node},setOrthoMode:function(mode){if(mode!==undefined&&mode!==null&&mode<Object.keys(_gliffy.Editor.ORTHO_MODE).length&&mode>=0){this.__orthoMode=mode}else{throw new Error(mode+" is not a valid ortho line type")}},shapeToolStartDrag:function(type){var uid,tid,node,pos,graphic,self,rect,snapPixels,initX,initY,params;if(type!==_gliffy.Editor.DRAW_MODE.ellipse&&type!==_gliffy.Editor.DRAW_MODE.rectangle){return}snapPixels=_gliffy.Utils.shouldSnapToGrid()?_gliffy.Utils.SNAP_PIXELS:1;uid="com.gliffy.shape.basic.basic_v1.default.ellipse";tid="com.gliffy.stencil.ellipse.basic_v1";if(type===_gliffy.Editor.DRAW_MODE.rectangle){uid="com.gliffy.shape.basic.basic_v1.default.rectangle";tid="com.gliffy.stencil.rectangle.basic_v1"}node=new _gliffy.Node();pos=_gliffy.Mouse.getPosition();pos.x=pos.x-pos.x%snapPixels;pos.y=pos.y-pos.y%snapPixels;params={tid:tid,uid:uid};this.setupShape(node,params,pos,false);graphic=node.getGraphic();graphic.setGradient(false);graphic.setFillColor("#ffffff");graphic.setStrokeColor("#000000");graphic.setDropShadow(false);graphic.setShadowX(0);graphic.setShadowY(0);graphic.setStrokeWidth(1);node.setX(pos.x);node.setY(pos.y);node.setWidth(0);node.setHeight(0);self=this;rect=null;initX=pos.x;initY=pos.y;self.__documentManager.addAndExecuteCommand(new _gliffy.AddNodeCommand({node:node,prepend:true}));this.__documentManager.redraw();return{node:node,initX:initX,initY:initY}},shapeToolDrag:function(node,initX,initY){var pos,eventX,eventY,l,r,t,b,w,h,snapPixels,rect;snapPixels=_gliffy.Utils.shouldSnapToGrid()?_gliffy.Utils.SNAP_PIXELS:1;pos=_gliffy.Mouse.getPosition();eventX=pos.x-pos.x%snapPixels;eventY=pos.y-pos.y%snapPixels;l=Math.min(initX,eventX);r=Math.max(initX,eventX);t=Math.min(initY,eventY);b=Math.max(initY,eventY);w=r-l;h=b-t;rect={tl:new _gliffy.Vec2(l,t),br:new _gliffy.Vec2(r,b)};if(rect.tl.x!==node.getX()||rect.tl.y!==node.getY()){this.__documentManager.addAndExecuteCommand(new _gliffy.MoveNodeCommand({node:node,x:rect.tl.x,y:rect.tl.y}))}if(w!==node.getWidth()||h!==node.getHeight()){this.__documentManager.addAndExecuteCommand(new _gliffy.SetWidthAndHeightCommand({node:node,width:w,height:h}))}this.__documentManager.redraw()},shapeToolDragEnd:function(shapeInfo,overlayManager){var diff,pos,eventX,eventY,l,r,t,b,w,h,snapPixels,rect;snapPixels=_gliffy.Utils.shouldSnapToGrid()?_gliffy.Utils.SNAP_PIXELS:1;pos=_gliffy.Mouse.getPosition();eventX=pos.x-pos.x%snapPixels;eventY=pos.y-pos.y%snapPixels;l=Math.min(shapeInfo.initX,eventX);r=Math.max(shapeInfo.initX,eventX);t=Math.min(shapeInfo.initY,eventY);b=Math.max(shapeInfo.initY,eventY);rect={tl:new _gliffy.Vec2(l,t),br:new _gliffy.Vec2(r,b)};if(shapeInfo.node){diff=new _gliffy.Vec2(0,0);if(rect){diff=_gliffy.Vec2.difference(rect.br,rect.tl)}if(diff.x<10&&diff.y<10){new _gliffy.RemoveNodeCommand({node:shapeInfo.node}).execute(this.__documentManager.getActiveStage());this.__documentManager.redraw()}else{overlayManager.deselectAll();overlayManager.selectNode(shapeInfo.node);GliffyApp.contextualPropertiesController.showControls(overlayManager.getActiveOverlay());this.__documentManager.getActiveStage().setUnsavedChanges(true)}}},redraw:function(){this.__documentManager.redraw()}})}());(function(){_gliffy.OverlayManager=_gliffy.Class.extend({overlay:null,lineOverlay:null,quickConnectionOverlay:null,tableOverlay:null,networkRackOverlay:null,textControl:null,__documentManager:null,__container:null,__editor:null,__selectedNodes:null,__enabled:true,__dragStageDiv:null,__nodeSelectionEnabled:true,__selectionNodesToBreakup:null,__DOUBLE_CLICK_TIMEOUT:300,__STUPID_IE9_DOUBLE_CLICK_TIMEOUT:700,init:function(o){this.__selectedNodes=[];this.__selectionNodesToBreakup=[];this.config(o)},config:function(o){if(!o){throw new Error("overlayManager config needs options")}if(!o.documentManager){throw new Error("overlayManager config options needs documentManager")}if(!o.target){throw new Error("overlayManager config options needs target")}if(!o.editor){throw new Error("overlayManager config options needs editor")}this.__documentManager=o.documentManager;this.__container=o.target;this.__editor=o.editor;this.__dragStageDiv=o.dragStageDiv;if(this.textControl===null){this.textControl=new _gliffy.TextControl(o)}if(this.overlay===null){this.overlay=new _gliffy.Overlay({documentManager:o.documentManager,target:o.target,textControl:this.textControl,manager:this})}if(this.lineOverlay===null){this.lineOverlay=new _gliffy.LineOverlay({editor:o.editor,documentManager:o.documentManager,target:o.target,textControl:this.textControl})}if(this.quickConnectionOverlay===null){this.quickConnectionOverlay=new _gliffy.QuickConnectionOverlay({editor:o.editor,documentManager:o.documentManager,target:o.target,manager:this})}if(this.tableOverlay===null){this.tableOverlay=new _gliffy.TableOverlay({editor:o.editor,documentManager:o.documentManager,target:o.target,manager:this})}if(this.networkRackOverlay===null){this.networkRackOverlay=new _gliffy.NetworkRackOverlay({editor:o.editor,documentManager:o.documentManager,target:o.target,manager:this})}var self=this;this.__documentManager.setBeforeRenderCallback(function(){self.overlay.deselect();self.lineOverlay.detach();self.overlay.detach();self.quickConnectionOverlay.detach();self.tableOverlay.detach();self.networkRackOverlay.detach()});$(".gliffy-stage").delegate("a:not(.gliffy-rte-text a)","mouseenter",function(ev){self.__nodeSelectionEnabled=false});$(".gliffy-stage").delegate("a:not(.gliffy-rte-text a)","mouseleave click",function(ev){self.__nodeSelectionEnabled=true})},getDoubleClickTimeout:function(){if(_gliffy.BrowserDetect.browser==="Explorer"&&_gliffy.BrowserDetect.version===9){return this.__STUPID_IE9_DOUBLE_CLICK_TIMEOUT}else{return this.__DOUBLE_CLICK_TIMEOUT}},getContainer:function(){return $("#container")},singleDownNoNode:function(event){var self=this;_gliffy.KeyManager.setState("stage");if(self.__enabled){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");self.deselectAll()}},singleDownWithNode:function(event,selectedNode,textChild){var self=this,lastSelected=this.getSelectedNode(),position=_gliffy.Mouse.getPosition(),node;if(self.__enabled&&self.__nodeSelectionEnabled&&selectedNode.isSelectable()){if(!lastSelected||(selectedNode&&lastSelected.getId()!==selectedNode.getId())){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text")}if(!(this.__editor.getDrawMode()===_gliffy.Editor.DRAW_MODE.line||this.__editor.getDrawMode()===_gliffy.Editor.DRAW_MODE.ortho)){event.preventDefault();if(selectedNode){if(_gliffy.KeyManager.shiftKeyDown||_gliffy.KeyManager.metaCtrlKeyDown){if(self.addNodeToSelection(selectedNode)){self.overlay.beginInitialDrag();event.stopPropagation()}}else{self.deselectAll();if(self.selectNode(selectedNode,textChild)){if(selectedNode.getGraphic() instanceof _gliffy.Line){self.lineOverlay.beginInitialDrag(event,textChild)}else{self.overlay.beginInitialDrag()}event.stopPropagation();GliffyApp.hudController.show(GliffyApp.hudController.HUD_MODE.pos)}}}else{if(lastSelected.getGraphic() instanceof _gliffy.Line){self.lineOverlay.beginInitialDrag(event)}else{self.overlay.beginInitialDrag()}}}}else{if(!self.__nodeSelectionEnabled){_gliffy.Logger.warn("OverlayManager skipping node selection")}}},setEnabled:function(enabled){this.__enabled=enabled},getSelectedNodes:function(){var nodes=[],i=0,n;for(i=0;i<this.__selectedNodes.length;i++){n=this.__documentManager.getActiveStage().find(this.__selectedNodes[i]);if(n){nodes.push(n)}}return nodes},getSelectedNode:function(){if(this.getActiveOverlay()===null){return null}else{return this.getActiveOverlay().getSelectedNode()}},selectNodes:function(nodes){var selectionNode,nodeIds;if(nodes.length>0){this.deselectAll();nodeIds=this.nodeIdsFromSelection(nodes);if(nodeIds.length>1){this.__selectedNodes=nodeIds;selectionNode=this.createSelectionNode();if(selectionNode){this.selectNode(selectionNode,true)}else{return false}return selectionNode}else{if(nodeIds.length===1){this.selectNode(nodes[0]);return nodes[0]}}}return false},selectAllNodes:function(){var pickableNodes,nodes;nodes=this.__documentManager.getActiveStage().objects;pickableNodes=_.reject(nodes,function(node){return !node.isPickable()});this.selectNodes(pickableNodes)},nodeIdsFromSelection:function(objects){var i,object,toAdd=[],children,j;for(i=0;i<objects.length;i++){object=objects[i];if($.inArray(object.getId(),toAdd)===-1){toAdd.push(object.getId())}}return toAdd},addSelectionNodesToBreakup:function(node){if(node&&node.isSelection&&$.inArray(node.getId(),this.__selectionNodesToBreakup)===-1){this.__selectionNodesToBreakup.push(node.getId())}},deselectAll:function(){if(typeof this.__documentManager==="undefined"){return}var i,stage=this.__documentManager.getActiveStage(),node;this.getContainer().trigger("gliffy-overlay-manager-deselect-all");for(i=0;i<this.__selectionNodesToBreakup.length;i++){node=stage.find(this.__selectionNodesToBreakup[i]);if(node&&node.isSelection()){this.ungroupifySelection(node)}}this.overlay.deselect();this.lineOverlay.deselect();this.quickConnectionOverlay.hide();this.tableOverlay.hide();this.networkRackOverlay.hide();this.__selectionNodesToBreakup=[];this.__selectedNodes=[];this.__documentManager.redraw()},selectNode:function(node,textChild){var container=this.__container,selectedText="";if(node.isLine()){this.overlay.deselect();this.lineOverlay.select(node,container)}else{if(node.isTable()){this.overlay.deselect();this.overlay.select(node,container);container.trigger("gliffy-overlay-manager-select-node")}else{if(node.isRackShape()){this.overlay.deselect();this.overlay.select(node,container);container.trigger("gliffy-overlay-manager-select-rack-node")}else{this.lineOverlay.deselect();this.overlay.select(node,container);this.quickConnectionOverlay.show(node,container)}}}if(!node.isSelection()){this.__selectedNodes=[node.getId()]}if(node.isGroup()||node.isSelection()){selectedText=""}else{if(node.isLine()){if(node.children&&node.children.length===1){selectedText=node.children[0].getGraphic().getHTML()}else{if(textChild){selectedText=textChild.getGraphic().getHTML()}else{selectedText=""}}}else{if(node.children&&node.children.length!==0&&node.children[0].getGraphic() instanceof _gliffy.Text){selectedText=node.children[0].getGraphic().getHTML()}else{if(node.getGraphic() instanceof _gliffy.Text){selectedText=node.getGraphic().getHTML()}else{selectedText=""}}}}this.updateRTEControls(selectedText);return true},updateRTEControls:function(content){var isFirefox=(_gliffy.BrowserDetect.browser==="Firefox"),ed=null,top,left;if(window.tinymce){ed=tinymce.activeEditor}if(ed&&ed.getContent()!==content){if(isFirefox){$("#gliffy-edit-text-container").css({display:""});top=$("#container").scrollTop();left=$("#container").scrollLeft()}ed.setContent(content);ed.selection.select(ed.getBody(),true);ed.nodeChanged();if(isFirefox){$("#gliffy-edit-text-container").css({display:"none"})}if(isFirefox){$("#container").scrollTop(top);$("#container").scrollLeft(left)}_gliffy.Utils.stealFocus()}},createSelectionNode:function(){var parentNode,stage;parentNode=new _gliffy.Node();stage=this.__documentManager.getActiveStage();parentNode.setUid("com.gliffy.shape.basic.basic_v1.default.selection");stage.appendNode(parentNode);stage.attachSelectionToGroup(parentNode,this.getSelectedNodes());if(!parentNode.children){new _gliffy.RemoveNodeCommand({node:parentNode}).execute(stage);return null}else{this.addSelectionNodesToBreakup(parentNode);return parentNode}},ungroupSelectedNodes:function(){var parentNode,stage;parentNode=this.overlay.getSelectedNode();stage=this.__documentManager.getActiveStage();if(parentNode&&parentNode.isSelection()){stage.detachSelectionFromGroup(parentNode);new _gliffy.RemoveNodeCommand({node:parentNode}).execute(stage);this.__documentManager.redraw()}},groupifySelection:function(){var node=this.overlay.getSelectedNode();if(node&&node.isSelection()){this.__selectedNodes=[node.getId()];this.__selectedNodes=[node.getId()];this.__documentManager.addAndExecuteCommand(new _gliffy.GroupCommand({node:node}))}},ungroupifyGroup:function(){var groupNode=this.overlay.getSelectedNode();if(groupNode&&groupNode.isGroup()){this.__documentManager.addAndExecuteCommand(new _gliffy.UngroupCommand({node:this.overlay.getSelectedNode()}))}this.overlay.deselect();this.lineOverlay.deselect()},ungroupifySelection:function(node){if(node.isSelection()){_gliffy.Tree.remove(node);this.__documentManager.getActiveStage().detachSelectionFromGroup(node);new _gliffy.RemoveNodeCommand({node:node}).execute(this.__documentManager.getActiveStage())}},addNodeToSelection:function(node){var i,curNode,selectedNodes=this.getSelectedNodes(),selectedNode=this.getSelectedNode(),stage=this.__documentManager.getActiveStage();if(this.getSelectedNodes().length===0){return this.selectNode(node,false)}else{if(!node.isSelection()){for(i=0;i<selectedNodes.length;i++){curNode=selectedNodes[i];if(curNode.isSelection()){return false}if(curNode.getId()===node.getId()){return false}}this.__selectedNodes.push(node.getId());if(selectedNode.isSelection()){stage.addSelectionToGroup(selectedNode,[node])}else{selectedNode=this.createSelectionNode()}this.lineOverlay.deselect();this.overlay.deselect();if(selectedNode){return this.selectNode(selectedNode,true)}else{return false}}else{return false}}},setDrawMode:function(drawMode){this.deselectAll();this.__enabled=(drawMode!==_gliffy.Editor.DRAW_MODE.pan);this.overlay.setActive(this.__enabled&&drawMode!==_gliffy.Editor.DRAW_MODE.line&&drawMode!==_gliffy.Editor.DRAW_MODE.ortho)},getActiveOverlay:function(){if(this.lineOverlay.isActive()){return this.lineOverlay}else{if(this.overlay.isActive()){return this.overlay}else{return null}}},deleteSelectedNode:function(){var nodes=this.getSelectedNodes(),commands=[],i=0,deleted=false;if(nodes.length>0){if(this.getActiveOverlay()===this.lineOverlay){deleted=this.lineOverlay.deleteActiveText()}if(!deleted){this.deselectAll();for(i=0;i<nodes.length;i++){if(nodes[i].getGraphic() instanceof _gliffy.Line){commands.push(new _gliffy.RemoveNodeCommand({node:nodes[i]}))}}for(i=0;i<nodes.length;i++){if(!(nodes[i].getGraphic() instanceof _gliffy.Line)){if(nodes[i].isMindmap()){nodes[i].findGraphic(_gliffy.Mindmap)[0].getGraphic().removeNode(commands)}commands.push(new _gliffy.RemoveNodeCommand({node:nodes[i]}))}}this.__documentManager.addAndExecuteCommand(new _gliffy.BundledCommand({commands:commands}))}this.__documentManager.redraw()}this.deselectAll()},updateOverlayX:function(value){if(this.overlay.isActive()){this.overlay.setTransX(value);this.overlay.__redrawModel=true;this.overlay.__popCommandBundle=true;this.getContainer().trigger("gliffy-overlay-manager-update-x")}},updateOverlayY:function(value){if(this.overlay.isActive()){this.overlay.setTransY(value);this.overlay.__redrawModel=true;this.overlay.__popCommandBundle=true;this.getContainer().trigger("gliffy-overlay-manager-update-y")}},updateOverlayWidth:function(value){var minWidth,newHeight,newWidth,node;if(this.overlay.isActive()){node=this.getSelectedNode();minWidth=node.getMinWidth();newWidth=Math.max(minWidth,value);if(node.getLockAspectRatio()){newHeight=newWidth/node.getAspectRatio();this.overlay.setTransY(node.getY()+(node.getHeight()-newHeight)/2)}this.overlay.setTransX(node.getX()+(node.getWidth()-newWidth)/2);this.overlay.setScaleX(newWidth);this.overlay.__redrawModel=true;this.overlay.__popCommandBundle=true;this.getContainer().trigger("gliffy-overlay-manager-update-width")}},updateOverlayHeight:function(value){var minHeight,newHeight,newWidth,node;if(this.overlay.isActive()){node=this.getSelectedNode();minHeight=node.getMinHeight();newHeight=Math.max(minHeight,value);if(node.getLockAspectRatio()){newWidth=newHeight*node.getAspectRatio();this.overlay.setTransX(node.getX()+(node.getWidth()-newWidth)/2)}this.overlay.setTransY(node.getY()+(node.getHeight()-newHeight)/2);this.overlay.setScaleY(newHeight);this.overlay.__redrawModel=true;this.overlay.__popCommandBundle=true;this.getContainer().trigger("gliffy-overlay-manager-update-height")}},updateOverlayRotation:function(value){if(this.overlay.isActive()){this.overlay.setRotation(value);this.overlay.__redrawModel=true;this.overlay.__popCommandBundle=true;this.getContainer().trigger("gliffy-overlay-manager-update-rotation")}}})}());(function(){var INHERIT="inherit",CURSOR_DATA="__cursor";_gliffy._CursorManager=_gliffy.Class.extend({__container:null,__enabled:true,init:function(options){options=options||{};if(!options.container){throw new Error("The options must contain a container.")}this.__container=$(options.container);if(_gliffy.BrowserDetect.browser==="Firefox"&&_gliffy.BrowserDetect.version===17){this.__enabled=false}},setCursor:function(name,element){if(this.__enabled){var jqElement=element?$(element):this.__container;this.clearCursor(element);if(name!==null){if(typeof(name)!=="string"){name=this.getCursorName(name)}if(name!==null){this.__setCursorName(name,jqElement);name=this.__getCursorClass(name);jqElement.addClass(name)}}}},clearCursor:function(element){var jqElement,name;if(this.__enabled){jqElement=element?$(element):this.__container;name=this.getCursorName(jqElement);if(name){this.__clearCursorName(jqElement);name=this.__getCursorClass(name);jqElement.removeClass(name);if(!element){jqElement.removeClass(this.__getCursorClass(INHERIT))}}}},pushCursor:function(name,element){var jqElement;if(this.__enabled){jqElement=element?$(element):this.__container;if(name!==null){if(typeof(name)!=="string"){name=this.getCursorName(name)}if(name!==null){this.__removeCurrentCursor(jqElement);this.__pushCursorName(name,jqElement);name=this.__getCursorClass(name);jqElement.addClass(name);if(!element){jqElement.addClass(this.__getCursorClass(INHERIT))}}}}},popCursor:function(element){var jqElement,name,data;if(this.__enabled){jqElement=element?$(element):this.__container;name=this.__popCursorName(jqElement);if(name){name=this.__getCursorClass(name);jqElement.removeClass(name);name=this.getCursorName(jqElement);if(name!==null){jqElement.addClass(this.__getCursorClass(name))}data=jqElement.data(CURSOR_DATA);if(data===null||data.length<=1){jqElement.removeClass(this.__getCursorClass(INHERIT))}}}},getCursorName:function(element){var jqElement,name;if(this.__enabled){jqElement=element?$(element):this.__container;name=jqElement.data(CURSOR_DATA)||null;return name?name[name.length-1]:null}return null},__getCursorClass:function(name){return"gliffy-cursor-"+name},__removeCurrentCursor:function(jqElement){var name=this.getCursorName(jqElement);if(name){jqElement.removeClass(this.__getCursorClass(name))}},__clearCursorName:function(jqElement){jqElement.data(CURSOR_DATA,null)},__setCursorName:function(name,jqElement){jqElement.data(CURSOR_DATA,[name])},__pushCursorName:function(name,jqElement){var names=jqElement.data(CURSOR_DATA)||null;if(names===null){names=[];jqElement.data(CURSOR_DATA,names)}names.push(name)},__popCursorName:function(jqElement){var names=jqElement.data(CURSOR_DATA)||null;if(names===null){return null}else{return names.pop()||null}}})}());(function(){_gliffy.DraftManager=_gliffy.Class.extend({_draftsEnabled:null,_editor:null,_enabled:null,_interval:null,_draftNoticeTemplate:null,_draftStatusTemplate:null,_draftDiffTemplate:null,_i18nStrings:null,createI18nStrings:function(indices){var obj={},i;for(i=0;i<indices.length;i++){obj["i18n_"+indices[i]]=$.i18n._(indices[i])}return obj},init:function(o){var self=this,options=$.extend({editor:null},o);this._editor=options.editor;this._interval=options.editor.draftInterval;this._draftsEnabled=options.editor.draftsEnabled;this._i18nStrings=this.createI18nStrings(["DRAFT_LOAD_DRAFT","DRAFT_YOU_HAVE_A_DRAFT_FROM","DRAFT_DRAFT_SAVED_AT","DRAFT_DISCARD_DRAFT","DRAFT_DRAFT_PREVIEW","DRAFT_WHAT_DO_YOU_WANT_TO_DO","DRAFT_PREVIEW_DRAFT"]);$(function(){if(self.draftsEnabled()){$("body").on("click","#gliffyViewDraftDiff",function(event){event.preventDefault();var notice=$("#gliffy-draft-notice");self.showDraftDiff(notice.data("draft"))});$("body").on("click","#gliffyLoadDraft",function(event){event.preventDefault();var notice=$("#gliffy-draft-notice");self.getDraft(notice.data("draft"),function(gon){self.loadDraft(gon)});notice.alert("close")});$("body").on("click","#gliffyDiscardDraft",function(event){event.preventDefault();var notice=$("#gliffy-draft-notice");self.deleteDraft();notice.alert("close")})}})},draftsEnabled:function(){return this._draftsEnabled},getDocument:function(){return this._editor.getDocumentManager().getActiveDocument()},removeDraftState:function(document){document.draftState=null},getDraftState:function(document){if(!document.draftState){document.draftState={firstCheck:true,commandLength:document.getStage().commandHistory.getSize(),noticeDraft:null,saveDraft:null}}return document.draftState},isActive:function(){return this._enabled===true},enable:function(){var self=this,state;this.disable();if(this._enabled===false&&this.draftsEnabled()&&this._interval>=5){this._enabled=true;state=this.getDraftState(this.getDocument());if(state.firstCheck){state.firstCheck=false;self.checkDraft()}if(state.noticeDraft){this.displayAutosaveDraftNotice(state.noticeDraft)}else{if(state.saveDraft){this.displayDraftStatus(state.saveDraft)}this.enableSaveDraftLoop()}}return this},disable:function(){this._enabled=false;this.hideNotifications();clearTimeout(this.timeout);return this},waitAndEnableSaveDraftLoop:function(){var self=this;clearTimeout(this.timeout);this.timeout=setTimeout(function(){self.enableSaveDraftLoop()},this._interval*1000)},enableSaveDraftLoop:function(){var self=this,document=this.getDocument(),state=this.getDraftState(document),stage=document.getStage();clearTimeout(this.timeout);if(!document.isAutosaveDisabled()&&this.draftsEnabled()&&this._enabled&&document&&stage.hasUnsavedChanges()&&!this._editor.isSaving()&&stage.objects.length>0&&!this.isShowingDraftNotice()&&((state.commandLength!==stage.commandHistory.getSize())||$("#gliffy-edit-text_ifr:visible").length>0)){this.saveDraft()}else{this.timeout=setTimeout(function(){self.enableSaveDraftLoop()},self._interval*1000)}},sanitizeDocument:function(document){var stage=new _gliffy.Stage(),i,node,activeTextNode,textNode,textContent,isMultipart;stage.fromObject(document.gon.stage,{subscribeToConstraints:false});stage.update();activeTextNode=$("#gliffy-edit-text_ifr:visible").data("node");if(activeTextNode){textNode=stage.find(activeTextNode.getId());isMultipart=textNode.getUidNode().isMultipartShape();textContent=$("<div>").append($(tinyMCE.activeEditor.getDoc().body).clone());textContent.find(".gliffy-placeholder-text").removeClass("gliffy-placeholder-text");if(_gliffy.Utils.hasNonWhitespaceCharacter(textContent.text())||isMultipart){textNode.getGraphic().setHTML(textContent.html())}else{if(!isMultipart){stage.removeNode(textNode)}}}for(i=0;i<stage.objects.length;i++){node=stage.objects[i];if(node.isSelection()){stage.detachSelectionFromGroup(node);stage.removeNode(node)}}stage.update();document.gon.stage=stage.toObject();return document},saveDraft:function(){var self=this,document=this.getDocument(),state=this.getDraftState(document);this._editor.integration.saveDraft(this.sanitizeDocument(document.toObject()),function(draft){state.noticeDraft=null;state.saveDraft=draft;state.commandLength=document.getStage().commandHistory.getSize();self.displayDraftStatus(draft);self.waitAndEnableSaveDraftLoop()},function(obj,err,which){_gliffy.Logger.error("Failed to saveDraft:"+document.getTitle());var repl="#";if(window.parent.jQuery){var content=window.parent.jQuery("#confluence-base-url").attr("content");if(content&&content.length>0){repl=content}else{if(window.GLIFFY&&window.GLIFFY.baseConfluenceUrl){repl=window.GLIFFY&&window.GLIFFY.baseConfluenceUrl}}}_gliffy.Dialog.showAlertDialog({content:$.i18n._("ERROR_SAVE_FAILURE").replace("{0}",repl),title:$.i18n._("ERRORHANDLER_ERROR"),escapeHTML:false,cancelCallback:function(){self.waitAndEnableSaveDraftLoop()},buttons:[{text:$.i18n._("DIALOG_OK"),callback:function(){self.waitAndEnableSaveDraftLoop()},primary:true,dismiss:true,add_classes:[]}]})})},getDraft:function(draft,callback){this._editor.integration.getDraft(draft.location,function(gon){callback(gon)},function(){callback(null)})},loadDraft:function(gon){var self=this,document=this.getDocument(),state=this.getDraftState(document),docObj;if(gon){this.disable();state.noticeDraft=null;state.saveDraft=null;docObj=document.toObject();docObj.gon=gon;self._editor.open({jsonObj:docObj,checkForDrafts:false,callback:function(){self._editor.getDocumentManager().getActiveStage().setUnsavedChanges(true);state.commandLength=document.getStage().commandHistory.getSize();self.enable()}})}else{self.enable();_gliffy.Logger.error("No draft to load.")}},isShowingDraftNotice:function(){return $("#gliffy-draft-notice").is(":visible")},checkDraft:function(){var self=this,document=this.getDocument(),state=this.getDraftState(document);this._editor.integration.checkDraft(document.toObject(),function(draftArray){if(draftArray&&draftArray.length>0){state.noticeDraft=draftArray[0];self.displayAutosaveDraftNotice(draftArray[0])}else{self.enableSaveDraftLoop()}},function(data){self.waitAndEnableSaveDraftLoop();_gliffy.Logger.error("Failed to check for draft for document:"+document.getTitle())})},deleteDraft:function(){var self=this,document=this.getDocument(),state=this.getDraftState(document);self.hideNotifications();self._editor.integration.deleteDraft(document.toObject(),function(){state.noticeDraft=null;state.saveDraft=null;self.enableSaveDraftLoop()},function(){self.waitAndEnableSaveDraftLoop();_gliffy.Logger.error("Failed to delete draft for document:"+document.getTitle())})},displayAutosaveDraftNotice:function(draft){var template,html;if(!this._draftNoticeTemplate){this._draftNoticeTemplate=$("#gliffy-draft-notice-template").html()}template=Handlebars.compile(this._draftNoticeTemplate);html=template($.extend({date:draft.friendlyDate},this._i18nStrings));$(html).appendTo("body").data({draft:draft}).alert()},displayDraftStatus:function(draft){var template,html;if(!this._draftStatusTemplate){this._draftStatusTemplate=$("#gliffy-draft-status-template").html()}if(!draft.createDate){draft.createDate=new Date()}template=Handlebars.compile(this._draftStatusTemplate);html=template($.extend({date:new Date(draft.createDate).toString("HH:mm:ss")},this._i18nStrings));$("#gliffy-draft-status").remove();$(html).appendTo("body");$("body").trigger("gliffy.display-draft-status")},showDraftDiff:function(draft){if(!this._draftDiffTemplate){this._draftDiffTemplate=$("#gliffy-draft-diff-template").html()}var html,template,self=this;$("#gliffy-draft-diff").remove();this.getDraft(draft,function(gon){self._editor.getDocumentManager().getPreviewImageFromGon(gon,function(imageData){var bar=GliffyApp.progressBarController.getBar(),barQueueLength=bar.queue().length;bar.delay(500).queue(function(next){template=Handlebars.compile(self._draftDiffTemplate);html=template($.extend({img:imageData},self._i18nStrings));GliffyApp.progressBarController.hide();$(html).appendTo("body").modal("show");next()});if(barQueueLength===0){bar.dequeue()}})})},hideNotifications:function(){$("#gliffy-draft-notice,#gliffy-draft-status,#gliffy-draft-diff").remove()}})}());(function(){var _alignments={align:{left:function(boundingBox,node){var pos=node.getWorldPosition();return{x:boundingBox.min.x+node.getBoundsOffset().x,y:pos.y}},center:function(boundingBox,node){var pos=node.getWorldPosition();return{x:boundingBox.getCenter().x+node.getBoundsOffset().x-node.worldAabb.getWidth()/2,y:pos.y}},right:function(boundingBox,node){var pos=node.getWorldPosition();return{x:boundingBox.max.x+node.getBoundsOffset().x-node.worldAabb.getWidth(),y:pos.y}},top:function(boundingBox,node){var pos=node.getWorldPosition();return{x:pos.x,y:boundingBox.min.y+node.getBoundsOffset().y}},middle:function(boundingBox,node){var pos=node.getWorldPosition();return{x:pos.x,y:boundingBox.getCenter().y+node.getBoundsOffset().y-node.worldAabb.getHeight()/2}},bottom:function(boundingBox,node){var pos=node.getWorldPosition();return{x:pos.x,y:boundingBox.max.y+node.getBoundsOffset().y-node.worldAabb.getHeight()}}},distribute:{horizontal:function(boundingBox,node,numNodes,index){var pos=node.getWorldPosition();return{x:(numNodes-1>0)?boundingBox.min.x+boundingBox.getWidth()*index/(numNodes-1)+node.getBoundsOffset().x-node.worldAabb.getWidth()/2:pos.x,y:pos.y}},vertical:function(boundingBox,node,numNodes,index){var pos=node.getWorldPosition();return{x:pos.x,y:(numNodes-1>0)?boundingBox.min.y+boundingBox.getHeight()*index/(numNodes-1)+node.getBoundsOffset().y-node.worldAabb.getHeight()/2:pos.y}}}};_gliffy._Align=_gliffy.Class.extend({_documentManager:null,init:function(options){if(!options||!options.documentManager){throw new Error("The Align Instance needs a documentManager in the options.")}this._documentManager=options.documentManager},align:function(type,nodes){this._transform(type,nodes,false)},distribute:function(type,nodes){this._transform(type,nodes,true)},_sortNodes:function(type,nodes){var getEdge={horizontal:function(bb){return bb.getCenter().x},vertical:function(bb){return bb.getCenter().y}};nodes.sort(function(a,b){if(getEdge[type](a.worldAabb)>getEdge[type](b.worldAabb)){return 1}else{return -1}});return nodes},_dumpUnalignable:function(nodes){var i,ret=[];for(i=0;i<nodes.length;i++){if(this._isAlignable(nodes[i])){ret.push(nodes[i])}}return ret},_transform:function(type,nodes,isDistribute){var i,pos,node,boundingBox=_gliffy.BoundingBox.SMALLEST.clone(),parentOffset,centers,i;if(nodes.length>0){this._documentManager.pushCommandBundle();nodes=this._dumpUnalignable(nodes);if(isDistribute){nodes=this._sortNodes(type,nodes);centers=[];for(i=0;i<nodes.length;i++){centers.push(nodes[i].worldAabb.getCenter())}boundingBox.fitPoints(centers)}else{for(i=0;i<nodes.length;i++){boundingBox.add(nodes[i].worldAabb)}}for(i=0;i<nodes.length;i++){node=nodes[i];pos=_alignments[(isDistribute?"distribute":"align")][type](boundingBox,node,nodes.length,i);if(node.parent){parentOffset=node.parent.getWorldPosition()}else{parentOffset={x:0,y:0}}this._documentManager.addAndExecuteCommand(new _gliffy.MoveNodeCommand({node:node,x:pos.x-parentOffset.x,y:pos.y-parentOffset.y}))}this._documentManager.redraw();this._documentManager.popCommandBundle()}},_isAlignable:function(node){return !node.getLockPosition()&&!node.isConnectedLine()}})}());(function(){_gliffy.MoveThreshold=_gliffy.Class.extend({__x:0,__y:0,__above:false,__distanceThreshold:3,init:function(distanceThreshold){if(distanceThreshold){this.__distanceThreshold=distanceThreshold}},setDistanceThreshold:function(distanceThreshold){this.__distanceThreshold=distanceThreshold},reset:function(event){this.__x=event.pageX;this.__y=event.pageY;this.__above=false},above:function(event){var x,y;if(this.__above||!event){return this.__above}x=event.pageX-this.__x;y=event.pageY-this.__y;this.__above=x*x+y*y>=this.__distanceThreshold*this.__distanceThreshold;return this.__above},setAbove:function(value){this.__above=value}})}());(function(){_gliffy.StageDiv=_gliffy.Class.extend({__points:null,__boundingBox:null,__redraw:false,__display:null,__className:null,init:function(options){var self=this;if(!options||!options.documentManager){throw new Error("StageDiv init does not have valid options. A documentManager is required.")}this.__boundingBox=new _gliffy.BoundingBox();this.__points=[null,null];this.__className=options.className;this.__documentManager=options.documentManager;if(options.container){this.setContainer(options.container)}_gliffy.RenderLoop.appendTask(function(){if(self.__redraw&&self.__display!==null){self.__deferredDraw()}self.__redraw=false})},isVisible:function(){return this.__display.css("display")!=="none"},setClassName:function(className){if(this.__display&&this.__className){this.__display.removeClass(this.__className)}this.__className=className;if(this.isVisible()){this.draw()}},setContainer:function(container){this.__display=$("<div></div>");this.__display.css({display:"none"});container.append(this.__display)},getDiv:function(){return this.__display},isScreenDiagonalLessThan:function(value){value/=this.__documentManager.getZoom();return _gliffy.Vec2.squaredDistance(this.__points[0],this.__points[1])<value*value},setStartCorner:function(point){this.__points[0]=point;if(this.__points[1]===null){this.__points[1]=point}if(this.isVisible()){this.draw()}},setEndCorner:function(point){this.__points[1]=point;if(this.__points[0]===null){this.__points[0]=point}if(this.isVisible()){this.draw()}},getStartCorner:function(){return this.__points[0]},getEndCorner:function(){return this.__points[1]},getBoundingBox:function(){return this.__boundingBox},draw:function(){if(this.__points[0]!==null&&this.__points[1]!==null){this.__boundingBox.fitPoints(this.__points);this.__redraw=true}},hide:function(){this.__display.css({display:"none"});this.__redraw=false},drawBox:function(boundingBox){this.__boundingBox.copy(boundingBox);this.__redraw=true},__deferredDraw:function(){var css=_gliffy.Utils.boundingBoxToCss(this.__boundingBox,this.__documentManager.getZoom());css.display="block";this.__display.addClass(this.__className);this.__display.css(css)}})}());(function(){var moveThreshold=new _gliffy.MoveThreshold(),CLASS_NAME="gliffy-selector";_gliffy.Selector=_gliffy.Class.extend({__domSelector:null,__eventsRegistered:false,__documentManager:null,__overlayManager:null,__stageDiv:null,init:function(o){if(!o){throw new Error("Selector init needs options")}if(!o.documentManager){throw new Error("Selector init options needs stage manager")}if(!o.overlayManager){throw new Error("Selector init options needs overlay manager")}if(!o.stageDiv){throw new Error("Selector init options needs a stage div")}this.__stageDiv=o.stageDiv;this.__documentManager=o.documentManager;this.__overlayManager=o.overlayManager;this.registerState();_gliffy.Mouse.setState("none")},registerState:function(){var self=this,moved=false,pos,nodeAtPoint;_gliffy.Mouse.registerDragState([{modes:["none"],dragStart:function(event){moved=false;self.__stageDiv.setStartCorner(_gliffy.Mouse.getPosition());self.__stageDiv.setClassName(CLASS_NAME);moveThreshold.reset(event)},drag:function(event){moved=moveThreshold.above(event);if(moved){self.__stageDiv.setEndCorner(_gliffy.Mouse.getPosition());self.__stageDiv.draw()}},dragEnd:function(event){var node,selected=false,selectedNodes,selectedNode=self.__overlayManager.getSelectedNode();self.__stageDiv.hide();if(selectedNode&&(_gliffy.KeyManager.shiftKeyDown||_gliffy.KeyManager.metaCtrlKeyDown)){if(moved){selectedNodes=self.__overlayManager.getSelectedNodes();selectedNodes=selectedNodes.concat(_gliffy.Pick.pickAllNodesInside(self.__documentManager.getActiveStage().objects,self.__stageDiv.getBoundingBox(),{excludeUnpickableNodes:true}));selected=self.__overlayManager.selectNodes(selectedNodes);if(selected){GliffyApp.contextualPropertiesController.showControls(self.__overlayManager.getActiveOverlay())}}_gliffy.Mouse.resetMouseUpPosition()}else{if(moved){selected=self.__overlayManager.selectNodes(_gliffy.Pick.pickAllNodesInside(self.__documentManager.getActiveStage().objects,self.__stageDiv.getBoundingBox(),{excludeUnpickableNodes:true}));if(selected){GliffyApp.contextualPropertiesController.showControls(self.__overlayManager.getActiveOverlay());_gliffy.Mouse.resetMouseUpPosition()}}else{pos=_gliffy.Mouse.getPosition();nodeAtPoint=_gliffy.Pick.getNodeAt(self.__documentManager.getActiveStage().objects,pos.x,pos.y,null,null,{excludeUnpickableNodes:true});if(nodeAtPoint&&nodeAtPoint.getLockPosition()){self.__overlayManager.selectNode(nodeAtPoint);GliffyApp.contextualPropertiesController.showControls(self.__overlayManager.getActiveOverlay());_gliffy.Mouse.resetMouseUpPosition()}}}},autoPan:true},{modes:["styleCopy"],dragStart:function(event){GliffyApp.styleCopyController.dragStart(event,self.__stageDiv,moveThreshold,CLASS_NAME)},drag:function(event){GliffyApp.styleCopyController.drag(event,moveThreshold)},dragEnd:function(){GliffyApp.styleCopyController.dragEnd()}}])}})}());(function(){_gliffy.AbstractOverlay=_gliffy.Class.extend({__editor:null,__container:null,__documentManager:null,__overlayContainer:null,__overlayOutline:null,__eventsRegistered:false,__targetNode:null,__manager:null,init:function(o){if(!o){throw new Error(this.__CLASS_NAME+" init needs options")}if(!o.documentManager){throw new Error(this.__CLASS_NAME+" init options needs documentManager")}if(!o.target){throw new Error(this.__CLASS_NAME+" init options needs target")}if(!o.editor){throw new Error(this.__CLASS_NAME+" init options needs editor")}if(!o.manager){throw new Error(this.__CLASS_NAME+" init options needs manager")}this.__manager=o.manager;this.__editor=o.editor;this.__documentManager=o.documentManager;this.__buildOverlayHTML();this.__container=o.target;this.registerEventListeners()},positionAndResize:function(o){var top,left,width,height,zoom=this.__editor.getDocumentManager().getActiveStage().getZoom(),node=o.node,container=o.container,padding=o.padding;top=node.getY()*zoom-padding;left=node.getX()*zoom-padding;width=node.getWidth()*zoom+(padding*2);height=node.getHeight()*zoom+(padding*2);container.width(width);container.height(height);container.css({top:top+"px",left:left+"px"})},detach:function(){if(this.__overlayContainer){this.__overlayContainer.detach()}},registerEventListeners:function(){throw new Error(this.__CLASS_NAME+".registerEventListeners needs to be overridden")},show:function(node,container){throw new Error(this.__CLASS_NAME+".show needs to be overridden")},hide:function(){throw new Error(this.__CLASS_NAME+".hide needs to be overridden")},__buildOverlayHTML:function(){throw new Error(this.__CLASS_NAME+".__buildOverlayHTML needs to be overridden")}})}());(function(){_gliffy.DrawingGuidesOverlayModule={_rotationalPositionOffset:null,showGivenDrawingGuides:function(guides){_.each(["x","y"],function(xOrY){_.each(guides[xOrY],function(guide){guide.node.showDrawingGuide(xOrY,guide.which)})})},hideAllDrawingGuides:function(options){var node,self,o=$.extend({},{redraw:true},options);self=this;if(self.__drawingGuides){_.each(["x","y"],function(xOrY){_.each(self.__drawingGuides[xOrY],function(guide){node=guide.node;if(node){node.hideGuides()}})})}if(o.redraw&&this.__documentManager){this.__documentManager.redraw()}},_getDrawingGuidesGivenNodes:function(visibleNodes,visibleDrawingGuides){var nodeGuides,selectedNode,self,visibleNodeIsGroupAndHasChildren;self=this;visibleDrawingGuides=visibleDrawingGuides||{x:[],y:[]};selectedNode=self.getSelectedNode();_.each(visibleNodes,function(visibleNode){visibleNodeIsGroupAndHasChildren=visibleNode.isGroup()&&visibleNode.children instanceof Array&&visibleNode.children.length>0;if(visibleNode!==selectedNode){if(visibleNode.supportsDrawingGuides()){nodeGuides=visibleNode.getDrawingGuides();_.each(nodeGuides.x,function(visibleDrawingGuidePosition,type){visibleDrawingGuides.x.push({node:visibleNode,position:visibleDrawingGuidePosition,which:type})});_.each(nodeGuides.y,function(guide,type){visibleDrawingGuides.y.push({node:visibleNode,position:guide,which:type})})}else{if(visibleNodeIsGroupAndHasChildren){self._getDrawingGuidesGivenNodes(visibleNode.children,visibleDrawingGuides)}}}});return visibleDrawingGuides},cacheDrawingGuidesInView:function(){var currentUserViewPort,drawingGuidesInView,nodesInView,selectedNodeBoundingBox;if(GliffyApp.documentModel.drawingGuides){currentUserViewPort=this.__documentManager.getActiveStageViewPort();nodesInView=_gliffy.Pick.pickAllNodesPartiallyInside(this.__documentManager.getActiveStage().objects,currentUserViewPort);drawingGuidesInView=this._getDrawingGuidesGivenNodes(nodesInView);this.__drawingGuides=_.mapValues(drawingGuidesInView,function(guides){return _.unique(guides,function(guide){return guide.position})})}this._rotationalPositionOffset={x:0,y:0};if(this.getSelectedNode()){selectedNodeBoundingBox=this.getSelectedNode().worldOverlayAabb;if(!selectedNodeBoundingBox.isZeroSize()){this._rotationalPositionOffset={x:selectedNodeBoundingBox.min.x-this.getTransX(),y:selectedNodeBoundingBox.min.y-this.getTransY()}}}},drawingGuides:function(inputCoords){var drawingGuides,deltaX,deltaY,overlayBoundingBox;overlayBoundingBox=this.getOverlayBoundingBoxWithoutControls();deltaX=inputCoords.x-this.getTransX();deltaY=inputCoords.y-this.getTransY();drawingGuides={x:{left:deltaX+overlayBoundingBox.min.x,center:deltaX+(overlayBoundingBox.max.x+overlayBoundingBox.min.x)/2,right:deltaX+overlayBoundingBox.max.x},y:{top:deltaY+overlayBoundingBox.min.y,middle:deltaY+(overlayBoundingBox.max.y+overlayBoundingBox.min.y)/2,bottom:deltaY+overlayBoundingBox.max.y}};return drawingGuides},closestGuides:function(overlayDrawingGuides){var closestGuides,distance,currentClosestDistance,self;self=this;closestGuides={x:[],y:[]};currentClosestDistance={x:10,y:10};_.each(self.__drawingGuides,function(xOrYGuides,xOrY){_.each(xOrYGuides,function(guide){_.each(overlayDrawingGuides[xOrY],function(selectedNodeDrawingGuide,selectedNodeDrawingGuideReference){distance=Math.abs(selectedNodeDrawingGuide-guide.position);if(_gliffy.Utils.floatEquals(distance,currentClosestDistance[xOrY])){guide.matchingSelectedNodeGuideReference=selectedNodeDrawingGuideReference;closestGuides[xOrY].push(guide)}else{if(distance-currentClosestDistance[xOrY]<0){currentClosestDistance[xOrY]=distance;guide.matchingSelectedNodeGuideReference=selectedNodeDrawingGuideReference;closestGuides[xOrY]=[guide]}}})})});return closestGuides},relevantGuidesForActiveControl:function(overlayDrawingGuides,anchors){var controlAngle,pi,rotation,drawingGuidesForAnchor,north,northEast,east,southEast,south,southWest,west,northWest;rotation=this.getRotation();pi=Math.PI;north=anchors.x===0.5&&anchors.y===1;northEast=anchors.x===0&&anchors.y===1;east=anchors.x===0&&anchors.y===0.5;southEast=anchors.x===0&&anchors.y===0;south=anchors.x===0.5&&anchors.y===0;southWest=anchors.x===1&&anchors.y===0;west=anchors.x===1&&anchors.y===0.5;northWest=anchors.x===1&&anchors.y===1;if(north){controlAngle=rotation+(0*pi/4)}else{if(northEast){controlAngle=rotation+(1*pi/4)}else{if(east){controlAngle=rotation+(2*pi/4)}else{if(southEast){controlAngle=rotation+(3*pi/4)}else{if(south){controlAngle=rotation+(4*pi/4)}else{if(southWest){controlAngle=rotation+(5*pi/4)}else{if(west){controlAngle=rotation+(6*pi/4)}else{if(northWest){controlAngle=rotation+(7*pi/4)}}}}}}}}drawingGuidesForAnchor={x:{},y:{}};if(Math.cos(controlAngle-0*pi/2)>0.001){drawingGuidesForAnchor.y.top=overlayDrawingGuides.y.top}if(Math.cos(controlAngle-1*pi/2)>0.001){drawingGuidesForAnchor.x.right=overlayDrawingGuides.x.right}if(Math.cos(controlAngle-2*pi/2)>0.001){drawingGuidesForAnchor.y.bottom=overlayDrawingGuides.y.bottom}if(Math.cos(controlAngle-3*pi/2)>0.001){drawingGuidesForAnchor.x.left=overlayDrawingGuides.x.left}return drawingGuidesForAnchor},_applyDrawingGuidesForTrans:function(x,y){var overlayDrawingGuides,originalCoords,closestGuides,firstGuide,firstGuideReference,guidePositionRelativeToOrigin,rotationalPositionOffset,selectedNode,selectedNodeBoundingBox,trans;this.hideAllDrawingGuides({redraw:false});overlayDrawingGuides=this.drawingGuides({x:x,y:y});closestGuides=this.closestGuides(overlayDrawingGuides);selectedNode=this.getSelectedNode();originalCoords=this.drawingGuides({x:this.getTransX(),y:this.getTransY()});selectedNodeBoundingBox=selectedNode.worldOverlayAabb.clone();trans={x:x,y:y};_.each(["x","y"],function(xOrY){if(closestGuides[xOrY].length>0){rotationalPositionOffset=this._rotationalPositionOffset[xOrY];firstGuide=closestGuides[xOrY][0];firstGuideReference=firstGuide.matchingSelectedNodeGuideReference;guidePositionRelativeToOrigin=originalCoords[xOrY][firstGuideReference]-originalCoords[xOrY][xOrY==="x"?"left":"top"];trans[xOrY]=(firstGuide.position-guidePositionRelativeToOrigin-rotationalPositionOffset);closestGuides[xOrY]=_.filter(closestGuides[xOrY],function(guide){return guide.node===firstGuide.node})}},this);this.showGivenDrawingGuides(closestGuides);this.setTransX(trans.x);this.setTransY(trans.y)},_applyDrawingGuidesForScale:function(bb,anchors,originalSize){var closestGuides,scaleOffsets,overlayDrawingGuides,relevantGuides,rotatedSizeOffsets;this.hideAllDrawingGuides({redraw:false});overlayDrawingGuides=this.drawingGuides({x:this.getTransX(),y:this.getTransY()});relevantGuides=this.relevantGuidesForActiveControl(overlayDrawingGuides,anchors);closestGuides=this.closestGuides(relevantGuides);_.each(["x","y"],function(xOrY){var firstNode;if(closestGuides[xOrY].length>0){firstNode=closestGuides[xOrY][0].node;closestGuides[xOrY]=_.filter(closestGuides[xOrY],function(guide){return guide.node===firstNode})}});this.showGivenDrawingGuides(closestGuides);scaleOffsets=this._scaleOffsetsForClosestGuides(closestGuides,relevantGuides);rotatedSizeOffsets=this._rotateScaleOffsets(scaleOffsets,anchors);rotatedSizeOffsets=_.mapValues(rotatedSizeOffsets,function(offset){return Math.round(offset)});if(_.any(rotatedSizeOffsets)){this.__doScale(-rotatedSizeOffsets.x,-rotatedSizeOffsets.y,anchors.x,anchors.y,15,15,originalSize,{dontRecursePlease:true})}},_rotateScaleOffsets:function(sizeOffsets,anchors){var notModifiyingX,notModifiyingY,overlayRotation,orientationStandard,orientationOrthogonal,rotatedScaleOffsets,rotationMatrix;overlayRotation=this.getRotation();rotationMatrix=_gliffy.AffineTransform.getRotateInstance(-overlayRotation,0,0);rotatedScaleOffsets=rotationMatrix.transformPoint(sizeOffsets.x,sizeOffsets.y);orientationStandard=this.orientationStandard();orientationOrthogonal=this.orientationOrthogonal();notModifiyingX=anchors.x===0.5;notModifiyingY=anchors.y===0.5;if(notModifiyingX){if(sizeOffsets.y&&!orientationStandard){rotatedScaleOffsets.y=sizeOffsets.y/Math.cos(-overlayRotation)}else{if(sizeOffsets.x&&!orientationOrthogonal){rotatedScaleOffsets.y=sizeOffsets.x/Math.sin(-overlayRotation)}}}if(notModifiyingY){if(sizeOffsets.x&&!orientationStandard){rotatedScaleOffsets.x=sizeOffsets.x/Math.cos(overlayRotation)}else{if(sizeOffsets.y&&!orientationOrthogonal){rotatedScaleOffsets.x=sizeOffsets.y/Math.sin(overlayRotation)}}}return rotatedScaleOffsets},_scaleOffsetsForClosestGuides:function(closestGuides,overlayDrawingGuides){var closestGuideX,closestGuideY,scaleOffsets;scaleOffsets={};closestGuideX=closestGuides.x[0];closestGuideY=closestGuides.y[0];scaleOffsets.x=this.scaleOffsetForClosestGuide(closestGuideX,overlayDrawingGuides,"x");scaleOffsets.y=this.scaleOffsetForClosestGuide(closestGuideY,overlayDrawingGuides,"y");return scaleOffsets},scaleOffsetForClosestGuide:function(closestGuide,overlayDrawingGuides,xOrY){var closestGuidePosition,closestGuideReference;if(!closestGuide){return 0}closestGuideReference=closestGuide.matchingSelectedNodeGuideReference;closestGuidePosition=closestGuide.position;return overlayDrawingGuides[xOrY][closestGuideReference]-closestGuidePosition},orientationStandard:function(){return _gliffy.Utils.floatEquals(Math.sin(this.getRotation()),0)},orientationOrthogonal:function(){return _gliffy.Utils.floatEquals(Math.cos(this.getRotation()),0)}}}());(function(){var RESIZE_CURSORS=["nw-resize","n-resize","ne-resize","e-resize","se-resize","s-resize","sw-resize","w-resize"],CLOCKWISE_CONTROL_POINTS=[0,1,2,5,8,7,6,3],ROTATION_CONTROL_OFFSET=25,ROTATION_HANDLE_SIZE=8,PADDING=2;_gliffy.Overlay=_gliffy.Class.extend($.extend({},_gliffy.DrawingGuidesOverlayModule,{__overlayContainer:null,__overlayControl:null,__overlayControlLane:null,__rotateControl:null,__rotateHandle:null,__overlayOutline:null,__overlayedNode:null,__container:null,__manager:null,__MIN_DIMENSIONS:{x:15,y:15},__snapPixels:10,__rotation:0,__scaleX:1,__scaleY:1,__transX:0,__transY:0,__laneCommand:null,__overlayCoords:null,__active:false,__eventsRegistered:false,__textControl:null,__dragOffset:new _gliffy.Vec2(0,0),__documentManager:null,__redraw:false,__redrawHud:false,__redrawModel:false,__popCommandBundle:false,__modifyLines:null,__contextMenu:null,__drawingGuides:[],__isStyleCopied:false,isDragging:false,init:function(o){var self=this,i,j,idx=0,oc,x,y,hud,linkHud;if(!o){throw new Error("overlay init needs options")}if(!o.documentManager){throw new Error("overlay init options needs documentManager")}if(!o.textControl){throw new Error("overlay init options needs textControl")}if(!o.manager){throw new Error("overlay init options needs manager")}this.__manager=o.manager;this.__documentManager=o.documentManager;this.__textControl=o.textControl;this.__overlayContainer=$('<div id="gliffy-overlay" />');this.__overlayContainer.css("display","none");this.__overlayOutline=$('<div class="gliffy-overlay-outline"/>');if($.browser.msie){this.__overlayOutline.css("background-color","rgba(255,255,255,0)")}_gliffy.CursorManager.setCursor("move",this.__overlayOutline);this.__overlayContainer.append(this.__overlayOutline);this.__overlayControl=[];for(i=0;i<9;i++){this.__overlayControl[i]=$('<div class="gliffy-overlay-control"/>');this.__overlayOutline.append(this.__overlayControl[i])}this.__overlayControlLane=[];for(i=0;i<11;i++){this.__overlayControlLane[i]=$("<div/>",{"class":"gliffy-overlay-control-lane lane-"+i});this.__overlayOutline.append(this.__overlayControlLane[i])}this.__rotateControl=$('<div class="gliffy-overlay-rotate gliffy-icon-overlay-rotate" />');_gliffy.CursorManager.setCursor("rotate",this.__rotateControl);this.__overlayOutline.append(this.__rotateControl);this.__rotateHandle=$('<div class="gliffy-overlay-rotate-handle" />');this.__overlayOutline.append(this.__rotateHandle);hud=$('<div id="gliffy-hud"></div>');this.__overlayContainer.append(hud);linkHud=$('<div id="gliffy-link-hud" title="'+$.i18n._("LINKHUD_HINT")+'"></div>');$(".gliffy-stage").append(linkHud);GliffyApp.contextMenuController.createContextMenu(this,"#gliffy-overlay",this.getContextMenuDefinition(),"gliffy-context-menu-overlay");$(this.__overlayContainer).mousedown(function(e){if(!e.shiftKey){self.__manager.getContainer().trigger("gliffy-overlay-overlaycontainer-mousedown");return}else{self.__manager.getContainer().trigger("gliffy-overlay-overlaycontainer-mousedown-shift")}});for(j=0;j<3;j++){for(i=0;i<3;i++){oc=this.__overlayControl[idx];x=i*0.5;y=j*0.5;oc.css({top:(y*100)+"%",left:(x*100)+"%"});oc.data("overlayCoords",{x:x,y:y});idx++}}this.__rotateControl.data("overlayCoords",{x:0.5,y:1.5});this.__overlayOutline.data("overlayCoords",{x:0.5,y:0.5});this.__rotateControl.css({top:"-"+ROTATION_CONTROL_OFFSET+"px",left:"50%"});this.__overlayControl[4].addClass("gliffy-overlay-control-center");this.__snapPixels=_gliffy.Utils.SNAP_PIXELS;_gliffy.RenderLoop.appendTask(function(){if(self.__redraw){self.__deferredDrawOverlay()}self.__redraw=false});this.__setupControlDragManager();if(_gliffy.BrowserDetect.browser==="Explorer"){this.__rotateHandle.css("z-index",10000)}},getMinDimensions:function(){var minHeight,minWidth,selectedNodes;minWidth=this.__MIN_DIMENSIONS.x;minHeight=this.__MIN_DIMENSIONS.y;selectedNodes=this.getTopLevelSelectedNodes();$.each(selectedNodes,function(i,node){minWidth=Math.max(minWidth,node.getMinWidth());minHeight=Math.max(minHeight,node.getMinHeight())});return{x:minWidth,y:minHeight}},__setupControlDragManager:function(){var self=this,minDragSize,originalMousePosition,originalSize,$this;_gliffy.Mouse.registerClickState({name:"overlay",modes:["shape-rotate","shape-resize","shape-overlay","lane-resize"],target:".gliffy-overlay-control,.gliffy-overlay-rotate,.gliffy-overlay-outline,.gliffy-overlay-control-lane",mouseDown:function(event){var pos=_gliffy.Mouse.getPosition(),selectedNode,overlayedNode;event.stopPropagation();_gliffy.Mouse.setClickMode("overlay");$this=$(event.currentTarget);overlayedNode=self.getSelectedNode();if($this.hasClass("gliffy-overlay-rotate")){_gliffy.Mouse.setState("shape-rotate")}else{if($this.hasClass("gliffy-overlay-control")&&!($this.hasClass("gliffy-overlay-control-center"))){_gliffy.Mouse.setState("shape-resize")}else{if($this.hasClass("gliffy-overlay-control-lane")){_gliffy.Mouse.setState("lane-resize")}else{if(overlayedNode&&self.__lastTarget===overlayedNode.getId()){self.__lastTarget=null;self.makeTextEditable();return}else{_gliffy.Mouse.setState("shape-overlay");self.__setLastTarget()}}}}_gliffy.Mouse.__mousedown(event)}});_gliffy.Mouse.registerDragState([{modes:["shape-rotate"],dragStart:function(event){_gliffy.Mouse.setCursor("rotate");self.__documentManager.pushCommandBundle();self.__storeState();GliffyApp.contextualPropertiesController.hideControls();GliffyApp.hudController.show(GliffyApp.hudController.HUD_MODE.rot);$this=$(event.currentTarget);$this.data("overlaySpace",self.__getOverlaySpace());$this.data("initRotation",self.getRotation());self.__manager.getContainer().trigger("gliffy-overlay-shape-rotate-dragStart")},drag:function(event){var x,y,angle,deg,pos,nodeCenter,selectedNode;pos=_gliffy.Mouse.getPosition();selectedNode=self.getSelectedNode();if(selectedNode){nodeCenter=selectedNode.getCenterPosition();x=pos.x;y=pos.y;x-=nodeCenter.x;y-=nodeCenter.y;angle=Math.atan2(y,x)+Math.PI/2;deg=_gliffy.Utils.radiansToDegrees(angle);if(event&&!event.shiftKey){deg=deg+7.5-_gliffy.Utils.posMod(deg+7.5,15)}self.setRotation(_gliffy.Utils.degreesToRadians(deg));self.__drawOverlay();self.__updateHud()}},dragEnd:function(event){GliffyApp.hudController.hide();GliffyApp.contextualPropertiesController.showControls(self);self.__applyState();self.__documentManager.popCommandBundle();self.__manager.getContainer().trigger("gliffy-overlay-shape-rotate-dragEnd")}},{modes:["shape-resize"],dragStart:function(event){var selected,i,child;$this=$(event.currentTarget);self.__documentManager.pushCommandBundle();self.__storeState();GliffyApp.contextualPropertiesController.hideControls();GliffyApp.hudController.show(GliffyApp.hudController.HUD_MODE.size);self.updateDragOffset();originalMousePosition=_gliffy.Mouse.getPosition();originalSize={x:self.getScaleX(),y:self.getScaleY()};if(self&&self.getSelectedNode()&&!self.getSelectedNode().getLockPosition()){_gliffy.Mouse.setCursor(_gliffy.CursorManager.getCursorName($this))}self.__overlayCoords=$this.data("overlayCoords");self.cacheDrawingGuidesInView();minDragSize=self.getMinDimensions();selected=self.getSelectedNode();if((selected.isGroup()||selected.isSelection())&&!selected.isOnlyNodeOnTheStage()){for(i=0;i<selected.children.length;i++){child=selected.children[i];if(!(child.isText()||child.isLine())){if(child.getWidth()>0&&child.getHeight()>0){minDragSize.x=Math.max(minDragSize.x,self.__MIN_DIMENSIONS.x/child.getWidth()*selected.getWidth());minDragSize.y=Math.max(minDragSize.y,self.__MIN_DIMENSIONS.y/child.getHeight()*selected.getHeight())}}}}self.__manager.getContainer().trigger("gliffy-overlay-shape-resize-dragStart")},drag:function(){var mousePositionDelta,node,positionDeltaInRotatedSpace,rotationTransform;node=self.getSelectedNode();if(self.__active&&node&&!node.getLockPosition()){self.__overlayCoords=$this.data("overlayCoords");mousePositionDelta=_gliffy.Vec2.difference(_gliffy.Mouse.getPosition(),originalMousePosition);rotationTransform=_gliffy.AffineTransform.getRotateInstance(-self.__rotation,0,0);positionDeltaInRotatedSpace=rotationTransform.transformPoint(mousePositionDelta.x,mousePositionDelta.y);self.__doScale(positionDeltaInRotatedSpace.x,positionDeltaInRotatedSpace.y,1-self.__overlayCoords.x,1-self.__overlayCoords.y,minDragSize.x,minDragSize.y,originalSize);self.isDragging=true;self.__drawOverlay();self.__updateHud();self.updateRotationControl()}},dragEnd:function(event){var selectedNode=self.getSelectedNode(),swimlanes,children,isGroup,images,i;this.__overlayCoords=null;GliffyApp.hudController.hide();self.isDragging=false;GliffyApp.contextualPropertiesController.showControls(self);self.__applyState();images=[];if(selectedNode){images=selectedNode.findGraphic(_gliffy.Image);for(i=0;i<images.length;i++){images[i].setFlag("skin");images[i].markDirty()}}if(selectedNode&&(selectedNode.isSelection()||selectedNode.isGroup()||selectedNode.isTable())){children=selectedNode.children;isGroup=selectedNode.isGroup();if(selectedNode.immediateChildrenHaveMixedRotation()){children=children.slice();if(isGroup){self.__manager.ungroupifyGroup()}self.__manager.deselectAll();self.__manager.selectNodes(children);if(isGroup){self.__manager.groupifySelection()}GliffyApp.contextualPropertiesController.showControls(self)}swimlanes=selectedNode.findUidFunction(function(uid){return uid&&uid.indexOf("com.gliffy.shape.swimlanes")===0});self.__documentManager.addAndExecuteCommand(new _gliffy.CleanSwimlanePositions({nodes:swimlanes}));self.__documentManager.redraw()}self.__documentManager.popCommandBundle();self.hideAllDrawingGuides();self.refresh();self.__manager.getContainer().trigger("gliffy-overlay-shape-resize-dragEnd")},autoPan:true},{modes:["shape-overlay"],dragStart:function(event){self.cacheDrawingGuidesInView();if(self&&!self.getLockPosition()){_gliffy.Mouse.setCursor("move");self.hideControls();GliffyApp.contextualPropertiesController.hideControls();GliffyApp.hudController.show(GliffyApp.hudController.HUD_MODE.pos);self.__manager.getContainer().trigger("gliffy-overlay-shape-overlay-dragStart")}self.__documentManager.pushCommandBundle();self.updateDragOffset()},drag:function(event){if(self&&!self.getLockPosition()){self.__outlineDrag();GliffyApp.hudController.show(GliffyApp.hudController.HUD_MODE.pos);self.isDragging=true}},dragEnd:function(event,didDrag,beginInitialDrag){self.isDragging=false;var pos,lastSelectedNode,selectedNode,selectedNode2,selectedNodeLength,selectList=[],i,objects;self.hideAllDrawingGuides();GliffyApp.hudController.hide();self.__documentManager.popCommandBundle();lastSelectedNode=self.getSelectedNode();pos=_gliffy.Mouse.getPosition();if(lastSelectedNode&&lastSelectedNode.isSelection()){selectedNode=_gliffy.Pick.getNodeAt(lastSelectedNode.flattenChildren(),pos.x,pos.y);objects=[].concat(self.__documentManager.getActiveStage().objects);objects=$.grep(objects,function(item){return item.getId()!==lastSelectedNode.getId()});selectedNode2=_gliffy.Pick.getNodeAt(objects,pos.x,pos.y);if(!selectedNode||(selectedNode2&&selectedNode.getOrder()<selectedNode2.getOrder())){selectedNode=selectedNode2}}else{selectedNode=_gliffy.Pick.getNodeAt(self.__documentManager.getActiveStage().objects,pos.x,pos.y)}if(!didDrag&&lastSelectedNode&&lastSelectedNode.isSwimlane()&&lastSelectedNode!==selectedNode){self.__manager.deselectAll();if(selectedNode){self.__manager.selectNode(selectedNode);GliffyApp.contextualPropertiesController.showControls(self)}}else{if(!didDrag&&lastSelectedNode&&lastSelectedNode.isSelection()&&(_gliffy.KeyManager.shiftKeyDown||_gliffy.KeyManager.metaCtrlKeyDown)&&selectedNode&&!beginInitialDrag){if(selectedNode){selectedNodeLength=lastSelectedNode.children?lastSelectedNode.children.length:0;for(i=0;i<selectedNodeLength;i++){if(lastSelectedNode.children[i].getId()!==selectedNode.getId()){selectList.push(lastSelectedNode.children[i])}}if(selectList.length===lastSelectedNode.children.length){selectList.push(selectedNode)}self.__manager.deselectAll();self.__manager.selectNodes(selectList);GliffyApp.contextualPropertiesController.showControls(self)}}else{if(!didDrag&&lastSelectedNode&&lastSelectedNode.isSelection()&&!(_gliffy.KeyManager.shiftKeyDown||_gliffy.KeyManager.metaCtrlKeyDown)){self.__manager.deselectAll();if(selectedNode){self.__manager.selectNode(selectedNode);self.showControls();GliffyApp.contextualPropertiesController.showControls(self)}}else{if(!didDrag&&lastSelectedNode&&lastSelectedNode.isGroup()){if(!(_gliffy.KeyManager.shiftKeyDown||_gliffy.KeyManager.metaCtrlKeyDown)){if(selectedNode&&selectedNode.closestGroup()!==lastSelectedNode){self.__manager.selectNode(selectedNode)}else{if(!selectedNode){self.__manager.deselectAll()}}}else{if(selectedNode&&selectedNode.getId()!==lastSelectedNode.getId()){self.__manager.deselectAll();self.__manager.selectNodes([lastSelectedNode,selectedNode])}}self.showControls();GliffyApp.contextualPropertiesController.showControls(self)}else{if(!didDrag&&lastSelectedNode&&selectedNode&&!lastSelectedNode.isSelection()&&!selectedNode.getLayerLocked()){self.__manager.selectNode(selectedNode);self.showControls();GliffyApp.contextualPropertiesController.showControls(self)}else{self.showControls();GliffyApp.contextualPropertiesController.showControls(self)}}}}}self.__documentManager.redraw();self.__manager.getContainer().trigger("gliffy-overlay-shape-overlay-dragEnd")},autoPan:true},{modes:["lane-resize"],dragStart:function(event){self.__documentManager.pushCommandBundle()},drag:function(event){var stage=self.__documentManager.getActiveStage(),data=$this.data("lane");self.__laneCommand=new _gliffy.UpdateLaneCommand({selectedNode:self.getSelectedNode(),node:stage.find(data.nodeId),sibling:stage.find(data.sibling),nextSibling:stage.find(data.nextSibling),mousePosition:_gliffy.Mouse.getPosition()});self.__drawOverlay()},dragEnd:function(event){self.__documentManager.popCommandBundle()}}])},updateDragOffset:function(){if(this.getSelectedNode()){this.__dragOffset=_gliffy.Vec2.difference(_gliffy.Mouse.getPosition(),this.getSelectedNode().getPosition())}},__setLastTarget:function(){var self=this;this.__lastTarget=this.getSelectedNode().getId();setTimeout(function(){self.__lastTarget=null},this.getManager().getDoubleClickTimeout())},detach:function(){this.__overlayContainer.detach()},__outlineDrag:function(){if(!this.__active||!this.getSelectedNode()||this.getSelectedNode().getLockPosition()){return}var pos=_gliffy.Vec2.difference(_gliffy.Mouse.getPosition(),this.__dragOffset);this.setTrans(pos.x,pos.y,true)},getLaneCommand:function(){return this.__laneCommand},getTransX:function(){return this.__transX},setTransX:function(transX){this.__transX=transX;this.__drawOverlay();this.__redrawModel=true},getTransY:function(){return this.__transY},setTransY:function(transY){this.__transY=transY;this.__drawOverlay()},setTrans:function(x,y,bSnap){if(bSnap&&this.isSnapEnabled()){x=x-x%this.__snapPixels;y=y-y%this.__snapPixels}if(GliffyApp.documentModel.drawingGuides&&this.getSelectedNode()){if(_gliffy.Mouse.getVelocity()<1500){this._applyDrawingGuidesForTrans(x,y)}else{this.__transX=x;this.__transY=y;$(".gliffy-drawing-guide").remove()}}else{this.__transX=x;this.__transY=y}this.__drawOverlay()},getScaleX:function(){return this.__scaleX},setScaleX:function(scaleX){if(this.__scaleX!==scaleX){if(this.getLockAspectRatio()){this.__scaleY=(this.__scaleY*scaleX/this.__scaleX)}this.__scaleX=scaleX;this.__drawOverlay()}},getScaleY:function(){return this.__scaleY},setScaleY:function(scaleY){if(this.__scaleY!==scaleY){if(this.getLockAspectRatio()){this.__scaleX=(this.__scaleX*scaleY/this.__scaleY)}this.__scaleY=scaleY;this.__drawOverlay()}},setSnapePixels:function(snapPixels){this.__snapPixels=snapPixels},getSnapePixels:function(){return this.__snapPixels},getRotation:function(){return this.__rotation},setRotation:function(rotation){this.__rotation=rotation;this.__drawOverlay()},__updateHud:function(){if(_gliffy.Debug.SKIP_RENDER_LOOP){GliffyApp.hudController.update()}else{this.__redrawHud=true}},__updateModel:function(){if(_gliffy.Debug.SKIP_RENDER_LOOP){GliffyApp.overlayModel.update(this)}else{this.__redrawModel=true}},beginInitialDrag:function(){var self=this,overlayedNode;overlayedNode=self.getSelectedNode();if(overlayedNode){_gliffy.Mouse.setDragLockTimeout(setTimeout(function(){_gliffy.Mouse.clearDragLockTimeout()},100));this.updateDragOffset();if(self.__lastTarget===overlayedNode.getId()){self.__lastTarget=null;self.makeTextEditable()}else{self.cacheDrawingGuidesInView();this.__setLastTarget();if(!this.getLockPosition()){_gliffy.Mouse.lockDragUI("move");self.hideControls();GliffyApp.contextualPropertiesController.hideControls();GliffyApp.hudController.show(GliffyApp.hudController.HUD_MODE.pos);self.__manager.getContainer().trigger("gliffy-overlay-shape-overlay-dragStart")}_gliffy.Mouse.beginInitialDrag("overlay","shape-overlay")}}},getOverlayBoundingBox:function(){var node=this.getSelectedNode(),boundingBox,rotateHandle,rotateHandleOffset,rotateControlOffset;node.update();boundingBox=node.worldAabb.clone();rotateHandleOffset=ROTATION_HANDLE_SIZE/this.getZoom();rotateControlOffset=-(ROTATION_CONTROL_OFFSET+ROTATION_HANDLE_SIZE)/this.getZoom();rotateHandle=node.worldTransform.transformPoint(node.getWidth()/2+rotateHandleOffset,rotateControlOffset);boundingBox.grow(rotateHandle.x,rotateHandle.y);rotateHandle=node.worldTransform.transformPoint(node.getWidth()/2-rotateHandleOffset,rotateControlOffset);boundingBox.grow(rotateHandle.x,rotateHandle.y);return boundingBox},getOverlayBoundingBoxWithoutControls:function(){var boundingBox,overlaySpace,topLeft,topRight,bottomLeft,bottomRight;overlaySpace=this.__getOverlaySpace();topLeft=overlaySpace.transformPoint(0,0);topRight=overlaySpace.transformPoint(1,0);bottomLeft=overlaySpace.transformPoint(0,1);bottomRight=overlaySpace.transformPoint(1,1);boundingBox=new _gliffy.BoundingBox();boundingBox.min.x=Math.min(topLeft.x,topRight.x,bottomLeft.x,bottomRight.x)/this.getZoom();boundingBox.max.x=Math.max(topLeft.x,topRight.x,bottomLeft.x,bottomRight.x)/this.getZoom();boundingBox.min.y=Math.min(topLeft.y,topRight.y,bottomLeft.y,bottomRight.y)/this.getZoom();boundingBox.max.y=Math.max(topLeft.y,topRight.y,bottomLeft.y,bottomRight.y)/this.getZoom();return boundingBox},__setupTextGraphic:function(parent){var node=new _gliffy.Node(),parentGraphic=parent.getGraphic(),textGraphic=new _gliffy.Text(),defaultText;defaultText=parentGraphic.node.getDefaultTextGraphic();if(defaultText){textGraphic.fromObject(defaultText.toObject())}else{this.__setupTextDefaults(parent,node,textGraphic)}node.setWidth(parent.getWidth()-PADDING*2);node.setHeight(parent.getHeight());node.setX(PADDING);node.setGraphic(textGraphic);node.setOrder("auto");node.setUid(null);this.__documentManager.addAndExecuteCommand(new _gliffy.AddNodeCommand({node:node,target:parent,prepend:true}));node.markDirty();return node},__setupTextDefaults:function(parent,node,text){var defaultTextStyle=null,themeType;if(parent.getShapeInformation()&&parent.getShapeInformation().defaults){if(parent.getShapeInformation().defaults.default_text_style){defaultTextStyle=parent.getShapeInformation().defaults.default_text_style}themeType=parent.getShapeInformation().defaults.themeType}text.setupDefaults(defaultTextStyle);text.setHTML(this.__documentManager.applyTextDefaults(text.getHTML(),themeType));node.setDefaultTextGraphic(text)},editText:function(textNode,event){var self=this,textGraphic=textNode.getGraphic();self.__documentManager.redraw(function(){textGraphic.editable.setEditMode(true);textGraphic.editable.focus();if((event!==null&&event!==undefined)){textGraphic.editable.setKeyEvent(event)}else{textGraphic.editable.setCursorEnd()}self.__textControl.edit(textGraphic);textGraphic.editable.registerBlurHandler(function(){GliffyApp.contextualPropertiesController.blurRTE(self);textGraphic.editable.setEditMode(false);self.__documentManager.redraw()})})},__getFirstTextChild:function(node){var children=node.flattenChildren(),i;for(i=0;i<children.length;i++){if(children[i].isTextChild()){return children[i]}}return null},makeTextEditable:function(event){var self=this,node=self.getSelectedNode(),textChildren,position=_gliffy.Mouse.getPosition(),children,i,child,selectedChildren,j,pickData,textChild=null;if(node){if(node.isGroup()||node.isSelection()){children=node.flattenChildren();if(event){for(i=0;i<children.length;i++){if(children[i].isShape()||children[i].isMultipartShape()||children[i].isLine()||children[i].isImage()||children[i].isSvg()||children[i].isStandAloneText()){node=children[i];break}}}else{pickData=_gliffy.Pick.getNodeAtExt(node.flattenChildren(),position.x,position.y,{doNotIncludeGroup:true});node=pickData.node;textChild=pickData.textChild}}if(node){if(node.isTable()){self.__manager.tableOverlay.makeTextEditable(event,node)}else{if(node.isMultipartShape()){children=node.flattenChildren();if(!event){selectedChildren=_gliffy.Pick.pickAllNodesAt(children,position.x,position.y,0);child=null;if(selectedChildren.length>0){child=self.__getFirstTextChild(selectedChildren[0])}if(!child){child=_gliffy.Pick.pickFirstTextChildNode(children,position.x,position.y)}if(!child){child=self.__getFirstTextChild(node)}}else{child=self.__getFirstTextChild(node)}if(child){self.editText(child,event)}}else{if(node.isLine()){self.__manager.lineOverlay.makeTextEditable({keyEvent:event,node:node,createNew:textChild===null,textChild:textChild})}else{if(node.isShape()||node.isImage()||node.isSvg()){textChildren=node.findGraphic(_gliffy.Text);for(j=1;j<textChildren.length;j++){new _gliffy.RemoveNodeCommand({node:textChildren[j]}).execute(this.__documentManager.getActiveStage())}if(textChildren.length===0){child=self.__setupTextGraphic(node)}else{child=textChildren[0]}self.editText(child,event)}else{if(node.isStandAloneText()){self.editText(node,event)}}}}}GliffyApp.overlayModel.update(self);if(!node.isTable()){self.__manager.deselectAll()}_gliffy.KeyManager.setState("rte");GliffyApp.contextualPropertiesController.showControls(this);self.hideAllDrawingGuides()}}},__registerEvents:function(){var self=this;_gliffy.KeyManager.registerState("overlaySelected","default",[{action:"delete",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.doDelete()}},{action:"cut",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.doCut()}},{action:"copy",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.doCopy()}},{action:"paste",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.doPaste()}},{action:"nudgeLeft",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.__nudge(true,true);GliffyApp.contextualPropertiesController.hideControls(self)},keyup:function(ev){GliffyApp.contextualPropertiesController.showControls(self)}},{action:"nudgeRight",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.__nudge(true,false);GliffyApp.contextualPropertiesController.hideControls(self)},keyup:function(ev){GliffyApp.contextualPropertiesController.showControls(self)}},{action:"nudgeUp",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.__nudge(false,true);GliffyApp.contextualPropertiesController.hideControls(self)},keyup:function(ev){GliffyApp.contextualPropertiesController.showControls(self)}},{action:"nudgeDown",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.__nudge(false,false);GliffyApp.contextualPropertiesController.hideControls(self)},keyup:function(ev){GliffyApp.contextualPropertiesController.showControls(self)}},{action:"enterRTE",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.makeTextEditable()}},{action:"group",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();GliffyApp.toolbarController.doGroup();return false},keypress:function(ev){return false},keyup:function(ev){return false}},{action:"ungroup",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();GliffyApp.toolbarController.doUnGroup();return false},keypress:function(ev){return false},keyup:function(ev){return false}},{action:"sendFront",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();if(!GliffyApp.layersController.multipleLayersActive){GliffyApp.toolbarController.doBringToFront()}return false},keypress:function(ev){return false},keyup:function(ev){return false}},{action:"sendBack",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();if(!GliffyApp.layersController.multipleLayersActive){GliffyApp.toolbarController.doSendToBack()}return false},keypress:function(ev){return false},keyup:function(ev){return false}},{action:"jumpStageLeft",keydown:function(e){e.stopImmediatePropagation();e.preventDefault()}},{action:"jumpStageRight",keydown:function(e){e.stopImmediatePropagation();e.preventDefault()}},{action:"jumpStageUp",keydown:function(e){e.stopImmediatePropagation();e.preventDefault()}},{action:"jumpStageDown",keydown:function(e){e.stopImmediatePropagation();e.preventDefault()}},{keypress:function(ev){if(!_gliffy.KeyManager.isControlKey(ev)&&self.isActive()){ev.stopImmediatePropagation();self.makeTextEditable(ev)}}}]);this.__eventsRegistered=true},__nudge:function(xAxis,negative){var nudge,viewPort=this.__documentManager.getActiveStageViewPort(),viewportDimension,node=this.getSelectedNode();if(this&&this.getLockPosition()){return}nudge=this.__getNudgeAmount();if(negative){nudge*=-1}if(xAxis){this.setTransX(this.getTransX()+nudge)}else{this.setTransY(this.getTransY()+nudge)}if(node){if(xAxis){if(viewPort.max.x<node.worldAabb.max.x+nudge*2||(negative&&viewPort.min.x>node.worldAabb.min.x+nudge*2)){viewportDimension=viewPort.getDimension();this.__documentManager.getActiveStage().offsetPan(-nudge,0,viewportDimension.x,viewportDimension.y)}}else{if(viewPort.max.y<node.worldAabb.max.y+nudge*2||(negative&&viewPort.min.y>node.worldAabb.min.y+nudge*2)){viewportDimension=viewPort.getDimension();this.__documentManager.getActiveStage().offsetPan(0,-nudge,viewportDimension.x,viewportDimension.y)}}}_gliffy.Mouse.updateOffset();this.__redrawModel=true},__getNudgeAmount:function(){return this.isSnapEnabled()?this.__snapPixels:1},setActive:function(active){this.__active=active;this.deselect()},isSnapEnabled:function(){return _gliffy.Utils.shouldSnapToGrid()},getLockAspectRatio:function(){return this.getSelectedNode()?this.getSelectedNode().getLockAspectRatio():false},getLockPosition:function(){return this.getSelectedNode()?this.getSelectedNode().getLockPosition():false},updateResizeControls:function(){if(this&&this.getLockPosition()){this.__overlayContainer.addClass("resize gliffy-overlay-lock")}else{if(this.isResizable()){this.__overlayContainer.addClass("resize");this.__overlayContainer.removeClass("gliffy-overlay-lock")}else{this.__overlayContainer.removeClass("resize gliffy-overlay-lock")}}},updateRotationControl:function(){var halfWayPoint,leftSideOffset,node,rightSideOffset,rotationControlOffset,text,textHeight,textNode,textNodeOffsets;rotationControlOffset=ROTATION_CONTROL_OFFSET;node=this.getSelectedNode();if(node instanceof _gliffy.Node){textNode=node.getFirstTopLevelNodeWithGraphic(_gliffy.Text);if(textNode&&textNode.isText()){text=textNode.getGraphic();if(text.getHPosition()==="none"){textHeight=text.getCalculatedHeight();switch(text.getVPosition()){case"above":rotationControlOffset+=Math.floor(textHeight*this.getZoom());break;case"none":if(node.getHeight()<textHeight){rotationControlOffset+=Math.floor((textHeight-node.getHeight())/2*this.getZoom())}break}}}}this.__rotateControl.css("top","-"+rotationControlOffset+"px")},getZoom:function(){return this.__documentManager.getZoom()},__setControlCursors:function(){var rot=_gliffy.Utils.unwrapRadians(this.__rotation+Math.PI/8),idxOffset,idx,i,cursorType,controlPoint,currentCursor,j;idxOffset=Math.floor(rot/(Math.PI/4));if(idxOffset<=7){for(i=0;i<CLOCKWISE_CONTROL_POINTS.length;i++){idx=(i+idxOffset)%8;cursorType=RESIZE_CURSORS[idx];controlPoint=this.__overlayControl[CLOCKWISE_CONTROL_POINTS[i]];currentCursor=_gliffy.CursorManager.getCursorName(controlPoint);if(currentCursor===cursorType){return}if(CLOCKWISE_CONTROL_POINTS[i]===3&&this.getSelectedNode().isSwimlane()){for(j=0;j<this.__overlayControlLane.length;j++){_gliffy.CursorManager.setCursor(cursorType,this.__overlayControlLane[j])}}_gliffy.CursorManager.setCursor(cursorType,controlPoint)}}},__worldToOverlay:function(xInWorld,yInWorld){var invertedOverlaySpace=this.__getOverlaySpace().createInverse();return invertedOverlaySpace.transformPoint(xInWorld,yInWorld)},__overlayToWorld:function(xInOverlaySpace,yInOverlaySpace){return this.__getOverlaySpace().transformPoint(xInOverlaySpace,yInOverlaySpace)},__drawRotateHandle:function(){var height,node,offset,offsetForText,text,textHeight,textNode;node=this.getSelectedNode();offset=ROTATION_CONTROL_OFFSET-ROTATION_HANDLE_SIZE;height=offset+node.getHeight()*this.__documentManager.getZoom()/2;node=this.getSelectedNode();if(node instanceof _gliffy.Node){textNode=node.getFirstTopLevelNodeWithGraphic(_gliffy.Text);if(textNode&&textNode.isText()){text=textNode.getGraphic();if(text.getHPosition()==="none"){textHeight=text.getCalculatedHeight();switch(text.getVPosition()){case"above":offsetForText=Math.floor(textHeight*this.getZoom());height+=offsetForText;offset+=offsetForText;break;case"none":if(textHeight>node.getHeight()){offsetForText=Math.floor((textHeight-node.getHeight())/2*this.getZoom());height+=offsetForText;offset+=offsetForText}break}}}}this.__rotateHandle.css({left:"50%",top:-offset+"px",height:height+"px"})},__drawOverlay:function(){if(_gliffy.Debug.SKIP_RENDER_LOOP){this.__deferredDrawOverlay()}else{this.__redraw=true}},__storeState:function(){this.__modifyLines=[];var lines=this.getSelectedNode().findGraphic(_gliffy.Line),i,command;for(i=0;i<lines.length;i++){command=new _gliffy.ModifyLineCommand({node:lines[i]});this.__modifyLines.push(command);this.getSelectedNode().stage.commandHistory.addAndExecuteCommand(command)}},__applyState:function(){var i,selectedNode=this.getSelectedNode();if(selectedNode){for(i=0;i<this.__modifyLines.length;i++){this.__modifyLines[i].takeSnapShot(selectedNode.stage)}}else{_gliffy.Logger.error("selectedNode is null in overlay._applyState")}this.__modifyLines=[]},__deferredDrawOverlay:function(){var node=this.getSelectedNode(),scaleX,scaleY,deg,o,outlineTransform,zoom,overlayOutlineCss,self=this;if(node instanceof _gliffy.Node){scaleX=this.__scaleX/node.getWidth();scaleY=this.__scaleY/node.getHeight();deg=_gliffy.Utils.radiansToDegrees(this.__rotation);if(!_gliffy.Utils.floatEquals(scaleX,1)||!_gliffy.Utils.floatEquals(scaleY,1)){if(node.isSwimlane()&&node.children.length>2&&self.__overlayCoords&&self.__overlayCoords.x!==0.5){this.__documentManager.addAndExecuteCommand(new _gliffy.ScaleSwimlaneCommand({node:node,scaleX:scaleX,scaleY:scaleY,x:this.__transX,y:this.__transY,overlayCoords:self.__overlayCoords}))}else{this.__documentManager.addAndExecuteCommand(new _gliffy.SetScaleCommand({node:node,scaleX:scaleX,scaleY:scaleY,x:this.__transX,y:this.__transY}))}}else{if(Math.ceil(this.__transX)!==Math.ceil(node.getX())||Math.ceil(this.__transY)!==Math.ceil(node.getY())){this.__documentManager.addAndExecuteCommand(new _gliffy.MoveNodeCommand({node:node,x:this.__transX,y:this.__transY}))}else{if(deg!==node.getRotation()){this.__documentManager.addAndExecuteCommand(new _gliffy.SetRotationCommand({node:node,rotation:deg}))}}}if(this.getLaneCommand()){this.__documentManager.addAndExecuteCommand(this.getLaneCommand());this.__laneCommand=null}o=this.__overlayToWorld(0,0);outlineTransform=_gliffy.AffineTransform.getTranslateInstance(o.x,o.y);outlineTransform.rotate(this.__rotation,0,0);zoom=this.__documentManager.getActiveStage().getZoom();overlayOutlineCss=_gliffy.Utils.transformCss(outlineTransform);overlayOutlineCss.width=this.__scaleX*zoom;overlayOutlineCss.height=this.__scaleY*zoom;this.__overlayOutline.css(overlayOutlineCss);if(this.__overlayContainer.css("display")!=="inline"){this.__overlayContainer.css("display","inline")}this.__documentManager.redraw(function(){if(self.__transX!==node.getX()||self.__transY!==node.getY()||self.__scaleX!==node.getWidth()||self.__scaleY!==node.getHeight()){node.update();outlineTransform=_gliffy.AffineTransform.getTranslateInstance(node.worldTransform.getTranslateX()*zoom,node.worldTransform.getTranslateY()*zoom);outlineTransform.rotate(self.__rotation,0,0);overlayOutlineCss=_gliffy.Utils.transformCss(outlineTransform);overlayOutlineCss.width=node.getWidth()*zoom;overlayOutlineCss.height=node.getHeight()*zoom;self.__overlayOutline.css(overlayOutlineCss)}});if(this.__redrawModel){GliffyApp.overlayModel.update(this);GliffyApp.contextualPropertiesController.updateControlsPosition(this)}if(this.__popCommandBundle){this.__documentManager.popCommandBundle()}this.__redrawHud=false;this.__redrawModel=false;this.__popCommandBundle=false;this.__updateLanes();this.__setControlCursors();this.__drawRotateHandle();if(_gliffy.Mouse.getVelocity()<1500){GliffyApp.hudController.showDeferred()}else{GliffyApp.hudController.quickHide()}}},__getStageOverlaySpace:function(){return new _gliffy.AffineTransform().translate(this.__transX,this.__transY).rotate(this.__rotation,0.5*this.__scaleX,0.5*this.__scaleY).scale(this.__scaleX,this.__scaleY)},__getOverlaySpace:function(){var zoom=this.__documentManager.getActiveStage().getZoom();return new _gliffy.AffineTransform().scale(zoom,zoom).translate(this.__transX,this.__transY).rotate(this.__rotation,0.5*this.__scaleX,0.5*this.__scaleY).scale(this.__scaleX,this.__scaleY)},refresh:function(){var node=this.getSelectedNode();if(node!==null){this.updateResizeControls();this.updateRotationControl();this.__scaleX=node.getWidth();this.__scaleY=node.getHeight();this.__transX=node.getX();this.__transY=node.getY();this.__rotation=node.getRotation()*Math.PI/180;this.__drawOverlay();this.__updateModel()}},select:function(node,container){var domStage=container.find(".gliffy-stage"),overlayUnderStage=domStage.find("#gliffy-overlay"),selectedNodes,i;if(overlayUnderStage.length===0){domStage.append(this.__overlayContainer);if(!this.__eventsRegistered){this.__registerEvents()}}this.__container=container;this.setSelectedNode(node);selectedNodes=this.getManager().getSelectedNodes();for(i=0;i<selectedNodes.length;i++){if(selectedNodes[i].isGroup()){selectedNodes[i].getDomViewbox().addClass("gliffy-active")}}if(node.isGroup()){node.getDomViewbox().addClass("gliffy-active")}_gliffy.KeyManager.setState("overlaySelected");this.refresh();this.configControlsDisplay();this.getManager().getContainer().trigger("gliffy-overlay-select")},deselect:function(){$(".gliffy-viewbox.gliffy-active").removeClass("gliffy-active");this.setSelectedNode(null);$("#gliffy-overlay").css("display","none");this.__overlayContainer.css("display","none");GliffyApp.contextualPropertiesController.hideControls();this.getManager().getContainer().trigger("gliffy-overlay-deselect")},isActive:function(){return(this.getSelectedNode()!==null)},__doScale:function(x,y,anchorX,anchorY,minX,minY,originalSize,doScaleForDrawingGuides){var scaleX,scaleY,overlaySpace,oMod,snapPixels,oOriginal,requestedScaleX,requestedScaleY,modifyingX,modifyingY;switch(anchorX){case 0:requestedScaleX=x+originalSize.x;modifyingX=true;break;case 0.5:requestedScaleX=this.getScaleX();modifyingX=false;break;case 1:requestedScaleX=-x+originalSize.x;modifyingX=true;break}switch(anchorY){case 0:requestedScaleY=y+originalSize.y;modifyingY=true;break;case 0.5:requestedScaleY=this.getScaleY();modifyingY=false;break;case 1:requestedScaleY=-y+originalSize.y;modifyingY=true;break}overlaySpace=this.__getStageOverlaySpace();overlaySpace.rotate(-this.__rotation,anchorX,anchorY);oMod=overlaySpace.transformPoint(anchorX,anchorY);snapPixels=this.isSnapEnabled()&&!doScaleForDrawingGuides?this.__snapPixels:1;scaleX=Math.max(requestedScaleX-requestedScaleX%snapPixels,minX);scaleY=Math.max(requestedScaleY-requestedScaleY%snapPixels,minY);if(modifyingX){this.setScaleX(scaleX-scaleX%snapPixels)}if(modifyingY){this.setScaleY(scaleY-scaleY%snapPixels)}oOriginal=this.__getStageOverlaySpace().transformPoint(anchorX,anchorY);this.__transX+=oMod.x-oOriginal.x;this.__transY+=oMod.y-oOriginal.y;if(GliffyApp.documentModel.drawingGuides&&!this.__allowLockAspectOnStretch()&&!doScaleForDrawingGuides){this._applyDrawingGuidesForScale(null,{x:anchorX,y:anchorY},{x:this.__scaleX,y:this.__scaleY})}},__allowLockAspectOnStretch:function(){return(this.getSelectedNode().getLockAspectRatio()||this.__isShiftKeyLockAspect(this.getSelectedNode()))},__isShiftKeyLockAspect:function(selectedNode){return _gliffy.KeyManager.shiftKeyDown&&selectedNode.supportsLockAspect()},move:function(axis,value){if(axis==="x"){this.setTransX(this.getTransX()+value)}else{this.setTransY(this.getTransY()+value)}this.__redrawModel=true},rotate:function(value){this.setRotation(_gliffy.Utils.unwrapRadians(this.getRotation()+value))},getSelectedNode:function(){return this.__documentManager.getActiveStage().find(this.__overlayedNode)},getTopLevelSelectedNodes:function(){var targets,selectedNode;selectedNode=this.getSelectedNode();if(selectedNode){if(!selectedNode.isMultipartShape()&&selectedNode.children&&(selectedNode.isGroup()||selectedNode.isSelection()||selectedNode.isGroupDroppable())){targets=selectedNode.children}else{targets=[selectedNode]}return targets}return[]},setSelectedNode:function(node){if(node!==this.__overlayedNode){$(window).trigger("gliffy-overlay-set-selected-node",[node])}if(node){this.__overlayedNode=node.getId()}else{this.__overlayedNode=null}},setupLanes:function(){var selectedNode=this.getSelectedNode(),lanes,i,lane,constraint;if(selectedNode.isSwimlane()){lanes=selectedNode.children.length-1;for(i=2;i<selectedNode.children.length;i++){lane=this.__overlayControlLane[i-2];constraint=selectedNode.children[i].getConstraints().getConstraint(_gliffy.PositionConstraint);if(constraint){lane.data("lane",{nodeId:selectedNode.children[i].getId(),sibling:selectedNode.children[i-1].getId(),nextSibling:selectedNode.children[i+1]?selectedNode.children[i+1].getId():null,lanes:lanes});lane.css({left:constraint.px*100+"%",top:"50%"})}else{_gliffy.Logger.warn("Swimlane is missing constraints! Removing this object: "+selectedNode.toObject());this.deselect();new _gliffy.RemoveNodeCommand({node:selectedNode}).execute(this.__documentManager.getActiveStage())}}for(i=lanes-1;i<11;i++){this.__overlayControlLane[i].removeClass("active")}this.__overlayContainer.addClass("lanes lane-"+lanes)}else{this.__overlayContainer.removeClass("lanes")}},__updateLanes:function(){var selectedNode=this.getSelectedNode(),i,stage=this.__documentManager.getActiveStage(),constraint,lane,data;if(selectedNode.isSwimlane()){for(i=0;i<this.__overlayControlLane.length;i++){if(this.__overlayControlLane[i].is(":visible")){data=this.__overlayControlLane[i].data("lane");if(data){lane=stage.find(data.nodeId);if(lane){constraint=lane.getConstraints().getConstraint(_gliffy.PositionConstraint);this.__overlayControlLane[i].css({left:constraint.px*100+"%",top:"50%"})}else{this.__overlayContainer.removeClass("lane-"+data.lanes).addClass("lane-"+selectedNode.children.length-1)}}}}}},configControlsDisplay:function(){var i,shapeInfo,mutableProps,heightConstraint=false,widthConstraint=false,rotationConstraint=false,selectedNode=this.getSelectedNode(),selectedNodes=this.getTopLevelSelectedNodes(),isUnknownShape=!(selectedNode&&selectedNode.isKnownShape());if(selectedNodes.length>0){if(this&&this.getLockPosition()){this.updateResizeControls()}this.__overlayContainer.removeClass().addClass("rotate resize");for(i=0;i<selectedNodes.length;i++){shapeInfo=selectedNodes[i].getShapeInformation();mutableProps=shapeInfo.mutableProperties;if(mutableProps){if(!heightConstraint){heightConstraint=($.inArray("height",mutableProps)===-1)}if(!widthConstraint){widthConstraint=($.inArray("width",mutableProps)===-1)}if(!rotationConstraint){rotationConstraint=($.inArray("rotate",mutableProps)===-1)}}}if(selectedNode.isProxy()||(heightConstraint&&widthConstraint)||isUnknownShape){this.__overlayContainer.removeClass("resize")}else{if(heightConstraint){this.__overlayContainer.addClass("height-constraint")}else{if(widthConstraint){this.__overlayContainer.addClass("width-constraint")}}}if(rotationConstraint||isUnknownShape){this.__overlayContainer.removeClass("rotate")}this.setupLanes()}},isResizable:function(){var i,selectedNodes;selectedNodes=this.getTopLevelSelectedNodes();if(selectedNodes.length>0){for(i=0;i<selectedNodes.length;i++){if(!selectedNodes[i].isKnownShape()||!selectedNodes[i].isResizable()){return false}}return true}return false},inStageViewport:function(){var inViewport=false,stageDimensions=this.__documentManager.getActiveStageViewPort();if(((this.getTransY()+this.getScaleY())>stageDimensions.min.y)&&((this.getTransX()+this.getScaleX())>stageDimensions.min.x)&&(this.getTransY()<stageDimensions.max.y)&&(this.getTransX()<stageDimensions.max.x)){inViewport=true}return inViewport},getClassName:function(){return"Overlay"},hideControls:function(){this.__overlayContainer.removeClass("resize rotate lanes")},showControls:function(){this.configControlsDisplay()},clearContextMenu:function(){return GliffyApp.contextMenuController.clearContextMenu(this.__contextMenu)},getContextMenuDefinition:function(){var self=this,contextMenu=[],pushToMenu,pushDivider;pushToMenu=function(key,val){var obj={};obj.text=key;obj.action=val.onclick;obj.className=val.className;contextMenu.push(obj)};pushDivider=function(){contextMenu.push({divider:true})};pushToMenu($.i18n._("OVERLAY_CUT"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"overlayCut"});GliffyApp.toolbarController.doCut()}});pushToMenu($.i18n._("OVERLAY_COPY"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"overlayCopy"});GliffyApp.toolbarController.doCopy()}});pushToMenu($.i18n._("OVERLAY_PASTE"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"overlayPaste"});_gliffy.Mouse.setLastMouseUpPosition(_gliffy.Mouse.getContextMenuMouseDownPosition());GliffyApp.toolbarController.doPaste()}});pushToMenu($.i18n._("OVERLAY_DELETE"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"overlayDelete"});GliffyApp.toolbarController.doDelete()}});pushToMenu($.i18n._("EDITOR_STYLE_COPY"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"styleCopyCopy"});GliffyApp.styleCopyController.copyStyle();self.__isStyleCopied=true},className:"gliffy-context-menu-style-copy"});pushToMenu($.i18n._("EDITOR_STYLE_PASTE"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"styleCopyPaste"});GliffyApp.styleCopyController.pasteStyle()},className:"gliffy-context-menu-style-paste"});pushDivider();pushToMenu($.i18n._("OVERLAY_UNLOCK_SELECTION"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"overlayUnlock"});GliffyApp.contextualPropertiesController.updateShapeTabProperty("LockPosition",false);self.refresh()},className:"gliffy-context-menu-item-unlock"});pushToMenu($.i18n._("OVERLAY_LOCK_SELECTION"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"overlayLock"});GliffyApp.contextualPropertiesController.updateShapeTabProperty("LockPosition",true);self.refresh()},className:"gliffy-context-menu-item-lock"});pushDivider();pushToMenu($.i18n._("OVERLAY_SEND_TO_FRONT"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"overlayToFront"});GliffyApp.toolbarController.doBringToFront()},className:"gliffy-context-menu-item-sendToFront"});pushToMenu($.i18n._("OVERLAY_SEND_TO_BACK"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"overlayToBack"});GliffyApp.toolbarController.doSendToBack()},className:"gliffy-context-menu-item-sendToBack"});pushToMenu($.i18n._("OVERLAY_GROUP"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"overlayGroup"});GliffyApp.toolbarController.doGroup()},className:"gliffy-context-menu-item-group"});pushToMenu($.i18n._("OVERLAY_UNGROUP"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"overlayUngroup"});GliffyApp.toolbarController.doUnGroup()},className:"gliffy-context-menu-item-ungroup"});return contextMenu.concat(_gliffy.LayersContextMenu.getContextMenuDescriptor())},beforeContextMenuShow:function(){var node=this.getSelectedNode(),isGroupOrSelection=false,isLocked=false,styleCopied,$menu=$(".gliffy-context-menu-overlay");_gliffy.Mouse.setContextMenuMouseDownPosition(_gliffy.Mouse.getPosition());if(node){isGroupOrSelection=node.isGroup()||node.isSelection()}isLocked=this?this.getLockPosition():false;styleCopied=this.__isStyleCopied;$menu.find(".gliffy-context-menu-item-group").toggle(isGroupOrSelection);$menu.find(".gliffy-context-menu-item-ungroup").toggle(isGroupOrSelection);$menu.find(".gliffy-context-menu-item-lock").toggle(!isLocked);$menu.find(".gliffy-context-menu-item-unlock").toggle(isLocked);$menu.find(".gliffy-context-menu-style-copy").toggle(node.supportsStyleCopy());$menu.find(".gliffy-context-menu-style-paste").toggle(styleCopied);_gliffy.LayersContextMenu.beforeContextShow($menu,this.__documentManager.getActiveStage().getLayers(),node)},setManager:function(manager){this.__manager=manager},getManager:function(){return this.__manager}}))}());(function(){var MIN_SIZE=3,ZOOM_AMOUNTS=[0.1,0.15,0.25,0.33,0.5,0.67,0.75,1,1.25,1.5,1.75,2,2.5,3,3.5,4],CLASS_NAME="gliffy-zoom-box";_gliffy.ZoomOverlay=_gliffy.Class.extend({init:function(options){var self=this;if(!options||!options.stageDiv||!options.documentManager){throw new Error("A stageDiv and documentManager is required for this to work.")}this.__stageDiv=options.stageDiv;this.__documentManager=options.documentManager;_gliffy.Mouse.registerDragState([{modes:["zoomIn","zoomOut"],dragStart:function(){self.__stageDiv.setClassName(CLASS_NAME);self.__stageDiv.setStartCorner(_gliffy.Mouse.getPosition())},drag:function(){self.__stageDiv.setEndCorner(_gliffy.Mouse.getPosition());if(self.isZoomIn()&&!self.__stageDiv.isScreenDiagonalLessThan(MIN_SIZE)){self.__stageDiv.draw()}else{self.__stageDiv.hide()}},dragEnd:function(){if(self.isZoomIn()&&self.__stageDiv.isVisible()){self.__documentManager.zoomToBox(self.__stageDiv.getBoundingBox());self.__stageDiv.hide()}else{self.click(self.__stageDiv.getEndCorner())}},autoPan:true}])},click:function(point){this.__documentManager.zoomAt(this.__getNextZoom(this.isZoomIn()),point.x,point.y)},keyboardZoom:function(zoomIn){this.__documentManager.zoomToCenter(this.__getNextZoom(zoomIn))},isZoomIn:function(){return _gliffy.Mouse.getState()==="zoomIn"},__getNextZoom:function(zoomIn){var zoom=this.__documentManager.getZoom(),i;if(zoomIn){if(Math.floor(zoom)>=ZOOM_AMOUNTS[ZOOM_AMOUNTS.length-1]){return Math.floor(zoom)+1}for(i=0;i<ZOOM_AMOUNTS.length;i++){if(ZOOM_AMOUNTS[i]>zoom){return ZOOM_AMOUNTS[i]}}return ZOOM_AMOUNTS[ZOOM_AMOUNTS.length-1]}else{if(Math.ceil(zoom)>=ZOOM_AMOUNTS[ZOOM_AMOUNTS.length-1]+1){return Math.ceil(zoom)-1}for(i=ZOOM_AMOUNTS.length;i>=0;i--){if(ZOOM_AMOUNTS[i]<zoom){return ZOOM_AMOUNTS[i]}}return ZOOM_AMOUNTS[0]}}});_gliffy.ZoomOverlay.ZOOM_AMOUNTS=ZOOM_AMOUNTS}());(function(){var moveThreshold=new _gliffy.MoveThreshold();_gliffy.LineOverlay=_gliffy.Class.extend({__MAX_CONTROL_POINTS:2,__MAX_ADJUSTMENT_POINTS:3,__CONTROL_POINT_PADDING:8,__MAX_LINE_TEXTS:16,__editor:null,__documentManager:null,__overlayControl:null,__overlayHighlight:null,__overlayAdjustment:null,__selectedNodeId:null,__container:null,__overlayControlWidth:0,__overlayControlHeight:0,__overlayContainer:null,__eventsRegistered:false,__textControl:null,__lineDrawMode:false,__snapPixels:10,__modifyLineCommand:null,__connectionData:null,__contextMenu:null,__textMovers:null,__cardinalityPlaceholders:null,__textMoverData:null,__slideData:null,__isStyleCopied:false,__connectionPointsActive:false,isNewlyCreatedLine:false,isDragging:false,init:function(o){this.__overlayControl=[];this.__overlayAdjustment=[];this.__textMovers=[];this.__cardinalityPlaceholders=[];this.__textMoverData={pointArray:[],controlHalfWidth:12,controlHalfHeight:12,padding:2,prevLineTValue:null,prevLinePerpValue:null,checkForDbl:false,currentIndex:-1};if(!o){throw new Error("lineOverlay init needs options")}if(!o.documentManager){throw new Error("lineOverlay init options needs documentManager")}if(!o.target){throw new Error("lineOverlay init options needs target")}if(!o.textControl){throw new Error("lineOverlay needs textControl")}if(!o.editor){throw new Error("lineOverlay init options needs editor")}var i,self=this;this.__editor=o.editor;this.__container=o.target;this.__documentManager=o.documentManager;this.__textControl=o.textControl;this.__overlayContainer=$('<div id="gliffy-line-overlay"/>');this.__overlayHighlight=$('<div class="gliffy-icon-overlay-cp-highlight gliffy-line-overlay-highlight hidden" />');for(i=0;i<this.__MAX_CONTROL_POINTS;i++){this.__overlayControl.push($('<div class="gliffy-line-overlay-control gliffy-icon-overlay-handle-circle" />'));this.__overlayControl[i].data("i",i);this.__overlayContainer.append(this.__overlayControl[i]);_gliffy.CursorManager.setCursor("move",this.__overlayControl[i])}for(i=0;i<this.__MAX_ADJUSTMENT_POINTS;i++){this.__overlayAdjustment.push($('<div class="gliffy-line-overlay-adjustment gliffy-icon-overlay-handle-circle" style="display:none;" />'));this.__overlayAdjustment[i].data("i",i);this.__overlayContainer.append(this.__overlayAdjustment[i])}for(i=0;i<this.__MAX_LINE_TEXTS;i++){this.__textMovers.push($('<div class="gliffy-line-overlay-text-adjustment" style="display:none;" />'));this.__textMovers[i].data("i",i);this.__overlayContainer.append(this.__textMovers[i])}for(i=0;i<2;i++){this.__cardinalityPlaceholders.push($('<div class="gliffy-cardinality-placeholder" style="display:none;" title="Add Cardinality">0..*</div>'));this.__cardinalityPlaceholders[i].data("i",i);this.__overlayContainer.append(this.__cardinalityPlaceholders[i])}_gliffy.RenderLoop.appendTask(function(){if(self.__redraw){self.__deferredDrawOverlay()}self.__redraw=false});this.__setupControlDragManager();this.__bindConnectionPointDistanceHiding();GliffyApp.contextMenuController.createContextMenu(this,"#gliffy-line-overlay",this.getContextMenuDefinition(),"gliffy-context-menu-line-overlay")},__bindConnectionPointDistanceHiding:function(){var self=this,$body=$("body");$body.on("mousemove",function(e){if(self.__connectionPointsActive){var p=_gliffy.Mouse.getPosition(),size=10,bb=new _gliffy.BoundingBox(p.x-size,p.y-size,p.x+size,p.y+size),nodes,i;nodes=_gliffy.Pick.selectNodesInclusive(self.__documentManager.getActiveStage().objects,bb);$("div.gliffy-viewbox.gliffy-near").removeClass("gliffy-near");for(i=0;i<nodes.length;i++){self.__addClassToNodeViewbox(nodes[i])}}})},__addClassToNodeViewbox:function(node){var i;node.getDomViewbox().addClass("gliffy-near");for(i=0;node.children&&i<node.children.length;i++){this.__addClassToNodeViewbox(node.children[i])}},__textMoverDragStart:function(){var line,self=this,overlayedNode=self.getSelectedNode(),textNode;if(overlayedNode){if(self.__textMoverData.checkForDbl){self.makeTextEditable()}else{if(overlayedNode.children&&overlayedNode.children.length>0){textNode=overlayedNode.children[self.__textMoverData.currentIndex];self.__editor.overlayManager.updateRTEControls(textNode.getGraphic().getHTML());self.__textMoverData.checkForDbl=true;setTimeout(function(){self.__textMoverData.checkForDbl=false},self.__editor.overlayManager.getDoubleClickTimeout());_gliffy.Mouse.setCursor("move");$(".gliffy-line-overlay-text-adjustment").css("border","");self.__textMovers[self.__textMoverData.currentIndex].css("border","2px solid #00B421");line=overlayedNode.getGraphic();self.__textMoverData.pointArray=[];self.__textMoverData.prevLineTValue=textNode.getGraphic().getLineTValue();self.__textMoverData.prevLinePerpValue=textNode.getGraphic().getLinePerpValue()}}}},__textMoverDrag:function(){var mousePos=_gliffy.Mouse.getPosition(),leastDistanceSq=Number.MAX_VALUE,closestDistanceIndex=0,i,line,closestPoint,overlayedNode=this.getSelectedNode(),curDistance,slopeVec,angle,tValue,textChild,self,dir,zoom,pathDistance;function isLeft(a,b,c){return((b.x-a.x)*(c.y-a.y)-(b.y-a.y)*(c.x-a.x))>0}if(overlayedNode){this.isDragging=true;line=overlayedNode.getGraphic();pathDistance=Math.floor(line.getPathLength().totalDistance);if(this.__textMoverData.pointArray.length===0){for(i=0;i<pathDistance;i++){this.__textMoverData.pointArray.push(_gliffy.candash.getPointInPathAtDistance(line.getPointPath(),i,line.getPathLength()))}GliffyApp.contextualPropertiesController.hideControls()}for(i=0;i<this.__textMoverData.pointArray.length;i++){curDistance=_gliffy.Vec2.squaredDistance(mousePos,this.__textMoverData.pointArray[i]);if(curDistance<leastDistanceSq){closestDistanceIndex=i;leastDistanceSq=curDistance}}closestPoint=_gliffy.candash.getPointInPathAtDistance(line.getPointPath(),closestDistanceIndex,line.getPathLength());slopeVec=line.getSlopeAtDistance(closestDistanceIndex);textChild=overlayedNode.children[this.__textMoverData.currentIndex].getGraphic();if(Math.sqrt(leastDistanceSq)>20){dir=isLeft(closestPoint,_gliffy.Vec2.sum(closestPoint,slopeVec),mousePos)?1:-1;textChild.setLinePerpValue(20*dir)}else{textChild.setLinePerpValue(0)}this.__documentManager.getActiveDocument().getGon().setBetaVersion();tValue=closestDistanceIndex/line.getPathLength().totalDistance;textChild.setLineTValue(tValue);line.markDirty();self=this;this.__documentManager.redraw(function(){self.__updateTextMoverPositions()})}},__updateTextMoverPositions:function(){var self=this,padding=self.__textMoverData.padding,zoom=this.__documentManager.getActiveStage().getZoom(),overlayedNode=this.getSelectedNode(),i;for(i=0;i<self.__MAX_LINE_TEXTS;i++){if(overlayedNode&&overlayedNode.children&&i<overlayedNode.children.length){self.__textMovers[i].css("display","");if(i===self.__textMoverData.currentIndex){self.__textMovers[i].css({left:(overlayedNode.children[i].worldAabb.min.x-padding)*zoom-1,top:(overlayedNode.children[i].worldAabb.min.y-padding)*zoom-1,width:(overlayedNode.children[i].worldAabb.max.x-overlayedNode.children[i].worldAabb.min.x+padding*2)*zoom,height:(overlayedNode.children[i].worldAabb.max.y-overlayedNode.children[i].worldAabb.min.y+padding*2)*zoom})}}else{self.__textMovers[i].css("display","none")}}},__textMoverDragEnd:function(){var overlayedNode=this.getSelectedNode(),textNode,newLinePerpValue,newLineTValue;if(overlayedNode){textNode=overlayedNode.children[this.__textMoverData.currentIndex];$(".gliffy-line-overlay-text-adjustment").css("border","");this.__textMovers[this.__textMoverData.currentIndex].css("border","2px solid #008D18");newLinePerpValue=textNode.getGraphic().getLinePerpValue();newLineTValue=textNode.getGraphic().getLineTValue();if(newLinePerpValue!==this.__textMoverData.prevLinePerpValue||newLineTValue!==this.__textMoverData.prevLineTValue){textNode.getGraphic().setLineTValue(this.__textMoverData.prevLineTValue);textNode.getGraphic().setLinePerpValue(this.__textMoverData.prevLinePerpValue);this.__documentManager.addAndExecuteCommand(new _gliffy.ModifyLineTextCommand({node:overlayedNode.children[this.__textMoverData.currentIndex],linePerpValue:newLinePerpValue,lineTValue:newLineTValue}))}_gliffy.Utils.analyticsEvent("trackEvent",{category:"line",action:"moveText"});GliffyApp.contextualPropertiesController.showControls(this)}},__renderCardinalityPlaceholders:function(){var i,cardinality=["begin","end"],node=this.getSelectedNode(),zoom=this.__documentManager.getActiveStage().getZoom(),width=26,height=16,line,totalDistance,arrow,curDistance,slopeVec,slope,lineTValue,linePerpValue,isShortLine;line=this.getSelectedNode().getGraphic();totalDistance=line.getPathLength().totalDistance;isShortLine=totalDistance<80;if(node&&node.getUid()&&(node.getUid().indexOf("uml")!==-1)&&(node.getUid().indexOf("anchor_line")===-1)){for(i=0;i<2;i++){arrow=line[(cardinality[i]==="begin")?"getStartArrow":"getEndArrow"]();curDistance=(arrow===0?15:25);linePerpValue=15*(i===1&&isShortLine?-1:1);if(!line.hasCardinality(cardinality[i])&&totalDistance>10){if(cardinality[i]==="end"){curDistance=totalDistance-curDistance}lineTValue=curDistance/totalDistance;slopeVec=line.getSlopeAtDistance(curDistance);slope=Math.atan2(slopeVec.y,slopeVec.x);if(slope>-1.571&&slope<1.57){linePerpValue=-15*(i===1&&isShortLine?-1:1)}var linePoint=line.getPointAt(lineTValue);var offset=new _gliffy.Vec2(0,0);if(linePerpValue!==0){offset=slopeVec.rotate(Math.PI/2).scale(linePerpValue)}var cardinalityPos=new _gliffy.Vec2(offset.x+linePoint.x-width/2,offset.y+linePoint.y-height/2);this.__cardinalityPlaceholders[i].css({display:"block",left:(this.getSelectedNode().getX()+cardinalityPos.x)*zoom+"px",top:(this.getSelectedNode().getY()+cardinalityPos.y)*zoom+"px",width:(width*zoom)+"px",height:(height*zoom)+"px"})}else{this.__cardinalityPlaceholders[i].css({display:"none"})}}}else{this.__cardinalityPlaceholders[0].css({display:"none"});this.__cardinalityPlaceholders[1].css({display:"none"})}},__renderTextMovers:function(node){var i,textChild,slopeVec,linePoint,angle,padding,zoom=this.__documentManager.getActiveStage().getZoom(),line=node.getGraphic();for(i=0;i<this.__MAX_LINE_TEXTS;i++){if(node.children&&i<node.children.length){textChild=node.children[i].getGraphic();slopeVec=line.getSlopeAtT(textChild.getLineTValue());linePoint=line.getPointInPathAtT(textChild.getLineTValue());angle=Math.atan2(slopeVec.y,slopeVec.x);padding=this.__textMoverData.padding;this.__textMovers[i].css({display:"",left:(node.children[i].worldAabb.min.x-padding)*zoom-1,top:(node.children[i].worldAabb.min.y-padding)*zoom-1,width:(node.children[i].worldAabb.max.x-node.children[i].worldAabb.min.x+padding*2)*zoom,height:(node.children[i].worldAabb.max.y-node.children[i].worldAabb.min.y+padding*2)*zoom})}else{this.__textMovers[i].css("display","none")}}},__convertCardinalityPlaceholder:function(placeholderEle){var beginEnd=placeholderEle.data("i")===0?"begin":"end";this.addCardinality(beginEnd)},__setupControlDragManager:function(){var self=this,$this,overlayedNode;var checkDoubleAndThen=function(thenFunc){if(self.__textMoverData.checkForDbl){self.__textMoverData.checkForDbl=false;self.makeTextEditable({createNew:true})}else{thenFunc();self.__textMoverData.checkForDbl=true;setTimeout(function(){self.__textMoverData.checkForDbl=false},self.__editor.overlayManager.getDoubleClickTimeout())}};_gliffy.Mouse.registerClickState({name:"line-overlay",target:".gliffy-line-overlay-control,.gliffy-line-overlay-adjustment,.gliffy-line-overlay-text-adjustment,.gliffy-cardinality-placeholder",modes:["line-control","line-adjustment","line-move","line-text-adjustment"],mouseDown:function(event){event.stopPropagation();_gliffy.Mouse.setClickMode("line-overlay");$this=$(event.currentTarget);overlayedNode=self.getSelectedNode();if($this.hasClass("gliffy-line-overlay-control")){_gliffy.Mouse.setState("line-control")}else{if($this.hasClass("gliffy-line-overlay-adjustment")){_gliffy.Mouse.setState("line-adjustment")}else{if($this.hasClass("gliffy-line-overlay-text-adjustment")){self.__textMoverData.currentIndex=$this.data("i");_gliffy.Mouse.setState("line-text-adjustment")}else{if($this.hasClass("gliffy-cardinality-placeholder")){self.__convertCardinalityPlaceholder($this);return false}else{if(overlayedNode&&self.__lastTarget===overlayedNode.getId()){self.__lastTarget=null;self.makeTextEditable();return}else{_gliffy.Mouse.setState("line-move");self.__setLastTarget()}}}}}_gliffy.Mouse.__mousedown(event)}});_gliffy.Mouse.registerDragState([{modes:["line-control"],dragStart:function(event){checkDoubleAndThen(function(){_gliffy.Mouse.setCursor("move");self.__startModifyLine();GliffyApp.contextualPropertiesController.hideControls();self.__resetTextMovers();self.__controlDragStart($this)})},drag:function(event){self.isDragging=true;self.__controlDrag($this,_gliffy.Mouse.getPosition())},dragEnd:function(event){self.isDragging=false;self.__controlDragEnd();self.__endModifyLine()},autoPan:true},{modes:["line-text-adjustment"],dragStart:function(event){self.isDragging=true;self.__textMoverDragStart(event)},drag:function(event){self.__textMoverDrag(event)},dragEnd:function(event){self.isDragging=false;self.__textMoverDragEnd(event)},autoPan:true},{modes:["line-adjustment"],dragStart:function(event){checkDoubleAndThen(function(){var node=self.getSelectedNode(),index=$this.data("i")+1;if(node.getGraphic().editable.isSegmentHorizontal(index)){_gliffy.Mouse.setCursor("n-resize")}else{_gliffy.Mouse.setCursor("w-resize")}self.__startModifyLine();GliffyApp.contextualPropertiesController.hideControls();self.__resetTextMovers();self.showConnectionPoints(false)})},drag:function(event){var node=self.getSelectedNode(),index,start,end,delta;if(node){index=$this.data("i")+1;delta=_gliffy.Mouse.getDelta();if(node.getGraphic().editable.isSegmentHorizontal(index)){delta.x=0}else{delta.y=0}start=node.getGraphic().getWorldControlPoint(index);end=node.getGraphic().getWorldControlPoint(index+1);start=_gliffy.Vec2.sum(start,delta);end=_gliffy.Vec2.sum(end,delta);node.getGraphic().setWorldControlPoint(index,start);node.getGraphic().setWorldControlPoint(index+1,end);node.getGraphic().editable.allowClearLocks=false;node.getGraphic().editable.setLockSegment(index,true);self.isDragging=true;self.__drawOverlay()}},dragEnd:function(event){var node=self.getSelectedNode();if(node){node.getGraphic().editable.allowClearLocks=true;self.isDragging=false;GliffyApp.lineOverlayModel.update(self);GliffyApp.contextualPropertiesController.showControls(self);self.showConnectionPoints(true);self.__endModifyLine()}},autoPan:true},{modes:["line-move"],dragStart:function(event){self.__startModifyLine();moveThreshold.reset(event);self.showConnectionPoints(false);self.__resetTextMovers();GliffyApp.contextualPropertiesController.hideControls()},drag:function(event){self.isDragging=true;if(moveThreshold.above(event)){self.move()}},dragEnd:function(event){self.isDragging=false;GliffyApp.lineOverlayModel.update(self);GliffyApp.contextualPropertiesController.showControls(self);self.showConnectionPoints(true);self.__endModifyLine()},autoPan:true}])},setLineType:function(orthoMode){var node=this.getSelectedNode(),options={};if(node){options.node=node;if(orthoMode!==null){options.ortho=true;switch(orthoMode){case _gliffy.Editor.ORTHO_MODE.bezel:options.interpolation=_gliffy.Line.INTERPOLATION_TYPE.linear;options.cornerRadius=10;break;case _gliffy.Editor.ORTHO_MODE.curved:options.interpolation=_gliffy.Line.INTERPOLATION_TYPE.quadratic;break;default:options.interpolation=_gliffy.Line.INTERPOLATION_TYPE.linear;break}}else{options.interpolation=_gliffy.Line.INTERPOLATION_TYPE.linear}this.__startModifyLine();node.stage.commandHistory.addAndExecuteCommand(new _gliffy.SetLineTypeCommand(options));if(orthoMode!==null){this.__documentManager.updateStyleDefaultsForNode(this.getSelectedNode(),"orthoMode",orthoMode)}this.__endModifyLine();if(node.getGraphic()){node.getGraphic().markDirty()}this.__documentManager.redraw()}},getLineType:function(){var node=this.getSelectedNode(),graphic;if(node){graphic=node.getGraphic();if(graphic){return graphic.getLineType()}}return"straight"},detach:function(){$("#gliffy-line-overlay").detach()},isSnapEnabled:function(){return _gliffy.Utils.shouldSnapToGrid()},unhighlightConnectionPoints:function(){this.__overlayHighlight.addClass("hidden");$(".gliffy-over-connection").removeClass("gliffy-over-connection")},__controlDragStart:function(jControl){$(".gliffy-stage").addClass("gliffy-line-control-drag")},__testConnectionEdge:function(pos,snap){var padding=this.__CONTROL_POINT_PADDING,nodes=_gliffy.Pick.pickAllNodesAt(this.__documentManager.getActiveStage().objects,pos.x,pos.y,padding),lineNode=this.getSelectedNode(),i,node,pt,connectionLocation,connect,func,connectionRatio,controlPoint;if(snap){for(i=0;i<nodes.length;i++){node=nodes[i];controlPoint=_gliffy.Pick.pickConnectionPoint(node,pos,this.__CONTROL_POINT_PADDING);if(controlPoint!==null){return{isConnectionPoint:true,node:node,connectionRatio:node.getConnectionPointRatio(controlPoint)}}}}for(i=0;i<nodes.length;i++){node=nodes[i];if(node!==lineNode&&(node.getGraphic() instanceof _gliffy.Shape||node.isMultipartShape())&&node.hasBoundsConnections()){pt=node.worldTransform.createInverse().transformPoint(pos.x,pos.y);connectionLocation=new _gliffy.Vec2(pt.x,pt.y);connect=false;if(pt.x>-padding&&pt.x<padding){connectionLocation.x=0;connect=true}if(pt.y>-padding&&pt.y<padding){connectionLocation.y=0;connect=true}if(pt.x>node.getWidth()-padding&&pt.x<node.getWidth()+padding){connectionLocation.x=node.getWidth();connect=true}if(pt.y>node.getHeight()-padding&&pt.y<node.getHeight()+padding){connectionLocation.y=node.getHeight();connect=true}if(connect){connectionRatio=new _gliffy.Vec2(connectionLocation.x/node.getWidth(),connectionLocation.y/node.getHeight());return{isConnectionPoint:false,node:node,connectionRatio:connectionRatio}}}}return{node:null,connectionRatio:null}},__displayHighlight:function(connectionInfo){var zoom=this.__documentManager.getActiveStage().getZoom(),point=connectionInfo.node.worldTransform.transformPoint(connectionInfo.connectionRatio.x*connectionInfo.node.getWidth(),connectionInfo.connectionRatio.y*connectionInfo.node.getHeight()),parent;this.__overlayHighlight.css({left:point.x*zoom-12,top:point.y*zoom-12});if(connectionInfo.isConnectionPoint){this.__overlayHighlight.removeClass("gliffy-icon-overlay-cp-highlight");this.__overlayHighlight.addClass("gliffy-icon-overlay-cp-highlight-bold")}else{this.__overlayHighlight.removeClass("gliffy-icon-overlay-cp-highlight-bold");this.__overlayHighlight.addClass("gliffy-icon-overlay-cp-highlight")}connectionInfo.node.getDomViewbox().addClass("gliffy-over-connection");if(_gliffy.BrowserDetect.browser==="Safari"||_gliffy.BrowserDetect.browser==="Chrome"){parent=this.__overlayHighlight.parent();this.__overlayHighlight.remove();parent.append(this.__overlayHighlight)}this.__overlayHighlight.removeClass("hidden")},__controlDrag:function(jControl,stageCoords){var lineIdx,node=this.getSelectedNode(),connectionInfo;lineIdx=$(jControl).data("i");this.unhighlightConnectionPoints();if(node){this.detachLineFromConnectionPoint(node,lineIdx);connectionInfo=this.__testConnectionEdge(stageCoords,true);if(connectionInfo.connectionRatio){this.__displayHighlight(connectionInfo);node.getGraphic()[lineIdx===0?"setStartConnection":"setEndConnection"](connectionInfo.node,connectionInfo.connectionRatio)}else{node.getGraphic()[lineIdx===0?"setStartConnection":"setEndConnection"](null)}this.__updateControl(jControl)}else{_gliffy.Logger.warn("node is null in lineOverlay __controlDrag")}this.__drawOverlay()},__startSlide:function(){this.__slideData={connectionStart:null,connectionEnd:null};var node=this.getSelectedNode(),connectionStart,connectionEnd;if(node){connectionStart=node.getGraphic().editable.getConnectionStart();connectionEnd=node.getGraphic().editable.getConnectionEnd();if(connectionStart&&connectionStart.node&&connectionStart.node.isUML2Activation()){this.__slideData.connectionStart=connectionStart}if(connectionEnd&&connectionEnd.node&&connectionEnd.node.isUML2Activation()){this.__slideData.connectionEnd=connectionEnd}}},__slideLineVerticallyMaintainingConnections:function(){var node=this.getSelectedNode(),connectionInfoStart,connectionInfoEnd,shouldMaintainConnection,clampY;if(this.__slideData.connectionStart||this.__slideData.connectionEnd){shouldMaintainConnection=function(initialConnection,currentConnection){return initialConnection&&initialConnection.node===currentConnection.node&&currentConnection.connectionRatio&&currentConnection.connectionRatio.x===initialConnection.ratio.x};clampY=function(connectionRatio){return{x:connectionRatio.x,y:_gliffy.Utils.clamp(connectionRatio.y,0.001,0.999)}};if(node){connectionInfoStart=this.__testConnectionEdge(node.getGraphic().editable.getWorldStartPoint(),false);connectionInfoEnd=this.__testConnectionEdge(node.getGraphic().editable.getWorldEndPoint(),false);this.detachLineFromConnectionPoint(node,0);this.detachLineFromConnectionPoint(node,1);if(shouldMaintainConnection(this.__slideData.connectionStart,connectionInfoStart)){node.getGraphic().setStartConnection(connectionInfoStart.node,clampY(connectionInfoStart.connectionRatio))}else{node.getGraphic().setStartConnection(null)}if(shouldMaintainConnection(this.__slideData.connectionEnd,connectionInfoEnd)){node.getGraphic().setEndConnection(connectionInfoEnd.node,clampY(connectionInfoEnd.connectionRatio))}else{node.getGraphic().setEndConnection(null)}}else{_gliffy.Logger.warn("node is null in lineOverlay __slideLineVerticallyMaintainingConnections")}this.unhighlightConnectionPoints();this.__drawOverlay()}},__controlDragEnd:function(){if(this.getSelectedNode()&&this.getSelectedNode().getGraphic()){if(this.getSelectedNode().getGraphic().connectedToUML2()&&!this.getSelectedNode().isUML2()){this.getSelectedNode().setUid("com.gliffy.shape.uml.uml_v2.class.association");this.__drawOverlay()}else{if(this.getSelectedNode().getGraphic().connectedToBPMN()&&!this.getSelectedNode().isBPMN()){this.getSelectedNode().setUid("com.gliffy.shape.bpmn.bpmn_v1.connectors.normal_sequence_flow");this.__drawOverlay()}else{if(this.getSelectedNode().getGraphic().connectedToERD()&&!this.getSelectedNode().isERD()){this.getSelectedNode().setUid("com.gliffy.shape.erd.erd_v1.default.one");this.__drawOverlay()}}}}GliffyApp.lineOverlayModel.update(this);GliffyApp.contextualPropertiesController.showControls(this);this.__overlayHighlight.addClass("hidden");this.unhighlightConnectionPoints();$(".gliffy-stage").removeClass("gliffy-line-control-drag")},__startModifyLine:function(){var node=this.getSelectedNode();this.__documentManager.pushCommandBundle();if(node!==null){node.getGraphic().editable.allowComputeBestPath=true;this.__modifyLineCommand=new _gliffy.ModifyLineCommand({node:this.getSelectedNode()});this.__documentManager.addAndExecuteCommand(this.__modifyLineCommand)}},__endModifyLine:function(){if(this.__modifyLineCommand!==null){this.__modifyLineCommand.takeSnapShot(this.__documentManager.getActiveStage());this.__modifyLineCommand=null}this.__documentManager.popCommandBundle()},move:function(delta){var node=this.getSelectedNode();delta=delta||_gliffy.Mouse.getDelta();this.__documentManager.addAndExecuteCommand(new _gliffy.MoveNodeCommand({node:node,x:node.getX()+delta.x,y:node.getY()+delta.y}));this.getSelectedNode().update();this.__slideLineVerticallyMaintainingConnections();this.__drawOverlay()},__setLastTarget:function(){var self=this;this.__lastTarget=this.getSelectedNode().getId();setTimeout(function(){self.__lastTarget=null},self.__editor.overlayManager.getDoubleClickTimeout())},beginInitialDrag:function(event,textChild){var self=this;if(this.getSelectedNode()&&self.__lastTarget===this.getSelectedNode().getId()){self.__lastTarget=null;self.__documentManager.popCommandBundle();self.makeTextEditable({createNew:true})}else{moveThreshold.reset(event);_gliffy.Mouse.lockDragUI("move");self.showConnectionPoints(false);GliffyApp.contextualPropertiesController.hideControls();self.__setLastTarget();if(textChild){self.__textMoverData.currentIndex=textChild.parent.children.indexOf(textChild);this.__textMoverDragStart();_gliffy.Mouse.beginInitialDrag("line-overlay","line-text-adjustment")}else{_gliffy.Mouse.beginInitialDrag("line-overlay","line-move");self.__resetTextMovers();self.__startSlide()}self.__textMoverData.checkForDbl=true;setTimeout(function(){self.__textMoverData.checkForDbl=false},self.__editor.overlayManager.getDoubleClickTimeout())}},simulateControlDrag:function(idx,stageCoords,type){var jControl=this.__overlayControl[idx];switch(type){case"start":this.__controlDragStart(jControl);break;case"end":this.__controlDragEnd();break;default:this.__controlDrag(jControl,stageCoords)}},__registerEvents:function(){var self=this;_gliffy.KeyManager.registerState("lineOverlaySelected","default",[{action:"nudgeLeft",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.__nudge(true,true)}},{action:"nudgeRight",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.__nudge(true,false)}},{action:"nudgeUp",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.__nudge(false,true)}},{action:"cut",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.doCut()}},{action:"copy",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.doCopy()}},{action:"paste",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.doPaste()}},{action:"delete",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.doDelete()}},{action:"nudgeDown",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.__nudge(false,false)}},{action:"enterRTE",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.makeTextEditable()}},{action:"jumpStageLeft",keydown:function(e){e.stopImmediatePropagation();e.preventDefault()}},{action:"jumpStageRight",keydown:function(e){e.stopImmediatePropagation();e.preventDefault()}},{action:"jumpStageUp",keydown:function(e){e.stopImmediatePropagation();e.preventDefault()}},{action:"jumpStageDown",keydown:function(e){e.stopImmediatePropagation();e.preventDefault()}},{action:"sendBack",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();GliffyApp.toolbarController.doSendToBack();return false},keypress:function(ev){return false},keyup:function(ev){return false}},{action:"sendFront",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();GliffyApp.toolbarController.doBringToFront();return false},keypress:function(ev){return false},keyup:function(ev){return false}},{keypress:function(ev){if(!_gliffy.KeyManager.isControlKey(ev)&&self.isActive()){ev.stopImmediatePropagation();self.makeTextEditable({keyEvent:ev})}}}]);this.__eventsRegistered=true},__getNudgeAmount:function(){return this.isSnapEnabled()?this.__snapPixels:1},__nudge:function(xAxis,negative){var nudge=this.__getNudgeAmount(),viewPort=this.__documentManager.getActiveStageViewPort(),viewportDimension,node=this.getSelectedNode();if(negative){nudge*=-1}if(xAxis){this.move(new _gliffy.Vec2(nudge,0))}else{this.move(new _gliffy.Vec2(0,nudge))}if(node){if(xAxis){if(viewPort.max.x<node.worldAabb.max.x+nudge*2||(negative&&viewPort.min.x>node.worldAabb.min.x+nudge*2)){viewportDimension=viewPort.getDimension();this.__documentManager.getActiveStage().offsetPan(-nudge,0,viewportDimension.x,viewportDimension.y)}}else{if(viewPort.max.y<node.worldAabb.max.y+nudge*2||(negative&&viewPort.min.y>node.worldAabb.min.y+nudge*2)){viewportDimension=viewPort.getDimension();this.__documentManager.getActiveStage().offsetPan(0,-nudge,viewportDimension.x,viewportDimension.y)}}}_gliffy.Mouse.updateOffset();GliffyApp.contextualPropertiesController.updateControlsPosition(this)},showConnectionPoints:function(show){var stage=this.__documentManager.target.find(".gliffy-stage");if(stage.find(".gliffy-line-overlay-highlight").length===0){stage.append(this.__overlayHighlight)}this.__connectionPointsActive=show;if(show){stage.addClass("gliffy-connections-active");if(this.__editor.inLineDrawMode()){this.__addConnectionHighlightHandler()}}else{stage.removeClass("gliffy-connections-active");this.__removeConnectionHightlightHandler()}},select:function(node,container){var domStage=container.find(".gliffy-stage"),overlayUnderStage=domStage.find("#gliffy-line-overlay");this.deselect();if(overlayUnderStage.length===0){domStage.append(this.__overlayContainer);this.__overlayControlWidth=this.__overlayControl[0].width();this.__overlayControlHeight=this.__overlayControl[0].height();if(!this.__eventsRegistered){this.__registerEvents()}}this.__overlayContainer.css({display:"inline",width:"0px",height:"0px"});if((node.getGraphic()!==null)&&(node.getGraphic().getClassName()==="Line"||node.getGraphic().getClassName()==="FillLine")){this.__selectedNodeId=node.getId();this.getSelectedNode().getGraphic().setOverlay(true);this.showConnectionPoints(true);this.__drawOverlay()}else{throw new Error("Line overlay is trying to select a non-line.")}_gliffy.KeyManager.setState("lineOverlaySelected");$(window).trigger("gliffy-line-overlay-select-node",[node]);GliffyApp.lineOverlayModel.update(this);GliffyApp.contextualPropertiesController.showControls(this)},deselect:function(){var i;$("#gliffy-line-overlay").css("display","none");GliffyApp.contextualPropertiesController.hideControls();if(this.getSelectedNode()&&this.getSelectedNode().getGraphic()){this.getSelectedNode().getGraphic().setOverlay(false);if(!this.__editor.inLineDrawMode()){this.showConnectionPoints(false)}for(i=0;i<this.__MAX_CONTROL_POINTS;i++){this.__overlayControl[i].css("display","none")}for(i=0;i<this.__MAX_ADJUSTMENT_POINTS;i++){this.__overlayAdjustment[i].css("display","none")}this.__documentManager.redraw()}this.__selectedNodeId=null;$(window).trigger("gliffy-line-overlay-deselect-node")},__resetTextMovers:function(){this.__textMoverData.currentIndex=-1;$(".gliffy-line-overlay-text-adjustment").css("border","")},isActive:function(){return(this.getSelectedNode()!==null)},attachLineToConnectionPoint:function(lineNode,lineIdx,graphicNode,graphicConnectionIdx){var node=this.getSelectedNode();if(lineIdx===0){node.getGraphic().editable.setConnectionStart(graphicNode,graphicConnectionIdx)}else{node.getGraphic().editable.setConnectionEnd(graphicNode,graphicConnectionIdx)}},getContainer:function(){return this.__container},getSelectedNode:function(){return this.__documentManager.getActiveStage().find(this.__selectedNodeId)},detachLineFromConnectionPoint:function(lineNode,lineIdx){var node=this.getSelectedNode();if(lineIdx===0){node.getGraphic().editable.clearConnectionStart()}else{node.getGraphic().editable.clearConnectionEnd()}},__updateControl:function(jqControl){var node=this.getSelectedNode(),globalPos=_gliffy.Mouse.getPosition(),line=node.getGraphic(),opposingPoint,distance,snapDegrees,controlIndex=(jqControl.data("i")===0)?0:line.getControlPointCount()-1;if(!line.isOrtho()){opposingPoint=(controlIndex===0)?line.editable.getWorldEndPoint():line.editable.getWorldStartPoint();distance=(_gliffy.Vec2.distance(globalPos,opposingPoint));if(distance>15){snapDegrees=_gliffy.Utils.SNAP_DEGREES_MULTIPLIER/distance;globalPos=_gliffy.Utils.calculateLineSnap(globalPos,opposingPoint,snapDegrees).point}}line.setWorldControlPoint(controlIndex,globalPos)},__deferredDrawOverlay:function(){var start,end,point,i,line,path,overlayControlHalfWidth,overlayControlHalfHeight,zoom,isLinearLine,node;zoom=this.__documentManager.getActiveStage().getZoom();overlayControlHalfWidth=this.__overlayControlWidth*0.5;overlayControlHalfHeight=this.__overlayControlHeight*0.5;node=this.getSelectedNode();if(node!==null){node.update();line=node.getGraphic();path=line.getWorldControlPath();start=path[0];point=new _gliffy.Vec2(start[0],start[1]);if(this.isNewlyCreatedLine&&this.__editor.inLineDrawMode()&&line.getStartConnection()){this.__overlayControl[0].addClass("hidden")}else{this.__overlayControl[0].css({display:"inline",left:point.x*zoom-overlayControlHalfWidth,top:point.y*zoom-overlayControlHalfHeight})}end=path[path.length-1];point=new _gliffy.Vec2(end[0],end[1]);this.__overlayControl[1].css({display:"inline",left:point.x*zoom-overlayControlHalfWidth,top:point.y*zoom-overlayControlHalfHeight});isLinearLine=line.isLinearLine();for(i=1;i<path.length-2;i++){start=path[i];end=path[i+1];if(this.__isMinAdjustableSegmentLength(start,end)&&!isLinearLine){point=new _gliffy.Vec2((start[0]+end[0])/2,(start[1]+end[1])/2);this.__overlayAdjustment[i-1].css({display:"inline",left:point.x*zoom-overlayControlHalfWidth,top:point.y*zoom-overlayControlHalfHeight});if(start[0]===end[0]){_gliffy.CursorManager.setCursor("w-resize",this.__overlayAdjustment[i-1])}else{_gliffy.CursorManager.setCursor("n-resize",this.__overlayAdjustment[i-1])}}else{if(i-1<this.__MAX_ADJUSTMENT_POINTS){this.__overlayAdjustment[i-1].css("display","none")}}}i=(path.length-3>0)?path.length-3:0;for(i;i<this.__MAX_ADJUSTMENT_POINTS;i++){this.__overlayAdjustment[i].css("display","none")}this.__renderCardinalityPlaceholders();if(node.hasText()){this.__renderTextMovers(node)}else{for(i=0;i<this.__textMovers.length;i++){this.__textMovers[i].css("display","none")}}}this.__documentManager.redraw()},__isMinAdjustableSegmentLength:function(start,end){if(start[0]===end[0]){return(Math.abs(end[1]-start[1])>5)}else{return(Math.abs(end[0]-start[0])>5)}},redraw:function(){this.__drawOverlay()},__drawOverlay:function(){if(_gliffy.Debug.SKIP_RENDER_LOOP){this.__deferredDrawOverlay()}else{this.__redraw=true}},__setupTextGraphic:function(o){var options=$.extend({},{parentNode:null,tValue:null,cardinality:null,initialText:null,useDefaultText:false},o),node=new _gliffy.Node(),textGraphic=new _gliffy.Text(),tValue=options.tValue||null,parentGraphic=o.parentNode.getGraphic(),defaultText;defaultText=parentGraphic.node.getDefaultTextGraphic();if(o.useDefaultText&&defaultText){textGraphic.fromObject(defaultText.toObject())}textGraphic.setOverflow("both");textGraphic.setValign("middle");if(tValue){textGraphic.setLineTValue(tValue)}if(options.cardinality){textGraphic.setCardinality(options.cardinality)}if(options.initialText){textGraphic.setHTML(options.initialText)}node.setWidth(1);node.setHeight(1);node.setGraphic(textGraphic);node.setOrder("auto");node.setUid(null);if(options.parentNode&&options.parentNode.isLine()&&options.parentNode.children&&options.parentNode.children.length>=1){this.__documentManager.getActiveDocument().getGon().setBetaVersion()}this.__documentManager.addAndExecuteCommand(new _gliffy.AddNodeCommand({node:node,target:options.parentNode,prepend:true}));node.markDirty();return node},editText:function(node,event){var self=this,textGraphic=node.getGraphic();self.__documentManager.redraw(function(){textGraphic.editable.setEditMode(true);textGraphic.editable.focus();if(event!==undefined&&event!==null){textGraphic.editable.setKeyEvent(event)}else{textGraphic.editable.setCursorEnd()}self.__textControl.edit(textGraphic);textGraphic.editable.registerBlurHandler(function(){GliffyApp.contextualPropertiesController.blurRTE(self);textGraphic.editable.setEditMode(false);self.__documentManager.redraw()})})},makeTextEditable:function(o){var self=this,pointArray=[],closestDistanceIndex=0,leastDistanceSq=Number.MAX_VALUE,textCreated=true,node,i,children,curDistance,pathDistance,tValue,child,closestChild,closestDistance,currentDistance,line,options=$.extend({keyEvent:null,createNew:false,node:null,textChild:null},o);node=options.node;if(!node){node=self.getSelectedNode()}if(node.isLine()){children=node.findGraphic(_gliffy.Text);if(options.textChild!==null){child=options.textChild}else{if(options.createNew===true){if(!node.children){node.children=[]}if(node.children&&node.children.length<self.__MAX_LINE_TEXTS){pathDistance=Math.floor(node.getGraphic().getPathLength().totalDistance);if(node.children.length>0){_gliffy.Utils.analyticsEvent("trackEvent",{category:"line",action:"multipleTexts"})}for(i=0;i<pathDistance;i++){line=node.getGraphic();pointArray.push(_gliffy.candash.getPointInPathAtDistance(line.getPointPath(),i,line.getPathLength()))}for(i=0;i<pointArray.length;i++){curDistance=_gliffy.Vec2.squaredDistance(_gliffy.Mouse.getPosition(),pointArray[i]);if(curDistance<leastDistanceSq){closestDistanceIndex=i;leastDistanceSq=curDistance}}tValue=closestDistanceIndex/node.getGraphic().getPathLength().totalDistance;child=self.__setupTextGraphic({parentNode:node,tValue:tValue})}else{textCreated=false}}else{if(children.length===0){child=self.__setupTextGraphic({parentNode:node,useDefaultText:true})}else{if(this.__textMoverData.currentIndex>=0){child=children[this.__textMoverData.currentIndex]}else{closestChild=null;closestDistance=Number.MAX_VALUE;for(i=0;i<children.length;i++){currentDistance=Math.abs(0.5-children[i].getGraphic().getLineTValue());if(currentDistance<closestDistance){closestDistance=currentDistance;closestChild=children[i]}}child=closestChild}}}}if(textCreated){self.editText(child,options.keyEvent);self.deselect();_gliffy.KeyManager.setState("rte")}}},getOverlayBoundingBox:function(){var node=this.getSelectedNode(),boundingBox;if(!node){node=this.__textControl.getLineParent()}if(node){boundingBox=node.worldAabb.clone();return boundingBox}return null},setLineDrawMode:function(lineDrawMode){this.__lineDrawMode=lineDrawMode},inStageViewport:function(){var olBB=this.getOverlayBoundingBox(),stageViewport=this.__documentManager.getActiveStageViewPort();if(olBB&&stageViewport){return olBB.inBoundingBox(stageViewport)}return false},__addConnectionHighlightHandler:function(){var unhighlightFunc,self=this;unhighlightFunc=function(){self.unhighlightConnectionPoints();var connectionInfo=self.__testConnectionEdge(_gliffy.Mouse.getPosition(),true);if(connectionInfo.node){self.__displayHighlight(connectionInfo)}};$(".gliffy-stage").bind("mousemove.gliffyHighlight",function(){unhighlightFunc()});$(".gliffy-stage").bind("mousewheel.gliffyHighlight",function(event){self.__documentManager.redraw(function(){_gliffy.Mouse.updatePosition(event);unhighlightFunc()});self.__documentManager.redraw();return true})},__removeConnectionHightlightHandler:function(){$(".gliffy-stage").unbind("mousemove.gliffyHighlight");$(".gliffy-stage").unbind("mousewheel.gliffyHighlight")},clearContextMenu:function(){return GliffyApp.contextMenuController.clearContextMenu(this.__contextMenu)},getActiveText:function(){var node=this.getSelectedNode();if(this.__textMoverData.currentIndex>=0){if(node.children&&node.children.length>0){return node.children[this.__textMoverData.currentIndex]}}return null},deleteActiveText:function(){var activeText=this.getActiveText(),node=this.getSelectedNode();if(node&&activeText){this.__documentManager.addAndExecuteCommand(new _gliffy.RemoveNodeCommand({node:activeText}));return true}return false},getContextMenuDefinition:function(){var self=this,pushToMenu,pushDivider,contextMenu=[];pushToMenu=function(key,val){var obj={};obj.text=key;obj.action=val.onclick;obj.className=val.className;contextMenu.push(obj)};pushDivider=function(){contextMenu.push({divider:true})};pushToMenu($.i18n._("OVERLAY_CUT"),{onclick:function(menuItem,menu){GliffyApp.toolbarController.doCut()},className:"gliffy-context-menu-item-line-overlay gliffy-context-menu-item-cut"});pushToMenu($.i18n._("OVERLAY_COPY"),{onclick:function(menuItem,menu){GliffyApp.toolbarController.doCopy()},className:"gliffy-context-menu-item-line-overlay gliffy-context-menu-item-copy"});pushToMenu($.i18n._("OVERLAY_PASTE"),{onclick:function(menuItem,menu){_gliffy.Mouse.setLastMouseUpPosition(_gliffy.Mouse.getContextMenuMouseDownPosition());GliffyApp.toolbarController.doPaste()},className:"gliffy-context-menu-item-line-overlay gliffy-context-menu-item-paste"});pushToMenu($.i18n._("OVERLAY_DELETE"),{onclick:function(menuItem,menu){GliffyApp.toolbarController.doDelete()},className:"gliffy-context-menu-item-line-overlay gliffy-context-menu-item-delete"});pushToMenu($.i18n._("EDITOR_STYLE_COPY"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"lineStyleCopyCopy"});GliffyApp.styleCopyController.copyStyle();self.__isStyleCopied=true},className:"gliffy-context-menu-item-line-overlay gliffy-context-menu-style-copy"});pushToMenu($.i18n._("EDITOR_STYLE_PASTE"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"lineStyleCopyPaste"});GliffyApp.styleCopyController.pasteStyle()},className:"gliffy-context-menu-item-line-overlay gliffy-context-menu-style-paste"});pushDivider();pushToMenu($.i18n._("OVERLAY_SEND_TO_FRONT"),{onclick:function(menuItem,menu){GliffyApp.toolbarController.doBringToFront()},className:"gliffy-context-menu-item-line-overlay gliffy-context-menu-item-sendToFront"});pushToMenu($.i18n._("OVERLAY_SEND_TO_BACK"),{onclick:function(menuItem,menu){GliffyApp.toolbarController.doSendToBack()},className:"gliffy-context-menu-item-line-overlay gliffy-context-menu-item-sendToBack"});pushDivider();pushToMenu($.i18n._("OVERLAY_RESET_CONNECTOR_PATH"),{onclick:function(menuItem,menu){var node=self.getSelectedNode();if(node){self.__startModifyLine();node.getGraphic().editable.clearLockSegments();self.__endModifyLine();self.__deferredDrawOverlay()}},className:"gliffy-context-menu-item-line-overlay gliffy-context-menu-item-reset-connector"});return contextMenu.concat(_gliffy.LayersContextMenu.getContextMenuDescriptor())},beforeContextMenuShow:function(menu){var node=this.getSelectedNode(),isOrthoLine=false,styleCopied;_gliffy.Mouse.setContextMenuMouseDownPosition(_gliffy.Mouse.getPosition());if(node){isOrthoLine=node.getGraphic().isOrtho()}styleCopied=(this.__isStyleCopied&&node.supportsStyleCopy());menu.find(".gliffy-context-menu-item-reset-connector").toggle(isOrthoLine);menu.find(".gliffy-context-menu-item-reset-connector").prev().toggle(isOrthoLine);menu.find(".gliffy-context-menu-style-copy").toggle(node.supportsStyleCopy());menu.find(".gliffy-context-menu-style-paste").toggle(styleCopied);_gliffy.LayersContextMenu.beforeContextShow(menu,this.__documentManager.getActiveStage().getLayers(),node)},addCardinality:function(beginEnd){var node=this.getSelectedNode(),initialText='<p style="text-align: center;"><span style="font-family: Arial; font-size: 12px; line-height: 14px;">0..*</span></p>',self=this,child;this.__documentManager.pushCommandBundle();child=this.__setupTextGraphic({parentNode:this.getSelectedNode(),cardinality:beginEnd,initialText:initialText});this.makeTextEditable({textChild:child});this.__documentManager.popCommandBundle();this.__documentManager.redraw(function(){self.__renderTextMovers(node)});this.__documentManager.getActiveDocument().getGon().setBetaVersion();_gliffy.Utils.analyticsEvent("trackEvent",{category:"line",action:"addCardinality"})},removeCardinality:function(){var node=this.getSelectedNode(),self=this,i;this.__documentManager.pushCommandBundle();if(node&&node.children){for(i=node.children.length-1;i>=0;i--){if(node.children[i].getGraphic().isCardinality&&node.children[i].getGraphic().isCardinality()){this.__documentManager.addAndExecuteCommand(new _gliffy.RemoveNodeCommand({node:node.children[i]}))}}}this.__documentManager.popCommandBundle();this.__documentManager.redraw(function(){self.__renderTextMovers(node)})}})}());(function(){_gliffy.QuickConnectionOverlay=_gliffy.AbstractOverlay.extend({__prevMousePos:null,__avoidanceCycles:0,__avoidanceDir:1,__doOverlayDragStartedCheck:false,__originalDraggedNode:null,__isDraggingOrResizing:false,__CLASS_NAME:"MindmapConnectionOverlay",init:function(o){this._super(o)},__buildOverlayHTML:function(){var table='<table cellspacing="0" cellpadding="0"><tr class="gliffy-qc-overlay-top-row"><td class="gliffy-qc-overlay-left-col"></td><td class="gliffy-qc-overlay-mid-col"><div class="gliffy-qc-overlay-arrow-up gliffy-icon-icn-chevron-up-grey"></div></td><td class="gliffy-qc-overlay-right-col"></td></tr><tr class="gliffy-qc-overlay-middle-row"><td class="gliffy-qc-overlay-left-col"><div class="gliffy-qc-overlay-arrow-left gliffy-icon-icn-chevron-left-grey"></div></td><td class="gliffy-qc-overlay-mid-col"></td><td class="gliffy-qc-overlay-right-col"><div class="gliffy-qc-overlay-arrow-right gliffy-icon-icn-chevron-right-grey"></div></td></tr><tr class="gliffy-qc-overlay-bottom-row"><td class="gliffy-qc-overlay-left-col"></td><td class="gliffy-qc-overlay-mid-col"><div class="gliffy-qc-overlay-arrow-down gliffy-icon-icn-chevron-down-grey"></div></td><td class="gliffy-qc-overlay-right-col"></td></tr></table>',mindmapCollapsible='<div class="gliffy-icon-node-collapsible gliffy-mindmap-collapse-button"></div>';this.__overlayContainer=$('<div id="gliffy-qc-overlay" />');this.__overlayContainer.css("display","none");this.__overlayOutline=$('<div class="gliffy-qc-overlay-outline"/>');this.__overlayOutline.append(table);this.__overlayContainer.append(this.__overlayOutline);this.__overlayContainer.append(mindmapCollapsible)},registerEventListeners:function(){var self=this,mousePos,stage,node,arrow,classList,worldAabb,worldAabbPadding=18,overlayUpdateEvents;this.__overlayOutline.on("mouseout",function(){setTimeout(function(){if(self.__manager.getSelectedNode()!==self.__targetNode){mousePos=_gliffy.Mouse.getPosition();if(self.__targetNode!==null){worldAabb=self.__targetNode.worldAabb.clone();if((mousePos.x<=self.__targetNode.worldAabb.min.x-worldAabbPadding)||(mousePos.x>=self.__targetNode.worldAabb.max.x+worldAabbPadding)||(mousePos.y<=self.__targetNode.worldAabb.min.y-worldAabbPadding)||(mousePos.y>=self.__targetNode.worldAabb.max.y+worldAabbPadding)){if(self.isDifferentMouseLocation(self.__prevMousePos,mousePos)){self.__prevMousePos=mousePos;self.hide()}}}}},1)});this.__overlayOutline.find("td[class*='gliffy-qc-overlay-arrow'], div[class*='gliffy-qc-overlay-arrow']").on("mouseover",function(e){arrow=$(this),classList=$(this).attr("class").split(/\s+/);$.each(classList,function(index,item){if(item.indexOf("-grey")>0){arrow.removeClass(item);arrow.addClass(item.substring(0,item.length-5)+"-blue")}})}).on("mouseout",function(e){arrow=$(this),classList=$(this).attr("class").split(/\s+/);$.each(classList,function(index,item){if(item.indexOf("-blue")>0){arrow.removeClass(item);arrow.addClass(item.substring(0,item.length-5)+"-grey")}})});$("#gliffy").on("mouseover",".gliffy-qc-overlay-arrows-viewbox",function(e){self.doMouseOver(e)});$("#gliffy").on("mouseover",".gliffy-qc-overlay-arrows-canvas",function(e){self.doMouseOver(e)});this.__manager.getContainer().on("gliffy-overlay-shape-resize-dragStart",function(e){self.__isDraggingOrResizing=true;self.hide()});this.__manager.getContainer().on("gliffy-overlay-shape-resize-dragEnd",function(e){self.__isDraggingOrResizing=false;self.show(self.__manager.getSelectedNode(),self.__container)});this.__manager.getContainer().on("gliffy-overlay-shape-overlay-dragStart",function(e){if(self.__manager.getSelectedNode()&&self.__manager.getSelectedNode().isMindmap()&&!_gliffy.KeyManager.shiftKeyDown){self.__doOverlayDragStartedCheck=true;self.__selectRelatedNodesOnDragStart()}self.__isDraggingOrResizing=true;self.hide()});this.__manager.getContainer().on("gliffy-overlay-shape-overlay-dragEnd",function(e){self.__doOverlayDragStartedCheck=false;if(self.__originalDraggedNode){self.__deselectRelatedNodesOnDragEnd()}self.__isDraggingOrResizing=false;self.show(self.__manager.getSelectedNode(),self.__container)});this.__manager.getContainer().on("gliffy-contextual-properties-close",function(e){self.show(self.__manager.getSelectedNode(),self.__container)});$(window).bind("rte-resize.gliffy-edit-text",function(event){self.show(self.__targetNode,self.__container)});this.__manager.getContainer().on("scrollEnd",function(){self.show(self.__targetNode,self.__container)});this.__overlayContainer.find(".gliffy-mindmap-collapse-button").on("mousedown",function(e){e.preventDefault();self.handleMindmapCollapseButtonClick()});var overlayUpdateEvents=["gliffy-overlay-manager-update-x","gliffy-overlay-manager-update-y","gliffy-overlay-manager-update-width","gliffy-overlay-manager-update-height"].join(" ");this.__manager.getContainer().on(overlayUpdateEvents,function(e){setTimeout(function(e){self.show(self.__manager.getSelectedNode(),self.__container)},2)})},__selectRelatedNodesOnDragStart:function(){var self=this;if(this.__doOverlayDragStartedCheck){setTimeout(function(){if(self.__manager.overlay.isDragging&&self.__manager.getSelectedNode()){self.__originalDraggedNode=self.__manager.getSelectedNode();self.__manager.selectNodes(self.getMindmapGraphic(self.__manager.getSelectedNode()).getChildrenNodes().concat([self.__manager.getSelectedNode()]));self.__manager.overlay.updateDragOffset();self.hide();self.__doOverlayDragStartedCheck=false}else{self.__selectRelatedNodesOnDragStart()}},5)}},__deselectRelatedNodesOnDragEnd:function(){this.__manager.deselectAll();if(this.__originalDraggedNode){this.__manager.selectNodes([this.__originalDraggedNode]);this.__originalDraggedNode=null}},doMouseOver:function(e){var stage=this.__documentManager.getActiveStage(),node=stage.find(/\d+/.exec(e.currentTarget.id)[0]),mousePos=_gliffy.Mouse.getPosition();if(node&&this.__editor.getDrawMode()===_gliffy.Editor.DRAW_MODE.none){node=node.getRootParent();if(node.isSelectable()&&this.isDifferentMouseLocation(this.__prevMousePos,mousePos)){this.__prevMousePos=mousePos;this.show(node,this.__container)}}},isDifferentMouseLocation:function(previousMousePosition,mousePosition){return(previousMousePosition===null||!_gliffy.Coordinate.equals(previousMousePosition,mousePosition))},getMindmapGraphic:function(node){return node.findGraphic(_gliffy.Mindmap)[0].getGraphic()},show:function(node,container){if(!this.__isDraggingOrResizing){var domStage=container.find(".gliffy-stage"),overlayUnderStage=domStage.find("#gliffy-qc-overlay"),buttonPadding=28;if(node&&node.getShapeInformation()&&node.getShapeInformation().quickConnectionOverlay){if(overlayUnderStage.length===0){domStage.append(this.__overlayContainer);if(!this.__eventsRegistered){this.__registerArrowMouseEvents();this.__registerKeyEvents()}}this.__overlayContainer.css({display:"inline",width:"150px",height:"90px"});this.__targetNode=node;this.positionAndResize({node:node,container:this.__overlayOutline,padding:buttonPadding});if(node.isMindmap()){this.updateCollapseButtonPosition(node,buttonPadding)}if(!$("#gliffy-edit-text_ifr").is(":visible")){this.applyKeyManagerState()}if(this.__manager.getSelectedNode()&&this.__manager.getSelectedNode().getId()===this.__targetNode.getId()){GliffyApp.contextualPropertiesController.showControls(this.__manager.overlay)}}}},updateCollapseButtonPosition:function(node,buttonPadding){var mindmapCollapseButton=this.__overlayContainer.find(".gliffy-mindmap-collapse-button"),mindmapGraphic=this.getMindmapGraphic(node);if(mindmapCollapseButton.length>0){mindmapCollapseButton.css("display","none");if(mindmapGraphic.getChildNodeIds().length>0){mindmapCollapseButton.css("left",(parseFloat(this.__overlayOutline.css("left"))||0)+this.__overlayOutline.width()/2-mindmapCollapseButton.width()/2+1);mindmapCollapseButton.css("top",(parseFloat(this.__overlayOutline.css("top"))||0)+this.__overlayOutline.height()-mindmapCollapseButton.height()/2-buttonPadding);mindmapCollapseButton.css("display","inline-block")}this.__updateCollapseButtonUI(mindmapCollapseButton,mindmapGraphic)}},__updateCollapseButtonUI:function(domElem,mindmapGraphic){if(mindmapGraphic.isCollapsed){domElem.removeClass("gliffy-icon-node-collapsible");domElem.addClass("gliffy-icon-node-collapsed")}else{domElem.addClass("gliffy-icon-node-collapsible");domElem.removeClass("gliffy-icon-node-collapsed")}},applyKeyManagerState:function(){if(this.__targetNode){setTimeout(function(){_gliffy.KeyManager.setState("qc-overlay")},1)}},hide:function(){$("#gliffy-qc-overlay").css("display","none");this.__targetNode=null},__registerArrowMouseEvents:function(){var self=this,$this,pos,mag;_gliffy.Mouse.registerClickState({name:"qc-overlay",modes:["quick-connect"],target:".gliffy-qc-overlay-arrow-up,.gliffy-qc-overlay-arrow-left,.gliffy-qc-overlay-arrow-right,.gliffy-qc-overlay-arrow-down",mouseDown:function(event){pos=_gliffy.Mouse.getPosition();mag=1;event.stopPropagation();$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text",{skipSaveToDocument:false});_gliffy.Mouse.setClickMode("qc-overlay");$this=$(event.currentTarget);_gliffy.Mouse.setState("quick-connect");if($this.hasClass("gliffy-qc-overlay-arrow-up")){self.__drawLine(null,{x:0,y:-mag});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"arrowMouseClick",label:"up"})}else{if($this.hasClass("gliffy-qc-overlay-arrow-left")){self.__drawLine(null,{x:-mag,y:0});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"arrowMouseClick",label:"left"})}else{if($this.hasClass("gliffy-qc-overlay-arrow-right")){self.__drawLine(null,{x:mag,y:0});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"arrowMouseClick",label:"right"})}else{if($this.hasClass("gliffy-qc-overlay-arrow-down")){self.__drawLine(null,{x:0,y:mag});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"arrowMouseClick",label:"down"})}}}}_gliffy.Mouse.__mousedown(event)}})},__registerKeyEvents:function(){var self=this;_gliffy.KeyManager.registerState("qc-overlay","default",[{action:"delete",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();self.handleDelete(e);_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"deleteNode"})}},{action:"cut",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.doCut()}},{action:"copy",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.doCopy()}},{action:"paste",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();GliffyApp.toolbarController.doPaste()}},{action:"jumpStageRight",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.handleJumpStageRight(self.__targetNode)}},{action:"jumpStageDown",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.handleJumpStageDown(self.__targetNode)}},{action:"jumpStageLeft",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.handleJumpStageLeft(self.__targetNode)}},{action:"jumpStageUp",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.handleJumpStageUp(self.__targetNode)}},{action:"nudgeDown",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.handleNudgeDown(self.__targetNode)}},{action:"nudgeLeft",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.handleNudgeLeft(self.__targetNode)}},{action:"nudgeUp",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.handleNudgeUp(self.__targetNode)}},{action:"nudgeRight",keydown:function(ev){ev.stopImmediatePropagation();ev.preventDefault();self.handleNudgeRight(self.__targetNode)}},{keypress:function(ev){if(!_gliffy.KeyManager.isControlKey(ev)){ev.stopImmediatePropagation();self.makeTextEditable(ev)}}}])},makeTextEditable:function(o){this.__manager.overlay.makeTextEditable(o)},handleDelete:function(e){GliffyApp.toolbarController.doDelete()},handleTab:function(e,node){this.__manager.selectNodes([node])},handleMindmapCollapseButtonClick:function(){var targetNode=this.__targetNode,mindmapGraphic;if(targetNode&&targetNode.isMindmap()){mindmapGraphic=this.getMindmapGraphic(targetNode);if(!mindmapGraphic.isCollapsed){this.__collapseNodes(targetNode);mindmapGraphic.isCollapsed=true}else{this.__expandNodes(targetNode,false);mindmapGraphic.isCollapsed=false}this.__updateCollapseButtonUI(this.__overlayContainer.find(".gliffy-mindmap-collapse-button"),mindmapGraphic);this.__editor.getDocumentManager().redraw()}},__collapseNodes:function(targetNode){var mindmapGraphic,subNodesAndLines,i;if(targetNode&&targetNode.isMindmap()){mindmapGraphic=this.getMindmapGraphic(targetNode);if(!mindmapGraphic.isCollapsed){subNodesAndLines=mindmapGraphic.getChildrenNodes({includeConnectedLines:true});for(i=0;i<subNodesAndLines.length;i++){subNodesAndLines[i].setHidden(true)}}}},__expandNodes:function(targetNode,expandAll){var mindmapGraphic,subNodesAndLines,i,elem=this.__overlayContainer.find(".gliffy-mindmap-collapse-button");if(targetNode&&targetNode.isMindmap()){mindmapGraphic=this.getMindmapGraphic(targetNode);if(expandAll||mindmapGraphic.isCollapsed){elem.addClass("gliffy-icon-node-collapsible");elem.removeClass("gliffy-icon-node-collapsed");subNodesAndLines=mindmapGraphic.getChildrenNodes({includeConnectedLines:true,excludeCollapsed:!expandAll});for(i=0;i<subNodesAndLines.length;i++){if(subNodesAndLines[i].isMindmap()&&expandAll){this.getMindmapGraphic(subNodesAndLines[i]).isCollapsed=false}subNodesAndLines[i].setHidden(false)}if(expandAll){mindmapGraphic.isCollapsed=false}}}},handleNudgeRight:function(node){var self=this;if(node&&node.isMindmap()){setTimeout(function(){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");self.__manager.selectNodes([node]);if(_gliffy.KeyManager.tabKeyDown&&self.selectParent()){self.__drawLine(null,{x:1,y:0});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"keyAddSibling",label:"right"})}else{self.navigate({x:1,y:0});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"keyNavigate",label:"right"})}},1)}},handleNudgeLeft:function(node){if(node&&node.isMindmap()){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");this.__manager.selectNodes([node]);if(_gliffy.KeyManager.tabKeyDown&&this.selectParent()){this.__drawLine(null,{x:-1,y:0});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"keyAddSibling",label:"left"})}else{this.navigate({x:-1,y:0});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"keyNavigate",label:"left"})}}},handleNudgeUp:function(node){if(node&&node.isMindmap()){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");this.__manager.selectNodes([node]);if(_gliffy.KeyManager.tabKeyDown&&this.selectParent()){this.__drawLine(null,{x:0,y:-1});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"keyAddSibling",label:"up"})}else{this.navigate({x:0,y:-1});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"keyNavigate",label:"up"})}}},handleNudgeDown:function(node){if(node&&node.isMindmap()){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");this.__manager.selectNodes([node]);if(_gliffy.KeyManager.tabKeyDown&&this.selectParent()){this.__drawLine(null,{x:0,y:1});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"keyAddSibling",label:"down"})}else{this.navigate({x:0,y:1});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"keyNavigate",label:"down"})}}},handleJumpStageUp:function(node){if(node&&node.isMindmap()){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");this.__manager.selectNodes([node]);this.__drawLine(null,{x:0,y:-1});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"keyAddChild",label:"up"})}},handleJumpStageLeft:function(node){if(node&&node.isMindmap()){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");this.__manager.selectNodes([node]);this.__drawLine(null,{x:-1,y:0});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"keyAddChild",label:"left"})}},handleJumpStageDown:function(node){if(node&&node.isMindmap()){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");this.__manager.selectNodes([node]);this.__drawLine(null,{x:0,y:1});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"keyAddChild",label:"down"})}},handleJumpStageRight:function(node){var self=this;if(node&&node.isMindmap()){setTimeout(function(){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");self.__manager.selectNodes([node]);self.__drawLine(null,{x:1,y:0});_gliffy.Utils.analyticsEvent("trackEvent",{category:self.__CLASS_NAME,action:"keyAddChild",label:"right"})},10)}},navigate:function(vec){var targetNode=this.__targetNode,searchBoundingBox,allNodes=this.__editor.getDocumentManager().getActiveStage().objects,nodesInSearchBoundingBox,tempNode,tempNodeCenterPoint,targetNodeCenterPoint,previousMin=99999999,closestNode=null,hypotenuse=0,i,xoffset=0,yoffset=0;if(targetNode&&targetNode.isMindmap()){if(vec.x!==0){xoffset=targetNode.getWidth()/2*vec.x}else{yoffset=targetNode.getHeight()/2*vec.y}searchBoundingBox=this.__calculateSearchBoundingBox(vec,targetNode);nodesInSearchBoundingBox=_gliffy.Pick.pickAllNodesInside(allNodes,searchBoundingBox);targetNodeCenterPoint=targetNode.getCenterPosition();for(i=0;i<nodesInSearchBoundingBox.length;i++){tempNode=nodesInSearchBoundingBox[i];if(tempNode.isMindmap()){tempNodeCenterPoint=tempNode.getCenterPosition();hypotenuse=Math.pow(((tempNodeCenterPoint.x-xoffset)-(targetNodeCenterPoint.x+xoffset)),2)+Math.pow(((tempNodeCenterPoint.y-yoffset)-(targetNodeCenterPoint.y+yoffset)),2);if(hypotenuse<previousMin){closestNode=tempNode;previousMin=hypotenuse}}}this.selectNode(closestNode)}},__calculateSearchBoundingBox:function(vec,targetNode){var boundingBox=new _gliffy.BoundingBox(),width=2000,height=2000;if(vec.x===1&&vec.y===0){boundingBox.min.x=targetNode.worldAabb.max.x;boundingBox.min.y=targetNode.worldAabb.min.y-height/2;boundingBox.max.x=targetNode.worldAabb.max.x+width;boundingBox.max.y=targetNode.worldAabb.max.y+height/2}else{if(vec.x===-1&&vec.y===0){boundingBox.min.x=targetNode.worldAabb.min.x-width;boundingBox.min.y=targetNode.worldAabb.min.y-height/2;boundingBox.max.x=targetNode.worldAabb.min.x;boundingBox.max.y=targetNode.worldAabb.max.y+height/2}else{if(vec.x===0&&vec.y===1){boundingBox.min.x=targetNode.worldAabb.min.x-width/2;boundingBox.min.y=targetNode.worldAabb.max.y;boundingBox.max.x=targetNode.worldAabb.max.x+width/2;boundingBox.max.y=targetNode.worldAabb.max.y+height}else{if(vec.x===0&&vec.y===-1){boundingBox.min.x=targetNode.worldAabb.min.x-width/2;boundingBox.min.y=targetNode.worldAabb.min.y-height;boundingBox.max.x=targetNode.worldAabb.max.x+width/2;boundingBox.max.y=targetNode.worldAabb.min.y}}}}return boundingBox},selectParent:function(){var childNode=this.__targetNode,childGraphic,stage=this.__editor.getDocumentManager().getActiveStage(),parentNode;if(childNode){childGraphic=this.getMindmapGraphic(childNode);if(childGraphic.getParentNodeId()!==undefined&&childGraphic.getParentNodeId()!==null){parentNode=stage.find(childGraphic.getParentNodeId());this.selectNode(parentNode)}}return parentNode},selectNode:function(node){if(node){this.__manager.selectNodes([node]);if(!_gliffy.Pick.isNodeInside(node,this.__editor.getDocumentManager().getActiveStageViewPort())){this.__centerOnStage(node)}}},__drawLine:function(startPoint,epVec){var lineNode,endPoint,shapeNode,ratio,i,connPointIdx,strokeTextColor,sendLineToBack=false,stage=this.__documentManager.getActiveStage(),sourceNode=this.__targetNode,sourceNodeObj;if(sourceNode&&sourceNode.isMindmap()){this.__expandNodes(sourceNode,true);this.getMindmapGraphic(sourceNode).isCollapsed=false}if(startPoint===null||startPoint==="undefined"){startPoint=sourceNode.getCenterPosition();sendLineToBack=true}this.__avoidanceCycles=0;endPoint=this.__findOptimalEndPoint(stage,epVec,startPoint,{x:0,y:0});if(endPoint){this.__documentManager.pushCommandBundle();connPointIdx=sourceNode.getClosestConnectionPoint(startPoint);ratio=sourceNode.getConnectionPointRatio(connPointIdx);strokeTextColor=this.getStrokeTextColor();lineNode=this.__buildLineNode({strokeTextColor:strokeTextColor,startPoint:startPoint,endPoint:endPoint,ratio:ratio});this.__documentManager.addAndExecuteCommand(new _gliffy.AddNodeCommand({node:lineNode}));sourceNodeObj=sourceNode.toObject();shapeNode=this.__buildShapeNode({targetNodeObj:sourceNodeObj,strokeTextColor:strokeTextColor,endPoint:endPoint});lineNode.getGraphic().setEndConnection(shapeNode,this.__getDestinationConnectionPointRatio(startPoint,sourceNode,shapeNode));this.__documentManager.addAndExecuteCommand(new _gliffy.ModifyLineCommand({node:lineNode}));this.__documentManager.popCommandBundle();if(sendLineToBack){stage.sendToBack(lineNode)}this.__manager.selectNode(shapeNode);if(!_gliffy.Pick.isNodeInside(shapeNode,this.__editor.getDocumentManager().getActiveStageViewPort())){this.__centerOnStage(shapeNode)}else{this.__targetNode=this.__manager.overlay.getSelectedNode();this.show(this.__targetNode,this.__container)}}},__centerOnStage:function(node){var self=this;$.when(this.__editor.getDocumentManager().centerOnStage(node)).then(function(){self.__targetNode=self.__manager.overlay.getSelectedNode();setTimeout(function(){self.show(self.__targetNode,self.__container)},1)})},getStrokeTextColor:function(){var strokeTextColor="#000000",stage=this.__editor.getDocumentManager().getActiveStage(),options,rootNode,graphic;if(this.__targetNode){if(this.__targetNode.isMindmap()){graphic=this.getMindmapGraphic(this.__targetNode);strokeTextColor=graphic.getStrokeColor();options={defaultColor:graphic.getStrokeColor(),targetNode:this.__targetNode,colorPalette:graphic.getColorPalette()};if(graphic.getColorScheme()===_gliffy.MINDMAP_COLOR_SCHEME_GENERATION){if(this.__isRootNode(this.__targetNode)){options.treeDepth=0}else{rootNode=stage.find(graphic.getRootNodeId());options.targetNode=rootNode;options.treeDepth=graphic.getTreeDepth();options.colorPalette=this.getMindmapGraphic(rootNode).getColorPalette()}strokeTextColor=this.__getNextColor(options)}else{if(this.__isRootNode(this.__targetNode)){strokeTextColor=this.__getNextColor(options)}}}}return strokeTextColor},__getNextColor:function(options){var i,color=options.defaultColor,colorPalette,childNodeIds,targetNode=options.targetNode,graphic;if(targetNode){colorPalette=options.colorPalette;if(colorPalette){graphic=this.getMindmapGraphic(targetNode);if(graphic.getColorScheme()===_gliffy.MINDMAP_COLOR_SCHEME_GENERATION){color=colorPalette[options.treeDepth%colorPalette.length]}else{childNodeIds=graphic.getChildNodeIds();color=colorPalette[childNodeIds.length%colorPalette.length]}}}return color},__getLineEndPoint:function(vec,offset){var endPoint={};endPoint.x=(this.__targetNode.getWidth()+100)*vec.x+offset.x;endPoint.y=(this.__targetNode.getHeight()+100)*vec.y+offset.y;return endPoint},__findOptimalEndPoint:function(stage,epVec,startPoint,offset){var i,tempPickNodes,endPoint,pickNodes=[],absX,absY;endPoint=this.__getLineEndPoint(epVec,offset);absX=startPoint.x+endPoint.x;absY=startPoint.y+endPoint.y;tempPickNodes=_gliffy.Pick.pickAllNodesAt(stage.objects,absX,absY);for(i=0;i<tempPickNodes.length;i++){if(tempPickNodes[i].isShape()){pickNodes.push(tempPickNodes[i])}}if(pickNodes.length>0){endPoint=this.__findNewEndPointAndUpdateAvoidanceData(stage,offset,epVec,startPoint)}if(absX<0||absY<0||absX>Number(stage.maxWidth)||absY>Number(stage.maxHeight)){endPoint=this.__findNewEndPointAndUpdateAvoidanceData(stage,offset,epVec,startPoint)}return endPoint},__findNewEndPointAndUpdateAvoidanceData:function(stage,offset,epVec,startPoint){var endPoint,avoidanceStep,AVOIDANCE_DISTANCE=25,AVOIDANCE_CYCLE_LIMIT=20;this.__avoidanceCycles++;if(epVec.x!==0){avoidanceStep=this.__targetNode.getHeight();offset.y=offset.y+this.__avoidanceDir*this.__avoidanceCycles*(avoidanceStep+AVOIDANCE_DISTANCE)}else{avoidanceStep=this.__targetNode.getWidth();offset.x=offset.x+this.__avoidanceDir*this.__avoidanceCycles*(avoidanceStep+AVOIDANCE_DISTANCE)}this.__avoidanceDir=this.__avoidanceDir*-1;if(this.__avoidanceCycles<=AVOIDANCE_CYCLE_LIMIT){endPoint=this.__findOptimalEndPoint(stage,epVec,startPoint,offset)}return endPoint},__buildShapeNode:function(o){var shapeNode,self=this,parentNode=this.__targetNode,parentNodeId=parentNode.getId(),stage=this.__documentManager.getActiveStage();if(parentNode.isMindmap()){shapeNode=this.__buildMindmapNode(o)}else{shapeNode=new _gliffy.Node().fromObject(o.targetNodeObj)}shapeNode.setX(parentNode.getX()+o.endPoint.x);shapeNode.setY(parentNode.getY()+o.endPoint.y);this.__documentManager.addAndExecuteCommand(new _gliffy.AddCopyNodeCommand({node:shapeNode}));this.__documentManager.redraw();return shapeNode},__buildMindmapNode:function(o){var shapeNode=new _gliffy.Node(),pos={},params,treeDepth,schemeData,parentGraphic,childGraphic;parentGraphic=this.getMindmapGraphic(this.__targetNode);treeDepth=parentGraphic.getTreeDepth();schemeData=_gliffy.MINDMAP_SCHEME_NODE_TREE[parentGraphic.getColorScheme()];if(treeDepth<schemeData.length-1){pos.x=this.__targetNode.getX()+o.endPoint.x;pos.y=this.__targetNode.getY()+o.endPoint.y;params={uid:schemeData[treeDepth+1].uid};this.__editor.drawManager.setupShape(shapeNode,params,pos,false);childGraphic=this.getMindmapGraphic(shapeNode);childGraphic.setStrokeColor(o.strokeTextColor);if(schemeData[treeDepth+1].fill==="line"){childGraphic.setFillColor(o.strokeTextColor)}else{childGraphic.setFillColor("#FFFFFF")}}else{shapeNode=new _gliffy.Node().fromObject(o.targetNodeObj);childGraphic=this.getMindmapGraphic(shapeNode);if(parentGraphic.getColorScheme()===_gliffy.MINDMAP_COLOR_SCHEME_GENERATION){childGraphic.setStrokeColor(o.strokeTextColor)}}if(this.__isRootNode(this.__targetNode)){childGraphic.setRootNodeId(this.__targetNode.getId())}else{childGraphic.setRootNodeId(parentGraphic.getRootNodeId())}childGraphic.setTreeDepth(parentGraphic.getTreeDepth()+1);childGraphic.setParentNodeId(this.__targetNode.getId());childGraphic.setColorScheme(parentGraphic.getColorScheme());return shapeNode},__buildLineNode:function(o){var lineNode,lineGraphic=new _gliffy.Line();lineGraphic.setStrokeWidth(2);if(this.__isRootNode(this.__targetNode)){lineGraphic.setStrokeWidth(3)}lineGraphic.setStrokeColor(o.strokeTextColor);lineGraphic.setControlPath([[o.startPoint.x,o.startPoint.y],[o.startPoint.x+o.endPoint.x,o.startPoint.y+o.endPoint.y]]);lineNode=new _gliffy.Node();lineNode.setUid("com.gliffy.shape.basic.basic_v1.default.line");lineNode.setGraphic(lineGraphic);lineNode.getGraphic().setStartConnection(this.__targetNode,o.ratio);return lineNode},__isRootNode:function(node){return(node&&node.getShapeInformation()&&node.getShapeInformation().isRootNode)},__getDestinationConnectionPointRatio:function(sourcePoint,sourceNode,destinationNode){var destinationPoint,connPointIdx,ratio;destinationPoint=destinationNode.getCenterPosition();connPointIdx=destinationNode.getClosestConnectionPoint(destinationPoint);ratio=destinationNode.getConnectionPointRatio(connPointIdx);return ratio},__getRandomColor:function(brightness){function randomChannel(brightness){var r=255-brightness;var n=0|((Math.random()*r)+brightness);var s=n.toString(16);return(s.length==1)?"0"+s:s}return"#"+randomChannel(brightness)+randomChannel(brightness)+randomChannel(brightness)}})}());(function(){_gliffy.TableOverlay=_gliffy.AbstractOverlay.extend({__selectedCells:null,__colsBoundingBoxArray:null,__rowsBoundingBoxArray:null,__uidHeaderPosition:null,__CLASS_NAME:"TableOverlay",init:function(o){this._super(o);this.__selectedCells=[];this.__colsBoundingBoxArray=[];this.__rowsBoundingBoxArray=[];this._setupDragManager();this.__uidHeaderPosition={"com.gliffy.shape.table.table_v2.default.table_horizontal_title_three_by_two":{y:0,x:-1},"com.gliffy.shape.table.table_v2.default.table_horizontal_and_vertical_title_three_by_two":{y:0,x:0},"com.gliffy.shape.table.table_v2.default.table_vertical_title_three_by_two":{y:-1,x:0}}},_setupDragManager:function(){var domElement,initialDomElementPosition,node,overlay,self,stage,position;self=this;_gliffy.Mouse.registerClickState({name:"tableOverlayResizeX",modes:["table-resize-x-cells"],target:".gliffy-table-resize-overlay-control-x",mouseDown:function(event){event.stopPropagation();_gliffy.Mouse.setClickMode("tableOverlayResizeX");domElement=$(event.currentTarget);if(domElement.hasClass("gliffy-table-resize-overlay-control-x")){node=self.__editor.overlayManager.getSelectedNode();if(node instanceof _gliffy.Node){stage=node.stage;_gliffy.Mouse.setState("table-resize-x-cells")}}_gliffy.Mouse.__mousedown(event)}});_gliffy.Mouse.registerDragState([{modes:["table-resize-x-cells"],dragStart:function(event){GliffyApp.contextualPropertiesController.hideControls();self.__documentManager.pushCommandBundle()},drag:function(event){var newNode,mousePositionOnStage,nodeIds,selectedNode=GliffyApp.contextualPropertiesController.getTargetNode();self.deselectTableParts();mousePositionOnStage=_gliffy.Mouse.getPosition();nodeIds=domElement[0].dataset.attrIds.split(",");if(mousePositionOnStage.x>1){initialDomElementPosition=node.getPosition();newNode=stage.find(nodeIds[0]);position=newNode.getPosition();self.__documentManager.addAndExecuteCommand(new _gliffy.TableResizeCommand({editor:self.__editor,selectedNode:selectedNode,node:newNode,width:mousePositionOnStage.x-initialDomElementPosition.x-position.x,type:"width",idArray:self.__getColumnsBoundingBoxArray(selectedNode,self.__getCurrentColumnsCount(selectedNode)),stage:stage}))}},dragEnd:function(event){GliffyApp.contextualPropertiesController.showControls(self.__manager.getActiveOverlay());self.__documentManager.popCommandBundle();_gliffy.Utils.analyticsEvent("trackEvent",{category:"tables",action:"xAxisResize"})},autoPan:true}]);_gliffy.Mouse.registerClickState({name:"tableOverlayResizeY",modes:["table-resize-y-cells"],target:".gliffy-table-resize-overlay-control-y",mouseDown:function(event){event.stopPropagation();_gliffy.Mouse.setClickMode("tableOverlayResizeY");domElement=$(event.currentTarget);if(domElement.hasClass("gliffy-table-resize-overlay-control-y")){node=self.__editor.overlayManager.getSelectedNode();if(node instanceof _gliffy.Node){stage=node.stage;_gliffy.Mouse.setState("table-resize-y-cells")}}_gliffy.Mouse.__mousedown(event)}});_gliffy.Mouse.registerDragState([{modes:["table-resize-y-cells"],dragStart:function(event){GliffyApp.contextualPropertiesController.hideControls();self.__documentManager.pushCommandBundle()},drag:function(event){var newNode,mousePositionOnStage,nodeIds,selectedNode=GliffyApp.contextualPropertiesController.getTargetNode();self.deselectTableParts();mousePositionOnStage=_gliffy.Mouse.getPosition();nodeIds=domElement[0].dataset.attrIds.split(",");if(mousePositionOnStage.y>1){initialDomElementPosition=node.getPosition();newNode=stage.find(nodeIds[0]);position=newNode.getPosition();self.__documentManager.addAndExecuteCommand(new _gliffy.TableResizeCommand({editor:self.__editor,selectedNode:selectedNode,node:newNode,height:mousePositionOnStage.y-initialDomElementPosition.y-position.y,type:"height",idArray:self.__getRowsBoundingBoxArray(selectedNode,self.__getCurrentColumnsCount(selectedNode)),stage:stage}))}},dragEnd:function(event){GliffyApp.contextualPropertiesController.showControls(self.__manager.getActiveOverlay());self.__documentManager.popCommandBundle();_gliffy.Utils.analyticsEvent("trackEvent",{category:"tables",action:"yAxisResize"})},autoPan:true}])},__buildOverlayHTML:function(){this.__overlayContainer=$('<div id="gliffy-table-overlay" />');this.__overlayContainer.css("display","none");this.__overlayOutline=$('<div class="gliffy-table-overlay-outline"/>');_gliffy.CursorManager.setCursor("move",this.__overlayOutline);this.__overlayContainer.append(this.__overlayOutline)},registerEventListeners:function(){var self=this,displayEvents,hideEvents,targetNode,text;displayEvents=["gliffy-overlay-shape-resize-dragEnd","gliffy-overlay-shape-overlay-dragEnd","gliffy-overlay-manager-select-node"].join(" ");hideEvents=["gliffy-overlay-shape-overlay-dragStart","gliffy-overlay-shape-resize-dragStart","gliffy-contextual-properties-close"].join(" ");this.__manager.getContainer().on(hideEvents,function(e){self.hide()});this.__manager.getContainer().on(displayEvents,function(e){self.show(self.__manager.getSelectedNode(),self.__container)});this.__manager.getContainer().on("gliffy-overlay-manager-deselect-all",function(e){self.deselectTableParts();self.hide()});this.__manager.getContainer().on("gliffy-overlay-overlaycontainer-mousedown",function(e){self.deselectTableParts();self.updateTableSelection();self.__manager.getContainer().trigger("gliffy-table-update-selection")});this.__manager.getContainer().on("gliffy-overlay-overlaycontainer-mousedown-shift",function(e){self.updateTableSelection()});$(window).on("rte-resize.gliffy-edit-text",function(event){targetNode=GliffyApp.contextualPropertiesController.getTargetNode();if(targetNode&&targetNode.isTable()){self.show(targetNode,self.__container);self.updateCellHeightFromText(event)}});$(window).bind("rte-remove.gliffy-edit-text",function(event){if(event&&event.node instanceof _gliffy.Node&&event.node.getRootParent().isTable()){setTimeout(function(){text=event.node.getGraphic().getNodeText();if(text&&text.length===1&&text.charCodeAt(0)===160){event.node.parent.removeChild(event.node,true)}},1)}});this.__manager.getContainer().on("scrollEnd",function(){self.show(self.__targetNode,self.__container)})},makeTextEditable:function(event,node){var selectedCell,childNode,parent,textNode,defaultStyle=[],bold=false,parentPosition,uid,positionCheck;selectedCell=this.getSelectedCells();if(selectedCell.length>0){parent=selectedCell[0]}else{parent=node.children[0]}childNode=parent.children[0];if(!childNode){uid=parent.getRootParent().getUid();if(uid&&this.__uidHeaderPosition[uid]){parentPosition=parent.getPosition();positionCheck=this.__uidHeaderPosition[uid];if(parentPosition.x===positionCheck.x){bold=true}else{if(parentPosition.y===positionCheck.y){bold=true}else{bold=false}}}defaultStyle=[{bold:bold,align:"left",paddingTop:3,paddingBottom:3,type:"fixed",underline:false,"font-size":12}];childNode=new _gliffy.Node();textNode=new _gliffy.Text();textNode.setupDefaults(defaultStyle);childNode.setGraphic(textNode);childNode.setWidth(parent.getWidth());childNode.setHeight(parent.getHeight());childNode.setOrder("auto");parent.insertChild(childNode,0)}this.__editor.overlayManager.deselectAll();this.__selectedCells.push(parent);parent.addTableSelectedCellClass();this.__editor.overlayManager.overlay.editText(childNode,event)},updateTableSelection:function(){var self=this,selectedNode=this.__editor.overlayManager.getSelectedNode(),index;if(selectedNode&&selectedNode.isTable()){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");var pos=_gliffy.Mouse.getPosition();var cell=_gliffy.Pick.getNodeAt(selectedNode.children,pos.x,pos.y,{subNodeSelection:true});if(cell&&cell.getGraphic().getClassName()=="Text"){cell=cell.parent}if(cell&&cell.isTableCellSelected()){index=self.overlay.__selectedCells.indexOf(cell);cell.removeTableSelectedCellClass();self.__selectedCells.splice(index,1)}else{if(cell){cell.addTableSelectedCellClass()}self.__selectedCells.push(cell)}self.__documentManager.redraw()}},deselectTableParts:function(){var i;if(this.__selectedCells&&this.__selectedCells.length>0){for(i=0;i<this.__selectedCells.length;i++){if(this.__selectedCells[i]!==null){this.__selectedCells[i].removeTableSelectedCellClass()}}this.__documentManager.redraw()}this.__selectedCells=[]},getSelectedCells:function(){return this.__selectedCells},updateCellHeightFromText:function(event){var cell,topNode;if(event&&event.node&&event.node.parent){cell=event.node.parent;topNode=cell.parent;if(topNode&&topNode.isTable()){if(cell.getHeight()<event.h){this.__editor.getDocumentManager().addAndExecuteCommand(new _gliffy.TableResizeCommand({editor:this.__editor,selectedNode:topNode,node:cell,height:event.h+5,type:"table-text-edit"}))}}}_gliffy.KeyManager.setState("rte");_gliffy.Utils.analyticsEvent("trackEvent",{category:"tables",action:"updateHeightFromText"})},show:function(node,container){var self=this,domStage=container.find(".gliffy-stage"),overlayUnderStage=domStage.find("#gliffy-table-overlay"),currentColumns,overlay;if(node&&node.isTable()){overlay=self.__manager.getActiveOverlay();if(overlayUnderStage.length===0){domStage.append(this.__overlayContainer)}this.__overlayContainer.css({display:"inline",width:"150px",height:"90px"});this.__targetNode=node;this.positionAndResize({node:node,container:this.__overlayContainer,padding:0});currentColumns=this.__getCurrentColumnsCount(node);if(overlay&&!overlay.getLockPosition()){this.buildColumnResizeControls(node,currentColumns);this.buildRowResizeControls(node,currentColumns)}}},__getCurrentColumnsCount:function(node){var currentColumns=0,position,i;if(node.children){for(i=0;i<node.children.length;i++){position=node.children[i].getPosition();if(position.y!==0){break}currentColumns++}}return currentColumns},hide:function(){$("#gliffy-table-overlay").css("display","none");$(".gliffy-table-resize-y-overlay").remove();$(".gliffy-table-resize-x-overlay").remove();this.__targetNode=null},buildRowResizeControls:function(node,currentColumns){this.__rowsBoundingBoxArray=this.__getRowsBoundingBoxArray(node,currentColumns);if(this.__rowsBoundingBoxArray.length>0){this.__buildResizeYControls(this.__rowsBoundingBoxArray)}},buildColumnResizeControls:function(node,currentColumns){this.__colsBoundingBoxArray=this.__getColumnsBoundingBoxArray(node,currentColumns);if(this.__colsBoundingBoxArray.length>0){this.__buildResizeXControls(this.__colsBoundingBoxArray)}},__buildResizeYControls:function(rowsBoundingBoxArray){var i,resizeOverlay,resizeOverlayControl,zoom=this.__editor.getDocumentManager().getActiveStage().getZoom();$(".gliffy-table-resize-y-overlay").remove();for(i=0;i<rowsBoundingBoxArray.length;i++){resizeOverlay=$('<div class="gliffy-table-resize-y-overlay" />');resizeOverlay.css("width",rowsBoundingBoxArray[i].width*zoom);resizeOverlay.css("height",rowsBoundingBoxArray[i].height*zoom);resizeOverlay.css("top",rowsBoundingBoxArray[i].startingPosY*zoom);resizeOverlay.css("left",0);resizeOverlayControl=$('<div class="gliffy-table-resize-overlay-control-y gliffy-cursor-s-resize" data-attr-ids="'+rowsBoundingBoxArray[i].ids.join(",")+'"/>');resizeOverlayControl.css("bottom",1);resizeOverlayControl.css("left",0);resizeOverlay.append(resizeOverlayControl);this.__overlayOutline.append(resizeOverlay)}},__buildResizeXControls:function(colsBoundingBoxArray){var i,resizeOverlay,resizeOverlayControl,zoom=this.__editor.getDocumentManager().getActiveStage().getZoom();$(".gliffy-table-resize-x-overlay").remove();for(i=0;i<colsBoundingBoxArray.length;i++){resizeOverlay=$('<div class="gliffy-table-resize-x-overlay" />');resizeOverlay.css("width",colsBoundingBoxArray[i].width*zoom);resizeOverlay.css("height",colsBoundingBoxArray[i].height*zoom);resizeOverlay.css("top",0);resizeOverlay.css("left",colsBoundingBoxArray[i].startingPosX*zoom);resizeOverlayControl=$('<div class="gliffy-table-resize-overlay-control-x gliffy-cursor-e-resize" data-attr-ids="'+colsBoundingBoxArray[i].ids.join(",")+'"/>');resizeOverlayControl.css("top",0);resizeOverlayControl.css("left",((colsBoundingBoxArray[i].width)*zoom)-1);resizeOverlay.append(resizeOverlayControl);this.__overlayOutline.append(resizeOverlay)}},__getRowsBoundingBoxArray:function(node,currentColumns){var idsToAdd=[],rowBoundingBoxArray=[],colCount=0,i,position,height=0,width=0,rowProps=[],startingPosY;if(node.children){for(i=0;i<node.children.length;i++){position=node.children[i].getPosition();height=node.children[i].getHeight();width+=node.children[i].getWidth();startingPosY=position.y;idsToAdd.push(node.children[i].getId());if(colCount===currentColumns-1){rowProps.startingPosY=startingPosY;rowProps.width=width;rowProps.height=height;rowProps.ids=idsToAdd;rowBoundingBoxArray.push(rowProps);idsToAdd=[];rowProps=[];colCount=0;height=0;width=0}else{colCount++}}}return rowBoundingBoxArray},__getColumnsBoundingBoxArray:function(node,currentColumns){var idsToAdd=[],colBoundingBoxArray=[],position,j,i,height,width,colProps,startingPosX;for(i=0;i<currentColumns;i++){idsToAdd=[];if(node.children){position=node.children[i].getPosition();height=0;width=0;startingPosX=position.x;colProps=[];for(j=0;j<node.children.length;j++){if(position.x===node.children[j].getPosition().x){idsToAdd.push(node.children[j].getId());height+=node.children[j].getHeight();width=node.children[j].getWidth()}}colProps.startingPosX=startingPosX;colProps.width=width;colProps.height=height;colProps.ids=idsToAdd;colBoundingBoxArray.push(colProps)}}return colBoundingBoxArray}})}());(function(){_gliffy.NetworkRackOverlay=_gliffy.AbstractOverlay.extend({__CLASS_NAME:"NetworkRackOverlay",__overlayManager:null,init:function(o){this._super(o);this._overlayManager=o.manager},__buildOverlayHTML:function(){this.__overlayContainer=$('<div id="gliffy-network-rack-overlay" />');this.__overlayContainer.css("display","none");this.__overlayOutline=$('<div class="gliffy-network-rack-overlay-outline"/>');_gliffy.CursorManager.setCursor("move",this.__overlayOutline);this.__overlayContainer.append(this.__overlayOutline)},registerEventListeners:function(){var self=this,displayEvents,hideEvents,offset=0,manager=this.__manager.getContainer(),snapPixelsEvent,undoSnapPixelsResize,newHeight,targetNode,originalHeight=null,heightAdjustment=0;displayEvents=["gliffy-overlay-shape-resize-dragEnd","gliffy-overlay-shape-overlay-dragEnd","gliffy-overlay-manager-select-rack-node"].join(" ");hideEvents=["gliffy-overlay-shape-overlay-dragStart","gliffy-overlay-shape-resize-dragStart","gliffy-contextual-properties-close","gliffy-overlay-manager-deselect-all"].join(" ");snapPixelsEvent=["gliffy-overlay-shape-resize-dragStart"].join(" ");undoSnapPixelsResize=["gliffy-overlay-shape-resize-dragEnd"].join(" ");manager.on(hideEvents,function(){targetNode=self.__manager.getSelectedNode();if(targetNode){originalHeight=targetNode.getHeight()}self.hide()});manager.on(displayEvents,function(){self.show(self.__manager.getSelectedNode(),self.__container)});manager.on(snapPixelsEvent,function(){if(self.__manager.getSelectedNode().isRackShape()){self._overlayManager.overlay.setSnapePixels(20)}});manager.on(undoSnapPixelsResize,function(){offset=0,heightAdjustment=0;if(self.__manager.getSelectedNode()&&self.__manager.getSelectedNode().isRackShape()){if(GliffyApp.networkRackTabController.isRack(self.__manager.getSelectedNode())){offset=GliffyApp.networkRackTabController.get("RACK_UNIT_OFFSET");heightAdjustment=GliffyApp.networkRackTabController.get("PIXELS_TO_UNITS")*offset}newHeight=Math.floor((self.__manager.getSelectedNode().getHeight()/GliffyApp.networkRackTabController.get("PIXELS_TO_UNITS"))-offset);if(newHeight<=0){newHeight=1}if(!originalHeight){originalHeight=0}GliffyApp.networkRackTabController.updateShapeUnits(originalHeight-heightAdjustment,newHeight);self._overlayManager.overlay.setSnapePixels(10)}})},show:function(node,container){var self=this,domStage=container.find(".gliffy-stage"),overlayUnderStage=domStage.find("gliffy-network-rack-overlay"),overlay;if(node&&node.isRackShape()){overlay=self.__manager.getActiveOverlay();if(overlayUnderStage.length===0){domStage.append(this.__overlayContainer)}this.__overlayContainer.css({display:"inline"});this.__targetNode=node;this.positionAndResize({node:node,container:this.__overlayContainer,padding:0})}},hide:function(){$("#gliffy-network-rack-overlay").css("display","none");$(".gliffy-network-rack-resize-y-overlay").remove();this.__targetNode=null}})}());(function(){_gliffy.TextControl=_gliffy.Class.extend({LINE_TEXT_WIDTH:200,__container:null,__rteNode:null,__object:null,__rteContainer:null,__initialWidth:0,__initialHeight:0,__documentManager:null,__editor:null,__nodeQueue:null,__cantUndoCallback:null,__bookmark:null,__boundingBox:null,__skipOnGetContent:false,linkBrowser:null,__internal:false,init:function(o){var self=this,keyeventNode,keyeventParent,keyeventSiblings,keyIndex,keyeventGraphic,once=true;self.__container=o.target;self.__documentManager=o.documentManager;self.__editor=o.editor;_gliffy.TextUtils.appendWebFontFixes();if(o.linkBrowser){self.linkBrowser=o.linkBrowser}else{if(_gliffy.LinkBrowser){self.linkBrowser=new _gliffy.LinkBrowser()}}$(".gliffy-stage").on("click",".gliffy-rte-text p a",function(ev){$(".gliffy-stage").trigger("mousedown",ev);$(".gliffy-stage").trigger("mouseup",ev);return false});$("#gliffy-contextual-properties-controls-tabs>*,#gliffy-contextual-properties-dialog,#gliffy-contextual-properties-controls>*,#gliffy-contextual-properties-dialog-Trigger,.jqmClose").click(function(ev){if(once&&$("#gliffy-edit-text_ifr").is(":visible")&&(!$(ev.target).is(":input")||$(ev.target).is(":button"))){once=false;tinymce.activeEditor.focus();setTimeout(function(){once=true},1)}});_gliffy.KeyManager.registerState("rte",null,[{action:"zoomIn",keydown:function(e){return self.__blurAndPassKeyEvent(e)}},{action:"zoomOut",keydown:function(e){return self.__blurAndPassKeyEvent(e)}},{action:"save",keydown:function(e){return self.__blurAndPassKeyEvent(e)}},{action:"blur",keydown:function(e){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");e.preventDefault();e.stopImmediatePropagation();return false}},{action:"nudgeUp",keydown:function(ev){self.__editor.overlayManager.quickConnectionOverlay.handleNudgeUp(self.__object.node.getUidNode());return false}},{action:"nudgeDown",keydown:function(ev){self.__editor.overlayManager.quickConnectionOverlay.handleNudgeDown(self.__object.node.getUidNode());return false}},{action:"nudgeRight",keydown:function(ev){self.__editor.overlayManager.quickConnectionOverlay.handleNudgeRight(self.__object.node.getUidNode());return false}},{action:"nudgeLeft",keydown:function(ev){self.__editor.overlayManager.quickConnectionOverlay.handleNudgeLeft(self.__object.node.getUidNode());return false}},{action:"jumpStageRight",keydown:function(ev){self.__editor.overlayManager.quickConnectionOverlay.handleJumpStageRight(self.__object.node.getUidNode());return false}},{action:"jumpStageLeft",keydown:function(ev){self.__editor.overlayManager.quickConnectionOverlay.handleJumpStageLeft(self.__object.node.getUidNode());return false}},{action:"jumpStageDown",keydown:function(ev){self.__editor.overlayManager.quickConnectionOverlay.handleJumpStageDown(self.__object.node.getUidNode());return false}},{action:"jumpStageUp",keydown:function(ev){self.__editor.overlayManager.quickConnectionOverlay.handleJumpStageUp(self.__object.node.getUidNode());return false}},{action:"switchFields",keydown:function(e){e.preventDefault();e.stopImmediatePropagation();keyeventNode=self.__object.node;keyeventParent=keyeventNode.getUidNode();keyeventSiblings=keyeventParent.findGraphic(_gliffy.Text);$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");if(keyeventParent.isMultipartShape()&&keyeventSiblings.length>1){for(keyIndex=0;keyIndex<keyeventSiblings.length;keyIndex++){if(keyeventNode.getId()===keyeventSiblings[keyIndex].getId()){break}}keyIndex=(keyIndex+1)%keyeventSiblings.length;keyeventGraphic=keyeventSiblings[keyIndex].getGraphic();self.__documentManager.redraw(function(){keyeventGraphic.editable.setEditMode(true);keyeventGraphic.editable.focus();keyeventGraphic.editable.setCursorEnd();self.edit(keyeventGraphic);keyeventGraphic.editable.registerBlurHandler(function(){GliffyApp.contextualPropertiesController.blurRTE(self);keyeventGraphic.editable.setEditMode(false);self.__documentManager.redraw()});_gliffy.KeyManager.setState("rte")})}else{if(keyeventParent.isMindmap()){self.__editor.overlayManager.quickConnectionOverlay.handleTab(e,keyeventParent)}}return false}},{action:"switchFieldsBackward",keydown:function(e){e.preventDefault();e.stopImmediatePropagation();keyeventNode=self.__object.node;keyeventParent=keyeventNode.getUidNode();keyeventSiblings=keyeventParent.findGraphic(_gliffy.Text);$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");if(keyeventParent.isMultipartShape()&&keyeventSiblings.length>1){for(keyIndex=0;keyIndex<keyeventSiblings.length;keyIndex++){if(keyeventNode.getId()===keyeventSiblings[keyIndex].getId()){break}}keyIndex=(keyIndex>0)?(keyIndex-1):(keyeventSiblings.length-1);keyeventGraphic=keyeventSiblings[keyIndex].getGraphic();self.__documentManager.redraw(function(){keyeventGraphic.editable.setEditMode(true);keyeventGraphic.editable.focus();keyeventGraphic.editable.setCursorEnd();self.edit(keyeventGraphic);keyeventGraphic.editable.registerBlurHandler(function(){GliffyApp.contextualPropertiesController.blurRTE(self);keyeventGraphic.editable.setEditMode(false);self.__documentManager.redraw()});_gliffy.KeyManager.setState("rte")})}return false}},{action:"print",keydown:function(e){e.stopImmediatePropagation();e.preventDefault();_gliffy.Utils.analyticsEvent("trackEvent",{category:"keyboardCommand",action:"print"});GliffyApp.toolbarController.openPrintDialog();return false}}],function(){_gliffy.KeyManager.resetModifierKeys()},function(){_gliffy.KeyManager.resetModifierKeys()})},getBoundingBox:function(){return this.__rteContainer.data("boundingBox")},reportAnalytics:function(cmd,val){var newVal=null;switch(cmd){case"FontName":cmd+=val;break;case"FontSize":newVal=parseInt(val.replace("px",""),10);break}if($("#container").data("skipTextControlAnalytics")!==true){if(newVal){_gliffy.Utils.analyticsEvent("trackEvent",{category:"tinyMCE",action:cmd,value:newVal})}else{_gliffy.Utils.analyticsEvent("trackEvent",{category:"tinyMCE",action:cmd})}}},__blurAndPassKeyEvent:function(e){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");e.preventDefault();e.stopImmediatePropagation();$(document).trigger(e);return false},__hasLineParent:function(){return this.__object&&this.__object.hasLineParent()},getLineParent:function(){return this.__hasLineParent()?this.__object.node.parent:null},__updateTextDefaults:function(cmd,val){var prop=null;cmd=cmd.toLowerCase();switch(cmd){case"bold":case"italic":case"underline":prop=cmd;break;case"fontname":prop="face";break;case"fontsize":prop="size";break;case"forecolor":prop="color";break}if(prop){this.__documentManager.updateTextDefaults(prop,val)}},getTinymceCommandName:function(cmd){var justify={JustifyLeft:"alignleft",JustifyCenter:"aligncenter",JustifyRight:"alignright"};if(justify[cmd]){return justify[cmd]}else{return cmd.toLowerCase()}},getTinymceButtonState:function(cmd){var command=cmd.toLowerCase(),selectorClass=".mceButton.mceButtonActive.mce_"+command;return $(selectorClass).length>0},reset:function(inittedCallback){var self=this,xOffset,yOffset,lastW=null,lastH=null,interval,iframe,rte,command,resetDefaults;if($("#gliffy-edit-text-container").length>0||!window.tinymce){return}$(self.__container.find(".gliffy-stage")).append($("<div />",{id:"gliffy-edit-text-container"}).css({position:"absolute",top:"0px",left:"0px",width:"100px",zIndex:"535000",display:"none"}));self.__rteContainer=$("#gliffy-edit-text-container");self.__rteContainer.append($("<div />",{id:"gliffy-edit-text"}).css({position:"absolute",top:"0px",left:"0px",width:"100%",height:"1px",display:"none"}));tinymce.init({theme:"advanced",mode:"none",theme_advanced_toolbar_location:(self.__internal?"top":"external"),plugins:"inlinepopups,autoresize,paste",paste_strip_class_attributes:"all",paste_remove_spans:true,paste_remove_styles:true,init_instance_callback:function(){_gliffy.FontLoader.attachLoadedFontsToTinyMCE();if(inittedCallback){inittedCallback()}},relative_urls:false,convert_urls:false,theme_advanced_statusbar_location:"none",theme_advanced_buttons1:"bold,italic,underline,|,justifyleft,justifycenter,justifyright",theme_advanced_buttons2:"fontselect,fontsizeselect",theme_advanced_buttons3:"link,unlink,|,gliffyforecolor",theme_advanced_font_sizes:"9px,10px,11px,12px,13px,14px,16px,18px,20px,24px,36px,48px,64px,72px,96px,110px,127px",theme_advanced_fonts:_gliffy.TextUtils.getFontList().join(),content_css:tinymce.baseURI.source+"/gliffy/tinymce.css?"+new Date().getTime(),autoresize_bottom_margin:0,autoresize_min_height:0,browser_spellcheck:true,valid_elements:"a[href|style],br,span[style|class],p[style]",language:$.i18n._("TINYMCE_LANGUAGE_CODE"),replace_blank_content:'<p style="text-align: center;"><span style="font-family: Arial; font-size: 12px;"><span class="gliffy-placeholder-text"><br></span></span></p>',autoresize_should_resize_width_callback:function(){if(!self.__object){return false}return !self.__object.hasFixedWidth()},autoresize_should_ignore_pixel_padding:function(){var $p,hasCenterOrRightText=false;if(!self.__object){return false}if(self.__object.getOverflow()==="right"){$p=$(tinyMCE.activeEditor.getDoc().body).find("p");$p.each(function(){if($(this).css("text-align")!=="left"){hasCenterOrRightText=true;return false}})}return hasCenterOrRightText},autoresize_on_resize:function(ed,w,h){var transform,css,parent,boundingBox,zoom;if(self.__object){switch(self.__object.getOverflow()){case"both":xOffset=(self.__initialWidth-w)/2;break;case"left":xOffset=(self.__initialWidth-w);break;case"right":xOffset=0;break;default:xOffset=0}switch(self.__object.getVPosition()){case"above":yOffset=self.__initialHeight-h;break;case"below":yOffset=0;break;default:switch(self.__object.getValign()){case"top":yOffset=0;break;case"bottom":yOffset=self.__initialHeight-h;break;case"middle":parent=self.__object.node.parent;if(parent&&h+self.__object.getPaddingTop()+self.__object.getPaddingBottom()>=parent.getHeight()&&self.__object.node.getUidNode().isMultipartShape()){yOffset=-self.__object.style.y+self.__object.getPaddingTop()}else{yOffset=(self.__initialHeight-h)/2}break}}zoom=self.__object.node.stage?self.__object.node.stage.getZoom():1;transform=new _gliffy.AffineTransform().scale(zoom,zoom).concatenate(self.__object.node.worldTransform).translate(self.__object.style.x+xOffset-1,self.__object.style.y+yOffset-1);boundingBox=new _gliffy.BoundingBox(0,0,$("#gliffy-edit-text_ifr").width(),$("#gliffy-edit-text_ifr").height());boundingBox.transform(transform);self.__rteContainer.data("boundingBox",boundingBox);css=_gliffy.Utils.transformCss(transform,{roundTranslate:true});self.__rteContainer.css(css);$(window).trigger({type:"rte-resize.gliffy-edit-text",node:self.__object.node,w:w,h:h});lastW=w;lastH=h}},min_height:100,inline_styles:true,formats:{bold:{inline:"span",styles:{"font-weight":"bold"}},italic:{inline:"span",styles:{"font-style":"italic"}},underline:{inline:"span",styles:{"text-decoration":"underline"}}},paste_postserialize:function(pl,o){o.content=o.content.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;");o.content=_gliffy.TextUtils.validateAndFix(o.content);o.content=_gliffy.TextUtils.adjustHeightsAndColor(o.content);o.afterSerialize=true;setTimeout(function(){var placeHolderHasCharacters,placeHolderTextElements=$(pl.editor.getBody()).find("p > .gliffy-placeholder-text");placeHolderHasCharacters=_.any(placeHolderTextElements,function(placeHolderTextElement){return placeHolderTextElement.textContent.length>0});if(!placeHolderHasCharacters){placeHolderTextElements.parent().remove()}pl.editor.plugins.autoresize.forceResize()},1)},setup:function(ed){ed.addButton("gliffyforecolor",{title:$.i18n._("TEXT_COLOR"),onclick:function(){var $cpDom=$("#gliffy-edit-text_gliffyforecolor");$cpDom[$cpDom.hasClass("active")?"removeClass":"addClass"]("active");GliffyApp.colorpickerController.toggleColorSwatchPicker($cpDom[0],GliffyApp.contextualPropertiesController)}});ed.onNodeChange.add(function(ed,a,b,c,d,e){if($("#gliffy-edit-text_ifr:visible").length>0){e=ed.dom.getParent(ed.selection.getNode(),"A");if(e){var currentLink=ed.dom.getAttrib(e,"href");if(currentLink){GliffyApp.linkHudController.show({rteLink:currentLink},true)}else{GliffyApp.linkHudController.hide()}}else{GliffyApp.linkHudController.hide()}}});ed.onMouseUp.add(function(ed){$(window).trigger("rte-mouseUp.gliffy-edit-text",ed)});ed.onInit.add(function(ed){var excludedCommands,interval1,interval2,cnt,changeHandlers,i,adjustLineHeights,text,resetDefaults,top,left,capturedScrollThisFrame=false,isFirefox=(_gliffy.BrowserDetect.browser==="Firefox");ed.onGetContent.add(function(ed,o){if(!self.__skipOnGetContent){if(self.__object&&(self.__hasLineParent()||self.__object.isStandalone())){if(lastW){self.__object.node.setWidth(lastW)}if(lastH){self.__object.node.setHeight(lastH)}if(self.__object.isStandalone()){self.__object.node.setX(self.__object.node.getX()+xOffset);self.__object.node.setY(self.__object.node.getY()+yOffset)}self.__object.node.update()}self.__object=null}});excludedCommands={mceRepaint:true,Undo:true,Redo:true};ed.onBeforeExecCommand.add(function(ed,cmd,ui,val,a){if(cmd==="FontName"&&!_gliffy.FontLoader.isLoadedOrLoading(val)){_gliffy.FontLoader.loadFont(val,function(){ed.execCommand(cmd,ui,val)});a.terminate=true;return}if($("#gliffy-edit-text_ifr").is(":visible")){self.reportAnalytics(cmd,val)}if(excludedCommands[cmd]!==true&&!$("#gliffy-edit-text_ifr").is(":visible")){if(self.__nodeQueue===null){self.__editor.getDocumentManager().pushCommandBundle();self.__nodeQueue=[];if(self.__editor.overlayManager.getSelectedNode()){if(self.__editor.overlayManager.lineOverlay.isActive()&&self.__editor.overlayManager.lineOverlay.getActiveText()){self.__nodeQueue=[self.__editor.overlayManager.lineOverlay.getActiveText()]}else{if(self.__editor.overlayManager.getSelectedNode().isTable()){for(i=0;i<self.__editor.overlayManager.getSelectedNode().children.length;i++){if(self.__editor.overlayManager.getSelectedNode().children[i].isTableCellSelected()){if(self.__editor.overlayManager.getSelectedNode().children[i].children[0]&&self.__editor.overlayManager.getSelectedNode().children[i].children[0].getGraphic().getNodeText().trim().length!=0){self.__nodeQueue.push(self.__editor.overlayManager.getSelectedNode().children[i].children[0])}}}if(self.__nodeQueue.length==0){for(var i=0;i<self.__editor.overlayManager.getSelectedNode().children.length;i++){if(self.__editor.overlayManager.getSelectedNode().children[i].children[0].getGraphic().getNodeText().trim().length!=0){self.__nodeQueue.push(self.__editor.overlayManager.getSelectedNode().children[i].children[0])}}}}else{self.__nodeQueue=self.__editor.overlayManager.getSelectedNode().findGraphic(_gliffy.Text)}}}self.__buttonState=self.getTinymceButtonState(cmd);ed.execCommand(cmd,ui,val,a);self.reportAnalytics(cmd,val);a.terminate=true}else{if(self.__nodeQueue.length>0){var last=self.__nodeQueue[self.__nodeQueue.length-1];ed.setContent(last.getGraphic().getHTML());self.setTransformFromGraphic(last.getGraphic());$("#gliffy-edit-text-container").css({display:""});ed.focus();ed.selection.select(ed.getBody(),true);if(_gliffy.BrowserDetect.browser==="Firefox"||_gliffy.BrowserDetect.browser==="Explorer"){if(cmd==="unlink"){ed.formatter.remove("link")}}$("#gliffy-edit-text-container").css("display","none");command=self.getTinymceCommandName(cmd);if(cmd==="FontName"){self.__applyStyle=tinymce.activeEditor.queryCommandValue("FontName")!==val.toLowerCase();setTimeout(function(){self.__documentManager.getActiveStage().invalidateTextWithFont(val.toLowerCase());self.__documentManager.redraw()},0)}else{if(cmd==="FontSize"){self.__applyStyle=tinymce.activeEditor.queryCommandValue("FontSize")!==val}else{if(cmd==="unlink"){self.__applyStyle=true}else{self.__applyStyle=tinymce.activeEditor.formatter.match(command)===self.__buttonState}}}}}}});ed.onExecCommand.add(function(ed,cmd,ui,val,a){if(excludedCommands[cmd]!==true){if(!$("#gliffy-edit-text_ifr").is(":visible")){if(self.__nodeQueue&&self.__nodeQueue.length>0){var last=self.__nodeQueue[self.__nodeQueue.length-1];if(self.__applyStyle){if(val&&val.skipCommandRegistration){new _gliffy.SetTextCommand({node:last,text:ed.getContent()}).execute(last.stage)}else{last.stage.commandHistory.addAndExecuteCommand(new _gliffy.SetTextCommand({node:last,text:ed.getContent()}))}}self.__nodeQueue.pop()}if(self.__nodeQueue&&self.__nodeQueue.length>0){ed.execCommand(cmd,ui,val,a)}else{self.__updateTextDefaults(cmd,val);if(self.__editor.overlayManager.lineOverlay.isActive()){self.__editor.overlayManager.lineOverlay.redraw()}self.hideMenus();_gliffy.Utils.stealFocus();self.__documentManager.redraw();self.__nodeQueue=null;self.__editor.getDocumentManager().popCommandBundle();if(self.__editor.overlayManager.overlay.isActive()){self.__editor.overlayManager.overlay.refresh()}}}else{if(cmd==="FontSize"||cmd==="FontName"){setTimeout(function(){adjustLineHeights(ed);resetDefaults(ed)},1)}self.__updateTextDefaults(cmd,val);self.hideMenus()}}});resetDefaults=function(ed,e){var existingText,ph,selection;if($(ed.getDoc().body).find("span").length===0){existingText=$(ed.getDoc().body).text();if(existingText.length===0){ed.setContent('<p style="text-align: center;"><span style="font-family: Arial; font-size: 12px; "><span class="gliffy-placeholder-text"><br></span></span></p>')}else{ed.setContent('<p style="text-align: center;"><span style="font-family: Arial; font-size: 12px; ">'+existingText+'<span class="gliffy-placeholder-text"><br></span></span></p>');ph=$(ed.getDoc().body).find(".gliffy-placeholder-text");selection=ed.selection.select(ph[0],true);if(tinymce.isIE){ed.dom.remove(selection)}}ed.plugins.autoresize.forceResize()}};adjustLineHeights=function(ed,e){var $body=$(ed.getDoc().body),spans,color,i,naughtyTagFound=false,replaceNaughty,isBlack,renderedColor;replaceNaughty=function(selector,newStyle){$body.find(selector).replaceWith(function(){naughtyTagFound=true;return $("<span>",{style:newStyle}).append(this.innerHTML)})};replaceNaughty("b,strong","font-weight:bold");replaceNaughty("i,em","font-style:italic");replaceNaughty("u","text-decoration:underline");if(naughtyTagFound&&tinyMCE.isWebKit){ed.selection.select(ed.getBody(),true);ed.selection.collapse(false)}spans=$body.find("span");spans.each(function(index){var span=$(this),font,weight,size,height,needsLineHeight=false;if(span[0].childNodes.length===0){needsLineHeight=true}for(i=0;i<span[0].childNodes.length;i++){if(span[0].childNodes[i].nodeType===3||span[0].childNodes[i].tagName.toLowerCase()==="br"||span[0].childNodes[i].tagName.toLowerCase()==="a"){needsLineHeight=true;break}}if(needsLineHeight){font=_gliffy.Utils.getRenderedStyle(span,"font-family");weight=_gliffy.Utils.getRenderedStyle(span,"font-weight");size=parseFloat(_gliffy.Utils.getRenderedStyle(span,"font-size").replace("px",""));font=font===""?"Arial":font;switch(weight){case"bold":case"700":weight="bold";break;case"":case"normal":case"400":weight="normal";break;default:weight="normal"}if(_gliffy.TextUtils.FONT_FIXES[font]===undefined){font="Arial"}if(_gliffy.TextUtils.FONT_FIXES[font][weight]===undefined){weight="normal"}if(isNaN(size)||_gliffy.TextUtils.FONT_FIXES[font][weight][size]===undefined){size=12}if(_gliffy.TextUtils.FONT_FIXES[font].isOffset){height=""+(size+_gliffy.TextUtils.FONT_FIXES[font][weight][size])+"px"}else{height=_gliffy.TextUtils.FONT_FIXES[font][weight][size]}if($(this).html().length===0){$(this).html("&nbsp;")}$(this).css("line-height",height)}else{$(this).css("line-height","")}isBlack=function(color){return color==="rgb(0, 0, 0)"||color==="black"||color==="#000000"||color==="#000"||color==="rgb(0,0,0)"};color=$(this).css("color");if(isBlack(color)){$(this).css("color","");renderedColor=_gliffy.Utils.getRenderedStyle($(this),"color");if(!isBlack(renderedColor)){$(this).css("color",color)}}})};changeHandlers=["onChange","onSetContent","onKeyUp","onPostRender"];for(i=0;i<changeHandlers.length;i++){ed[changeHandlers[i]].add(resetDefaults);ed[changeHandlers[i]].add(adjustLineHeights)}ed.onKeyDown.add(function(ed,e){$(document).trigger(e)});ed.onCantUndo.add(function(ed,undoLevel,b,c,d){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text",{removeNodeWithoutAddingCommand:true,checkHasUndo:true})});if(!self.__internal){interval1=setInterval(function(){var ext,container;if($("#gliffy-contextual-properties-tab-text-rte").length!==0){ext=$("#"+ed.id+"_external");$("#gliffy-contextual-properties-tab-text-rte").html("");container=$("<div/>",{"class":"defaultSkin"});$("#gliffy-contextual-properties-tab-text-rte").append(container);ext.appendTo(container);ext.show();ed.controlManager.controls["gliffy-edit-text_fontselect"].onRenderMenu.add(function(){setTimeout(function(){var fontList=_gliffy.TextUtils.getFontList(true),i;for(var i=0;i<fontList.length;i++){_gliffy.FontLoader.attachPlaceholderFont(fontList[i])}},1)});if(tinyMCE.isWebKit){if(_gliffy.BrowserDetect.browser==="Safari"){_gliffy.Utils.addDynamicStyle(".defaultSkin .mceListBoxMenu::-webkit-scrollbar {-webkit-appearance: none;width: 7px;}.defaultSkin .mceListBoxMenu::-webkit-scrollbar-thumb {border-radius: 4px;background-color: rgba(0,0,0, .5);-webkit-box-shadow: 0 0 1px rgba(255,255,255,.5);}")}ed.controlManager.controls["gliffy-edit-text_fontsizeselect"].onRenderMenu.add(function(){setTimeout(function(){$("#menu_gliffy-edit-text_gliffy-edit-text_fontsizeselect_menu_co").unbind("gliffy-scroll-hack");$("#menu_gliffy-edit-text_gliffy-edit-text_fontsizeselect_menu_co").bind("scroll.gliffy-scroll-hack",function(){$(this).html($(this).html())})},1)})}cnt=0;interval2=setInterval(function(){ext.show();$("#gliffy-edit-text_fontselect_text").width(126);if(self.linkBrowser){ed.gliffyLinkFunc=self.__linkAction;ed.gliffyTextControl=self}if(cnt===5){clearInterval(interval2)}cnt++},1000);clearInterval(interval1)}},50)}});ed.onSetAttrib.add(function(ed,dom,cmd,val){if(cmd==="tabindex"&&val==="-1"&&$(dom).length!==0){self.hideMenus($(dom).attr("id")?($(dom).attr("id")).replace("menu_",""):null)}});ed.onSetContent.add(function(ed,o){var $root,$bogusX,selection,keyEvent,charToInsert;if(self.__object===null){return}$root=$(ed.dom.getRoot());if(self.__object.hasFixedWidth()){$root.addClass("gliffy-fixed-width")}else{$root.removeClass("gliffy-fixed-width")}$bogusX=$root.find(".gliffy-placeholder-text");if($bogusX.length!==0){ed.focus();selection=ed.selection.select($bogusX[0],true);if(tinymce.isIE&&!_gliffy.Utils.hasNonWhitespaceCharacter($bogusX.text())){ed.dom.remove(selection)}ed.nodeChanged()}else{if(self.__object.editable.shouldSetCursorEnd()&&$root.html().length!==0){ed.focus();ed.selection.select(ed.getBody(),true);ed.selection.collapse(false)}}$("#gliffy-edit-text_tbl").css("height","100%");keyEvent=self.__object.editable.getKeyEvent();if(keyEvent&&keyEvent.charCode!==13){charToInsert=String.fromCharCode(keyEvent.charCode);ed.focus();ed.selection.select(ed.getBody(),true);var firstP=$(ed.getBody()).find("p:first");firstP.remove("p").find("span:not(:eq(0))").remove();firstP.find("span:not(:eq(0))").remove();if(firstP.find("span").length===0){firstP.append($("<span />"))}firstP.find("span").text(charToInsert);$(ed.getBody()).html("");if(firstP.length>0){if(tinyMCE.isIE){$(ed.getBody()).html(firstP[0].outerHTML)}else{ed.selection.setContent(firstP[0].outerHTML)}}if(!tinyMCE.isIE){ed.selection.select(ed.getBody(),true);ed.selection.setContent(charToInsert)}ed.nodeChanged();ed.selection.select(ed.getBody(),true);ed.selection.collapse(false);ed.onChange.dispatch()}self.__object.editable.clearModifiers()})}});tinymce.execCommand("mceAddControl",true,"gliffy-edit-text");interval=setInterval(function(){iframe=$("#gliffy-edit-text_ifr");if(iframe.length===1){rte=$("#gliffy-edit-text_parent");rte.css({display:"",position:"absolute",top:"0px",left:"0px"});self.__rteNode=rte;self.__setupTooltips();self.__fixSafariScrollIssue();if(!(_gliffy.BrowserDetect.browser==="Explorer"&&_gliffy.BrowserDetect.version===9)){self.__injectGliffyTextForegroundColorButtonStyle()}clearInterval(interval)}},25)},hideMenus:function(except){var controls=tinymce.activeEditor.controlManager.controls,ids=["gliffy-edit-text_gliffy-edit-text_fontselect_menu","gliffy-edit-text_gliffy-edit-text_fontsizeselect_menu","gliffy-edit-text_forecolor"],control,i,$cpDom=$("#gliffy-edit-text_gliffyforecolor");for(i=0;i<ids.length;i++){if(ids[i]!==except){control=controls[ids[i]];if(control&&$.isFunction(control.hideMenu)){control.hideMenu()}}}if(except!=="gliffy-edit-text_gliffyforecolor"&&$("#gliffy-edit-text_gliffyforecolor").hasClass("active")){$("#gliffy-edit-text_gliffyforecolor").removeClass("active");GliffyApp.colorpickerController.toggleColorSwatchPicker($cpDom[0],GliffyApp.contextualPropertiesController)}},getActiveObject:function(){return this.__object},__injectGliffyTextForegroundColorButtonStyle:function(){$("#gliffy-edit-text_gliffyforecolor .mce_gliffyforecolor").remove();$("#gliffy-edit-text_gliffyforecolor").prepend($('<span class="gliffy-color-fill-icon"><b class="caret"></b></span>'))},__fixSafariScrollIssue:function(){var top,left,dragging=false;if(_gliffy.BrowserDetect.browser==="Safari"){$("#gliffy-edit-text_ifr").contents().on("mousedown",function(event){top=$("#container").scrollTop();left=$("#container").scrollLeft();dragging=true}).on("mouseup",function(){dragging=false});$("#container").on("scroll",function(event){if(dragging){$("#container").scrollTop(top);$("#container").scrollLeft(left)}})}},setTransformFromGraphic:function(textGraphic){var zoom,transform,width,height,self=this;if(textGraphic.getOverflow()==="none"){width=textGraphic.node.getWidth()-textGraphic.getPaddingLeft()-textGraphic.getPaddingRight()}else{width=textGraphic.node.getWidth()}if(textGraphic.node.isPartOfMultipartShape()){height=textGraphic.node.getHeight()+textGraphic.getPaddingTop()+textGraphic.getPaddingBottom()}else{height=textGraphic.node.getHeight()}zoom=textGraphic.node.stage?textGraphic.node.stage.getZoom():1;transform=new _gliffy.AffineTransform().scale(zoom,zoom).concatenate(textGraphic.node.worldTransform).translate(textGraphic.style.x,textGraphic.style.y);if(self.__rteContainer){self.__rteContainer.css(_gliffy.Utils.transformCss(transform,{roundTranslate:true})).css({display:"",width:width,height:height})}},edit:function(object){var textNode=object.node.getDomElement(),html,self=this,transform,width,height,zoom,lastBorder;if(tinymce.activeEditor&&tinymce.activeEditor.undoManager){tinymce.activeEditor.undoManager.clear()}textNode.html("");self.__object=object;$("#gliffy-edit-text_ifr").data("node",object.node);if(self.__hasLineParent()){self.__object.node.setX(0);self.__object.node.setY(0);self.__object.node.update();$("#gliffy-edit-text_ifr").css("background-color",self.__object.node.stage.background==="transparent"?"#ffffff":self.__object.node.stage.background)}else{$("#gliffy-edit-text_ifr").css("background-color","")}self.__initialWidth=self.__object.style.width;self.__initialHeight=self.__object.style.height;self.setTransformFromGraphic(self.__object);if(self.__rteNode){self.__rteNode.css("display","");if(!self.__hasLineParent()){self.__rteNode.css({width:"100%","background-color":""})}else{self.__rteNode.css("width","")}}if((self.__object.isStandalone()||self.__hasLineParent())&&self.__object.getHTML().length===0){html='<p style="text-align: center;"><span style="font-family: Arial; font-size: 12px; "><span class="gliffy-placeholder-text"><br></span></span></p>';self.__object.setHTML(html);html=self.__documentManager.applyTextDefaults(html,self.__object.isStandalone()?"text":"line");if(tinymce.activeEditor&&html){tinymce.activeEditor.setContent(html,{format:"raw"})}else{_gliffy.Logger.warn("Failed to update text: "+html)}}else{html=this.__stripLineHeights(this.__object.getHTML());if(tinymce.activeEditor&&html){tinymce.activeEditor.setContent(html,{format:"raw"})}else{_gliffy.Logger.warn("Failed to update text: "+html)}}if(tinymce.activeEditor){tinymce.activeEditor.focus();tinymce.activeEditor.onKeyUp.dispatch(tinymce.activeEditor,{keyCode:17})}$(window).trigger({type:"rte-add.gliffy-edit-text",node:self.__object.node});self.__fixChromeRenderingBug()},__fixChromeRenderingBug:function(){var lastBorder;if(_gliffy.BrowserDetect.browser==="Chrome"&&window.devicePixelRatio>1){lastBorder=$("#gliffy-edit-text_ifr").css("border");$("#gliffy-edit-text_ifr").css("border","none");setTimeout(function(){$("#gliffy-edit-text_ifr").css("border",lastBorder)},1)}},__stripLineHeights:function(html){var $html=$("<div/>").append($(html));$html.find("span").each(function(){$(this).css("line-height","")});return $html.html()},__applyLink:function(ed,linkURL,linkText,oldLinkText,rteMode){linkText=linkText||null;oldLinkText=oldLinkText||null;if(typeof(linkURL)==="string"){linkURL={href:linkURL}}var jSelectionNode=$(ed.selection.getNode()).find("a");for(var j=0;j<Math.max(jSelectionNode.length,1);j++){if(rteMode!==true&&jSelectionNode.length>0){ed.selection.select(jSelectionNode[j])}var anchor=ed.dom.getParent(ed.selection.getNode(),"a"),formatter=ed.formatter;linkURL.href=linkURL.href.replace(" ","%20");if(!anchor||!linkURL.href){formatter.remove("link")}if(linkURL.href){formatter.apply("link",linkURL,anchor);if(linkText!==oldLinkText){var node=$(ed.dom.get(ed.selection.getNode()));var a=node.find("a");if(a.length===0){node.text(linkText)}else{for(var i=0;i<a.length;i++){if($(a[i]).text()===oldLinkText){$(a[i]).text(linkText)}}}}}}},__getContentWithoutSideEffects:function(){var content;this.__skipOnGetContent=true;content=tinyMCE.activeEditor.getContent();this.__skipOnGetContent=false;return content},__linkAction:function(self,ed){var callback,activeText,e,currentLink=null,selectedNode=self.__editor.overlayManager.getSelectedNode(),rteActive=$("#gliffy-edit-text_ifr").is(":visible"),textNode,parent;if(!rteActive&&selectedNode===null){return}if(rteActive&&$(self.__getContentWithoutSideEffects()).text().replace(/\s/g,"").length===0){textNode=$("#gliffy-edit-text_ifr").data("node");if(textNode.parent&&textNode.parent.supportsIcon()){parent=textNode.parent;$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");_gliffy.Utils.stealFocus();self.__editor.overlayManager.selectNode(parent);self.__linkAction(self,ed);return}}if(!rteActive&&selectedNode&&selectedNode.supportsIcon()){callback=_gliffy.ShapeLinker.linkNavCallback}else{callback=function(value,linkText,oldLinkText){var rteActive=$("#gliffy-edit-text_ifr").is(":visible"),textNodes;if(tinyMCE.isIE&&self.__bookmark){ed.selection.moveToBookmark(self.__bookmark)}if(!rteActive){textNodes=null;if(self.__editor.overlayManager.getActiveOverlay()===self.__editor.overlayManager.lineOverlay){activeText=self.__editor.overlayManager.lineOverlay.getActiveText();if(activeText!==null){textNodes=[activeText]}}if(textNodes===null){if(self.__editor.overlayManager.getSelectedNode()!==null){textNodes=self.__editor.overlayManager.getSelectedNode().findGraphic(_gliffy.Text)}}if(textNodes!==null){var stage=null;if(textNodes.length>=1){stage=textNodes[0].stage;stage.commandHistory.pushCommandBundle()}for(var i=0;i<textNodes.length;i++){ed.setContent(textNodes[i].getGraphic().getHTML());$("#gliffy-edit-text-container").css({display:""});ed.focus();ed.selection.select(ed.getBody(),true);self.__applyLink(ed,value,linkText,oldLinkText,rteActive);$("#gliffy-edit-text-container").css("display","none");textNodes[i].stage.commandHistory.addAndExecuteCommand(new _gliffy.SetTextCommand({node:textNodes[i],text:ed.getContent()}));_gliffy.Utils.stealFocus()}if(stage){stage.commandHistory.popCommandBundle()}GliffyApp.contextualPropertiesController.showControls(self.__editor.overlayManager.getActiveOverlay());self.__documentManager.redraw()}}else{self.__applyLink(ed,value,linkText,oldLinkText,rteActive);if(ed){ed.undoManager.add()}}tinyMCE.activeEditor.nodeChanged()}}var getTextNodesIn=function($el){return $el.find(":not(iframe)").andSelf().contents().filter(function(){return this.nodeType==3})};if($("#gliffy-edit-text_ifr").is(":visible")||self.__editor.overlayManager.getSelectedNode()!==null){if(tinyMCE.isIE){self.__bookmark=ed.selection.getBookmark()}e=ed.dom.getParent(ed.selection.getNode(),"A");if(_gliffy.BrowserDetect.browser==="Firefox"&&!$("#gliffy-edit-text_ifr").is(":visible")){var a=$(ed.selection.getNode()).find("a");if(a.length===1){e=a[0]}}var linkText=null;if($("#gliffy-edit-text_ifr").is(":visible")){if(e){currentLink=ed.dom.getAttrib(e,"href");var outer=ed.dom.getOuterHTML(e);linkText=$(outer).text()}else{var linkContent=ed.selection.getContent();var asDom=$("<div />").append(linkContent);if(_gliffy.BrowserDetect.browser==="Firefox"&&!$("#gliffy-edit-text_ifr").is(":visible")){asDom=$(ed.dom.getRoot())}var textNodes=getTextNodesIn(asDom,false);if(textNodes.length===1){linkText=textNodes[0].nodeValue}}}else{var linkNodes=null;if(selectedNode){linkNodes=selectedNode.findGraphic(_gliffy.Link);if(linkNodes.length>0){currentLink=linkNodes[0].getGraphic().getHref()}}}self.linkBrowser.show(callback,currentLink,linkText,self.__editor.overlayManager.getSelectedNode())}},__setupTooltips:function(){var i,add=[$("#gliffy-edit-text_bold"),$("#gliffy-edit-text_italic"),$("#gliffy-edit-text_underline"),$("#gliffy-edit-text_justifyleft"),$("#gliffy-edit-text_justifycenter"),$("#gliffy-edit-text_justifyright"),$("#gliffy-edit-text_link"),$("#gliffy-edit-text_unlink"),$("#gliffy-edit-text_gliffyforecolor")];for(i=0;i<add.length;i++){add[i].tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD)}$("#gliffy-edit-text_forecolor table").attr("title","")},doUndo:function(cantUndoCallback){var localCallback;cantUndoCallback=cantUndoCallback===undefined?null:cantUndoCallback;this.__cantUndoCallback=cantUndoCallback;if(tinymce.activeEditor){tinymce.activeEditor.undoManager.undo()}this.__cantUndoCallback=null},debugEvents:function(ed,log){ed.onPreInit.add(function(ed,a,b,c,d){if(log){console.log("onPreInit",a,b,c,d)}});ed.onBeforeRenderUI.add(function(ed,a,b,c,d){if(log){console.log("onBeforeRenderUI",a,b,c,d)}});ed.onPostRender.add(function(ed,a,b,c,d){if(log){console.log("onPostRender",a,b,c,d)}});ed.onLoad.add(function(ed,a,b,c,d){if(log){console.log("onLoad",a,b,c,d)}});ed.onInit.add(function(ed,a,b,c,d){if(log){console.log("onInit",a,b,c,d)}});ed.onRemove.add(function(ed,a,b,c,d){if(log){console.log("onRemove",a,b,c,d)}});ed.onActivate.add(function(ed,a,b,c,d){if(log){console.log("onActivate",a,b,c,d)}});ed.onDeactivate.add(function(ed,a,b,c,d){if(log){console.log("onDeactivate",a,b,c,d)}});ed.onClick.add(function(ed,a,b,c,d){if(log){console.log("onClick",a,b,c,d)}});ed.onEvent.add(function(ed,a,b,c,d){if(log){console.log("onEvent",a,b,c,d)}});ed.onMouseUp.add(function(ed,a,b,c,d){if(log){console.log("onMouseUp",a,b,c,d)}});ed.onMouseDown.add(function(ed,a,b,c,d){if(log){console.log("onMouseDown",a,b,c,d)}});ed.onDblClick.add(function(ed,a,b,c,d){if(log){console.log("onDblClick",a,b,c,d)}});ed.onKeyDown.add(function(ed,a,b,c,d){if(log){console.log("onKeyDown",a,b,c,d)}});ed.onKeyUp.add(function(ed,a,b,c,d){if(log){console.log("onKeyUp",a,b,c,d)}});ed.onKeyPress.add(function(ed,a,b,c,d){if(log){console.log("onKeyPress",a,b,c,d)}});ed.onContextMenu.add(function(ed,a,b,c,d){if(log){console.log("onContextMenu",a,b,c,d)}});ed.onSubmit.add(function(ed,a,b,c,d){if(log){console.log("onSubmit",a,b,c,d)}});ed.onReset.add(function(ed,a,b,c,d){if(log){console.log("onReset",a,b,c,d)}});ed.onPaste.add(function(ed,a,b,c,d){if(log){console.log("onPaste",a,b,c,d)}});ed.onPreProcess.add(function(ed,a,b,c,d){if(log){console.log("onPreProcess",a,b,c,d)}});ed.onPostProcess.add(function(ed,a,b,c,d){if(log){console.log("onPostProcess",a,b,c,d)}});ed.onBeforeSetContent.add(function(ed,a,b,c,d){if(log){console.log("onBeforeSetContent",a,b,c,d)}});ed.onBeforeGetContent.add(function(ed,a,b,c,d){if(log){console.log("onBeforeGetContent",a,b,c,d)}});ed.onSetContent.add(function(ed,a,b,c,d){if(log){console.log("onSetContent",a,b,c,d)}});ed.onGetContent.add(function(ed,a,b,c,d){if(log){console.log("onGetContent",a,b,c,d)}});ed.onLoadContent.add(function(ed,a,b,c,d){if(log){console.log("onLoadContent",a,b,c,d)}});ed.onSaveContent.add(function(ed,a,b,c,d){if(log){console.log("onSaveContent",a,b,c,d)}});ed.onNodeChange.add(function(ed,a,b,c,d){if(log){console.log("onNodeChange",a,b,c)}});ed.onChange.add(function(ed,a,b,c,d){if(log){console.log("onChange",a,b,c,d)}});ed.onBeforeExecCommand.add(function(ed,a,b,c,d){if(log){console.log("onBeforeExecCommand",a,b,c,d)}});ed.onExecCommand.add(function(ed,a,b,c,d){if(log){console.log("onExecCommand",a,b,c,d)}});ed.onUndo.add(function(ed,a,b,c,d){if(log){console.log("onUndo",a,b,c,d)}});ed.onRedo.add(function(ed,a,b,c,d){if(log){console.log("onRedo",a,b,c,d)}});ed.onVisualAid.add(function(ed,a,b,c,d){if(log){console.log("onVisualAid",a,b,c,d)}});ed.onSetProgressState.add(function(ed,a,b,c,d){if(log){console.log("onSetProgressState",a,b,c,d)}});ed.onSetAttrib.add(function(ed,a,b,c,d){if(log){console.log("onSetAttrib",a,b,c,d)}})}})}());(function(){_gliffy.LinkBrowser=_gliffy.Class.extend({__url:null,__urlRegex:null,__protocolRegex:null,init:function(o){this.__urlRegex=new RegExp("^(http|https|file|ftp|mailto|notes):\\/\\/(((([a-zA-Z0-9]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(%[\\da-f]{2})|[!\\$&'\\(\\)\\*\\+,;=]|:)*@)?((\\[(|(v[\\da-f]{1,}\\.(([a-zA-Z0-9]|\\d|-|\\.|_|~)|[!\\$&'\\(\\)\\*\\+,;=]|:)+))\\])|((\\d|[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5])\\.(\\d|[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5])\\.(\\d|[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5])\\.(\\d|[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5]))|((([a-zA-Z0-9]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-zA-Z0-9]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-zA-Z0-9]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-zA-Z0-9]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.)*(([a-zA-Z0-9]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-zA-Z0-9]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-zA-Z0-9]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.?)(:\\d*)?)(\\/((([a-zA-Z0-9]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(%[\\da-f]{2})|[!\\$&'\\(\\)\\*\\+,;=]|:|@)+(\\/(([a-zA-Z0-9z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(%[\\da-f]{2})|[!\\$&'\\(\\)\\*\\+,;=]|:|@)*)*)?)?(\\?((([a-zA-Z0-9]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(%[\\da-f]{2})|[!\\$&'\\(\\)\\*\\+,;=]|:|@)|[\\uE000-\\uF8FF]|\\/|\\?)*)?(\\#((([a-zA-Z0-9]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(%[\\da-f]{2})|[!\\$&'\\(\\)\\*\\+,;=]|:|@)|\\/|\\?)*)?$","i");this.__protocolRegex=new RegExp("^(.*?):");this.__url="http://"},show:function(applyURL,url,linkText,node){var self=this,giveHideIconOption=node&&!node.isText(),linkNodes;self.__url=url||"http://";_gliffy.Dialog.showGenericDialog({content:$(".gliffy-link-nav-body").html(),title:$.i18n._("LINKBROWSER_INSERT_LINK"),cancelCallback:null,escapeHTML:false,skipNodeDeselect:true,buttons:[{text:$.i18n._("LINKBROWSER_INSERT_LINK"),callback:function(button){var hideIcon=undefined;if(!$(button).hasClass("disabled")){self.__unbindHandlers();self.__url=self.__ensureUrlHasProtocol(self.__url);if(giveHideIconOption){hideIcon=$("#gliffy-hide-link-icon").prop("checked")}applyURL(self.__url,$(".gliffy-url-text-input").attr("value"),linkText,node,hideIcon);_gliffy.Dialog.hide()}},primary:true,dismiss:false,add_classes:["gliffy-insert-link-button","disabled"]},{text:$.i18n._("LINKBROWSER_CANCEL"),callback:self.__unbindHandlers,primary:false,dismiss:true}]});if(linkText===null){$(".gliffy-link-text-row").css("display","none")}else{$(".gliffy-link-text-row").css("display","");$(".gliffy-url-text-input").val(linkText)}if(giveHideIconOption){$("#gliffy-hide-link-icon-row").show();$("#gliffy-hide-link-icon").prop("checked",false);linkNodes=node.findGraphic(_gliffy.Link);if(linkNodes.length>0){$("#gliffy-hide-link-icon").prop("checked",!linkNodes[0].getGraphic().getRenderIcon())}}else{$("#gliffy-hide-link-icon-row").hide()}$(".gliffy-url-input").focus().val(self.__url);$(".gliffy-url-input").bind("keyup.gliffy-url-input",function(e){self.__keyUpFunc(e,$(this));if(e.keyCode===13){$(".gliffy-insert-link-button").click()}});self.__keyUpFunc(null,$(".gliffy-url-input"));setTimeout(function(){$(".gliffy-url-input").focus();$(".gliffy-url-input").get(0).setSelectionRange(self.__url.length,self.__url.length)},100)},__validateUrl:function(valUrl){return this.__urlRegex.test(valUrl)||!this.__protocolRegex.test(valUrl)},__ensureUrlHasProtocol:function(url){if(url&&url.substr(0,7)!=="http://"&&url.substr(0,8)!=="https://"){url="http://"+url}return url},__unbindHandlers:function(){$(".gliffy-url-input").unbind("keyup.gliffy-url-input")},__keyUpFunc:function(e,jqEle){var weblink_url=jqEle.val().replace(" ","%20");if(this.__validateUrl(weblink_url)){this.__url=weblink_url;$(".gliffy-insert-link-button").removeClass("disabled");$(".gliffy-url-message").css("visibility","hidden")}else{$(".gliffy-insert-link-button").addClass("disabled");$(".gliffy-url-message").css("visibility","visible")}}})}());(function(){var TRANSPARENT_OUTLINE_SIZE_DIFFERENCE=20,OVERFLOW_TEXT_WIDTH_DIFFERENCE=25;_gliffy.ShapeTextMover=_gliffy.Class.extend({_domElement:null,_overlay:null,_position:null,_textPositionAnchors:[],_transparentOutline:null,init:function(parameters){if(parameters&&parameters.overlay){this._setOverlay(parameters.overlay)}this._setDomElement($('<div class="gliffy-overlay-text-adjustment">'));this._setTextPositionAnchors([{position:"above",coordinates:{x:0,y:0},element:$('<div class="gliffy-overlay-text-position-anchor above">')},{position:"below",coordinates:{x:0,y:0},element:$('<div class="gliffy-overlay-text-position-anchor below">')},{position:"left",coordinates:{x:0,y:0},element:$('<div class="gliffy-overlay-text-position-anchor left">')},{position:"right",coordinates:{x:0,y:0},element:$('<div class="gliffy-overlay-text-position-anchor right">')},{position:"center",coordinates:{x:0,y:0},element:$('<div class="gliffy-overlay-text-position-anchor center">')}]);this._setTransparentOutline($('<div class="gliffy-overlay-text-adjustment-transparent-outline">'));this._getDomElement().append(this._getTransparentOutline());this._setupDragManager();this._registerEventListeners()},_setupDragManager:function(){var clearDragManagerVariables,domElement,doubleClick,initialDomElementPosition,initialMousePositionOnStage,initialTextHalign,initialTextPosition,node,overlay,self,stage,text,textNode;self=this;clearDragManagerVariables=function(){domElement=null;initialDomElementPosition=null;initialMousePositionOnStage=null;initialTextHalign=null;initialTextPosition=null;node=null;overlay=null;stage=null;text=null;textNode=null};_gliffy.Mouse.registerClickState({name:"shapeTextMover",modes:["shape-text-adjustment"],target:".gliffy-overlay-text-adjustment",mouseDown:function(event){event.stopPropagation();_gliffy.Mouse.setClickMode("shapeTextMover");domElement=$(event.currentTarget);if(domElement.hasClass("gliffy-overlay-text-adjustment")){overlay=self._getOverlay();if(overlay instanceof _gliffy.Overlay){node=overlay.getSelectedNode();if(node instanceof _gliffy.Node){textNode=node.getFirstTopLevelNodeWithGraphic(_gliffy.Text);if(textNode instanceof _gliffy.Node&&textNode.isText){text=textNode.getGraphic();stage=node.stage;_gliffy.Mouse.setState("shape-text-adjustment")}}}}_gliffy.Mouse.__mousedown(event)}});_gliffy.Mouse.registerDragState([{modes:["shape-text-adjustment"],dragStart:function(event){if(node&&overlay&&node.getId()===overlay.__lastTarget){doubleClick=true;overlay.__lastTarget=null;overlay.makeTextEditable()}else{if(domElement&&event&&overlay&&self&&stage&&text){doubleClick=false;initialMousePositionOnStage=new _gliffy.Vec2(event.pageX+stage.getStagePanX()*stage.getZoom(),event.pageY+stage.getStagePanY()*stage.getZoom());initialDomElementPosition=self._getPosition();initialTextPosition=text.getPosition();initialTextHalign=text.getHalign();self._displayTextAnchors();domElement.removeClass("dropped");domElement.addClass("dragging");overlay.hideControls();overlay.__setLastTarget();GliffyApp.contextualPropertiesController.hideControls()}}},drag:function(event){var delta,mousePositionOnStage,nearestAnchor,position,theta;if(!doubleClick){if(event&&initialDomElementPosition&&initialMousePositionOnStage&&overlay&&self&&stage&&text){nearestAnchor=self._nearestTextAnchor();if(text.getPosition()!==nearestAnchor.position){text.setPosition(nearestAnchor.position)}mousePositionOnStage=new _gliffy.Vec2(event.pageX+stage.getStagePanX()*stage.getZoom(),event.pageY+stage.getStagePanY()*stage.getZoom());theta=-overlay.getRotation();delta=_gliffy.Vec2.difference(mousePositionOnStage,initialMousePositionOnStage);delta=new _gliffy.AffineTransform().rotate(theta,0,0).transformPoint(delta.x,delta.y);position=new _gliffy.Vec2(initialDomElementPosition.x+delta.x,initialDomElementPosition.y+delta.y);domElement.css("top",position.y+"px");domElement.css("left",position.x+"px");self._setPosition(position)}}},dragEnd:function(event){var newTextHalign,newTextPosition;if(!doubleClick){if(domElement&&initialTextPosition&&initialTextHalign&&overlay&&self&&textNode&&text){newTextPosition=text.getPosition();newTextHalign=text.getHalign();if(newTextPosition!==initialTextPosition||newTextHalign!==initialTextHalign){self._logEvent(newTextPosition);text.setPosition(initialTextPosition,{skipHalign:true});text.setHalign(initialTextHalign,{skipCommandRegistration:true});overlay.__documentManager.addAndExecuteCommand(new _gliffy.ModifyNodeTextCommand({hAlign:newTextHalign,node:textNode,position:newTextPosition}))}}self._hideTextAnchors();domElement.removeClass("dragging");domElement.addClass("dropped");overlay.showControls();GliffyApp.contextualPropertiesController.showControls(overlay);overlay.refresh();clearDragManagerVariables();self._displayOverText()}},autoPan:true}])},_getDomElement:function(){return this._domElement},_getOverlay:function(){return this._overlay},_getPosition:function(){return this._position},_getTextPositionAnchors:function(){return this._textPositionAnchors},_getTransparentOutline:function(){return this._transparentOutline},_setDomElement:function(domElement){this._domElement=domElement},_setOverlay:function(overlay){this._overlay=overlay},_setPosition:function(position){this._position=position},_setTextPositionAnchors:function(textPositionAnchors){this._textPositionAnchors=textPositionAnchors},_setTransparentOutline:function(transparentOutline){this._transparentOutline=transparentOutline},_displayOverText:function(){var borderWidth,node,nodeHeight,nodeWidth,overlay,position,shapeInfo,text,textHeight,textOutline,textNode,textWidth,transparentOutline,xOffset,yOffset,zoom;borderWidth=2;overlay=this._getOverlay();if(overlay instanceof _gliffy.Overlay){node=overlay.getSelectedNode();if(node instanceof _gliffy.Node){shapeInfo=node.getShapeInformation();if(shapeInfo&&shapeInfo.mutableProperties&&$.inArray("textPosition",shapeInfo.mutableProperties)>0){textNode=node.getFirstTopLevelNodeWithGraphic(_gliffy.Text);if(textNode&&textNode.isText()){text=textNode.getGraphic();nodeHeight=node.getHeight();nodeWidth=node.getWidth();zoom=node.stage.getZoom();textHeight=textNode.getHeight();textWidth=textNode.getWidth();if(text.getOverflow()!=="none"){textWidth+=OVERFLOW_TEXT_WIDTH_DIFFERENCE}switch(text.getVPosition()){case"below":yOffset=nodeHeight+text.getOuterPaddingBottom();break;case"above":yOffset=-(textHeight+text.getOuterPaddingTop());break;default:yOffset=(nodeHeight-textHeight)/2}switch(text.getHPosition()){case"right":xOffset=nodeWidth+text.getOuterPaddingRight();break;case"left":xOffset=-(textWidth+text.getOuterPaddingLeft());break;default:xOffset=(nodeWidth-textWidth)/2}textOutline=this._getDomElement();textOutline.width(textWidth*zoom-borderWidth);textOutline.height(textHeight*zoom-borderWidth);position=new _gliffy.Vec2(xOffset*zoom-borderWidth,yOffset*zoom-borderWidth);textOutline.css("left",xOffset*zoom-borderWidth);textOutline.css("top",yOffset*zoom-borderWidth);this._setPosition(position);this._show();transparentOutline=this._getTransparentOutline();transparentOutline.width(textWidth*zoom-borderWidth+TRANSPARENT_OUTLINE_SIZE_DIFFERENCE);transparentOutline.height(textHeight*zoom-borderWidth+TRANSPARENT_OUTLINE_SIZE_DIFFERENCE);overlay.__overlayOutline.append(textOutline)}}}}},_displayTextAnchors:function(){var anchor,anchors,borderWidth,element,i,node,nodeHeight,nodeWidth,overlay,position,text,textHeight,textNode,textWidth,xOffset,xOffsets,yOffset,yOffsets,zoom;borderWidth=2;overlay=this._getOverlay();if(overlay instanceof _gliffy.Overlay){node=overlay.getSelectedNode();if(node instanceof _gliffy.Node){nodeHeight=node.getHeight();nodeWidth=node.getWidth();zoom=node.stage.getZoom();textNode=node.getFirstTopLevelNodeWithGraphic(_gliffy.Text);if(textNode){text=textNode.getGraphic();textHeight=textNode.getHeight();textWidth=textNode.getWidth();if(text.getOverflow()!=="none"){textWidth+=OVERFLOW_TEXT_WIDTH_DIFFERENCE}xOffsets={left:-(textWidth+text.getOuterPaddingLeft()),right:nodeWidth+text.getOuterPaddingRight(),center:(nodeWidth-textWidth)/2};yOffsets={above:-(textHeight+text.getOuterPaddingTop()),below:nodeHeight+text.getOuterPaddingBottom(),center:(nodeHeight-textHeight)/2};anchors=this._getTextPositionAnchors();for(i=0;i<anchors.length;i++){anchor=anchors[i];switch(anchor.position){case"above":xOffset=xOffsets.center;yOffset=yOffsets.above;break;case"below":xOffset=xOffsets.center;yOffset=yOffsets.below;break;case"right":xOffset=xOffsets.right;yOffset=yOffsets.center;break;case"left":xOffset=xOffsets.left;yOffset=yOffsets.center;break;case"center":xOffset=xOffsets.center;yOffset=yOffsets.center;break}element=anchor.element;element.width(textWidth*zoom-borderWidth);element.height(textHeight*zoom-borderWidth);position=new _gliffy.Vec2(xOffset*zoom-borderWidth,yOffset*zoom-borderWidth);element.css("left",position.x);element.css("top",position.y);anchor.coordinates=position;element.addClass("active");overlay.__overlayOutline.append(element)}}}}},_hide:function(){var domElement;domElement=this._getDomElement();domElement.removeClass("active");domElement.removeClass("dragging");domElement.removeClass("dropped")},_hideTextAnchors:function(){var anchor,anchors,i;anchors=this._getTextPositionAnchors();for(i=0;i<anchors.length;i++){anchor=anchors[i];anchor.element.removeClass("active")}},_logEvent:function(newPosition){_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeTextMover",action:"text_moved_to_"+newPosition})},_nearestTextAnchor:function(){var anchor,anchors,anchorPosition,minSquaredDistance,moverPosition,nearestAnchor,squaredDistance;moverPosition=this._getPosition();minSquaredDistance=Number.MAX_VALUE;anchors=this._getTextPositionAnchors();for(i=0;i<anchors.length;i++){anchor=anchors[i];anchorPosition=anchor.coordinates;squaredDistance=_gliffy.Coordinate.squaredDistance(moverPosition,anchorPosition);if(squaredDistance<minSquaredDistance){minSquaredDistance=squaredDistance;nearestAnchor=anchor}}return nearestAnchor},_show:function(){this._getDomElement().addClass("active")},_registerEventListeners:function(){var displayEvents,hideEvents;displayEvents=["gliffy-overlay-shape-resize-dragEnd","gliffy-overlay-shape-overlay-dragEnd","gliffy-overlay-shape-rotate-dragEnd","gliffy-overlay-select"].join(" ");hideEvents=["gliffy-overlay-shape-resize-dragStart","gliffy-overlay-shape-overlay-dragStart","gliffy-overlay-shape-rotate-dragStart","gliffy-overlay-deselect"].join(" ");this._getOverlay().getManager().getContainer().on(hideEvents,$.proxy(this._hide,this));this._getOverlay().getManager().getContainer().on(displayEvents,$.proxy(this._displayOverText,this))}})}());(function(){var KEYS_PC={nudgeStageUp:"up",nudgeStageLeft:"left",nudgeStageDown:"down",nudgeStageRight:"right",jumpStageUp:"ctrl+up",jumpStageLeft:"ctrl+left",jumpStageDown:"ctrl+down",jumpStageRight:"ctrl+right",doNothing:"home end pagedown pageup",arrowsDoNothing:"up down left right shift+up shift+down shift+right shift+left",cut:"ctrl+x",copy:"ctrl+c",paste:"ctrl+v","delete":"backspace del",blur:"esc",selectAll:"ctrl+a",toggleFrameRate:"ctrl+shift+d",undo:"ctrl+z",redo:"ctrl+shift+z ctrl+y",textMode:"ctrl+2",ellipseMode:"ctrl+9",rectMode:"ctrl+8",connectMode:"ctrl+3",lineMode:"ctrl+6",nudgeLeft:"left shift+left",nudgeRight:"right shift+right",nudgeUp:"up shift+up",nudgeDown:"down shift+down",enterRTE:"F2",dumpFile:"ctrl+shift+F1",toggleVersionInfo:"ctrl+shift+F2",group:"ctrl+g",ungroup:"ctrl+u",sendFront:"ctrl+f",sendBack:"ctrl+b",save:"ctrl+s",zoomIn:"alt+plus alt+ffplus alt+numpadplus ctrl+plus ctrl+ffplus ctrl+numpadplus",zoomOut:"alt+minus alt+ffminus alt+numpadminus ctrl+minus ctrl+ffminus ctrl+numpadminus",pan:"space",switchFields:"tab",switchFieldsBackward:"shift+tab",print:"ctrl+p"},KEYS_MAC={nudgeStageUp:"up",nudgeStageLeft:"left",nudgeStageDown:"down",nudgeStageRight:"right",jumpStageUp:"meta+up",jumpStageLeft:"meta+left",jumpStageDown:"meta+down",jumpStageRight:"meta+right",doNothing:"home end pagedown pageup",arrowsDoNothing:"up down left right shift+up shift+down shift+right shift+left",cut:"meta+x",copy:"meta+c",paste:"meta+v","delete":"backspace del",blur:"esc",selectAll:"meta+a",toggleFrameRate:"meta+shift+d",undo:"meta+z",redo:"meta+shift+z meta+y",textMode:"meta+2 ctrl+2",ellipseMode:"meta+9 ctrl+9",rectMode:"meta+8 ctrl+8",connectMode:"meta+3 ctrl+3",lineMode:"meta+6 ctrl+6",nudgeLeft:"left shift+left",nudgeRight:"right shift+right",nudgeUp:"up shift+up",nudgeDown:"down shift+down",enterRTE:"F2",dumpFile:"meta+shift+F1",toggleVersionInfo:"meta+shift+F2",group:"meta+g",ungroup:"meta+u",sendFront:"meta+f",sendBack:"meta+b",save:"meta+s",zoomIn:"meta+plus meta+ffplus meta+numpadplus",zoomOut:"meta+minus meta+ffminus meta+numpadminus",pan:"space",switchFields:"tab",switchFieldsBackward:"shift+tab",print:"meta+p"};_gliffy.Editor=_gliffy.Class.extend({__documentManager:null,__actions:null,overlayManager:null,drawManager:null,documentTabsController:null,container:null,rootServiceUrl:null,rootResourceUrl:null,svgToStencilTransformURL:null,imageContext:null,readyCallback:null,errorCallback:null,colorPicker:null,__drawMode:0,__node:null,__mouseDownPosition:null,__contextMenu:null,containerBounds:null,exportTo:null,postSaveCallback:null,postCloseCallback:null,saving:false,productVersion:null,customerId:null,language:null,init:function(o){if(!o){throw new Error("editor init needs options")}else{if(!o.target){throw new Error("editor init options needs target")}else{if(!o.rootServiceUrl){throw new Error("editor init options needs rootServiceUrl")}else{if(!o.integration){throw new Error("editor init options needs integration")}}}}_gliffy.IntegrationHandler.validate(o.integration);var options,self=this,editor=this,dragStageDiv,selectedNode,fontPath=(o.fontPath!==undefined)?o.fontPath:null;this.integration=o.integration;this.container=o.target;this.rootServiceUrl=o.rootServiceUrl;this.svgToStencilTransformURL=o.svgToStencilTransformURL;this.rootResourceUrl=(o.rootResourceUrl!==undefined)?o.rootResourceUrl:null;this.imageContext=o.imageContext;this.__actions=o.actions;this.productVersion=o.productVersion;this.customerId=o.customerId;this.readyCallback=o.readyCallback;this.errorCallback=o.errorCallback;this.draftInterval=o.draftInterval||30;this.draftsEnabled=o.draftsEnabled||false;this.analyticsEnabled=(o.analyticsEnabled!==undefined?o.analyticsEnabled:true);this.analyticsAccount=o.analyticsAccount||"UA-248648-8";this.analyticsLabel=o.analyticsLabel||null;this.analyticsProduct=o.analyticsProduct||"none";this.analyticsLicense=o.analyticsLicense||"none";this.analyticsNumUsers=o.analyticsNumUsers||0;this.newDiagramPanels=o.newDiagramPanels;this.pluginsReadyCallback=o.pluginsReadyCallback;this.language=o.language||null;this.imageExportType=o.imageExportType||"smallest";this.bindBeforeUnloadOverride=o.bindBeforeUnloadOverride;this.confluenceVersion=o.confluenceVersion||null;this.enableCustomShapes=_gliffy.Utils.getValueOrDefault(o.enableCustomShapes,true);this.enableImagePanel=_gliffy.Utils.getValueOrDefault(o.enableImagePanel,true);this.exportTo=_gliffy.Utils.getValueOrDefault(o.exportTo,["PNG","JPG","SVG","Gliffy"]);_gliffy.confluenceVersion=this.confluenceVersion;_gliffy.versionString=this.productVersion;_gliffy.analyticsProduct=this.analyticsProduct;_gliffy.CursorManager=new _gliffy._CursorManager({container:this.container});_gliffy.KeyManager=new _gliffy._KeyManager({container:this.container,editor:this});window.GLIFFY.KeyManager=_gliffy.KeyManager;this.init_i18n();_gliffy.LayersContextMenu=new _gliffy._LayersContextMenu();_gliffy.FontLoader.setPath(fontPath);_gliffy.TextUtils.appendWebFontFixes();if(this.analyticsEnabled){_gliffy.Utils.analyticsEvent("init",{accountType:"google",accountID:this.analyticsAccount,debug:_gliffy.Debug.USE_ANALYTICS_DEBUG_JS});if(_gliffy.Debug.LOG_ANALYTICS){_gliffy.Utils.analyticsEvent("logEvents",{logEvents:true,logger:_gliffy.Logger})}if(this.analyticsLabel){_gliffy.Utils.analyticsEvent("setLabel",{label:this.analyticsLabel})}_gliffy.Utils.analyticsEvent("setCustomVariables",{product:this.analyticsProduct,license:this.analyticsLicense,numUsers:(this.analyticsNumUsers+" Users")});_gliffy.Utils.analyticsEvent("trackEvent",{category:"editorLanguage",action:(this.language||"en"),non_interaction:true});_gliffy.GoogleTagManager=new _gliffy._GoogleTagManager("GTM-KQ5R7B")}if($.browser.msie){$("body").on("selectstart","div",function(e){if($("input:focus, textarea:focus").length===0){e.preventDefault()}})}if(_gliffy.BrowserDetect.OS==="Mac"){_gliffy.KeyManager.addKeyBindings(KEYS_MAC)}else{_gliffy.KeyManager.addKeyBindings(KEYS_PC)}if(_gliffy.BrowserDetect.browser==="Explorer"){$("#gliffy").addClass("gliffy-ie")}$("body").bind("send-error.gliffy-body",function(event,errorObj){if(self.errorCallback){self.errorCallback(errorObj)}});this.__documentManager=new _gliffy.DocumentManager({editor:this});dragStageDiv=new _gliffy.StageDiv({documentManager:this.__documentManager,container:this.container});options={documentManager:this.__documentManager,target:o.target,editor:this,dragStageDiv:dragStageDiv,linkBrowser:o.linkBrowser};this.drawManager=new _gliffy.DrawManager(options);GliffyApp.toolbarController.config({editor:this});GliffyApp.exportDialogController.config({editor:this});GliffyApp.contextualPropertiesController.setEditor(this);GliffyApp.colorpickerController=GliffyApp.ColorpickerController.create({__editor:this});GliffyApp.contextMenuController=GliffyApp.ContextMenuController.create({__editor:this});GliffyApp.tipsController.config({editor:this,tips:o.tips});GliffyApp.pageNavigatorController=GliffyApp.PageNavigatorController.create({__editor:this});GliffyApp.progressBarController.config({editor:this});if(this.container.find("gliffy-stage").length===0){this.container.append($("<div />",{"class":"gliffy-stage"}))}_gliffy.Mouse=new _gliffy._Mouse({editor:self});_gliffy.ShapeLinker=new _gliffy._ShapeLinker({editor:self});window.GLIFFY.Mouse=_gliffy.Mouse;_gliffy.Mouse.registerClickState({name:"stage",target:".gliffy-stage",modes:$.extend([],_gliffy.Editor.DRAW_MODE_NAMES),mouseDown:function(event){var self=_gliffy.Mouse,pos,pickData,textChild;_gliffy.Mouse.setClickMode("stage");_gliffy.Utils.stealFocus();$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");if(self.getState()==="none"){pos=_gliffy.Mouse.getPosition();pickData=_gliffy.Pick.getNodeAtExt(editor.getDocumentManager().getActiveStage().objects,pos.x,pos.y,{excludeUnpickableNodes:true});selectedNode=pickData.node;textChild=pickData.textChild;if(!selectedNode&&(_gliffy.KeyManager.shiftKeyDown||_gliffy.KeyManager.metaCtrlKeyDown)){self.__mousedown(event)}else{if(!selectedNode||(selectedNode.getLockPosition()&&!(_gliffy.KeyManager.shiftKeyDown||_gliffy.KeyManager.metaCtrlKeyDown))){if(!$(event.target).hasClass("gliffy-link-edit")){editor.overlayManager.singleDownNoNode(event);self.__mousedown(event)}}else{if(!textChild){editor.getDocumentManager().pushCommandBundle()}editor.overlayManager.singleDownWithNode(event,selectedNode,textChild)}}}else{if(self.getState()!=="line"&&self.getState()!=="ortho"){editor.overlayManager.singleDownNoNode(event);if(self.getState()==="none"){pos=_gliffy.Mouse.getPosition();selectedNode=_gliffy.Pick.getNodeAt(editor.getDocumentManager().getActiveStage().objects,pos.x,pos.y);if(selectedNode){editor.getDocumentManager().pushCommandBundle();editor.overlayManager.singleDownWithNode(event,selectedNode)}else{self.__mousedown(event)}}else{self.__mousedown(event)}}else{self.__mousedown(event)}}}});_gliffy.Mouse.setState("none");this.overlayManager=new _gliffy.OverlayManager(options);this.selector=new _gliffy.Selector({documentManager:options.documentManager,overlayManager:this.overlayManager,stageDiv:options.dragStageDiv});this.zoomOverlay=new _gliffy.ZoomOverlay({stageDiv:options.dragStageDiv,documentManager:options.documentManager});GliffyApp.documentTabsController=GliffyApp.DocumentTabsController.create({__editor:this});this.documentTabsController=GliffyApp.documentTabsController;GliffyApp.documentPropertiesController.setEditor(this);GliffyApp.documentPropertiesController.config();GliffyApp.saveDialogController.config({editor:this});window.GLIFFY.toolbarController=GliffyApp.toolbarController;this.grid=new _gliffy.Grid({documentManager:this.__documentManager});this.pageBreaks=new _gliffy.PageBreaks({documentManager:this.__documentManager});if(!window.jasmine){GliffyApp.PrintModel.setUserDefaults(this.performAction("getRemotePrintModel"))}GliffyApp.revisionHistoryController.config({editor:this});GliffyApp.hudController=GliffyApp.HudController.create({__editor:this});GliffyApp.linkHudController.config({editor:this});GliffyApp.styleCopyController.config({__editor:this});GliffyApp.layersController.config({editor:this,debug:_gliffy.Debug.SHOW_LAYERS});this.setupEditor(function(){if(self.readyCallback){self.readyCallback(self)}});this.setDrawMode(_gliffy.Editor.DRAW_MODE.none);this.colorPicker=$("#gliffy-colorpicker").ColorPicker({flat:true});this.__bindResizeContainer();this.drawManager.bindDrawHandlers();GliffyApp.contextMenuController.createContextMenu(this,".gliffy-stage",this.getStageContextMenuObject(),"gliffy-context-menu-stage");GliffyApp.saveDialogController.getFilenameElement().click(function(event){GliffyApp.saveDialogController.getFilenameElement().parents("div.control-group").removeClass("error").find("span.help-inline").empty()});$(window).unbind("rte-resize.gliffy-edit-text.editable-text").bind("rte-resize.gliffy-edit-text.editable-text",function(event){var node=self.getDocumentManager().getActiveStage().find(event.node.getId()),parent,change;if(node){if(event.w!==undefined&&event.w!==null){node.setWidth(event.w);self.getDocumentManager().redraw()}if(event.h!==undefined&&event.h!==null){if(node.isPartOfMultipartShape()){parent=node.getUidNode();if(parent.getUid()==="com.gliffy.shape.bpmn.bpmn_v1.data_artifacts.annotation"){change=(node.getHeight()-(node.getGraphic().getPaddingTop()+node.getGraphic().getPaddingBottom()+event.h))/2;if(Math.abs(change)>5){parent.setY(parent.getY()+change)}}node.setHeight(event.h+node.getGraphic().getPaddingTop()+node.getGraphic().getPaddingBottom())}else{node.setHeight(event.h)}self.getDocumentManager().redraw()}}});_gliffy.Align=new _gliffy._Align({documentManager:this.__documentManager});_gliffy.RenderLoop.start();$("body").on("shown",".gliffy-popup .modal",function(){var skipNodeDeselect=($(this).data("skipNodeDeselect"))||false;$(this).removeData("skipNodeDeselect");if(!skipNodeDeselect){self.overlayManager.deselectAll();_gliffy.KeyManager.handleEscKeypress()}_gliffy.KeyManager.setState("modals");$(this).on("focus","input",function(event){_gliffy.KeyManager.setState("input")});$(this).on("focus","textarea",function(event){_gliffy.KeyManager.setState("input")});$(this).on("blur","input",function(event){if(_gliffy.KeyManager.getState()==="input"){_gliffy.KeyManager.setLastState()}});$(this).on("blur","textarea",function(event){if(_gliffy.KeyManager.getState()==="input"){_gliffy.KeyManager.setLastState()}})});$("body").on("hidden",".gliffy-popup .modal",function(){if($("#gliffy-edit-text_ifr").is(":visible")){_gliffy.KeyManager.setState("rte")}else{_gliffy.KeyManager.setState("stage")}$(this).off("focus","input");$(this).off("focus","textarea");$(this).off("blur","input");$(this).off("blur","textarea")});_gliffy.KeyManager.registerState("modals","default",[{action:"nudgeStageRight",keydown:function(e){e.preventDefault()}},{action:"nudgeStageLeft",keydown:function(e){e.preventDefault()}},{action:"nudgeStageDown",keydown:function(e){e.preventDefault()}},{action:"nudgeStageUp",keydown:function(e){e.preventDefault()}},{action:"jumpStageRight",keydown:function(e){e.preventDefault()}},{action:"jumpStageLeft",keydown:function(e){e.preventDefault()}},{action:"jumpStageDown",keydown:function(e){e.preventDefault()}},{action:"jumpStageUp",keydown:function(e){e.preventDefault()}}]);_gliffy.Plugins.activate(this);if(!window.jasmine){this.initNavigator()}this.bindBeforeUnload(this.bindBeforeUnloadOverride);$(window).unload(function(){if(!window.jasmine){_gliffy.Utils.analyticsEvent("trackEvent",{category:"time",action:"editing",value:(new Date().getTime()-GLIFFY_START_TIME)/1000,non_interaction:true})}});GliffyApp.themeController.config({editor:this});if(_gliffy.Debug.POLL_LAYER_STATE&&_gliffy.DebugUtils){setTimeout(function(){_gliffy.DebugUtils.pollLayerState(self)},3000)}$("#gliffy-toolbar-button-pointer").click()},init_i18n:function(){$(".gliffy-colorswatchpicker button").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD)},openTips:function(){GliffyApp.tipsController.openOnInit()},getExportTo:function(){return this.exportTo},openUpdateSplash:function(options){if(window.GliffyApp&&window.GliffyApp.updateSplashController){return window.GliffyApp.updateSplashController.openOnInit(options)}return false},showSpinner:function(){_gliffy.Spinner.show(arguments)},hideSpinner:function(){_gliffy.Spinner.hide(arguments)},initNavigator:function(){var zoomAmounts=_gliffy.ZoomOverlay.ZOOM_AMOUNTS,slider,self=this,lastValue;lastValue=zoomAmounts.indexOf(1);slider=new _gliffy.Slider({target:$("#gliffy-navigator-zoom-slider"),namespace:"gliffy.editor.zoom",min:0,max:zoomAmounts.length-1,value:lastValue,reset_value:lastValue,reset_step:1,step:1,dragCallback:function(slider){var actualZoom=self.getDocumentManager().getActiveStage().getZoom(),sliderZoom=zoomAmounts[Math.round(slider.value)];if(!_gliffy.Utils.floatEquals(sliderZoom,actualZoom)){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");self.overlayManager.deselectAll();self.getDocumentManager().zoomToCenter(sliderZoom)}}});$(document).bind("gliffy.zoom",function(event,value){var smallestDiff=10000,smallestDiffIdx=null,i,diff;for(i=0;i<zoomAmounts.length;i++){diff=Math.abs(zoomAmounts[i]-value);if(diff<smallestDiff){smallestDiff=diff;smallestDiffIdx=i}}if(smallestDiffIdx!==null){slider.value=smallestDiffIdx;slider.moveHandle()}})},isSaving:function(){return this.saving},getDocumentManager:function(){return this.__documentManager},unsavedChanges:function(){var i;for(i=0;i<this.getDocumentManager().getDocuments().length;i++){if(this.getDocumentManager().getDocuments()[i].getStage().hasUnsavedChanges()){return true}}return false},open:function(options){this.getDocumentManager().disableRenderLoop();this.container.scrollTop(0).scrollLeft(0);options.target=this.container;_gliffy.Mouse.reset();this.overlayManager.textControl.reset();this.getDocumentManager().render(options)},openInNewTab:function(options){GliffyApp.documentTabsController.selectTab(new _gliffy.Document());this.open(options)},openTemplateFromGON:function(gon,options){var jsonObj={name:"untitled",version:0,gon:gon};options.jsonObj=jsonObj;this.open(options)},setupEditor:function(callback,libraries){this.createUntitledTab(callback,[])},createUntitledTab:function(callback,libraries){var document=new _gliffy.Document();if(libraries){document.setLibrariesMetadata(libraries)}this.getDocumentManager().disableRenderLoop();this.container.scrollTop(0).scrollLeft(0);_gliffy.Mouse.reset();this.overlayManager.textControl.reset();this.__documentManager.setActiveDocument(document,true);if(!window.jasmine){this.__documentManager.render({jsonObj:document.toObject(),scale:1,callback:callback,target:this.container,loadLibraryPanels:false})}},create:function(callback,libraries){var document=new _gliffy.Document();if(libraries){document.setLibrariesMetadata(libraries);_gliffy.Utils.analyticsEvent("trackEvent",{category:"createWithLibraries",action:libraries.join(",")})}this.open({jsonObj:document.toObject(),scale:1,callback:callback})},close:function(){var self=this;if(this.unsavedChanges()){_gliffy.Dialog.showYesNoDialog({title:$.i18n._("EDITOR_CONFIRM_NAVIGATION"),content:$.i18n._("EDITOR_YOU_HAVE_UNSAVED_CHANGES._ARE_YOU_SURE_YOU_WANT_TO_LEAVE_THIS_PAGE?"),cancelCallback:null,buttons:[{text:$.i18n._("EDITOR_STAY_ON_THIS_PAGE"),callback:function(e){if(self.postCloseCallback){self.postCloseCallback({userCancelled:true})}},primary:false,dismiss:true},{text:$.i18n._("EDITOR_LEAVE_THIS_PAGE"),callback:function(e){self.__close();return false},primary:true,dismiss:true}]})}else{this.__close()}},__close:function(){var i;for(i=0;i<this.getDocumentManager().getDocuments().length;i++){this.getDocumentManager().getDocuments()[i].getStage().setUnsavedChanges(false)}if(window.parent!==window){GliffyApp.documentTabsController.closeAllTabs();this.getDocumentManager().cleanTarget()}this.performAction("close");if(this.postCloseCallback){this.postCloseCallback({userCancelled:false})}},closeLastTab:function(){this.integration.closeLastTab(this)},blur:function(){_gliffy.RenderLoop.stop()},focus:function(){_gliffy.RenderLoop.start()},__doSave:function(doSaveSuccessCallback,doSaveErrorCallback){var self=this,revision=this.getDocumentManager().getActiveDocument().getCurrentRevision(),originalTitle=this.getDocumentManager().getActiveDocument().getTitle(),successCallback,errorCallback;if(!this.saving){this.saving=true;successCallback=function(data,textStatus,xhr){self.saving=false;$(".gliffy-save button,.gliffy-save-dialog-button").html($.i18n._("EDITOR_SAVE")).removeAttr("disabled");$(".gliffy-save-blocker").remove();if(data.error){GliffyApp.saveDialogController.showErrorMessage(data.error);if(revision<1&&originalTitle){self.getDocumentManager().getActiveDocument().setTitle(originalTitle)}if(doSaveErrorCallback){doSaveErrorCallback(data)}}else{GliffyApp.saveDialogController.hide();self.getDocumentManager().getActiveDocument().refreshFromObject(data);self.getDocumentManager().getActiveStage().setUnsavedChanges(false);GliffyApp.documentModel.update(self.getDocumentManager().getActiveDocument());if(self.postSaveCallback){self.postSaveCallback()}if(doSaveSuccessCallback){doSaveSuccessCallback(data)}}self.postSaveCallback=null};errorCallback=function(xhr,textStatus,errorThrown){var content,repl;self.saving=false;$(".gliffy-save button,.gliffy-save-dialog-button").html($.i18n._("EDITOR_SAVE")).removeAttr("disabled");$(".gliffy-save-blocker").remove();if(revision<1&&originalTitle){self.getDocumentManager().getActiveDocument().setTitle(originalTitle)}if(xhr.status===400){GliffyApp.saveDialogController.getFilenameElement().parents("div.control-group").addClass("error").find("span.help-inline").text(xhr.responseText)}else{if(xhr.status===401){repl="#";if(window.parent.jQuery){content=window.parent.jQuery("#confluence-base-url").attr("content");if(content&&content.length>0){repl=content}else{if(window.GLIFFY&&window.GLIFFY.baseConfluenceUrl){repl=window.GLIFFY&&window.GLIFFY.baseConfluenceUrl}}}_gliffy.Dialog.showAlertDialog({escapeHTML:false,content:$.i18n._("ERROR_SAVE_FAILURE").replace("{0}",repl),title:$.i18n._("ERRORHANDLER_ERROR")})}else{GliffyApp.saveDialogController.showErrorMessage(xhr.responseText)}}if(doSaveErrorCallback){doSaveErrorCallback(xhr,textStatus,errorThrown)}self.postSaveCallback=null};$(".gliffy-save button,.gliffy-save-dialog-button").html('<div class="gliffy-save-spinner"></div>&nbsp;'+$.i18n._("EDITOR_SAVING...")).attr("disabled",true);$("body").append($('<div class="gliffy-save-blocker gliffy-super-ui-blocker"></div>'));if(self.getDocumentManager().getActiveDocument().getCurrentRevision()<1){self.getDocumentManager().getActiveDocument().setTitle(GliffyApp.saveDialogController.getFilename())}this.getDocumentManager().getActiveStage().update();setTimeout(function(){self.getDocumentManager().getImageData(self.getDocumentManager().getActiveStage(),self.imageExportType,function(imageData){self.getDocumentManager().getActiveDocument().setImage(imageData);if(self.getDocumentManager().getActiveDocument().getCurrentRevision()<1){self.performAction("create",self.getDocumentManager().getActiveDocument().toObject(),successCallback,errorCallback)}else{self.performAction("save",self.getDocumentManager().getActiveDocument().toObject(),successCallback,errorCallback)}},false,1)},10)}},save:function(postSaveCallback){var self=this,oldPostSaveCallback;this.deselect();if(postSaveCallback){if(this.postSaveCallback){oldPostSaveCallback=this.postSaveCallback;this.postSaveCallback=function(){postSaveCallback();oldPostSaveCallback()}}else{this.postSaveCallback=postSaveCallback}}self.getDocumentManager().getDraftManager().hideNotifications();if((self.getDocumentManager().getActiveDocument().getCurrentRevision()+1||1)===1){GliffyApp.saveDialogController.show()}else{this.__doSave()}},deselect:function(){this.overlayManager.deselectAll();_gliffy.KeyManager.setState("stage");$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text")},__bindResizeContainer:function(){var self=this,$window=$(window),resizeContainer,offset;resizeContainer=function(){self.__resizeContainer()};$window.bind("resize",resizeContainer);$window.load(resizeContainer);resizeContainer()},resizeContainer:function(){this.__resizeContainer()},__resizeContainer:function(){var $window=$(window),offset=this.container.offset(),width=$window.width()-offset.left,height=$window.height()-offset.top-$("#gliffy-bottom-panel").height();$(".gliffy-sidebar").css("height",($window.height()-$(".navbar-fixed-top").height()-30)+"px");this.container.css({width:width+"px",height:height+"px",overflow:"scroll"});this.containerBounds=new _gliffy.BoundingBox(offset.left,offset.top,offset.left+width,offset.top+height)},inZoomInMode:function(){return this.isZoomInMode(this.__drawMode)},inZoomOutMode:function(){return this.isZoomOutMode(this.__drawMode)},inZoomMode:function(){return this.isZoomMode(this.__drawMode)},inLineDrawMode:function(){return this.isLineDrawMode(this.__drawMode)},inShapeDrawMode:function(){return this.isShapeDrawMode(this.__drawMode)},isLineDrawMode:function(mode){return mode===_gliffy.Editor.DRAW_MODE.line||mode===_gliffy.Editor.DRAW_MODE.ortho},isShapeDrawMode:function(mode){return mode===_gliffy.Editor.DRAW_MODE.ellipse||mode===_gliffy.Editor.DRAW_MODE.rectangle},isZoomMode:function(mode){return mode===_gliffy.Editor.DRAW_MODE.zoomIn||mode===_gliffy.Editor.DRAW_MODE.zoomOut},isZoomInMode:function(mode){return mode===_gliffy.Editor.DRAW_MODE.zoomIn},isZoomOutMode:function(mode){return mode===_gliffy.Editor.DRAW_MODE.zoomOut},__showConnectionPoints:function(show){var stage=this.getDocumentManager().target?this.getDocumentManager().target.find(".gliffy-stage"):null;if(stage){this.overlayManager.lineOverlay.showConnectionPoints(show);this.overlayManager.lineOverlay.setLineDrawMode(show)}},setDrawMode:function(mode){if(mode!=="undefined"&&mode!==null){if(mode!==this.__drawMode){$(_gliffy.Editor.DRAW_MODE_BUTTONS[this.__drawMode]).removeClass("active");if(this.__drawMode===_gliffy.Editor.DRAW_MODE.line||this.__drawMode===_gliffy.Editor.DRAW_MODE.ortho){this.overlayManager.lineOverlay.unhighlightConnectionPoints()}}$(_gliffy.Editor.DRAW_MODE_BUTTONS[mode]).addClass("active");this.__drawMode=mode;this.overlayManager.setDrawMode(this.__drawMode);_gliffy.CursorManager.setCursor(_gliffy.Editor.DRAW_MODE_CURSORS[mode]);this.__showConnectionPoints(this.inLineDrawMode());_gliffy.KeyManager.setState("stage");_gliffy.Mouse.setState(_gliffy.Editor.DRAW_MODE_NAMES[mode])}},getDrawMode:function(){return this.__drawMode},viewActiveDocumentSource:function(){var timeout,display,keyState,destroy,self=this;display=$("<div class='gliffy-super-ui-blocker gliffy-semi-opaque'><div class='gliffy-document-window'><h1>"+$.i18n._("EDITOR_DOCUMENT_SOURCE")+"</h1><pre>"+$.i18n._("EDITOR_LOADING...")+"</pre><div><input type='button' class='btn' value='"+$.i18n._("EDITOR_CLOSE")+"'/><input type='button' class='btn' value='"+$.i18n._("EDITOR_SELECT")+"'/><input type='button' class='btn' value='"+$.i18n._("EDITOR_RELOAD")+"'/></div></div></div>");$("body").append(display);timeout=setTimeout(function(){var serializedDocument=JSON.stringify(self.__documentManager.getActiveDocument().getGon().toObject(),undefined,2);serializedDocument=document.createTextNode(serializedDocument);$(".gliffy-document-window pre").html("").get(0).appendChild(serializedDocument);timeout=null;$(".gliffy-document-window input[value=Select]").removeAttr("disabled")},100);keyState=_gliffy.KeyManager.getState();_gliffy.KeyManager.setState(null);destroy=function(){$(document).unbind(".gliffyprintdoc");_gliffy.KeyManager.setState(keyState);display.remove();display=null;destroy=null;if(timeout!==null){clearTimeout(timeout)}};$(document).bind("keydown.gliffyprintdoc","esc",destroy);$(".gliffy-document-window input[value="+$.i18n._("EDITOR_CLOSE")+"]").click(destroy);$(".gliffy-document-window input[value="+$.i18n._("EDITOR_SELECT")+"]").click(function(){var ie9=_gliffy.BrowserDetect.browser==="Explorer"&&_gliffy.BrowserDetect.version===9;if(ie9){if(window.console){window.console.log($(".gliffy-document-window pre").text())}}else{_gliffy.Utils.selectAllTextInElement($(".gliffy-document-window pre"))}});$(".gliffy-document-window input[value="+$.i18n._("EDITOR_RELOAD")+"]").click(function(){if(window.console&&window.console.log){window.console.log("Attempting to reload...")}self.open({jsonObj:self.getDocumentManager().getActiveDocument().toObject(),callback:function(){if(window.console&&window.console.log){window.console.log("File has been reloaded!")}}});destroy()});$(".gliffy-document-window input[value=Select]").attr("disabled",true)},clearContextMenu:function(){return GliffyApp.contextMenuController.clearContextMenu(this.__contextMenu)},bindBeforeUnload:function(overrideFunction){var self=this;if(!_gliffy.Debug.NO_NAVIGATE_WARNING){if(overrideFunction){window.addEventListener("beforeunload",overrideFunction)}else{window.addEventListener("beforeunload",function(e){var warningString=$.i18n._("EDITOR_YOU_HAVE_UNSAVED_CHANGES.");if(self.unsavedChanges()){if(e){e.returnValue=warningString}return warningString}},false)}}},loadLibraryPanels:function(){this.getDocumentManager().loadLibraryPanels()},getStageContextMenuObject:function(){var self=this,stageMenu=[],pushToMenu,pushDivider;pushToMenu=function(key,val){var obj={};obj.text=key;obj.action=val.onclick;obj.className=val.className;stageMenu.push(obj)};pushDivider=function(){stageMenu.push({divider:true})};pushToMenu($.i18n._("EDITOR_PASTE_HERE"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"paste"});_gliffy.Mouse.setLastMouseUpPosition(_gliffy.Mouse.getContextMenuMouseDownPosition());GliffyApp.toolbarController.doPaste()},className:"gliffy-context-menu-item-stage gliffy-context-menu-item-paste"});pushDivider();pushToMenu($.i18n._("EDITOR_SELECT_ALL"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"selectAll"});GliffyApp.toolbarController.doSelectAll()},className:"gliffy-context-menu-item-stage gliffy-context-menu-item-selectAll"});pushDivider();pushToMenu($.i18n._("EDITOR_ZOOM_FIT_TO_SCREEN"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"zoomFit"});self.overlayManager.deselectAll();GliffyApp.toolbarController.handleZoomSelect("fit")},className:"gliffy-context-menu-item-stage gliffy-context-menu-item-zoomFit"});pushToMenu($.i18n._("EDITOR_ZOOM")+" - 400%",{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"zoom400"});self.overlayManager.deselectAll();self.getDocumentManager().zoomAt(4,_gliffy.Mouse.getContextMenuMouseDownPosition().x,_gliffy.Mouse.getContextMenuMouseDownPosition().y)},className:"gliffy-context-menu-item-stage gliffy-context-menu-item-zoom400"});pushToMenu($.i18n._("EDITOR_ZOOM")+" - 200%",{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"zoom200"});self.overlayManager.deselectAll();self.getDocumentManager().zoomAt(2,_gliffy.Mouse.getContextMenuMouseDownPosition().x,_gliffy.Mouse.getContextMenuMouseDownPosition().y)},className:"gliffy-context-menu-item-stage gliffy-context-menu-item-zoom200"});pushToMenu($.i18n._("EDITOR_ZOOM")+" - 100%",{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"zoom100"});self.overlayManager.deselectAll();self.getDocumentManager().zoomAt(1,_gliffy.Mouse.getContextMenuMouseDownPosition().x,_gliffy.Mouse.getContextMenuMouseDownPosition().y)},className:"gliffy-context-menu-item-stage gliffy-context-menu-item-zoom100"});pushToMenu($.i18n._("EDITOR_ZOOM")+" - 50%",{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"zoom50"});self.overlayManager.deselectAll();self.getDocumentManager().zoomAt(0.5,_gliffy.Mouse.getContextMenuMouseDownPosition().x,_gliffy.Mouse.getContextMenuMouseDownPosition().y)},className:"gliffy-context-menu-item-stage gliffy-context-menu-item-zoom50"});pushDivider();pushToMenu($.i18n._("EDITOR_VIEW_DIAGRAM_SOURCE"),{onclick:function(menuItem,menu){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"viewSource"});self.viewActiveDocumentSource()},className:"gliffy-context-menu-item-stage gliffy-context-menu-item-source"});return stageMenu.concat(this.overlayManager.lineOverlay.getContextMenuDefinition())},beforeContextMenuShow:function(menu){_gliffy.Mouse.setContextMenuMouseDownPosition(_gliffy.Mouse.getPosition());var selectedNode,pos=_gliffy.Mouse.getPosition(),dividers;selectedNode=_gliffy.Pick.getNodeAt(this.getDocumentManager().getActiveStage().objects,pos.x,pos.y);dividers=$(".gliffy-context-menu-stage .divider");dividers.show();if(selectedNode&&this.overlayManager.lineOverlay.isActive()&&this.overlayManager.lineOverlay.getSelectedNode()===selectedNode){$(".gliffy-context-menu-stage .gliffy-context-menu-item-stage").hide();$(".gliffy-context-menu-stage .gliffy-context-menu-item-line-overlay").show();$(dividers.get(0)).hide();$(dividers.get(1)).hide();$(dividers.get(2)).hide();this.overlayManager.lineOverlay.beforeContextMenuShow(menu)}else{$(".gliffy-context-menu-stage .gliffy-context-menu-item-stage").show();$(".gliffy-context-menu-stage .gliffy-context-menu-item-line-overlay").hide();$(dividers.get(3)).hide();$(dividers.get(4)).hide()}_gliffy.LayersContextMenu.beforeContextShow(menu,this.__documentManager.getActiveStage().getLayers(),this.overlayManager.overlay.getSelectedNode())},performAction:function(name){var args,self=this;if(this.__actions&&this.__actions[name]){args=Array.prototype.slice.call(arguments);args.shift();return _gliffy.Utils.tryCatch(function(){if(!self.__actions[name]){throw new Error("Missing action: "+name)}return self.__actions[name].apply(self.__actions,args)},function(e){_gliffy.handleError("com.gliffy.error.action_failed",null,e)})}else{_gliffy.handleError("com.gliffy.error.unknown_action")}},getEmbeddedResources:function(){return this.getDocumentManager().getActiveDocument().getEmbeddedResources()},getEmbeddedResource:function(node){if(node.getGraphic() instanceof _gliffy.Svg){return this.getDocumentManager().getActiveDocument().getEmbeddedResources().getResource(node.getGraphic().getEmbeddedResourceId())}return null},dockToBottomPanel:function(element){$("#gliffy-bottom-panel").empty().append(element);this.__resizeContainer()},clearBottomPanel:function(){$("#gliffy-bottom-panel").empty();this.__resizeContainer()},updateContainerSize:function(){this.__resizeContainer()}});_gliffy.Editor.DRAW_MODE_BUTTONS=["#gliffy-toolbar-button-pointer","#gliffy-toolbar-button-lineTool","#gliffy-toolbar-button-connectorTool","#gliffy-toolbar-button-textTool","#gliffy-toolbar-button-pan","#gliffy-toolbar-button-ellipseTool","#gliffy-toolbar-button-rectangleTool","#gliffy-toolbar-button-zoomIn","#gliffy-toolbar-button-zoomOut"];_gliffy.Editor.DRAW_MODE_CURSORS=["default","line","connector","text","hand","ellipse","rectangle","zoom-in","zoom-out","style-copy"];_gliffy.Editor.DRAW_MODE={none:0,line:1,ortho:2,text:3,pan:4,ellipse:5,rectangle:6,zoomIn:7,zoomOut:8,styleCopy:9};_gliffy.Editor.DRAW_MODE_NAMES=["none","line","ortho","text","pan","ellipse","rectangle","zoomIn","zoomOut","styleCopy"];_gliffy.Editor.ORTHO_MODE={straight:0,bezel:1,curved:2};_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD={placement:"bottom",trigger:"hover",delay:{show:650,hide:50}};_gliffy.Editor.TOOLTIP_OPTIONS_QUICK={placement:"bottom",trigger:"hover",delay:{show:0,hide:50}};_gliffy.Editor.TOOLTIP_OPTIONS_SHAPE_LIBRARY={placement:"right",trigger:"hover",delay:{show:650,hide:50}};_gliffy.Editor.TOOLTIP_OPTIONS_LEFT={placement:"left",trigger:"hover",delay:{show:650,hide:50}};_gliffy.Editor.TOOLTIP_OPTIONS_TOP={placement:"top",trigger:"hover",delay:{show:650,hide:50}};_gliffy.Editor.TOOLTIP_OPTIONS_RIGHT={placement:"right",trigger:"hover",delay:{show:650,hide:50}};_gliffy.Editor.LOREM_IPSUM_TEXT="Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.";_gliffy.Editor.CONTEXT_MENU_STYLE="gliffy"}());(function(){GliffyApp.DocumentModel=Ember.Object.extend({title:"",currentRevision:0,zoom:1,gridVisible:true,pageBreaksVisible:false,exportBorder:false,maxWidth:5000,maxHeight:5000,unsavedChanges:false,snapToGrid:true,drawingGuides:false,pageColor:"#FFFFFF",autosaveDisabled:false,loadPosition:"default",viewportType:"default",reset:function(){this.set("title","");this.set("currentRevision",0);this.set("zoom",1);this.set("gridVisible",true);this.set("pageBreaksVisible",false);this.set("exportBorder",false);this.set("maxWidth",5000);this.set("maxHeight",5000);this.set("unsavedChanges",false);this.set("snapToGrid",true);this.set("drawingGuides",false);this.set("pageColor","#FFFFFF");this.set("disableAutosave","false");this.set("loadPosition","default");this.set("viewportType","default")},update:function(document){if(document){if(document.getStage()){this.set("zoom",document.getStage().getZoom());this.set("gridVisible",document.getStage().isGridVisible());this.set("pageBreaksVisible",document.getStage().isPageBreaksVisible());this.set("snapToGrid",document.getStage().isSnapToGrid());this.set("drawingGuides",document.getStage().isDrawingGuideOn())}this.set("title",document.getTitle());this.set("currentRevision",document.getCurrentRevision());this.set("exportBorder",document.getStage().exportBorder||false);this.set("autosaveDisabled",document.isAutosaveDisabled());if(document.getStage()){this.set("unsavedChanges",document.getStage().hasUnsavedChanges());this.set("pageColor",document.getStage().background)}this.set("maxWidth",document.getStage().maxWidth);this.set("maxHeight",document.getStage().maxHeight);this.set("loadPosition",document.getLoadPosition());this.set("viewportType",document.getStage().getViewportType())}},updateProperty:function(prop,value){this.set(prop.charAt(0).toLowerCase()+prop.slice(1),value)}});GliffyApp.documentModel=GliffyApp.DocumentModel.create()}());(function(){GliffyApp.overlayModel=Ember.Object.create({x:200,y:100,width:100,height:75,rotation:0,opacity:100,fillAllowed:true,lineColorAllowed:true,gradientAllowed:true,gradientOn:false,shadowAllowed:true,shadowOn:false,fixedAspect:false,lockShape:false,shapeState:0,shapeStateBoolean:false,__lockShapeState:"unlocked",__lockAspectState:"unlocked",__USE_GHOST_CHECK:true,reset:function(){this.set("gradientOn",false);this.set("shadowOn",false);this.set("fixedAspect",false);this.set("lockShape",false);this.set("shapeState",0);this.set("shapeStateBoolean",false);this.set("lockSomeShapes","");this.set("opacity",100)},update:function(o,node){var i,selectedNode=node||o.getSelectedNode(),list,olHeight;if(selectedNode){this.reset();this.set("x",Math.round(o.getTransX()));this.set("y",Math.round(o.getTransY()));this.set("width",Math.round(o.getScaleX()));this.set("height",Math.round(selectedNode.getHeight()));this.set("rotation",Math.round(_gliffy.Utils.radiansToDegrees(o.getRotation())));list=selectedNode.findNodesWithGraphics([_gliffy.Image,_gliffy.Shape]);for(i=0;i<list.length;i++){this.__updateFromNode(list[i])}this.updateLockedShapeProperties(o,selectedNode);this.updateLockedAspectProperties(o,selectedNode)}},__updateLockProperties:function(selectedNode,overlay,$checkboxDom,propertyName,nodeSetFuncName,nodeGetFuncName,overlaySetFuncName,hybridLock){var lockedArr=[],unlockedArr=[],self=this,lockFunc,lockState,shouldLockParent,i,newLockState;lockFunc=function(node){if(node[nodeGetFuncName]&&node[nodeGetFuncName]()){lockedArr.push(node)}else{unlockedArr.push(node)}};lockState=function(){if(lockedArr.length===0&&unlockedArr.length>0){return"unlocked"}else{if(lockedArr.length>0&&unlockedArr.length===0){return"locked"}}return"hybrid"};if(selectedNode.isSelection()){for(i=0;i<selectedNode.children.length;i++){lockFunc(selectedNode.children[i])}}else{lockFunc(selectedNode)}newLockState=lockState();shouldLockParent=(newLockState==="hybrid"?hybridLock:(newLockState==="locked"));self.set(propertyName,shouldLockParent);if(selectedNode[nodeSetFuncName]&&overlay[overlaySetFuncName]){selectedNode[nodeSetFuncName](shouldLockParent);overlay[overlaySetFuncName]()}return newLockState},updateLockedAspectProperties:function(overlay,node){this.__lockAspectState=this.__updateLockProperties(node,overlay,$("#gliffy-contextual-properties-checkbox-fixedaspect"),"fixedAspect","setLockAspectRatio","getLockAspectRatio","setLockAspectRatio",false)},updateLockedShapeProperties:function(overlay,node){this.__lockShapeState=this.__updateLockProperties(node,overlay,$("#gliffy-contextual-properties-checkbox-lockshape"),"lockShape","setLockPosition","getLockPosition","updateResizeControls",false)},__updateFromNode:function(node){var graphic=node.getGraphic();if(graphic instanceof _gliffy.Shape){if(!this.gradientOn){this.set("gradientOn",graphic.isGradient())}this.set("shapeState",graphic.getState());this.set("shapeStateBoolean",(graphic.getState()===1));this.set("opacity",Math.round(graphic.getOpacity()*100))}if(!this.shadowOn){this.set("shadowOn",graphic.isDropShadow())}}})}());(function(){GliffyApp.lineOverlayModel=Ember.Object.create({startPt:null,endPt:null,path:null,lineArrowBegin:0,lineArrowEnd:0,lineWeight:0,init:function(){this.startPt={x:0,y:0};this.endPt={x:0,y:0}},update:function(o){var selectedNode=o.getSelectedNode();if(selectedNode){this.__updateFromNode(selectedNode)}},__updateFromNode:function(node){if(node){var graphic=node.getGraphic();if(graphic){this.set("lineArrowBegin",graphic.getStartArrow());this.set("lineArrowEnd",graphic.getEndArrow());this.set("lineWeight",graphic.getStrokeWidth())}}}})}());(function(){GliffyApp.BaseController=Ember.ObjectController.extend({__editor:null,config:function(o){this.__editor=o.editor}})}());(function(){GliffyApp.AbstractPropertiesController=GliffyApp.BaseController.extend({__editor:null,setEditor:function(editor){this.__editor=editor},getEditor:function(){return this.__editor},__getWidgetPosition:function(attachedDomElementId,widgetSelector){var xoff=-3,yoff=-34,stageOffsetX=_gliffy.Mouse.getStageOffset().left,stageOffsetY=$(".navbar-fixed-top").height(),widget=$(".gliffy-colorswatchpicker"),cx=$("#"+attachedDomElementId).offset().left-_gliffy.Mouse.getContainerOffset().left+xoff,cy=$("#"+attachedDomElementId).offset().top+yoff,cw=widgetSelector.width(),ch=widgetSelector.height();return this.__getAdjustedPosition(cx,cy,cw,ch,stageOffsetX,stageOffsetY,attachedDomElementId)},__getAdjustedPosition:function(cx,cy,cw,ch,stageOffsetX,stageOffsetY,domElementId){if((cx+cw+stageOffsetX)>$(window).width()){cx-=(cx+cw+stageOffsetX)-$(window).width()}if((cy+ch+stageOffsetY)>$(window).height()){cy=cy-$("#"+domElementId).height()-ch-8}return{x:cx,y:cy}}})}());(function(){GliffyApp.ToolbarController=GliffyApp.BaseController.extend({init:function(){},actions:{drawModeClick:function(val){this.updateDrawMode(_gliffy.Editor.DRAW_MODE[val])},menuNew:function(){this.doNew();this.doDeselectAll()},menuOpen:function(){this.doOpen();this.doDeselectAll()},menuSave:function(){this.doSave()},menuSaveAndClose:function(){this.doSaveAndClose()},menuClose:function(){this.doClose()},menuExport:function(){this.doExportDialog()},menuRevisionHistory:function(){GliffyApp.revisionHistoryController.loadRevisionHistory()},menuDocumentProperties:function(){GliffyApp.documentPropertiesController.showDialog()},menuRename:function(){},menuSaveAs:function(){},menuPrint:function(){this.openPrintDialog()},menuUndo:function(){this.doUndo()},menuRedo:function(){this.doRedo()},menuSelectAll:function(){this.doSelectAll()},menuGroup:function(){this.doGroup()},menuUnGroup:function(){this.doUnGroup()},menuCopy:function(){this.doCopy()},menuCut:function(){this.doCut()},menuPaste:function(){this.doPaste()},menuDelete:function(){this.doDelete()},menuTips:function(){GliffyApp.tipsController.open()},zoomSelect:function(val){this.handleZoomSelect(val)},zoomInClick:function(){this.doZoomIn()},zoomOutClick:function(){this.doZoomOut()}},config:function(o){this.__editor=o.editor;this.setFileMenuWidth();this.setEditMenuWidth();var orthoMode,self=this;if(this.__editor!==null){orthoMode=_gliffy.Editor.ORTHO_MODE.bezel;this.__editor.drawManager.setOrthoMode(orthoMode)}GliffyApp.saveDialogController.hide();GliffyApp.saveDialogController.getModal().find("form").submit(function(event){event.preventDefault();self.__editor.__doSave()});GliffyApp.saveDialogController.getModal().find(".gliffy-save-dialog-button").click(function(event){event.preventDefault();self.__editor.__doSave()});GliffyApp.saveDialogController.getModal().find(".gliffy-save-dialog-cancel-button").click(function(event){self.__editor.postSaveCallback=null});$(".navbar").delegate(".gliffy-close a","click",function(event){event.preventDefault();self.__editor.close()});$(".navbar").delegate(".gliffy-toolbar .gliffy-save button","click",function(event){event.preventDefault();$(this).blur();self.doSave()});if(this.__editor){setTimeout(function(){if(self.__editor.rootResourceUrl){$(".gliffy-help-menu-link-eula a").attr("href",self.__editor.rootResourceUrl+"/Gliffy_EULA.pdf")}$(".gliffy-navbar-helpmenu-productVersion a").text($.i18n._("MENU_GLIFFY_VERSION",[self.__editor.productVersion]));$(".gliffy-navbar-helpmenu-customerId a").text($.i18n._("MENU_CUSTOMER_ID")+self.__editor.customerId);$("#gliffy-anchor-feedback").on("click",function(e){self.__editor.performAction("clickFeedback");e.preventDefault()});self.__showFeedbackPopup()},1)}},__showFeedbackPopup:function(){var ctr=$.cookie("feedbackCtr"),popover;if(ctr===null){$.cookie("feedbackCtr",0,{expires:365});ctr=0}if(ctr!=="never"){$.cookie("feedbackCtr",++ctr,{expires:365});if(ctr===5||ctr===10||(ctr%20===0)){popover=new _gliffy.Popover({target:$("#gliffy-anchor-feedback").parent(),title:$.i18n._("FEEDBACK_NAG_TITLE"),content:"",placement:"sr"});$(".gliffy-popover-content").html("<p>"+$.i18n._("FEEDBACK_NAG_BODY")+'</p><p><a class="gliffy-never-show-feedback-popup" href="#">'+$.i18n._("FEEDBACK_NAG_NEVER_AGAIN")+"</a></p>");$(".gliffy-never-show-feedback-popup").click(function(e){$.cookie("feedbackCtr","never",{expires:365});popover.hide();return false})}}},captureSaveAnalytics:function(){var self=this;_gliffy.Utils.analyticsEvent("runFuncIfAnalyticsExists",{func:function(){var analyticsData=self.__editor.getDocumentManager().getActiveStage().getAnalyticsData();$.each(analyticsData,function(topKey,topVal){if($.isPlainObject(topVal)){$.each(topVal,function(subKey,subVal){_gliffy.Utils.analyticsEvent("trackEvent",{category:"save."+topKey,action:subKey,value:subVal,non_interaction:true})})}else{_gliffy.Utils.analyticsEvent("trackEvent",{category:"save."+topKey,action:topVal,non_interaction:true})}})}})},syncButtons:function(stage){GliffyApp.toolbarController.toggleDrawingGuidesButton(stage.drawingGuidesOn);GliffyApp.toolbarController.toggleShowGridButton(stage.gridOn);GliffyApp.toolbarController.toggleSnapToGridButton(stage.snapToGrid)},doNew:function(){this.__editor.performAction("handleFileNew")},doOpen:function(){this.__editor.performAction("showFileOpenBrowser")},doSave:function(){this.captureSaveAnalytics();this.__editor.save()},doSaveAndClose:function(){var self=this;this.__editor.postSaveCallback=function(e){self.doClose()};this.captureSaveAnalytics();this.__editor.save()},doClose:function(){GliffyApp.documentTabsController.closeTab(this.__editor.getDocumentManager().getActiveDocument())},doExportDialog:function(){GliffyApp.exportDialogController.showDialog()},doDeselectAll:function(){this.__editor.overlayManager.deselectAll()},openPrintDialog:function(){GliffyApp.printController.openPrintDialog()},handleZoomSelect:function(val){if(val==="fit"){this.__editor.overlayManager.deselectAll();this.__editor.getDocumentManager().zoomToFit()}else{this.__editor.overlayManager.deselectAll();this.__editor.getDocumentManager().zoomToCenter(Number(val))}},doZoomOut:function(){this.__editor.setDrawMode(_gliffy.Editor.DRAW_MODE.zoomOut)},doZoomIn:function(){this.__editor.setDrawMode(_gliffy.Editor.DRAW_MODE.zoomIn)},updateDrawMode:function(mode){this.__editor.setDrawMode(mode)},doUndo:function(target){if($("#gliffy-edit-text_ifr").is(":visible")&&tinyMCE.activeEditor.undoManager.hasUndo()){this.__editor.overlayManager.textControl.doUndo()}else{$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");this.__editor.overlayManager.deselectAll();this.__editor.getDocumentManager().undoCommand();this.__editor.getDocumentManager().redraw()}},doRedo:function(target){if($("#gliffy-edit-text_ifr").is(":visible")){tinyMCE.activeEditor.undoManager.redo()}else{$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");this.__editor.overlayManager.deselectAll();this.__editor.getDocumentManager().redoCommand();this.__editor.getDocumentManager().redraw()}},doSelectAll:function(target){this.__editor.overlayManager.selectAllNodes();GliffyApp.contextualPropertiesController.showControls(this.__editor.overlayManager.getActiveOverlay())},doGroup:function(target){var self=this;if(this.__editor.overlayManager.getSelectedNode()){$(".gliffy-viewbox.gliffy-active").removeClass("gliffy-active");this.__editor.overlayManager.groupifySelection();this.__editor.getDocumentManager().redraw(function(){if(self.__editor.overlayManager.getSelectedNode()){self.__editor.overlayManager.getSelectedNode().getDomViewbox().addClass("gliffy-active")}})}},doUnGroup:function(target){if(this.__editor.overlayManager.getSelectedNode()){this.__editor.overlayManager.ungroupifyGroup();this.__editor.overlayManager.deselectAll();this.__editor.getDocumentManager().redraw()}},doCopy:function(){var node=this.__editor.overlayManager.getSelectedNode();if(node&&!node.isProxy()){_gliffy.Mouse.resetMouseUpPosition();if(node.supportsCopyPaste()){this.__editor.getDocumentManager().addAndExecuteCommand(new _gliffy.CopyCommand({node:node,embeddedResources:this.__editor.getEmbeddedResources()}))}else{this.__editor.getDocumentManager().getActiveStage().commandHistory.setClipboard(null)}}},doCut:function(){var node=this.__editor.overlayManager.getSelectedNode();if(node&&!node.isProxy()){this.__editor.getDocumentManager().addAndExecuteCommand(new _gliffy.CutCommand({node:node,embeddedResources:this.__editor.getEmbeddedResources()}))}this.__editor.getDocumentManager().redraw()},doPaste:function(){var selectedNode=this.__editor.overlayManager.getSelectedNode();this.__editor.getDocumentManager().addAndExecuteCommand(new _gliffy.PasteCommand({selectedNode:selectedNode}));this.__editor.getDocumentManager().redraw()},doDelete:function(){this.__editor.overlayManager.deleteSelectedNode();this.__editor.getDocumentManager().redraw()},doSendToBack:function(){var node=this.__editor.overlayManager.getSelectedNode();if(this.__editor.getDocumentManager().getActiveDocument()!==null&&node){this.__editor.getDocumentManager().addAndExecuteCommand(new _gliffy.SendToBackCommand({node:node}));this.__editor.getDocumentManager().redraw()}},doBringToFront:function(){var node=this.__editor.overlayManager.getSelectedNode();if(this.__editor.getDocumentManager().getActiveDocument()!==null&&node){this.__editor.getDocumentManager().addAndExecuteCommand(new _gliffy.BringToFrontCommand({node:node}));this.__editor.getDocumentManager().redraw()}},togglePageNavigator:function(on){if(on){GliffyApp.pageNavigatorController.show()}else{GliffyApp.pageNavigatorController.hide()}},toggleDrawingGuides:function(on){this.__editor.getDocumentManager().getActiveStage().drawingGuidesOn=on;GliffyApp.documentModel.update(this.__editor.getDocumentManager().getActiveDocument());GliffyApp.toolbarController.toggleDrawingGuidesButton(!on)},toggleThemes:function(on){GliffyApp.toolbarController.toggleThemesButton(on);GliffyApp.themeController[on?"showDialog":"hideDialog"]()},toggleLayers:function(on){GliffyApp.toolbarController.toggleLayersButton(on);GliffyApp.layersController[on?"showDialog":"hideDialog"]()},toggleDrawingGuidesButton:function(on){if(on){$(".gliffy-tool-guides").parent().addClass("active")}else{$(".gliffy-tool-guides").parent().removeClass("active")}},toggleShowGrid:function(on){this.__editor.getDocumentManager().getActiveStage().gridOn=on;this.__editor.grid.setEnabled(on);this.__editor.getDocumentManager().redraw();GliffyApp.documentModel.update(this.__editor.getDocumentManager().getActiveDocument());GliffyApp.toolbarController.toggleShowGridButton(!on)},toggleShowGridButton:function(on){if(on){$(".gliffy-tool-show-grid").parent().addClass("active")}else{$(".gliffy-tool-show-grid").parent().removeClass("active")}},toggleSnapToGrid:function(on){this.__editor.getDocumentManager().getActiveStage().snapToGrid=on;GliffyApp.documentModel.update(this.__editor.getDocumentManager().getActiveDocument());GliffyApp.toolbarController.toggleSnapToGridButton(!on)},toggleSnapToGridButton:function(on){if(on){$(".gliffy-tool-snap-to-grid").parent().addClass("active")}else{$(".gliffy-tool-snap-to-grid").parent().removeClass("active")}},toggleThemesButton:function(on){var currentState=$(".gliffy-tool-themes").parent().hasClass("active");if(currentState!==on){$(".gliffy-tool-themes").parent()[on?"addClass":"removeClass"]("active");_gliffy.Utils.analyticsEvent("trackEvent",{category:"toolbarClick",action:(on?"themesOn":"themesOff")})}},toggleLayersButton:function(on){var currentState=$(".gliffy-tool-layers").parent().hasClass("active");if(currentState!==on){$(".gliffy-tool-layers").parent()[on?"addClass":"removeClass"]("active");_gliffy.Utils.analyticsEvent("trackEvent",{category:"toolbarClick",action:(on?"layersOn":"layersOff")})}},toggleVersionInfo:function(on){$(".gliffy-version-info").toggle()},setEditMenuWidth:function(){if(!_gliffy.Utils.isEnglish(this.__editor)){$(".gliffy-edit-dropdown").css("width","250px")}},setFileMenuWidth:function(){if(!_gliffy.Utils.isEnglish(this.__editor)){$(".gliffy-file-dropdown").css("width","250px")}}});GliffyApp.toolbarController=GliffyApp.ToolbarController.create()}());(function(){var TABS={NONE:0,SHAPE:1,GROUP:2,LINE:3,TEXT:4};GliffyApp.ContextualPropertiesController=GliffyApp.AbstractPropertiesController.extend({overlayXBinding:Ember.Binding.oneWay("GliffyApp.overlayModel.x"),overlayYBinding:Ember.Binding.oneWay("GliffyApp.overlayModel.y"),overlayWidthBinding:Ember.Binding.oneWay("GliffyApp.overlayModel.width"),overlayHeightBinding:Ember.Binding.oneWay("GliffyApp.overlayModel.height"),overlayRotationBinding:Ember.Binding.oneWay("GliffyApp.overlayModel.rotation"),overlayOpacityBinding:Ember.Binding.oneWay("GliffyApp.overlayModel.opacity"),overlayGradientOnBinding:Ember.Binding.oneWay("GliffyApp.overlayModel.gradientOn"),overlayShadowOnBinding:Ember.Binding.oneWay("GliffyApp.overlayModel.shadowOn"),overlayFixedAspectBinding:Ember.Binding.oneWay("GliffyApp.overlayModel.fixedAspect"),overlayLockShapeBinding:Ember.Binding.oneWay("GliffyApp.overlayModel.lockShape"),overlayLockSomeShapesBinding:Ember.Binding.oneWay("GliffyApp.overlayModel.lockSomeShapes"),currentXPos:0,currentYPos:0,lineTypeIconClass:"icon gliffy-icon-properties-button-straight",_tab:TABS.SHAPE,__currentTextObject:null,__openMagnitude:1,__currentNumControls:2,__LINE_PROPS_INSIDE_OFFSET:10,__LINE_PROPS_OUTSIDE_OFFSET:10,__CONTROL_BUTTON_WIDTH:39,__DIALOG_WIDTH_DEFAULT:318,__DIALOG_WIDTH_LINE_TAB:275,__dialogButtons:["gliffy-contextual-properties-fill-button","gliffy-contextual-properties-bordercolor-button","gliffy-contextual-properties-linecolor-button","gliffy-contextual-properties-textcolor-button","gliffy-contextual-properties-shape-opacity-button"],__dialogDropdowns:["gliffy-contextual-properties-border-width","gliffy-contextual-properties-arrowbegin","gliffy-contextual-properties-arrowend","gliffy-contextual-properties-line-type","gliffy-contextual-properties-line-width","gliffy-contextual-properties-dash-style","gliffy-contextual-properties-line-dash-style","gliffy-contextual-properties-lanes"],__markersDict:{},__scrollTimeout:null,__scrolling:false,__tempTime:null,__editTextWidth:-10000,__editTextHeight:-10000,__groupOrLineGrabberWidth:170,__shapeGrabberWidth:210,keepDialogOpen:false,keepDialogOpenOnBlurText:false,__updateOverlayTimeout:null,__updateDialogTimeout:null,__addingLoremIpsum:false,init:function(){var self=this;this.__markersDict.standard=[1,2,3,17];this.__markersDict["com.gliffy.shape.uml.uml_v1"]=[4,5,6,7];this.__markersDict["com.gliffy.shape.uml.uml_v2"]=[4,5,6,19,7,18];this.__markersDict["com.gliffy.shape.floorplan.floorplan_v2"]=[8];this.__markersDict["com.gliffy.shape.erd.erd_v1"]=[9,10,11,12,13,14];this.__markersDict["com.gliffy.shape.bpmn.bpmn_v1"]=[4,5,15,16];$("#gliffy-contextual-properties-dialog").mousedown(function(e){if(e.target.tagName.toUpperCase()!=="INPUT"){return false}});$(window).bind("rte-remove.gliffy-edit-text",function(event){self.hideControls()});$(window).bind("rte-add.gliffy-edit-text",function(event){self.__editTextWidth=-10000;self.__editTextHeight=-10000;self.showControls($("#gliffy-edit-text_ifr"));if(self.__addingLoremIpsum){self.addLoremIpsum();self.__addingLoremIpsum=false}self.updateTextForegroundColorButton()});$(window).bind("rte-resize.gliffy-edit-text",function(event){if(!(self.__editTextWidth===event.w&&self.__editTextHeight===event.h)){self.updateControlsPosition($("#gliffy-edit-text_ifr"));self.__editTextWidth=event.w;self.__editTextHeight=event.h}});$(window).bind("rte-mouseUp.gliffy-edit-text",function(event,rte){self.updateTextForegroundColorButton()});this.__tempTime=(new Date()).getTime();if(_gliffy.KeyManager){_gliffy.KeyManager.registerState("contextualProperties","default",[{action:"arrowsDoNothing",keydown:function(e){e.stopImmediatePropagation();e.preventDefault()}},{action:"jumpStageLeft",keydown:function(e){e.stopImmediatePropagation();e.preventDefault()}},{action:"jumpStageRight",keydown:function(e){e.stopImmediatePropagation();e.preventDefault()}},{keypress:function(ev){var overlay=self.__editor.overlayManager.overlay,lineOverlay=self.__editor.overlayManager.lineOverlay;if(!_gliffy.KeyManager.isControlKey(ev)){if(overlay.isActive()){overlay.makeTextEditable(ev);ev.stopImmediatePropagation();ev.preventDefault()}else{if(lineOverlay.isActive()){lineOverlay.makeTextEditable(ev);ev.stopImmediatePropagation();ev.preventDefault()}}}}}])}},handleScrollStart:function(){this.__scrolling=true;if(this.__editor.overlayManager.getActiveOverlay()!==null){this.hideControls()}else{if($("#gliffy-edit-text_ifr").is(":visible")){this.hideControls(true)}}},handleScrollEnd:function(){this.__scrolling=false;if(this.__editor.overlayManager.getActiveOverlay()!==null&&!this.__editor.overlayManager.getActiveOverlay().isDragging){this.showControls(this.__editor.overlayManager.getActiveOverlay())}else{if($("#gliffy-edit-text_ifr").is(":visible")){this.showControls($("#gliffy-edit-text_ifr"))}}},actions:{alignLeft:function(){this.doAlign("left");_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"alignLeft"})},alignCenter:function(){this.doAlign("center");_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"alignCenter"})},alignRight:function(){this.doAlign("right");_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"alignRight"})},alignTop:function(){this.doAlign("top");_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"alignTop"})},alignMiddle:function(){this.doAlign("middle");_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"alignMiddle"})},alignBottom:function(){this.doAlign("bottom");_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"alignBottom"})},distributeHorizontal:function(){this.doDistribute("horizontal");_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"distributeHorizontal"})},distributeVertical:function(){this.doDistribute("vertical");_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"distributeVertical"})},selectBorderWidth:function(val){this.updateShapeTabProperty("StrokeWidth",Number(val));_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"borderWidth",value:Number(val)});$("#gliffy-contextual-properties-border-width").click()},selectShapeDashStyle:function(newDashStyle){var analyticsValue,dashArray,i;if(newDashStyle==="null"){analyticsValue=0}else{analyticsValue=0;dashArray=newDashStyle.split(",");for(i=0;i<dashArray.length;i++){analyticsValue+=parseInt(dashArray[i],10)}}_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"shapeDashStyle",value:analyticsValue});this.updateShapeTabProperty("DashStyle",newDashStyle);$("#gliffy-contextual-properties-dash-style").click()},selectLineWidth:function(val){this.updateLineTabProperty("StrokeWidth",Number(val));_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"lineWidth",value:Number(val)});$("#gliffy-contextual-properties-line-width").click()},selectLineDashStyle:function(val){if(val==="null"){val=null}_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"dashStyle"});this.updateLineTabProperty("DashStyle",val);if(val){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"lineDashStyle",value:parseInt(val,10)})}$("#gliffy-contextual-properties-line-dash-style").click()},selectLineType:function(val){this.updateLineTabProperty("LineType",val);_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"lineType"+val});$("#gliffy-contextual-properties-line-type").click()},selectTextPosition:function(halign,position){this.updateTextTabProperty("textPosition",{hAlign:halign,position:position});_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"textPosition"+position});this.deactivateCurrentHorizontalTextJustificationDisplay();$("#gliffy-contextual-properties-text-position").click()},selectTextVerticalAlign:function(vAlign){this.updateTextTabProperty("verticalAlign",{vAlign:vAlign});_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"verticalAlign"+vAlign});this.deactivateCurrentHorizontalTextJustificationDisplay()}},deactivateCurrentHorizontalTextJustificationDisplay:function(){$("#gliffy-edit-text_justifyright").removeClass("mceButtonActive");$("#gliffy-edit-text_justifycenter").removeClass("mceButtonActive");$("#gliffy-edit-text_justifyleft").removeClass("mceButtonActive")},registerScrollHandler:function(){var self=this;$("#container").bind("scroll.gliffy_cprops",function(){var now=(new Date()).getTime();if(now-self.__tempTime>200&&!self.__scrolling){$("#container").trigger("scrollStart");self.__tempTime=now}clearTimeout(self.__scrollTimeout);self.__scrollTimeout=setTimeout(function(){if(self.__scrolling){$("#container").trigger("scrollEnd")}},300)})},isValidPropertyValue:function(prop,value){value=Number(value);if(isNaN(value)){return false}else{if(Math.abs(value)>5000){return false}}if(prop==="width"||prop==="height"){if(value<=0){return false}}return true},doUpdateLane:function(node,value){this.__editor.overlayManager.deselectAll();this.__editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateLaneNumberCommand({node:node,lanes:value}));this.__editor.overlayManager.selectNode(node)},getTargetNode:function(blurText){var overlayManager=this.__editor.overlayManager,targetNode;targetNode=overlayManager.getSelectedNode();if(!targetNode&&$("#gliffy-edit-text_ifr").is(":visible")&&this.__currentTextObject!==null){targetNode=this.__currentTextObject;if(blurText){this.keepDialogOpen=true;this.keepDialogOpenOnBlurText=$("#gliffy-edit-text_ifr").is(":visible");if(this.__currentTextObject.isStandAloneText()){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text")}else{$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text")}this.__editor.overlayManager.selectNode(this.__currentTextObject);if($("#gliffy-contextual-properties-dialog").is(":visible")){_gliffy.KeyManager.setState("contextualProperties")}this.keepDialogOpen=this.keepDialogOpenOnBlurText}}return targetNode},__updateProperties:function(options){var documentManager=this.__editor.getDocumentManager(),i,o=$.extend({list:[],prop:null,value:null,updateStyleDefaultsForNode:false},options);for(i=0;i<o.list.length;i++){o.list[i].updateProperty(o.prop,o.value);if(o.updateStyleDefaultsForNode){documentManager.updateStyleDefaultsForNode(o.list[i],o.prop,o.value)}}},__forceImagesToReload:function(selectedNode){var images,i;images=selectedNode.findGraphic(_gliffy.Image);for(i=0;i<images.length;i++){images[i].setFlag("skin");images[i].markDirty()}},updateShapeTabProperty:function(prop,value,customTab){var customTabInstance,documentManager,list,overlayManager,shapes,targetNode;overlayManager=this.__editor.overlayManager;documentManager=this.__editor.getDocumentManager();targetNode=this.getTargetNode();shapes=targetNode.findGraphic(_gliffy.Shape);GliffyApp.overlayModel.set(prop,value);documentManager.pushCommandBundle();switch(prop){case"x":targetNode=this.getTargetNode(true);overlayManager.updateOverlayX(Number(value));break;case"y":targetNode=this.getTargetNode(true);overlayManager.updateOverlayY(Number(value));break;case"width":targetNode=this.getTargetNode(true);overlayManager.updateOverlayWidth(Number(value));this.__forceImagesToReload(targetNode);break;case"height":targetNode=this.getTargetNode(true);overlayManager.updateOverlayHeight(Number(value));this.__forceImagesToReload(targetNode);break;case"rotation":targetNode=this.getTargetNode(true);overlayManager.updateOverlayRotation(_gliffy.Utils.degreesToRadians(Number(value)));break;case"LockAspectRatio":targetNode=this.getTargetNode(true);list=targetNode.getLeafNodes(true);this.__updateProperties({list:list,prop:prop,value:value,updateStyleDefaultsForNode:false});documentManager.popCommandBundle();break;case"LockPosition":targetNode=this.getTargetNode(true);overlayManager.overlay.updateResizeControls();list=targetNode.getLeafNodes(true);this.__updateProperties({list:list,prop:prop,value:value,updateStyleDefaultsForNode:false});documentManager.popCommandBundle();break;case"StrokeWidth":case"DropShadow":targetNode=this.getTargetNode(false);list=targetNode.findNodesWithGraphics([_gliffy.Shape,_gliffy.Image]);this.__updateProperties({list:list,prop:prop,value:value,updateStyleDefaultsForNode:true});documentManager.popCommandBundle();break;case"Opacity":case"Gradient":case"State":targetNode=this.getTargetNode(false);list=targetNode.findGraphic(_gliffy.Shape);this.__updateProperties({list:list,prop:prop,value:value,updateStyleDefaultsForNode:true});documentManager.popCommandBundle();break;case"DashStyle":this.__updateProperties({list:shapes,prop:prop,value:value,updateStyleDefaultsForNode:true});documentManager.popCommandBundle();break;default:if(customTab){customTabInstance=_gliffy.Plugins.getInstance(customTab);customTabInstance.doCustomUpdate(prop,value,this.__editor,this.getTargetNode(true));documentManager.popCommandBundle()}else{_gliffy.Logger.warn("Attempted to update unknown property:"+prop+" value:"+value);documentManager.popCommandBundle()}break}this.__updateOverlayAndRedraw(GliffyApp.overlayModel,overlayManager.overlay,TABS.SHAPE,targetNode)},updateTextTabProperty:function(prop,options){var documentManager,i,node,nodes,overlay,rte,self,text,textNode,updateProperty;documentManager=this.__editor.getDocumentManager();self=this;updateProperty=function(commandCallback){documentManager.pushCommandBundle();rte=$("#gliffy-edit-text_ifr");if(rte.is(":visible")){node=rte.data("node");overlay=self.getEditor().overlayManager.overlay;if(node instanceof _gliffy.Node&&overlay instanceof _gliffy.Overlay){text=node.getGraphic();if(text instanceof _gliffy.Text){text.runCallbackWhileEditing(overlay,function(){commandCallback(documentManager,options,node)})}}}else{overlay=self.getEditor().overlayManager.overlay;if(overlay instanceof _gliffy.Overlay){nodes=overlay.getTopLevelSelectedNodes();for(i=0;i<nodes.length;i++){node=nodes[i];if(node instanceof _gliffy.Node){textNode=node.getFirstTopLevelNodeWithGraphic(_gliffy.Text);if(textNode instanceof _gliffy.Node&&textNode.isText()){commandCallback(documentManager,options,textNode)}}}}}documentManager.popCommandBundle();overlay.refresh()};switch(prop){case"textPosition":updateProperty(function(documentManager,options,textNode){documentManager.addAndExecuteCommand(new _gliffy.ModifyNodeTextCommand({hAlign:options.hAlign,node:textNode,position:options.position,vAlign:"middle"}))});break;case"verticalAlign":updateProperty(function(documentManager,options,textNode){documentManager.addAndExecuteCommand(new _gliffy.ModifyNodeTextCommand({hAlign:"center",node:textNode,position:"center",vAlign:options.vAlign}))});break}},updateLineTabProperty:function(prop,value){var documentManager,lines,overlay,overlayManager,overlayModel,targetNode;overlayManager=this.__editor.overlayManager;documentManager=this.__editor.getDocumentManager();targetNode=this.getTargetNode(prop==="LineType");lines=targetNode.findGraphic(_gliffy.Line);if(targetNode.isLine()){overlayModel=GliffyApp.lineOverlayModel;overlay=overlayManager.lineOverlay}else{overlayModel=GliffyApp.overlayModel;overlay=overlayManager.overlay}overlayModel.set(prop,value);documentManager.pushCommandBundle();switch(prop){case"StartArrow":case"EndArrow":case"StrokeWidth":case"DashStyle":this.__updateProperties({list:lines,prop:prop,value:value,updateStyleDefaultsForNode:true});break;case"LineType":this.changeLineType(value,lines);break}documentManager.popCommandBundle();this.__updateOverlayAndRedraw(overlayModel,overlay,TABS.LINE,targetNode)},__updateOverlayAndRedraw:function(overlayModel,overlay,tab,target){var dimension,self=this;if(overlayModel){overlayModel.update(overlay,target)}if(overlay){overlay.__drawOverlay();if((tab===TABS.SHAPE)&&!overlay.inStageViewport()){$("#container").unbind("scroll.gliffy_cprops");GliffyApp.contextualPropertiesController.keepDialogOpen=true;dimension=this.__editor.getDocumentManager().getActiveStageViewPort().getDimension();this.__editor.getDocumentManager().getActiveStage().centerAt(overlay.getTransX()+overlay.getScaleX()/2,overlay.getTransY()+overlay.getScaleY()/2,dimension.x,dimension.y);self.__updateOverlayTimeout=setTimeout(function(){GliffyApp.contextualPropertiesController.keepDialogOpen=false;self.registerScrollHandler()},50)}this.__editor.getDocumentManager().redraw(function(){_gliffy.Mouse.updateOffset();self.updateControlsPosition(self.__editor.overlayManager.overlay);self.__updateDialogTimeout=setTimeout(function(){if(_gliffy.BrowserDetect.browser==="Explorer"){self.__updateDialogPosition()}if(overlayModel){overlayModel.update(overlay,target)}},50)})}else{this.__editor.getDocumentManager().redraw()}if(tab===TABS.LINE){this.__showArrowSelections()}this.configureDialogControls();if($("#gliffy-edit-text_ifr").is(":visible")){$("#gliffy-edit-text_ifr").focus()}},handleColorpickerColorChange:function(color,mode){var i,graphic,node,targetNode=GliffyApp.contextualPropertiesController.getTargetNode(false),documentManager=GliffyApp.contextualPropertiesController.__editor.getDocumentManager(),stage=documentManager.getActiveStage(),shapes=targetNode.findGraphic(_gliffy.Shape),lines=targetNode.findGraphic(_gliffy.Line),selected,self=GliffyApp.contextualPropertiesController,customTab;if(targetNode.isTable()){selected=[];for(i=0;i<targetNode.children.length;i++){if(targetNode.children[i].isTableCellSelected()){selected.push(targetNode.children[i])}}if(selected.length>0){shapes=selected}}documentManager.pushCommandBundle();switch(mode){case"fill":if(targetNode.isSwimlane()){shapes=[targetNode.children[0]]}for(i=0;i<shapes.length;i++){node=shapes[i];graphic=node.getGraphic();if(!(graphic.getState&&graphic.getState())||!node.isPartOfMultipartShape()){if(color==="none"){node.updateProperty("Gradient",false);GliffyApp.contextualPropertiesController.__editor.getDocumentManager().updateStyleDefaultsForNode(node,"gradient",false)}stage.commandHistory.addAndExecuteCommand(_gliffy.SetFillColorCommand({node:node,fillColor:color}));GliffyApp.contextualPropertiesController.__editor.getDocumentManager().updateStyleDefaultsForNode(node,"fill",color);GliffyApp.contextualPropertiesController.configureDialogControls()}}break;case"border":for(i=0;i<shapes.length;i++){shapes[i].stage.commandHistory.addAndExecuteCommand(_gliffy.SetStrokeColorCommand({node:shapes[i],strokeColor:color}));GliffyApp.contextualPropertiesController.__editor.getDocumentManager().updateStyleDefaultsForNode(shapes[i],"stroke",color)}break;case"linefill":for(i=0;i<lines.length;i++){graphic=lines[i].getGraphic();lines[i].stage.commandHistory.addAndExecuteCommand(_gliffy.SetFillColorCommand({node:lines[i],fillColor:color}));GliffyApp.contextualPropertiesController.__editor.getDocumentManager().updateStyleDefaultsForNode(lines[i],"fill",color)}break;case"line":for(i=0;i<lines.length;i++){lines[i].stage.commandHistory.addAndExecuteCommand(_gliffy.SetStrokeColorCommand({node:lines[i],strokeColor:color}));GliffyApp.contextualPropertiesController.__editor.getDocumentManager().updateStyleDefaultsForNode(lines[i],"stroke",color)}break;case"text":tinyMCE.activeEditor.execCommand("ForeColor",false,color);setTimeout(function(){tinyMCE.activeEditor.execCommand("mceFocus")},0);break;default:customTab=self.getCustomTab(targetNode);if(customTab){customTab.doCustomUpdate(mode,color,self.__editor,targetNode)}break}documentManager.popCommandBundle();GliffyApp.contextualPropertiesController.setPickerButtonColors();GliffyApp.contextualPropertiesController.__editor.getDocumentManager().redraw();if($("#gliffy-edit-text_ifr").is(":visible")){$("#gliffy-edit-text_ifr").focus()}},resetDialogControls:function(exclude){var i,ddId;if(!exclude){exclude=""}this.resetPickerControls(exclude);this.__editor.overlayManager.textControl.hideMenus(exclude);for(i=0;i<this.__dialogDropdowns.length;i++){ddId=this.__dialogDropdowns[i];if(exclude!==ddId){$("#"+ddId).parent().removeClass("open")}}},resetPickerControls:function(exclude){var i,btnId;$("#gliffy-colorpicker").ColorPickerHide();$(".gliffy-colorswatchpicker").hide();$(".gliffy-opacity-widget").hide();if(!exclude){exclude=""}for(i=0;i<this.__dialogButtons.length;i++){btnId=this.__dialogButtons[i];if(exclude!==btnId){$("#"+btnId).attr("class","btn")}}},showDialog:function(e){var dh,dw,val,dialog=$("#gliffy-contextual-properties-dialog"),controlTabs=$("#gliffy-contextual-properties-controls-tabs");$("#gliffy-contextual-properties-dialog-Trigger").hide();this.resetDialogControls();this.configureDialogControls();dialog.css({width:40,height:50,left:200,top:0});dialog.jqmShow();dh=this.getDialogHeight();dw=this.getDialogWidth();if(_gliffy.BrowserDetect.browser==="Explorer"){dialog.css({width:dw,height:dh})}this.__updateDialogPosition();val=$(e.currentTarget).attr("value");if(val==="custom"){controlTabs.find("a[href='#gliffy-contextual-properties-tab-custom']").tab("show").trigger("show")}else{if(val==="table"){controlTabs.find("a[href='#gliffy-contextual-properties-tab-table']").tab("show").trigger("show");_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"editTable"})}else{if(val==="text"){controlTabs.find("a[href='#gliffy-contextual-properties-tab-text']").tab("show").trigger("show")}else{if(this.getTab()===TABS.LINE){controlTabs.find("a[href='#gliffy-contextual-properties-tab-line']").tab("show").trigger("show")}else{controlTabs.find("a[href='#gliffy-contextual-properties-tab-shape']").tab("show").trigger("show")}}}}this.__adjustGrabberWidth();this.showNoTextInfo()},__adjustGrabberWidth:function(){$(".gliffy-contextual-properties-dragarea").width(this.__shapeGrabberWidth);if(this.getTab()===TABS.LINE||$("#gliffy-contextual-properties-controls-tabs.three-tabs .gliffy-contextual-properties-dragarea").length>0){$(".gliffy-contextual-properties-dragarea").width(this.__groupOrLineGrabberWidth)}},__activeNode:function(){var node=this.__editor.overlayManager.getSelectedNode(),txt;if(!node){txt=this.__editor.overlayManager.textControl.getActiveObject();node=txt?txt.node:null}return node},showNoTextInfo:function(){var node=this.__activeNode();if(($("#gliffy-edit-text_ifr").is(":visible"))||(node&&node.hasTextContent())){$("#gliffy-contextual-properties-tab-text-rte").show();$("#gliffy-contextual-properties-notext-message").hide();return false}$("#gliffy-contextual-properties-tab-text-rte").hide();$("#gliffy-contextual-properties-notext-message").show();return true},__updateDialogPosition:function(){var dh=this.getDialogHeight(),dw=this.getDialogWidth(),dialog=$("#gliffy-contextual-properties-dialog"),animateFinishCallback;animateFinishCallback=function(){dialog.css({height:"100%"})};if(this.__openMagnitude>0){if(_gliffy.BrowserDetect.browser==="Explorer"){dialog.css({position:"absolute",top:-75,left:200})}else{dialog.animate({width:dw,height:dh,top:-75},50,null,animateFinishCallback)}}else{if(this.getTab()===TABS.LINE){if(_gliffy.BrowserDetect.browser==="Explorer"){dialog.css({position:"absolute",top:-75,left:-10})}else{dialog.animate({width:dw,height:dh,left:0,top:-75},50,null,animateFinishCallback)}}else{if(_gliffy.BrowserDetect.browser==="Explorer"){dialog.css({position:"absolute",top:-75,left:-40})}else{dialog.animate({width:dw,height:dh,left:-40,top:-75},50,null,animateFinishCallback)}}}},handleDrag:function(event,dd){var newX,newY,dialog=$("#gliffy-contextual-properties-dialog"),offset,$ddProxy=$(dd.proxy),threeTabs=$("#gliffy-contextual-properties-controls-tabs.three-tabs .gliffy-contextual-properties-dragarea").length>0,grabberOffsetX=(threeTabs)?110:75;if($("#gliffy-edit-text_ifr").is(":visible")){newX=dd.offsetX-GliffyApp.contextualPropertiesController.currentXPos-grabberOffsetX-$(".gliffy-sidebar").offset().left;newY=dd.offsetY-GliffyApp.contextualPropertiesController.currentYPos-90}else{newX=dd.offsetX-GliffyApp.contextualPropertiesController.currentXPos*this.getZoom()-grabberOffsetX-this.__getScrollX()-$(".gliffy-sidebar").offset().left;newY=dd.offsetY-GliffyApp.contextualPropertiesController.currentYPos*this.getZoom()-90-this.__getScrollY()}dialog.css({left:newX+"px",top:newY+"px"})},handleDragStart:function(event){GliffyApp.contextualPropertiesController.resetDialogControls()},setTab:function(tab){this._tab=tab},getTab:function(){return this._tab},getDialogHeight:function(){if(this.getTab()===TABS.LINE){return 150}else{if(this.getTab()===TABS.GROUP){return 256}else{return 190}}},getDialogWidth:function(){if(this.getTab()===TABS.LINE){return this.__DIALOG_WIDTH_LINE_TAB}else{return this.__DIALOG_WIDTH_DEFAULT}},closeDialog:function(e){if(!$("#gliffy-edit-text_ifr").is(":visible")){GliffyApp.contextualPropertiesController.setKeyState()}GliffyApp.contextualPropertiesController.resetDialogControls(null);if(_gliffy.BrowserDetect.browser==="Explorer"){GliffyApp.contextualPropertiesController.hideControls()}else{$("#gliffy-contextual-properties-dialog").hide();$("#gliffy-contextual-properties-dialog-Trigger").show()}$("#container").trigger("gliffy-contextual-properties-close")},configureDialogControls:function(){var i,j,graphic,shape,node,targets=this.getTargetNodes(),tableNodeChildren,showFill=true,showBorderColor=true,showBorderWidth=true,showGradient=true,showDropShadow=true,showLineFill=true,showBooleanState=true,showLoremIpsum=true,showLockAspect=true,showOpacity=true,disableWidth=false,disableHeight=false,disableRotation=false,showDashStyle=true,showTextPosition=true,hasStandAloneTextShape=false,hasFillableShapes=false,hasImageShape=false,hasLine=false,hasShapeWithText=false;if(targets!==null){for(i=0;i<targets.length;i++){node=targets[i];graphic=node.getGraphic();shape=_gliffy.shapeLibrary.shapes[node.getUid()];if(typeof shape==="object"&&shape.mutableProperties){if($.inArray("fill",shape.mutableProperties)<0){showFill=false}if($.inArray("stroke",shape.mutableProperties)<0){showBorderColor=false}if($.inArray("strokeWidth",shape.mutableProperties)<0){showBorderWidth=false}if(($.inArray("gradient",shape.mutableProperties)<0)||(node.getGraphic()&&node.getGraphic().getFillColor&&node.getGraphic().getFillColor()==="none")){showGradient=false}if($.inArray("shadow",shape.mutableProperties)<0){showDropShadow=false}if($.inArray("opacity",shape.mutableProperties)<0){showOpacity=false}if($.inArray("lockAspectRatio",shape.mutableProperties)<0){showLockAspect=false}if($.inArray("width",shape.mutableProperties)<0){disableWidth=true}if($.inArray("height",shape.mutableProperties)<0){disableHeight=true}if($.inArray("rotate",shape.mutableProperties)<0){disableRotation=true}if($.inArray("dashStyle",shape.mutableProperties)<0){showDashStyle=false}if($.inArray("textPosition",shape.mutableProperties)<0){showTextPosition=false}if(node.getShapeInformation().states!==2){showBooleanState=false}if(!node.getShapeInformation().showLoremIpsumButton){showLoremIpsum=false}}if(node.isLine()){hasLine=true;if(graphic.getStrokeWidth()<3){showLineFill=false}showDashStyle=true;showLoremIpsum=false;showBooleanState=false}else{if(node.isStandAloneText()){hasStandAloneTextShape=true;showFill=false;showBorderColor=false;showBorderWidth=false;showGradient=false;showDropShadow=false;showOpacity=false;showLoremIpsum=false;showBooleanState=false}else{if(node.isImage()){hasImageShape=true;showFill=false;showBorderColor=false;showBorderWidth=false;showGradient=false;showOpacity=false;showLoremIpsum=false;showBooleanState=false}else{if(node.isTable()){hasStandAloneTextShape=true;showFill=true;showBorderWidth=true;showBorderColor=true;hasFillableShapes=true;tableNodeChildren=node.children;for(j=0;j<tableNodeChildren.length;j++){if(tableNodeChildren[j].isTableCellSelected()){showBorderWidth=false;showBorderColor=false}}}else{hasFillableShapes=true;if(node.hasText()){hasShapeWithText=true}}}}}}this.showShapePropertiesTopRowPanel();if(!(showFill||showBorderColor||showBorderWidth||showGradient||showDropShadow)||(!hasFillableShapes&&!hasImageShape)){this.hideShapePropertiesTopRowPanel()}$("#gliffy-contextual-properties-fill-button").toggle(showFill);$("#gliffy-contextual-properties-bordercolor-button").toggle(showBorderColor);$("#gliffy-contextual-properties-border-width").toggle(showBorderWidth);$("#gliffy-contextual-properties-gradient-button").toggle(showGradient);$("#gliffy-contextual-properties-shape-opacity-button").toggle(showOpacity);$("#gliffy-contextual-properties-shadow-button").toggle(showDropShadow);$("#gliffy-contextual-properties-linefillcolor-button").toggle(showLineFill);$("#gliffy-contextual-properties-span-state").toggle(showBooleanState);$("#gliffy-contextual-properties-button-loremipsum").toggle(showLoremIpsum);$("#gliffy-contextual-properties-span-lock-aspect").toggle(showLockAspect);$("#gliffy-contextual-properties-dash-style").toggle(showDashStyle);$("#gliffy-contextual-properties-text-position").toggle(showTextPosition&&hasShapeWithText);$("#gliffy-contextual-properties-vertical-align").toggle(showTextPosition&&hasShapeWithText);if(!GliffyApp.overlayModel.lockShape){this.setTextFieldDisabled("#gliffy-contextual-properties-textfield-width",disableWidth);this.setTextFieldDisabled("#gliffy-contextual-properties-textfield-height",disableHeight);this.setTextFieldDisabled("#gliffy-contextual-properties-textfield-rotation",disableRotation)}if(targets.length===1&&targets[0].isProxy()){this.setTextFieldDisabled("#gliffy-contextual-properties-textfield-width",true);this.setTextFieldDisabled("#gliffy-contextual-properties-textfield-height",true)}if(hasLine){this.__buildArrowDropdowns();this.__showArrowSelections()}this.setPickerButtonColors();this.highlightActiveDropdownOptions()}else{this.hideControls()}},highlightActiveDropdownOptions:function(){var node=this.getTargetNode(),lines=node.findGraphic(_gliffy.Line),shapes=node.findGraphic(_gliffy.Shape),line,shape;if(lines.length>0){line=lines[0].getGraphic();this.__setActiveDropdown("#gliffy-contextual-properties-line-width",this.reformatStrokeWidth(line));this.__setActiveDropdown("#gliffy-contextual-properties-line-type",this.reformatLineType(line));this.__setActiveDropdown("#gliffy-contextual-properties-line-dash-style",this.reformatDashStyle(line))}if(shapes.length>0){shape=shapes[0].getGraphic();this.__setActiveDropdown("#gliffy-contextual-properties-border-width",this.reformatStrokeWidth(shape));this.__setActiveDropdown("#gliffy-contextual-properties-dash-style",this.reformatDashStyle(shape))}},reformatStrokeWidth:function(graphic){if(graphic.getStrokeWidth){return graphic.getStrokeWidth()}else{return null}},reformatDashStyle:function(graphic){var dashArray,i,result,values;dashArray=graphic.getDashStyle({allowReturnToBeNull:true});if(dashArray&&dashArray.split){values=dashArray.split(",")}else{if(dashArray instanceof Array){values=dashArray}}if(values instanceof Array){result=[];for(i=0;i<values.length;i++){result.push((parseInt(values[i],10))+".0")}}if(result&&result.length>0){dashArray=result.join(",")}return dashArray},reformatLineType:function(line){var result=null;if(line.isOrtho()){if(line.getInterpolationType()===_gliffy.Line.INTERPOLATION_TYPE.linear){result=line.getCornerRadius()===10?line.LINE_TYPE_ORTHO_ROUNDED:line.LINE_TYPE_ORTHO_RIGHT_ANGLE}else{result=line.LINE_TYPE_QUADRATIC_BEZIER}}else{result=line.LINE_TYPE_STRAIGHT}return result},__setActiveDropdown:function(target,value){target=$(target).siblings();target.find("li.active").removeClass("active");if(value===null){value="null"}if(value!==undefined){target.find('a[data-gliffy-value="'+value+'"]').parent().addClass("active")}},setPickerButtonColors:function(){var node=this.getTargetNode(),lines,shapes;lines=node.findGraphic(_gliffy.Line);shapes=node.findGraphic(_gliffy.Shape);$("#gliffy-contextual-properties-bordercolor-button .gliffy-color-line-color-icon").css("background-color",this.getTargetStrokeColor(shapes));$("#gliffy-contextual-properties-fill-button .gliffy-color-fill-icon").css("background-color",this.getTargetFillColor(shapes));$("#gliffy-contextual-properties-linefillcolor-button .gliffy-color-fill-icon").css("background-color",this.getTargetFillColor(lines));$("#gliffy-contextual-properties-linecolor-button .gliffy-color-line-color-icon").css("background-color",this.getTargetStrokeColor(lines));this.updateTextForegroundColorButton()},updateTextForegroundColorButton:function(){var textForegroundColor="#000000";if($("#gliffy-edit-text_ifr").is(":visible")){textForegroundColor=this.getTargetTextColor(null)}else{if(this.getTargetNode()){textForegroundColor=this.getTargetTextColor(this.getTargetNode().findGraphic(_gliffy.Text))}}$("#gliffy-edit-text_gliffyforecolor .gliffy-color-fill-icon").css("background-color",textForegroundColor)},setTextFieldDisabled:function(selector,disable){if(disable){$(selector).attr("disabled","disabled")}else{$(selector).removeAttr("disabled")}},__buildArrowDropdowns:function(){var i,markerArr,self=this,lineLibIdChunked,lineLibraryId,line,nodes=this.getTargetNode().findGraphic(_gliffy.Line),begin=$("#gliffy-contextual-properties-arrowbegin-dropdown"),end=$("#gliffy-contextual-properties-arrowend-dropdown");if(nodes!==null&&nodes.length>0){lineLibraryId=nodes[0].getUid()}if(lineLibraryId!==null){lineLibIdChunked=lineLibraryId.split(".");if(lineLibIdChunked.length>4){lineLibraryId="com.gliffy.shape.".concat(lineLibIdChunked[3]).concat(".").concat(lineLibIdChunked[4])}}markerArr=this.__markersDict[lineLibraryId];if(markerArr){markerArr=this.__markersDict.standard.concat(markerArr)}else{markerArr=this.__markersDict.standard}begin.empty().html('<li><a href="#" data-gliffy-value="0"><span class="icon line-ending left_noarrow gliffy-icon-arrow-none-left"></span></a></li>');end.empty().html('<li><a href="#" data-gliffy-value="0"><span class="icon line-ending right_noarrow gliffy-icon-arrow-none-right"></span></a></li>');for(i=0;i<markerArr.length;i++){$('<li><a href="#" data-gliffy-value="'+markerArr[i]+'"><span class="icon line-ending left_'+markerArr[i]+" gliffy-icon-arrow-"+markerArr[i]+'-left"></span></a></li>').insertAfter("#gliffy-contextual-properties-arrowbegin-dropdown li:last");$('<li><a href="#" data-gliffy-value="'+markerArr[i]+'"><span class="icon line-ending right_'+markerArr[i]+" gliffy-icon-arrow-"+markerArr[i]+'-right"></span></a></li>').insertAfter("#gliffy-contextual-properties-arrowend-dropdown li:last")}begin.find("li a").each(function(){$(this).bind("click",function(e){var num=Number(e.currentTarget.getAttribute("data-gliffy-value"));GliffyApp.contextualPropertiesController.updateLineTabProperty("StartArrow",num);_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"lineArrowBegin",value:num});e.preventDefault();begin.click()})});end.find("li a").each(function(){$(this).bind("click",function(e){var num=Number(e.currentTarget.getAttribute("data-gliffy-value"));GliffyApp.contextualPropertiesController.updateLineTabProperty("EndArrow",num);_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"lineArrowEnd",value:num});e.preventDefault();end.click()})})},__showArrowSelections:function(){var i,line,startArrow,endArrow,startArrowClass,endArrowClass,nodes=this.getTargetNode().findGraphic(_gliffy.Line);if(nodes!==null&&nodes.length>0){line=nodes[0].getGraphic();startArrow=line.getStartArrow();if(startArrow){startArrowClass="gliffy-icon-arrow-"+startArrow+"-left"}else{startArrowClass="gliffy-icon-arrow-none-left"}endArrow=line.getEndArrow();if(endArrow){endArrowClass="gliffy-icon-arrow-"+endArrow+"-right"}else{endArrowClass="gliffy-icon-arrow-none-right"}$("#gliffy-contextual-properties-arrowbegin span.icon").removeClass().addClass("icon "+startArrowClass);$("#gliffy-contextual-properties-arrowend span.icon").removeClass().addClass("icon "+endArrowClass)}else{$("#gliffy-contextual-properties-arrowbegin span.icon").removeClass().addClass("icon gliffy-icon-arrow-none-left");$("#gliffy-contextual-properties-arrowend span.icon").removeClass().addClass("icon gliffy-icon-arrow-none-right")}},updateControlsPosition:function(target){var xpos,ypos,cpropsTransform;this.__openMagnitude=1;if($("#gliffy-edit-text_ifr").is(":visible")){this.__getDialogTransformForText(target)}else{if(this.getTab()===TABS.LINE){this.__getDialogTransformForLine(target)}else{this.__getDialogTransformForShape(target)}}if(!$("#gliffy-tabs-container").is(":visible")){this.currentYPos=this.currentYPos-54}if(!$("#gliffy-edit-text_ifr").is(":visible")){this.__checkYPos();xpos=(this.getZoom()*this.currentXPos)+this.__getScrollX();ypos=(this.getZoom()*this.currentYPos)+this.__getScrollY()}else{xpos=this.currentXPos;ypos=this.currentYPos}if(xpos<30){xpos=30}cpropsTransform=_gliffy.AffineTransform.getTranslateInstance(Math.ceil(xpos),Math.ceil(ypos));$("#gliffy-contextual-properties-controls").css(_gliffy.Utils.transformCss(cpropsTransform,{matrixOnly:true}))},isVisible:function(){return($("#gliffy-contextual-properties-controls").is(":visible")||$("#gliffy-contextual-properties-dialog").is(":visible"))},__getScrollX:function(){return(_gliffy.Mouse.getStageOffset().left-(this.__getSidebarWidth()+10))},__getScrollY:function(){return this.__editor.getDocumentManager().getActiveStage().pan_y},getZoom:function(){return this.__editor.getDocumentManager().getActiveStage().zoom},__getSidebarWidth:function(){var sideBar=$(".gliffy-sidebar"),sideBarWidth=sideBar.width();if(sideBar&&sideBar.offset()){sideBarWidth=sideBar.width()+sideBar.offset().left}return sideBarWidth},__getDialogTransformForLine:function(ol){var mousePos=_gliffy.Mouse.getPosition(),selectedNode=this.__editor.overlayManager.lineOverlay.getSelectedNode(),lineGraphic,editableLine,startPoint,endPoint,pos="end",activeText=null,dialogWidth,containerOffsetX,boundingBox;if(ol&&selectedNode){lineGraphic=selectedNode.getGraphic();editableLine=lineGraphic.editable;startPoint=editableLine.getWorldStartPoint();endPoint=editableLine.getWorldEndPoint();if(ol.getActiveText){activeText=ol.getActiveText()}if(activeText){dialogWidth=this.getDialogWidth();containerOffsetX=_gliffy.Mouse.getContainerOffset().left;boundingBox=activeText.worldAabb;this.currentXPos=boundingBox.max.x+20;this.currentYPos=boundingBox.min.y+(boundingBox.max.y-boundingBox.min.y)/2+45;if((this.currentXPos+dialogWidth+containerOffsetX-15)>$(window).width()){this.__openMagnitude=-1;this.currentXPos=this.currentXPos-(boundingBox.max.x-boundingBox.min.x)-100}}else{if(_gliffy.Vec2.squaredDistance(mousePos,startPoint)<_gliffy.Vec2.squaredDistance(mousePos,endPoint)){pos="start";endPoint=editableLine.getWorldStartPoint();startPoint=editableLine.getWorldEndPoint()}this.__positionForLinePoint(pos,startPoint,endPoint,lineGraphic);this.__checkLineXPos(pos,startPoint,endPoint,lineGraphic)}}},__positionForLinePoint:function(pos,sp,ep,lineGraphic){var propsOffset=this.__LINE_PROPS_INSIDE_OFFSET+lineGraphic.getStrokeWidth(),editableLine=lineGraphic.editable,magAxis=editableLine.getMagnitudeAndAxis(pos),mag=magAxis.mag,axis=magAxis.axis,x=0,y=0;if(axis==="y"){if((pos==="start"&&mag===1)||(pos==="end"&&mag===-1)){y=Math.round(ep.y+this.__LINE_PROPS_INSIDE_OFFSET/this.getZoom()+70/this.getZoom())}else{y=Math.round(ep.y-this.__LINE_PROPS_INSIDE_OFFSET/this.getZoom()+20/this.getZoom())}if(ep.x>sp.x){x=Math.round(ep.x+(propsOffset+15)/this.getZoom())}else{this.__openMagnitude=-1;x=Math.round(ep.x-propsOffset/this.getZoom()-65/this.getZoom())}}else{if(axis==="x"){if((pos==="start"&&mag===1)||(pos==="end"&&mag===-1)){this.__openMagnitude=-1;x=Math.round(ep.x+this.__LINE_PROPS_INSIDE_OFFSET/this.getZoom()-90/this.getZoom())}else{x=Math.round(ep.x-this.__LINE_PROPS_INSIDE_OFFSET/this.getZoom()+35/this.getZoom())}if(ep.y>sp.y){y=Math.round(ep.y+propsOffset/this.getZoom()+5/this.getZoom())}else{y=Math.round(ep.y-propsOffset/this.getZoom()+90/this.getZoom())}}}this.currentXPos=x;this.currentYPos=y},__checkLineXPos:function(pos,sp,ep,lineGraphic){var stageOffsetX=_gliffy.Mouse.getStageOffset().left,newMag;if((this.__openMagnitude===1&&(this.currentXPos*this.getZoom()+this.getDialogWidth()+stageOffsetX-20)>$(window).width())||(this.__openMagnitude===-1&&(stageOffsetX+this.currentXPos*this.getZoom()+this.__getControlButtonsWidth()-this.getDialogWidth()-5<0))){newMag=this.__openMagnitude*-1;if(pos==="start"){pos="end"}else{pos="start"}this.__positionForLinePoint(pos,ep,sp,lineGraphic);this.__openMagnitude=newMag}},__checkYPos:function(){var stageOffsetY=this._getStageOffsetY();if(this.currentYPos*this.getZoom()+this.__getScrollY()<this.getDialogHeight()/2){this.currentYPos=(this.getDialogHeight()/2-this.__getScrollY())/this.getZoom()}else{if(this.currentYPos*this.getZoom()+this.getDialogHeight()/2+15+this.__getScrollY()>$(window).height()-stageOffsetY){this.currentYPos=($(window).height()-stageOffsetY-this.getDialogHeight()/2-15-this.__getScrollY())/this.getZoom()}}},_getStageOffsetY:function(){return $(".navbar-fixed-top").height()},__getDialogTransformForShape:function(ol){var olBox,positionX,positionY,paddingLeftRight=20,dw=this.getDialogWidth(),selectedNode,stageOffsetX;if(ol&&ol.getSelectedNode){selectedNode=ol.getSelectedNode();stageOffsetX=_gliffy.Mouse.getStageOffset().left;if(selectedNode&&selectedNode!==null){olBox=ol.getOverlayBoundingBox()}else{olBox=new _gliffy.BoundingBox()}positionX=olBox.max.x+(paddingLeftRight/this.getZoom());if(selectedNode&&selectedNode.isShape()&&selectedNode.getShapeInformation().quickConnectionOverlay){positionX=positionX+15/this.getZoom()}if((olBox.max.y-olBox.min.y)<(95/this.getZoom())){positionY=olBox.min.y+(90/this.getZoom())}else{positionY=olBox.min.y+(110/this.getZoom())}if((positionX*this.getZoom()+stageOffsetX+dw-15)>$(window).width()){this.__openMagnitude=-1;positionX=positionX-((olBox.max.x-olBox.min.x)+(paddingLeftRight/this.getZoom()))-(this.__getControlButtonsWidth()/this.getZoom());if(selectedNode&&selectedNode.isShape()&&selectedNode.getShapeInformation().quickConnectionOverlay){positionX=positionX-40/this.getZoom()}}this.currentXPos=positionX;this.currentYPos=positionY}},__getControlButtonsWidth:function(extraPadding){if(!extraPadding){extraPadding=0}return this.__CONTROL_BUTTON_WIDTH*this.__currentNumControls+extraPadding},__getDialogTransformForText:function(target){var dw=this.getDialogWidth(),containerOffsetX=_gliffy.Mouse.getContainerOffset().left,paddingLeftRight=24,rteBoundingBox=$("#gliffy-edit-text-container").data("boundingBox");this.currentXPos=rteBoundingBox.max.x+paddingLeftRight+this.__getScrollX();this.currentYPos=rteBoundingBox.min.y+(rteBoundingBox.max.y-rteBoundingBox.min.y)/2+45+this.__getScrollY();if((this.currentXPos+dw+containerOffsetX-15)>$(window).width()){this.__openMagnitude=-1;this.currentXPos=this.currentXPos-(rteBoundingBox.max.x-rteBoundingBox.min.x)-this.__getControlButtonsWidth(27)}},showControls:function(target){var textNode,display=false,lineIcon=null,rte=$("#gliffy-edit-text_ifr"),node,activeOverlay=this.__editor.overlayManager.getActiveOverlay();if(target!==null){if(target instanceof _gliffy.Overlay){if(activeOverlay!==null&&activeOverlay instanceof _gliffy.LineOverlay){target=activeOverlay}else{GliffyApp.overlayModel.update(target)}}}$("#gliffy-contextual-properties-shapeline-trigger i").removeClass("gliffy-tool-rect gliffy-icon-toolbar-rectangle-white gliffy-tool-line gliffy-icon-toolbar-line-white gliffy-tool-group gliffy-icon-toolbar-group-white");if(target!==null){if(target instanceof _gliffy.LineOverlay){this.__currentTextObject=null;this.setTab(TABS.LINE);if(target.isNewlyCreatedLine){return}this.__showLineControls();this.setLineIconType(target.getLineType());display=target.inStageViewport()}else{if(target instanceof _gliffy.Overlay){this.__currentTextObject=null;this.__showShapeControls(target,false);display=(target.inStageViewport()&&target.getSelectedNode()!==null)}else{if(rte.is(":visible")){textNode=rte.data("node");if(textNode){this.__currentTextObject=textNode.getUidNode();if(this.__currentTextObject&&this.__currentTextObject.isLine()){this.setTab(TABS.LINE);this.__showLineControls()}else{this.__showShapeControls(target,true)}}display=true}}}this.updateControlsPosition(target)}if(display){this.displayControls();node=target.getSelectedNode?target.getSelectedNode():null;if(node){GliffyApp.linkHudController.show({node:node})}else{GliffyApp.linkHudController.hide()}}},displayControls:function(){$("#gliffy-contextual-properties-controls").show()},__doTransformGroup:function(type,distributeOrAlign){var documentManager=this.__editor.getDocumentManager(),overlayManager=this.__editor.overlayManager;if(overlayManager.getSelectedNode().isSelection()){documentManager.pushCommandBundle();documentManager.getActiveStage().detachSelectionFromGroup(overlayManager.getSelectedNode());_gliffy.Align[distributeOrAlign](type,overlayManager.getSelectedNodes());documentManager.getActiveStage().attachSelectionToGroup(overlayManager.getSelectedNode(),overlayManager.getSelectedNodes());documentManager.popCommandBundle();overlayManager.overlay.refresh();documentManager.redraw()}else{if(overlayManager.getSelectedNode().isGroup()){documentManager.pushCommandBundle();_gliffy.Align[distributeOrAlign](type,overlayManager.getSelectedNode().children);overlayManager.getSelectedNode().stage.commandHistory.addAndExecuteCommand(new _gliffy.UpdateGroupBoundsCommand({node:overlayManager.getSelectedNode()}));documentManager.popCommandBundle();overlayManager.overlay.refresh();documentManager.redraw()}}},doAlign:function(type){this.__doTransformGroup(type,"align")},doDistribute:function(type){this.__doTransformGroup(type,"distribute")},__updateCardinalityButton:function(){var node=this.__activeNode(),hasCardinality;if(node){hasCardinality=node.getGraphic().hasCardinality&&node.getGraphic().hasCardinality();$(".gliffy-icon-toolbar-cardinality").removeClass("gliffy-icon-toolbar-cardinality-off").removeClass("gliffy-icon-toolbar-cardinality-on").addClass("gliffy-icon-toolbar-cardinality-"+(hasCardinality?"off":"on"))}},__showLineControls:function(){var node=this.__activeNode();$("#gliffy-contextual-properties-controls-tabs li:eq(0)").hide();$("#gliffy-contextual-properties-controls-tabs li:eq(1)").css("display","block");$("#gliffy-contextual-properties-shapeline-trigger").attr("data-original-title",$.i18n._("CPROPS_JS_EDIT_LINE_PROPERTIES"));$("#gliffy-contextual-properties-shapeline-trigger i").addClass("gliffy-tool-line gliffy-icon-toolbar-line-white");$("#gliffy-contextual-properties-table-trigger").hide();$("#gliffy-contextual-properties-controls-tabs li:eq(2)").hide();$("#gliffy-contextual-properties-custom-trigger").hide();$("#gliffy-contextual-properties-controls-tabs .gliffy-custom-properties-tab").hide()},__showShapeControls:function(target,isActiveText){var node=this.getTargetNode(),customTab;this.__currentNumControls=2;this.clearCustomTab();customTab=this.getCustomTab(node);$("#gliffy-contextual-properties-controls-tabs li:eq(0)").css("display","block");$("#gliffy-contextual-properties-table-trigger").hide();$("#gliffy-contextual-properties-controls-tabs li:eq(2)").hide();$("#gliffy-contextual-properties-custom-trigger").hide();$("#gliffy-contextual-properties-controls-tabs .gliffy-custom-properties-tab").hide();if(!isActiveText&&this.__isGroupSelected(target)){this.setTab(TABS.GROUP);$("#gliffy-contextual-properties-controls-tabs li:eq(1)").toggle(this.__hasLineInGroup(target));$(".gliffy-pe-align").show();$("#gliffy-contextual-properties-controls-tabs li:eq(0)").attr("data-original-title",$.i18n._("CPROPS_JS_SELECTION/SHAPE_PROPERTIES"));$("#gliffy-contextual-properties-shapeline-trigger").attr("data-original-title",$.i18n._("CPROPS_JS_EDIT_GROUP_PROPERTIES"));$("#gliffy-contextual-properties-shapeline-trigger i").addClass("gliffy-tool-group gliffy-icon-toolbar-group-white")}else{this.setTab(TABS.SHAPE);$("#gliffy-contextual-properties-controls-tabs li:eq(1)").hide();$(".gliffy-pe-align").hide();$("#gliffy-contextual-properties-controls-tabs li:eq(0)").attr("data-original-title",$.i18n._("CPROPS_JS_SHAPE_PROPERTIES"));$("#gliffy-contextual-properties-shapeline-trigger").attr("data-original-title",$.i18n._("CPROPS_JS_EDIT_SHAPE_PROPERTIES"));$("#gliffy-contextual-properties-shapeline-trigger i").addClass("gliffy-tool-rect gliffy-icon-toolbar-rectangle-white");if(customTab){this.setupCustomTab(customTab,node);this.__currentNumControls=3}}},getCustomTab:function(node){var shapeInfo;if(node){shapeInfo=node.getShapeInformation();if(shapeInfo&&shapeInfo.component){return _gliffy.Plugins.getInstance(shapeInfo.component)}}return null},clearCustomTab:function(){if(this._currentCustomTabView){Ember.View.views["gliffy-contextual-properties-tab-custom"].removeChild(this._currentCustomTabView)}$("#gliffy-contextual-properties-tab-custom").empty();if(this._currentCustomTabView){this._currentCustomTabView.destroy()}this._currentCustomTabView=null},setupCustomTab:function(customTab,node){var customContainerView=Ember.View.views["gliffy-contextual-properties-tab-custom"];$("#gliffy-contextual-properties-custom-trigger").show();$("#gliffy-contextual-properties-controls-tabs .gliffy-custom-properties-tab").show();this.clearCustomTab();this._currentCustomTabView=customTab.getCustomTabView(node);customContainerView.pushObject(this._currentCustomTabView)},__isGroupSelected:function(target){var node=target.getSelectedNode?target.getSelectedNode():null;return node&&(node.isGroup()||node.isSelection())},__hasLineInGroup:function(target){var node=target.getSelectedNode?target.getSelectedNode():null;return(node&&node.findGraphic(_gliffy.Line).length>0)},setKeyState:function(){if(GliffyApp.contextualPropertiesController.__editor.overlayManager.getSelectedNode()){if(this.getTargetNode().isLine()){_gliffy.KeyManager.setState("lineOverlaySelected")}else{_gliffy.KeyManager.setState("overlaySelected")}}else{_gliffy.KeyManager.setState("stage")}},blurRTE:function(){if(!this.keepDialogOpenOnBlurText){this.hideControls()}this.keepDialogOpenOnBlurText=false},hideControls:function(skipKeyState){if(skipKeyState===undefined){skipKeyState=false}if(!this.keepDialogOpen&&!this.keepDialogOpenOnBlurText){this.setTab(TABS.NONE);if($("#gliffy-contextual-properties-controls").css("display")!=="none"){$("#gliffy-contextual-properties-controls").hide();$("#gliffy-contextual-properties-dialog").hide();$("#gliffy-contextual-properties-dialog").jqmHide();$("#gliffy-contextual-properties-dialog-Trigger").show();$("#gliffy-colorpicker").ColorPickerHide();$(".gliffy-colorswatchpicker").hide();$(".gliffy-opacity-widget").hide();GliffyApp.linkHudController.hide()}if(!skipKeyState){this.setKeyState()}}},toggleColorSwatchPicker:function(domElement){var domId=domElement.getAttribute("id");this.resetDialogControls(domId)},getTargetColor:function(domElement){var domId=domElement.getAttribute("id"),node=this.getTargetNode(false);if(node){switch(domId){case"gliffy-contextual-properties-fill-button":return this.getTargetFillColor(node.findGraphic(_gliffy.Shape));case"gliffy-contextual-properties-linefillcolor-button":return this.getTargetFillColor(node.findGraphic(_gliffy.Line));case"gliffy-contextual-properties-bordercolor-button":return this.getTargetStrokeColor(node.findGraphic(_gliffy.Shape));case"gliffy-contextual-properties-linecolor-button":return this.getTargetStrokeColor(node.findGraphic(_gliffy.Line));case"gliffy-edit-text_gliffyforecolor":case"gliffy-contextual-properties-textcolor-button":return this.getTargetTextColor(node.findGraphic(_gliffy.Text))}}return null},getTargetFillColor:function(nodes){var fillColor="#000000";if(nodes&&nodes.length>0){fillColor=nodes[0].getGraphic().getFillColor();if(fillColor===null){fillColor="#000000"}else{if(fillColor==="none"){fillColor="transparent"}}}return fillColor},getTargetStrokeColor:function(nodes){var strokeColor="#000000";if(nodes&&nodes.length>0){strokeColor=nodes[0].getGraphic().getStrokeColor()}return strokeColor},getTargetTextColor:function(nodes){var textColor="#000000";if($("#gliffy-edit-text_ifr").is(":visible")&&tinyMCE&&tinyMCE.activeEditor){textColor=tinyMCE.activeEditor.selection.getNode().style.color}else{if(nodes&&nodes.length>0){textColor=nodes[0].getGraphic().getFirstColor()}}return(new _gliffy.RGBColor(textColor)).toHex()},showTab:function(){this.resetDialogControls()},getTargetNodes:function(){var targets=this.getTargetNode();if(targets===null){return null}else{return this.getTargetNode().getLeafNodes()}},hideShapePropertiesTopRowPanel:function(){$(".gliffy-pe-toprow").hide()},showShapePropertiesTopRowPanel:function(){$(".gliffy-pe-toprow").show()},changeLineType:function(type,nodes){var overlay=this.__editor.overlayManager.getActiveOverlay(),i,node;for(i=0;i<nodes.length;i++){node=nodes[i];if(node.isLine()){this.setLineIconType(type);switch(type){case (_gliffy.Line.prototype.LINE_TYPE_STRAIGHT):if(overlay instanceof _gliffy.LineOverlay){this.__editor.drawManager.setOrthoMode(_gliffy.Editor.ORTHO_MODE.bezel);overlay.setLineType(null)}else{node.getGraphic().editable.setOrthoMode(_gliffy.Editor.ORTHO_MODE.bezel);node.getGraphic().setOrtho(false)}break;case (_gliffy.Line.prototype.LINE_TYPE_ORTHO_RIGHT_ANGLE):if(overlay instanceof _gliffy.LineOverlay){this.__editor.drawManager.setOrthoMode(_gliffy.Editor.ORTHO_MODE.straight);overlay.setLineType(_gliffy.Editor.ORTHO_MODE.straight)}else{node.getGraphic().editable.setOrthoMode(_gliffy.Editor.ORTHO_MODE.straight);node.getGraphic().setOrtho(true)}break;case (_gliffy.Line.prototype.LINE_TYPE_ORTHO_ROUNDED):if(overlay instanceof _gliffy.LineOverlay){this.__editor.drawManager.setOrthoMode(_gliffy.Editor.ORTHO_MODE.bezel);overlay.setLineType(_gliffy.Editor.ORTHO_MODE.bezel)}else{node.getGraphic().editable.setOrthoMode(_gliffy.Editor.ORTHO_MODE.bezel);node.getGraphic().setOrtho(true)}break;case (_gliffy.Line.prototype.LINE_TYPE_QUADRATIC_BEZIER):if(overlay instanceof _gliffy.LineOverlay){this.__editor.drawManager.setOrthoMode(_gliffy.Editor.ORTHO_MODE.curved);overlay.setLineType(_gliffy.Editor.ORTHO_MODE.curved)}else{node.getGraphic().editable.setOrthoMode(_gliffy.Editor.ORTHO_MODE.curved);node.getGraphic().setOrtho(true)}break}}}},setLineIconType:function(type){var lineIcon;lineIcon=type.replace(/-/g,"_");this.set("lineTypeIconClass",_gliffy.Line().LINE_TYPE_ICON_MAP[lineIcon])},handleLoremIpsumClick:function(){if(this.__editor.overlayManager.getActiveOverlay() instanceof _gliffy.Overlay){this.__editor.overlayManager.overlay.makeTextEditable();this.__addingLoremIpsum=true}else{this.addLoremIpsum()}},addLoremIpsum:function(){tinyMCE.activeEditor.execCommand("mceInsertContent",false,_gliffy.Editor.LOREM_IPSUM_TEXT);tinyMCE.activeEditor.execCommand("mceAutoResize",false)},convertToChart:function(){var node,matrix,labeledHorizontally=false,labeledVertically=false,uid="";node=this.__editor.overlayManager.getSelectedNode();uid=node.getUid();switch(uid){case"com.gliffy.shape.table.table_v1.default.table_horizontal_title_three_by_two":labeledHorizontally=true;break;case"com.gliffy.shape.table.table_v1.default.table_vertical_title_three_by_two":labeledVertically=true;break;case"com.gliffy.shape.table.table_v1.default.table_horizontal_and_vertical_title_three_by_two":labeledHorizontally=true;labeledVertically=true;break;case"com.gliffy.shape.table.table_v1.default.table_three_by_two":break;default:break}matrix=this.parseToMatrix(node,labeledHorizontally,labeledVertically);GliffyApp.chartController.convertToChart(matrix,labeledHorizontally,labeledVertically)},parseToMatrix:function(node,labeledHorizontally,labeledVertically){var self=this,i,j,text,matrix=[],el,matrixHeight,matrixWidth;el=document.createElement("div");matrixWidth=Math.floor(node.getWidth()/node.children[0].getWidth());matrixHeight=Math.floor(node.getHeight()/node.children[0].getHeight());if(labeledVertically&&!labeledHorizontally){for(i=0;i<matrixHeight;i++){matrix[i]=[];for(j=0;j<matrixWidth;j++){text=self.getNodeText(node.children[(matrixWidth*i)+j].children[0]);matrix[i].push(text)}}}else{for(i=0;i<matrixWidth;i++){matrix[i]=[];for(j=0;j<matrixHeight;j++){text=self.getNodeText(node.children[(matrixWidth*j)+i].children[0]);matrix[i].push(text)}}}return matrix},getNodeText:function(node){var el,span,text;el=document.createElement("div");el.innerHTML=node.getGraphic().getHTML();span=$("span",el);text=span[0].textContent;return text},toggleOpacityWidget:function(button,action){var coords,widget=$(".gliffy-opacity-widget"),domId=button.getAttribute("id");this.resetDialogControls(domId);if(button.getAttribute("class").indexOf("active")>-1){widget.hide()}else{widget.show();widget.find(".gliffy-opacity-slider").slider("setValue",this.overlayOpacity);coords=this.__getWidgetPosition(domId,$(".gliffy-opacity-widget"));widget.css("left",coords.x+212);widget.css("top",coords.y+62);_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:action+"Show"})}},setPropertyFromSlider:function(prop,val){var overlayManager=this.__editor.overlayManager,targetNode=this.getTargetNode(false),list=targetNode.findGraphic(_gliffy.Shape);this.set("overlay"+prop,val);GliffyApp.overlayModel.set(prop,val/100);this.__updateProperties({list:list,prop:prop,value:val/100,updateStyleDefaultsForNode:true});this.__updateOverlayAndRedraw(GliffyApp.overlayModel,overlayManager.overlay,TABS.SHAPE,targetNode)}});GliffyApp.contextualPropertiesController=GliffyApp.ContextualPropertiesController.create()}());(function(){GliffyApp.DocumentPropertiesController=GliffyApp.AbstractPropertiesController.extend({__dialogButtons:null,titleVersionDisplay:null,init:function(){this.__dialogButtons=["gliffy-document-properties-pagecolor-button"]},actions:{handleImageFitSelect:function(val){this.updateProperty("Viewport",val,true)},handleLoadPosition:function(val){this.updateProperty("LoadPosition",val,true)}},config:function(){var self=this,diffx,diffy;GliffyApp.documentModel.addObserver("gridVisible",function(){self.updateUI()});GliffyApp.documentModel.addObserver("title",function(){self.updateUI()});GliffyApp.documentModel.addObserver("currentRevision",function(){self.updateUI()});GliffyApp.documentModel.addObserver("pageColor",function(){self.setPickerButtonColors()});_gliffy.Mouse.registerClickState({name:"documentProperties",modes:["document-properties-drag"],target:".gliffy-document-properties-dragarea",mouseDown:function(event){_gliffy.Mouse.setClickMode("documentProperties");_gliffy.Mouse.setState("document-properties-drag");_gliffy.Mouse.__mousedown(event)}});_gliffy.Mouse.registerDragState([{modes:["document-properties-drag"],dragStart:function(event){var dialog=$("#gliffy-document-properties-dialog");GliffyApp.documentPropertiesController.resetDialogControls();diffx=event.pageX-dialog.offset().left;diffy=event.pageY-dialog.offset().top},drag:function(event){var dialog=$("#gliffy-document-properties-dialog"),newX=event.pageX,newY=event.pageY,dialogWidth=dialog.width(),dialogHeight=dialog.height(),windowWidth=$(window).width(),windowHeight=$(window).height();newX=newX-diffx+200;newY=newY-diffy;if(newX<200){newX=200}else{if(newX>(windowWidth-dialogWidth)){newX=windowWidth-dialogWidth+200}}if(newY<90){newY=90}else{if(newY>(windowHeight-dialogHeight-15)){newY=(windowHeight-dialogHeight-15)}}dialog.css({left:newX+"px",top:newY+"px"})},dragEnd:function(event){}}])},getEditor:function(){return this.__editor},updateUI:function(){if($("#gliffy-document-properties-dialog").is(":visible")){this.set("titleVersionDisplay",GliffyApp.documentTabsController.getDisplayTitle());this.setPickerButtonColors();$("#gliffy-document-properties-loadposition li a").each(function(){if($(this).data("gliffy-value")===GliffyApp.documentModel.loadPosition){$("#gliffy-document-properties-loadposition .gliffy-dropdown-button").html($(this).html())}});$("#gliffy-document-properties-imagefit li a").each(function(){if($(this).data("gliffy-value")===GliffyApp.documentModel.viewport){$("#gliffy-document-properties-imagefit .gliffy-dropdown-button").html($(this).html())}})}},updateSizeProperty:function(prop,value){var documentManager=GliffyApp.contextualPropertiesController.__editor.getDocumentManager();if(prop==="MaxWidth"){documentManager.getActiveStage().commandHistory.addAndExecuteCommand(_gliffy.SetPageWidthCommand({stage:documentManager.getActiveStage(),width:value}))}else{documentManager.getActiveStage().commandHistory.addAndExecuteCommand(_gliffy.SetPageHeightCommand({stage:documentManager.getActiveStage(),height:value}))}this.__editor.getDocumentManager().redraw()},updateProperty:function(prop,value,skipRedraw){GliffyApp.documentModel.updateProperty(prop,value);this.__editor.getDocumentManager().getActiveDocument().updateProperty(prop,value);if(prop==="GridVisible"){this.__editor.grid.setEnabled(value)}if(!skipRedraw){this.__editor.getDocumentManager().redraw()}GliffyApp.documentModel.set("unsavedChanges",true);this.updateUI()},isValidPropertyValue:function(prop,value){value=Number(value);if(isNaN(value)){return false}else{if(value<=0||value>5000){return false}}return true},resetDialogControls:function(exclude){var i,btnId;$("#gliffy-colorpicker").ColorPickerHide();$(".gliffy-colorswatchpicker").hide();if(!exclude){exclude=""}for(i=0;i<this.__dialogButtons.length;i++){btnId=this.__dialogButtons[i];if(btnId!==exclude){$("#"+btnId).attr("class","btn")}}},setPickerButtonColors:function(){var pageColor=this.getTargetColor($("#gliffy-document-properties-pagecolor-button").get(0));if(pageColor==="none"||pageColor==="rgba(0, 0, 0, 0)"){$("#gliffy-document-properties-pagecolor-button .gliffy-color-fill-icon").addClass("gliffy-icon-colorswatchpicker-transparent")}else{$("#gliffy-document-properties-pagecolor-button .gliffy-color-fill-icon").removeClass("gliffy-icon-colorswatchpicker-transparent");$("#gliffy-document-properties-pagecolor-button .gliffy-color-fill-icon").css("background-color",pageColor)}},handleColorpickerColorChange:function(color,mode){if(color==="none"){color="rgba(0, 0, 0, 0)"}var documentManager=GliffyApp.contextualPropertiesController.__editor.getDocumentManager();documentManager.getActiveStage().commandHistory.addAndExecuteCommand(new _gliffy.SetPageColorCommand({stage:documentManager.getActiveStage(),background:color}));documentManager.redraw(null,false)},showDialog:function(){var dialog=$("#gliffy-document-properties-dialog"),l=$(window).width()/2,t=$(window).height()/2-dialog.height()/2;dialog.css({left:l+"px",top:t+"px"});dialog.show();this.updateUI()},hideDialog:function(){$("#gliffy-document-properties-pagecolor-button").attr("class","btn");$("#gliffy-document-properties-dialog").hide();$("#gliffy-colorpicker").ColorPickerHide();$(".gliffy-colorswatchpicker").hide()},getTargetColor:function(domElement){return this.__editor.getDocumentManager().getActiveStage().background}});GliffyApp.documentPropertiesController=GliffyApp.DocumentPropertiesController.create()}());(function(){GliffyApp.DocumentTabsController=Ember.Object.extend({__editor:null,__tabIDCounter:0,__tabLimit:9,__tabTemplate:null,init:function(){var self=this;if(!window.jasmine){this.setupTabContainer()}GliffyApp.documentModel.addObserver("title",function(){self.updateTabText()});GliffyApp.documentModel.addObserver("unsavedChanges",function(){self.updateTabText()});GliffyApp.documentModel.addObserver("currentRevision",function(){self.updateTabText()});$("#gliffy-tabs-container").on("click",".gliffy-document-tab",function(e){e.preventDefault();var document=$(this).data("document");if(document){self.selectTab($(this).data("document"))}});$("#gliffy-tabs-button-add").attr("title",$.i18n._("TABDIALOG_OPEN_DOCUMENT"));$("#gliffy-tabs-button-add").click(function(e){_gliffy.Utils.analyticsEvent("trackEvent",{category:"documentTabClick",action:"newTabClicked"});self.__editor.performAction("clickAddTab");e.preventDefault()}).tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-tabs-container").on("click",".icon-remove",function(e){e.preventDefault();var tabId=e.currentTarget.getAttribute("data-tabId"),document=$("#"+tabId).data("document");self.closeTab(document)})},setupTabContainer:function(){var html,template;template=Handlebars.compile($("#gliffy-tab-container-template").html());html=template({enableTabs:_gliffy.FEATURES.tabs});$("#gliffy-center-pane").prepend(html)},getDisplayTitle:function(){var str=GliffyApp.documentModel.title+", v"+GliffyApp.documentModel.currentRevision;if(!$.isNumeric(GliffyApp.documentModel.currentRevision)||GliffyApp.documentModel.currentRevision<1){str=GliffyApp.documentModel.title}return(GliffyApp.documentModel.unsavedChanges===true?"*":"")+str},updateTabText:function(){var tabDomElement=this.__editor.getDocumentManager().getActiveDocument().tabDomElement,tab;tab=$(this.getTabTemplateHTML($("#gliffy-tabs-button-add").length!==0,tabDomElement.attr("id"))).data(tabDomElement.data());if(tab){tabDomElement.replaceWith(tab);this.__editor.getDocumentManager().getActiveDocument().tabDomElement=tab;tab.find("i").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy").trigger("gliffy.document_tab_updated")}},getTabCount:function(){return this.__editor.getDocumentManager().getDocumentCount()},getTabTemplateHTML:function(close,tabId){return this.__tabTemplate({displayTitle:this.getDisplayTitle(),tabId:tabId,"active?":true,"close?":close})},createNewTab:function(document){var tabHTML,tab,tmpl,self=this;if(!this.__tabTemplate){tmpl=$("#gliffy-tab-template").html();this.__tabTemplate=function(data){if(data&&tmpl){return Handlebars.compile(tmpl)($.extend(data,{i18n_TAB_CLOSE_DOCUMENT:$.i18n._("TAB_CLOSE_DOCUMENT")}))}}}tabHTML=this.getTabTemplateHTML($("#gliffy-tabs-button-add").length!==0,"gliffy-tab-"+this.__tabIDCounter);tab=$(tabHTML);tab.insertBefore("#gliffy-tabs-container li:last");tab.data("document",document);document.tabDomElement=tab;this.__tabIDCounter++;$("#gliffy").trigger("gliffy.document_tab_updated");$("#gliffy-tabs-button-add").toggle(this.getTabCount()<=this.__tabLimit)},closeAllTabs:function(){var i,documents=this.__editor.getDocumentManager().getDocuments();for(i=0;i<documents.length;i++){this.__preRemoveTab(document[i])}},closeTab:function(document){var self=this;if(document.getStage().hasUnsavedChanges()){if(this.__editor.getDocumentManager().getActiveDocument()!==document){this.selectTab(document)}_gliffy.Dialog.showYesNoDialog({title:$.i18n._("TABDIALOG_CONFIRM_NAVIGATION"),content:$.i18n._("TABDIALOG_UNSAVED_CHANGES",[document.getTitle()]),cancelCallback:null,buttons:[{text:$.i18n._("TABDIALOG_CONTINUE_WORKING"),callback:null,primary:false,dismiss:true},{text:$.i18n._("TABDIALOG_CLOSE_TAB"),callback:function(e){document.getStage().setUnsavedChanges(false);self.__preRemoveTab(document)},primary:true,dismiss:true}]})}else{this.__preRemoveTab(document)}},__preRemoveTab:function(document){var self=this;if(!(document instanceof _gliffy.Document)){document=this.__editor.getDocumentManager().getActiveDocument()}if(this.getTabCount()===1){if(window===window.parent){this.__editor.closeLastTab()}else{this.__editor.create(function(){self.__editor.closeLastTab()})}}else{this.removeTab(document)}},removeTab:function(document){this.killCloseTooltip(document.tabDomElement);this.__editor.getDocumentManager().removeDocument(document);document.tabDomElement.remove();this.selectLastTab();$("#gliffy-tabs-button-add").toggle(this.getTabCount()<=this.__tabLimit)},killCloseTooltip:function(tabDomElement){tabDomElement.find("i").removeAttr("data-original-title").tooltip("hide")},selectTab:function(document,skipPanels){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");if(document!==this.__editor.getDocumentManager().getActiveDocument()){this.__editor.overlayManager.deselectAll();this.__editor.getDocumentManager().cleanTarget();this.__editor.getDocumentManager().setActiveDocument(document,skipPanels);document.tabDomElement.addClass("active")}},selectLastTab:function(){var lastTab=$("#gliffy-tabs-container .gliffy-document-tab:last");if(lastTab.length>0){this.selectTab(lastTab.data("document"));lastTab.addClass("active")}else{this.__editor.closeLastTab()}}})}());(function(){GliffyApp.RevisionHistoryController=GliffyApp.BaseController.extend({currentPage:1,numPages:1,currentBaseRevision:1,currentMaxRevision:1,numRevisions:0,allRevisions:null,revisions:null,errorTarget:null,currentRevision:null,imageSizeLargeClass:"",MODAL_PADDING:15,LARGE_IMAGE_THUMBNAIL_SIZE:250,LARGE_IMAGE_WIDTH_SCALE_PERCENT:0.87,LARGE_IMAGE_HEIGHT_SCALE_PERCENT:0.77,__editor:null,init:function(){this.revisions=Ember.A([])},actions:{nextClick:function(){this.handleNextClick()},previousClick:function(){this.handlePreviousClick()},okayClick:function(){var openUrl=$('#revision-history label input[name="gliffy-revision-radio-button"]:checked').attr("data-gliffy-revision-url");if(openUrl){this.openRevision(openUrl);$("#revision-history").modal("hide")}},showRevisionHistoryPreview:function(){this.showRevisionHistoryPreview()},hideRevisionHistoryPreview:function(){this.hideRevisionHistoryPreview()}},reset:function(){this.allRevisions=[];this.currentPage=1;this.numPages=1;this.set("currentBaseRevision",1);this.set("currentMaxRevision",1);this.set("numRevisions",0);this.set("currentRevision",null);this.revisions.clear();this.hideRevisionHistoryPreview()},revisionClick:function(version){var currentRevision;$("#revision-history .gliffy-btn-primary").attr("disabled",false);currentRevision=this.findRevisionFromVersion(version);this.getImageSizeAndAddClassFromUrl(currentRevision.urls.thumbnail);this.setCurrentRevision(currentRevision)},getImageSizeAndAddClassFromUrl:function(url){var self=this;$("<img/>").attr("src",url).load(function(){if(this.height>self.get("LARGE_IMAGE_THUMBNAIL_SIZE")){self.set("imageSizeLargeClass","gliffy-revision-preview-large-thumbnail")}else{self.set("imageSizeLargeClass","")}})},handleNextClick:function(){this.currentPage++;this.set("currentRevision",null);this.__populate()},handlePreviousClick:function(){this.currentPage--;this.set("currentRevision",null);this.__populate()},__populate:function(){var i,revision,moddt,currentMaxRevision,currentBaseRevision,isChecked;this.revisions.clear();$("#revision-history .gliffy-btn-primary").attr("disabled",true);currentBaseRevision=((this.currentPage-1)*10+1);currentMaxRevision=(this.currentPage*10);if(currentMaxRevision>this.numRevisions){currentMaxRevision=this.numRevisions}this.set("currentBaseRevision",currentBaseRevision);this.set("currentMaxRevision",currentMaxRevision);for(i=0;i<this.allRevisions.length;i++){if(i>=currentBaseRevision-1&&i<=currentMaxRevision-1){revision=this.allRevisions[i];moddt=new Date(revision.lastModified);revision.prettyDate=revision.lastModifiedFriendly;isChecked=(this.__editor.getDocumentManager().getActiveDocument().getCurrentRevision()===revision.version);if(isChecked){$("#revision-history .gliffy-btn-primary").attr("disabled",false);this.setCurrentRevision(revision.version);this.revisionClick(revision.version)}revision.isChecked=isChecked;revision.radioId="gliffy-revison-history-radio-"+revision.version;revision.descriptor="id:"+revision.id+",dvid:"+revision.version;if(revision.urls){revision.openUrl=revision.urls.open}this.revisions.pushObject(revision)}}this.__displayPreviousNext()},findRevisionFromVersion:function(version){var revision;revision=_.find(GliffyApp.revisionHistoryController.allRevisions,function(revision){return revision.version===version});return revision},__hidePreviousNext:function(){$("#gliffy-revision-history-previous-button").hide();$("#gliffy-revision-history-next-button").hide();$("#gliffy-revision-history-previous-next-separator").hide()},__displayPreviousNext:function(){$("#gliffy-revision-history-previous-button").show();$("#gliffy-revision-history-next-button").show();$("#gliffy-revision-history-previous-next-separator").show();if(this.numPages===this.currentPage){$("#gliffy-revision-history-next-button").hide();$("#gliffy-revision-history-previous-next-separator").hide()}if(this.currentPage===1){$("#gliffy-revision-history-previous-button").hide();$("#gliffy-revision-history-previous-next-separator").hide()}},loadRevisionHistory:function(){var self=this;this.reset();this.__editor.performAction("history",this.__editor.getDocumentManager().getActiveDocument().toObject(),function(data){_gliffy.Utils.tryCatch(function(){self.handleLoadSuccess(data)},function(e){_gliffy.handleError("com.gliffy.error.file_malformed",[],e,self.errorTarget)})},function(xhr,status,error){if(xhr.status===404){_gliffy.handleError("com.gliffy.error.file_not_found",[],error,this.errorTarget)}else{_gliffy.handleError("com.gliffy.error.file_malformed",[],error,this.errorTarget)}})},handleLoadSuccess:function(data){this.set("numRevisions",data.numRevisions);this.numPages=Math.ceil(this.numRevisions/10);this.allRevisions=data.revisions;this.__populate();this.__displayPreviousNext()},openRevision:function(openUrl){var self=this;if(this.__editor.getDocumentManager().getActiveStage().hasUnsavedChanges()){_gliffy.Dialog.showYesNoDialog({title:$.i18n._("REVISIONHISTORY_CONFIRM_NAVIGATION"),content:$.i18n._("REVISIONHISTORY_YOU_HAVE_UNSAVED_CHANGES._ARE_YOU_SURE_YOU_WANT_TO_LOAD_THIS_REVISION?"),cancelCallback:null,buttons:[{text:$.i18n._("REVISIONHISTORY_CONTINUE_WORKING"),callback:null,primary:false,dismiss:true},{text:$.i18n._("REVISIONHISTORY_OPEN_REVISION"),callback:function(e){self.__editor.open({url:openUrl});self.ga("openRevision")},primary:true,dismiss:true}]})}else{this.__editor.open({url:openUrl});self.ga("openRevision")}},setCurrentRevision:function(revision){this.set("currentRevision",revision)},showRevisionHistoryPreview:function(){var img,imgArray,containerOffset,bodyOffset,previewImageWidth,previewImageHeight,largeClass=false;imgArray=$("#gliffy-revision-preview img");img=imgArray[0];containerOffset=100;bodyOffset=50;$("#gliffy-revision-preview").show();$("#gliffy-revision-history").hide();$(".modal-footer").hide();if(window.innerWidth<img.naturalWidth){$(img).width(window.innerWidth*this.LARGE_IMAGE_WIDTH_SCALE_PERCENT);largeClass=true;previewImageWidth=$(img).width()}else{previewImageWidth=img.naturalWidth;$(img).width(img.naturalWidth)}if(window.innerHeight<img.naturalHeight){$(img).height(window.innerHeight*this.LARGE_IMAGE_HEIGHT_SCALE_PERCENT);largeClass=true;previewImageHeight=$(img).height()}else{previewImageHeight=img.naturalHeight;$(img).height(img.naturalHeight)}$("#revision-history").css("margin-top",-((previewImageHeight+(this.MODAL_PADDING*2)+containerOffset)/2));$("#revision-history").css("margin-left",-((previewImageWidth+(this.MODAL_PADDING*2))/2));$("#revision-history").width(previewImageWidth+(this.MODAL_PADDING*2)).height(previewImageHeight+(this.MODAL_PADDING*2)+containerOffset);$("#revision-history .modal-body").width(previewImageWidth).height(previewImageHeight+(this.MODAL_PADDING*2)+bodyOffset);if(largeClass){$("#revision-history").addClass("gliffy-revision-preview-large")}else{$("#revision-history").removeClass("gliffy-revision-preview-large")}},hideRevisionHistoryPreview:function(){var revisionHistory;revisionHistory=$("#revision-history");$("#gliffy-revision-preview").hide();$("#gliffy-revision-history").show();$(".modal-footer").show();revisionHistory.css("height","");revisionHistory.css("width","");$("#revision-history .modal-body").css("height","");$("#revision-history .modal-body").css("width","");revisionHistory.css("margin-top",-((revisionHistory.height()+(this.MODAL_PADDING*2))/2));revisionHistory.css("margin-left",-((revisionHistory.width()+(this.MODAL_PADDING*2))/2))},ga:function(action){_gliffy.Utils.analyticsEvent("trackEvent",{category:"revisionHistory",action:action})}});GliffyApp.revisionHistoryController=GliffyApp.RevisionHistoryController.create()}());(function(){GliffyApp.HudController=Ember.Object.extend({__editor:null,__mode:null,__width:null,__deferredMode:null,canShow:false,HUD_MODE:{pos:"pos",size:"size",rot:"rot"},update:function(){var o=this.__editor.overlayManager.overlay,height,selectedNode,deg;switch(this.__mode){case this.HUD_MODE.pos:$("#gliffy-hud").html("<span>X: </span> "+Math.round(o.getTransX())+"px <span>Y:</span> "+Math.round(o.getTransY())+"px");break;case this.HUD_MODE.size:selectedNode=o.getSelectedNode();if(selectedNode){height=Math.round(selectedNode.getHeight())}else{height=Math.round(o.getScaleY())}$("#gliffy-hud").html("<span>"+$.i18n._("HUD_W")+": </span> "+Math.round(o.getScaleX())+$.i18n._("HUD_PX")+" <span>"+$.i18n._("HUD_H")+":</span> "+height+$.i18n._("HUD_PX"));break;case this.HUD_MODE.rot:deg=(Math.round(_gliffy.Utils.radiansToDegrees(o.getRotation()))+3600)%360;$("#gliffy-hud").html((deg>180?-360+deg:deg)+"&#176;");break}this.position()},position:function(){var hud=$("#gliffy-hud"),transform,selectedNode=this.__editor.overlayManager.getSelectedNode(),zoom=this.__editor.getDocumentManager().getActiveStage().getZoom(),bb,width,o=this.__editor.overlayManager.overlay,ow,oh,x,y;switch(this.__mode){case this.HUD_MODE.rot:ow=o.getScaleX()*zoom;oh=o.getScaleY()*zoom;x=o.getTransX()*zoom+ow/2-this.__width*zoom/2;y=o.getTransY()*zoom+oh+20;hud.css({top:y,left:x});break;default:if(selectedNode!==null){selectedNode.update();bb=selectedNode.getChildrenAabb(true);bb.transform(selectedNode.worldTransform);width=bb.getDimension().x;hud.css({top:(bb.max.y+20/zoom)*zoom,left:(bb.min.x+(width/2-this.__width/2/zoom))*zoom})}break}},show:function(mode){this.__deferredMode=mode},showDeferred:function(){this.canShow=true;var self=this,hud=$("#gliffy-hud");if(!this.isOn){setTimeout(function(){if(self.canShow&&self.__deferredMode!==null){self.__mode=self.__deferredMode;if(self.__mode===self.HUD_MODE.rot){hud.width(40);self.__width=40}else{hud.width(125);self.__width=125}self.update();hud.show();self.isOn=true}},300)}else{this.update()}},quickHide:function(){this.isOn=false;$("#gliffy-hud").hide()},hide:function(){this.canShow=false;this.isOn=false;$("#gliffy-hud").hide();this.__deferredMode=null}})}());(function(){GliffyApp.LinkHudController=GliffyApp.BaseController.extend({__width:null,__once:true,href:null,multipleLinks:false,showTip:false,linkType:"shape",targetNode:null,init:function(){this.setHrefArray([])},config:function(options){this._super(options);this.__registerEventListeners()},__registerEventListeners:function(){var overlayPositionResizeEvents,self=this;overlayPositionResizeEvents=["gliffy-overlay-manager-update-x","gliffy-overlay-manager-update-y","gliffy-overlay-manager-update-width","gliffy-overlay-manager-update-height","gliffy-overlay-manager-update-rotation"].join(" ");this.__editor.overlayManager.getContainer().on(overlayPositionResizeEvents,function(e){setTimeout(function(e){self.position()},10)})},actions:{editLink:function(){$("#container").data("skipTextControlAnalytics",true);tinyMCE.activeEditor.execCommand("gliffyLink",false);$("#container").data("skipTextControlAnalytics",false)},unlink:function(){switch(this.linkType){case"shape":this.unlinkShape();break;case"text":case"rte":this.unlinkText();break}},goToLink:function(href){_gliffy.Utils.analyticsEvent("trackEvent",{category:"linkHudClick",action:"go"});window.open(href)}},position:function(){var hud=$("#gliffy-link-hud"),selectedNode=this.__editor.overlayManager.getSelectedNode(),zoom=this.__editor.getDocumentManager().getActiveStage().getZoom(),bb,width,o=this.__editor.overlayManager.overlay,self=this;this.__width=175;if(selectedNode===null){if(($("#gliffy-edit-text_ifr").is(":visible"))&&tinyMCE.activeEditor.gliffyTextControl!==null&&tinyMCE.activeEditor.gliffyTextControl.getBoundingBox()!==null){bb=tinyMCE.activeEditor.gliffyTextControl.getBoundingBox();if(bb){hud.css({top:(bb.max.y+20/zoom),left:(bb.min.x+($("#gliffy-edit-text_ifr").width()/2-this.__width/2/zoom))})}else{_gliffy.Logger.warn("Cannot place link hud for visible text.")}}else{_gliffy.Logger.warn("Cannot place link hud.")}}else{selectedNode.update();bb=selectedNode.getChildrenAabb(true);bb.transform(selectedNode.worldTransform);if(bb){width=bb.getDimension().x;hud.css({top:(bb.max.y+20/zoom)*zoom,left:(bb.min.x+(width/2-this.__width/2/zoom))*zoom})}else{_gliffy.Logger.warn("Cannot place link hud for selected Node")}}},setHrefArray:function(hrefArray){hrefArray=$.unique(hrefArray);this.set("href",Ember.A(hrefArray));this.set("multipleLinks",hrefArray.length>1);if(this.multipleLinks){$(".gliffy-link-hud-multiple-links").css("display","none")}else{$(".gliffy-link-hud-multiple-links").css("display","inline")}},show:function(options){var linkHTML="",self=this,o=$.extend({},{node:null,rteLink:null},options),node=o.node,textNode,links;this.setHrefArray([]);this.set("showTip",false);if(o.rteLink){this.setHrefArray([o.rteLink]);this.linkType="rte";this.targetNode=null}else{if(node){this.targetNode=node;if(node.isText()){this.setHrefArray(node.getGraphic().getLinks());this.linkType="text"}else{if(node.getLink()){this.setHrefArray([node.getLink()]);this.linkType="shape"}}textNode=node.findGraphic(_gliffy.Text);if(textNode.length>0&&textNode[0].getGraphic().getLinks().length>1){this.set("showTip",true)}}}if(this.href.length>0||this.showTip){this.position();$("#gliffy-link-hud").show()}else{this.hide()}},hide:function(){this.setHrefArray([]);$("#gliffy-link-hud").hide()},unlinkShape:function(){var child,selectedNode=this.targetNode,self=this;if(selectedNode&&selectedNode.children){for(var i=0;i<selectedNode.children.length;i++){child=selectedNode.children[i];if(child.getGraphic() instanceof _gliffy.Link){self.__editor.getDocumentManager().addAndExecuteCommand(new _gliffy.RemoveNodeCommand({node:child,markParentDirty:true}));self.__editor.getDocumentManager().redraw();this.show({node:selectedNode})}}}},unlinkText:function(){$("#container").data("skipTextControlAnalytics",true);tinyMCE.activeEditor.execCommand("unlink",false);$("#container").data("skipTextControlAnalytics",false);this.show(this.targetNode)}});GliffyApp.linkHudController=GliffyApp.LinkHudController.create()}());(function(){GliffyApp.ColorpickerController=GliffyApp.AbstractPropertiesController.extend({__currentButtonDomElement:null,__propertiesController:null,__colorPickerMemory:null,__colorPickerMemoryIndex:0,init:function(){var self=this;this.__colorPickerMemory=[]},actions:{handleCustomButtonClick:function(e){_gliffy.Utils.analyticsEvent("trackEvent",{category:"colorpickerClick",action:"custom"});this.toggleColorpicker(this.__currentButtonDomElement,this.__propertiesController)}},handleSwatchClick:function(e){var hex,colorData;hex=(new _gliffy.RGBColor($(e.currentTarget).css("background-color"))).toHex();colorData=$(e.currentTarget).data("gliffy-color");_gliffy.Utils.analyticsEvent("trackEvent",{category:"colorpickerClick",action:colorData});if($(e.currentTarget).parent().hasClass("gliffy-custom-swatches")){_gliffy.Utils.analyticsEvent("trackEvent",{category:"colorpickerClick",action:"customSwatch"})}if(colorData){if(colorData!=="none"){this.__propertiesController.handleColorpickerColorChange(hex,this.getColorpickerMode(this.__currentButtonDomElement));this.addToColorMemory(hex)}else{this.__propertiesController.handleColorpickerColorChange("none",this.getColorpickerMode(this.__currentButtonDomElement))}this.setSelectedSwatchColor(hex);if(this.__currentButtonDomElement.id!=="gliffy-edit-text_gliffyforecolor"){this.__currentButtonDomElement.click()}}},getColorPickerPosition:function(domElementId){var xoff=-205,yoff=-62,stageOffsetX=_gliffy.Mouse.getStageOffset().left,stageOffsetY=$(".navbar-fixed-top").height(),picker=$("#gliffy-colorpicker"),cx=$("#"+domElementId).offset().left+xoff,cy=$("#"+domElementId).offset().top+yoff,cw=picker.ColorPickerGetWidth(),ch=picker.ColorPickerGetHeight();return this.__getAdjustedPosition(cx,cy,cw,ch,stageOffsetX,stageOffsetY,domElementId)},toggleColorSwatchPicker:function(domElement,propertiesController){var coords,domId=domElement.getAttribute("id"),swatchPicker=$(".gliffy-colorswatchpicker"),picker=$("#gliffy-colorpicker"),buttonClass=domElement.getAttribute("class"),isButtonActive=((domId==="gliffy-edit-text_gliffyforecolor")?buttonClass.indexOf("active")===-1:buttonClass.indexOf("active")>-1);this.__propertiesController=propertiesController;this.__currentButtonDomElement=domElement;propertiesController.resetDialogControls(domId);if(isButtonActive){this.hideColorpicker()}else{picker.ColorPickerHide();swatchPicker.show();coords=this.__getWidgetPosition(domId,$(".gliffy-colorswatchpicker"));swatchPicker.css("left",coords.x+212);swatchPicker.css("top",coords.y+62);this.showColorMemory();this.setSelectedSwatchColor(this.__propertiesController.getTargetColor(domElement));this.showNoFill(domElement)}},showNoFill:function(domElement){var i,targets,showNoFill=true,mode=this.getColorpickerMode(domElement);$(".gliffy-colorswatchpicker .gliffy-nofill").hide();if(mode==="fill"||mode==="linefill"){targets=this.__propertiesController.getTargetNodes();for(i=0;i<targets.length;i++){if(targets[i].getShapeInformation().hideNoFill){showNoFill=false;break}}}else{if(mode==="page"){showNoFill=true}else{showNoFill=false}}if(showNoFill){$(".gliffy-colorswatchpicker .gliffy-nofill").show()}},hideColorpicker:function(){var self=this;setTimeout(function(e){self.__propertiesController.resetDialogControls(null)},1);$("#gliffy-colorpicker").ColorPickerHide();$(".gliffy-colorswatchpicker").hide()},toggleColorpicker:function(domElement,propertiesController){var domId=domElement.getAttribute("id"),picker=$("#gliffy-colorpicker"),swatchPicker=$(".gliffy-colorswatchpicker");this.__propertiesController=propertiesController;this.__currentButtonDomElement=domElement;if(domElement.getAttribute("class").indexOf("active")===-1){this.hideColorpicker()}else{this.__propertiesController.resetDialogControls(domId);picker.ColorPickerSetColor(this.__propertiesController.getTargetColor(domElement),this.getColorpickerMode(domElement));swatchPicker.hide();picker.find(".btn.swatches-button").text($.i18n._("COLORSWATCHPICKER_SWATCHES"));picker.find(".btn.ok-button").text($.i18n._("COLORSWATCHPICKER_OK"));picker.find(".btn.cancel-button").text($.i18n._("COLORSWATCHPICKER_CANCEL"));picker.show();picker.ColorPickerShow();domId=domElement.getAttribute("id");picker.ColorPickerPosition(this.getColorPickerPosition(domId));picker.ColorPickerSetCallback(this.__propertiesController.handleColorpickerColorChange)}},handleSwatchesButtonClick:function(e){var self=GliffyApp.colorpickerController;self.toggleColorSwatchPicker(self.__currentButtonDomElement,self.__propertiesController)},getColorpickerMode:function(domElement){var domId=domElement.getAttribute("id");switch(domId){case"gliffy-contextual-properties-fill-button":return"fill";case"gliffy-contextual-properties-bordercolor-button":return"border";case"gliffy-contextual-properties-linecolor-button":return"line";case"gliffy-contextual-properties-linefillcolor-button":return"linefill";case"gliffy-edit-text_gliffyforecolor":case"gliffy-contextual-properties-textcolor-button":return"text";case"gliffy-document-properties-pagecolor-button":return"page";case"gliffy-contextual-properties-highlight-button":return"SelectedColor";default:return domId}},setSelectedSwatchColor:function(c){if(c){c=c.toUpperCase();$(".gliffy-colorswatchpicker .swatch").each(function(){if($(this).data("gliffy-color")===c){$(this).addClass("selected")}else{$(this).removeClass("selected")}})}},addToColorMemory:function(c){if($.inArray(c,this.__colorPickerMemory)===-1){this.__colorPickerMemory[this.__colorPickerMemoryIndex]=c;this.__colorPickerMemoryIndex++}},showColorMemory:function(){var self=this,index=0,total=this.__colorPickerMemory.length;if(total>10){index=total-10}$(".gliffy-custom-swatches .swatch").each(function(){if(self.__colorPickerMemory[index]){$(this).css("background-color",self.__colorPickerMemory[index]);$(this).data("gliffy-color",self.__colorPickerMemory[index]);$(this).removeClass("nohover")}index++})}})}());(function(){GliffyApp.ContextMenuController=Ember.Object.extend({__editor:null,init:function(){var self=this;$("#container").bind("scroll",function(){self.clearAll()})},clearAll:function(){if(this.__editor.clearContextMenu()||this.__editor.overlayManager.overlay.clearContextMenu()||this.__editor.overlayManager.lineOverlay.clearContextMenu()){$(".context-menu-shadow").hide()}},createContextMenu:function(object,target,contextMenuObject,className){var self=this;if(_gliffy.Debug.NO_CONTEXT_MENU){return}context.init({preventDoubleContext:false,className:className});context.attach(target,contextMenuObject,function(menu){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");self.clearAll();_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextMenu",action:"show"});object.beforeContextMenuShow(menu);object.__contextMenu=menu})},clearContextMenu:function(menu){if(menu&&menu.is(":visible")){menu.hide();return true}return false}})}());(function(){GliffyApp.TipsController=GliffyApp.BaseController.extend({__tips:[],__currentTip:1,__closeCallback:null,init:function(){this.__tips=[]},config:function(o){var self=this;this.__editor=o.editor;if(o.tips){this.__tips=o.tips}this.__update();$("#gliffy-tips-link-next-tip").click(function(e){e.preventDefault();self.__currentTip++;self.__update()});$("#gliffy-tips-link-previous-tip").click(function(e){e.preventDefault();self.__currentTip--;self.__update()});$(".gliffy-tips-footer button").click(function(e){self.close(true)});$(".gliffy-tips-header .close").click(function(e){self.close()});$("#gliffy-tips-checkbox-no-tips").click(function(e){if(e.currentTarget.checked){$.cookie("doNotShowTips",true,{expires:365})}else{$.removeCookie("doNotShowTips",{expires:365})}});$("#gliffy-tips .gliffy-tips-bg").click(function(){self.close(true)})},__update:function(){if(this.__tips.length>0){$("#gliffy-tips-link-previous-tip").toggle(this.__currentTip>1);$("#gliffy-tips-link-next-tip").toggle(this.__currentTip<this.__tips.length);$(".gliffy-tips-graphic").css("background-image","url("+this.__tips[this.__currentTip-1].image+")");$(".gliffy-tips-content h1").html(this.__currentTip+". "+$.i18n._(this.__tips[this.__currentTip-1].title));$(".gliffy-tips-content p").html($.i18n._(this.__tips[this.__currentTip-1].content));$(".gliffy-tips-number").html($.i18n._("TIPS_TIP_NUM",[this.__currentTip,this.__tips.length]))}},close:function(ignoreCloseCallback){$("#gliffy-tips").hide();_gliffy.KeyManager.setState("stage");if(!ignoreCloseCallback&&this.__closeCallback!==null){this.__closeCallback()}$("body").unbind("keydown.gliffy_tips")},openOnInit:function(){if(!this.doNotShowTips()){this.open()}},open:function(closeCallback){var self=this;if(closeCallback){this.__closeCallback=closeCallback}else{this.__closeCallback=null}if(this.__tips.length>0){GliffyApp.toolbarController.doDeselectAll();_gliffy.KeyManager.handleEscKeypress();_gliffy.KeyManager.setState("modals");$("#gliffy-tips").show();$("body").bind("keydown.gliffy_tips",function(e){if(e.which===27){self.close(self.__closeCallback)}});$("#gliffy-tips-checkbox-no-tips").attr("checked",(this.doNotShowTips()))}},doNotShowTips:function(){var cookie=$.cookie("doNotShowTips");return _gliffy.Debug.NO_TIPS||cookie==="true"},showTip:function(tipNum){this.__currentTip=tipNum;this.__update()}});GliffyApp.tipsController=GliffyApp.TipsController.create()}());(function(){GliffyApp.PageNavigatorController=Ember.Object.extend({__editor:null,__positionX:-10000,__positionY:-10000,init:function(){var self=this;$(".gliffy-page-navigator-dragarea").bind("drag",function(event,dd){self.handleDrag(event,dd)});$("#gliffy-navigator-dialog .close").click(function(){$(".gliffy-tool-navigator").parent().removeClass("active");self.hide()});$(".gliffy-navigator-zoomIn").click(function(){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");self.__editor.overlayManager.deselectAll();self.__editor.zoomOverlay.keyboardZoom(true)});$(".gliffy-navigator-zoomOut").click(function(){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");self.__editor.overlayManager.deselectAll();self.__editor.zoomOverlay.keyboardZoom(false)});self.hide()},show:function(){$("#gliffy-navigator-dialog").show();if(this.__positionX===-10000){this.__positionX=$(window).width()-$("#gliffy-navigator-dialog").width()-25;this.__positionY=100}$("#gliffy-navigator-dialog").css({left:this.__positionX+"px",top:this.__positionY+"px"})},hide:function(){$("#gliffy-navigator-dialog").hide()},handleDrag:function(event,dd){var dialog=$("#gliffy-navigator-dialog"),newX=dd.offsetX,newY=dd.offsetY,dialogWidth=dialog.width(),dialogHeight=dialog.height(),windowWidth=$(window).width(),windowHeight=$(window).height();if(dd.offsetX<0){newX=0}else{if(dd.offsetX>(windowWidth-dialogWidth)){newX=windowWidth-dialogWidth}}if(dd.offsetY<90){newY=90}else{if(dd.offsetY>(windowHeight-dialogHeight-15)){newY=(windowHeight-dialogHeight-15)}}dialog.css({left:newX+"px",top:newY+"px"});this.__positionX=newX;this.__positionY=newY}})}());(function(){GliffyApp.progressBarController=GliffyApp.BaseController.create({title:null,__cachedBar:null,init:function(){},show:function(title){if(!title){title=""}this.set("title",title);$("#gliffyProgressBar .progress .bar").width(0);$("#gliffyProgressBar button").attr("disabled","disabled");$("#gliffyProgressBar").modal({backdrop:false})},hide:function(){$("#gliffyProgressBar").modal("hide")},getBar:function(){if(!this.__cachedBar||this.__cachedBar.length===0){this.__cachedBar=$("#gliffyProgressBar .progress .bar")}return this.__cachedBar},updateProgress:function(currentSize,totalSize){this.getBar().width(Math.floor((currentSize/totalSize)*100)+"%")}})}());(function(){GliffyApp.SaveDialogController=GliffyApp.BaseController.extend({__editor:null,init:function(){},config:function(o){this.__editor=o.editor;this.hide()},getModal:function(){return $("#saveDialog")},show:function(){this.getModal().modal("show");var filenameElement=this.getFilenameElement();filenameElement.parents("div.control-group").removeClass("error").find("span.help-inline").text("");filenameElement.val("").focus();return this.getModal()},hide:function(){this.getModal().modal("hide")},applySave:function(){this.__editor.__doSave()},cancelSave:function(){this.__editor.postSaveCallback=null},getFilenameElement:function(){return this.getModal().find(".gliffy-save-filename")},getFilename:function(){return this.getFilenameElement().val()},showErrorMessage:function(msg){_gliffy.Dialog.showAlertDialog({content:msg,title:$.i18n._("ERRORHANDLER_ERROR")})}});GliffyApp.saveDialogController=GliffyApp.SaveDialogController.create()}());(function(){GliffyApp.SideDialogController=GliffyApp.AbstractPropertiesController.extend({_firstOpen:true,_onShow:null,_domSelector:null,_toggleButtonCallback:null,config:function(options){var self=this,o=$.extend({},{domSelector:$(),toggleButtonCallback:null},options),dialog,left;self._domSelector=o.domSelector;self._toggleButtonCallback=o.toggleButtonCallback;if(!window.jasmine){$(window).resize(function(){dialog=$(self._domSelector);left=parseInt(dialog.css("left").toLowerCase().replace("px",""),10);if(left>$(window).width()){dialog.css({left:($(window).width())+"px",top:$(".gliffy-html5-container").offset().top+"px"})}})}},setOnShow:function(onShow){var self=this;self._onShow=onShow;setInterval(function(){if(self._onShow){self._onShow()}},1000)},getDialogDomSelector:function(){return this._domSelector},showDialog:function(){var dialog=$(this._domSelector),left,top;left=parseInt(dialog.css("left").toLowerCase().replace("px",""),10);if(this._firstOpen||left>$(window).width()){left=$(window).width();top=$(".gliffy-html5-container").offset().top;if(this.isPositionOverAnotherSideDialog(left,top)){left=left-dialog.width()}dialog.css({left:left+"px",top:top+"px"})}this._firstOpen=false;if(this._onShow){this._onShow()}dialog.show()},__isPositionOverAnotherSideDialog:function(otherDialogElement,left,top){return(otherDialogElement.is(":visible")&&otherDialogElement.position().left===left&&otherDialogElement.position().top===top)},hideDialog:function(){$(this._domSelector).hide();if(this._toggleButtonCallback){this._toggleButtonCallback(false)}},handleDrag:function(event,dd){var dialog=$(this._domSelector),newX=dd.offsetX+200,newY=dd.offsetY,dialogWidth=dialog.width(),dialogHeight=dialog.height(),windowWidth=$(window).width(),windowHeight=$(window).height();if(dd.offsetX<0){newX=200}else{if(dd.offsetX>(windowWidth-dialogWidth)){newX=windowWidth-dialogWidth+200}}if(dd.offsetY<90){newY=90}else{if(dd.offsetY>(windowHeight-dialogHeight-15)){newY=(windowHeight-dialogHeight-15)}}dialog.css({left:newX+"px",top:newY+"px"})}})}());(function(){GliffyApp.ThemeController=GliffyApp.SideDialogController.extend({config:function(o){this.__editor=o.editor;this._super({domSelector:"#gliffy-theme-dialog",toggleButtonCallback:function(state){GliffyApp.toolbarController.toggleThemesButton(state)}})},isPositionOverAnotherSideDialog:function(left,top){return this.__isPositionOverAnotherSideDialog($(GliffyApp.layersController.getDialogDomSelector()),left,top)}});GliffyApp.themeController=GliffyApp.ThemeController.create()}());(function(){GliffyApp.LayersController=GliffyApp.SideDialogController.extend({_editor:null,layers:null,atMaxLayers:false,atMinLayers:true,multipleLayersActive:false,debug:false,guid:null,layerNameClickTime:null,init:function(){},config:function(o){this.__editor=o.editor;this._editor=o.editor;this.debug=o.debug;var self=this;this._super({domSelector:"#gliffy-layers-dialog",toggleButtonCallback:function(state){GliffyApp.toolbarController.toggleLayersButton(state)}});_gliffy.Mouse.registerClickState({name:"layers",modes:["layers-panel-drag"],target:"#gliffy-layers-area .gliffy-panel-move",mouseDown:function(event){var $this=$(event.currentTarget);if($this.hasClass("gliffy-panel-move")){_gliffy.Mouse.setClickMode("layers");_gliffy.Mouse.setState("layers-panel-drag");_gliffy.Mouse.__mousedown(event)}}});$(window).on("gliffy-stage-layer-updated",function(event,layer){var emberLayer=_.find(self.layers,{guid:layer.guid});if(emberLayer){emberLayer.setProperties(layer.toObject())}});$(window).on("gliffy-stage-all-layers-updated",function(event,stageLayers){self.deserializeLayersObject(stageLayers)});(new _gliffy.PanelDrag()).registerPanelDrag("layers-panel-drag",".gliffy-layers-scrollable",function(){self._commitRTEAndDeselect();self._reorderLayers()})},actions:{editLayerNameOnDoubleClick:function(layer){var self=this;if(new Date()-this.layerNameClickTime<350){layer.set("isEditingName",true);_gliffy.Utils.analyticsEvent("trackEvent",{category:"layers",action:"editLayerName"});this.guid=layer.guid;setTimeout(function(){var input=$(".gliffy-layer-name-input");input.focus();input.select();input.off("blur.layer-name-blur");input.off("click.layer-name-click");input.on("click.layer-name-click",function(event){event.stopPropagation();event.preventDefault()});input.on("blur.layer-name-blur",function(){self.applyNameToLayer(self.guid,$(".gliffy-layer-name-input").val())})},0)}this.layerNameClickTime=new Date()},setActive:function(layer){this.setActiveByGuids([layer.guid]);this.applyModifications(false)},addLayer:function(){_gliffy.Utils.analyticsEvent("trackEvent",{category:"layers",action:"add"});this.addLayer()},deleteActiveLayers:function(){_gliffy.Utils.analyticsEvent("trackEvent",{category:"layers",action:"deleteActive"});this.deleteActiveLayers()},duplicateLayer:function(){_gliffy.Utils.analyticsEvent("trackEvent",{category:"layers",action:"duplicate"});this.duplicateLayer()},toggleVisibility:function(layer){_gliffy.Utils.analyticsEvent("trackEvent",{category:"layers",action:"toggleVisibility"});this.setVisibility(layer,!layer.visible)},toggleLock:function(layer){_gliffy.Utils.analyticsEvent("trackEvent",{category:"layers",action:"toggleLock"});this.setLock(layer,!layer.locked)}},isPositionOverAnotherSideDialog:function(left,top){return this.__isPositionOverAnotherSideDialog($(GliffyApp.themeController.getDialogDomSelector()),left,top)},handleInputKeyDown:function(e){if(e.keyCode===13){this.applyNameToLayer(this.guid,$(".gliffy-layer-name-input").val())}},_calcAtMaxOrMinLayers:function(){this.set("atMaxLayers",this.layers.length>=_gliffy.Layer.MAX_LAYERS);this.set("atMinLayers",this.layers.length<=1);this.set("multipleLayersActive",this.getActiveLayers().length>1)},_createName:function(prefix){var names={},ctr=0;_.each(this.layers,function(layer){names[layer.name]=true});while(true){if(!names[prefix+ctr]){return prefix+ctr}if(ctr>=256){_gliffy.Logger.warn("could not fond valid layer name");return prefix+"0"}ctr++}},_commitRTE:function(){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text")},_deselect:function(){this._editor.overlayManager.deselectAll()},_commitRTEAndDeselect:function(){this._commitRTE();this._deselect()},_reorderLayers:function(){var $nameDom=$("#gliffy-layers-area .gliffy-layer-name"),orderCtr=$nameDom.length-1,documentManager=this._editor.getDocumentManager(),orderChanged=false,self=this;$nameDom.each(function(){var guid=$(this).data("guid"),layer=_.find(self.layers,{guid:guid}),oldOrder=layer.get("order");if(oldOrder!==orderCtr){layer.set("order",orderCtr);orderChanged=true}orderCtr--});if(orderChanged){self.deserializeLayersObject(_.sortBy(self.layers,function(layer){return -layer.order}));documentManager.pushCommandBundle();self.applyModifications(true);documentManager.addAndExecuteCommand(new _gliffy.ReorderNodesCommand({node:null}));documentManager.popCommandBundle();documentManager.redraw()}},sendToLayer:function(stageLayer,node){var documentManager=this._editor.getDocumentManager();documentManager.pushCommandBundle();this.setActiveByGuids([stageLayer.guid]);this.applyModifications(true);if(node.isSelection()){node.setCopiedSelection(true);if(node.children){var i=0;node.children=_.sortBy(node.children,function(childNode){return childNode.getOrder()});_.each(node.children,function(childNode){childNode.updateProperty("LayerId",stageLayer.guid);childNode.prevOrder=childNode.getOrder();childNode.setOrder(_gliffy.Layer.ABOVE_ALL_LAYERS+(i++))})}}else{node.updateProperty("LayerId",stageLayer.guid);node.updateProperty("Order",_gliffy.Layer.ABOVE_ALL_LAYERS)}if(node.isSelection()){this._deselect()}documentManager.addAndExecuteCommand(new _gliffy.ReorderNodesCommand({node:null}));documentManager.popCommandBundle();documentManager.redraw()},duplicateLayer:function(){var documentManager=this._editor.getDocumentManager(),stage=documentManager.getActiveStage(),copiedSelection=null,activeGuid,oldLayerNodes,newLayerGuid,selection;this.setTopmostLayerActive();activeGuid=this.getTopmostActiveLayer().guid;this._commitRTEAndDeselect();documentManager.pushCommandBundle();oldLayerNodes=stage.findNodesByLayerId(activeGuid);selection=this._editor.overlayManager.selectNodes(oldLayerNodes);if(selection){copiedSelection=new _gliffy.Node();copiedSelection.fromObject(selection.toObject())}newLayerGuid=this.addLayer(this.getLayerByGUID(activeGuid).name+" copy");if(copiedSelection){copiedSelection.setLayerId(newLayerGuid);copiedSelection.setCopiedSelection(true)}this.applyModifications(true);this.setActiveByGuids([newLayerGuid]);if(copiedSelection){documentManager.addAndExecuteCommand(new _gliffy.AddCopyNodeCommand({node:copiedSelection}))}this._deselect();documentManager.popCommandBundle();documentManager.redraw()},applyModifications:function(undoable){var command=new _gliffy.ModifyLayersCommand({layers:this.serializeLayersObject()});if(undoable){this._editor.getDocumentManager().addAndExecuteCommand(command)}else{command.execute(this._editor.getDocumentManager().getActiveStage())}$(".tooltip").remove();this._calcAtMaxOrMinLayers()},_sortLayers:function(){this.set("layers",_.sortBy(this.layers,function(layer){return layer.order}).reverse())},setActiveByGuids:function(guidArray){_.each(this.layers,function(layer){layer.set("active",false);_.each(guidArray,function(guid){if(layer.guid===guid){layer.set("active",true)}})})},getActiveLayers:function(){var activeLayers;activeLayers=_.filter(this.layers,function(layer){return layer.active});return activeLayers},getLayerByGUID:function(guid){var layer;layer=_.findWhere(this.layers,{guid:guid})||null;return layer},addLayer:function(name){this._commitRTEAndDeselect();var topmostLayer=_.max(this.layers,function(layer){return layer.order}),emberLayer=(Ember.Object.create().setProperties(new _gliffy.Layer().fromDefault().setName(name?name:this._createName("Layer ")).setOrder(topmostLayer.order+1).toObject()));this.layers.pushObject(emberLayer);this.setActiveByGuids([emberLayer.guid]);this._sortLayers();this.applyModifications(true);return emberLayer.guid},deleteActiveLayers:function(options){var active=this.getActiveLayers(),documentManager=this._editor.getDocumentManager(),nodesToDelete=[],bottomLayer,o=$.extend({},{stage:null},options),stage=o.stage||documentManager.getActiveStage();this._commitRTEAndDeselect();if(active.length<this.layers.length){_.each(active,function(layer){nodesToDelete=nodesToDelete.concat(stage.findNodesByLayerId(layer.guid));this.layers.removeObject(layer)},this)}bottomLayer=this.layers[0];bottomLayer.set("active",true);documentManager.pushCommandBundle();_.each(nodesToDelete,function(node){if(o.stage){new _gliffy.RemoveNodeCommand({node:node}).execute(o.stage)}else{documentManager.addAndExecuteCommand(new _gliffy.RemoveNodeCommand({node:node}))}});this.applyModifications(true);documentManager.popCommandBundle();documentManager.redraw()},setVisibility:function(layer,visibility){var documentManager=this._editor.getDocumentManager(),stage=documentManager.getActiveStage(),markDirtyDeep;this._commitRTEAndDeselect();layer.set("visible",visibility);documentManager.pushCommandBundle();markDirtyDeep=function(nodes,setPositionFlag){_.each(nodes,function(node){node.markDirty();if(setPositionFlag){node.setFlag("position");node.setFlag("guide")}if(node.children){markDirtyDeep(node.children,setPositionFlag)}})};markDirtyDeep(stage.findNodesByLayerId(layer.guid),visibility);this.applyModifications(true);documentManager.popCommandBundle();documentManager.redraw()},setLock:function(layer,locked){var documentManager=this._editor.getDocumentManager(),stage=documentManager.getActiveStage();layer.set("locked",locked);this._commitRTEAndDeselect();this.applyModifications(true);_.each(stage.findNodesByLayerId(layer.guid),function(node){_.each(node.findGraphic(_gliffy.Text),function(textNode){textNode.markDirty();textNode.setFlag("bounds")})});documentManager.redraw()},setActiveByNode:function(node){this.setActiveByGuids(_.map(node.getActiveLayers(),function(layer){return layer.guid}));this.applyModifications(false)},getTopmostActiveLayer:function(){var topmostActiveLayer;topmostActiveLayer=_.max(this.getActiveLayers(),function(layer){return layer.order});return topmostActiveLayer},setTopmostLayerActive:function(){var topmost=this.getTopmostActiveLayer();this.setActiveByGuids([topmost.guid]);this.applyModifications(false)},applyNameToLayer:function(guid,name){var layer=GliffyApp.layersController.getLayerByGUID(guid);layer.set("isEditingName",false);layer.set("name",name);GliffyApp.layersController.applyModifications(true)},deserializeLayersObject:function(layers){var active=false;this.set("layers",Ember.A([]));_.each(layers,function(layer){if(layer.active){active=true}this.layers.pushObject(Ember.Object.create().setProperties(layer))},this);if(!active){_gliffy.Logger.warn("warning: no active layer in deserializeLayersObject")}this._calcAtMaxOrMinLayers()},serializeLayersObject:function(){return JSON.parse(JSON.stringify(this.layers))}});GliffyApp.layersController=GliffyApp.LayersController.create()}());(function(){GliffyApp.ExportDialogController=GliffyApp.BaseController.extend({MAX_EXPORT_MEMORY_LIMIT:36000000,__disable200PercentOption:false,__disable300PercentOption:false,__disable400PercentOption:false,showDialog:function(){var sizeSelector=".gliffy-export-dialog input[type=radio][name=gliffy-export-format]",self=this,isFirefox=GLIFFY.BrowserDetect.browser==="Firefox",stageWidth=this.__editor.getDocumentManager().getActiveStage().width,stageHeight=this.__editor.getDocumentManager().getActiveStage().height,stageArea=stageWidth*stageHeight,validFormats=["PNG","JPG","SVG","Gliffy"],exportTo;this.__disable200PercentOption=((stageArea*Math.pow(2,2))>this.MAX_EXPORT_MEMORY_LIMIT)&&!isFirefox;this.__disable300PercentOption=((stageArea*Math.pow(3,2))>this.MAX_EXPORT_MEMORY_LIMIT)&&!isFirefox;this.__disable400PercentOption=((stageArea*Math.pow(4,2))>this.MAX_EXPORT_MEMORY_LIMIT)&&!isFirefox;function unbindHandlers(){$(sizeSelector).off("change")}_gliffy.Dialog.showGenericDialog({content:$(".gliffy-export-dialog-body").html(),title:$.i18n._("EXPORT_TITLE"),cancelCallback:null,escapeHTML:false,buttons:[{text:$.i18n._("EXPORT_EXPORT"),callback:function(button){var type=$("input[name=gliffy-export-format]:checked").val(),size=parseInt($("input[name=gliffy-export-size]:checked").val());switch(type){case"PNG":self.exportImage("image/png","png",size);_gliffy.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:"exportAsPNG"+size});break;case"JPG":self.exportImage("image/jpeg","jpg",size);_gliffy.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:"exportAsJPG"+size});break;case"SVG":self.exportSvg();_gliffy.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:"exportAsSVG"});break;case"Gliffy":self.exportData("application/gliffy+json","gliffy");_gliffy.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:"exportAsGliffy"});break}unbindHandlers()},primary:true,dismiss:true},{text:$.i18n._("LINKBROWSER_CANCEL"),callback:function(button){unbindHandlers()},primary:false,dismiss:true}]});this.__updateExportSizeOptions(true);exportTo=this.__editor.getExportTo();_.each(validFormats,function(validFormat){var show=$.inArray(validFormat,exportTo)>=0;$("#gliffy-export-"+validFormat)[show?"show":"hide"]();$("label[for='gliffy-export-"+validFormat+"']")[show?"show":"hide"]()});$(sizeSelector).on("change",function(){self.__updateExportSizeOptions($(this).data("showsize"))})},__updateExportSizeOptions:function(showSizes){$("input[name=gliffy-export-size]").prop("disabled",true);$(".gliffy-export-size-label").addClass("disabled");$("#gliffy-export-size-100").prop("disabled",!showSizes);$("label[for='gliffy-export-size-100']")[showSizes?"removeClass":"addClass"]("disabled");if(!this.__disable200PercentOption){$("#gliffy-export-size-200").prop("disabled",!showSizes);$("label[for='gliffy-export-size-200']")[showSizes?"removeClass":"addClass"]("disabled")}if(!this.__disable300PercentOption){$("#gliffy-export-size-300").prop("disabled",!showSizes);$("label[for='gliffy-export-size-300']")[showSizes?"removeClass":"addClass"]("disabled")}if(!this.__disable400PercentOption){$("#gliffy-export-size-400").prop("disabled",!showSizes);$("label[for='gliffy-export-size-400']")[showSizes?"removeClass":"addClass"]("disabled")}$("#gliffy-export-size-100").attr("checked","checked")},exportSvg:function(){var self=this,command;this.__editor.getDocumentManager().getSvgData(this.__editor.getDocumentManager().getActiveStage(),function(mockContext){if(_gliffy.Debug.LOCAL_SVG_EXPORT){var iframe=$("<iframe id='gliffy-svg-frame'/>"),tmp=$("<div style='position:absolute'/>"),contents,svg;iframe.css({position:"fixed",left:0,top:0,width:500,height:500,zIndex:610000});tmp.append(mockContext.getSvg());$("body").append(iframe);contents=iframe.contents();contents.find("body").css("margin","0").append(mockContext.getSvg()).click(function(){iframe.remove()});svg=contents.find("svg");iframe.width(svg.width()).height(svg.height())}else{command={document:self.__editor.getDocumentManager().getActiveDocument(),contentType:"image/svg+xml",extension:"svg",data:mockContext.getSerializedSvg(true)};self.__editor.performAction("export",command)}GliffyApp.progressBarController.getBar().delay(500).queue(function(next){GliffyApp.progressBarController.hide();next()})},true)},exportImage:function(contentType,extension,scale){var self=this,command,stage=this.__editor.getDocumentManager().getActiveStage();this.__editor.getDocumentManager().getImageData(stage,contentType,function(imageData){command={document:self.__editor.getDocumentManager().getActiveDocument(),contentType:contentType,extension:extension,data:imageData};self.__editor.performAction("export",command);GliffyApp.progressBarController.getBar().delay(500).queue(function(next){GliffyApp.progressBarController.hide();next()})},true,scale)},exportData:function(contentType,extension){var self=this,command;command={document:self.__editor.getDocumentManager().getActiveDocument(),contentType:contentType,extension:extension};self.__editor.performAction("export",command);GliffyApp.progressBarController.getBar().delay(500).queue(function(next){GliffyApp.progressBarController.hide();next()})}});GliffyApp.exportDialogController=GliffyApp.ExportDialogController.create()}());(function(){var _load=[];GliffyApp.GlobalView=Ember.View.create({showUnstable:false,supported:false,init:function(){var metaDom=$("meta[name=gliffy-show-unstable]");if(metaDom.length>0){this.showUnstable=metaDom.attr("content")==="true"}metaDom=$("meta[name=gliffy-supported]");if(metaDom.length>0){this.supported=metaDom.attr("content")==="true"}},didInsertElement:function(){var i;for(i=0;i<_load.length;i++){_load[i]()}},appendTemplate:function(templateName,parent){parent=parent||"#gliffy";var render=function(){Ember.View.create({templateName:templateName}).appendTo(parent)};_load.push(render);if($(parent).length>0){render()}},renderTemplate:function(templateName,container){var render=function(){$(container).html("");Ember.View.create({templateName:templateName}).appendTo($(container))};_load.push(render);if($(container).length>0){render()}}})}());(function(){GliffyApp.AbstractInputModalView=Ember.View.extend({didInsertElement:function(e){var self=this;$(".gliffy-input-modal").on("hide",function(e){$(".gliffy-input-modal-error").hide()});$(".gliffy-input-modal").on("show",function(e){self.doOnShow()});$(".gliffy-input-modal").on("shown",function(e){self.doOnShown()});$(".gliffy-input-modal-input").focus(function(){setTimeout(function(){if(window.GLIFFY.KeyManager){window.GLIFFY.KeyManager.setState("input")}},100)});$(".gliffy-input-modal-input").blur(function(){if(window.GLIFFY.KeyManager){window.GLIFFY.KeyManager.setState("modals")}});$(".gliffy-input-modal-input").on("keydown",function(e){self.handleInputKeyDown(e)})},doOnShow:function(){$(".gliffy-input-modal-input").val("")},doOnShown:function(){$(".gliffy-input-modal-input").focus()},handleSubmit:function(e){$(".gliffy-input-modal-error").hide()},handleInputKeyDown:function(e){if(e.keyCode===13){e.preventDefault();this.handleSubmit(e)}},displayErrorMessage:function(errorMsg){$(".gliffy-input-modal-error").show();$(".gliffy-input-modal-error p").html(errorMsg)}})}());(function(){GliffyApp.AbstractPropertiesTextField=Ember.TextField.extend({keyDown:function(e){if(e.keyCode===13||e.keyCode===9){this.handleEnterOrTabKey(e.keyCode);if(e.keyCode===13){e.preventDefault()}}},focusOut:function(e){if($(e.currentTarget).is(":visible")){this.__commit(this.propertyKey,this.value)}else{this.__rollback()}},__commit:function(){throw ("You need to override __commit() for GliffyApp.AbstractPropertiesTextField")},__rollback:function(){throw ("You need to override __rollback() for GliffyApp.AbstractPropertiesTextField")}})}());(function(){GliffyApp.DocumentPropertiesView=Ember.View.extend({titleBinding:Ember.Binding.oneWay("GliffyApp.documentModel.title"),versionBinding:Ember.Binding.oneWay("GliffyApp.documentModel.currentRevision"),showStageProperties:false,showDisableAutosaveCheckbox:false,clickExportBorderCheckbox:function(e){GliffyApp.documentPropertiesController.resetDialogControls();GliffyApp.documentPropertiesController.updateProperty("ExportBorder",$("#gliffy-document-properties-checkbox-exportborder").prop("checked"))},clickDisableAutosaveCheckbox:function(e){GliffyApp.documentPropertiesController.resetDialogControls();var checked=$("#gliffy-document-properties-checkbox-autosave").prop("checked");GliffyApp.documentModel.updateProperty("autosaveDisabled",checked);GliffyApp.documentPropertiesController.getEditor().getDocumentManager().getActiveDocument().setAutosaveDisabled(checked);GliffyApp.documentModel.set("unsavedChanges",true)},clickColorButton:function(e){GliffyApp.colorpickerController.toggleColorSwatchPicker(e.currentTarget,GliffyApp.documentPropertiesController);e.preventDefault()},didInsertElement:function(){var self=this;this.set("showDisableAutosaveCheckbox",_gliffy.FEATURES.allowDisableAutosave);$("#gliffy-document-properties-dialog-close-btn").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD).on("click",function(){GliffyApp.documentPropertiesController.hideDialog()});$("#gliffy-document-properties-pagecolor-button").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD).on("click",function(e){self.clickColorButton(e)});$("#gliffy-document-properties-checkbox-autosave").on("click",function(e){self.clickDisableAutosaveCheckbox(e)});$("#gliffy-document-properties-checkbox-exportborder").on("click",function(e){self.clickExportBorderCheckbox(e)})}});GliffyApp.DocumentPropertiesTextField=GliffyApp.AbstractPropertiesTextField.extend({mouseDown:function(e){GliffyApp.documentPropertiesController.resetDialogControls()},__commit:function(prop,value){if(GliffyApp.documentPropertiesController.isValidPropertyValue(prop,value)){if(this.value!==this.oldValue){GliffyApp.documentPropertiesController.updateSizeProperty(prop,value)}}else{this.__rollback()}_gliffy.KeyManager.setState("stage")}});GliffyApp.DocumentPropertiesTextFieldWidth=GliffyApp.DocumentPropertiesTextField.extend({propertyKey:"MaxWidth",valueBinding:Ember.Binding.oneWay("GliffyApp.documentModel.maxWidth"),oldValueBinding:Ember.Binding.oneWay("GliffyApp.documentModel.maxWidth"),__rollback:function(){this.set("value",GliffyApp.documentModel.maxWidth)},handleEnterOrTabKey:function(keyCode){if(keyCode===13){$("#gliffy-document-properties-textfield-width").blur()}}});GliffyApp.DocumentPropertiesTextFieldHeight=GliffyApp.DocumentPropertiesTextField.extend({propertyKey:"MaxHeight",valueBinding:Ember.Binding.oneWay("GliffyApp.documentModel.maxHeight"),oldValueBinding:Ember.Binding.oneWay("GliffyApp.documentModel.maxHeight"),__rollback:function(){this.set("value",GliffyApp.documentModel.maxHeight)},handleEnterOrTabKey:function(keyCode){$("#gliffy-document-properties-textfield-height").blur()}})}());(function(){GliffyApp.ContextualPropertiesView=Ember.View.extend({lineTypeIconClassBinding:Ember.Binding.oneWay("GliffyApp.contextualPropertiesController.lineTypeIconClass"),clickColorButton:function(e){GliffyApp.colorpickerController.toggleColorSwatchPicker(e.currentTarget,GliffyApp.contextualPropertiesController);e.preventDefault()},clickFillOpacityButton:function(e){GliffyApp.contextualPropertiesController.toggleOpacityWidget(e.currentTarget,"fillOpacity");e.preventDefault()},convertToChart:function(e){GliffyApp.contextualPropertiesController.convertToChart();_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"convertTableToChart"})},selectArrowBegin:function(e){GliffyApp.contextualPropertiesController.updateLineTabProperty("StartArrow",Number(e.currentTarget.getAttribute("data-gliffy-value")));_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"startArrow",value:Number(e.currentTarget.getAttribute("data-gliffy-value"))});e.preventDefault();$("#gliffy-contextual-properties-arrowbegin").click()},selectArrowEnd:function(e){GliffyApp.contextualPropertiesController.updateLineTabProperty("EndArrow",Number(e.currentTarget.getAttribute("data-gliffy-value")));_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"endArrow",value:Number(e.currentTarget.getAttribute("data-gliffy-value"))});e.preventDefault();$("#gliffy-contextual-properties-arrowend").click()},clickDropdown:function(e){var domId=e.currentTarget.getAttribute("id"),dropdownContainer=$(e.currentTarget).parent(),dropdown=dropdownContainer.children("ul");GliffyApp.contextualPropertiesController.resetDialogControls(domId);if(this.__isDropdownBelowFold(dropdownContainer,dropdown)){dropdown.css("top",-(dropdown.height()+12))}else{dropdown.css("top","100%")}$(e.currentTarget).tooltip("hide");e.preventDefault()},__isDropdownBelowFold:function(dropdownContainer,dropdown){return(dropdownContainer.offset().top+dropdownContainer.height()+dropdown.height()>$(window).height())},clickAspectRatioCheckbox:function(e){GliffyApp.contextualPropertiesController.resetDialogControls();GliffyApp.contextualPropertiesController.updateShapeTabProperty("LockAspectRatio",$("#gliffy-contextual-properties-checkbox-fixedaspect").prop("checked"));_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:$("#gliffy-contextual-properties-checkbox-fixedaspect").prop("checked")?"fixAspect":"unfixAspect"});_gliffy.KeyManager.setState("contextualProperties")},clickLockShapeCheckbox:function(e){GliffyApp.contextualPropertiesController.resetDialogControls();GliffyApp.contextualPropertiesController.updateShapeTabProperty("LockPosition",$("#gliffy-contextual-properties-checkbox-lockshape").prop("checked"));_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:$("#gliffy-contextual-properties-checkbox-lockshape").prop("checked")?"lockPosition":"unlockPosition"});_gliffy.KeyManager.setState("contextualProperties")},didInsertElement:function(){var self=this,checkBoxLockShape;$("#gliffy-contextual-properties-dialog .jqmClose").attr("title",$.i18n._("MODAL_CLOSE"));$("#gliffy-contextual-properties-controls button:not(#gliffy-contextual-properties-shapeline-trigger, #gliffy-contextual-properties-text-trigger, #gliffy-contextual-properties-table-trigger)").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-border-width").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-gradient-button").parent().tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-shadow-button").parent().tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-controls .jqmClose").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$(".gliffy-text-properties span").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-cardinalitybegin").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-cardinalityend").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-arrowbegin").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-lanes").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-arrowend").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-linecolor-button").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-line-width").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-dash-style").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-line-dash-style").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-line-type").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);if(_gliffy.FEATURES.charts){$("#gliffy-contextual-properties-table-make-chart-button").show()}$("#gliffy-contextual-properties-dialog-Trigger button").click(function(e){GliffyApp.contextualPropertiesController.showDialog(e)}).tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-controls-tabs").find(".gliffy-shape-properties-tab").attr("title",$.i18n._("SHAPE_PROPERTIES"));$("#gliffy-contextual-properties-controls-tabs").find(".gliffy-line-properties-tab").attr("title",$.i18n._("LINE_PROPERTIES"));$("#gliffy-contextual-properties-controls-tabs").find(".gliffy-text-properties-tab").attr("title",$.i18n._("TEXT_PROPERTIES"));$("#gliffy-contextual-properties-controls-tabs").find(".gliffy-custom-properties-tab").attr("title",$.i18n._("CUSTOM_PROPERTIES"));$("#gliffy-contextual-properties-controls-tabs li").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_TOP);$("#gliffy-contextual-properties-dialog").jqm({modal:false,trigger:"#gliffy-contextual-properties-shapeline-trigger,#gliffy-contextual-properties-text-trigger,#gliffy-contextual-properties-table-trigger",onHide:GliffyApp.contextualPropertiesController.closeDialog,overlay:0,overlayClass:"whiteOverlay"});$("#gliffy-contextual-properties-dialog .jqmClose").on("click",function(){if(_gliffy.BrowserDetect.browser==="Explorer"){setTimeout(function(){$("#gliffy-contextual-properties-controls").show()},100)}});$(".gliffy-contextual-properties-dragarea").bind("drag",function(event,dd){GliffyApp.contextualPropertiesController.handleDrag(event,dd)});$(".gliffy-contextual-properties-dragarea").bind("dragstart",function(event){GliffyApp.contextualPropertiesController.handleDragStart(event)});$("#gliffy-contextual-properties-controls-tabs li a").on("shown",function(e){GliffyApp.contextualPropertiesController.showTab()});GliffyApp.overlayModel.addObserver("lockShape",function(){GliffyApp.contextualPropertiesController.setTextFieldDisabled("#gliffy-contextual-properties-textfield-x",GliffyApp.overlayModel.lockShape);GliffyApp.contextualPropertiesController.setTextFieldDisabled("#gliffy-contextual-properties-textfield-y",GliffyApp.overlayModel.lockShape);GliffyApp.contextualPropertiesController.setTextFieldDisabled("#gliffy-contextual-properties-textfield-width",GliffyApp.overlayModel.lockShape);GliffyApp.contextualPropertiesController.setTextFieldDisabled("#gliffy-contextual-properties-textfield-height",GliffyApp.overlayModel.lockShape);GliffyApp.contextualPropertiesController.setTextFieldDisabled("#gliffy-contextual-properties-textfield-rotation",GliffyApp.overlayModel.lockShape);GliffyApp.contextualPropertiesController.setTextFieldDisabled("#gliffy-contextual-properties-textfield-opacity",GliffyApp.overlayModel.lockShape)});$("#gliffy-contextual-properties-fill-button,#gliffy-contextual-properties-bordercolor-button,#gliffy-contextual-properties-linecolor-button, #gliffy-contextual-properties-linefillcolor-button").on("click",function(e){self.clickColorButton(e)});$("#gliffy-contextual-properties-border-width, #gliffy-contextual-properties-dash-style, #gliffy-contextual-properties-arrowbegin, #gliffy-contextual-properties-arrowend,#gliffy-contextual-properties-line-width, #gliffy-contextual-properties-line-dash-style, #gliffy-contextual-properties-line-type").on("click",function(e){self.clickDropdown(e)});$("#gliffy-contextual-properties-checkbox-fixedaspect").on("click",function(e){self.clickAspectRatioCheckbox(e)});$("#gliffy-contextual-properties-button-loremipsum").click(function(e){GliffyApp.contextualPropertiesController.handleLoremIpsumClick()});checkBoxLockShape=$("#gliffy-contextual-properties-checkbox-lockshape");if(checkBoxLockShape.length>0){checkBoxLockShape.on("focus",function(e){checkBoxLockShape.keydown(function(e){if(e.which===9){$("#gliffy-contextual-properties-textfield-x").select();setTimeout(function(){$("#gliffy-contextual-properties-textfield-x").focus()},1)}})})}checkBoxLockShape.on("click",function(e){self.clickLockShapeCheckbox(e)});$("#gliffy-contextual-properties-shape-opacity-button").on("click",function(e){self.clickFillOpacityButton(e)});$("#gliffy-contextual-properties-text-position-button").on("click",function(e){self.clickDropdown(e)});$("#gliffy-contextual-properties-controls-tabs a").on("show",function(){var rte=$("#gliffy-edit-text_ifr"),tabs=$("#gliffy-contextual-properties-controls-tabs");if(tabs.find("li:visible").length===3){tabs.addClass("three-tabs")}else{tabs.removeClass("three-tabs")}if(rte.is(":visible")){_gliffy.KeyManager.setState("rte")}else{_gliffy.KeyManager.setState("contextualProperties")}});GliffyApp.contextualPropertiesController.registerScrollHandler();$("#container").bind("scrollStart",function(){GliffyApp.contextualPropertiesController.handleScrollStart()});$("#container").bind("scrollEnd",function(){GliffyApp.contextualPropertiesController.handleScrollEnd()})}});GliffyApp.ContextualPropertiesTextField=GliffyApp.AbstractPropertiesTextField.extend({mouseDown:function(e){GliffyApp.contextualPropertiesController.resetDialogControls()},handleEnterOrTabKey:function(){this.__commit(this.propertyKey,this.value)},__commit:function(prop,value){if(GliffyApp.contextualPropertiesController.isValidPropertyValue(prop,value)){if(parseInt(this.value,10)!==parseInt(this.oldValue,10)){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"type"+_gliffy.Utils.capitalize(prop),value:parseInt(this.value,10)});GliffyApp.contextualPropertiesController.updateShapeTabProperty(prop,value)}}else{this.__rollback()}}});GliffyApp.ContextualPropertiesTextFieldX=GliffyApp.ContextualPropertiesTextField.extend({propertyKey:"x",valueBinding:Ember.Binding.oneWay("GliffyApp.contextualPropertiesController.overlayX"),oldValueBinding:Ember.Binding.oneWay("GliffyApp.contextualPropertiesController.overlayX"),__rollback:function(){this.set("value",GliffyApp.contextualPropertiesController.overlayX)}});GliffyApp.ContextualPropertiesTextFieldY=GliffyApp.ContextualPropertiesTextField.extend({propertyKey:"y",valueBinding:Ember.Binding.oneWay("GliffyApp.contextualPropertiesController.overlayY"),oldValueBinding:Ember.Binding.oneWay("GliffyApp.contextualPropertiesController.overlayY"),__rollback:function(){this.set("value",GliffyApp.contextualPropertiesController.overlayY)}});GliffyApp.ContextualPropertiesTextFieldWidth=GliffyApp.ContextualPropertiesTextField.extend({propertyKey:"width",valueBinding:Ember.Binding.oneWay("GliffyApp.contextualPropertiesController.overlayWidth"),oldValueBinding:Ember.Binding.oneWay("GliffyApp.contextualPropertiesController.overlayWidth"),__rollback:function(){this.set("value",GliffyApp.contextualPropertiesController.overlayWidth)}});GliffyApp.ContextualPropertiesTextFieldHeight=GliffyApp.ContextualPropertiesTextField.extend({propertyKey:"height",valueBinding:Ember.Binding.oneWay("GliffyApp.contextualPropertiesController.overlayHeight"),oldValueBinding:Ember.Binding.oneWay("GliffyApp.contextualPropertiesController.overlayHeight"),__rollback:function(){this.set("value",GliffyApp.contextualPropertiesController.overlayHeight)}});GliffyApp.ContextualPropertiesTextFieldRotation=GliffyApp.ContextualPropertiesTextField.extend({propertyKey:"rotation",valueBinding:Ember.Binding.oneWay("GliffyApp.contextualPropertiesController.overlayRotation"),oldValueBinding:Ember.Binding.oneWay("GliffyApp.contextualPropertiesController.overlayRotation"),__rollback:function(){this.set("value",GliffyApp.contextualPropertiesController.overlayRotation)}});GliffyApp.PropertiesBootstrapToggleButton=Ember.View.extend({tagName:"button",classNameBindings:["buttonClass"],buttonClass:Ember.computed(function(){if(this.buttonOn){return"btn active"}else{return"btn"}}).property("buttonOn"),didInsertElement:function(){$("#"+this.domElementId).attr("data-toggle","button")}});GliffyApp.PropertiesGradientButton=GliffyApp.PropertiesBootstrapToggleButton.extend({buttonOnBinding:Ember.Binding.oneWay("GliffyApp.contextualPropertiesController.overlayGradientOn"),domElementId:"gliffy-contextual-properties-gradient-button",click:function(e){GliffyApp.contextualPropertiesController.resetDialogControls();GliffyApp.contextualPropertiesController.updateShapeTabProperty("Gradient",!GliffyApp.overlayModel.gradientOn);_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:GliffyApp.overlayModel.gradientOn?"gradientOn":"gradientOff"});e.preventDefault()}});GliffyApp.PropertiesShadowButton=GliffyApp.PropertiesBootstrapToggleButton.extend({buttonOnBinding:Ember.Binding.oneWay("GliffyApp.overlayModel.shadowOn"),domElementId:"gliffy-contextual-properties-shadow-button",click:function(e){GliffyApp.contextualPropertiesController.resetDialogControls();GliffyApp.contextualPropertiesController.updateShapeTabProperty("DropShadow",!GliffyApp.overlayModel.shadowOn);_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:GliffyApp.overlayModel.shadowOn?"shadowOn":"shadowOff"});e.preventDefault()}})}());(function(){GliffyApp.AbstractMenuView=Ember.View.extend({__tooltipHideTimeout:null,__trackAndClose:function(e,elemClass,action,keepSelected,skipTextBlur){if(!e.isTrigger){_gliffy.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:action})}this.onMenuClick(e,elemClass,keepSelected,skipTextBlur)},onMenuClick:function(e,followUpClickId,keepSelected,skipTextBlur){if(skipTextBlur===undefined||skipTextBlur===false){$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text")}if(!keepSelected){if(e.deselect===undefined||e.deselect!==false){GliffyApp.toolbarController.doDeselectAll()}}e.preventDefault();if(followUpClickId){$("#"+followUpClickId).click()}}})}());(function(){GliffyApp.ToolbarView=GliffyApp.AbstractMenuView.extend({__tooltipHideTimeout:null,zoomBinding:Ember.Binding.oneWay("GliffyApp.documentModel.zoom"),zoomPercent:Ember.computed(function(){return Math.round(this.zoom*100)+"%"}).property("zoom"),didInsertElement:function(){var self=this,setButtonState,setButtonStateEvents;$(".gliffy-tools .btn").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-anchor-exit").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-anchor-exit").on("click",function(e){self.__tooltipHideTimeout=setTimeout(function(){$("#gliffy-anchor-exit").tooltip("hide")},1000)});$(".gliffy-toolbar .gliffy-filemenu").on("click",function(e){$(".gliffy-filemenu-import .qq-upload-button").removeClass("qq-upload-button-focus");$(".gliffy-filemenu-import .gliffy-file-upload-button").trigger("mouseleave")});if(_gliffy.Debug.SHOW_MOUSE_COORDS){setInterval(function(){var mousePos=_gliffy.Mouse.getPosition();$("#gliffy-debug-box").html("("+mousePos.x+", "+mousePos.y+")")},16)}setButtonState=function(node){if(node&&(node.supportsIcon()||node.isText()||$("#gliffy-edit-text_ifr").is(":visible"))){$("#gliffy-button-link").attr("data-toggle","modal");$("#gliffy-button-link").removeClass("disabled")}else{$("#gliffy-button-link").attr("data-toggle","");$("#gliffy-button-link").addClass("disabled")}};$("#gliffy-button-link").addClass("disabled");setButtonStateEvents=["gliffy-overlay-set-selected-node","gliffy-overlay-manager-deselect-all","gliffy-draw-swap-proxy"].join(" ");$(window).on(setButtonStateEvents,function(event,node){setButtonState(node)});$(window).on("rte-add.gliffy-edit-text",function(ev,options){setButtonState(ev.node)});$(".gliffy-toolbar .gliffy-draw-tools button").on("click",function(e){self.onMenuClick(e);if(!e.isTrigger){_gliffy.Utils.analyticsEvent("trackEvent",{category:"drawModeClick",action:e.currentTarget.value})}});Ember.View.views["gliffy-node-tools"].pushObject(GliffyApp.StyleCopyView.create());$(".gliffy-tools .btn i").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$(".gliffy-zoom-tools .dropdown-menu li a").on("click",function(e){if(!e.isTrigger){_gliffy.Utils.analyticsEvent("trackEvent",{category:"toolbarClick",action:"zoomSelect"})}self.onMenuClick(e,"gliffy-toolbar-zoom-text",false)});$("#gliffy-toolbar-button-zoomIn").on("click",function(e){self.__trackeEventAndBlurText(e,"zoomIn")});$("#gliffy-toolbar-button-zoomOut").on("click",function(e){self.__trackeEventAndBlurText(e,"zoomOut")});$("#gliffy-button-undo").on("click",function(e){e.preventDefault();if(!e.isTrigger){_gliffy.Utils.analyticsEvent("trackEvent",{category:"toolbarClick",action:"undo"})}GliffyApp.toolbarController.doUndo()});$("#gliffy-button-redo").on("click",function(e){if(!e.isTrigger){_gliffy.Utils.analyticsEvent("trackEvent",{category:"toolbarClick",action:"redo"})}GliffyApp.toolbarController.doRedo()});$("#gliffy-button-group").on("click",function(e){self.__trackeEventAndBlurText(e,"group");GliffyApp.toolbarController.doGroup()});$("#gliffy-button-ungroup").on("click",function(e){self.__trackeEventAndBlurText(e,"ungroup");GliffyApp.toolbarController.doUnGroup()});$(".gliffy-toolbar-btns").on("click","#gliffy-button-toFront",function(e){self.__trackeEventAndBlurText(e,"bringToFront");GliffyApp.toolbarController.doBringToFront()});$(".gliffy-toolbar-btns").on("click","#gliffy-button-toBack",function(e){self.__trackeEventAndBlurText(e,"sendToBack");GliffyApp.toolbarController.doSendToBack()});$("#gliffy-toolbar-button-drawing-guides").on("click",function(e){var currentlyActive=$(e.currentTarget).hasClass("active");self.__trackeEventAndBlurText(e,(currentlyActive?"drawingGuidesOff":"drawingGuidesOn"));GliffyApp.toolbarController.toggleDrawingGuides(!currentlyActive)});$("#gliffy-toolbar-button-snap-to-grid").on("click",function(e){var currentlyActive=$(e.currentTarget).hasClass("active");self.__trackeEventAndBlurText(e,(currentlyActive?"snapToGridOff":"snapToGridOn"));GliffyApp.toolbarController.toggleSnapToGrid(!currentlyActive)});$("#gliffy-toolbar-button-show-grid").on("click",function(e){var currentlyActive=$(e.currentTarget).hasClass("active");self.__trackeEventAndBlurText(e,(currentlyActive?"showGridOff":"showGridOn"));GliffyApp.toolbarController.toggleShowGrid(!currentlyActive)});$("#gliffy-toolbar-button-themes").on("click",function(e){var currentlyActive=$(e.currentTarget).hasClass("active");$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");GliffyApp.toolbarController.toggleThemes(!currentlyActive)});$("#gliffy-toolbar-button-layers").on("click",function(e){var currentlyActive=$(e.currentTarget).hasClass("active");$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");GliffyApp.toolbarController.toggleLayers(!currentlyActive)})},__trackeEventAndBlurText:function(e,action){if(!e.isTrigger){_gliffy.Utils.analyticsEvent("trackEvent",{category:"toolbarClick",action:action})}$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text")},navigatorClick:function(e){var currentlyActive=$(e.currentTarget).hasClass("active");_gliffy.Utils.analyticsEvent("trackEvent",{category:"toolbarClick",action:(currentlyActive?"navigatorOff":"navigatorOn")});$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");GliffyApp.toolbarController.togglePageNavigator(!currentlyActive)}})}());(function(){GliffyApp.FileMenuView=GliffyApp.AbstractMenuView.extend({didInsertElement:function(){var self=this;$(".gliffy-filemenu-import .gliffy-file-upload-button").on("mouseenter",function(){$(this).css("background-color","#E4EAF2")});$(".gliffy-filemenu-import .gliffy-file-upload-button").on("mouseleave",function(){$(this).css("background-color","#FFFFFF")});GliffyApp.documentModel.addObserver("currentRevision",function(){if(GliffyApp.documentModel.currentRevision>0){$(".gliffy-filemenu-revisionhistory").show()}else{$(".gliffy-filemenu-revisionhistory").hide()}});$(".gliffy-filemenu-new a").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-file","new")});$(".gliffy-filemenu-open a").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-file","open")});$(".gliffy-filemenu-menuSave a").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-file","save")});$(".gliffy-filemenu-saveAs a").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-file","saveAs")});$(".gliffy-filemenu-rename a").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-file","rename")});$(".gliffy-filemenu-saveAndClose a").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-file","saveAndClose")});$(".gliffy-filemenu-close a").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-file","close")});$(".gliffy-filemenu-export a").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-file","export")});$("#gliffy-filemenu-print").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-file","print")})},menuImport:function(e){if(!e.isTrigger){_gliffy.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:"import"})}this.onMenuClick(e,"gliffy-toolbar-menu-file",false);$(".gliffy-filemenu-import .gliffy-file-upload-button").trigger("mouseleave")}})}());(function(){GliffyApp.EditMenuView=GliffyApp.AbstractMenuView.extend({didInsertElement:function(){var self=this;$(".gliffy-editmenu-undo").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-edit","undo",true,true)});$(".gliffy-editmenu-redo").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-edit","redo",true,true)});$(".gliffy-editmenu-selectAll").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-edit","selectAll",true)});$(".gliffy-editmenu-group").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-edit","group",true)});$(".gliffy-editmenu-ungroup").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-edit","ungroup",true)});$(".gliffy-editmenu-copy").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-edit","copy",true)});$(".gliffy-editmenu-cut").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-edit","cut",true)});$(".gliffy-editmenu-paste").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-edit","paste",true)});$(".gliffy-editmenu-delete").on("click",function(e){self.__trackAndClose(e,"gliffy-toolbar-menu-edit","delete",true)})}})}());(function(){GliffyApp.HelpMenuView=GliffyApp.AbstractMenuView.extend({didInsertElement:function(){$(".gliffy-help-menu-link-user-manual").on("click",function(){GLIFFY.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:"helpUserManual"})});$(".gliffy-help-menu-link-user-newsletter").on("click",function(){GLIFFY.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:"helpNewsletter"})});$(".gliffy-help-menu-link-about-us").on("click",function(){GLIFFY.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:"helpAboutUs"})});$(".gliffy-help-menu-link-shape-shortcuts").on("click",function(){GLIFFY.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:"helpShapeShortcuts"})});$(".gliffy-help-menu-link-document-shortcuts").on("click",function(){GLIFFY.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:"helpDocumentShortcuts"})});$(".gliffy-help-menu-link-mindmap-shortcuts").on("click",function(){GLIFFY.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:"helpMindmapShortcuts"})});$(".gliffy-help-menu-link-eula").on("click",function(){GLIFFY.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:"helpEULA"})});$(".gliffy-help-menu-link-search-support").on("click",function(){GLIFFY.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:"helpSearchSupport"})});$(".gliffy-help-menu-link-create-ticket").on("click",function(){GLIFFY.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:"helpCreateTicket"})});$(".gliffy-navbar-helpmenu-tips").on("click",function(e){e.preventDefault();if(!e.isTrigger){GLIFFY.Utils.analyticsEvent("trackEvent",{category:"menuClick",action:"tips"})}})},showMindmaps:Ember.computed(function(){return _gliffy.FEATURES.mindmaps}).property()})}());GliffyApp.DocumentTabsView=Ember.View.extend({});(function(){GliffyApp.RevisionHistoryView=Ember.View.extend({currentBaseRevisionBinding:Ember.Binding.oneWay("GliffyApp.revisionHistoryController.currentBaseRevision"),currentMaxRevisionBinding:Ember.Binding.oneWay("GliffyApp.revisionHistoryController.currentMaxRevision"),numRevisionsBinding:Ember.Binding.oneWay("GliffyApp.revisionHistoryController.numRevisions"),imageSizeLargeClass:Ember.Binding.oneWay("GliffyApp.revisionHistoryController.imageSizeLargeClass"),didInsertElement:function(){$(".modal-body").on("mouseover","#gliffy-revision-thumbnail-container",function(){$("#gliffy-revision-history-preview-icon").show()});$(".modal-body").on("mouseout","#gliffy-revision-thumbnail-container",function(){$("#gliffy-revision-history-preview-icon").hide()});$("#revision-history").on("click",".radio input",function(e){$("#revision-history .gliffy-btn-primary").attr("disabled",false);GliffyApp.revisionHistoryController.revisionClick($(e.currentTarget).data("gliffy-revision-version"))})}})}());(function(){GliffyApp.ColorpickerView=Ember.View.extend({didInsertElement:function(){$(".gliffy-colorswatchpicker button").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$(".gliffy-colorswatchpicker").mousedown(function(e){return false});$(".gliffy-colorswatchpicker .swatch").click(function(e){GliffyApp.colorpickerController.handleSwatchClick(e)});$(".gliffy-colorswatchpicker .gliffy-nofill").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD)}})}());(function(){GliffyApp.TipsView=Ember.View.extend({didInsertElement:function(){}})}());(function(){GliffyApp.SaveDialogView=Ember.View.extend({didInsertElement:function(){$("#saveDialog").find("form").submit(function(event){event.preventDefault();GliffyApp.saveDialogController.applySave()});$("#saveDialog").find(".gliffy-save-dialog-button").click(function(event){event.preventDefault();GliffyApp.saveDialogController.applySave()});$("#saveDialog").find(".gliffy-save-dialog-cancel-button").click(function(event){GliffyApp.saveDialogController.cancelSave()})}})}());(function(){GliffyApp.ThemeView=Ember.View.extend({_draggingDialog:false,_themes:null,didInsertElement:function(){var self=this;GliffyApp.themeController.setOnShow(function(){var documentManager=GliffyApp.themeController.__editor.getDocumentManager(),activeTheme=documentManager.getActiveStage().themeData;$("#gliffy-theme-title-bar").html($.i18n._("THEMES_TITLE"));try{if(activeTheme&&activeTheme.uid){$(".gliffy-theme-item").each(function(index){if($(this).data("gliffy-theme-data")&&($(this).data("gliffy-theme-data").uid===activeTheme.uid)){$(this).addClass("active")}else{$(this).removeClass("active")}})}else{$(".gliffy-theme-item").each(function(index){$(this).removeClass("active")})}}catch(e){}});$("#gliffy-theme-undo-tooltip").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-theme-dialog").jqm({modal:false,onHide:GliffyApp.themeController.closeDialog,overlay:0,overlayClass:"whiteOverlay"});$(".gliffy-theme-dragarea").bind("drag",function(event,dd){GliffyApp.themeController.handleDrag(event,dd)}).bind("dragstart",function(event,dd){self._draggingDialog=true}).bind("dragend",function(event,dd){self._draggingDialog=false});$("#gliffy-theme-dialog .jqmClose").bind("click",function(event){GliffyApp.themeController.hideDialog()});var themes=[{uid:"com.gliffy.theme.daily_glyph",name:"The Daily Glyph",shape:{primary:{strokeWidth:2,strokeColor:"#333333",fillColor:"#EEEEEE",gradient:false,dropShadow:false,opacity:1,text:{color:"#000000",bold:null,italic:null,underline:null}},secondary:{strokeWidth:2,strokeColor:"#666666",fillColor:"#FFFFFF",gradient:false,dropShadow:false,opacity:1,text:{color:"#000000",bold:null,italic:null,underline:null}},tertiary:{strokeWidth:2,strokeColor:"#333333",fillColor:"#CCCCCC",gradient:false,dropShadow:false,opacity:1,text:{color:"#000000",bold:null,italic:null,underline:null}},highlight:{strokeWidth:2,strokeColor:"#333333",fillColor:"#333333",gradient:false,dropShadow:false,opacity:1,text:{color:"#FFFFFF",bold:null,italic:null,underline:null}}},line:{strokeWidth:2,strokeColor:"#333333",fillColor:"none",arrowType:2,interpolationType:"linear",cornerRadius:0,text:{color:"#000000",bold:null,italic:null,underline:null}},text:{color:"#000000",bold:null,italic:null,underline:null},stage:{color:null}},{uid:"com.gliffy.theme.blueprint",name:"Blueprint",shape:{primary:{strokeWidth:2,strokeColor:"#0B599F",fillColor:"#DDE6F1",gradient:false,dropShadow:false,opacity:1,text:{color:"#08233F",bold:null,italic:null,underline:null}},secondary:{strokeWidth:2,strokeColor:"#08233F",fillColor:"#424D76",gradient:false,dropShadow:false,opacity:1,text:{color:"#FFFFFF",bold:null,italic:null,underline:null}},tertiary:{strokeWidth:2,strokeColor:"#0B599F",fillColor:"#FFFFFF",gradient:false,dropShadow:false,opacity:1,text:{color:"#08233F",bold:null,italic:null,underline:null}},highlight:{strokeWidth:2,strokeColor:"#0B599F",fillColor:"#0B599F",gradient:false,dropShadow:false,opacity:1,text:{color:"#ffffff",bold:null,italic:null,underline:null}}},line:{strokeWidth:2,strokeColor:"#0B599F",fillColor:"none",arrowType:2,interpolationType:"linear",cornerRadius:0,text:{color:"#08233F",bold:null,italic:null,underline:null}},text:{color:"#08233F",bold:null,italic:null,underline:null},stage:{color:"#FFFFFF"}},{uid:"com.gliffy.theme.cloudy_day",name:"Cloudy Day",shape:{primary:{strokeWidth:2,strokeColor:"#7F9EAD",fillColor:"#CBD8DE",gradient:false,dropShadow:false,opacity:1,text:{color:"#000000",bold:null,italic:null,underline:null}},secondary:{strokeWidth:2,strokeColor:"#555555",fillColor:"#EEEEEE",gradient:false,dropShadow:false,opacity:1,text:{color:"#000000",bold:null,italic:null,underline:null}},tertiary:{strokeWidth:2,strokeColor:"#7E725A",fillColor:"#CCC7BD",gradient:false,dropShadow:false,opacity:1,text:{color:"#000000",bold:null,italic:null,underline:null}},highlight:{strokeWidth:2,strokeColor:"#314047",fillColor:"#4A5F68",gradient:false,dropShadow:false,opacity:1,text:{color:"#ffffff",bold:null,italic:null,underline:null}}},line:{strokeWidth:2,strokeColor:"#4A5F68",fillColor:"none",arrowType:2,interpolationType:"quadratic",cornerRadius:0,text:{color:"#000000",bold:null,italic:null,underline:null}},text:{color:"#252F34",bold:null,italic:null,underline:null},stage:{color:"#FFFFFF"}},{uid:"com.gliffy.theme.eggplant_casserole",name:"Eggplant Casserole",shape:{primary:{strokeWidth:2,strokeColor:"#60327C",fillColor:"#DFD7E5",gradient:false,dropShadow:false,opacity:1,text:{color:"#432657",bold:null,italic:null,underline:null}},secondary:{strokeWidth:2,strokeColor:"#377c32",fillColor:"#D7E4D6",gradient:false,dropShadow:false,opacity:1,text:{color:"#235522",bold:null,italic:null,underline:null}},tertiary:{strokeWidth:2,strokeColor:"#7c5d32",fillColor:"#E6DFD6",gradient:false,dropShadow:false,opacity:1,text:{color:"#3E2D17",bold:null,italic:null,underline:null}},highlight:{strokeWidth:2,strokeColor:"#60327C",fillColor:"#60327C",gradient:false,dropShadow:false,opacity:1,text:{color:"#DFD7E5",bold:null,italic:null,underline:null}}},line:{strokeWidth:2,strokeColor:"#60327C",fillColor:"none",arrowType:2,interpolationType:"quadratic",cornerRadius:0,text:{color:"#432657",bold:null,italic:null,underline:null}},text:{color:"#432657",bold:null,italic:null,underline:null},stage:{color:null}},{uid:"com.gliffy.theme.technorama",name:"Technorama",shape:{primary:{strokeWidth:2,strokeColor:"#0E75AB",fillColor:"#0099CC",gradient:false,dropShadow:false,opacity:1,text:{color:"#FFFFFF",bold:null,italic:null,underline:null}},secondary:{strokeWidth:2,strokeColor:"#AAAAAA",fillColor:"#EEEEEE",gradient:false,dropShadow:false,opacity:1,text:{color:"#000000",bold:null,italic:null,underline:null}},tertiary:{strokeWidth:2,strokeColor:"#B5BF5E",fillColor:"#EEF19F",gradient:false,dropShadow:false,opacity:1,text:{color:"#1A1B11",bold:null,italic:null,underline:null}},highlight:{strokeWidth:2,strokeColor:"#90B328",fillColor:"#C6DD58",gradient:false,dropShadow:false,opacity:1,text:{color:"#1C210C",bold:null,italic:null,underline:null}}},line:{strokeWidth:2,strokeColor:"#0E75AB",fillColor:"none",arrowType:2,interpolationType:"quadratic",cornerRadius:0,text:{color:"#071E2D",bold:null,italic:null,underline:null}},text:{color:"#071E2D",bold:null,italic:null,underline:null},stage:{color:"#FFFFFF"}},{uid:"com.gliffy.theme.business_casual",name:"Business Casual",shape:{primary:{strokeWidth:2,strokeColor:"#2A5666",fillColor:"#4B8598",gradient:false,dropShadow:false,opacity:1,text:{color:"#FFFFFF",bold:null,italic:null,underline:null}},secondary:{strokeWidth:2,strokeColor:"#58483B",fillColor:"#867160",gradient:false,dropShadow:false,opacity:1,text:{color:"#FFFFFF",bold:null,italic:null,underline:null}},tertiary:{strokeWidth:2,strokeColor:"#B2B973",fillColor:"#D1D693",gradient:false,dropShadow:false,opacity:1,text:{color:"#000000",bold:true,italic:null,underline:null}},highlight:{strokeWidth:2,strokeColor:"#6F1C03",fillColor:"#9D3100",gradient:false,dropShadow:false,opacity:1,text:{color:"#FFFFFF",bold:null,italic:null,underline:null}}},line:{strokeWidth:2,strokeColor:"#2A5666",fillColor:"none",arrowType:2,interpolationType:"linear",cornerRadius:10,text:{color:"#332714",bold:null,italic:null,underline:null}},text:{color:"#332714",bold:null,italic:null,underline:null},stage:{color:"#FFFFFF"}},{uid:"com.gliffy.theme.beach_day",name:"Beach Day",shape:{primary:{strokeWidth:2,strokeColor:"#00A4DA",fillColor:"#AEE4F4",gradient:false,dropShadow:false,opacity:1,text:{color:"#004257",bold:null,italic:null,underline:null}},secondary:{strokeWidth:2,strokeColor:"#CDB25E",fillColor:"#EACF81",gradient:false,dropShadow:false,opacity:1,text:{color:"#332D1A",bold:null,italic:null,underline:null}},tertiary:{strokeWidth:2,strokeColor:"#FFBE00",fillColor:"#FFF1CB",gradient:false,dropShadow:false,opacity:1,text:{color:"#000000",bold:null,italic:null,underline:null}},highlight:{strokeWidth:2,strokeColor:"#00A4DA",fillColor:"#00A4DA",gradient:false,dropShadow:false,opacity:1,text:{color:"#ffffff",bold:null,italic:null,underline:null}}},line:{strokeWidth:2,strokeColor:"#00A4DA",fillColor:"none",arrowType:2,interpolationType:"quadratic",cornerRadius:0,text:{color:"#002248",bold:null,italic:null,underline:null}},text:{color:"#002248",bold:null,italic:null,underline:null},stage:{color:"#FFFFFF"}},{uid:"com.gliffy.theme.spring_green",name:"Spring Green",shape:{primary:{strokeWidth:2,strokeColor:"#418104",fillColor:"#6BAF21",gradient:false,dropShadow:false,opacity:1,text:{color:"#FFFFFF",bold:null,italic:null,underline:null}},secondary:{strokeWidth:2,strokeColor:"#3971B4",fillColor:"#589AD7",gradient:false,dropShadow:false,opacity:1,text:{color:"#FFFFFF",bold:null,italic:null,underline:null}},tertiary:{strokeWidth:2,strokeColor:"#624025",fillColor:"#91643C",gradient:false,dropShadow:false,opacity:1,text:{color:"#FFFFFF",bold:null,italic:null,underline:null}},highlight:{strokeWidth:2,strokeColor:"#D27023",fillColor:"#E88C3D",gradient:false,dropShadow:false,opacity:1,text:{color:"#FFFFFF",bold:null,italic:null,underline:null}}},line:{strokeWidth:2,strokeColor:"#418104",fillColor:"none",arrowType:2,interpolationType:"linear",cornerRadius:10,text:{color:"#2F3A1C",bold:null,italic:null,underline:null}},text:{color:"#2F3A1C",bold:null,italic:null,underline:null},stage:{color:"#FFFFFF"}},{uid:"com.gliffy.theme.blue_sweater",name:"Blue Sweater",shape:{primary:{strokeWidth:2,strokeColor:"#003068",fillColor:"#CCD5E1",gradient:false,dropShadow:false,opacity:1,text:{color:"#010B14",bold:null,italic:null,underline:null}},secondary:{strokeWidth:2,strokeColor:"#006800",fillColor:"#CCE0CC",gradient:false,dropShadow:false,opacity:1,text:{color:"#031C00",bold:null,italic:null,underline:null}},tertiary:{strokeWidth:2,strokeColor:"#6A3C00",fillColor:"#E2D8CC",gradient:false,dropShadow:false,opacity:1,text:{color:"#1B1000",bold:null,italic:null,underline:null}},highlight:{strokeWidth:2,strokeColor:"#003068",fillColor:"#003068",gradient:false,dropShadow:false,opacity:1,text:{color:"#FFFFFF",bold:null,italic:null,underline:null}}},line:{strokeWidth:2,strokeColor:"#003068",fillColor:"none",arrowType:2,interpolationType:"quadratic",cornerRadius:0,text:{color:"#010B14",bold:null,italic:null,underline:null}},text:{color:"#010B14",bold:null,italic:null,underline:null},stage:{color:"#FFFFFF"}},{uid:"com.gliffy.theme.earthy",name:"Earthy",shape:{primary:{strokeWidth:2,strokeColor:"#422000",fillColor:"#DAD2CC",gradient:false,dropShadow:false,opacity:1,text:{color:"#2E1600",bold:null,italic:null,underline:null}},secondary:{strokeWidth:2,strokeColor:"#0D3E00",fillColor:"#CFD8CC",gradient:false,dropShadow:false,opacity:1,text:{color:"#092C00",bold:null,italic:null,underline:null}},tertiary:{strokeWidth:2,strokeColor:"#004C67",fillColor:"#CBDBE0",gradient:false,dropShadow:false,opacity:1,text:{color:"#003547",bold:null,italic:null,underline:null}},highlight:{strokeWidth:2,strokeColor:"#024100",fillColor:"#16530E",gradient:false,dropShadow:false,opacity:1,text:{color:"#DCE9D8",bold:null,italic:null,underline:null}}},line:{strokeWidth:2,strokeColor:"#3D1F28",fillColor:"none",arrowType:2,interpolationType:"linear",cornerRadius:10,text:{color:"#2E1600",bold:null,italic:null,underline:null}},text:{color:"#2A0002",bold:null,italic:null,underline:null},stage:{color:"#FFFFFF"}},{uid:"com.gliffy.theme.rosy",name:"Rosy",shape:{primary:{strokeWidth:2,strokeColor:"#231218",fillColor:"#72404D",gradient:false,dropShadow:false,opacity:1,text:{color:"#FFFFFF",bold:null,italic:null,underline:null}},secondary:{strokeWidth:2,strokeColor:"#A5817F",fillColor:"#CBA7A6",gradient:false,dropShadow:false,opacity:1,text:{color:"#161110",bold:null,italic:null,underline:null}},tertiary:{strokeWidth:2,strokeColor:"#C0AE9A",fillColor:"#DAC9B7",gradient:false,dropShadow:false,opacity:1,text:{color:"#100E0B",bold:null,italic:null,underline:null}},highlight:{strokeWidth:2,strokeColor:"#231218",fillColor:"#9DAC95",gradient:false,dropShadow:false,opacity:1,text:{color:"#272B25",bold:null,italic:null,underline:null}}},line:{strokeWidth:2,strokeColor:"#231218",fillColor:"none",arrowType:2,interpolationType:"linear",cornerRadius:10,text:{color:"#000000",bold:null,italic:null,underline:null}},text:{color:"#000000",bold:null,italic:null,underline:null},stage:{color:"#FFFFFF"}},{uid:"com.gliffy.theme.goldfish",name:"Goldfish",shape:{primary:{strokeWidth:2,strokeColor:"#DA8707",fillColor:"#FCD186",gradient:false,dropShadow:false,opacity:1,text:{color:"#312101",bold:null,italic:null,underline:null}},secondary:{strokeWidth:2,strokeColor:"#AA9B2E",fillColor:"#E6DB77",gradient:false,dropShadow:false,opacity:1,text:{color:"#2A2709",bold:null,italic:null,underline:null}},tertiary:{strokeWidth:2,strokeColor:"#3E6B3F",fillColor:"#70AE73",gradient:false,dropShadow:false,opacity:1,text:{color:"#FFFFFF",bold:null,italic:null,underline:null}},highlight:{strokeWidth:2,strokeColor:"#0B5B61",fillColor:"#008D95",gradient:false,dropShadow:false,opacity:1,text:{color:"#FFFFFF",bold:null,italic:null,underline:null}}},line:{strokeWidth:2,strokeColor:"#DA8707",fillColor:"none",arrowType:2,interpolationType:"linear",cornerRadius:10,text:{color:"#312101",bold:null,italic:null,underline:null}},text:{color:"#312101",bold:null,italic:null,underline:null},stage:{color:"#FFFFFF"}}];this._themes=themes;setTimeout(function(){self.createThemes(themes)},1)},applyThemeToNode:function(node,themeData,skipText){var shapeInfo,themeType,line,uid,text,childGraphic;if(!node.getLayerLocked()){if(node.isShape()){shapeInfo=node.getShapeInformation();themeType=(shapeInfo&&shapeInfo.defaults&&shapeInfo.defaults.themeType)?shapeInfo.defaults.themeType:null;if(themeType&&themeData.shape[themeType]){node.getGraphic().fromObject(themeData.shape[themeType]);if(node.isMultipartShape()){_.each(node.children,function(childNode){childGraphic=childNode.getGraphic();if(childGraphic){childGraphic.fromObject(themeData.shape[themeType])}})}}}else{if(node.isLine()){line=node.getGraphic();uid=node.getUid();if(!(uid&&uid.substring(0,20)==="com.gliffy.shape.uml")&&!(uid.substring(0,20)==="com.gliffy.shape.erd")&&!(uid.substring(0,21)==="com.gliffy.shape.bpmn")){if(line.getStartArrow()!==0){line.setStartArrow(themeData.line.arrowType)}if(line.getEndArrow()!==0){line.setEndArrow(themeData.line.arrowType)}}node.getGraphic().fromObject(themeData.line)}else{if(!skipText&&node.isText()){text=node.getGraphic();if(node.isTextChild()){if(node.parent.isLine()){text.editable.applyTheme(themeData.line.text)}else{if(node.parent.isShape()){shapeInfo=node.parent.getShapeInformation();themeType=(shapeInfo&&shapeInfo.defaults&&shapeInfo.defaults.themeType)?shapeInfo.defaults.themeType:null;if(themeType&&themeData.shape[themeType]&&themeData.shape[themeType].text){text.editable.applyTheme(themeData.shape[themeType].text)}}}}else{text.editable.applyTheme(themeData.text)}}}}}},__createTextHideStyles:function(themeData){var scrollTop=$("#gliffy-theme-area")[0].scrollTop;if($("#gliffy-text-preview-stylesheet").length===0){$("head").append('<style type="text/css" id="gliffy-text-preview-stylesheet"/>')}$("#gliffy-text-preview-stylesheet").html(".gliffy-text span[style]{display:none}");if(_gliffy.BrowserDetect.browser==="Explorer"){$("#gliffy-theme-area")[0].scrollTop=scrollTop}},__createTextPreviewStyles:function(themeData){var scrollTop=$("#gliffy-theme-area")[0].scrollTop;if($("#gliffy-text-preview-stylesheet").length===0){$("head").append('<style type="text/css" id="gliffy-text-preview-stylesheet"/>')}var styleSheet=$("#gliffy-text-preview-stylesheet");var contents="";if(themeData.line.text.color){contents+=".gliffy-text-with-line-parent:not(.gliffy-locked-layer) span[style]{color:"+themeData.line.text.color+" !important;}\n"}if(themeData.text.color){contents+=".gliffy-text-standalone:not(.gliffy-locked-layer) span[style]{color:"+themeData.text.color+" !important;}\n"}$.each(themeData.shape,function(key,value){contents+=".gliffy-text-with-shape-parent-"+key+":not(.gliffy-locked-layer) span[style]{color: "+value.text.color+" !important;}\n"});styleSheet.html(contents);if(_gliffy.BrowserDetect.browser==="Explorer"){$("#gliffy-theme-area")[0].scrollTop=scrollTop}},__removeTextPreviewStyles:function(){var scrollTop=$("#gliffy-theme-area")[0].scrollTop;$("#gliffy-text-preview-stylesheet").remove();if(_gliffy.BrowserDetect.browser==="Explorer"){$("#gliffy-theme-area")[0].scrollTop=scrollTop}},_cachedStage:null,createThemes:function(themes){var self=this,table=$("#gliffy-theme-area").append("<table />").find("table"),tr,i,td,item,themeData,previewImageClass;var activeTheme=GliffyApp.themeController.__editor.getDocumentManager().getActiveStage().themeData;for(i=0;i<themes.length;i++){themeData=themes[i];if(i%2===0){tr=$("<tr />");table.append(tr)}td=$("<td />");tr.append(td);previewImageClass="gliffy-icon-theme-"+themeData.uid.split("com.gliffy.theme.")[1].replace("_","-");item=$('<div class="gliffy-theme-item" />').data("gliffy-theme-data",themeData).data("gliffy-theme-index",i).addClass(previewImageClass);td.append(item)}var themeApplied=false;var reset=function(){if(!themeApplied){var documentManager=GliffyApp.themeController.__editor.getDocumentManager(),stage=documentManager.getActiveStage();$(this).removeClass("highlight");if(self._cachedStage){stage.fromObject(self._cachedStage);self._cachedStage=null}documentManager.redraw()}themeApplied=false;self.__removeTextPreviewStyles()};$("#gliffy-theme-area").hoverIntent(function(e){if(self._draggingDialog){return}var documentManager=GliffyApp.themeController.__editor.getDocumentManager(),stage=documentManager.getActiveStage()},function(e){if(self._draggingDialog){return}reset()});$(".gliffy-theme-item").hoverIntent(function(e){if(self._draggingDialog){return}if(!themeApplied){self.__createTextHideStyles(themeData);$(this).addClass("highlight");GliffyApp.themeController.__editor.overlayManager.deselectAll();$("#gliffy-edit-text").trigger("customblur.gliffy-edit-text");var themeData=$(this).data("gliffy-theme-data"),documentManager=GliffyApp.themeController.__editor.getDocumentManager(),stage=documentManager.getActiveStage();if(self._cachedStage===null){self._cachedStage=stage.toObject()}if(themeData.stage.color){stage.setBackground(themeData.stage.color)}stage.iterateNodes(function(node){node.update();if(_gliffy.Pick.isNodePartiallyInside(node,documentManager.getActiveStageViewPort())){self.applyThemeToNode(node,themeData,true)}});documentManager.redraw();self.__createTextPreviewStyles(themeData)}},function(e){if(self._draggingDialog){return}if(!themeApplied){var documentManager=GliffyApp.themeController.__editor.getDocumentManager(),stage=documentManager.getActiveStage();$(this).removeClass("highlight")}}).click(function(e){var documentManager=GliffyApp.themeController.__editor.getDocumentManager(),stage=documentManager.getActiveStage(),themeData=$(this).data("gliffy-theme-data");var scrollTop=$("#gliffy-theme-area")[0].scrollTop;_gliffy.Utils.analyticsEvent("trackEvent",{category:"themeSelect",action:themeData.name});$(".gliffy-theme-item").removeClass("active").removeClass("highlight");$(this).addClass("active");_gliffy.Spinner.show({context:"theme",noAnimate:true});themeApplied=true;if(_gliffy.BrowserDetect.browser==="Explorer"){$("#gliffy-theme-area")[0].scrollTop=scrollTop}setTimeout(function(){var nodeQueue=[];stage.iterateNodes(function(node){node.update();nodeQueue.push(node)});var interval=setInterval(function(){for(var i=0;i<3;i++){if(nodeQueue.length===0){clearInterval(interval);stage.themeData=themeData;stage.commandHistory.addAndExecuteCommand(new _gliffy.UpdateThemeCommand({stageObject:stage.toObject(),stageUndoObject:self._cachedStage}));self._cachedStage=null;self.__removeTextPreviewStyles();documentManager.redraw();reset();$("#gliffy-theme-undo-tooltip").tooltip("show");setTimeout(function(){$("#gliffy-theme-undo-tooltip").tooltip("hide")},3000);_gliffy.Spinner.hide({context:"theme"});return}else{var node=nodeQueue.pop();self.applyThemeToNode(node,themeData,false);if(_gliffy.BrowserDetect.browser==="Explorer"){$("#gliffy-theme-area")[0].scrollTop=scrollTop}}}},1)},30)})}})}());(function(){GliffyApp.LayersView=Ember.View.extend({name:"layer0",guid:null,editGuid:null,layerNameClickTime:null,didInsertElement:function(){var self=this;this.layerNameClickTime=new Date();GliffyApp.layersController.setOnShow(function(){$("#gliffy-layers-dialog").tooltip($.extend({},_gliffy.Editor.TOOLTIP_OPTIONS_QUICK,{selector:".gliffy-layer-tooltip"}))});$("#gliffy-layers-dialog").jqm({modal:false,onHide:GliffyApp.layersController.closeDialog,overlay:0,overlayClass:"whiteOverlay"});$(".gliffy-layers-dragarea").bind("drag",function(event,dd){GliffyApp.layersController.handleDrag(event,dd)});$("#gliffy-layers-dialog .jqmClose").bind("click",function(event){GliffyApp.layersController.hideDialog()});$(window).on("gliffy-overlay-set-selected-node gliffy-group-reorder",function(event,node){if(node){GliffyApp.layersController.setActiveByNode(node)}else{GliffyApp.layersController.setTopmostLayerActive()}});$("#gliffy-layers-area").on("keydown",".gliffy-layer-name-input",function(e){GliffyApp.layersController.handleInputKeyDown(e)})}})}());(function(){GliffyApp.LinkHudView=Ember.View.extend({attributeBindings:["data-href"],hrefBinding:Ember.Binding.oneWay("GliffyApp.linkHudController.href"),didInsertElement:function(){setTimeout(function(){_gliffy.Utils.moveEmberView($("#gliffy-link-hud-template"),$("#gliffy-link-hud"));$("#gliffy-link-hud").on("mousedown",function(e){e.stopPropagation()})},1)}})}());(function(){_gliffy.Slider=_gliffy.Class.extend({_sliderMarkup:'<div class="gliffy-slider"><div class="gliffy-initial-pos"></div><div class="gliffy-slider-handler" /></div>',_handle:null,_handle_width:null,_slider:null,_max:null,_min:null,_width:null,_reset_value:null,_reset_step:null,_reset_pos:null,target:null,value:null,init:function(o){var lastpos,self=this,options=$.extend({},{min:0,max:100,step:0,value:50,namespace:"gliffy.viewer.zoom",reset_step:2,reset_value:50,dragStartCallback:function(self){},dragEndCallback:function(self){},dragCallback:function(self,lastValue){}},o);if(!options.target){throw new Error("Slider must have a target container set")}this._max=options.max;this._min=options.min;this.value=options.reset_value;this._step=options.step;this._reset_value=options.reset_value;this._reset_step=options.reset_step;this.target=options.target;this._slider=$(this._sliderMarkup);this._handle=this._slider.find(".gliffy-slider-handler");options.target.append(this._slider);this._handle_width=this._handle.width();this._width=this._slider.width();this.moveHandle();this._reset_pos=this._slider.find(".gliffy-initial-pos");if(this._reset_step>0){this._reset_pos.css({left:this._handle.css("left")})}else{this._reset_pos.hide()}this.value=options.value;this.moveHandle();this.dragEvent="drag."+options.namespace;this.dragInitEvent="draginit."+options.namespace;this.dragEndEvent="dragend."+options.namespace;this.clickEvent="mousedown."+options.namespace;lastpos={x:this._handle.offset().left};this._handle.bind(this.dragInitEvent,{which:1},function(){lastpos={x:self._handle.offset().left};options.dragStartCallback(self)}).bind(this.dragEvent,{which:1},function(event){var lastValue=self.value,pos=lastpos;lastpos=self._updatePosition(event,lastpos);options.dragCallback(self,lastValue)}).bind(this.dragEndEvent,{which:1},function(event){lastpos=self._updatePosition(event,lastpos);options.dragEndCallback(self)}).mousedown(function(event){event.stopPropagation()});this._slider.bind(this.clickEvent,function(event){event.preventDefault();event.stopPropagation();var lastValue=self.value;lastpos=self._updatePosition(event,lastpos);options.dragStartCallback(self);options.dragCallback(self,lastValue);options.dragEndCallback(self)})},_updatePosition:function(event,lastpos){var xDiff=event.pageX-this._handle_width/2-lastpos.x,valueDiff=(this._max-this._min)*(xDiff/this._width),newValue=this.value+valueDiff;if(this._handle_width===0){this._handle_width=this._handle.width()}if(this._width===0){this._width=this._slider.width()}if(Math.abs(valueDiff)>this._step){if(newValue>(this._reset_value-this._reset_step)&&newValue<(this._reset_value+this._reset_step)){this.value=this._reset_value}else{if(newValue>this._max){this.value=this._max}else{if(newValue<this._min){this.value=this._min}else{this.value=newValue}}}this.moveHandle();return{x:this._handle.offset().left}}return lastpos},moveHandle:function(){var val=null;if(this.value>this._max||this.value===this._max){val="100%"}else{if(this.value<this._min||this.value===this._min){val=0}else{val=parseInt((this.value-this._min)/(this._max-this._min)*100,10)+"%"}}this._handle.css({left:val})},remove:function(){this._handle.unbind(this.dragInitEvent).unbind(this.dragEvent).unbind(this.dragEndEvent);this._slider.remove()}})}());(function(){_gliffy.Dialog={hide:function(){$("#alertDialog").modal("hide")},__bindButtonActions:function(button,footer){var $button,self=this,buttonTemplate;buttonTemplate={text:$.i18n._("DIALOG_OK"),callback:null,primary:true,dismiss:true,add_classes:[]};button=$.extend({},buttonTemplate,button);$button=$("<button />").addClass("btn").html(Handlebars.Utils.escapeExpression(button.text));if(button.primary){$button.addClass("gliffy-btn-primary")}if(button.add_classes&&button.add_classes.length>0){$button.addClass(button.add_classes.join(" "))}footer.append($button);$button.unbind("click.gliffy-dialog");if(button.callback&&button.callback!==undefined){$button.bind("click.gliffy-dialog",function(e){if(button.dismiss){self.hide()}button.callback($button[0]);e.preventDefault()})}else{if(button.dismiss){$button.bind("click.gliffy-dialog",function(e){self.hide();e.preventDefault()})}}$("#alertDialog").unbind("hide.gliffy-dialog");$("#alertDialog").bind("hide.gliffy-dialog",function(){$("a").trigger("mouseleave")})},hideDialog:function(){$("#alertDialog").modal("hide")},showGenericDialog:function(o){var i,buttonTemplate={text:$.i18n._("DIALOG_OK"),callback:null,primary:true,dismiss:true,add_classes:[]},$footer,options,self=this;options=$.extend({content:"",title:"",cancelCallback:null,buttons:[],escapeHTML:true,skipNodeDeselect:false,backdropStatic:false},o);if(options.backdropStatic){$("#alertDialog").attr("data-backdrop","static")}$("#alertDialog").data("skipNodeDeselect",options.skipNodeDeselect);$("#alertDialog").modal("show");$("#alertDialog .modal-header h4").html(options.escapeHTML?Handlebars.Utils.escapeExpression(options.title):options.title);$("#alertDialog .modal-body").html(options.escapeHTML?Handlebars.Utils.escapeExpression(options.content):options.content);$footer=$("#alertDialog .modal-footer");$footer.html("");if(!$.isArray(options.buttons)){options.buttons=[buttonTemplate]}for(i=0;i<options.buttons.length;i++){this.__bindButtonActions(options.buttons[i],$footer)}if(options.cancelCallback){$("#alertDialog .modal-header a").bind("click",options.cancelCallback)}},showAlertDialog:function(o){var options=$.extend({content:$.i18n._("DIALOG_AN_UNKNOWN_ERROR_HAS_OCCURRED"),title:$.i18n._("DIALOG_ALERT"),cancelCallback:null,buttons:[{text:$.i18n._("DIALOG_OK"),callback:null,primary:true,dismiss:true,add_classes:[]}]},o);_gliffy.Dialog.showGenericDialog(options)},showYesNoDialog:function(o){var options=$.extend({content:"",title:"",cancelCallback:null,buttons:[{text:$.i18n._("DIALOG_YES"),callback:null,primary:true,dismiss:true,add_classes:[]},{text:$.i18n._("DIALOG_NO"),callback:null,primary:false,dismiss:true,add_classes:[]}]},o);this.showGenericDialog(options)}}}());(function(){_gliffy.Spinner={__contexts:{},createSpinner:function(){var opts;opts={lines:7,length:7,width:6,radius:8,corners:1,rotate:0,direction:1,color:"#000",speed:1,trail:60,shadow:false,hwaccel:true,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"};return new Spinner(opts)},showSmallSpinner:function(target){var opts,spinner;opts={lines:7,length:5,width:4,radius:4,corners:1,rotate:46,color:"#000",speed:1.3,trail:34,shadow:false,hwaccel:true,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"};spinner=new Spinner(opts).spin(target.get(0))},showNodeSpinner:function(node){var opts,target,spinner;opts={lines:7,length:5,width:4,radius:4,corners:1,rotate:46,color:"#000",speed:1.3,trail:34,shadow:false,hwaccel:true,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"};target=$("<div/>",{"class":"gliffy-node-spinner"});target.css({width:50,height:50,marginTop:-10,marginLeft:-10});node.getDomViewbox().append(target);spinner=new Spinner(opts).spin(target.get(0))},hideNodeSpinner:function(node){node.getDomViewbox().find(".gliffy-node-spinner").remove()},isShown:function(o){var options=$.extend({},{context:"general"},o);return this.__contexts[options.context]},show:function(o){var options=$.extend({},{noAnimate:false},{context:"general"},o),$spinnerIcon=$(".gliffy-spinner-icon"),$spinnerBg=$(".gliffy-spinner-bg"),hadContexts=false;$.each(this.__contexts,function(key,val){hadContexts=true});this.__contexts[o.context]=true;if(!hadContexts){$spinnerIcon.stop();$spinnerBg.stop();$spinnerIcon.show();$spinnerBg.show();$spinnerIcon.css("opacity",1);$spinnerBg.css("opacity",0.5)}},hide:function(o){var options=$.extend({},{context:"general",force:false},o),$spinnerIcon=$(".gliffy-spinner-icon"),$spinnerBg=$(".gliffy-spinner-bg"),contextsRemain=false;delete this.__contexts[o.context];if(o.force){this.__contexts={}}$.each(this.__contexts,function(key,val){contextsRemain=true});if(!contextsRemain){$spinnerIcon.stop();$spinnerBg.stop();if(parseFloat($spinnerIcon.css("opacity"))>0.1){$spinnerIcon.animate({opacity:0},100,function(){$spinnerIcon.hide()})}else{$spinnerIcon.hide()}if(parseFloat($spinnerBg.css("opacity"))>0.1){$spinnerBg.animate({opacity:0},100,function(){$spinnerBg.hide()})}else{$spinnerBg.hide()}}},forceHide:function(){this.hide({force:true})}}}());var public_classes=["shapeLibrary","Viewer","EmbeddableViewer","Editor","Utils","IntegrationHandler","Components","Plugins","setErrorHandler","setI18nHandler","Logger","Class","AffineTransform","BrowserDetect","Popover","Dialog","Slider","Renderer","Spinner","FileHandlerRegister","DefaultFileHandler","CopyCommand","CutCommand","PasteCommand","BoundingBox","Node","FileHandlerUtils","FEATURES"],i=0;window.GLIFFY=window.GLIFFY||{};for(i=0;i<public_classes.length;i++){window.GLIFFY[public_classes[i]]=_gliffy[public_classes[i]]}_gliffy.NoDebug={SKIP_CATCH_ERRORS:false,SKIP_RENDER_LOOP:false,DISPLAY_GUIDES:false,NO_CONTEXT_MENU:false,NO_TIPS:false,NO_ERROR_DIALOG:false,FINITE_NUMBER_CHECKS:false,NO_NAVIGATE_WARNING:false,STARTUP_FILE:null,LOG_TO_CONSOLE:false,LOG_ANALYTICS:false,USE_ANALYTICS_DEBUG_JS:false,SHOW_MOUSE_COORDS:false,I18N_UNDERSCORES:false,SHOW_RTREE:false,LOCAL_SVG_EXPORT:false,POPUP_NOTE_POSITION:false,EXPORT_TEXT_DISPLAY:false,SHOW_LAYERS:false,POLL_LAYER_STATE:false};_gliffy.FullDebug={SKIP_CATCH_ERRORS:true,SKIP_RENDER_LOOP:false,DISPLAY_GUIDES:false,NO_CONTEXT_MENU:true,NO_TIPS:true,NO_ERROR_DIALOG:true,FINITE_NUMBER_CHECKS:true,NO_NAVIGATE_WARNING:true,STARTUP_FILE:null,LOG_TO_CONSOLE:true,LOG_ANALYTICS:false,USE_ANALYTICS_DEBUG_JS:false,SHOW_MOUSE_COORDS:true,I18N_UNDERSCORES:true,SHOW_RTREE:false,LOCAL_SVG_EXPORT:true,POPUP_NOTE_POSITION:false,EXPORT_TEXT_DISPLAY:false,SHOW_LAYERS:false,POLL_LAYER_STATE:false};_gliffy.Debug=_gliffy.NoDebug;if($.url().param("debug")==="true"){_gliffy.Debug=_gliffy.FullDebug}if($.url().param("debug_options")){_.each($.url().param("debug_options").split(","),function(option){_gliffy.Debug[option.toUpperCase()]=true})}(function(){_gliffy.Plugins.create({activate:function(editor){var self=this;GliffyApp.shapeLibraryController=GliffyApp.ShapeLibraryController.create({__editor:editor});GliffyApp.shapeLibraryModel=GliffyApp.ShapeLibraryModel.create({editor:editor,panels:[]});$(window).on("gliffy-shape-library-search-loaded",function(event,results){self.buildSearchPanel(editor,results)})},initTemplates:function(){var view=Ember.View.create({templateName:this.getTemplateNames()[0]});if(Ember.View.views["gliffy-sidebar"]){Ember.View.views["gliffy-sidebar"].pushObject(view)}},getTemplateNames:function(){return["shape-library"]},getName:function(){return"ShapeLibrary"},clearLibraryPanels:function(){var i,keys=Object.keys(GliffyApp.shapeLibraryModel.panelViewMap);for(i=0;i<keys.length;i++){GliffyApp.shapeLibraryModel.panelViewMap[keys[i]].remove();Ember.View.views["gliffy-symbol-library"].removeChild(GliffyApp.shapeLibraryModel.panelViewMap[keys[i]])}GliffyApp.shapeLibraryModel.panelViewMap={}},insertAtIndex:function(i){return function(){var children;if(i===0){this.$().prependTo($("#gliffy-symbol-library"))}else{children=$("#gliffy-symbol-library").children();if(children.length===i){this.$().appendTo($("#gliffy-symbol-library"))}else{$($("#gliffy-symbol-library").children().get(i)).before(this.$())}}}},addLibraryPanels:function(editor,panels){var i,view,showFirst=GliffyApp.shapeLibraryModel.get("showFirstPanel");for(i=0;i<panels.length;i++){view=this.buildPanelView(editor,panels[i],!showFirst||(showFirst&&i===0));if(view){GliffyApp.shapeLibraryModel.panelViewMap[panels[i]]=view;Ember.View.views["gliffy-symbol-library"].insertAt(i,view)}}GliffyApp.shapeLibraryModel.set("showFirstPanel",false);$(window).trigger("gliffy_addLibraryPanels")},updatePanel:function(editor,panel){var lastView=GliffyApp.shapeLibraryModel.panelViewMap[panel],index=GliffyApp.shapeLibraryModel.panels.indexOf(panel);if(index>-1){if(lastView){lastView.remove()}GliffyApp.shapeLibraryModel.panelViewMap[panel]=this.buildPanelView(editor,panel,true);GliffyApp.shapeLibraryModel.panelViewMap[panel]._insertElementLater(this.insertAtIndex(index))}},buildLibraryPanels:function(editor,panels){var i,library,validLibraries=[],view,viewsToAppend=[];for(i=0;i<panels.length;i++){view=this.buildPanelView(editor,panels[i],true);if(view){validLibraries.push(panels[i]);GliffyApp.shapeLibraryModel.panelViewMap[panels[i]]=view;viewsToAppend.push(view)}}if(validLibraries.length<panels.length){GliffyApp.shapeLibraryModel.set("panels",validLibraries)}else{$.each(viewsToAppend,function(_,view){Ember.View.views["gliffy-symbol-library"].pushObject(view)})}},buildPanelView:function(editor,panel,openOnInit){var library=_gliffy.shapeLibrary.libraries[panel],plugin;if(library){plugin=_gliffy.Plugins.getInstance(library.type);if(plugin&&plugin.createPanel){return plugin.createPanel(editor,library,openOnInit)}}return null},buildSearchPanel:function(editor,results){var view;view=this.buildSearchPanelView(editor,results);if(view){if(Ember.View.views["gliffy-shape-search-results"]){Ember.View.views["gliffy-shape-search-results"].clear();Ember.View.views["gliffy-shape-search-results"].pushObject(view)}}},buildSearchPanelView:function(editor,results){var plugin;if(results){plugin=_gliffy.Plugins.getInstance(results.type);if(plugin&&plugin.createPanel){return plugin.createPanel(editor,results,true)}}return null},onAllPluginsActivated:function(editor){GliffyApp.shapeLibraryModel.addObserver("panels",this,function(){var self=this,document,i,index,panel,panels;if(GliffyApp.shapeLibraryModel.override){if(GliffyApp.shapeLibraryModel.panels.length>0){$(".gliffy-sidebar-tip").hide();$(".gliffy-sidebar-loading").show();_gliffy.shapeLibrary.loadLibraries(GliffyApp.shapeLibraryModel.panels,editor.language).then(function(){self.clearLibraryPanels();self.buildLibraryPanels(editor,[].concat(GliffyApp.shapeLibraryModel.panels));$(".gliffy-sidebar-loading").hide()})}else{self.clearLibraryPanels();$(".gliffy-sidebar-loading").hide();$(".gliffy-sidebar-tip").show()}}else{if(GliffyApp.shapeLibraryModel.panelToRemove&&GliffyApp.shapeLibraryModel.panelViewMap[GliffyApp.shapeLibraryModel.panelToRemove]){GliffyApp.shapeLibraryModel.panelViewMap[GliffyApp.shapeLibraryModel.panelToRemove].remove();delete GliffyApp.shapeLibraryModel.panelViewMap[GliffyApp.shapeLibraryModel.panelToRemove];if(GliffyApp.shapeLibraryModel.panels.length===0){$(".gliffy-sidebar-tip").show()}}else{if(GliffyApp.shapeLibraryModel.panelToAdd){panel=[GliffyApp.shapeLibraryModel.panelToAdd];_gliffy.shapeLibrary.loadLibraries(panel,editor.language).then(function(){self.addLibraryPanels(editor,panel)});$(".gliffy-sidebar-tip").hide()}else{if(GliffyApp.shapeLibraryModel.panelsToAdd){panels=GliffyApp.shapeLibraryModel.panelsToAdd;_gliffy.shapeLibrary.loadLibraries(GliffyApp.shapeLibraryModel.panelsToAdd,editor.language).then(function(){self.addLibraryPanels(editor,panels)});$(".gliffy-sidebar-tip").hide()}else{if(GliffyApp.shapeLibraryModel.panelToUpdate){panel=GliffyApp.shapeLibraryModel.panelToUpdate;self.updatePanel(editor,panel)}}}}}if(!GliffyApp.shapeLibraryModel.override){document=editor.getDocumentManager().getActiveDocument();if(document){document.setLibrariesMetadata([].concat(GliffyApp.shapeLibraryModel.panels))}}GliffyApp.shapeLibraryModel.resetState()})}})}());(function(){GliffyApp.ShapeLibraryController=Ember.Object.extend({__editor:null,__loadedArray:null,__initialShapeLibraryClick:false,customLibraryDropRegister:null,premiumShapePopover:{title:"Premium Shapes",content:'<div>This shape is available to Business Accounts only.</div><div><a href="http://www.gliffy.com">Upgrade to get access</a></div>'},init:function(){this.__loadedArray=[];this.customLibraryDropRegister=new _gliffy.CustomLibraryDropRegister(this.__editor);if(!window.jasmine){this.registerMouseClickState();this.setupShapeLibrary();$(function(){if($.browser.webkit){$("body").on("mousedown",".gliffy-accordion-inner",function(e){var elems=_gliffy.KoreSampl.fromEvent(e,e.currentTarget);if(elems.length>0&&$(elems[0]).is("input")){return true}else{return false}})}if(typeof window.chrome==="object"){$("body").on("click",function(){$(".gliffy-dropdown-clone").remove()})}$("body").on("mouseenter",".gliffy-sidebar-shape",function(){$(this).addClass("gliffy-hover")}).on("mouseleave",".gliffy-sidebar-shape",function(){$(".gliffy-sidebar-shape.gliffy-hover").removeClass("gliffy-hover")});$("body").on("mousedown","#gliffy-sidebar .accordion-toggle,#gliffy-sidebar .gliffy-panel-remove,#gliffy-sidebar .accordion-heading",function(event){event.preventDefault()})})}},registerMouseClickState:function(){var self=this,INTERP_TIME=150,draggingOverStage=false,nodeDom=null,node,annotationRemoved,$dragThis,$this,shapeCopy,w,h,startedAutopan=false,delayAutopan=false,nodeBB,stageOffset,autoPan=new _gliffy.AutoPan({editor:this.__editor,callback:function(position){self.__updateNode($dragThis,node,position)}});_gliffy.Mouse.registerClickState({name:"shapeLibrary",modes:["library-drop","panel-drag"],target:".gliffy-sidebar-shape,.gliffy-shape-library-com-gliffy-shape-image,.gliffy-sidebar .gliffy-panel-move",mouseDown:function(event){$this=$(event.currentTarget);if($this.hasClass("gliffy-panel-move")&&!$this.hasClass("gliffy-panel-clone")){_gliffy.Mouse.setClickMode("shapeLibrary");_gliffy.Mouse.setState("panel-drag");_gliffy.Mouse.__mousedown(event)}else{if(!$this.hasClass("gliffy-shape-clone")){$(".gliffy-shape-clone").remove();_gliffy.Mouse.setClickMode("shapeLibrary");_gliffy.Mouse.setState("library-drop");_gliffy.Mouse.__mousedown(event)}}}});(new _gliffy.PanelDrag()).registerPanelDrag("panel-drag",".gliffy-sidebar",function(panel,panelIndex){GliffyApp.shapeLibraryModel.movePanel(panel.data("uid"),panelIndex)});_gliffy.Mouse.registerDragState([{modes:["library-drop"],dragStart:function(event){startedAutopan=false;$("#gliffy-edit-text").trigger("customblur");shapeCopy=$this.clone().addClass("gliffy-shape-clone");if(shapeCopy.find("canvas").length>0){shapeCopy.find("canvas").get(0).getContext("2d").drawImage($this.find("canvas").get(0),0,0)}w=shapeCopy.width();h=shapeCopy.height();shapeCopy.css({position:"absolute",left:event.pageX-w/2+"px",top:event.pageY-h/2+"px"});$("#gliffy").append(shapeCopy);draggingOverStage=false;nodeDom=null;$("#gliffy-toolbar-button-pointer").trigger({type:"click",deselect:false});_gliffy.Mouse.lockDragUI("move")},drag:function(event){var dragPoint,stageCoord=_gliffy.Mouse.getPosition(),domNode,nodeId,containerBounds,params;if(event&&shapeCopy){shapeCopy.css({left:event.pageX-w/2+"px",top:event.pageY-h/2+"px"});$dragThis=$this;self.__editor.overlayManager.overlay.isDragging=true;self.__editor.overlayManager.lineOverlay.isDragging=true;containerBounds=new _gliffy.BoundingBox(self.__editor.containerBounds.min.x,self.__editor.containerBounds.min.y,self.__editor.containerBounds.max.x+40,self.__editor.containerBounds.max.y+40);dragPoint=new _gliffy.Vec2(event.pageX+20,event.pageY+20);if(containerBounds.pointInside(dragPoint.x,dragPoint.y)){if(!draggingOverStage){shapeCopy.animate({opacity:0},INTERP_TIME);node=new _gliffy.Node();params=$dragThis.data("params");if(!params){params={uid:$dragThis.attr("data-uid"),tid:$dragThis.attr("data-tid")};$dragThis.data("params",params)}self.__editor.drawManager.setupShape(node,params,stageCoord);if(node.isLine()){self.__editor.overlayManager.lineOverlay.isNewlyCreatedLine=true;self.__editor.overlayManager.selectNode(node);self.__editor.overlayManager.lineOverlay.showConnectionPoints(false,true)}else{self.__editor.overlayManager.selectNode(node);if(node.isContainer()){self.__editor.getDocumentManager().getActiveStage().sendToBack(node)}self.__editor.overlayManager.overlay.cacheDrawingGuidesInView()}}else{stageOffset=_gliffy.Mouse.getStageOffset();nodeBB=new _gliffy.BoundingBox(node.worldAabb.min.x+stageOffset.left,node.worldAabb.min.y+stageOffset.top,node.worldAabb.max.x+stageOffset.left,node.worldAabb.max.y+stageOffset.top);if(!startedAutopan&&containerBounds.boundingBoxInside(nodeBB)){autoPan.start(event,stageCoord);startedAutopan=true;delayAutopan=true}else{if(startedAutopan){if(delayAutopan){setTimeout(function(){if(startedAutopan){autoPan.update(event,stageCoord)}delayAutopan=false},2000)}else{autoPan.update(event,stageCoord)}}}}if(node){if(!nodeDom){nodeDom=node.getDomElement();if(nodeDom){nodeDom.css("opacity","0.0");nodeDom.animate({opacity:1},INTERP_TIME)}if(node.supportsDrawingGuides()){self.__editor.overlayManager.overlay.cacheDrawingGuidesInView()}}self.__updateNode($dragThis,node,stageCoord)}draggingOverStage=true;self.__editor.overlayManager.quickConnectionOverlay.hide()}else{autoPan.stop();startedAutopan=false;if(draggingOverStage){shapeCopy.animate({opacity:1},INTERP_TIME);self.__editor.overlayManager.deselectAll();self.__editor.overlayManager.overlay.hideAllDrawingGuides();domNode=node.getDomElements();nodeId=node.getId();domNode.animate({opacity:"0.1"},INTERP_TIME,function(){var stage=self.__editor.getDocumentManager().getActiveStage(),removeNode=stage.find(nodeId);if(removeNode){annotationRemoved=removeNode.isAnnotation();self.__editor.getDocumentManager().addAndExecuteCommand(new _gliffy.RemoveNodeCommand({node:removeNode}));if(annotationRemoved){self.__editor.getDocumentManager().popCommandBundle()}self.__editor.getDocumentManager().redraw()}});GliffyApp.hudController.hide()}draggingOverStage=false;nodeDom=null;node=null}}},dragEnd:function(event){var customHandler,searchShapeBox;self.__editor.overlayManager.overlay.isDragging=false;self.__editor.overlayManager.lineOverlay.isDragging=false;autoPan.stop();startedAutopan=false;if(shapeCopy){shapeCopy.animate({left:$this.offset().left,top:$this.offset().top},INTERP_TIME,function(){shapeCopy.remove()})}if(draggingOverStage){_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeAdded",action:node.getUid()});if(node.getUid()&&node.getUid().indexOf("uml_v2")!==-1){self.__editor.getDocumentManager().getActiveDocument().getGon().setBetaVersion()}if(node&&node.isTable()){self.__editor.__documentManager.getActiveDocument().getGon().setBetaVersion()}searchShapeBox=$("#gliffy-shape-library-search-field");if(searchShapeBox.length>0){searchShapeBox.blur()}customHandler=self.customLibraryDropRegister.getCustomHandler(node);customHandler.afterDrop(node,$this)}draggingOverStage=false;GliffyApp.hudController.hide()}}])},setupShapeLibrary:function(){var self=this;$("body").on("show",".accordion-body",function(event){if(_gliffy.BrowserDetect.browser==="Firefox"){$(".accordion-body").not(".collapse").not(".in").addClass("collapse").collapse("hide")}var library=$(this);$("#gliffy-edit-text").trigger("customblur");$(".gliffy-sidebar a[href='#"+event.currentTarget.id+"']").addClass("opened")});$("body").on("hide",".accordion-body",function(event){$("#gliffy-edit-text").trigger("customblur");$(".gliffy-sidebar a[href='#"+event.currentTarget.id+"']").removeClass("opened")})},__updateNode:function($this,node,stageCoord){var nodeBB=null,imageWidth,imageHeight;if($this.data("params")&&$this.data("params").tid==="com.gliffy.stencil.line"){this.__editor.overlayManager.lineOverlay.isNewlyCreatedLine=true;node.setX(stageCoord.x);node.setY(stageCoord.y);node.update();this.__editor.overlayManager.lineOverlay.redraw()}else{if(node.getRotation()===0){this.__editor.overlayManager.overlay.setTrans(stageCoord.x,stageCoord.y,true)}else{nodeBB=node.worldAabb.clone();this.__editor.overlayManager.overlay.setTrans(stageCoord.x+(node.getX()-nodeBB.min.x),stageCoord.y+(node.getY()-nodeBB.min.y),true)}this.__editor.overlayManager.overlay.hideControls();GliffyApp.hudController.show(GliffyApp.hudController.HUD_MODE.pos)}},showPremiumPopover:function(domElement){var offset=$(domElement).offset(),popover=new _gliffy.Popover({left:offset.left+$(domElement).width()+5,top:offset.top,title:this.premiumShapePopover.title,contentAsHTML:this.premiumShapePopover.content,placement:"e"})}})}());(function(){GliffyApp.ShapeSearchController=Ember.ObjectController.extend({isSearchOn:false,searchData:null,currentPage:0,resultsPerPage:6,currentStart:0,currentEnd:0,currentTotal:0,isLastPage:false,shapes:null,largestShapeIndex:0,premiumShapeUids:null,iconHeightToDisplayHeight:{},iconWidthToDisplayHeight:{},currentResultHeight:null,init:function(){this.set("isSearchOn",_gliffy.FEATURES.searchOn);this.buildIconHeightToDisplayHeightMap();this.buildIconWidthToDisplayHeightMap()},buildIconHeightToDisplayHeightMap:function(){this.iconHeightToDisplayHeight[50]=21*this.get("resultsPerPage");this.iconHeightToDisplayHeight[60]=26*this.get("resultsPerPage");this.iconHeightToDisplayHeight[62]=35*this.get("resultsPerPage");this.iconHeightToDisplayHeight[75]=42*this.get("resultsPerPage");this.iconHeightToDisplayHeight[80]=45*this.get("resultsPerPage")},buildIconWidthToDisplayHeightMap:function(){this.iconWidthToDisplayHeight[50]=7*this.get("resultsPerPage");this.iconWidthToDisplayHeight[60]=15*this.get("resultsPerPage");this.iconWidthToDisplayHeight[62]=21*this.get("resultsPerPage");this.iconWidthToDisplayHeight[75]=28*this.get("resultsPerPage");this.iconWidthToDisplayHeight[80]=31*this.get("resultsPerPage")},actions:{prevSearchPage:function(){var searchTerm=$("#gliffy-shape-library-search-field");this.searchShapes({searchTerm:searchTerm,reset:false,pageCount:-1});$("#gliffy-shape-search-results").css("height",this.get("currentResultHeight")).html("");_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeSearch",action:"prevSearchPage"})},nextSearchPage:function(){var searchTerm=$("#gliffy-shape-library-search-field");this.searchShapes({searchTerm:searchTerm,reset:false,pageCount:1});$("#gliffy-shape-search-results").css("height",this.get("currentResultHeight")).html("");_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeSearch",action:"nextSearchPage"})},togglePanel:function(){if($(".gliffy-search-panel-heading").hasClass("gliffy-search-panel-expand")){$(".gliffy-search-panel-heading").removeClass("gliffy-search-panel-expand");$("#gliffy-shape-search-results").slideUp()}else{$(".gliffy-search-panel-heading").addClass("gliffy-search-panel-expand");$("#gliffy-shape-search-results").slideDown()}$("#gliffy-search-pagination").toggle()}},incrementCurrentPageCount:function(){this.set("currentPage",this.currentPage+1)},decrementCurrentPageCount:function(){if(this.currentPage>1){this.set("currentPage",this.currentPage-1)}},populateSearchData:function(){this.set("searchData",GLIFFY_SEARCH_INDEX)},searchShapes:function(searchOptions){var promise,results,self=this;searchOptions=$.extend({},{searchTerm:"aws",reset:false,pageCount:0},searchOptions);if(searchOptions.reset){this.resetSearchPagination()}if(searchOptions.pageCount===-1){this.decrementCurrentPageCount()}else{if(searchOptions.pageCount===1){this.incrementCurrentPageCount()}}promise=this.queryShapeData(searchOptions.searchTerm.val());promise.done(function(){results={name:"Search Results",shapes:self.get("shapes"),type:"ShapeLibraryPanel",uid:"com.gliffy.shape.search",largestShapeIndex:self.get("largestShapeIndex"),premiumShapeUids:self.premiumShapeUids};$(window).trigger("gliffy-shape-library-search-loaded",results)});promise.fail(function(){console.log("fail")})},queryShapeData:function(searchTerm){var search=$("#gliffy-shape-library-search-field"),deferred;search.attr("disabled","true");if(!this.searchData){this.populateSearchData()}this.shapes=this.searchShapeLibraries(searchTerm);deferred=_gliffy.shapeLibrary.loaded;deferred.done(function(){search.removeAttr("disabled")});return deferred},searchShapeLibraries:function(searchTerm){var index=lunr.Index.load(this.searchData),results,i,shapesUids=Ember.A([]),initialCount=0,total=0,shape,biggestShape;results=index.search(searchTerm);this.set("largestShapeIndex",0);this.premiumShapeUids=[];if(results.length!==0){for(i=((this.get("currentPage")-1)*this.get("resultsPerPage"));i<results.length;i++){if(initialCount<this.get("resultsPerPage")){shape=_gliffy.shapeLibrary.getShape(results[i].ref);if(shape){biggestShape=_gliffy.shapeLibrary.getShape(results[this.largestShapeIndex].ref);if(biggestShape&&(shape.preview.iconHeight*shape.preview.iconWidth)>(biggestShape.preview.iconHeight*biggestShape.preview.iconWidth)){this.set("largestShapeIndex",initialCount)}if(shape.isPremium&&_gliffy.FEATURES.showPremiumShapesLocked){this.premiumShapeUids.push(results[i].ref)}shapesUids.push(results[i].ref)}initialCount++}total++}if(this.get("largestShapeIndex")!==null){shape=_gliffy.shapeLibrary.getShape(results[this.get("largestShapeIndex")+((this.get("currentPage")-1)*this.get("resultsPerPage"))].ref);if(shape&&shape.preview.iconHeight){if(this.iconHeightToDisplayHeight[shape.preview.iconHeight]&&this.iconWidthToDisplayHeight[shape.preview.iconWidth]){if(shape.preview.iconHeight>=shape.preview.iconWidth){this.set("currentResultHeight",this.iconHeightToDisplayHeight[shape.preview.iconHeight])}else{this.set("currentResultHeight",this.iconWidthToDisplayHeight[shape.preview.iconWidth])}}else{this.set("currentResultHeight",this.iconHeightToDisplayHeight[80])}}}else{this.set("currentResultHeight",this.iconHeightToDisplayHeight[80])}this.set("currentStart",((this.get("currentPage")-1)*this.get("resultsPerPage"))+1);if(this.get("currentTotal")===0){this.set("currentTotal",total)}this.set("currentEnd",this.get("resultsPerPage")*this.get("currentPage"));if(results.length<=this.get("resultsPerPage")||total<=this.resultsPerPage){this.set("isLastPage",true)}else{this.set("isLastPage",false)}if(total<this.resultsPerPage){this.set("currentEnd",this.get("currentStart")+total-1)}}else{this.set("isLastPage",true);this.set("currentStart",0);this.set("currentEnd",0);this.set("currentTotal",0)}_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeSearch",action:searchTerm});return shapesUids},resetSearchPagination:function(){this.set("currentPage",1);this.set("currentTotal",0)}});GliffyApp.shapeSearchController=GliffyApp.ShapeSearchController.create()}());(function(){GliffyApp.ShapeLibraryModel=Ember.Object.extend({editor:null,panels:null,panelViewMap:null,timeout:null,showFirstPanel:null,init:function(){this.panelViewMap={};this.showFirstPanel=false},panelsEqual:function(panels){var i=0;if(this.panels&&panels&&this.panels.length===panels.length){for(i=0;i<panels.length;i++){if(panels[i]!==this.panels[i]){return false}}return true}return false},overridePanels:function(panels){if(panels.length===0||!this.panelsEqual(panels)){this.override=true;this.set("panels",panels)}},movePanel:function(panel,newIndex){var index=this.panels.indexOf(panel);this.panels.splice(index,1);this.panels.splice(newIndex,0,panel);this.set("panels",[].concat(this.panels))},addPanel:function(panel){var index=this.panels.indexOf(panel);if(index===-1){this.panelToAdd=panel;this.panels.unshift(panel);this.set("panels",[].concat(this.panels))}},addPanels:function(panels){var validPanels=[],i;for(i=0;i<panels.length;i++){if(this.panels.indexOf(panels[i])===-1){validPanels.push(panels[i])}}if(validPanels.length>0){this.panelsToAdd=validPanels;this.set("panels",validPanels.concat(this.panels))}},removePanel:function(panel){this.panelToRemove=panel;var index=this.panels.indexOf(panel);if(index>=0){this.panels.splice(index,1);this.set("panels",[].concat(this.panels))}},resetState:function(){this.panelToRemove=null;this.panelToAdd=null;this.panelsToAdd=null;this.panelToUpdate=null;this.override=null}})}());(function(){GliffyApp.shapeSearchView=Ember.View.extend({currentPageBinding:Ember.Binding.oneWay("GliffyApp.shapeSearchController.currentPage"),isLastPageBinding:Ember.Binding.oneWay("GliffyApp.shapeSearchController.isLastPage"),isFirstPage:Ember.computed(function(){if(this.get("currentPage")===1){return true}else{return false}}).property("currentPage")});GliffyApp.ShapeSearchTextField=Ember.TextField.extend({placeholder:null,focusIn:function(e){$("#search-icon").hide()},focusOut:function(e){if($("#gliffy-shape-library-search-field").val()===""){$("#search-icon").show()}},didInsertElement:function(){this.set("placeholder",$.i18n._("SHAPE_SEARCH_PLACEHOLDER_TITLE"))},keyDown:function(e){var searchTerm=$("#gliffy-shape-library-search-field");if(e.keyCode===13&&searchTerm.length!=0&&searchTerm.val()!==""){$("#gliffy-shape-search-container").show();$(".gliffy-search-panel-heading").addClass("gliffy-search-panel-expand");$("#gliffy-search-pagination").show();GliffyApp.shapeSearchController.searchShapes({searchTerm:searchTerm,reset:true,pageCount:0});$("#gliffy-shape-search-results").css("height",GliffyApp.shapeSearchController.get("currentResultHeight")).show().html("")}else{if(e.keyCode===13&&searchTerm.length==1&&searchTerm.val()===""){$("#gliffy-shape-search-container").hide();$("#gliffy-search-pagination").hide();$("#gliffy-shape-search-results").html("")}}}})}());(function(){_gliffy.Plugins.create({activate:function(editor){},createPanel:function(editor,library,openOnInit){var shapePreview=_gliffy.shapeLibrary.getShapePreview(library),template=this.getTemplateNames()[0];GliffyApp.shapeLibraryPanelControllerMap=GliffyApp.shapeLibraryPanelControllerMap||{};GliffyApp.shapeLibraryPanelControllerMap[library.uid]=GliffyApp.ShapeLibraryPanelController.create({uid:library.uid,shapes:library.shapes,editor:editor,iconWidth:shapePreview.iconWidth,iconHeight:shapePreview.iconHeight,columns:library.columns,generatePreview:library.generatePreview,premiumShapeUids:library.premiumShapeUids});if(library.uid==="com.gliffy.shape.search"){template="shape-library-search-panel"}return GliffyApp.ShapeLibraryPanelView.create({uid:library.uid,templateName:template,elementId:library.uid.split(".").join("-")+"-toggle",panelName:$.i18n._(library.uid),shapes:null,openOnInit:openOnInit})},initTemplates:function(){},getTemplateNames:function(){return["shape-library-panel"]},getName:function(){return"ShapeLibraryPanel"}})}());(function(){GliffyApp.ShapeLibraryShapeModel=Ember.Object.extend({uid:null,tid:null,library:null,x:null,y:null,title:null,width:null,height:null,isPremium:false,shapeSize:Ember.computed(function(){return"width:"+this.width+"px; height:"+this.height+"px; margin:2px;"}).property("width","height"),libraryClass:Ember.computed(function(){return"gliffy-sidebar-shape "+this.get("library").split(".").join("-")}).property("library"),shapeClass:Ember.computed(function(){return(this.uid)?this.get("uid").split(".").join("-").split("_").join("-"):""}).property("uid"),shapeCenter:"gliffy-shape-center"})}());(function(){GliffyApp.ShapeLibraryPanelView=Ember.View.extend({panelName:null,tagName:"div",templateName:"shape-library-panel",classNames:["gliffy-accordion-group"],attributeBindings:["data-uid"],"data-uid":Ember.computed(function(){return this.uid}).property("uid"),shapesBuilt:false,click:function(event){if(this.uid==="com.gliffy.shape.search"){if($(event.currentTarget.lastElementChild).hasClass("in")){$("#gliffy-search-pagination").show()}else{$("#gliffy-search-pagination").hide()}}},linkHref:Ember.computed(function(){return"#"+((this.uid)?this.uid.split(".").join("-"):"")}).property("uid"),uidId:Ember.computed(function(){return(this.uid)?this.uid.split(".").join("-"):""}).property("uid"),minHeight:345,styleMinHeight:Ember.computed(function(){return"min-height:"+this.minHeight+"px;"}).property("minHeight"),didInsertElement:function(){var controller=GliffyApp.shapeLibraryPanelControllerMap[this.get("uid")],self=this;var minHeight=Math.ceil(controller.get("shapes").length/controller.get("columns"))*controller.get("iconHeight");if(navigator.appName=="Microsoft Internet Explorer"){minHeight+=40}this.set("minHeight",minHeight);$("#"+this.elementId).find(".gliffy-panel-remove").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_RIGHT);if(!this.shapesBuilt){_gliffy.workQueue.delay(1).queue(function(next){GliffyApp.shapeLibraryPanelControllerMap[self.get("uid")].buildShapeModels();self.set("shapes",GliffyApp.shapeLibraryPanelControllerMap[self.get("uid")].get("content"));self.set("shapesBuilt",true);if(self.openOnInit){setTimeout(function(){$("#"+self.elementId).find(".accordion-heading>a:first").click()},100)}$("#"+self.elementId).find(".gliffy-loading").removeClass("gliffy-loading");$("#"+self.elementId).on("mousedown",".gliffy-library-panel-premium-shape",function(e){e.preventDefault();e.stopPropagation();GliffyApp.shapeLibraryController.showPremiumPopover(e.currentTarget)});next()})}}})}());(function(){GliffyApp.ShapeLibraryPanelController=Ember.ObjectController.extend({shapeModelMap:null,content:null,shapes:[],columns:null,iconWidth:null,iconHeight:null,premiumShapeUids:null,uid:"",editor:null,init:function(){this.set("content",Ember.A([]))},actions:{},bindTooltipEvents:function(){$("#"+this.uid.split(".").join("-")+" div.gliffy-sidebar-shape").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_SHAPE_LIBRARY)},generateSvgPreview:function(model,preview){var width=model.defaults.width,height=model.defaults.height,canvas=$("<canvas/>"),ctx=canvas.get(0).getContext("2d"),size=40,canvasSize=model.preview.iconWidth,offsetX,offsetY,stage=new _gliffy.Stage(),node=new _gliffy.Node(stage),shape,tid,shapeStyle,i;ctx.canvas.width=canvasSize;ctx.canvas.height=canvasSize;if(width>height){if(width>size){height=size*(height/width);width=size}}else{if(height>size){width=size*(width/height);height=size}}offsetY=(canvasSize-height)/2;offsetX=(canvasSize-width)/2;node.setUid(model.uid);node.setWidth(width);node.setHeight(height);node.setX(offsetX);node.setY(offsetY);shape=new _gliffy.Shape(node);node.setGraphic(shape);tid=_gliffy.shapeLibrary.shapes[model.uid].tids[0];node.getGraphic().setTid(tid);shapeStyle=new _gliffy.ShapeStyle();shapeStyle.fromObject(node.getShapeInformation().defaults);node.getGraphic().applyStyle(shapeStyle);node.update();node.getGraphic().style.single_canvas=true;for(i=0;i<preview.length;i++){if(preview[i].innerHTML.indexOf("canvas")!==-1){preview.splice(i,1)}}_gliffy.renderers[_gliffy.Renderer.ShapeCanvas.prototype.id].render({target:ctx,object:node.getGraphic(),renderCallback:function(){preview.append(canvas)}})},buildShapeModels:function(){var i,model,self=this;this.set("shapeModelMap",{});this.set("content",Ember.A([]));for(i=0;i<this.get("shapes").length;i++){model=GliffyApp.ShapeLibraryShapeModel.create({uid:this.get("shapes")[i],tid:"",library:this.get("uid"),title:"",width:this.get("iconWidth"),height:this.get("iconHeight")});if(_gliffy.FEATURES.showPremiumShapes&&this.premiumShapeUids){model.set("isPremium",this.premiumShapeUids.indexOf(model.uid)>-1)}this.get("shapeModelMap")[this.get("shapes")[i]]=model;this.get("content").push(model)}_gliffy.shapeLibrary.loaded.done(function(){var uid,tid,shape,uids=self.get("shapes"),i,container,id;for(i=0;i<uids.length;i++){uid=uids[i];shape=_gliffy.shapeLibrary.shapes[uid];self.get("shapeModelMap")[uid].set("tid",shape.tids[0]);self.get("shapeModelMap")[uid].set("title",$.i18n._(uid));if(_gliffy.shapeLibrary.shapes[uids[i]].preview.type==="svg"){(function(i){setTimeout(function(){id=uids[i];if(self.uid==="com.gliffy.shape.search"){container=$("#gliffy-shape-search-container ."+self.get("shapeModelMap")[id].get("shapeClass"))}else{container=$("#gliffy-sidebar ."+self.get("shapeModelMap")[id].get("shapeClass"))}self.generateSvgPreview(_gliffy.shapeLibrary.shapes[id],container);self.bindTooltipEvents()},100)}(i))}else{setTimeout(function(){self.bindTooltipEvents()},200)}}})}})}());(function(){_gliffy.Plugins.create({activate:function(editor){if(editor.enableCustomShapes){GliffyApp.shapeLibraryCustomPanelDeleteModalView.set("editor",editor)}},createPanel:function(editor,library,openOnInit){var shapePreview=_gliffy.shapeLibrary.getShapePreview(library);if(editor.enableCustomShapes){GliffyApp.shapeLibraryPanelControllerMap=GliffyApp.shapeLibraryPanelControllerMap||{};GliffyApp.shapeLibraryPanelControllerMap[library.uid]=GliffyApp.ShapeLibraryCustomPanelController.create({uid:library.uid,editor:editor,iconWidth:shapePreview.iconWidth,iconHeight:shapePreview.iconHeight,columns:library.columns});return GliffyApp.ShapeLibraryCustomPanelView.create({uid:library.uid,templateName:this.getTemplateNames()[0],elementId:library.uid.split(".").join("-")+"-toggle",panelName:library.name,shapes:null,openOnInit:openOnInit})}},initTemplates:function(){var view=GliffyApp.shapeLibraryCustomPanelDeleteModalView=GliffyApp.ShapeLibraryCustomPanelDeleteModalView.create({});if(Ember.View.views["gliffy-popup-container"]){Ember.View.views["gliffy-popup-container"].pushObject(view)}},getTemplateNames:function(){return["shape-library-custom-panel"]},getName:function(){return"ShapeLibraryCustomPanel"}})}());(function(){GliffyApp.ShapeLibraryCustomShapeModel=Ember.Object.extend({uid:null,tid:null,library:null,title:null,width:null,height:null,data:null,preview:null,index:null,shapeSize:Ember.computed(function(){return"width:"+this.width+"px; height:"+this.height+"px; margin:2px;"}).property("width","height"),libraryClass:Ember.computed(function(){return"gliffy-sidebar-shape "+this.get("library").split(".").join("-")}).property("library"),shapeClass:Ember.computed(function(){return(this.uid)?this.get("uid").split(".").join("-").split("_").join("-"):""}).property("uid"),shapeCenter:Ember.computed(function(){return"gliffy-shape-center"})})}());(function(){GliffyApp.ShapeLibraryCustomPanelView=Ember.View.extend({panelName:null,tagName:"div",templateName:"shape-library-panel",classNames:["gliffy-accordion-group"],attributeBindings:["data-uid"],isNotAnonymous:true,"data-uid":Ember.computed(function(){return this.uid}).property("uid"),shapesBuilt:false,click:function(event){},linkHref:Ember.computed(function(){return"#"+((this.uid)?this.uid.split(".").join("-"):"")}).property("uid"),uidId:Ember.computed(function(){return(this.uid)?this.uid.split(".").join("-"):""}).property("uid"),minHeight:300,styleMinHeight:Ember.computed(function(){return"min-height:"+this.minHeight+"px;"}).property("minHeight"),isChrome:function(){return typeof window.chrome==="object"},isFavorite:Ember.computed(function(){return this.get("favorite")}).property("favorite"),actions:{removePanel:function(){GliffyApp.manageShapeLibraryController.removePanel(this);if(this.isChrome()){$(".gliffy-dropdown-clone").remove()}$(".tooltip.right").remove();_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeLibraryRemovePanel",action:this.uid});_gliffy.Utils.analyticsEvent("trackEvent",{category:"customLibraryOptions",action:"removeFromSidebar"})},deleteForeverPop:function(){GliffyApp.shapeLibraryCustomPanelDeleteModalView.show(this);_gliffy.Utils.analyticsEvent("trackEvent",{category:"customLibraryOptions",action:"delete"})},toggleFavorite:function(){var controller=GliffyApp.shapeLibraryPanelControllerMap[this.get("uid")];controller.toggleFavorite(this.get("library"),this)},launchLibraryEdit:function(){GliffyApp.modifyCustomLibraryController.loadLibrary(this.uid);if(this.isChrome()){$(".gliffy-dropdown-clone").remove()}_gliffy.Utils.analyticsEvent("trackEvent",{category:"customLibraryOptions",action:"edit"})}},calculateMenuDropdown:function(event){var element=$(event.target).closest("a"),dropdown=element.closest(".gliffy-custom-dropdown"),offset=element.offset(),ul;if(this.isChrome()){event.preventDefault();$(".gliffy-dropdown-clone").remove();ul=dropdown.find("ul");ul.css({display:"none"});ul.clone(true).addClass("gliffy-dropdown-clone").css({top:offset.top+20,left:offset.left,position:"fixed",display:"block"}).appendTo("body")}else{dropdown.find("ul").css({top:offset.top+20,left:offset.left})}},update:function(library){var controller=GliffyApp.shapeLibraryPanelControllerMap[this.get("uid")],shapes=controller.get("shapes"),sameShapes=true,i=0;this.set("panelName",library.name);if(library.shapes.length===shapes.length){for(i=0;i<library.shapes.length;i++){if(library.shapes[i].data!==shapes[i].data){sameShapes=false;break}}}else{sameShapes=false}if(!sameShapes){controller.set("shapes",library.shapes);controller.buildShapeModels();this.set("shapes",controller.get("content"));controller.renderShapes()}},didInsertElement:function(){var controller=GliffyApp.shapeLibraryPanelControllerMap[this.get("uid")],self=this;this.set("minHeight",Math.ceil(controller.get("shapes").length/controller.get("columns"))*controller.get("iconHeight"));$("#"+this.elementId).find(".gliffy-panel-remove").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_RIGHT).on("click",function(e){self.calculateMenuDropdown(e)});if(!this.shapesBuilt){_gliffy.workQueue.delay(1).queue(function(next){GliffyApp.shapeLibraryPanelControllerMap[self.get("uid")].populateCustomShapes().then(function(data){self.set("library",data);self.set("panelName",data.name);GliffyApp.shapeLibraryPanelControllerMap[self.get("uid")].buildShapeModels();self.set("shapes",GliffyApp.shapeLibraryPanelControllerMap[self.get("uid")].get("content"));self.set("shapesBuilt",true);self.set("favorite",data.favorite);GliffyApp.shapeLibraryPanelControllerMap[self.get("uid")].renderShapes();if(self.openOnInit){setTimeout(function(){$("#"+self.elementId).find(".accordion-heading>a:first").click()},50)}$("#"+self.elementId).find(".gliffy-loading").removeClass("gliffy-loading")});next()})}}})}());(function(){GliffyApp.ShapeLibraryCustomPanelController=GliffyApp.ShapeLibraryPanelController.extend({shapeModelMap:null,content:null,shapes:[],columns:null,iconWidth:null,iconHeight:null,uid:"",editor:null,init:function(){this.set("content",Ember.A([]))},getPanelSelector:function(){return"#"+this.uid.split(".").join("-")},bindTooltipEvents:function(){$(this.getPanelSelector()+" div.gliffy-sidebar-shape").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_SHAPE_LIBRARY)},toggleFavorite:function(library,view){if(library.favorite){this.editor.integration.removeFavoriteCustomLibrary(library.uid,function(){view.get("library").favorite=false;view.set("favorite",false);_gliffy.Utils.analyticsEvent("trackEvent",{category:"customLibraryOptions",action:"removeFromFavorites"})},function(){_gliffy.Logger.warn("Failed to remove library:"+library.uid+" to favorites")})}else{this.editor.integration.markFavoriteCustomLibrary(library.uid,function(){view.get("library").favorite=true;view.set("favorite",true);_gliffy.Utils.analyticsEvent("trackEvent",{category:"customLibraryOptions",action:"addToFavorites"})},function(){_gliffy.Logger.warn("Failed to add library:"+library.uid+" to favorites")})}},populateCustomShapes:function(){var self=this,deferred=new $.Deferred();this.editor.integration.getCustomLibrary(this.uid,function(data){self.set("shapes",data.shapes);deferred.resolve(data)},function(xhr,text,error){self.set("shapes",[]);deferred.reject()});return deferred.promise()},buildShapeModels:function(){var i,model,self=this,shape,shapes=[],tid;this.set("shapeModelMap",{});this.set("content",Ember.A([]));for(i=0;i<this.get("shapes").length;i++){shape=this.get("shapes")[i];shapes.push(shape.uid);tid="";if(shape.uid==="com.gliffy.shape.basic.basic_v1.default.svg"){tid="com.gliffy.stencil.custom.svg.static"}else{if(shape.uid==="com.gliffy.shape.basic.basic_v1.default.image"){tid="com.gliffy.stencil.image"}}model=GliffyApp.ShapeLibraryCustomShapeModel.create({uid:shape.uid,tid:tid,data:shape.data,thumbnail:shape.thumbnail,library:this.get("uid"),title:"",width:this.get("iconWidth"),height:this.get("iconHeight"),index:i});this.get("shapeModelMap")[i]=model;this.get("content").push(model)}_gliffy.shapeLibrary.loaded.done(function(){self.bindTooltipEvents()})},generateSvgPreview:function(model,shape){_gliffy.shapeLibrary.loadSvgStencil(model.data).then(function(){var dim=_gliffy.shapeLibrary.svgDim[model.data],canvas=$("<canvas/>"),ctx=canvas.get(0).getContext("2d"),ratioW=dim.width/dim.height,ratioH=dim.height/dim.width,offsetX=0,offsetY=0,padding=10,width=model.width-padding,height=model.height-padding;if(ratioW>ratioH){ratioW=1;offsetY=(height-ratioH*height)/2}else{ratioH=1;offsetX=(width-ratioW*width)/2}ctx.canvas.width=width;ctx.canvas.height=height;if(_gliffy.shapeLibrary.canDrawStencil(model.data)){ctx.translate(offsetX,offsetY);ctx.scale(width*ratioW/dim.width,height*ratioH/dim.height);ctx.translate(-dim.x,-dim.y);_gliffy.shapeLibrary.drawStencil(model.data,ctx,{width:width,height:height,gradient:false,stroke:"black",fill:"black"})}shape.append(canvas.css({marginTop:padding/2,marginLeft:padding/2}))})},renderShapes:function(){var inner=$(this.getPanelSelector()+" .gliffy-accordion-inner"),i,model,params,shape;inner.empty();for(i=0;i<this.get("shapes").length;i++){model=this.get("shapeModelMap")[i];params={uid:model.get("uid"),tid:model.get("tid")};shape=$("<div/>",{"class":model.get("libraryClass")+" "+model.get("shapeClass"),style:model.get("shapeSize")});if(model.uid==="com.gliffy.shape.basic.basic_v1.default.svg"){params=$.extend(params,{svg:model.data});this.generateSvgPreview(model,shape)}else{if(model.uid==="com.gliffy.shape.basic.basic_v1.default.image"){params=$.extend(params,{image:model.data,thumbnail:model.thumbnail,doNotProxyImage:true});shape.css({"background-image":"url("+model.thumbnail+")",width:model.width,height:model.height,"background-size":"cover"})}else{}}shape.data({uid:model.uid,tid:model.tid,params:params});inner.append(shape)}}})}());(function(){GliffyApp.ShapeLibraryCustomPanelDeleteModalView=Ember.View.extend({tagName:"div",templateName:"shape-library-custom-panel-delete-modal",classNames:["gliffy-popup"],uid:null,editor:null,show:function(panelView){this.set("uid",panelView.uid);this.panelView=panelView;$("#gliffyConfirmDeleteLibrary").modal("show")},deleteLibrary:function(event){var self=this;event.preventDefault();this.editor.integration.deleteCustomLibrary(this.uid,function(){GliffyApp.manageShapeLibraryController.removePanel(self.panelView);_gliffy.Utils.analyticsEvent("trackEvent",{category:"customLibrary",action:"delete"})},function(){_gliffy.Utils.notify("error",$.i18n._("LIBRARYOPTION_DELETE_ERROR_TITLE"),$.i18n._("LIBRARYOPTION_DELETE_ERROR_MESSAGE"))})},didInsertElement:function(){var self=this;$("#gliffyConfirmDeleteLibrary .gliffy-btn-primary").on("click",function(e){self.deleteLibrary(e)})}})}());(function(){GliffyApp.ManageShapeLibraryView=Ember.View.extend({panelName:null,tagName:"div",templateName:"manage-shape-library",classNames:["gliffy-popup"],shapesBuilt:false,libraries:null,showIntro:true,showUmlV1:false,showUIV2:false,shapePreview:null,toggleGroup:function(event){var icon=$(event.target),group=icon.closest(".gliffy-panel-group"),subgroup=group.find(".gliffy-panel-sub-group"),background=$("#manageLibrary .gliffy-selected-background");if(subgroup.is(":visible")){icon.removeClass("gliffy-icon-library-arrow-open").addClass("gliffy-icon-library-arrow-closed");subgroup.slideUp()}else{icon.removeClass("gliffy-icon-library-arrow-closed").addClass("gliffy-icon-library-arrow-open");subgroup.slideDown(function(){group.find("div.checkbox:first div").click()})}},toggleLibraryGroup:function(event){var checkbox=$(event.target),i,panels=[],isDisplayed=false,subCheckboxes=checkbox.closest(".gliffy-panel-group").find(".gliffy-panel-sub-group input"),box;for(i=0;i<subCheckboxes.length;i++){box=$(subCheckboxes.get(i));isDisplayed=(box.parent().css("display")!=="none");if(checkbox.is(":checked")){if(isDisplayed){panels.push(box.val())}box.attr("checked",true)}else{if(isDisplayed){GliffyApp.manageShapeLibraryController.removePanelByLibraryId(box.val());_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeLibraryRemovePanel",action:box.val()})}box.removeAttr("checked")}}if(panels.length>0){GliffyApp.shapeLibraryModel.addPanels(panels);for(i=0;i<panels.length;i++){_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeLibraryAddPanel",action:panels[i]})}}this.fixCheckboxState()},checkIfAllToggled:function(checkbox){var subgroup=checkbox.closest(".gliffy-panel-sub-group"),notChecked;if(subgroup.length>0){notChecked=$.grep(subgroup.find("input"),function(n,i){return !$(n).is(":checked")});if(notChecked.length===0){checkbox.closest(".gliffy-panel-group").find(".gliffy-panel-group-toggle").attr("checked",true)}}},toggleSelectCustom:function(event){var label=$(event.target),checkbox=label.closest(".checkbox").find("input");this.set("customShapePreview",true);this.selectItem(label,true,false);GliffyApp.manageShapeLibraryController.renderCustomLibraryPreview(checkbox.val(),$("#manageLibrary .gliffy-shape-preview-container"));return false},toggleSelectCustomGroup:function(event){var label=$(event.target),checkbox=label.closest(".checkbox").find("input");this.selectItem(label,false,true);$("#manageLibrary .gliffy-shape-preview-container").empty();return false},toggleSelectGroup:function(event){var label=$(event.target),checkbox=label.closest(".checkbox").find("input"),libraries=[];this.selectItem(label,false,false);_.each(label.closest(".gliffy-panel-group").find(".gliffy-panel-sub-group input"),function(librarySubGroup){if($(this).parent().css("display")!=="none"){libraries.push(librarySubGroup.value)}});GliffyApp.manageShapeLibraryController.renderGliffyLibraryPreview(libraries);return false},toggleSelect:function(event){var label=$(event.target),checkbox=label.closest(".checkbox").find("input");this.subFunctionCalled++;this.selectItem(label,false,false);GliffyApp.manageShapeLibraryController.renderGliffyLibraryPreview([checkbox.val()]);return false},deselect:function(){this.set("selected",false);this.set("showIntro",GliffyApp.manageShapeLibraryController.customShapesEnabled());this.set("selectedCustomLibrary",null);$("#manageLibrary .gliffy-selected-background").hide();$("#manageLibrary .gliffy-shape-preview-container").empty()},selectItem:function(label,isCustomLibrary,showIntro){var background=$("#manageLibrary .gliffy-selected-background"),container=$("#manageLibrary .gliffy-library-list-container"),uid=label.closest(".checkbox").find("input").val(),libraries=this.get("libraries"),favoriteLibraries=this.get("favoriteLibraries"),i,library;this.set("customShapePreview",isCustomLibrary);this.set("showIntro",showIntro&&GliffyApp.manageShapeLibraryController.customShapesEnabled());this.set("selected",true);if(isCustomLibrary){for(i=0;i<libraries.length;i++){if(libraries[i].uid===uid){library=libraries[i];break}}if(!library){for(i=0;i<favoriteLibraries;i++){if(favoriteLibraries[i].uid===uid){library=favoriteLibraries[i];break}}}this.set("selectedCustomLibrary",library)}else{this.set("selectedCustomLibrary",null)}background.css({visibility:"visible",display:"block",top:label.offset().top-$("#manageLibrary .gliffy-library-list-container").offset().top+container.scrollTop()-4})},markFavorite:function(){var library=this.get("selectedCustomLibrary");GliffyApp.manageShapeLibraryController.markFavorite(library,this)},removeFavorite:function(){var library=this.get("selectedCustomLibrary");GliffyApp.manageShapeLibraryController.removeFavorite(library,this)},everyoneCanEdit:Ember.computed(function(){var library=this.get("selectedCustomLibrary");if(library){return library.permissions==="everyone"}else{return false}}).property("selectedCustomLibrary"),updateLibrary:function(event){var checkbox=$(event.target),library=checkbox.val(),index=GliffyApp.shapeLibraryModel.panels.indexOf(library);if(index===-1){GliffyApp.shapeLibraryModel.addPanel(library);_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeLibraryAddPanel",action:library});this.checkIfAllToggled(checkbox)}else{GliffyApp.manageShapeLibraryController.removePanelByLibraryId(library);_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeLibraryRemovePanel",action:library});checkbox.closest(".gliffy-panel-group").find(".gliffy-panel-group-toggle").removeAttr("checked")}this.fixCheckboxState()},didInsertElement:function(){var self=this;this.addObserver("libraries",this,function(){setTimeout(function(){self.fixCheckboxState()},1)});this.addObserver("favoriteLibraries",this,function(){setTimeout(function(){self.fixCheckboxState()},1)});this.set("showIntro",GliffyApp.manageShapeLibraryController.customShapesEnabled());this.set("customShapesEnabled",GliffyApp.manageShapeLibraryController.customShapesEnabled());this.set("imagePanelEnabled",GliffyApp.manageShapeLibraryController.imagePanelEnabled());this.set("showTables",GliffyApp.manageShapeLibraryController.showTables());this.set("showTablesV2",GliffyApp.manageShapeLibraryController.showTablesV2());this.set("showUmlV1",GliffyApp.manageShapeLibraryController.showUmlV1());this.set("showUIV2",GliffyApp.manageShapeLibraryController.showUIV2());$("#manageLibrary").on("show",function(){self.fixCheckboxState();if(GliffyApp.manageShapeLibraryController.customShapesEnabled()){GliffyApp.manageShapeLibraryController.populateCustomLibraryList(self)}}).on("hide",function(){self.deselect();if(GliffyApp.manageShapeLibraryController.customShapesEnabled()){GliffyApp.manageShapeLibraryController.set("listOffset",0);GliffyApp.manageShapeLibraryController.set("favoriteOffset",0)}});$("#manageLibrary").on("click",".gliffy-icon-library-arrow-closed,.gliffy-icon-library-arrow-open",function(event){self.toggleGroup(event)});$("#manageLibrary").on("click",".gliffy-toggle-select-group",function(event){self.toggleSelectGroup(event)});$("#manageLibrary").on("click",".gliffy-toggle-select",function(event){self.toggleSelect(event)});$("#manageLibrary").on("click",".gliffy-panel-group-toggle",function(event){self.toggleLibraryGroup(event)});$("#manageLibrary").on("click",".gliffy-panel-sub-group .checkbox input",function(e){self.updateLibrary(e)});$("#manageLibrary").on("click",".gliffy-toggle-select-custom-group",function(e){self.toggleSelectCustomGroup(e)});$("#manageLibrary").on("click",".gliffy-toggle-select-custom",function(e){self.toggleSelectCustom(e)})},loadMoreLibraries:function(){GliffyApp.manageShapeLibraryController.updateCustomLibraryList(this);return false},fixCheckboxState:function(){var self=this;$("#manageLibrary").find("input").each(function(){var checkbox=$(this),index=GliffyApp.shapeLibraryModel.panels.indexOf(checkbox.val());if(!checkbox.hasClass("gliffy-panel-group-toggle")&&checkbox.parent().css("display")!=="none"){if(index===-1){checkbox.removeAttr("checked");checkbox.closest(".gliffy-panel-group").find(".gliffy-panel-group-toggle").removeAttr("checked")}else{checkbox.attr("checked",true);self.checkIfAllToggled(checkbox)}}})}})}());(function(){GliffyApp.RequestShapeLibraryView=Ember.View.extend({panelName:null,tagName:"div",templateName:"request-shape-library",classNames:["gliffy-popup"],shapesBuilt:false,appId:"unknown",getRequestedLibraries:function(){var requestedLibraries=[],other;$(".gliffy-request-library-checkbox:checked").each(function(key,val){var sendid=$(val).data("sendid");if(sendid!=="other"){requestedLibraries.push(sendid)}});other=$(".gliffy-request-library-other").val();if(other.length>0){requestedLibraries.push(other.replace(/\,/g," "))}return requestedLibraries.join(",")},didInsertElement:function(){var self=this,$req=$(".gliffy-requested-libraries"),html="",libraries=[{name:"BPMN 2.0",id:"BPMN_2"},{name:"iPad",id:"iPad"},{name:"Electrical / Circuit Diagrams",id:"electrical_circuit"},{name:"Roadmaps",id:"roadmaps"},{name:"Timelines",id:"timelines"},{name:"Mindmap",id:"mindmap"},{name:"Gantt chart",id:"gantt"},{name:"Process Engineering",id:"process_engineering"},{name:"Enterprise Integration",id:"enterprise_integration"},{name:"Entity Relationship Diagrams (ERD) 2.0",id:"ERD_2"},{name:"Charts and graphs",id:"charts_graphs"}];libraries.push({name:"Other (please specify)",id:"other"});$.each(libraries,function(key,val){html+='<div class="checkbox">';html+="    <span>"+val.name+"</span>";html+='<input type="checkbox" data-sendId="'+val.id+'"class="gliffy-request-library-checkbox gliffy-panel-group-toggle-'+val.id+'" value="" >';if(val.id==="other"){html+='    <input type="text" class="gliffy-request-library-other">'}html+="</div>"});$req.html(html);$(".gliffy-request-library-other").on("change keyup paste, click",function(){$(".gliffy-panel-group-toggle-other").attr("checked","true")});$(".gliffy-request-library-form").on("submit",function(e){return false});$("#gliffy-send-shape-request").click(function(){GliffyApp.requestShapeLibrarySendView.displayLoad();$.ajax({type:"PUT",url:"https://www.gliffy.com/go/libraryRequest",data:{appId:self.appId,libraryName:self.getRequestedLibraries()},success:function(){GliffyApp.requestShapeLibrarySendView.displaySuccess()},error:function(e){GliffyApp.requestShapeLibrarySendView.displayFail()}})})}})}());(function(){GliffyApp.RequestShapeLibrarySendView=Ember.View.extend({panelName:null,tagName:"div",templateName:"request-shape-library-send",classNames:["gliffy-popup"],didInsertElement:function(){$(".gliffy-accept-request-library").click(function(){$(".gliffy-request-library-success").hide();$(".gliffy-request-library-fail").hide();$(".gliffy-request-library-load").show()})},displayLoad:function(){$(".gliffy-request-library-load").show();$(".gliffy-request-library-fail").hide();$(".gliffy-request-library-success").hide()},displaySuccess:function(){$(".gliffy-request-library-load").hide();$(".gliffy-request-library-fail").hide();$(".gliffy-request-library-success").show()},displayFail:function(){$(".gliffy-request-library-load").hide();$(".gliffy-request-library-fail").show();$(".gliffy-request-library-success").hide()}})}());(function(){GliffyApp.ManageShapeLibraryButtonView=Ember.View.extend({templateName:"manage-shape-library-button",classNames:["btn-group gliffy-tools gliffy-toolbar-more-shapes gliffy-sidebar-shapes gliffy-sidebar-btns"],didInsertElement:function(){var self=this;$("#gliffy-hide-library,.gliffy-toggle-panels").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_TOP);$(".gliffy-toggle-panels").on("click",function(event){event.preventDefault();$(event.target).blur()});$("#gliffy-library-toggle-panels").on("click",function(e){e.preventDefault();$(e.target).blur()});$("#gliffy-hide-library").on("click",function(event){self.toggleSidebar(event)})},toggleSidebar:function(event){event.preventDefault();var sidebar=$(".gliffy-sidebar"),centerPane=$("#gliffy-center-pane").parent(),start=parseInt(centerPane.css("marginLeft"),10),target=$(event.target).closest("a");target.css("visibility","hidden");$(".gliffy-sidebar").animate({left:-sidebar.width()},{complete:function(){$(".gliffy-sidebar-btns").css("display","none");var button=$('<div><a class="btn" id="gliffy-show-library" href="#" title="'+$.i18n._("MANAGELIBRARY_TOOLTIP_SHOW_SIDEBAR")+'"><i class="icon-chevron-right"></i></a></div>');button.appendTo("body").css({opacity:0.5}).animate({opacity:1});button.find("a").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_RIGHT);button.click(function(){$(".gliffy-sidebar-btns").css("display","block");target.css({visibility:"visible"});sidebar.animate({left:0},{step:function(now,fx){button.css({left:start+now-10,opacity:-now/start});centerPane.css({marginLeft:start+now});$(window).trigger("resize")},complete:function(){$("#gliffy-show-library").removeAttr("data-original-title").tooltip("hide");$("#gliffy-show-library").remove()}});_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeLibraryToggleSidebar",action:"show"});return false})},step:function(now,fx){centerPane.css({marginLeft:start+now});$(window).trigger("resize")}});_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeLibraryToggleSidebar",action:"hide"})}})}());(function(){GliffyApp.ModifyCustomLibraryView=Ember.View.extend({editor:null,tagName:"div",templateName:"modify-custom-library",classNames:["gliffy-popup"],theController:null,persistName:function(){var name=$.trim(this.$().find(".gliffy-custom-name-field").val());if(this.validateName(name,false)){this.get("theController").get("model").set("name",name)}this.$().find(".gliffy-custom-name-field").hide();this.$().find(".gliffy-custom-name").show();this.$().find(".gliffy-icon-library-pencil").show()},showError:function(notice,textkey){notice.find(".alert").removeClass("alert-info").addClass("alert-error");notice.find(".gliffy-error-message").text($.i18n._(textkey));notice.show()},validateName:function(name,updateNotice){var notice=$("#gliffy-custom-error-notice");if(name===$.i18n._("MODIFYLIBRARY_PLACEHOLDER_TITLE")){if(updateNotice){this.showError(notice,"MODIFYLIBRARY_ERROR_NOT_NAMED")}return false}else{if(!name||name.length===0){if(updateNotice){this.showError(notice,"MODIFYLIBRARY_ERROR_EMPTY")}return false}else{if(name&&name.length>127){if(updateNotice){this.showError(notice,"MODIFYLIBRARY_ERROR_TOO_LONG")}}else{if(name&&name.length>0&&name.length<127){notice.hide();return true}}}}return false},didInsertElement:function(){var self=this,element=document.getElementById("customLibraryDragAndDrop");if(this.get("theController")){this.get("theController").bindDragEvents(element);this.get("theController").registerMouseClickState();this.$().on("blur",".gliffy-custom-name-field",function(){self.persistName()});this.$().find(".gliffy-custom-name-field").on("keyup",function(event){if(event.keyCode===13){this.blur()}});$("#modifyCustomLibrary").on("show",function(){var select=$("#modifyCustomLibrary .gliffy-custom-library-edit-permission");if(!("File" in window)){$("#gliffyFileUploadLink").hide()}if(!window.dropfile){self.showError($("#gliffy-custom-error-notice"),"MODIFYLIBRARY_ERROR_FILEAPI")}if(self.get("theController").get("model").get("userIsOwner")){select.show()}else{select.hide()}}).on("hide",function(){$("#gliffy-custom-error-notice").hide()})}else{this.remove()}}})}());(function(){GliffyApp.CustomLibraryDataModel=Ember.Object.extend({uid:null,files:null,name:null,owner:null,editable:null,favorite:null,permissions:null,userIsOwner:null,init:function(){this.files=[]},addFile:function(file){var unique=true,i;if(this.files.length<30){for(i=0;i<this.files.length;i++){if(this.files[i].data===file.data&&this.files[i].uid===file.uid){unique=false}}if(unique){this.files.push(file);this.set("files",[].concat(this.files))}else{if(GliffyApp.modifyCustomLibraryController){GliffyApp.modifyCustomLibraryController.showErrorNotice("MODIFYLIBRARY_NOT_UNIQUE_TITLE")}}}else{if(GliffyApp.modifyCustomLibraryController){GliffyApp.modifyCustomLibraryController.showErrorNotice("MODIFYLIBRARY_MAX_SHAPES_TITLE")}}},removeFile:function(file){if(GliffyApp.modifyCustomLibraryController){GliffyApp.modifyCustomLibraryController.hideErrorNotice()}var i;for(i=0;i<this.files.length;i++){if(this.files[i]===file){this.files.splice(i,1);break}}},moveFile:function(file,index){var i;for(i=0;i<this.files.length;i++){if(this.files[i]===file){this.files.splice(i,1);this.files.splice(index,0,file);break}}}})}());(function(){GliffyApp.ModifyCustomLibraryController=Ember.ObjectController.extend({model:null,editor:null,init:function(){this.fileHandlerRegister=new _gliffy.FileHandlerRegister(null);$("body").on("click","#modifyCustomLibrary",function(){$("#customLibraryShapes .gliffy-custom-shape-preview.gliffy-selected").removeClass("gliffy-selected")})},actions:{editLibraryName:function(view){view.$().find(".gliffy-custom-name").hide();view.$().find(".gliffy-icon-library-pencil").hide();view.$().find(".gliffy-custom-name-field").show().focus().select()},editLibraryPermission:function(view){this.get("model").set("permissions",view.$().find(".gliffy-custom-library-edit-permission").val())},launchFileUpload:function(){$("#gliffyFileUploadInput").click()},persistLibraryChanges:function(view){if(view.validateName(this.get("model").get("name"),true)){this.persistLibraryChanges();$("#modifyCustomLibrary").modal("hide")}return false},hideNotice:function(event){$("#gliffy-custom-error-notice").hide()}},registerMouseClickState:function(){var self=this,$this,spacer,placeholder,bounds,containerWidth,containerHeight,calculatePlaces,places,positionPlaceholder,top,left,rows,index,doSelect,calculateRows,lastIndex,start,end;positionPlaceholder=function(event){var i,smallest,smallestIndex,diff;left=Math.min(Math.max(event.pageX-34,bounds.left),bounds.left+containerWidth-76);top=Math.min(Math.max(event.pageY-34,bounds.top),bounds.top+containerHeight);for(i=0;i<rows.length;i++){diff=Math.abs(rows[i]-top);if(smallest===undefined||diff<smallest){smallest=diff;smallestIndex=i}}top=rows[smallestIndex]-10;placeholder.css({position:"absolute",left:left,top:top,zIndex:590000})};calculateRows=function(draggable){rows=[];$("#customLibraryShapes").find(".gliffy-custom-shape-preview").each(function(index){var offset=$(this).offset();if(draggable.get(0)===this){lastIndex=index}if(index%10===0){rows.push(offset.top)}})};calculatePlaces=function(){places=[];$("#customLibraryShapes").find(".gliffy-custom-shape-preview").each(function(index){var offset=$(this).offset();places.push({top:offset.top,left:offset.left,elem:$(this)})})};_gliffy.Mouse.registerClickState({name:"customShapeModal",modes:["custom-shape-drag"],target:"#customLibraryShapes .gliffy-custom-shape-preview",mouseDown:function(event){var target=$(event.target);$this=$(event.currentTarget);if(target.hasClass("gliffy-icon-library-remove-shape")){self.get("model").removeFile($this.data("file"));$this.remove()}else{if(!$this.hasClass("gliffy-custom-shape-clone")){_gliffy.Mouse.setClickMode("customShapeModal");_gliffy.Mouse.setState("custom-shape-drag");_gliffy.Mouse.__mousedown(event)}}}});_gliffy.Mouse.registerDragState([{modes:["custom-shape-drag"],dragStart:function(event){start=new Date();$("#customLibraryShapes .gliffy-custom-shape-preview.gliffy-selected").removeClass("gliffy-selected");spacer=$("<div/>",{"class":"gliffy-custom-shape-spacer"});placeholder=$this.clone().addClass("gliffy-custom-shape-clone");if(placeholder.find("canvas").length>0){placeholder.find("canvas").get(0).getContext("2d").drawImage($this.find("canvas").get(0),0,0)}spacer.insertBefore($this);calculateRows($this);$this.detach();calculatePlaces();bounds=$("#customLibraryShapes").offset();containerWidth=$("#customLibraryShapes").width();containerHeight=$("#customLibraryShapes").height();positionPlaceholder(event);placeholder.css({left:spacer.offset().left});$("#gliffy").append(placeholder)},drag:function(event){var row=0,i,diff,smallestDiff;if(index!==undefined){lastIndex=index}index=-1;positionPlaceholder(event);if(places.length>0){spacer.remove();for(row=0;row<rows.length;row++){if(rows[row]-10===top){break}}for(i=10*row;i<places.length&&i<(10*row+10);i++){if(places[i]){diff=Math.abs(places[i].left-left);if(smallestDiff===undefined||diff<smallestDiff){smallestDiff=diff;index=i}}}if(index===-1){index=Math.max(0,row*10-1)}if(left-places[index].left>0){spacer.insertAfter(places[index].elem);index++}else{spacer.insertBefore(places[index].elem)}}},dragEnd:function(){spacer.replaceWith($this);placeholder.remove();end=new Date();if(end.getTime()-start.getTime()<500){$this.addClass("gliffy-selected")}else{self.get("model").moveFile($this.data("file"),index)}}}])},addModelObservers:function(){var self=this;this.get("model").addObserver("files",self,function(){self.renderPreview()});this.get("model").addObserver("name",self,function(){self.updateName()});this.get("model").addObserver("permissions",self,function(){$("#modifyCustomLibrary .gliffy-custom-library-edit-permission").val(self.get("model").get("permissions"))})},removeModelObservers:function(){if(this.get("model")){this.get("model").removeObserver("files");this.get("model").removeObserver("name");this.get("model").removeObserver("permissions")}},loadNewLibrary:function(){var self=this,model;self.removeModelObservers();this.set("model",GliffyApp.CustomLibraryDataModel.create({}));this.addModelObservers();model=this.get("model");model.set("permissions","everyone");model.set("editable",true);model.set("favorite",false);model.set("name",$.i18n._("MODIFYLIBRARY_PLACEHOLDER_TITLE"));model.set("files",[]);model.set("userIsOwner",true);self.renderPreview();$("#modifyCustomLibrary").modal("show")},loadLibrary:function(libraryUid){var self=this;this.editor.integration.getCustomLibrary(libraryUid,function(library){var model=GliffyApp.CustomLibraryDataModel.create({uid:library.uid});if(self.get("model")){self.removeModelObservers()}self.set("model",model);self.addModelObservers();model.set("owner",library.owner);model.set("name",library.name);model.set("files",library.shapes);model.set("editable",library.editable);model.set("favorite",library.favorite);model.set("permissions",library.permissions);model.set("userIsOwner",library.userIsOwner);$("#modifyCustomLibrary").modal("show")},function(){})},persistLibraryChanges:function(){var libraryModel=this.get("model"),library={};if(!libraryModel.get("uid")){library.shapes=libraryModel.get("files");library.name=libraryModel.get("name");library.owner=libraryModel.get("owner");library.permissions=libraryModel.get("permissions");this.editor.integration.createCustomLibrary(library,function(library){GliffyApp.shapeLibraryModel.addPanel(library.uid);_gliffy.Utils.analyticsEvent("trackEvent",{category:"customLibrary",action:"create"})},function(){_gliffy.Utils.notify("error",$.i18n._("MODIFYLIBRARY_ERROR_COULD_NOT_CREATE_TITLE"),$.i18n._("MODIFYLIBRARY_ERROR_COULD_NOT_CREATE_MESSAGE"))})}else{library.uid=libraryModel.get("uid");library.shapes=libraryModel.get("files");library.name=libraryModel.get("name");library.permissions=libraryModel.get("permissions");this.editor.integration.updateCustomLibrary(library,function(){GliffyApp.shapeLibraryModel.panelViewMap[library.uid].update(library);_gliffy.Utils.analyticsEvent("trackEvent",{category:"customLibrary",action:"update"})},function(){_gliffy.Utils.notify("error",$.i18n._("MODIFYLIBRARY_ERROR_COULD_NOT_UPDATE_TITLE"),$.i18n._("MODIFYLIBRARY_ERROR_COULD_NOT_UPDATE_MESSAGE"))})}},bindDragEvents:function(element){var self=this,inputId;if(element){element.ondragenter=function(){$(element).css("background","#EEE")};element.ondragleave=function(){$(element).css("background","white")};element.ondragover=function(e){$(element).css("background","#EEE");return false};element.ondragend=function(){return false};element.ondrop=function(e){e.preventDefault();$(element).css("background","white");var files,source,i,j,handler,file,fileHandlers=self.fileHandlerRegister.getFileHandlers(),url;if(e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length>0){files=(e.files||e.dataTransfer.files)}else{if(e.dataTransfer){files=[];try{source=e.dataTransfer.getData("text/html");url=_gliffy.Utils.getImageUrlFromHtml(source)}catch(error){source=e.dataTransfer.getData("TEXT");if(source!==null){url=_gliffy.Utils.getImageUrlFromHtml(source)}else{url=e.dataTransfer.getData("URL")}}if(url&&url.length>0){files.push({url:url,source:source,type:"url"})}}}for(i=0;i<files.length;i++){file=files[i];for(j=0;j<fileHandlers.length;j++){handler=fileHandlers[j];if(handler.canHandleFile(file)){handler.handleCustomLibraryUpload(file,i,self.get("model"));break}}}return false}}inputId=document.getElementById("gliffyFileUploadInput");if(inputId){inputId.addEventListener("change",function(e){var files=e.target.files,file,handler,fileHandlers=self.fileHandlerRegister.getFileHandlers(),i,j;for(i=0;i<files.length;i++){file=files[i];for(j=0;j<fileHandlers.length;j++){handler=fileHandlers[j];if(handler.canHandleFile(file)){handler.handleCustomLibraryUpload(file,i,self.get("model"));break}}}},false)}},generateSvgPreview:function(model,preview){var self=this,width=50,height=50;_gliffy.shapeLibrary.loadSvgStencil(model.data).then(function(){var dim=_gliffy.shapeLibrary.svgDim[model.data],canvas=$("<canvas/>"),ctx=canvas.get(0).getContext("2d"),ratioW=dim.width/dim.height,ratioH=dim.height/dim.width,offsetX=0,offsetY=0;if(ratioW>ratioH){ratioW=1;offsetY=(height-ratioH*height)/2}else{ratioH=1;offsetX=(width-ratioW*width)/2}ctx.canvas.width=width;ctx.canvas.height=height;if(_gliffy.shapeLibrary.canDrawStencil(model.data)){ctx.translate(offsetX,offsetY);ctx.scale(width*ratioW/dim.width,height*ratioH/dim.height);ctx.translate(-dim.x,-dim.y);_gliffy.shapeLibrary.drawStencil(model.data,ctx,{width:width,height:height,gradient:false,stroke:"black",fill:"black"})}preview.append(canvas)},function(){self.get("model").removeFile(model);var notice=$("#gliffy-custom-error-notice");notice.find(".alert").removeClass("alert-error").addClass("alert-info");notice.find(".gliffy-error-message").text($.i18n._("MODIFYLIBRARY_ERROR_CANT_CONVERT"));notice.show();setTimeout(function(){preview.remove()},1)})},showErrorNotice:function(i18nKey){var notice=$("#gliffy-custom-error-notice");notice.find(".alert").removeClass("alert-error").addClass("alert-info");notice.find(".gliffy-error-message").text($.i18n._(i18nKey));notice.show()},hideErrorNotice:function(){var previousError=$("#gliffy-custom-error-notice");if(previousError.length>0){previousError.hide()}},updateName:function(){$("#modifyCustomLibrary .gliffy-custom-name").text(this.get("model").get("name"));$("#modifyCustomLibrary .gliffy-custom-name-field").val(this.get("model").get("name"))},renderCustomPreview:function(container,shapes){var i,model,params,shape,image;for(i=0;i<shapes.length;i++){model=shapes[i];params={uid:model.uid};shape=$("<div/>",{"class":"gliffy-custom-shape-preview"});shape.append($("<i/>",{"class":"gliffy-icon-library-remove-shape"}));if(model.uid==="com.gliffy.shape.basic.basic_v1.default.svg"){params=$.extend(params,{svg:model.data});this.generateSvgPreview(model,shape)}else{if(model.uid==="com.gliffy.shape.basic.basic_v1.default.image"){params=$.extend(params,{image:model.data,thumbnail:model.thumbnail,doNotProxyImage:true});image=$("<div/>").css({"background-image":"url("+model.thumbnail+")",width:50,height:50,"background-size":"cover"});shape.append(image)}else{shape.append($("<div/>",{"class":model.uid.split(".").join("-").split("_").join("-")}))}}shape.data({uid:model.uid,params:params,file:model});container.append(shape)}},renderPreview:function(){var container=$("#customLibraryShapes");container.empty();this.renderCustomPreview(container,this.get("model").get("files"))}})}());(function(){GliffyApp.ManageShapeLibraryController=Ember.ObjectController.extend({model:null,editor:null,limit:30,favoriteOffset:0,listOffset:0,init:function(){this.spinner=_gliffy.Spinner.createSpinner()},actions:{logMoreClick:function(){_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeLibraryMoreShapes",action:"show"})},togglePanels:function(){if($("#gliffy-symbol-library").find(".accordion-toggle.opened").length>0){this.collapsePanels()}else{this.expandPanels()}},addNewLibrary:function(){GliffyApp.modifyCustomLibraryController.loadNewLibrary();_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeLibraryAddCustom",action:"show"})},removePanel:function(view){this.removePanel(view);$(".tooltip.right").remove();_gliffy.Utils.analyticsEvent("trackEvent",{category:"removePanel",action:view.uid})},loadMoreFavorites:function(view){this.updateFavoriteLibraryList(view);return false}},expandPanels:function(){$("#gliffy-symbol-library").find(".accordion-toggle").each(function(){var link=$(this);if(!link.hasClass("opened")){link.click()}});$(".gliffy-sidebar-btns").find(".gliffy-toggle-panels i").removeClass().addClass("gliffy-icon-sidebar-hide-all-white");_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeLibraryToggleAllPanels",action:"expand"})},collapsePanels:function(){$("#gliffy-symbol-library").find(".accordion-toggle.opened").click();$(".gliffy-sidebar-btns").find(".gliffy-toggle-panels i").removeClass().addClass("gliffy-icon-sidebar-show-all-white");_gliffy.Utils.analyticsEvent("trackEvent",{category:"shapeLibraryToggleAllPanels",action:"collapse"})},removePanel:function(view){GliffyApp.shapeLibraryModel.removePanel(view.uid);Ember.View.views["gliffy-symbol-library"].removeChild(view)},removePanelByLibraryId:function(libraryId){var elem=$("#gliffy-symbol-library").find("div[data-uid='"+libraryId+"']");this.removePanel(Ember.View.views[elem.attr("id")])},customShapesEnabled:function(){return this.editor.enableCustomShapes},imagePanelEnabled:function(){return this.editor.enableImagePanel},showTables:function(){return _gliffy.FEATURES.tables},showTablesV2:function(){return _gliffy.FEATURES.tables_v2},showUmlV1:function(){return _gliffy.FEATURES.umlV1},showUmlV2:Ember.computed(function(){return _gliffy.FEATURES.umlV2}).property(),showUIV2:function(){return _gliffy.FEATURES.uiV2},showUIV3:Ember.computed(function(){return _gliffy.FEATURES.uiV3}).property(),showMindmaps:Ember.computed(function(){return _gliffy.FEATURES.mindmaps}).property(),updateCustomLibraryList:function(view){var limit=this.get("limit"),self=this,listOffset=self.get("listOffset"),moreButton=$("#manageLibrary .gliffy-load-more-libraries");this.editor.integration.getCustomLibraryList(limit,listOffset,function(list){if(list&&list.length>0){if(listOffset===0){view.set("libraries",Ember.A(list))}else{view.set("libraries",Ember.A(view.get("libraries").toArray().concat(list)))}if(list.length===limit){moreButton.show()}else{moreButton.hide()}self.set("listOffset",listOffset+list.length)}else{if(listOffset===0){view.set("libraries",null)}moreButton.hide()}},function(){moreButton.hide();self.set("listOffset",0);view.set("libraries",null)})},updateFavoriteLibraryList:function(view){var limit=this.get("limit"),self=this,listOffset=self.get("favoriteOffset"),moreButton=$("#manageLibrary .gliffy-load-more-favorites");this.editor.integration.getFavoriteLibraryList(limit,listOffset,function(list){if(list&&list.length>0){if(listOffset===0){view.set("favoriteLibraries",Ember.A(list))}else{view.set("favoriteLibraries",Ember.A(view.get("favoriteLibraries").toArray().concat(list)))}if(list.length===limit){moreButton.show()}else{moreButton.hide()}self.set("favoriteOffset",listOffset+list.length)}else{if(listOffset===0){view.set("favoriteLibraries",null)}moreButton.hide()}},function(){moreButton.hide();self.set("favoriteOffset",0);view.set("favoriteLibraries",null)})},populateCustomLibraryList:function(view){this.updateCustomLibraryList(view);this.updateFavoriteLibraryList(view)},renderCustomLibraryPreview:function(library,container){var self=this;container.empty();this.spinner.spin(container.get(0));this.editor.integration.getCustomShapes(library,function(shapes){container.empty();self.renderCustomPreview(shapes,container)},function(){container.empty()})},generateSvgPreview:function(svg,preview){var model={data:svg,width:50,height:50};_gliffy.shapeLibrary.loadSvgStencil(model.data).then(function(){var dim=_gliffy.shapeLibrary.svgDim[model.data],canvas=$("<canvas/>"),ctx=canvas.get(0).getContext("2d"),ratioW=dim.width/dim.height,ratioH=dim.height/dim.width,offsetX=0,offsetY=0;if(ratioW>ratioH){ratioW=1;offsetY=(model.height-ratioH*model.height)/2}else{ratioH=1;offsetX=(model.width-ratioW*model.width)/2}ctx.canvas.width=model.width;ctx.canvas.height=model.height;if(_gliffy.shapeLibrary.canDrawStencil(model.data)){ctx.translate(offsetX,offsetY);ctx.scale(model.width*ratioW/dim.width,model.height*ratioH/dim.height);ctx.translate(-dim.x,-dim.y);_gliffy.shapeLibrary.drawStencil(model.data,ctx,{width:model.width,height:model.height,gradient:false,stroke:"black",fill:"black"})}preview.append(canvas)})},renderCustomPreview:function(shapes,container){var i,model,shape,image;for(i=0;i<shapes.length;i++){model=shapes[i];shape=$("<div/>",{"class":"gliffy-custom-shape-preview"});if(model.uid==="com.gliffy.shape.basic.basic_v1.default.svg"){this.generateSvgPreview(model.data,shape)}else{if(model.uid==="com.gliffy.shape.basic.basic_v1.default.image"){image=$("<div/>").css({"background-image":"url("+model.thumbnail+")",width:50,height:50,"background-size":"cover"});shape.append(image)}else{shape.append($("<div/>",{"class":model.uid.split(".").join("-").split("_").join("-")}))}}container.append(shape)}},renderGliffyLibraryPreview:function(libraries){var self=this,preview=$("#manageLibrary .gliffy-shape-preview-container"),shapePreview;preview.empty();_gliffy.shapeLibrary.loaded.then(function(){var j,i,library,shape;for(j=0;j<libraries.length;j++){library=_gliffy.shapeLibrary.libraries[libraries[j]];preview.append($('<h4 data-uid="'+libraries[j]+'"/>').text($.i18n._(library.uid)).css({clear:"both"}));for(i=0;library.shapes&&i<library.shapes.length;i++){shapePreview=_gliffy.shapeLibrary.shapes[library.shapes[i]];shape=self.renderGliffyLibraryShape(library.shapes[i]);shape.css({width:library.iconWidth,height:library.iconHeight});preview.append(shape);if(shapePreview.preview.type==="svg"){self.generateGliffySvgPreview(shapePreview,shape)}}}$(window).trigger("gliffy_libraryPreviewGenerated")})},generateGliffySvgPreview:function(model,preview){var width=model.defaults.width,height=model.defaults.height,canvas=$("<canvas/>"),ctx=canvas.get(0).getContext("2d"),size=40,canvasSize=model.preview.iconWidth,offsetX,offsetY,stage=new _gliffy.Stage(),node=new _gliffy.Node(stage),shape,tid,shapeStyle;ctx.canvas.width=canvasSize;ctx.canvas.height=canvasSize;if(width>height){if(width>size){height=size*(height/width);width=size}}else{if(height>size){width=size*(width/height);height=size}}offsetY=(canvasSize-height)/2;offsetX=(canvasSize-width)/2;node.setUid(model.uid);node.setWidth(width);node.setHeight(height);node.setX(offsetX);node.setY(offsetY);shape=new _gliffy.Shape(node);node.setGraphic(shape);tid=_gliffy.shapeLibrary.shapes[model.uid].tids[0];node.getGraphic().setTid(tid);shapeStyle=new _gliffy.ShapeStyle();shapeStyle.fromObject(node.getShapeInformation().defaults);node.getGraphic().applyStyle(shapeStyle);node.update();node.getGraphic().style.single_canvas=true;_gliffy.renderers[_gliffy.Renderer.ShapeCanvas.prototype.id].render({target:ctx,object:node.getGraphic(),renderCallback:function(){preview.append(canvas)}})},renderGliffyLibraryShape:function(uid){return $("<div/>",{"class":uid.split(".").join("-").split("_").join("-")+" gliffy-shape-preview"})}})}());(function(){_gliffy.Plugins.create({activate:function(editor){GliffyApp.manageShapeLibraryController=GliffyApp.ManageShapeLibraryController.create({editor:editor});if(editor.enableCustomShapes){GliffyApp.modifyCustomLibraryController=GliffyApp.ModifyCustomLibraryController.create({editor:editor});if(GliffyApp.modifyCustomLibraryView){GliffyApp.modifyCustomLibraryView.set("theController",GliffyApp.modifyCustomLibraryController)}}if(GliffyApp.requestShapeLibraryView){GliffyApp.requestShapeLibraryView.set("appId",editor.analyticsProduct)}},initTemplates:function(){var popupContainer=Ember.View.views["gliffy-popup-container"];if(Ember.View.views["gliffy-sidebar"]){Ember.View.views["gliffy-sidebar"].pushObject(GliffyApp.ManageShapeLibraryButtonView.create({}))}if(popupContainer){popupContainer.pushObject(GliffyApp.ManageShapeLibraryView.create({}));GliffyApp.requestShapeLibraryView=GliffyApp.RequestShapeLibraryView.create({});popupContainer.pushObject(GliffyApp.requestShapeLibraryView);GliffyApp.requestShapeLibrarySendView=GliffyApp.RequestShapeLibrarySendView.create({});popupContainer.pushObject(GliffyApp.requestShapeLibrarySendView);GliffyApp.modifyCustomLibraryView=GliffyApp.ModifyCustomLibraryView.create({});popupContainer.pushObject(GliffyApp.modifyCustomLibraryView)}},getTemplateNames:function(){return["manage-shape-library-button","manage-shape-library","modify-custom-library"]},getName:function(){return"ManageShapeLibrary"}})}());(function(){GliffyApp.SwimlaneTabController=Ember.ObjectController.extend({actions:{selectLaneNumber:function(val){GliffyApp.contextualPropertiesController.updateShapeTabProperty("Lanes",Number(val),this.name);_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"selectLane",value:Number(val)});$("#gliffy-contextual-properties-lanes").click()}}})}());(function(){GliffyApp.SwimlaneTabView=Ember.View.extend({tagName:"div",elementId:"gliffy-swimlane-tab",templateName:"swimlane-tab",classNames:[],clickDropdown:function(e){var domId=e.currentTarget.getAttribute("id"),dropdownContainer=$(e.currentTarget).parent(),dropdown=dropdownContainer.children("ul");GliffyApp.contextualPropertiesController.resetDialogControls(domId);if(this.__isDropdownBelowFold(dropdownContainer,dropdown)){dropdown.css("top",-(dropdown.height()+12))}else{dropdown.css("top","100%")}$(e.currentTarget).tooltip("hide");e.preventDefault()},__isDropdownBelowFold:function(dropdownContainer,dropdown){return(dropdownContainer.offset().top+dropdownContainer.height()+dropdown.height()>$(window).height())},didInsertElement:function(){var self=this;$("#gliffy-contextual-properties-lanes").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-contextual-properties-lanes").on("click",function(e){self.clickDropdown(e)})}})}());(function(){_gliffy.Plugins.create({activate:function(editor){GliffyApp.swimlaneTabController=GliffyApp.SwimlaneTabController.create({name:this.getName()})},getCustomTabView:function(){return GliffyApp.SwimlaneTabView.create({name:this.getName()})},doCustomUpdate:function(prop,value,editor,node){switch(prop){case"Lanes":editor.overlayManager.deselectAll();editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateLaneNumberCommand({node:node,lanes:value}));editor.overlayManager.selectNode(node);break}},initTemplates:function(){},getTemplateNames:function(){return["swimlane-tab"]},getName:function(){return"SwimlaneTab"}})}());(function(){GliffyApp.SelectedTabView=Ember.View.extend({tagName:"div",elementId:"gliffy-selected-tab",templateName:"selected-tab",classNames:[],didInsertElement:function(){var self=this;$("#gliffy-contextual-properties-span-state").on("click",function(e){self.clickStateCheckbox(e)})},shapeStateBooleanBinding:Ember.Binding.oneWay("GliffyApp.overlayModel.shapeStateBoolean"),clickStateCheckbox:function(e){GliffyApp.contextualPropertiesController.resetDialogControls();GliffyApp.contextualPropertiesController.updateShapeTabProperty("State",Number($("#gliffy-contextual-properties-span-state input").prop("checked")))}})}());(function(){_gliffy.Plugins.create({activate:function(editor){},getCustomTabView:function(){return GliffyApp.SelectedTabView.create({name:this.getName()})},doCustomUpdate:function(prop,value,editor,node){},initTemplates:function(){},getTemplateNames:function(){return["selected-tab"]},getName:function(){return"SelectedTab"}})}());(function(){var MAX_SIZE=20;GliffyApp.ContextualPropertiesTextFieldSelectedTabV2Items=GliffyApp.ContextualPropertiesTextField.extend({propertyKey:"Items",valueBinding:Ember.Binding.oneWay("GliffyApp.selectedTabV2Model.itemsValue"),oldValueBinding:Ember.Binding.oneWay("GliffyApp.selectedTabV2Model.itemsValue"),__commit:function(prop,value){if(value.length===0){value=$("#gliffy-selected-tab-v2-items").val()}if(value.length>0){value=Number(value);value=parseInt(value,10);if(!isNaN(value)&&value>0&&value<=MAX_SIZE){if(parseInt(this.value,10)!==parseInt(this.oldValue,10)){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"type"+_gliffy.Utils.capitalize(prop),value:parseInt(this.value,10)});GliffyApp.contextualPropertiesController.updateShapeTabProperty(prop,value,"SelectedTabV2")}}else{this.__rollback()}}},__rollback:function(){this.set("value",GliffyApp.selectedTabV2Model.get("itemsValue"))}});GliffyApp.ContextualPropertiesTextFieldSelectedTabV2Selected=GliffyApp.ContextualPropertiesTextField.extend({propertyKey:"Selected",valueBinding:Ember.Binding.oneWay("GliffyApp.selectedTabV2Model.selectedValue"),oldValueBinding:Ember.Binding.oneWay("GliffyApp.selectedTabV2Model.selectedValue"),__commit:function(prop,value){if(value.length===0){value=$("#gliffy-selected-tab-v2-selected").val()}if(value.length>0){value=Number(value);value=parseInt(value,10);if(!isNaN(value)&&value>=0&&value<=MAX_SIZE&&value<=GliffyApp.selectedTabV2Model.get("itemsValue")){if(value!==parseInt(this.oldValue,10)){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"type"+_gliffy.Utils.capitalize(prop),value:value});GliffyApp.contextualPropertiesController.updateShapeTabProperty(prop,value,"SelectedTabV2")}}else{this.__rollback()}}},__rollback:function(){this.set("value",GliffyApp.selectedTabV2Model.get("selectedValue"))}});GliffyApp.SelectedTabViewV2=Ember.View.extend({tagName:"div",elementId:"gliffy-selected-tab-v2",templateName:"selected-tab-v2",classNames:[],selectedColorBinding:Ember.Binding.oneWay("GliffyApp.selectedTabV2Model.selectedColor"),selectedColorStyle:Ember.computed(function(){return"background-color:"+this.get("selectedColor")}).property("selectedColor"),clickColorButton:function(e){GliffyApp.colorpickerController.toggleColorSwatchPicker(e.currentTarget,GliffyApp.contextualPropertiesController);e.preventDefault()},didInsertElement:function(){var self=this;$("#gliffy-contextual-properties-highlight-button").on("click",function(e){self.clickColorButton(e)})}})}());(function(){_gliffy.BaseNavbarSelectedTabV2=_gliffy.Class.extend({selectedColor:null,deselectedColor:null,getItems:function(node){return node.children.length},getSelected:function(node){for(var i=0;i<node.children.length;i++){if(node.children[i].getGraphic().getState()===1){return i+1}}return 0},getSelectedColor:function(node){var selected=this.getSelected(node);return selected===0?this.selectedColor:node.children[selected-1].getGraphic().getFillColor()},getUid:function(){console.error("this method must be redefined in the subclass")},updateItems:function(prop,value,editor,node){console.error("this method must be redefined in the subclass")},updateSelected:function(prop,value,editor,node){if(value!==this.getSelected(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateNavbarCommand({node:node,cellCount:GliffyApp.selectedTabV2Model.get("itemsValue"),selected:value,selectedColor:this.selectedColor,deselectedColor:this.deselectedColor}));GliffyApp.selectedTabV2Model.set("selectedValue",value)}},updateSelectedColor:function(prop,value,editor,node){var selected=this.getSelected(node);if(selected>0){editor.getDocumentManager().addAndExecuteCommand(_gliffy.SetFillColorCommand({node:node.children[selected-1],fillColor:value,selectedColor:this.selectedColor,deselectedColor:this.deselectedColor}))}GliffyApp.selectedTabV2Model.set("selectedColor",value)}})}());(function(){_gliffy.AndroidTabs02SelectedTabV2=_gliffy.BaseNavbarSelectedTabV2.extend({selectedColor:"#2094f2",deselectedColor:"none",getUid:function(){return"com.gliffy.shape.android.android_v1.general.tabs02"},updateItems:function(prop,value,editor,node){if(value!==this.getItems(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateAndroidTabs02Command({node:node,cellCount:value,selected:GliffyApp.selectedTabV2Model.get("selectedValue"),selectedColor:this.selectedColor,deselectedColor:this.deselectedColor}));GliffyApp.selectedTabV2Model.set("itemsValue",value)}},updateSelected:function(prop,value,editor,node){if(value!==this.getSelected(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateAndroidTabs02Command({node:node,cellCount:GliffyApp.selectedTabV2Model.get("itemsValue"),selected:value,selectedColor:this.selectedColor,deselectedColor:this.deselectedColor}));GliffyApp.selectedTabV2Model.set("selectedValue",value)}}})}());(function(){var SELECTED_COLOR="#EEEEEE",DESELECTED_COLOR="#FFFFFF";_gliffy.DropdownSelectedTabV2=_gliffy.Class.extend({init:function(){},getItems:function(node){return node.children.length},getSelected:function(node){for(var i=0;i<node.children.length;i++){if(node.children[i].getGraphic().getState()===1){return i+1}}return 0},getSelectedColor:function(node){var selected=this.getSelected(node);return selected===0?SELECTED_COLOR:node.children[selected-1].getGraphic().getFillColor()},getUid:function(){return"com.gliffy.shape.ui.ui_v3.forms_controls.dropdown"},updateItems:function(prop,value,editor,node){if(value!==this.getItems(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateDropdownCommand({node:node,cells:value,selected:GliffyApp.selectedTabV2Model.get("selectedValue")}));GliffyApp.selectedTabV2Model.set("itemsValue",value);GliffyApp.selectedTabV2Model.set("selectedValue",this.getSelected(node))}},updateSelected:function(prop,value,editor,node){if(value!==this.getSelected(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateDropdownCommand({node:node,cells:GliffyApp.selectedTabV2Model.get("itemsValue"),selected:value}));GliffyApp.selectedTabV2Model.set("selectedValue",value)}},updateSelectedColor:function(prop,value,editor,node){var selected=this.getSelected(node);if(selected>0){editor.getDocumentManager().addAndExecuteCommand(_gliffy.SetFillColorCommand({node:node.children[selected-1],fillColor:value}))}GliffyApp.selectedTabV2Model.set("selectedColor",value)}})}());(function(){var SELECTED_COLOR="#DBEEFB",DESELECTED_COLOR="#FFFFFF";_gliffy.NavbarSelectedTabV2=_gliffy.Class.extend({init:function(){},getItems:function(node){return node.children.length},getSelected:function(node){for(var i=0;i<node.children.length;i++){if(node.children[i].getGraphic().getState()===1){return i+1}}return 0},getSelectedColor:function(node){var selected=this.getSelected(node);return selected===0?SELECTED_COLOR:node.children[selected-1].getGraphic().getFillColor()},getUid:function(){return"com.gliffy.shape.ui.ui_v3.navigation.navbar"},updateItems:function(prop,value,editor,node){if(value!==this.getItems(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateNavbarCommand({node:node,cellCount:value,selected:GliffyApp.selectedTabV2Model.get("selectedValue")}));GliffyApp.selectedTabV2Model.set("itemsValue",value);GliffyApp.selectedTabV2Model.set("selectedValue",this.getSelected(node))}},updateSelected:function(prop,value,editor,node){if(value!==this.getSelected(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateNavbarCommand({node:node,cellCount:GliffyApp.selectedTabV2Model.get("itemsValue"),selected:value}));GliffyApp.selectedTabV2Model.set("selectedValue",value)}},updateSelectedColor:function(prop,value,editor,node){var selected=this.getSelected(node);if(selected>0){editor.getDocumentManager().addAndExecuteCommand(_gliffy.SetFillColorCommand({node:node.children[selected-1],fillColor:value}))}GliffyApp.selectedTabV2Model.set("selectedColor",value)}})}());(function(){var SELECTED_COLOR="#EEEEEE",DESELECTED_COLOR="#FFFFFF";_gliffy.NavbarVerticalSelectedTabV2=_gliffy.Class.extend({init:function(){},getItems:function(node){return node.children.length},getSelected:function(node){for(var i=0;i<node.children.length;i++){if(node.children[i].getGraphic().getState()===1){return i+1}}return 0},getSelectedColor:function(node){var selected=this.getSelected(node);return selected===0?SELECTED_COLOR:node.children[selected-1].getGraphic().getFillColor()},getUid:function(){return"com.gliffy.shape.ui.ui_v3.navigation.navbar_vertical"},updateItems:function(prop,value,editor,node){if(value!==this.getItems(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateNavbarVerticalCommand({node:node,cells:value,selected:GliffyApp.selectedTabV2Model.get("selectedValue")}));GliffyApp.selectedTabV2Model.set("itemsValue",value);GliffyApp.selectedTabV2Model.set("selectedValue",this.getSelected(node))}},updateSelected:function(prop,value,editor,node){if(value!==this.getSelected(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateNavbarVerticalCommand({node:node,cells:GliffyApp.selectedTabV2Model.get("itemsValue"),selected:value}));GliffyApp.selectedTabV2Model.set("selectedValue",value)}},updateSelectedColor:function(prop,value,editor,node){var selected=this.getSelected(node);if(selected>0){editor.getDocumentManager().addAndExecuteCommand(_gliffy.SetFillColorCommand({node:node.children[selected-1],fillColor:value}))}GliffyApp.selectedTabV2Model.set("selectedColor",value)}})}());(function(){_gliffy.TabBarSelectedTabV2=_gliffy.BaseNavbarSelectedTabV2.extend({selectedColor:"#DDDEDE",deselectedColor:"none",getUid:function(){return"com.gliffy.shape.iphone.iphone_ios7.navigation.tab_bar"},updateItems:function(prop,value,editor,node){if(value!==this.getItems(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateNavbarCommand({node:node,cellCount:value,selected:GliffyApp.selectedTabV2Model.get("selectedValue"),selectedColor:this.selectedColor,deselectedColor:this.deselectedColor,tids:{first:"com.gliffy.stencil.rectangle.fill_line_top",middle:"com.gliffy.stencil.rectangle.fill_line_top",last:"com.gliffy.stencil.rectangle.fill_line_top",single:"com.gliffy.stencil.rectangle.fill_line_top"}}));GliffyApp.selectedTabV2Model.set("itemsValue",value)}}})}());(function(){_gliffy.Navigation3TabsSelectedTabV2=_gliffy.BaseNavbarSelectedTabV2.extend({selectedColor:"#0080ff",deselectedColor:"#FFFFFF",getUid:function(){return"com.gliffy.shape.iphone.iphone_ios7.navigation.nav_3tabs"},updateItems:function(prop,value,editor,node){if(value!==this.getItems(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateNavbarCommand({node:node,cellCount:value,selected:GliffyApp.selectedTabV2Model.get("selectedValue"),selectedColor:this.selectedColor,deselectedColor:this.deselectedColor}));GliffyApp.selectedTabV2Model.set("itemsValue",value)}}})}());(function(){GliffyApp.SelectedTabV2Model=Ember.Object.extend({itemsValue:null,selectedValue:null,selectedColor:null,init:function(){}})}());(function(){_gliffy.Plugins.create({registry:null,activate:function(editor){this.registry={};this.ANDROID_TABS02=new _gliffy.AndroidTabs02SelectedTabV2();this.DROPDOWN=new _gliffy.DropdownSelectedTabV2();this.NAV_3TABS=new _gliffy.Navigation3TabsSelectedTabV2();this.NAVBAR=new _gliffy.NavbarSelectedTabV2();this.NAVBAR_VERTICAL=new _gliffy.NavbarVerticalSelectedTabV2();this.TAB_BAR=new _gliffy.TabBarSelectedTabV2();this.registry[this.ANDROID_TABS02.getUid()]=this.ANDROID_TABS02;this.registry[this.DROPDOWN.getUid()]=this.DROPDOWN;this.registry[this.NAV_3TABS.getUid()]=this.NAV_3TABS;this.registry[this.NAVBAR.getUid()]=this.NAVBAR;this.registry[this.NAVBAR_VERTICAL.getUid()]=this.NAVBAR_VERTICAL;this.registry[this.TAB_BAR.getUid()]=this.TAB_BAR;GliffyApp.selectedTabV2Model=GliffyApp.SelectedTabV2Model.create({})},getCustomTabView:function(node){var handler=this.registry[node.getUid()],items,selected,selectedColor,view;if(handler.getItems){items=handler.getItems(node)}if(handler.getSelected){selected=handler.getSelected(node)}if(handler.getSelectedColor){selectedColor=handler.getSelectedColor(node)}if(items){GliffyApp.selectedTabV2Model.set("itemsValue",items)}if(selected){GliffyApp.selectedTabV2Model.set("selectedValue",selected)}if(selectedColor){GliffyApp.selectedTabV2Model.set("selectedColor",selectedColor)}view=GliffyApp.SelectedTabViewV2.create({name:this.getName()});return view},doCustomUpdate:function(prop,value,editor,node){var handler=this.registry[node.getUid()];switch(prop){case"Items":handler.updateItems(prop,value,editor,node);break;case"Selected":handler.updateSelected(prop,value,editor,node);break;case"SelectedColor":handler.updateSelectedColor(prop,value,editor,node);break}},initTemplates:function(){},getTemplateNames:function(){return["selected-tab-v2"]},getName:function(){return"SelectedTabV2"}})}());(function(){var MAX_SIZE=20;GliffyApp.ContextualPropertiesTextFieldElementCountTabItems=GliffyApp.ContextualPropertiesTextField.extend({propertyKey:"Items",valueBinding:Ember.Binding.oneWay("GliffyApp.elementCountTabModel.itemsValue"),oldValueBinding:Ember.Binding.oneWay("GliffyApp.elementCountTabModel.itemsValue"),__commit:function(prop,value){if(value.length===0){value=$("#gliffy-element-count-tab-items").val()}if(value.length>0){value=Number(value);value=parseInt(value,10);if(!isNaN(value)&&value>0&&value<=MAX_SIZE){if(parseInt(this.value,10)!==parseInt(this.oldValue,10)){_gliffy.Utils.analyticsEvent("trackEvent",{category:"contextualProperties",action:"type"+_gliffy.Utils.capitalize(prop),value:parseInt(this.value,10)});GliffyApp.contextualPropertiesController.updateShapeTabProperty(prop,value,"ElementCountTab")}}else{this.__rollback()}}},__rollback:function(){this.set("value",GliffyApp.elementCountTabModel.get("itemsValue"))}});GliffyApp.ElementCountTabView=Ember.View.extend({tagName:"div",elementId:"gliffy-element-count-tab",templateName:"element-count-tab",classNames:[],didInsertElement:function(){}})}());(function(){_gliffy.AndroidList1LineElementCountTab=_gliffy.Class.extend({getItems:function(node){var listChild;listChild=node.children[0];return listChild.children.length},getUid:function(){return"com.gliffy.shape.android.android_v1.general.list_1line"},updateItems:function(prop,value,editor,node){if(value!==this.getItems(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateAndroidList1LineCommand({node:node.children[0],cellCount:value}));GliffyApp.elementCountTabModel.set("itemsValue",value)}}})}());(function(){_gliffy.AndroidList2LineElementCountTab=_gliffy.Class.extend({getItems:function(node){var listChild;listChild=node.children[0];return listChild.children.length},getUid:function(){return"com.gliffy.shape.android.android_v1.general.list_2lines"},updateItems:function(prop,value,editor,node){if(value!==this.getItems(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateAndroidList2LineCommand({node:node.children[0],cellCount:value}));GliffyApp.elementCountTabModel.set("itemsValue",value)}}})}());(function(){_gliffy.AndroidTabs01ElementCountTab=_gliffy.Class.extend({getItems:function(node){return node.children.length},getUid:function(){return"com.gliffy.shape.android.android_v1.general.tabs01"},updateItems:function(prop,value,editor,node){if(value!==this.getItems(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateAndroidTabs01Command({node:node,cellCount:value}));GliffyApp.elementCountTabModel.set("itemsValue",value)}}})}());(function(){_gliffy.ButtonStackElementCountTab=_gliffy.Class.extend({getItems:function(node){return node.children.length},getSelected:function(node){return 0},getSelectedColor:function(node){return"#FFFFFF"},getUid:function(){return"com.gliffy.shape.iphone.iphone_ios7.forms_controls.button_stack"},updateItems:function(prop,value,editor,node){if(value!==this.getItems(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateButtonStackCommand({node:node,cellCount:value}));GliffyApp.elementCountTabModel.set("itemsValue",value)}}})}());(function(){_gliffy.IphoneContextualMenuElementCountTab=_gliffy.Class.extend({getItems:function(node){return node.children[0].children.length},getSelected:function(node){return 0},getSelectedColor:function(node){return"#FFFFFF"},getUid:function(){return"com.gliffy.shape.iphone.iphone_ios7.navigation.contextual_menu"},updateItems:function(prop,value,editor,node){if(value!==this.getItems(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateIphoneContextualMenuCommand({node:node,cellCount:value}));GliffyApp.elementCountTabModel.set("itemsValue",value)}}})}());(function(){_gliffy.IphoneTableElementCountTab=_gliffy.Class.extend({getItems:function(node){return node.children.length},getUid:function(){return"com.gliffy.shape.iphone.iphone_ios7.containers_content.table"},updateItems:function(prop,value,editor,node){if(value!==this.getItems(node)){editor.getDocumentManager().addAndExecuteCommand(new _gliffy.UpdateIphoneTableCommand({node:node,cellCount:value}));GliffyApp.elementCountTabModel.set("itemsValue",value)}}})}());(function(){GliffyApp.ElementCountTabModel=Ember.Object.extend({itemsValue:null,init:function(){}})}());(function(){_gliffy.Plugins.create({registry:null,activate:function(){this.registry={};this.ANDROID_LIST_1_LINE=new _gliffy.AndroidList1LineElementCountTab();this.ANDROID_LIST_2_LINE=new _gliffy.AndroidList2LineElementCountTab();this.ANDROID_TABS01=new _gliffy.AndroidTabs01ElementCountTab();this.BUTTON_STACK=new _gliffy.ButtonStackElementCountTab();this.CONTEXTUAL_MENU=new _gliffy.IphoneContextualMenuElementCountTab();this.IPHONE_TABLE=new _gliffy.IphoneTableElementCountTab();this.registry[this.ANDROID_LIST_1_LINE.getUid()]=this.ANDROID_LIST_1_LINE;this.registry[this.ANDROID_LIST_2_LINE.getUid()]=this.ANDROID_LIST_2_LINE;this.registry[this.ANDROID_TABS01.getUid()]=this.ANDROID_TABS01;this.registry[this.BUTTON_STACK.getUid()]=this.BUTTON_STACK;this.registry[this.CONTEXTUAL_MENU.getUid()]=this.CONTEXTUAL_MENU;this.registry[this.IPHONE_TABLE.getUid()]=this.IPHONE_TABLE;GliffyApp.elementCountTabModel=GliffyApp.ElementCountTabModel.create({})},getCustomTabView:function(node){var handler,items,view;handler=this.registry[node.getUid()];if(handler.getItems){items=handler.getItems(node)}if(items){GliffyApp.elementCountTabModel.set("itemsValue",items)}view=GliffyApp.ElementCountTabView.create({name:this.getName()});return view},doCustomUpdate:function(prop,value,editor,node){var handler=this.registry[node.getUid()];switch(prop){case"Items":handler.updateItems(prop,value,editor,node);break}},initTemplates:function(){},getTemplateNames:function(){return["element-count-tab"]},getName:function(){return"ElementCountTab"}})}());(function(){GliffyApp.OpacityWidgetView=Ember.View.extend({didInsertElement:function(){var editor=GliffyApp.contextualPropertiesController.getEditor();$(".gliffy-opacity-slider").slider({orientation:"vertical",min:5,max:100,tooltip:"hide"}).on("slide",function(e){GliffyApp.contextualPropertiesController.setPropertyFromSlider("Opacity",$(".gliffy-opacity-slider").slider("getValue").val())}).on("slideStart",function(){editor.getDocumentManager().pushCommandBundle()}).on("slideStop",function(){setTimeout(function(){GliffyApp.contextualPropertiesController.setPropertyFromSlider("Opacity",$(".gliffy-opacity-slider").slider("getValue").val());_gliffy.Utils.analyticsEvent("trackEvent",{category:"opacityWidget",action:"sliderStop"});editor.getDocumentManager().popCommandBundle()},10)})}});GliffyApp.OpacityWidgetTextFieldOpacity=GliffyApp.ContextualPropertiesTextField.extend({propertyKey:"Opacity",valueBinding:Ember.Binding.oneWay("GliffyApp.contextualPropertiesController.overlayOpacity"),oldValueBinding:Ember.Binding.oneWay("GliffyApp.contextualPropertiesController.overlayOpacity"),mouseDown:function(e){},__commit:function(prop,value){if(!isNaN(value)){value=Math.round(Number(value));if(value<5){value=5}if(value>100){value=100}this.set("value",value);$(".gliffy-opacity-slider").slider("setValue",value);this._super(this.propertyKey,value/100)}else{this.__rollback()}},__rollback:function(){this.set("value",GliffyApp.contextualPropertiesController.overlayOpacity);$(".gliffy-opacity-slider").slider("setValue",GliffyApp.contextualPropertiesController.overlayOpacity)}})}());(function(){_gliffy.Plugins.create({activate:function(editor){},initTemplates:function(){var view=GliffyApp.OpacityWidgetView.create({templateName:this.getTemplateNames()[0]});if(Ember.View.views["gliffy-popup-container"]){Ember.View.views["gliffy-popup-container"].pushObject(view)}},getTemplateNames:function(){return["gliffy-opacity-widget-template"]},getName:function(){return"OpacityWidget"}})}());(function(){_gliffy.Plugins.create({activate:function(editor){_gliffy.GliffyWars=new _gliffy._GliffyWars({editor:editor,container:$("#container")})},initTemplates:function(){var view=Ember.View.create({templateName:"gliffyWars-opening-template"});if(Ember.View.views["gliffy-popup-container"]){Ember.View.views["gliffy-popup-container"].pushObject(view)}},getName:function(){return"GliffyWars"}})}());(function(){var GAME_MODE={gameOver:"gameOver",intro:"intro",play:"play",win:"win"};var MAX_AMMO=5;_gliffy._GliffyWars=_gliffy.Class.extend({_editor:null,_debug:false,_cheatBuffer:"",_cheatAnswer:"uuddlrlrba",_shipData:{},_asteroidData:{},_sfx:{},_ammoData:[],_gameMode:GAME_MODE.intro,_domStage:null,_score:0,_invincible:true,_numAsteroids:0,_startTime:0,_boomTimeout:-1,_shoot:function(){var ammoData=this._getAmmo();if(ammoData){var rad=_gliffy.Utils.degreesToRadians(this._shipData.node.getRotation());ammoData.velocity=new _gliffy.Vec2(Math.sin(rad)*5,-Math.cos(rad)*5);ammoData.node.setX(this._shipData.node.getX()+this._shipData.node.getWidth()*0.5-ammoData.node.getWidth()*0.5);ammoData.node.setY(this._shipData.node.getY()+this._shipData.node.getHeight()*0.5-ammoData.node.getHeight()*0.5);this._playSFX("shot"+ammoData.index)}},init:function(options){var self=this;this._editor=options.editor;this._domStage=options.container.find(".gliffy-stage");if(this._debug){this._cheatAnswer="b"}_gliffy.KeyManager.addKeyBindings({typeA:"a",typeB:"b",gameStart:"space",gameLeft:"left",gameRight:"right",gameThrust:"up"});_gliffy.KeyManager.addActionsToState("stage",[{action:"typeA",keydown:function(e){self.checkCheat("a")}},{action:"typeB",keydown:function(e){self.checkCheat("b")}},{action:"nudgeStageLeft",keydown:function(e){self.checkCheat("l")}},{action:"nudgeStageRight",keydown:function(e){self.checkCheat("r")}},{action:"nudgeStageUp",keydown:function(e){self.checkCheat("u")}},{action:"nudgeStageDown",keydown:function(e){self.checkCheat("d")}}]);_gliffy.KeyManager.registerState("game",null,[{action:"gameStart",keydown:function(e){switch(self._gameMode){case GAME_MODE.intro:$("#gliffy-game-text").addClass("gliffy-game-text-inactive");$(".gliffy-graphic").animate({opacity:"1.0"},1000);$(".gliffy-text p").show();$("#gliffy-game-instructions").html('<div>move ship: arrow keys<br>shoot: &lt;space&gt;<div id="gliffy-game-stuck"></div>');setTimeout(function(){$("#gliffy-game-stuck").html("Can't win?  Refresh your browser to continue using Gliffy.")},30000);setTimeout(function(){self._gameMode=GAME_MODE.play;self._invincible=true;self._shipData.node.getDomElement().css("opacity","0.0").stop().animate({opacity:"1.0"},500).animate({opacity:"0.0"},500).animate({opacity:"1.0"},125,function(){self._invincible=false})},1000);break;case (GAME_MODE.play):self._shoot();break}e.stopImmediatePropagation();e.preventDefault();return false}},{action:"gameLeft",keydown:function(e){if(self._gameMode===GAME_MODE.play){self._shipData.node.setRotation(self._shipData.node.getRotation()-15)}e.stopImmediatePropagation();e.preventDefault();return false}},{action:"gameRight",keydown:function(e){if(self._gameMode===GAME_MODE.play){self._shipData.node.setRotation(self._shipData.node.getRotation()+15)}e.stopImmediatePropagation();e.preventDefault();return false}},{action:"gameThrust",keydown:function(e){if(self._gameMode===GAME_MODE.play){var rad=_gliffy.Utils.degreesToRadians(self._shipData.node.getRotation());self._shipData.velocity=new _gliffy.Vec2(Math.sin(rad),-Math.cos(rad))}e.stopImmediatePropagation();e.preventDefault();return false}}])},checkCheat:function(add){this._cheatBuffer+=add;if(this._cheatBuffer.length>this._cheatAnswer.length){this._cheatBuffer=this._cheatBuffer.substr(1,this._cheatBuffer.length)}if(this._cheatBuffer===this._cheatAnswer){this.confirmPlay()}},_removeUnneededNodes:function(){var stage=this._editor.getDocumentManager().getActiveStage();var removeMe=[];var bounds=this._editor.getDocumentManager().getActiveStageViewPort();var nodesInView=_gliffy.Pick.pickAllNodesInside(this._editor.getDocumentManager().getActiveStage().objects,bounds);var nodeIdsInView={};for(var i=0;i<nodesInView.length;i++){nodeIdsInView[nodesInView[i]._id]=true}for(var i=0;i<stage.objects.length;i++){if((!stage.objects[i].isShape()&&!stage.objects[i].isImage())||nodeIdsInView[stage.objects[i]._id]!==true||stage.objects[i].width>200||stage.objects[i].height>200){removeMe.push(stage.objects[i])}}for(var i=0;i<removeMe.length;i++){stage.removeNode(removeMe[i])}this._editor.getDocumentManager().redraw()},_colorize:function(){var stage=this._editor.getDocumentManager().getActiveStage();var self=this;for(var i=0;i<stage.objects.length;i++){if(stage.objects[i].isShape()||stage.objects[i].isImage()){var graphic=stage.objects[i].getGraphic();if(graphic instanceof _gliffy.Shape){graphic.setGradient(false);graphic.setFillColor("#000000");graphic.setStrokeColor("#ffffff");graphic.setDropShadow(false);graphic.setShadowX(0);graphic.setShadowY(0);graphic.setStrokeWidth(2)}this._asteroidData[stage.objects[i]._id]={node:stage.objects[i],velocity:new _gliffy.Vec2.randomUnit()}}}stage.setDrawingGuideOn(false);stage.setGridVisible(false);stage.setBackground("#000000");this._editor.grid.setEnabled(stage.gridOn)},_setupShip:function(){var node=new _gliffy.Node();var bounds=this._editor.getDocumentManager().getActiveStageViewPort();this._editor.drawManager.setupShape(node,{tid:"com.gliffy.stencil.triangle.basic_v1",uid:"com.gliffy.shape.basic.basic_v1.default.triangle"},{x:bounds.max.x/2+30,y:bounds.max.y/2+30});node.setWidth(40);node.setHeight(55);var graphic=node.getGraphic();graphic.setGradient(false);graphic.setFillColor("#0000CC");graphic.setStrokeColor("#ffffff");graphic.setDropShadow(false);graphic.setShadowX(0);graphic.setShadowY(0);graphic.setStrokeWidth(2);var out=this._editor.getDocumentManager().getActiveStage().appendNode(node);this._editor.getDocumentManager().redraw();this._shipData={velocity:new _gliffy.Vec2(0,0),node:node}},_setupAmmo:function(){var node;for(var i=0;i<MAX_AMMO;i++){node=new _gliffy.Node();this._editor.drawManager.setupShape(node,{tid:"com.gliffy.stencil.ellipse.basic_v1",uid:"com.gliffy.shape.basic.basic_v1.default.ellipse"},{x:-500,y:-500});node.setWidth(15);node.setHeight(15);var graphic=node.getGraphic();graphic.setGradient(false);graphic.setFillColor("#ff0000");graphic.setStrokeColor("#ffffff");graphic.setDropShadow(false);graphic.setShadowX(0);graphic.setShadowY(0);graphic.setStrokeWidth(2);this._editor.getDocumentManager().getActiveStage().appendNode(node);this._editor.getDocumentManager().redraw();this._ammoData.push({node:node,used:false,index:i,velocity:new _gliffy.Vec2(0,0)})}},_getAmmo:function(){for(var i=0;i<this._ammoData.length;i++){if(this._ammoData[i].used===false){this._ammoData[i].used=true;return this._ammoData[i]}}return null},_handleHit:function(ammoData,asteroidData){var stage=this._editor.getDocumentManager().getActiveStage();var asteroidID=asteroidData.node._id;this._numAsteroids++;this._playSFX("boom"+ammoData.index);this._domStage.prepend($('<div class="gliffy-game-boom gliffy-game-boom'+ammoData.index+'"></div>').css({left:asteroidData.node.getX()+asteroidData.node.getWidth()/2-71,top:asteroidData.node.getY()+asteroidData.node.getHeight()/2-100}));setTimeout(function(){$(".gliffy-game-boom"+ammoData.index).remove()},1000);if(asteroidData.node.getWidth()>50&&asteroidData.node.getHeight()>50){for(var i=0;i<2;i++){var node=new _gliffy.Node();var tid="com.gliffy.stencil.rectangle.basic_v1";var uid="com.gliffy.shape.basic.basic_v1.default.rectangle";if(asteroidData.node.isShape()){tid=asteroidData.node.getGraphic().getTid();uid=asteroidData.node.getUid()}this._editor.drawManager.setupShape(node,{tid:tid,uid:uid},{x:asteroidData.node.getX()+asteroidData.node.getWidth()/2,y:asteroidData.node.getY()+asteroidData.node.getHeight()/2});var ammoVec=new _gliffy.Vec2(ammoData.velocity.x,ammoData.velocity.y).normalize();var deg=_gliffy.Utils.radiansToDegrees(Math.atan2(ammoVec.y,ammoVec.x))-45+Math.random()*90;var rad=_gliffy.Utils.degreesToRadians(deg);var newVec=new _gliffy.Vec2(Math.cos(rad),Math.sin(rad)).normalize();node.setWidth(asteroidData.node.getWidth()/(1.5+Math.random()));node.setHeight(asteroidData.node.getHeight()/(1.5+Math.random()));var graphic=node.getGraphic();if(node.isShape()){graphic.setGradient(false);graphic.setFillColor("#000000");graphic.setStrokeColor("#ffffff");graphic.setDropShadow(false);graphic.setShadowX(0);graphic.setShadowY(0);graphic.setStrokeWidth(2)}this._asteroidData[node._id]={node:node,velocity:newVec}}this._editor.getDocumentManager().getActiveStage().appendNode(node)}stage.removeNode(asteroidData.node);delete this._asteroidData[asteroidID];ammoData.used=false;ammoData.node.setX(-500);ammoData.node.setY(-500)},_checkAsteroidCollisions:function(){var self=this;var hadCollision=false;for(var i=0;i<self._ammoData.length;i++){var x=self._ammoData[i].node.getX();var y=self._ammoData[i].node.getY();var w=self._ammoData[i].node.getWidth()/2;var h=self._ammoData[i].node.getHeight()/2;$.each(self._asteroidData,function(key,data){if(data.node.worldAabb.pointInside(x,y)||data.node.worldAabb.pointInside(x+w,y)||data.node.worldAabb.pointInside(x,y+h)||data.node.worldAabb.pointInside(x+w,y+h)){self._handleHit(self._ammoData[i],data);hadCollision=true}})}return hadCollision},_checkWin:function(){var self=this;if(Object.keys(this._asteroidData).length===0){self._gameMode=GAME_MODE.win;for(var i=0;i<self._ammoData.length;i++){self._ammoData[i].node.getDomElement().stop().animate({opacity:"0.0"},1000)}$("#gliffy-game-instructions").text("You must refresh your browser to continue using Gliffy.");$("#gliffy-game-instructions").css("opacity","0.0");setTimeout(function(){$("#gliffy-game-instructions").animate({opacity:"1.0"},1000)},8000);_gliffy.Utils.analyticsEvent("trackEvent",{category:"gliffyWars",action:"win"});self._shipData.node.getDomElement().stop().animate({opacity:"0.0"},1000,function(){$("#gliffy-game-text h1").html("You Win<sub>Good job Djedi!</sub>");$("#titlecontent").html("<p>Congratulations young Djedi, you've successfully defeated the empire of misfit shapes.</p><p>You successfully shot down "+self._numAsteroids+" shapes. And wasted exactly "+((new Date()).getTime()-self._startTime)/1000+" seconds!</p><p>Gliffy is...</p><p class='gliffy-game-center'>Chris Kohlhardt<br>CEO & Founder</p><p class='gliffy-game-center'>Clint Dickson<br>Principal Engineer & Founder</p><p class='gliffy-game-center'>Eric Chiang<br>Director of Engineering</p><p class='gliffy-game-center'>Kerry Liu<br>Senior Software Engineer</p><p class='gliffy-game-center'>Rocco Balsamo<br>Senior Software Engineer</p><p class='gliffy-game-center'>Michal Cialowicz<br>Senior Software Engineer</p><p class='gliffy-game-center'>Keith Rockhold<br>Software Engineer</p><p class='gliffy-game-center'>Joe Lau<br>Software Engineer</p><p class='gliffy-game-center'>Jonathan Potter<br>Software Engineer</p><p class='gliffy-game-center'>Zachary Propersi<br>Software Engineer</p><p class='gliffy-game-center'>Joshua Totemwongse<br>Software Engineer</p><p class='gliffy-game-center'>Jan Revis<br>Software Engineer</p><p class='gliffy-game-center'>May Woo<br>Director of User Experience</p><p class='gliffy-game-center'>Jason Ferrier<br>Web Developer</p><p class='gliffy-game-center'>Mark Gopez<br>Marketing</p><p class='gliffy-game-center'>Katy Kelly<br>Customer Support Advocate</p><p class='gliffy-game-center'>Tyler Brown<br>QA Lead</p><p class='gliffy-game-center'>Drew Dimanlig<br>QA Engineer</p><p class='gliffy-game-center'>Kat Cole<br>Operations Assistant</p><p class='gliffy-game-small'>Gliffy Wars was created during innovation week 2012 by Rocco Balsamo.  Starfield inspiration: http://codentronix.com/2011/07/22/html5-canvas-3d-starfield/ (Lefam), Scrolling text inspiration: http://www.sitepoint.com/css3-starwars-scrolling-text/ (Craig Buckler).</p><p>...and we weren't kidding, you have to refresh your browser to keep working with Gliffy!</p>");$("#gliffy-game-text").removeClass("gliffy-game-text-inactive")})}},_tickGame:function(self){var frameTime=new Date().getTime();var delta=frameTime-self._lastFrameTime;var bounds=this._editor.getDocumentManager().getActiveStageViewPort();var speed=1;var updateWithWrap=function(key,data,multiplier){if(multiplier===undefined){multiplier=1}var newX=(data.node.getX()+data.velocity.x*delta*multiplier/20+bounds.max.x*5)%bounds.max.x;var newY=(data.node.getY()+data.velocity.y*delta*multiplier/20+bounds.max.y*5)%bounds.max.y;data.node.setX(newX);data.node.setY(newY)};var updateNoWrap=function(key,data){var newX=(data.node.getX()+data.velocity.x*delta/10);var newY=(data.node.getY()+data.velocity.y*delta/10);if(newX<bounds.min.x||newY>bounds.max.x||newY<bounds.min.y||newY>bounds.max.x){return false}data.node.setX(newX);data.node.setY(newY);return true};switch(self._gameMode){case GAME_MODE.gameOver:break;case GAME_MODE.play:self._invincibleTime-=delta;$.each(self._asteroidData,updateWithWrap);updateWithWrap(null,self._shipData,2);for(var i=0;i<self._ammoData.length;i++){if(self._ammoData[i].used){if(!updateNoWrap(null,self._ammoData[i])){self._ammoData[i].node.setX(-500);self._ammoData[i].node.setY(-500);self._ammoData[i].velocity=new _gliffy.Vec2(0,0);self._ammoData[i].used=false}}}if(self._checkAsteroidCollisions()){self._checkWin()}break}self._lastFrameTime=frameTime;self._editor.getDocumentManager().redraw()},_initStarField:function(){var self=this,bounds=this._editor.getDocumentManager().getActiveStageViewPort();var bounds=this._editor.getDocumentManager().getActiveStageViewPort();self._domStage.prepend($('<canvas id="gliffy-starfield" style="background-color:#bbbbbb;position:absolute;top:0px;left:0px;width:'+bounds.max.x+"px;height:"+bounds.max.y+'px;"></canvas>'));self._domStage.append($('<div id="gliffy-game-instructions" style="color:yellow; position:absolute; top: 10px; left:10px; width:400px; ">Press &lt;space&gt; to start.</div>'));var canvas=$("#gliffy-starfield")[0];var MAX_DEPTH=32;var canvas,ctx;var stars=new Array(512);function randomRange(minVal,maxVal){return Math.floor(Math.random()*(maxVal-minVal-1))+minVal}function initStars(){for(var i=0;i<stars.length;i++){stars[i]={x:randomRange(-25,25),y:randomRange(-25,25),z:randomRange(1,MAX_DEPTH)}}}function loop(){var halfWidth=canvas.width/2;var halfHeight=canvas.height/2;ctx.fillStyle="rgb(25,25,25)";ctx.fillRect(0,0,canvas.width,canvas.height);for(var i=0;i<stars.length;i++){stars[i].z-=0.2;if(stars[i].z<=0){stars[i].x=randomRange(-25,25);stars[i].y=randomRange(-25,25);stars[i].z=MAX_DEPTH}var k=128/stars[i].z;var px=stars[i].x*k+halfWidth;var py=stars[i].y*k+halfHeight;if(px>=0&&px<=canvas.width&&py>=0&&py<=canvas.height){var size=(1-stars[i].z/32)*5;var shade=parseInt((1-stars[i].z/32)*255);ctx.fillStyle="rgb("+shade+","+shade+","+shade+")";ctx.fillRect(px,py,size,size)}}}ctx=canvas.getContext("2d");initStars();setInterval(loop,66)},_initSFX:function(){var self=this;var ext=(new Audio()).canPlayType("audio/ogg; codecs=vorbis")?"ogg":"mp3";function addSfx(name,filename){self._sfx[name]=new Audio("../audio/"+filename+"."+ext)}addSfx("shot0","shot");addSfx("shot1","shot");addSfx("shot2","shot");addSfx("shot3","shot");addSfx("shot4","shot");addSfx("boom0","boom");addSfx("boom1","boom");addSfx("boom2","boom");addSfx("boom3","boom");addSfx("boom4","boom")},_playSFX:function(name){},_initGame:function(){var stage=this._editor.getDocumentManager().getActiveStage(),self=this;_gliffy.Utils.analyticsEvent("trackEvent",{category:"gliffyWars",action:"play"});$("#ki_container").hide();$(".gliffy-popover").hide();$("#gliffy-bottom-panel").hide().height(0);this._editor.resizeContainer();$("body").append($('<div class="game-ui-blocker"></div>'));this._editor.getDocumentManager().getDraftManager().disable();$("#gliffy-hide-library").click();$(".gliffy-super-ui-blocker").show();_gliffy.KeyManager.setState("game");_gliffy.Mouse.setState("game");_gliffy.KeyManager.setState=function(){};_gliffy.Mouse.setState=function(){};this._startTime=(new Date()).getTime();this._editor.getDocumentManager().getActiveStage().setPan(0,0,0,0);setTimeout(function(){self._initStarField()},500);this._removeUnneededNodes();this._colorize();this._setupShip();this._setupAmmo();this._invincibleTime=5000;this._shipData.node.getDomElement().css("opacity","0.0").animate({opacity:"1.0"},3000);setTimeout(function(){$(".gliffy-graphic").css("opacity","0.0");$(".gliffy-text p").hide();$("#gliffy-game-text").removeClass("gliffy-game-text-inactive")},125);this._lastFrameTime=new Date().getTime();setInterval(function(){self._tickGame(self)},1)},confirmPlay:function(){var self=this;if(self._debug){self._initGame()}else{var cnt=0;var bounds=this._editor.getDocumentManager().getActiveStageViewPort();var nodesInView=_gliffy.Pick.pickAllNodesInside(this._editor.getDocumentManager().getActiveStage().objects,bounds);for(var i=0;i<nodesInView.length;i++){if(nodesInView[i].isShape()||nodesInView[i].isImage()){cnt++}}if(cnt>0&&_gliffy.BrowserDetect.browser!=="Explorer"){_gliffy.Dialog.showYesNoDialog({title:"May the Schwartz Be With You",content:"Do you really want to play Glyph Wars?  It will destroy your diagram so you should probably save first.",cancelCallback:null,buttons:[{text:"No",callback:null,primary:false,dismiss:true},{text:"Yes",callback:function(e){var prevColor=$(".gliffy-popup .modal-header").css("background-color");_gliffy.Dialog.showYesNoDialog({title:"No, Really.",content:"THIS WILL DESTROY YOUR DIAGRAM.  Save first!  Do you wish to continue, young Djedi?",cancelCallback:null,buttons:[{text:"No, I need to go back and Save",callback:function(){$(".gliffy-popup .modal-header").css("background-color",prevColor);$(".gliffy-popup .gliffy-btn-red").removeClass("gliffy-btn-red").addClass("gliffy-btn-primary")},primary:false,dismiss:true},{text:"Yes, I've already saved.",callback:function(e){self._initGame();return false},primary:true,dismiss:true}]});$(".gliffy-popup .modal-header").css("background-color","#cc0000");$(".gliffy-popup .gliffy-btn-primary").removeClass("gliffy-btn-primary").addClass("gliffy-btn-red");return false},primary:true,dismiss:true}]})}else{_gliffy.Dialog.showAlertDialog({content:(_gliffy.BrowserDetect.browser==="Explorer"?"Young Djedi, come back and play Glyph wars with Chrome, Firefox or Safari!":"Glyph Wars won't be much fun unless you have at least 3 shapes on the screen.  Come back soon!"),title:"Do.  Or do not.  There is no try.",cancelCallback:null,buttons:[{text:"OK",callback:null,primary:true,dismiss:true,add_classes:[]}]})}}}})}());(function(){_gliffy.Plugins.create({_isEditor:false,activate:function(container){var self=this,options;this._isEditor=_gliffy.Editor&&container instanceof _gliffy.Editor;if(this._isEditor){GliffyApp.popupNotesDialogController=GliffyApp.PopupNotesDialogController.create({_editor:container})}options={getStageCallback:function(){if(self._isEditor){return container.getDocumentManager().getActiveStage()}return container.document.getStage()},shouldShowPopupCallback:function(){if(self._isEditor){return(!container.overlayManager.getSelectedNode())}return true},mouse:_gliffy.Mouse||null};if($("#container-container").length>0){options.scrollContainer=$("#container-container")}_gliffy.PopupNotesMouseHandler=new _gliffy._PopupNotesMouseHandler(options)},initTemplates:function(){if(window.GliffyApp){if(Ember.View.views["gliffy-node-tools"]){Ember.View.views["gliffy-node-tools"].insertAt(0,GliffyApp.PopupNotesButtonView.create({}))}if(Ember.View.views["gliffy-popup-container"]){Ember.View.views["gliffy-popup-container"].pushObject(GliffyApp.PopupNotesDialogView.create({}))}}},getTemplateNames:function(){return["popup-notes-button.handlebars"]},getName:function(){return"PopupNotes"},showAllNoteIcons:function(){_gliffy.PopupNotesMouseHandler.showAllIcons()},hideAllNoteIcons:function(){_gliffy.PopupNotesMouseHandler.hideAllIcons()},showAllNotes:function(){_gliffy.PopupNotesMouseHandler.showAllNotes()},hideAllNotes:function(){_gliffy.PopupNotesMouseHandler.hideAllNotes()}})}());(function(){_gliffy.PopupNote=_gliffy.Graphic.extend({_text:null,_renderIcon:true,_forceShow:false,style:null,init:function(){this.style={}},getTid:function(){return"popupNote"},markDirty:function(){this._dirty=true;if(this.node){this.node.markDirty();this.node.setFlag("skin");if(this.node.parent){this.node.parent.markDirty()}}},getText:function(){return this._text},setText:function(text){this._text=text;this.markDirty()},update:function(){},applyStyle:function(style){},forceShow:function(bool){this._forceShow=bool;this.markDirty()},hideIcon:function(){this._renderIcon=false;this.markDirty()},showIcon:function(){this._renderIcon=true;this.markDirty()},getRenderIcon:function(){return this._renderIcon},shouldForceShow:function(){return this._forceShow},getClassName:function(){return"PopupNote"},__toObject:function(){this.update();return{text:this.getText()}},__fromObject:function(object){if(object.text!==undefined){this.setText(object.text)}}})})();(function(){_gliffy.Renderer.PopupNotesRenderer=_gliffy.Renderer.IconRenderer.extend({id:"Gliffy.Renderer.PopupNotesRenderer",init:function(){_gliffy.renderers[this.id]=this},render:function(o){o.graphicType=_gliffy.PopupNote;o.iconClass="gliffy-viewerIcon-popupNotes-icon";o.oppositeGraphicType=_gliffy.Link;o.renderLeftIfOppositeGraphicTypeExists=false;o.renderPopupPoints=true;this._super(o)}})})();(function(){_gliffy._PopupNotesMouseHandler=_gliffy.Class.extend({_getStageCallback:null,_shouldShowPopupCallback:null,_redrawCallback:null,_showAllMode:false,_showAllPopovers:null,_mouse:null,_mouseChangeFunc:null,init:function(options){var o=$.extend({},{getStageObjectsCallback:function(){return[]},shouldShowPopupCallback:function(){return true},redrawCallback:function(){},scrollContainer:$(window),mouse:null},options),self=this,startedScroll;this._mouse=o.mouse;this._getStageCallback=o.getStageCallback;this._shouldShowPopupCallback=o.shouldShowPopupCallback;this._redrawCallback=o.redrawCallback();this._showAllPopovers=[];this.handleMouseEvents();if(o.scrollContainer){startedScroll=false;o.scrollContainer.scroll(function(){clearTimeout($.data(this,"gliffy-popup-notes-scrollTimer"));$.data(this,"gliffy-popup-notes-scrollTimer",setTimeout(function(){self.scrollEnd();startedScroll=false},250));if(!startedScroll){self.scrollStart();startedScroll=true}})}},setCustomMouseTrigger:function(){var self=this;$("body").off("mousemove.gliffy-popup-notes");$("body").on("custom-mouse-trigger.gliffy-popup-notes",function(ev,pt){self.mouseChangeFunc(pt)})},handleMouseEvents:function(){var currentNode=null,editor=this._editor,self=this;self.mouseChangeFunc=function(pos){var node=null,popupNoteNode;if(self._showAllMode){return}if(self._shouldShowPopupCallback()){node=_gliffy.Pick.getNodeAt(self._getStageCallback().objects,pos.x,pos.y,true)}if(!node){if(self.currentPopover){self.currentPopover.remove()}}else{if(node!==currentNode){if(self.currentPopover){self.currentPopover.remove()}popupNoteNode=_gliffy.Utils.firstInArray(node.findImmediateChildGraphic(_gliffy.PopupNote));self.currentPopover=self.addPopover(node,popupNoteNode)}}currentNode=node};if(this._mouse){this._mouse.onChangeIntent(self.mouseChangeFunc)}else{$("body").on("mousemove.gliffy-popup-notes",function(e){var x=e.pageX,y=e.pageY,offset,zoom;if($(".gliffy-stage").length>0){offset=$(".gliffy-stage").offset();x-=offset.left;y-=offset.top}zoom=self._getStageCallback().getZoom();x/=zoom;y/=zoom;self.mouseChangeFunc({x:x,y:y})})}$("#container").on("mousedown",function(){if(self.currentPopover){self.currentPopover.remove()}});$("#container").scroll($.debounce(250,true,function(){if(self.currentPopover){self.currentPopover.remove()}self._hideAll()}));$("#container").scroll($.debounce(250,function(){if(self._showAllMode){self.showAllNotes()}}));$("#container").on("removeCurrent.gliffy-popup-notes",function(){if(self.currentPopover){self.currentPopover.remove()}})},removeCurrentPopover:function(){if(self.currentPopover){self.currentPopover.remove()}},_modifyAllNotes:function(options){var nodes,note,popupNotes,node,popupNote,i,j,o=$.extend({},{type:"note",show:true},options);this._showAllPopovers=[];nodes=this._getStageCallback().objects;for(i=0;i<nodes.length;i++){node=nodes[i];popupNotes=node.findGraphic(_gliffy.PopupNote);for(j=0;j<popupNotes.length;j++){popupNote=popupNotes[j].getGraphic();if(o.type==="icon"){popupNote[o.show?"showIcon":"hideIcon"]()}else{if(o.type==="note"){popupNote.forceShow(o.show);if(popupNote.node.parent){var popover=this.refresh(popupNote.node.parent,popupNote.node);if(popover){this._showAllPopovers.push(popover)}}}}}}},_hideAll:function(){for(var i=0;i<this._showAllPopovers.length;i++){this._showAllPopovers[i].remove()}},_showAllNotes:function(){$("#container").trigger("removeCurrent.gliffy-popup-notes");this._modifyAllNotes({type:"note",show:true})},_hideAllNotes:function(){this._hideAll();this._modifyAllNotes({type:"note",show:false});if(this.currentPopover){this.currentPopover.remove();this.currentPopover=null}},showAllNotes:function(){this._showAllMode=true;this._showAllNotes()},hideAllNotes:function(){this._showAllMode=false;this._hideAllNotes()},hasPopupNotes:function(){var stage=this._getStageCallback();return stage&&stage.findGraphic(_gliffy.PopupNote).length>0},scrollStart:function(){if(this._showAllMode){this._hideAllNotes()}},scrollEnd:function(){if(this._showAllMode){this._showAllNotes()}},showAllIcons:function(){this._modifyAllNotes({type:"icon",show:true})},hideAllIcons:function(){this._modifyAllNotes({type:"icon",show:false})},refresh:function(parentNode,popupNoteNode){if(popupNoteNode.getGraphic().shouldForceShow()){return this.addPopover(parentNode,popupNoteNode)}return null},addPopover:function(parentNode,popupNoteNode){var offset,containerBB,directions,popupBB,$popupNoteDomNode,popupNoteGraphic,popupNodePoints,self=this;directions=["n","s","w","e","nw","ne","se","sw"];containerBB=new _gliffy.BoundingBox(0,0,window.innerWidth,window.innerHeight);offset=$("#container").offset();if(offset){containerBB.min.x=offset.left;containerBB.min.y=offset.top}if(popupNoteNode){popupNoteGraphic=popupNoteNode.getGraphic();popupNodePoints=$(".gliffy-popup-point");popupNodePoints.show();_.each(directions,function(direction){$popupNoteDomNode=parentNode.getDomViewbox().find(".gliffy-popup-point-"+direction);$popupNoteDomNode.html(direction);self.currentPopover=new _gliffy.Popover({target:$popupNoteDomNode,content:popupNoteGraphic.getText(),placement:direction,addClass:"gliffy-popup-note"});popupBB=self.currentPopover.getBoundingBox();if(containerBB.boundingBoxInside(popupBB)){return false}else{self.currentPopover.remove();self.currentPopover=null}});popupNodePoints.hide()}return self.currentPopover}})}());(function(){GliffyApp.PopupNotesButtonView=Ember.View.extend({tagName:"button",templateName:"popup-notes-button",classNames:["btn","popup-notes-button","disabled"],didInsertElement:function(event){var setButtonState=function(node){var popupNoteNode;if(node&&node.supportsIcon()){$(".popup-notes-button").attr("data-toggle","modal");$(".popup-notes-button").removeClass("disabled");GliffyApp.popupNotesDialogController.set("_targetNode",node);popupNoteNode=_gliffy.Utils.firstInArray(node.findImmediateChildGraphic(_gliffy.PopupNote));$("#gliffy-popup-notes-textarea").val(popupNoteNode?popupNoteNode.getGraphic().getText():"")}else{$(".popup-notes-button").attr("data-toggle","");$(".popup-notes-button").addClass("disabled")}};$(".popup-notes-button").attr("data-original-title",$.i18n._("POPUP_NOTES_INSERT"));$(".popup-notes-button").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$(".popup-notes-button").attr("data-target","#gliffy-popup-notes-dialog");$(".popup-notes-button").on("click",function(){if($(this).hasClass("disabled")){_gliffy.Utils.analyticsEvent("trackEvent",{category:"toolbarClick",action:"popupNotesWhenDisabled"})}else{_gliffy.Utils.analyticsEvent("trackEvent",{category:"toolbarClick",action:"popupNotes"})}});$("#gliffy-popup-notes-dialog").on("shown",function(){var textAreaValue=$("#gliffy-popup-notes-textarea").val();$("#gliffy-popup-notes-textarea").focus().val("").val(textAreaValue)});$(window).on("rte-add.gliffy-edit-text",function(event){var rte=$("#gliffy-edit-text_ifr"),textNode;if(rte.is(":visible")){textNode=rte.data("node");if(textNode){setButtonState(textNode.getUidNode())}}});$(window).on("gliffy-overlay-set-selected-node gliffy-draw-swap-proxy gliffy-overlay-manager-deselect-all",function(event,node){setButtonState(node)});if(_gliffy.Debug.POPUP_NOTE_POSITION){$(".gliffy-toolbar").append('<input type="number" min="0" max="150" value="100" style="width:50px" class="gliffy-popup-debug gliffy-popup-debug-x"><input class="gliffy-popup-debug gliffy-popup-debug-y" style="width:50px" type="number" min="0" max="150" value="100">');$(".gliffy-popup-debug").change(function(e){_gliffy.Debug.popupWidthMultiplier=parseInt($(".gliffy-popup-debug-x").val(),10)/100;_gliffy.Debug.popupHeightMultiplier=parseInt($(".gliffy-popup-debug-y").val(),10)/100;GliffyApp.popupNotesDialogController.debugRedrawAll()})}}})}());(function(){GliffyApp.PopupNotesDialogView=Ember.View.extend({templateName:"popup-notes-dialog",classNames:["gliffy-popup"],doneClick:function(){GliffyApp.popupNotesDialogController.modifyPopupNodeOnTarget({text:$("#gliffy-popup-notes-textarea").val()})},didInsertElement:function(){}})}());(function(){GliffyApp.PopupNotesDialogController=Ember.ObjectController.extend({_targetNode:null,_editor:null,_targetText:"",init:function(o){},actions:{doneClick:function(){this.modifyPopupNodeOnTarget({text:$("#gliffy-popup-notes-textarea").val()})}},modifyPopupNodeOnTarget:function(o){var options=$.extend({text:""},o),existingPopup,popupNode,graphic;if(this._targetNode){this._editor.getDocumentManager().pushCommandBundle();existingPopup=_gliffy.Utils.firstInArray(this._targetNode.findImmediateChildGraphic(_gliffy.PopupNote));if(existingPopup){this._editor.getDocumentManager().addAndExecuteCommand(new _gliffy.RemoveNodeCommand({node:existingPopup,markParentDirty:true}))}if(options.text){popupNode=new _gliffy.Node();graphic=new _gliffy.PopupNote();graphic.setText(options.text);popupNode.setGraphic(graphic);this._editor.getDocumentManager().addAndExecuteCommand(new _gliffy.AddNodeCommand({node:popupNode,target:this._targetNode,markParentDirty:true}));_gliffy.Utils.analyticsEvent("trackEvent",{category:"popupNotes",action:"add"})}else{_gliffy.Utils.analyticsEvent("trackEvent",{category:"popupNotes",action:"remove"})}this._editor.getDocumentManager().popCommandBundle();this._editor.getDocumentManager().redraw()}},debugRedrawAll:function(){var i;var stage=this._editor.getDocumentManager().getActiveStage();for(i=0;i<stage.objects.length;i++){stage.objects[i].markDirty()}this._editor.getDocumentManager().redraw()}})}());(function(){GliffyApp.TablesTabView=Ember.View.extend({tagName:"div",elementId:"gliffy-tables-tab",templateName:"tables-tab",classNames:[],showAddRemove:true,clickDropdown:function(e){var domId=e.currentTarget.getAttribute("id"),dropdownContainer=$(e.currentTarget).parent(),dropdown=dropdownContainer.children("ul");GliffyApp.contextualPropertiesController.resetDialogControls(domId);if(this.__isDropdownBelowFold(dropdownContainer,dropdown)){dropdown.css("top",-(dropdown.height()+12))}else{dropdown.css("top","100%")}$(e.currentTarget).tooltip("hide");e.preventDefault()},didInsertElement:function(e){$("#gliffy-contextual-properties-table-resize-buttons button").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);GliffyApp.tablesTabController.registerSelectionListeners()}})}());(function(){GliffyApp.TablesTabController=Ember.ObjectController.extend({__editor:null,__documentManager:null,container:null,tableOverlay:null,showInsert:false,targetNode:null,init:function(){this.container=this.__editor.overlayManager.getContainer();this.tableOverlay=this.__editor.overlayManager.tableOverlay},registerSelectionListeners:function(){var self=this,updateEvents=["gliffy-table-update-selection","gliffy-overlay-manager-select-node"].join(" "),selectedCells;this.container.on(updateEvents,function(e){setTimeout(function(){selectedCells=self.tableOverlay.getSelectedCells();if(selectedCells){self.set("showInsert",(selectedCells.length>0))}},1)})},actions:{addColumn:function(){this.updateProperty("addCell",{rows:0,columns:1});_gliffy.Utils.analyticsEvent("trackEvent",{category:"tables",action:"addTableColumn"})},removeColumn:function(){this.updateProperty("removeCell",{rows:0,columns:-1});_gliffy.Utils.analyticsEvent("trackEvent",{category:"tables",action:"removeTableColumn"})},addRow:function(){this.updateProperty("addCell",{rows:1,columns:0});_gliffy.Utils.analyticsEvent("trackEvent",{category:"tables",action:"addTableRow"})},removeRow:function(){this.updateProperty("removeCell",{rows:-1,columns:0});_gliffy.Utils.analyticsEvent("trackEvent",{category:"tables",action:"removeTableRow"})},insertColumn:function(){this.updateProperty("insertCell",{rows:0,columns:1});_gliffy.Utils.analyticsEvent("trackEvent",{category:"tables",action:"insertTableColumn"})},removeSelectedColumn:function(){this.updateProperty("removeSelectedCell",{rows:0,columns:-1});_gliffy.Utils.analyticsEvent("trackEvent",{category:"tables",action:"removeSelectedTableColumn"})},insertRow:function(){this.updateProperty("insertCell",{rows:1,columns:0});_gliffy.Utils.analyticsEvent("trackEvent",{category:"tables",action:"insertTableRow"})},removeSelectedRow:function(){this.updateProperty("removeSelectedCell",{rows:-1,columns:0});_gliffy.Utils.analyticsEvent("trackEvent",{category:"tables",action:"removeSelectedTableRow"})},convertToChart:function(){GliffyApp.contextualPropertiesController.convertToChart()}},updateProperty:function(prop,value){var documentManager=this.__editor.getDocumentManager();GliffyApp.overlayModel.set(prop,value);documentManager.pushCommandBundle();this.targetNode=GliffyApp.contextualPropertiesController.getTargetNode(true);GliffyApp.contextualPropertiesController.keepDialogOpen=true;GliffyApp.contextualPropertiesController.keepDialogOpenOnBlurText=true;this.doTableUpdateCells(this.targetNode,value,prop);GliffyApp.contextualPropertiesController.keepDialogOpen=false;GliffyApp.contextualPropertiesController.keepDialogOpenOnBlurText=false;documentManager.popCommandBundle()},doTableUpdateCells:function(node,value,type){var selectedCells=[];if(type==="insertCell"||type==="removeSelectedCell"){selectedCells=this.tableOverlay.getSelectedCells()}if(node.children.length!==1||type!=="removeCell"||type!=="removeSelectedCell"){this.__editor.overlayManager.deselectAll();this.__editor.getDocumentManager().addAndExecuteCommand(new _gliffy.TableInsertCellsCommand({node:node,rows:value.rows,columns:value.columns,selectedCells:selectedCells,tableOverlay:this.tableOverlay}));this.__editor.overlayManager.selectNode(node)}else{GliffyApp.contextualPropertiesController.keepDialogOpen=false;GliffyApp.contextualPropertiesController.keepDialogOpenOnBlurText=false;this.__editor.overlayManager.deselectAll();new _gliffy.RemoveNodeCommand({node:node}).execute(this.__editor.getDocumentManager().getActiveStage());this.__editor.getDocumentManager().redraw();_gliffy.Utils.analyticsEvent("trackEvent",{category:"tables",action:"deleteLastNode"})}}})}());(function(){_gliffy.Plugins.create({activate:function(editor){GliffyApp.tablesTabController=GliffyApp.TablesTabController.create({__editor:editor,__documentManager:editor.getDocumentManager()})},getCustomTabView:function(){return GliffyApp.TablesTabView.create({name:this.getName()})},initTemplates:function(){},getTemplateNames:function(){return["tables-tab"]},getName:function(){return"TablesTab"}})}());(function(){_gliffy.PRINT_CONSTANTS={BROWSER_PRINT_CONSTANTS:{Chrome:{pixelsPerUnit:{"in":144,mm:5.669,cm:56.69},margin:{"in":0.3937,cm:1,mm:10}},Firefox:{pixelsPerUnit:{"in":96,mm:3.779,cm:37.79},margin:{"in":0.75,cm:1.905,mm:19.05},marginBottom:{"in":0.9,cm:2.286,mm:22.86}},Safari:{pixelsPerUnit:{"in":96,mm:3.779,cm:37.79},margin:{"in":0.25,cm:6.35,mm:0.635},marginBottom:{"in":0.56,cm:1.4224,mm:14.224}},Explorer:{pixelsPerUnit:{"in":96,mm:4,cm:40},margin:{"in":0.75,cm:1.905,mm:19.05}}},GLIFFY_NORMALIZED_PIXELS_PER_UNIT:{"in":96,cm:37.8,mm:3.78},PAGE_SIZES:{letter:{name:"letter",description:"Letter (8.5in x 11in)",margin:0.75,dimension:{x:8.5,y:11},unit:"in"},legal:{name:"legal",description:"Legal (8.5in x 14in)",margin:0.75,dimension:{x:8.5,y:14},unit:"in"},_11x17:{name:"_11x17",description:"Tabloid (11in x 17in)",margin:0.75,dimension:{x:11,y:17},unit:"in"},a3:{name:"a3",description:"A3 (297mm x 420mm)",margin:25,dimension:{x:297,y:420},unit:"mm"},a4:{name:"a4",description:"A4 (210mm x 297mm)",margin:25,dimension:{x:210,y:297},unit:"mm"}}}}());(function(){var __createStyleNode;GLIFFY.printUtils=GLIFFY.printUtils||{};__createStyleNode=GLIFFY.printUtils.__createStyleNode=function(mediaTypes,name,cssProperties){var serializedProperties,style;serializedProperties="";$.each(cssProperties,function(property,value){serializedProperties+=property+":"+value+";"});style=document.createElement("style");style.type="text/css";style.innerHTML="@media "+mediaTypes.join(",")+"{\n\t"+name+"{"+serializedProperties+" }\n}\n";document.head.appendChild(style);return style};GLIFFY.printUtils.createScreenStyle=function(name,cssProperties){return __createStyleNode(["screen"],name,cssProperties)};GLIFFY.printUtils.createPrintStyle=function(name,cssProperties){return __createStyleNode(["print"],name,cssProperties)};GLIFFY.printUtils.createStyle=function(name,cssProperties){return __createStyleNode(["print","screen"],name,cssProperties)}}());(function(){var PRINT_MODEL_DEFAULT={displayPageBreaks:false,fitToOnePage:false,pageSize:"Letter",portrait:true};GliffyApp.PrintModel=Ember.Object.extend({pageSize:PRINT_MODEL_DEFAULT.pageSize,portrait:PRINT_MODEL_DEFAULT.portrait,fitToOnePage:PRINT_MODEL_DEFAULT.fitToOnePage,displayPageBreaks:PRINT_MODEL_DEFAULT.displayPageBreaks,printDialogOpen:null,addPrintObservers:function(observerCallback){this.addObserver("pageSize",observerCallback);this.addObserver("portrait",observerCallback);this.addObserver("fitToOnePage",observerCallback);this.addObserver("displayPageBreaks",observerCallback)},toObject:function(){var serializeablePrintObject;serializeablePrintObject={pageSize:this.pageSize,portrait:this.portrait,fitToOnePage:this.fitToOnePage,displayPageBreaks:this.displayPageBreaks};return serializeablePrintObject},fromObject:function(object){this.set("pageSize",object.pageSize);this.set("portrait",object.portrait);this.set("fitToOnePage",object.fitToOnePage);this.set("displayPageBreaks",object.displayPageBreaks)},toString:function(){return JSON.stringify(this.toObject())}});GliffyApp.PrintModel.reopenClass({createFromObject:function(object){var printModel;printModel=this.create();if(object&&_.all(object,function(value){return value!==undefined})){printModel.fromObject(object)}else{printModel.fromObject(this.getUserDefaults()||PRINT_MODEL_DEFAULT)}return printModel},setUserDefaults:function(userDefaults){this.userDefaults=userDefaults},getUserDefaults:function(){return this.userDefaults}})}());(function(){GliffyApp.UserModel=Ember.Object.extend({uid:null,token:null,username:null,OptOut:false,isConfirmed:false,terms:false,isTempPwd:false,authenticated:false,accountUsers:false,currentAccount:null,userPreferences:null,gDriveOAuth2:false,isAuthenticated:Ember.computed(function(){return(this.get("authenticated")||this.get("token")!==null)&&this.get("uid")!==null}).property("token","uid"),init:function(){this.set("accountUsers",Ember.A([]))},displayName:Ember.computed(function(){if(this.get("username")){return this.get("username")}else{return"Demo User"}}).property("username"),optIn:Ember.computed(function(){return(!this.get("OptOut"))}).property("OptOut"),hasGDriveOAuth2:Ember.computed(function(){return(this.get("gDriveOAuth2"))}).property("gDriveOAuth2"),populate:function(data){this.set("authenticated",data.authenticated||null);this.set("uid",data.uid||null);this.set("username",data.username||null);this.set("token",data.token||null);this.set("OptOut",data.optOut||null);this.set("isConfirmed",data.isConfirmed||null);this.set("terms",data.token||null);this.set("isTempPwd",data.optOut||null);this.set("munchkinKey",data.munchkinKey||null);this.set("accountUsers",Ember.A([]));this.set("gDriveOAuth2",data.hasGDriveOAuth2||false);var currentAccountId=GliffyApp.authController.get("account").get("id");if(typeof GliffyApp.documentManagerController!="undefined"){GliffyApp.documentManagerController.propertyWillChange("showSwitcher")}for(var i=0;i<data.accountUsers.length;i++){var au=GliffyApp.AccountUserListItem.create({accountId:data.accountUsers[i].accountId,productId:data.accountUsers[i].productId,accountName:data.accountUsers[i].name,userRole:data.accountUsers[i].userRole,isDefault:data.accountUsers[i].isDefault});if(data.accountUsers[i].accountId==currentAccountId){this.set("currentAccount",au)}this.accountUsers.pushObject(au)}if(typeof GliffyApp.documentManagerController!="undefined"){GliffyApp.documentManagerController.propertyDidChange("showSwitcher")}},loadPreferences:function(onSuccess,onError){var self=this;this.set("userPreferences",null)},getUserPreferences:function(){if(this.get("userPreferences")===null){this.userPreferences=Ember.Object.create();this.get("userPreferences").setProperties(this.DEFAULT_USER_PREFERENCES)}return this.get("userPreferences")},setPreference:function(key,value){var self=this;this.getUserPreferences().set(key,value)},fetch:function(onSuccess,onError){var uid=this.get("uid"),self=this,query;if(uid!==0){GLIFFY.API.GET("user.json",{success:function(data){self.populate(data);if(onSuccess){onSuccess(self)}},error:onError})}},DEFAULT_USER_PREFERENCES:{printerPaperSize:"LETTER",navigatorOn:"true"},switchAbleAccounts:Ember.computed(function(){var switchableAccounts=Ember.A([]),self=this;var accountUsers=self.get("accountUsers");for(var i=0;i<accountUsers.length;i++){if(accountUsers[i].get("productId").indexOf("GAPP")===-1){switchableAccounts.push(accountUsers[i])}}return switchableAccounts}).property("accountUsers")});GliffyApp.AccountUserListItem=Ember.Object.extend({accountId:null,productId:null,accountName:null,userRole:"USER",isDefault:false})}());(function(){function pixelsPer(unit){var browser;browser=_gliffy.BrowserDetect.browser;return _gliffy.PRINT_CONSTANTS.BROWSER_PRINT_CONSTANTS[browser]["pixelsPerUnit"][unit]||1}GliffyApp.PrintController=Ember.ObjectController.extend({model:null,actions:{handleCancelPrintClick:function(){this.hidePrintDialog()},handlePrintClick:function(){GLIFFY.Utils.analyticsEvent("trackEvent",{category:"print",action:"printClick",label:GliffyApp.printController.get("model").toString()});window.print()}},getPageSetting:function(pageSize){return _gliffy.PRINT_CONSTANTS.PAGE_SIZES[pageSize.toLowerCase()]},browserDependentPixelsPerUnit:function(){return pixelsPer(this.getUnit())},gliffyNormalizedPixelsPerUnit:Ember.computed(function(){return _gliffy.PRINT_CONSTANTS.GLIFFY_NORMALIZED_PIXELS_PER_UNIT[this.getUnit()]||100}).property("model.pageSize","model.portrait"),getMargin:function(){var browser=_gliffy.BrowserDetect.browser;return _gliffy.PRINT_CONSTANTS.BROWSER_PRINT_CONSTANTS[browser]["margin"][this.getUnit()]},getUnit:function(){return this.getPageSetting(this.get("model").get("pageSize")).unit},dimension:Ember.computed(function(){var size,dimension,pageSize,portrait;pageSize=this.get("model").get("pageSize"),portrait=this.get("model").get("portrait"),size=this.getPageSetting(pageSize);if(portrait){dimension={x:size.dimension.x,y:size.dimension.y}}else{dimension={x:size.dimension.y,y:size.dimension.x}}return dimension}).property("model.pageSize","model.portrait"),openPrintDialog:function(){var printMenu;this.get("model").set("printDialogOpen",true);printMenu=$("#gliffy-print-modal");printMenu.modal("show");printMenu.css("display","block");$(window).resize(GLIFFY.printUtils.scalePrintView);GLIFFY.printUtils.scalePrintView();this.generateSvgOrImage()},generateSvgOrImage:function(){var activeStage,browser,documentManager,ie9,imagePromise,svgPromise;documentManager=_gliffy.Mouse.editor.getDocumentManager();activeStage=documentManager.getActiveStage();GLIFFY.printUtils.scalePrintView();browser=_gliffy.BrowserDetect;ie9=browser.browser==="Explorer"&&browser.version===9;if(ie9){imagePromise=documentManager.getImageData(activeStage,"img/png",this.prepareImageForPrintPreviewAndIE9,false,1)}else{svgPromise=documentManager.generateSvg(this.prepareSvgForPrint)}GLIFFY.printViewer.initializePrintPagesContainers();$.when(imagePromise,svgPromise).then($.proxy(GLIFFY.printViewer.render,GLIFFY.printViewer))},prepareSvgForPrint:function(svgString,deferred){var diagramContainer,svg;diagramContainer=$("#gliffy-print-diagram-svg-container");diagramContainer.html(svgString);svg=diagramContainer.find("svg")[0];svg.setAttribute("preserveAspectRatio","none meet");svg.id="gliffy-print-diagram-svg";GliffyApp.printController.injectClipPathToHideNodesOutsideStage(svg);deferred.resolve()},prepareImageForPrintPreviewAndIE9:function(imageData,deferred){var diagramContainer,stageImage;stageImage=new Image();stageImage.src=imageData;diagramContainer=$("#gliffy-print-diagram-image");diagramContainer.html(stageImage);deferred.resolve()},injectClipPathToHideNodesOutsideStage:function(svg){var browser,clipPath,defs,firstGroupTag,INCOMPATIBLE_BROWSERS,rect,$svg;INCOMPATIBLE_BROWSERS=["Firefox","Explorer"];browser=_gliffy.BrowserDetect.browser;if(!_.contains(INCOMPATIBLE_BROWSERS,browser)){$svg=$(svg);defs=$svg.find("defs");clipPath=$('<clippath id="gliffy-stage-rect-clip-path"><rect x="0" y="0" width="'+$svg.attr("width")+'" height="'+$svg.attr("height")+'"></rect></clippath>');defs.append(clipPath);firstGroupTag=$svg.find("g").first();firstGroupTag.attr("clip-path","url(#gliffy-stage-rect-clip-path)")}},hidePrintDialog:function(){this.get("model").set("printDialogOpen",false);$("#gliffy-print-modal").modal("hide");$(window).off("resize",GLIFFY.printUtils.scalePrintView)},init:function(){var model,SIZES;SIZES=_gliffy.PRINT_CONSTANTS.PAGE_SIZES;model=GliffyApp.PrintModel.create();model.addPrintObservers($.proxy(this.syncPageBreaks,this));model.addPrintObservers(this.renderOnTheViewer);this.set("model",model);this.sizes=Ember.A([SIZES.letter,SIZES.legal,SIZES._11x17,SIZES.a3,SIZES.a4])},registerEventListeners:function(eventAnchors){var syncPrintModelEvents;syncPrintModelEvents=["gliffy-document-manager-set-active-document","gliffy-document-manager-loaded-callback"].join(" ");$(eventAnchors.documentManager).on(syncPrintModelEvents,this.syncPrintModelToActiveStage)},syncPrintModelToActiveStage:function(){var activeStage=this.getActiveStage();GliffyApp.printController.model.fromObject(activeStage.printModel.toObject())},syncPageBreaks:function(){var pageBreaks=_gliffy.Mouse.editor.pageBreaks;pageBreaks.setEnabled(this.model.displayPageBreaks);pageBreaks.markDirty()},renderOnTheViewer:function(){GLIFFY.printViewer.render()},});GliffyApp.printController=GliffyApp.PrintController.create()}());(function(){var browser=GLIFFY.BrowserDetect;GliffyApp.PrintView=Ember.View.extend({isWindows:browser.OS==="Windows",isMac:browser.OS==="Mac",isChrome:browser.browser==="Chrome",isFirefox:browser.browser==="Firefox",isSafari:browser.browser==="Safari",isInternetExplorer:browser.browser==="Explorer",isIE9:browser.browser==="Explorer"&&browser.version===9,pageSizeBinding:"GliffyApp.printController.model.pageSize",portraitBinding:"GliffyApp.printController.model.portrait",printDialogOpenBinding:"GliffyApp.printController.model.printDialogOpen",scaleBinding:"GliffyApp.printController.model.scale",fitToOnePageBinding:"GliffyApp.printController.model.fitToOnePage",displayPageBreaksBinding:"GliffyApp.printController.model.displayPageBreaks",sizesBinding:Ember.Binding.oneWay("GliffyApp.printController.sizes"),pageSizeDescription:Ember.computed(function(){return GliffyApp.printController.getPageSetting(this.get("pageSize")).description}).property("pageSize"),didInsertElement:function(){var self=this;this.$(".gliffy-print-scale-radio-group").delegate("input[name=pageFit]","click",function(ev){self.handlePageFit});$(".gliffy-editor-print-menu").on("click","#print-enable-fit-to-page",function(e){self.handlePageFit(e)});$(".gliffy-editor-print-menu").on("click","#print-display-page-breaks",function(e){self.handlePageBreaksClick(e)})},actions:{handlePortraitClick:function(){this.set("portrait",true);this.updatePrintModelsDependantOnUserInputGivenPropertyAndValue("portrait",true)},handleLandscapeClick:function(){this.set("portrait",false);this.updatePrintModelsDependantOnUserInputGivenPropertyAndValue("portrait",false)},handlePageSizeClick:function(value){this.set("pageSize",value);this.updatePrintModelsDependantOnUserInputGivenPropertyAndValue("pageSize",value)}},handlePageFit:function(event){var value=$(event.currentTarget).is(":checked");this.set("fitToOnePage",value);this.updatePrintModelsDependantOnUserInputGivenPropertyAndValue("fitToOnePage",value)},handlePageBreaksClick:function(event){var value=$(event.currentTarget).is(":checked");this.set("displayPageBreaks",value);this.updatePrintModelsDependantOnUserInputGivenPropertyAndValue("displayPageBreaks",value)},newPrintModelGivenPropertyAndValue:function(property,value){var printModel;printModel={pageSize:this.pageSize,portrait:this.portrait,fitToOnePage:this.fitToOnePage,displayPageBreaks:this.displayPageBreaks};printModel[property]=value;return printModel},updatePrintModelsDependantOnUserInputGivenPropertyAndValue:function(property,value){var printModel;printModel=this.newPrintModelGivenPropertyAndValue(property,value);this.updateUserDefaultPrintModel(printModel);this.updateStagePrintModel(printModel)},updateUserDefaultPrintModel:function(printModel){var editor;editor=_gliffy.Mouse.editor;GliffyApp.PrintModel.setUserDefaults(printModel);editor.performAction("updateRemotePrintModel",printModel)},updateStagePrintModel:function(printModel){_gliffy.Mouse.editor.getDocumentManager().getActiveStage().printModel.fromObject(printModel)}})}());(function(){_gliffy.Plugins.create({activate:function(editor){},initTemplates:function(){var view=GliffyApp.PrintView.create({templateName:this.getTemplateNames()[0]});if(Ember.View.views["gliffy-print-container-view"]){Ember.View.views["gliffy-print-container-view"].pushObject(view)}},getTemplateNames:function(){return["gliffy-print-svg-menu-template"]},getName:function(){return"Print"}})}());(function(){var MITER_LIMIT=0;var PRINT_PREVIEW_CONTAINER;PRINT_PREVIEW_CONTAINER="#gliffy-print-preview-container";window.GLIFFY=window.GLIFFY||{};GLIFFY.PrintViewer=GLIFFY.Class.extend({__browserDependentPixelsPerUnit:null,__fitToOnePage:null,__gliffyNormalizedPixelsPerUnit:null,__margin:null,__scalePrintView:null,__pageSize:null,__printContainer:null,__printPreviewContainer:null,__unit:null,render:function(){var activeStage,browser,documentManager,printController,self,$stageImageContainer;self=this;browser=_gliffy.BrowserDetect;this.ie9=browser.browser==="Explorer"&&browser.version===9;$stageImageContainer=$("#gliffy-print-diagram-image");this.stageImage=$stageImageContainer.children(0)[0];documentManager=_gliffy.Mouse.editor.getDocumentManager();activeStage=documentManager.getActiveStage();this.stageImage=$stageImageContainer.children(0)[0];this.diagramWidth=activeStage.fitBB.max.x;this.diagramHeight=activeStage.fitBB.max.y;printController=GliffyApp.printController;if(printController.get("model").printDialogOpen){this.__browserDependentPixelsPerUnit=printController.browserDependentPixelsPerUnit();this.__fitToOnePage=!this.ie9&&printController.get("model").fitToOnePage;this.__gliffyNormalizedPixelsPerUnit=printController.get("gliffyNormalizedPixelsPerUnit");this.__margin=printController.getMargin();this.__pageSize=printController.get("dimension");this.__unit=printController.getUnit();this.__scalePrintView=GLIFFY.printUtils.scalePrintView;this.initializePrintPagesContainers();setTimeout(function(){self.__generateSvgPages()},0)}},getPrintPreviewContainer:function(){return $(PRINT_PREVIEW_CONTAINER)},initializePrintPagesContainers:function(){_gliffy.Spinner.showSmallSpinner($("#gliffy-print-preview-viewport"));this.getPrintPreviewContainer().empty();$("#gliffy-pages-for-print").remove();this.__printContainer=$("<div>",{id:"gliffy-pages-for-print"});$("body").append(this.__printContainer)},hiddenSvgForPrint:function(){var dupSvg,hiddenSvg;hiddenSvg=document.getElementById("gliffy-print-diagram-svg");dupSvg=hiddenSvg.cloneNode(true);return dupSvg},getHorizontalPageCount:function(){var gliffyNormalizedPageWidth,horizontalPageCount;gliffyNormalizedPageWidth=this.gliffyNormalizedPageWidthInPixels();if(this.__fitToOnePage){horizontalPageCount=1}else{horizontalPageCount=Math.ceil((this.diagramWidth-2*MITER_LIMIT)/gliffyNormalizedPageWidth)}return horizontalPageCount},getVerticalPageCount:function(){var gliffyNormalizedPageHeight,verticalPageCount;gliffyNormalizedPageHeight=this.gliffyNormalizedPageHeightInPixels();if(this.__fitToOnePage){verticalPageCount=1}else{verticalPageCount=Math.ceil((this.diagramHeight-2*MITER_LIMIT)/gliffyNormalizedPageHeight)}return verticalPageCount},browserDependentPageWidthInPixels:function(){return Math.floor(this.__pageSize.x*this.__browserDependentPixelsPerUnit)},browserDependentPageHeightInPixels:function(){return Math.floor(this.__pageSize.y*this.__browserDependentPixelsPerUnit)},gliffyNormalizedPageWidthInPixels:function(){return Math.floor(this.__pageSize.x*this.__gliffyNormalizedPixelsPerUnit)},browserDependentMarginInPixels:function(){return Math.floor(this.__margin*this.__browserDependentPixelsPerUnit)},gliffyNormalizedPageHeightInPixels:function(){return Math.floor(this.__pageSize.y*this.__gliffyNormalizedPixelsPerUnit)},pageWidthHeightRatio:function(){return this.__pageSize.x/this.__pageSize.y},pageFitViewBoxWidthAndHeight:function(){var diagramWidthHeightRatio,fitToPageBounds,additionPixelBuffer=0;additionPixelBuffer=0;diagramWidthHeightRatio=this.diagramWidth/this.diagramHeight;fitToPageBounds={};if(diagramWidthHeightRatio<this.pageWidthHeightRatio()){fitToPageBounds.width=this.diagramHeight*this.pageWidthHeightRatio();fitToPageBounds.height=this.diagramHeight+additionPixelBuffer}else{fitToPageBounds.width=this.diagramWidth+additionPixelBuffer;fitToPageBounds.height=this.diagramWidth/this.pageWidthHeightRatio()}return fitToPageBounds},pageViewBoxGivenBounds:function(bounds){var normalizedPageWidth,normalizedPageHeight,pageFitViewbox,viewBox;if(this.__fitToOnePage){pageFitViewbox=this.pageFitViewBoxWidthAndHeight();viewBox=[0,0,pageFitViewbox.width,pageFitViewbox.height].join(" ")}else{normalizedPageWidth=this.gliffyNormalizedPageWidthInPixels();normalizedPageHeight=this.gliffyNormalizedPageHeightInPixels();viewBox=[bounds.min.x,bounds.min.y,normalizedPageWidth,normalizedPageHeight].join(" ")}return viewBox},__generateSvgPages:function(){var boundingBox,horizontalPage,horizontalPageCount,horizontalPixelRange,pages,gliffyNormalizedPageHeight,gliffyNormalizedPageWidth,$row,svgId,verticalPage,verticalPageCount,verticalPixelRange;gliffyNormalizedPageWidth=this.gliffyNormalizedPageWidthInPixels();gliffyNormalizedPageHeight=this.gliffyNormalizedPageHeightInPixels();verticalPageCount=this.getVerticalPageCount();horizontalPageCount=this.getHorizontalPageCount();svgId=0;verticalPixelRange={min:0,max:gliffyNormalizedPageHeight};for(verticalPage=1;verticalPage<=verticalPageCount;verticalPage++){$row=$("<div>",{"class":"gliffy-page-row"});this.getPrintPreviewContainer().append($row);horizontalPixelRange={min:0,max:gliffyNormalizedPageWidth};for(horizontalPage=1;horizontalPage<=horizontalPageCount;horizontalPage++){boundingBox=new GLIFFY.BoundingBox(horizontalPixelRange.min,verticalPixelRange.min,horizontalPixelRange.max,verticalPixelRange.max);pages=this.__createSvgPage(boundingBox,svgId++);$row.append(pages.preview);this.__printContainer.append(pages.print);horizontalPixelRange={min:horizontalPixelRange.min+gliffyNormalizedPageWidth,max:horizontalPixelRange.max+gliffyNormalizedPageWidth}}verticalPixelRange={min:verticalPixelRange.min+gliffyNormalizedPageHeight,max:verticalPixelRange.max+gliffyNormalizedPageHeight}}this.getPrintPreviewContainer().parent().find(".spinner").remove();if(this.__scalePrintView){this.__scalePrintView()}},__createSvgPage:function(bounds,svgId){var previewPage,printPage;if(this.ie9){previewPage=this.generatePrintPageImage(bounds,"preview")}else{previewPage=this.generatePrintPreviewPage(bounds,svgId)}switch(_gliffy.BrowserDetect.browser){case"Chrome":printPage=this.generatePrintPageForChrome(bounds,svgId);break;case"Firefox":printPage=this.generatePrintPageForFirefox(bounds,svgId);break;case"Safari":printPage=this.generatePrintPageForSafari(bounds,svgId);break;case"Explorer":switch(_gliffy.BrowserDetect.version){case 11:printPage=this.generatePrintPageForIE11(bounds,svgId);break;case 10:printPage=this.generatePrintPageForIE10(bounds,svgId);break;case 9:printPage=this.generatePrintPageImage(bounds,"print");break}break;default:printPage=this.generatePrintPageForChrome(bounds,svgId);break}return{preview:previewPage,print:printPage}},generatePrintPreviewPage:function(bounds,svgId){var $previewPage,marginInUnits,pageHeightMinusMargin,pageWidthMinusMargin,svg,viewBox;marginInUnits=this.__margin+this.__unit;pageWidthMinusMargin=(this.__pageSize.x-2*this.__margin)+this.__unit;pageHeightMinusMargin=(this.__pageSize.y-2*this.__margin)+this.__unit;svg=this.hiddenSvgForPrint();svg.id="svgDiagram_"+svgId;svg.setAttribute("width",pageWidthMinusMargin);svg.setAttribute("height",pageHeightMinusMargin);svg.setAttribute("viewBox",this.pageViewBoxGivenBounds(bounds));svg.setAttribute("style","margin:"+marginInUnits+";width:"+pageWidthMinusMargin+";height:"+pageHeightMinusMargin+";");$previewPage=$("<div>",{"class":"gliffy-print-preview-page",height:this.__pageSize.y+this.__unit,width:this.__pageSize.x+this.__unit});$previewPage.append(svg);return $previewPage},generatePrintPageImage:function(bounds,printOrPreview){var browserDependentMarginInPixels,browserDependentPageHeightInPixels,browserDependentPageWidthInPixels,pageCanvas,canvas2DContext,pageHeightMinusMarginInPixels,pageWidthMinusMarginInPixels,svgViewboxForFullPage,sourceViewbox,page,marginInUnits,pageHeightMinusMarginInUnits,pageWidthMinusMarginInUnits,fullPageViewbox,destinationViewbox;browserDependentPageWidthInPixels=this.browserDependentPageWidthInPixels();browserDependentPageHeightInPixels=this.browserDependentPageHeightInPixels();browserDependentMarginInPixels=this.browserDependentMarginInPixels();pageWidthMinusMarginInPixels=browserDependentPageWidthInPixels-2*browserDependentMarginInPixels;pageHeightMinusMarginInPixels=browserDependentPageHeightInPixels-2*browserDependentMarginInPixels;pageCanvas=GLIFFY.PrintViewer.generatePrintPageCanvas({height:pageHeightMinusMarginInPixels,width:pageWidthMinusMarginInPixels});svgViewboxForFullPage=_.map(this.pageViewBoxGivenBounds(bounds).split(" "),function(numberAsString){return parseInt(numberAsString)});fullPageViewbox={x1:svgViewboxForFullPage[0],y1:svgViewboxForFullPage[1],x2:svgViewboxForFullPage[0]+svgViewboxForFullPage[2],y2:svgViewboxForFullPage[1]+svgViewboxForFullPage[3],width:svgViewboxForFullPage[2],height:svgViewboxForFullPage[3]};sourceViewbox={x:fullPageViewbox.x1,y:fullPageViewbox.y1,width:fullPageViewbox.x2<this.diagramWidth?fullPageViewbox.width:this.diagramWidth-fullPageViewbox.x1,height:fullPageViewbox.y2<this.diagramHeight?fullPageViewbox.height:this.diagramHeight-fullPageViewbox.y1};destinationViewbox={x:0,y:0,width:Math.floor(sourceViewbox.width*(pageCanvas.width/this.gliffyNormalizedPageWidthInPixels())),height:Math.floor(sourceViewbox.height*(pageCanvas.height/this.gliffyNormalizedPageHeightInPixels()))};canvas2DContext=pageCanvas.getContext("2d");canvas2DContext.drawImage(this.stageImage,sourceViewbox.x,sourceViewbox.y,sourceViewbox.width,sourceViewbox.height,0,0,destinationViewbox.width,destinationViewbox.height);pageHeightMinusMarginInUnits=(this.__pageSize.y-2*this.__margin)+this.__unit;pageWidthMinusMarginInUnits=(this.__pageSize.x-2*this.__margin)+this.__unit;marginInUnits=printOrPreview==="preview"?this.__margin+this.__unit:0;if(printOrPreview==="print"){page=document.createElement("div");page["class"]="gliffy-ie9-page-for-print"}else{page=GLIFFY.PrintViewer.generatePrintPreviewPageContainer({height:pageHeightMinusMarginInUnits,width:pageWidthMinusMarginInUnits,margin:marginInUnits})}page.appendChild(pageCanvas);return page},generatePrintPageForChrome:function(bounds,svgId){var browserDependentMargin,browserDependentPageHeight,browserDependentPageWidth,CHROME_SPECIFIC_HEIGHT_STUPIDITY,$page,pageHeightMinusMargin,pageWidthMinusMargin,svg,viewBox;CHROME_SPECIFIC_HEIGHT_STUPIDITY=4;browserDependentPageWidth=this.browserDependentPageWidthInPixels();browserDependentPageHeight=this.browserDependentPageHeightInPixels();browserDependentMargin=this.browserDependentMarginInPixels();pageWidthMinusMargin=browserDependentPageWidth-2*browserDependentMargin-10;pageHeightMinusMargin=browserDependentPageHeight-2*browserDependentMargin-CHROME_SPECIFIC_HEIGHT_STUPIDITY;svg=this.hiddenSvgForPrint();svg.id="svgDiagram_"+svgId;svg.setAttribute("width",pageWidthMinusMargin);svg.setAttribute("height",pageHeightMinusMargin);svg.setAttribute("viewBox",this.pageViewBoxGivenBounds(bounds));svg.setAttribute("style","margin:"+browserDependentMargin+";width:"+pageWidthMinusMargin+";height:"+pageHeightMinusMargin+";");$page=$("<div>",{"class":"gliffy-page-for-print",height:browserDependentPageHeight,width:browserDependentPageWidth});$page.append(svg);return $page},generatePrintPageForFirefox:function(bounds,svgId){var browserDependentMargin,browserDependentPageHeight,browserDependentPageWidth,marginBottom,$page,pageHeightMinusMargin,pageWidthMinusMargin,svg,viewBox;browserDependentPageWidth=this.browserDependentPageWidthInPixels();browserDependentPageHeight=this.browserDependentPageHeightInPixels();browserDependentMargin=this.browserDependentMarginInPixels();marginBottom=_gliffy.PRINT_CONSTANTS.BROWSER_PRINT_CONSTANTS.Firefox.marginBottom[this.__unit]*this.__browserDependentPixelsPerUnit;pageWidthMinusMargin=browserDependentPageWidth-2*browserDependentMargin;pageHeightMinusMargin=browserDependentPageHeight-browserDependentMargin-marginBottom;svg=this.hiddenSvgForPrint();svg.id="svgDiagram_"+svgId;svg.setAttribute("width",pageWidthMinusMargin);svg.setAttribute("height",pageHeightMinusMargin);svg.setAttribute("viewBox",this.pageViewBoxGivenBounds(bounds));svg.setAttribute("style","width:100%;height:100%;");$page=$("<div>",{"class":"gliffy-page-for-print",height:browserDependentPageHeight+"px",width:browserDependentPageWidth+"px"});$page.append(svg);return $page},generatePrintPageForSafari:function(bounds,svgId){var browserDependentMargin,browserDependentPageHeight,browserDependentPageWidth,marginBottom,pageHeightMinusMargin,pageWidthMinusMargin,SAFARI_SPECIFIC_HEIGHT_STUPIDITY,svg,viewBox;SAFARI_SPECIFIC_HEIGHT_STUPIDITY=4;browserDependentPageWidth=this.browserDependentPageWidthInPixels();browserDependentPageHeight=this.browserDependentPageHeightInPixels();browserDependentMargin=this.browserDependentMarginInPixels();marginBottom=_gliffy.PRINT_CONSTANTS.BROWSER_PRINT_CONSTANTS.Safari.marginBottom[this.__unit]*this.__browserDependentPixelsPerUnit;pageWidthMinusMargin=browserDependentPageWidth-2*browserDependentMargin;pageHeightMinusMargin=browserDependentPageHeight-browserDependentMargin-marginBottom-SAFARI_SPECIFIC_HEIGHT_STUPIDITY;svg=this.hiddenSvgForPrint();svg.id="svgDiagram_"+svgId;svg.setAttribute("width",pageWidthMinusMargin);svg.setAttribute("height",pageHeightMinusMargin);svg.setAttribute("viewBox",this.pageViewBoxGivenBounds(bounds));svg.setAttribute("style","width:"+pageWidthMinusMargin+";height:"+pageHeightMinusMargin+";");return svg},generatePrintPageForIE11:function(bounds,svgId){var browserDependentMargin,browserDependentPageHeight,browserDependentPageWidth,$page,pageHeightMinusMargin,pageWidthMinusMargin,svg,viewBox;browserDependentPageWidth=this.browserDependentPageWidthInPixels();browserDependentPageHeight=this.browserDependentPageHeightInPixels();browserDependentMargin=this.browserDependentMarginInPixels();pageWidthMinusMargin=browserDependentPageWidth-2*browserDependentMargin;pageHeightMinusMargin=browserDependentPageHeight-2*browserDependentMargin;svg=this.hiddenSvgForPrint();svg.id="svgDiagram_"+svgId;svg.setAttribute("width",pageWidthMinusMargin);svg.setAttribute("height",pageHeightMinusMargin);svg.setAttribute("viewBox",this.pageViewBoxGivenBounds(bounds));$page=$("<div>",{"class":"gliffy-page-for-print",height:browserDependentPageHeight-2*browserDependentMargin,width:browserDependentPageWidth-2*browserDependentMargin});$page.append(svg);return $page},generatePrintPageForIE10:function(bounds,svgId){var browserDependentMargin,browserDependentPageHeight,browserDependentPageWidth,$page,pageHeightMinusMargin,pageWidthMinusMargin,svg,viewBox;browserDependentPageWidth=this.browserDependentPageWidthInPixels();browserDependentPageHeight=this.browserDependentPageHeightInPixels();browserDependentMargin=this.browserDependentMarginInPixels();pageWidthMinusMargin=browserDependentPageWidth-2*browserDependentMargin;pageHeightMinusMargin=browserDependentPageHeight-2*browserDependentMargin;svg=this.hiddenSvgForPrint();svg.id="svgDiagram_"+svgId;svg.setAttribute("width",pageWidthMinusMargin);svg.setAttribute("height",pageHeightMinusMargin);svg.setAttribute("viewBox",this.pageViewBoxGivenBounds(bounds));svg.setAttribute("style","width:"+pageWidthMinusMargin+"px;height:"+pageHeightMinusMargin+"px;");$page=$("<div>",{"class":"gliffy-page-for-print",style:"width"+browserDependentPageHeight+";height"+browserDependentPageWidth+";"});$page.append(svg);return $page}});GLIFFY.PrintViewer.generatePrintPageCanvas=function(dimensions){var canvas;canvas=document.createElement("canvas");canvas.className="gliffy-print-image-canvas";canvas.width=dimensions.width;canvas.height=dimensions.height;return canvas};GLIFFY.PrintViewer.generatePrintPreviewPageContainer=function(dimensions){var pageContainer;pageContainer=document.createElement("div");pageContainer.className="gliffy-print-preview-page";pageContainer.style.width=dimensions.width;pageContainer.style.height=dimensions.height;pageContainer.style.padding=dimensions.margin;return pageContainer}}());(function(){var scalePrintView;GLIFFY.printViewer=new GLIFFY.PrintViewer();scalePrintView=function(){var $printModalViewboxPrintContainer,containerHeight,heightRatio,$printModal,$printModalBody,$printModalControls,$printModalHeader,MODAL_MARGIN,scale,scaleCss,printModalViewboxHeight,printModalViewboxWidth,containerWidth,widthRatio,$window,MINIMUM_WIDTH_OFFSET_FOR_NO_WRAP,$printModalViewbox;MODAL_MARGIN=50;MINIMUM_WIDTH_OFFSET_FOR_NO_WRAP=40;$window=$(window);$printModal=$("#gliffy-print-modal");$printModalHeader=$("#gliffy-print-modal-header");$printModalBody=$("#gliffy-print-modal-body");$printModalControls=$(".gliffy-print-controls");$printModalViewbox=$("#gliffy-print-preview-viewport");$printModalViewboxPrintContainer=$("#gliffy-print-preview-container");$printModal.width($window.width()-2*MODAL_MARGIN);$printModal.height($window.height()-2*MODAL_MARGIN);printModalViewboxWidth=$printModal.width()-MINIMUM_WIDTH_OFFSET_FOR_NO_WRAP-$printModalControls.outerWidth();printModalViewboxHeight=$printModal.height()-$printModalHeader.outerHeight();$printModalBody.height(printModalViewboxHeight);$printModalViewbox.width(printModalViewboxWidth);containerWidth=$printModalViewboxPrintContainer[0].scrollWidth;containerHeight=$printModalViewboxPrintContainer[0].scrollHeight;widthRatio=printModalViewboxWidth/containerWidth;heightRatio=printModalViewboxHeight/containerHeight;scale=widthRatio<heightRatio?widthRatio:heightRatio;$("#gliffy-print-scale").remove();if(scale<1){scaleCss="scale("+scale+","+scale+")";GLIFFY.printUtils.createScreenStyle("#gliffy-print-preview-container",{transform:scaleCss,"-ms-transform":scaleCss,"-webkit-transform":scaleCss,"-o-transform":scaleCss,"-moz-transform":scaleCss}).id="gliffy-print-scale"}};GLIFFY.printUtils=GLIFFY.printUtils||{};GLIFFY.printUtils.scalePrintView=scalePrintView}());(function(){_gliffy.Plugins.create({activate:function(editor){},initTemplates:function(){var view=Ember.View.create({templateName:this.getTemplateNames()[0],elementId:"gliffy-button-link",classNames:["btn"],click:function(e){if(!$("#gliffy-button-link").hasClass("disabled")){if(!e.isTrigger){_gliffy.Utils.analyticsEvent("trackEvent",{category:"toolbarClick",action:"gliffyLink"})}$("#container").data("skipTextControlAnalytics",true);tinyMCE.activeEditor.execCommand("gliffyLink",false);$("#container").data("skipTextControlAnalytics",false)}}});if(Ember.View.views["gliffy-node-tools"]){Ember.View.views["gliffy-node-tools"].insertAt(0,view)}},getTemplateNames:function(){return["gliffy-link-tool-button-template"]},getName:function(){return"LinkTool"}})}());(function(){GliffyApp.NetworkRackTabView=Ember.View.extend({tagName:"div",elementId:"gliffy-tables-tab",templateName:"network-rack-tab",classNames:[],didInsertElement:function(e){var self=this;GliffyApp.networkRackTabController.registerSelectionListeners();$("#gliffy-contextual-properties-checkbox-hide-units").prop("checked",GliffyApp.networkRackTabController.get("unitsHidden"));$("#gliffy-contextual-properties-checkbox-hide-units").on("click",function(e){self.clickHideUnitsCheckbox(e)});$("#gliffy-contextual-properties-checkbox-hide-label").prop("checked",GliffyApp.networkRackTabController.get("labelHidden"));$("#gliffy-contextual-properties-checkbox-hide-label").on("click",function(e){self.clickHideLabelCheckbox(e)})},clickHideUnitsCheckbox:function(event){GliffyApp.networkRackTabController.setRackUnitsVisibility(event.target.checked)},clickHideLabelCheckbox:function(event){GliffyApp.networkRackTabController.setRackLabelVisibility(event.target.checked)}});GliffyApp.NetworkUnitTextField=GliffyApp.ContextualPropertiesTextField.extend({originalHeight:0,placeholder:"1",maxlength:2,disabledBinding:Ember.Binding.oneWay("GliffyApp.networkRackTabController.disableUnitInput"),valueBinding:Ember.Binding.oneWay("GliffyApp.networkRackTabController.shapeUnitValue"),focusIn:function(){this.originalHeight=this.value*GliffyApp.networkRackTabController.PIXELS_TO_UNITS},focusOut:function(){},__commit:function(prop,value){if(value.length===0){value=$("#gliffy-contextual-properties-network-rack-input-update-units").val()}value=parseInt(value);if(value===value&&value>0){GliffyApp.networkRackTabController.updateShapeUnits(this.originalHeight,value)}}})}());(function(){GliffyApp.NetworkRackTabController=Ember.ObjectController.extend({__editor:null,__documentManager:null,__stage:null,shapeUnitValue:1,shapeUnitOffset:0,RACK_UNIT_OFFSET:3,PIXELS_TO_UNITS:20,unitsHidden:false,labelHidden:false,targetNode:null,disableUnitInput:false,internalUnits:0,init:function(){this.__documentManager=this.__editor.getDocumentManager();this.__stage=this.__editor.getDocumentManager().getActiveStage()},actions:{},registerSelectionListeners:function(){var self=this},updateShapeUnits:function(originalHeight,units){var internalUnits=parseInt(units);this.set("internalUnits",0);this.set("shapeUnitOffset",0);if(this.targetNode){if(!originalHeight||originalHeight===0){originalHeight=this.get("shapeUnitValue")*this.PIXELS_TO_UNITS}if(this.isRack(this.targetNode)){internalUnits=parseInt(units)+this.RACK_UNIT_OFFSET;this.set("shapeUnitOffset",this.RACK_UNIT_OFFSET*this.PIXELS_TO_UNITS)}GliffyApp.contextualPropertiesController.keepDialogOpenOnBlurText=false;this.__documentManager.pushCommandBundle();this.__documentManager.addAndExecuteCommand(new _gliffy.NetworkRackResizeCommand({editor:this.__editor,node:this.targetNode,height:internalUnits*this.PIXELS_TO_UNITS,oldHeight:originalHeight,shapeUnitOffset:this.get("shapeUnitOffset"),units:units,PIXELS_TO_UNITS:this.PIXELS_TO_UNITS}));this.__documentManager.popCommandBundle();this.set("shapeUnitValue",units);this.__editor.getDocumentManager().redraw();this.__editor.overlayManager.updateOverlayHeight(internalUnits*this.PIXELS_TO_UNITS)}},setTargetNode:function(targetNode){var unitSize,childTextUnitIndex=1,childTextLabelIndex=0,childUnitNode,childLabelNode;if(targetNode){this.targetNode=targetNode;this.set("disableUnitInput",this.isLCD(targetNode));unitSize=Math.ceil(targetNode.getHeight()/this.PIXELS_TO_UNITS);if(this.isRack(this.targetNode)){unitSize=parseInt(unitSize)-this.RACK_UNIT_OFFSET;this.set("shapeUnitOffset",this.RACK_UNIT_OFFSET*this.PIXELS_TO_UNITS)}childTextUnitIndex=this.getChildNodeIndex(this.targetNode,"units");childTextLabelIndex=this.getChildNodeIndex(this.targetNode,"label");if(this.targetNode.children[childTextUnitIndex].children.length>0){childUnitNode=this.targetNode.children[childTextUnitIndex].children[0];this.set("unitsHidden",childUnitNode.getHidden())}if(this.targetNode.children[childTextLabelIndex].children.length>0){childLabelNode=this.targetNode.children[childTextLabelIndex].children[0];this.set("labelHidden",childLabelNode.getHidden())}this.set("shapeUnitValue",unitSize)}},setRackUnitsVisibility:function(checked){var childTextIndex,childNode;if(this.targetNode){childTextIndex=this.getChildNodeIndex(this.targetNode,"units");childNode=this.targetNode.children[childTextIndex].children[0];childNode.setHidden(checked);childNode.setFlag("bounds");childNode.markDirty();this.__editor.getDocumentManager().redraw()}},setRackLabelVisibility:function(checked){var childTextIndex,childNode;if(this.targetNode){this.set("labelHidden",checked);childTextIndex=this.getChildNodeIndex(this.targetNode,"label");childNode=this.targetNode.children[childTextIndex].children[0];childNode.setHidden(checked);childNode.setFlag("bounds");this.__editor.getDocumentManager().redraw()}},getChildNodeIndex:function(node,type){var childTextIndex=0;if(type=="units"){childTextIndex=1}if(type=="units"&&this.isRack(node)){childTextIndex=4}else{if(type=="label"&&this.isRack(node)){childTextIndex=3}}return childTextIndex},isRack:function(node){return(node.getUid()==="com.gliffy.shape.network.network_v4.rack.rack")},isLCD:function(node){return(node.getUid()==="com.gliffy.shape.network.network_v4.rack.7u_lcd")}})}());(function(){_gliffy.Plugins.create({activate:function(editor){GliffyApp.networkRackTabController=GliffyApp.NetworkRackTabController.create({__editor:editor,__documentManager:editor.getDocumentManager()})},getCustomTabView:function(){GliffyApp.networkRackTabController.setTargetNode(GliffyApp.contextualPropertiesController.getTargetNode(false));return GliffyApp.NetworkRackTabView.create({name:this.getName()})},initTemplates:function(){},getTemplateNames:function(){return["network-rack-tab"]},getName:function(){return"NetworkRackTab"}})}());(function(){GliffyApp.MindMapTabView=Ember.View.extend({tagName:"div",elementId:"gliffy-mind-map-tab",templateName:"mind-map-tab",classNames:[],showLayoutButtons:false,didInsertElement:function(){var self=this;GliffyApp.mindMapTabController.resetDialogControls();$("#gliffy-mind-map-button-color1").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-mind-map-button-color2").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-mind-map-button-color3").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-mind-map-button-color4").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-mind-map-button-color5").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-mind-map-button-color6").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-mind-map-button-color7").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);$("#gliffy-mind-map-button-color8").tooltip(_gliffy.Editor.TOOLTIP_OPTIONS_STANDARD);this.set("showLayoutButtons",GLIFFY.FEATURES.mindmapsAutoLayout);$(".gliffy-mind-map-tab-colors button").on("click",function(e){self.clickColorButton(e)});$(".gliffy-mind-map-tab-radio input").on("click",function(e){self.clickColorScheme(e)})},clickColorScheme:function(e){GliffyApp.mindMapTabController.updateProperty("ColorScheme",e.currentTarget.value);_gliffy.Utils.analyticsEvent("trackEvent",{category:"MindMapTabView",action:"clickColorScheme",label:e.currentTarget.value})},clickColorButton:function(e){e.preventDefault();GliffyApp.mindMapTabController.toggleColorSwatchPicker(e.currentTarget);_gliffy.Utils.analyticsEvent("trackEvent",{category:"MindMapTabView",action:"clickColorButton",label:$(e.currentTarget).data("gliffy-color")})}})}());(function(){_gliffy.ModifyMindmapNodeCommand=_gliffy.UndoableCommand.extend({action:"modify_mindmap_node",node:null,target:null,mindmapGraphic:null,init:function(o){var self=this,properties,options=$.extend({node:null,mindmapGraphic:null,props:{},},o),n=null;if(!options.node){throw new Error("Node must be defined")}if(!options.mindmapGraphic){throw new Error("mindmapGraphic must be defined")}this.nodeId=options.node.getId();this.props=options.props;properties=Object.keys(this.props);this.redoProps={};this.mindmapGraphic=o.mindmapGraphic;$.each(this.props,function(property,value){if(self.mindmapGraphic["get"+property]){self.redoProps[property]=self.mindmapGraphic["get"+property]()}else{if(self.mindmapGraphic["is"+value]){self.redoProps[property]=self.mindmapGraphic["is"+property]()}}})},execute:function(stage){this.setMindmapGraphicProperties(this.props)},undo:function(stage){this.setMindmapGraphicProperties(this.redoProps)},setMindmapGraphicProperties:function(properties){var self=this;$.each(properties,function(property,value){if(self.mindmapGraphic["set"+property]){self.mindmapGraphic["set"+property](value)}})}})}());(function(){GliffyApp.MindMapTabController=Ember.ObjectController.extend({__editor:null,__documentManager:null,isRootNode:true,FORCE_LAYOUT_CONFIGURATION:{linkDistance:75,chargeFactor:1.5,gravity:0.2},init:function(){},actions:{clickForceLayout:function(){this.forceLayout();_gliffy.Utils.analyticsEvent("trackEvent",{category:"MindMapTabView",action:"clickForceLayout"})}},toggleColorSwatchPicker:function(domElement){GliffyApp.colorpickerController.toggleColorSwatchPicker(domElement,this)},getTargetColor:function(domElement){var selectedNode=GliffyApp.contextualPropertiesController.getTargetNode();if(this.isMindmap(selectedNode)){return this.getMindmapGraphic(selectedNode).getColorPalette()[Number($(domElement).data("gliffy-color"))-1]}else{return"#000000"}},getMindmapGraphic:function(node){return node.findGraphic(_gliffy.Mindmap)[0].getGraphic()},resetDialogControls:function(skipId){var selectedNode=GliffyApp.contextualPropertiesController.getTargetNode(),colorPalette,i,graphic;if(this.isMindmap(selectedNode)){graphic=this.getMindmapGraphic(selectedNode);this.set("isRootNode",graphic.getTreeDepth()===0);setTimeout(function(){$("input[name=gliffy-mind-map-radio-group-color-scheme][value="+graphic.getColorScheme()+"]").prop("checked",true);colorPalette=graphic.getColorPalette();if(colorPalette){$(".gliffy-mind-map-tab-colors button").each(function(index){$(this).find(".gliffy-color-fill-icon").css("background-color",colorPalette[index]);if(skipId!==$(this).attr("id")){$(this).attr("class","btn")}})}},1)}},updateProperty:function(prop,value){var selectedNode=GliffyApp.contextualPropertiesController.getTargetNode(),props={};props[prop]=value;if(this.isMindmap(selectedNode)){this.__documentManager.pushCommandBundle();if(selectedNode.stage){selectedNode.stage.commandHistory.addAndExecuteCommand(new _gliffy.ModifyMindmapNodeCommand({node:selectedNode,props:props,mindmapGraphic:this.getMindmapGraphic(selectedNode)}))}else{selectedNode.updateProperty(prop,value)}this.__documentManager.popCommandBundle()}},handleColorpickerColorChange:function(color,domId){var selectedNode=GliffyApp.contextualPropertiesController.getTargetNode(),colorPalette,graphic=this.getMindmapGraphic(selectedNode);if(this.isMindmap(selectedNode)){colorPalette=graphic.getColorPalette().slice(0);colorPalette[Number($("#"+domId).data("gliffy-color"))-1]=color;this.updateProperty("ColorPalette",colorPalette);this.resetDialogControls()}},isMindmap:function(selectedNode){return(selectedNode&&selectedNode.isMindmap())},forceLayout:function(){var self=this,stage=this.__documentManager.getActiveStage(),stageMaxWidth=stage.maxWidth,stageMaxHeight=stage.maxHeight,mindmapTreeAsJSON=this.generateSimpleMindmapTreeJSON(),node,flattenedJSONNodes,links,layout,tickCycles=500,i,targetNode=this.__editor.overlayManager.getSelectedNode();this.__editor.overlayManager.deselectAll();flattenedJSONNodes=this.__flattenNodes(mindmapTreeAsJSON);this.__assignIds(flattenedJSONNodes);try{links=d3.layout.tree().links(flattenedJSONNodes);layout=d3.layout.force().nodes(flattenedJSONNodes).links(links).linkDistance(this.FORCE_LAYOUT_CONFIGURATION.linkDistance).charge(function(data){return -(data.width*data.height*self.FORCE_LAYOUT_CONFIGURATION.chargeFactor)}).gravity(this.FORCE_LAYOUT_CONFIGURATION.gravity).size([stageMaxWidth,stageMaxHeight])}catch(e){console.warn("This feature is not yet supported")}if(layout){layout.start();for(i=0;i<tickCycles;i++){layout.tick()}layout.stop();self.__documentManager.pushCommandBundle();$.each(flattenedJSONNodes,function(_,jsonNode){node=stage.find(jsonNode.node_id);stage.commandHistory.addAndExecuteCommand(new _gliffy.ModifyNodeCommand({node:node,props:{X:jsonNode.x-jsonNode.width/2,Y:jsonNode.y-jsonNode.height/2}}))});this.__documentManager.redraw();setTimeout(function(){self.__editor.overlayManager.quickConnectionOverlay.__centerOnStage(targetNode);self.__documentManager.popCommandBundle()},1)}},generateSimpleMindmapTreeJSON:function(){var self=this,rootJSON,stage=_gliffy.Mouse.documentManager.getActiveStage(),nodes=stage.objects.slice(0),graphic;$.each(nodes,function(_,node){if(node.isMindmap()){graphic=self.getMindmapGraphic(node);if(graphic.getRootNodeId()===null){rootJSON=self.__generateObjectJSONFromNode(node);if(graphic.getChildNodeIds().length>0){self.__appendChildren(graphic,rootJSON)}}}});return rootJSON},__flattenNodes:function(node){var flattenedNodes,self;self=this;flattenedNodes=[node];if(node.children instanceof Array){node.children.forEach(function(childNode){flattenedNodes=flattenedNodes.concat(self.__flattenNodes(childNode))})}return flattenedNodes},__assignIds:function(nodes){$.each(nodes,function(i,node){node.id=i})},__appendChildren:function(parentGraphic,parentJSON){var childIds=parentGraphic.getChildNodeIds(),childNode,childNodeGraphic,childJSON,stage=_gliffy.Mouse.documentManager.getActiveStage(),self=this;if(childIds.length>0){parentJSON.children=[];$.each(childIds,function(_,childId){childNode=stage.find(childId);if(childNode&&childNode.findGraphic(_gliffy.Mindmap).length>0){childNodeGraphic=self.getMindmapGraphic(childNode);childJSON=self.__generateObjectJSONFromNode(childNode);self.__appendChildren(childNodeGraphic,childJSON);parentJSON.children.push(childJSON)}})}},__generateObjectJSONFromNode:function(refNode){var nodeText="",textNodeGraphic=refNode.findGraphic(_gliffy.Text);if(textNodeGraphic.length>0){nodeText=textNodeGraphic[0].getGraphic().getNodeText()}return{node_id:refNode.getId(),name:nodeText,x:refNode.getX(),y:refNode.getY(),width:refNode.getWidth(),height:refNode.getHeight()}}})}());(function(){_gliffy.Plugins.create({activate:function(editor){GliffyApp.mindMapTabController=GliffyApp.MindMapTabController.create({__editor:editor,__documentManager:editor.getDocumentManager()})},getCustomTabView:function(){return GliffyApp.MindMapTabView.create({name:this.getName()})},doCustomUpdate:function(prop,value,editor,node){},initTemplates:function(){},getTemplateNames:function(){return["mind-map-tab"]},getName:function(){return"MindMapTab"}})}())}());